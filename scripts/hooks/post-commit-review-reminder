#!/bin/bash
# Post-commit Review Reminder Hook
# Reminds developers to create review documents for completed stories
#
# Installation:
#   cp scripts/hooks/post-commit-review-reminder .git/hooks/post-commit
#   chmod +x .git/hooks/post-commit

# Colors for output
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Get the commit message
COMMIT_MSG=$(git log -1 --pretty=%B)

# Extract story ID from commit message (US-XXX format)
STORY_ID=$(echo "$COMMIT_MSG" | grep -oE "US-[0-9]+" | head -1)

if [ -n "$STORY_ID" ]; then
    # Find the story file
    STORY_FILE=$(find docs/backlog -name "$STORY_ID.md" 2>/dev/null | head -1)

    if [ -n "$STORY_FILE" ]; then
        # Check story status
        STATUS=$(grep "^status:" "$STORY_FILE" | cut -d':' -f2 | xargs)

        # If completed, check for review document
        if [ "$STATUS" == "completed" ] || [ "$STATUS" == "done" ]; then
            STORY_DIR=$(dirname "$STORY_FILE")
            REVIEW_DOCS=$(find "$STORY_DIR" -name "review-*.md" 2>/dev/null)

            if [ -z "$REVIEW_DOCS" ]; then
                echo ""
                echo -e "${YELLOW}ðŸ“‹ Post-Commit Reminder${NC}"
                echo "======================================"
                echo -e "Story ${CYAN}$STORY_ID${NC} is marked as ${CYAN}completed${NC}"
                echo ""
                echo "Consider creating a review document:"
                echo "  1. Create: $STORY_DIR/review-$(date +%Y%m%d).md"
                echo "  2. Include:"
                echo "     - What was implemented"
                echo "     - What worked well"
                echo "     - What could be improved"
                echo "     - Lessons learned"
                echo ""
                echo "Template available in: docs/templates/review-template.md"
                echo "======================================"
                echo ""
            fi
        fi
    fi
fi

# Check if tests were added in this commit
if echo "$COMMIT_MSG" | grep -qi "test\|spec"; then
    # Suggest running full test suite
    echo ""
    echo -e "${CYAN}ðŸ’¡ Tip${NC}: You added tests. Consider running:"
    echo "  pytest -v    # Run all tests"
    echo ""
fi

# Check TDD phase and suggest next steps
if [ -f ".tdd-phase" ]; then
    PHASE=$(cat .tdd-phase)
    echo ""
    echo -e "${CYAN}ðŸ”„ TDD Phase${NC}: $PHASE"

    case $PHASE in
        RED)
            echo "  Next: Write minimal implementation (GREEN phase)"
            echo "  Command: python scripts/phase-tracker.py set GREEN"
            ;;
        GREEN)
            echo "  Next: Refactor and improve code quality"
            echo "  Command: python scripts/phase-tracker.py set REFACTOR"
            ;;
        REFACTOR)
            echo "  Next: Start new feature/test (RED phase)"
            echo "  Command: python scripts/phase-tracker.py set RED"
            ;;
    esac
    echo ""
fi
