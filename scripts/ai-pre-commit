#!/bin/bash
# AI-Enhanced Pre-commit Hook voor DefinitieApp
# Detecteert AI agent commits en voert enhanced review uit

# Colors voor output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}ðŸ” Running pre-commit checks...${NC}"

# Check if this is an AI agent commit
if [ -n "$AI_AGENT_COMMIT" ]; then
    echo -e "${YELLOW}ðŸ¤– AI Agent commit detected!${NC}"
    echo "Agent: ${AI_AGENT_NAME:-Unknown}"
    echo "Running enhanced AI code review..."

    # Run the AI code reviewer
    python scripts/ai_code_reviewer.py \
        --max-iterations 5 \
        --ai-agent "${AI_AGENT_NAME:-manual}"

    REVIEW_EXIT_CODE=$?

    if [ $REVIEW_EXIT_CODE -ne 0 ]; then
        echo -e "${RED}âŒ AI Code review failed!${NC}"
        echo "Please fix the issues before committing."
        echo "Review report saved to: review_report.md"
        exit 1
    fi

    echo -e "${GREEN}âœ… AI Code review passed!${NC}"
else
    # Normal pre-commit flow voor human developers
    echo "Running standard pre-commit checks..."

    # Backlog integrity guard (IDs + links)
    if [ -f "scripts/docs/check_backlog_integrity.py" ]; then
        echo "Running backlog integrity checks (IDs + links)..."
        python3 scripts/docs/check_backlog_integrity.py || exit 1
    fi

    # Check if pre-commit is installed
    if command -v pre-commit &> /dev/null; then
        pre-commit run --all-files
        exit $?
    else
        # Fallback to basic checks
        echo -e "${YELLOW}âš ï¸  pre-commit not installed, running basic checks${NC}"

        # Basic Python checks
        if command -v ruff &> /dev/null; then
            echo "Running Ruff..."
            ruff check src/ || exit 1
        fi

        if command -v black &> /dev/null; then
            echo "Running Black..."
            black --check src/ || exit 1
        fi

        # Run tests if available
        if [ -f "pytest.ini" ] || [ -f "setup.cfg" ] || [ -f "pyproject.toml" ]; then
            echo "Running tests..."
            python -m pytest tests/ -x || exit 1
        fi
    fi
fi

echo -e "${GREEN}âœ… All pre-commit checks passed!${NC}"
exit 0
