---
id: US-195
epic: EPIC-004
title: Duplicate‑gate bij genereren definitie met 3‑contextkeuze
status: active
prioriteit: hoog
story_points: 5
owner: development
applies_to: definitie-app@current
canonical: false
last_verified: 2025-10-02
last_updated: 2025-09-22
---

# US-195 — Duplicate‑gate bij genereren definitie met 3‑contextkeuze

Als gebruiker wil ik dat de definitiegenerator direct stopt wanneer er al een definitie bestaat met dezelfde context (begrip + organisatorische, juridische én wettelijke context), zodat ik expliciet kan kiezen tussen het hergebruiken van de bestaande definitie of het bewust genereren van een nieuwe (met duidelijke waarschuwing).

## Context & Rationale
- Duplicate‑criterium is canoniek: begrip + drie contextlijsten (organisatorisch, juridisch, wettelijk). Categorie maakt geen deel uit van de duplicate‑check.
- Bij duplicate moet de UI niet door‑genereren maar de gebruiker eerst 2 keuzes bieden.
- Bij “Genereer nieuwe” moet de validator (CON‑01) de situatie zichtbaar markeren (error/high); gates blijven drempel‑gedreven.

## Scope
- UI (EPIC‑004): duplicate pre‑check vóór generatie + dialoog met 2 knoppen.
- Services/DB (alignering): DB‑filtering op `wettelijke_basis` (JSON), checker‑laag borgt orde‑onafhankelijkheid.
- Migrator: normalisatie van `wettelijke_basis` naar unieke, gesorteerde JSON‑array zodat SQL‑vergelijkingen betrouwbaar zijn.
 - Preconditie (CFR‑BUG‑029 opgelost op 2025‑09‑22): in de Generator‑tab is minimaal één context (organisatorisch of juridisch of wettelijk) vereist vóór genereren of opslaan als concept.

## Definitie van Gereed
- UI stopt generatie wanneer duplicate (3/3 contexten) is gevonden en toont 2 knoppen:
  1) “Toon bestaande definitie” — toont definitietekst, context (3x) en status (draft/established).
  2) “Genereer nieuwe definitie” — forceert generatie; validator laat CON‑01 als error terugkomen (severity_level=high).
- Duplicate‑check gebruikt drie contextlijsten; categorie wordt genegeerd.
- DB‑laag kan op `wettelijke_basis` filteren; checker doet orde‑onafhankelijke vergelijking als vangnet.
- Migratie uitgevoerd op bestaande database om `wettelijke_basis` te normaliseren.
- Tests aanwezig die 3/3‑context invariant borgen.
 - Generator‑tab valideert dat ≥1 context is ingevuld (CFR‑BUG‑029); UI‑knoppen disabled zonder context + duidelijke melding.

## Acceptatiecriteria
- AC1: Voor een bestaande definitie met exact dezelfde (begrip, org, jur, wet) verschijnt de keuze‑UI, en er wordt nog niets gegenereerd.
- AC2: “Toon bestaande definitie” toont definitietekst, status en alle 3 contexten (leesbaar) in de UI.
- AC3: “Genereer nieuwe definitie” maakt een nieuw record; validator bevat CON‑01 violation (error/high) met metadata `existing_definition_id` en `status`.
- AC4: Variatie alleen in `wettelijke_basis` (overige gelijk) resulteert in PROCEED (géén duplicate‑UI).
- AC5: De volgorde van items in `wettelijke_basis` mag het resultaat niet beïnvloeden (orde‑onafhankelijk).
- AC6: Migratiescript normaliseert bestaande `wettelijke_basis` waarden; herhaald draaien is idempotent.

## Niet‑functioneel
- Pre‑check moet < 100 ms blijven bij een database tot ~10k records (lokale SQLite). SQL filter + normalisatie minimaliseren IO.
- Geen netwerkafhankelijkheden in de pre‑check‑flow.

## Implementatie (korte samenvatting)
- UI: `src/ui/tabbed_interface.py`
  - Duplicate‑gate vóór generatie; knoppen “Toon bestaande” en “Genereer nieuwe”.
- Checker: `src/integration/definitie_checker.py`
  - `check_before_generation(..., wettelijke_basis=[])` verwerkt alle 3 lijsten; categorie genegeerd.
- DB‑laag: `src/database/definitie_repository.py`
  - `find_definitie`/`find_duplicates` accepteren `wettelijke_basis` en filteren op de JSON‑string; categorie‑filter verwijderd.
  - `set_wettelijke_basis()` normaliseert naar unieke, gesorteerde JSON.
- Migrator: `src/database/migrate_database.py`
  - Normaliseert bestaande `wettelijke_basis` waarden (uniek + gesorteerd).
- Validator: `src/services/validation/modular_validation_service.py`
  - CON‑01 duplicate‑violation: bij geforceerde generatie `severity=error`, `severity_level=high` (bewust geen ‘critical’ gate change in deze US).

## Testplan
- Unit/integration: `tests/integration/test_duplicate_check_three_contexts.py`
  - test_exact_match_requires_all_three_lists_equal_order_independent
  - test_mismatch_wettelijke_basis_does_not_count_as_exact_or_duplicate
  - test_draft_status_returns_update_existing_when_all_three_match
- Handmatig in UI:
  1) Maak definitie A (begrip X, org=OM, jur=Strafrecht, wet=[Art. 27 Sv]).
  2) Genereer opnieuw met exact dezelfde context → duplicate‑UI (AC1/AC2).
  3) Varieer wet (bijv. [Art. 67 Sv]) → geen duplicate‑UI, wel generatie mogelijk (AC4).
  4) Forceer “Genereer nieuwe definitie” → CON‑01 error zichtbaar met metadata (AC3).

## Traceability
- REQ: Koppeling met UI‑use‑cases (REQ‑052, REQ‑049) en kwaliteitstoetsing (REQ‑072) — zie Portal Traceability.
- EPIC: EPIC‑004 (User Interface)

## Open Besluiten
- Of CON‑01 bij geforceerde duplicate ‘critical’ moet worden (gate‑block) blijft een optionele vervolgstap (niet in deze US).
