---
id: US-068
epic: EPIC-004
titel: Implement Audit Trail Query for History Tab
type: feature
status: proposed
prioriteit: MEDIUM
story_points: 3
sprint: backlog
aangemaakt: 2025-09-11
bijgewerkt: 2025-09-11
owner: developer
applies_to: definitie-app@current
canonical: false
last_verified: 2025-09-11
vereisten:
  - REQ-045
toegewezen_aan: development-team
---

# US-068: Implement Audit Trail Query for History Tab

**Epic:** EPIC-004 - User Interface

## Gebruikersverhaal

**Als een** compliance officer of juridisch professional
**wil ik** de complete audit trail van definitie wijzigingen kunnen zien
**zodat** ik de evolutie van definities kan traceren en compliance kan aantonen

## Probleembeschrijving

TODO in `ui/components/history_tab.py:72`:
- Implement audit trail query from definitie_geschiedenis table

De UI toont nu placeholder data maar haalt geen echte audit trail op.

## Acceptatiecriteria

### Functionele Criteria
- [ ] Audit trail toont alle wijzigingen van een definitie
- [ ] Inclusief: wie, wat, wanneer, waarom
- [ ] Filtering op datum range
- [ ] Filtering op type wijziging
- [ ] Filtering op gebruiker
- [ ] Export mogelijkheid (CSV/JSON)

### Data Criteria
- [ ] Query haalt data uit definitie_geschiedenis table
- [ ] Performance optimized met indices
- [ ] Pagination voor grote histories
- [ ] Soft deletes worden getoond
- [ ] Version diffs kunnen bekeken worden

### UI Criteria
- [ ] Timeline view van changes
- [ ] Expandable details per change
- [ ] Color coding voor type changes
- [ ] Search binnen history
- [ ] Compare versions side-by-side

## Implementatie Details

### History Query Service
```python
class AuditTrailService:
    def get_definition_history(
        self,
        definition_id: int,
        filters: HistoryFilters
    ) -> PaginatedHistory:
        # Query definitie_geschiedenis
        # Apply filters
        # Format for display

    def get_change_diff(
        self,
        version_a: int,
        version_b: int
    ) -> VersionDiff:
        # Compare two versions
```

### Database Query
```sql
SELECT
    dg.id,
    dg.definitie_id,
    dg.actie,
    dg.oude_waarde,
    dg.nieuwe_waarde,
    dg.gebruiker,
    dg.timestamp,
    dg.reden
FROM definitie_geschiedenis dg
WHERE dg.definitie_id = ?
ORDER BY dg.timestamp DESC
LIMIT ? OFFSET ?
```

## Definition of Done

- [ ] Audit trail service geïmplementeerd
- [ ] Database queries geoptimaliseerd
- [ ] UI component toont echte data
- [ ] Filtering werkend
- [ ] Pagination geïmplementeerd
- [ ] Export functionaliteit
- [ ] Unit tests voor service
- [ ] Integration test met database
- [ ] Performance test (>1000 history items)

## Risico's

| Risico | Impact | Mitigatie |
|--------|--------|-----------|
| Performance grote histories | High | Indices + pagination |
| Missing audit entries | High | Data integrity checks |
| Privacy concerns | Medium | Role-based filtering |

## Notes

- Overweeg caching voor vaak bekeken histories
- Audit trail moet onveranderbaar zijn (append-only)
- Consider integration met externe audit systems
