---
id: US-110
epic: EPIC-004
titel: Persistente bronverantwoording (web sources) en generatie‑metadata voor definities
status: proposed
prioriteit: HIGH
story_points: 5
sprint: backlog
owner: architecture
applies_to: definitie-app@current
canonical: false
last_verified: 2025-09-12
---

# US-110: Persistente bronverantwoording (web sources) en generatie‑metadata voor definities

## Gebruikersverhaal
Als gebruiker wil ik dat bij iedere definitie de gebruikte bronnen (provenance) en de belangrijke generatie‑instellingen/artefacten (zoals prompt en model) duurzaam worden opgeslagen, zodat herleidbaarheid, auditing en reproduceerbaarheid gewaarborgd zijn.

## Context
- UI toont “sources in preview” (Epic 3), maar structurele opslag in de DB ontbreekt nog.
- Prompt debug sectie gebruikt `prompt_template` uit metadata; dat wordt niet persistent vastgelegd.
- Gerelateerd: [US‑064 (Edit Interface)](../US-064/US-064.md), [US‑153 (wettelijke_basis kolom)](../US-153/US-153.md), [US‑154 (normalisatie wettelijke basis)](../US-154/US-154.md), [US‑071 (schema‑reconciliatie)](../US-071/US-071.md), en EPIC‑004.

## Scope
In scope
- DDL voor twee tabellen: `definitie_bronnen` (provenance) en `definitie_generatie` (generatie‑metadata).
- Migratie (aanmaken tabellen + indexen); geen backfill vereist (huidige data bevat deze velden niet persistent).
- Repo‑contract (signatures, dataclasses) voor CRUD en delta‑updates (geen implementatie in deze US).

Out of scope
- UI‑aanpassingen en services‑implementatie (vallen onder US‑064 en services stories).
- Externe bronnormalisatie (zoals masterdata voor webbronnen) — later mogelijk.

## Ontwerp

### DDL – Bronverantwoording (provenance)
```sql
CREATE TABLE IF NOT EXISTS definitie_bronnen (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    definitie_id INTEGER NOT NULL REFERENCES definities(id) ON DELETE CASCADE,

    name VARCHAR(255) NOT NULL,       -- WebSource.name
    url VARCHAR(500),                 -- WebSource.url
    confidence REAL DEFAULT 0.0,      -- WebSource.confidence
    is_juridical BOOLEAN DEFAULT FALSE, -- WebSource.is_juridical
    api_type VARCHAR(50),             -- "mediawiki", "sru", "scraping", etc.

    aangemaakt_op TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    bijgewerkt_op TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    UNIQUE(definitie_id, name, url)
);

CREATE INDEX IF NOT EXISTS idx_bronnen_definitie_id ON definitie_bronnen(definitie_id);

CREATE TRIGGER IF NOT EXISTS trg_bronnen_update
AFTER UPDATE ON definitie_bronnen
FOR EACH ROW WHEN NEW.bijgewerkt_op = OLD.bijgewerkt_op
BEGIN
    UPDATE definitie_bronnen SET bijgewerkt_op = CURRENT_TIMESTAMP WHERE id = NEW.id;
END;
```

### DDL – Generatie‑metadata
```sql
CREATE TABLE IF NOT EXISTS definitie_generatie (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    generation_id VARCHAR(64),      -- UUID/trace id
    definitie_id INTEGER NOT NULL REFERENCES definities(id) ON DELETE CASCADE,

    model VARCHAR(100),             -- bijv. gpt-4o-mini-2024-07-18
    temperature REAL,               -- bijv. 0.0..1.0
    prompt_template TEXT,           -- effectieve prompt
    prompt_tokens INTEGER,          -- optioneel
    completion_tokens INTEGER,      -- optioneel
    total_tokens INTEGER,           -- optioneel
    duration_seconds REAL,          -- end-to-end duur
    orchestrator_version VARCHAR(20),
    created_by VARCHAR(255),

    aangemaakt_op TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_generatie_definitie_id ON definitie_generatie(definitie_id);
CREATE INDEX IF NOT EXISTS idx_generatie_generation_id ON definitie_generatie(generation_id);
```

## Repository‑contract (concept)
Dataclasses (voorbeeld):
```python
@dataclass
class BronRecord:
    id: int | None
    definitie_id: int
    name: str
    url: str | None = None
    confidence: float = 0.0
    is_juridical: bool = False
    api_type: str | None = None

@dataclass
class GeneratieRecord:
    id: int | None
    generation_id: str | None
    definitie_id: int
    model: str | None
    temperature: float | None
    prompt_template: str | None
    prompt_tokens: int | None
    completion_tokens: int | None
    total_tokens: int | None
    duration_seconds: float | None
    orchestrator_version: str | None
    created_by: str | None
```

Methodes (signatures):
- Bronnen: `list_bronnen(definitie_id) -> list[BronRecord]`, `upsert_bronnen(definitie_id, nieuwe: list[BronRecord]) -> dict`
- Generatie: `add_generatie(record: GeneratieRecord) -> int`, `list_generaties(definitie_id) -> list[GeneratieRecord]`

## Migratie
- Stap 1: DDL uitvoeren (tabellen + indexen + triggers).
- Stap 2: (Optioneel) backfill wanneer data in logs/exports aanwezig is — niet vereist in deze US.

## Acceptatiecriteria
- [ ] Tabellen `definitie_bronnen` en `definitie_generatie` bestaan met bijbehorende indexen en triggers.
- [ ] Repo‑contract gedefinieerd voor bronverantwoording en generatie‑metadata.
- [ ] Links in dit document werken (US‑064, US‑069, US‑070, US‑071, EPIC‑004).

## Teststrategie (concept)
- DDL smoke: creatie op lege DB; herhaaldelijke creatie is idempotent.
- CRUD rondes: (na implementerende US) insert/update/list/delete op bronnen en generaties; UNIQUE‑schendingen correct.
- Integratie: UI/services kunnen bronnen/generaties schrijven en later weergeven.

## Risico’s en mitigatie
- Duplicaten van bronnen: UNIQUE(definitie_id, name, url) voorkomt triviale duplicaties; delta‑update API nodig.
- Privacy/PII: prompt_template en modelparameters kunnen gevoelige context bevatten — opslag alleen op vertrouwde omgevingen; toonbaarheid via UI achter flag/rol.
- Token/duratievelden optioneel, afhankelijk van AI‑provider logging.

## Referenties
- Schema: `src/database/schema.sql` (hoofdschema voor definities)
- Gerelateerd: [US‑064](../US-064/US-064.md), [US‑153](../US-153/US-153.md), [US‑154](../US-154/US-154.md), [US‑071](../US-071/US-071.md), [EPIC‑004](../EPIC-004.md)
