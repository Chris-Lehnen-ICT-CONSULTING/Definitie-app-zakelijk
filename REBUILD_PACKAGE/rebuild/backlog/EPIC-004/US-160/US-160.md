---
id: US-160
epic: EPIC-004
titel: Validatie‑gate bij Vaststellen (Option B)
type: feature
status: In uitvoering
prioriteit: HOOG
story_points: 5
sprint: backlog
aangemaakt: 2025-09-13
bijgewerkt: 2025-09-13
owner: frontend-team
applies_to: definitie-app@current
canonical: false
last_verified: 2025-09-22
vereisten:
  - REQ-093
toegezegd_door: product-owner
---

# US-160: Validatie‑gate bij Vaststellen (Option B)

## Gebruikersverhaal
**Als** expert reviewer
**wil ik** dat het vaststellen van definities aan kwaliteitsregels voldoet (met duidelijke drempels en eventueel override)
**zodat** alleen kwalitatief acceptabele definities als Vastgesteld de keten in gaan

## Context en scope
- Gate wordt zowel in de UI zichtbaar als in de service afgedwongen.
- Hard beleid (Context Model V2): minimaal één context ingevuld (organisatorisch of juridisch of wettelijk).
- Soft beleid: wettelijke_basis ontbreekt → override toegestaan met reden.
- Score‑drempel: overall_score ≥ 0.75 en geen ‘critical’ issues (configurabel).
- Uitbreidingen/andere opties worden expliciet NIET in deze US geïmplementeerd en worden vastgelegd (zie “Niet opgenomen in scope”).

## Acceptatiecriteria (SMART)
1) UI‑gate duidelijk zichtbaar:
- Expert‑tab toont validatiescore en issues.
- Knop “Vaststellen” is:
  - Groen (enabled) wanneer gate gehaald is.
  - Oranje (enabled, met “Vaststellen met override” + reden verplicht) bij soft‑violations (bijv. ontbrekende wettelijke basis of enkel ‘high’ issues, score ≥ 0.65).
  - Grijs (disabled) wanneer hard‑gate niet gehaald is (score < 0.75 of ‘critical’ issues of ontbrekende org/jur context).
2) Service‑gate enforced:
- DefinitionWorkflowService blokkeert transitie naar established indien hard‑gate niet gehaald is.
- Bij override (soft‑gate) is “reden” verplicht en wordt als notes/geschiedenis vastgelegd.
3) Logging/Audit:
- Gate‑uitkomst (pass/blocked/override) en eventuele override‑reden in `definitie_geschiedenis` (notes/reden) terug te vinden.
4) Configurabel:
- Drempel (min_overall_score), forbid_critical, soft‑override‑drempel en require_fields via centrale policy (YAML/DI). Defaults gedocumenteerd.
5) Regressie‑vrij:
- Bestaande Vaststellen/Afwijzen/Terugzetten functionaliteit blijft werken; UI geeft duidelijke meldingen.

## Niet opgenomen in scope (vastgelegd voor vervolg‑US’en)
- Option C (alle drie contextvelden hard) – NIET nu.
- Conditioneel vereisen van wettelijke_basis (bijv. op status/categorie) – NIET nu.
- UI‑beheer van policy (variabelen) – opgenomen in EPIC‑016.

## UI Specificaties (Expert‑tab)
- Badge/indicator bij score (groen/oranje/grijs) met toelichting op niet‑gehaalde criteria.
- Override‑dialoog (reden verplicht) bij soft‑gate; reden wordt gelogd.

Status update (2025‑09‑22):
- Gate‑preview en knoppenstates zijn geïntegreerd in de Expert‑tab.
- “Vaststellen” loopt via DefinitionWorkflowService en respecteert gate‑beleid (override vereist reden).
- UI toont gate‑status en redenen bij blokkade/override.

## Service Specificaties
- DefinitionWorkflowService consulteert GatePolicyService (DI) en beslist gate‑uitkomst vóór statuswijziging.
- Bij override: statuswijziging toegestaan, met verplichte `notes` (reden) die in geschiedenis worden vastgelegd.
- Geen ad‑hoc her‑validatie in `approve()`; als er geen betrouwbare validatiegegevens aanwezig zijn, blokkeer met duidelijke instructie (eerst (her)valideren).
- Enum‑correctie: statuswijziging gebeurt naar `ESTABLISHED` (niet `APPROVED`).

## Testscenario’s
- Gate pass (score ≥ 0.75, geen critical, org/jur gevuld) → Vaststellen lukt.
- Soft‑gate (score 0.65–0.74 of enkel ‘high’ issues) → Vaststellen met override (reden verplicht) lukt en logt.
- Hard‑fail (score < 0.65 of critical issues of alle contexten leeg) → Vaststellen disabled en service‑block met melding.

## Definition of Done
- [ ] UI‑gate zichtbaar en correct (groen/oranje/grijs + override flow)
- [ ] Service‑gate enforced (block/override met logging)
- [ ] Policy laadbaar/configureerbaar via DI (YAML)
- [ ] Documentatie bijgewerkt (README/architectuur)
- [ ] Smoke‑tests handmatig gedraaid voor pass/soft‑override/block

## Achtergrond & Businesswaarde
- Verhoogt kwaliteit en consistentie van “Vastgestelde” definities; vermindert herwerk.
- Maakt besluitvorming transparant (override met reden) en auditeerbaar.

## In scope / Out of scope
In scope:
- Gate‑policy toepassen bij Vaststellen (UI + service), Option B.
- Duidelijke gebruikersfeedback en logging.
Out of scope:
- UI‑beheer van policy (EPIC‑016), conditionele vereisten voor wettelijke_basis, Option C.

## Businessregels
- Gate beslist op basis van: overall_score, violation severities, aanwezigheid vereiste velden.
- Soft‑gate: override vereist “reden” (notes) → audit.
- Gate beslist vóór statuswijziging (service), UI toont status van de gate.

## UI/UX specificaties (verder uitgewerkt)
- Indicator bij validatiescore: groen (≥0.75, geen critical), oranje (≥0.65 en alleen high/soft‑issues), grijs (onder drempel of missing hard‑fields).
- Tooltip/expander met exacte criteria (drempels, ontbrekende velden, issues samenvatting).
- Override dialoog: tekstveld (min 10 chars), bevestigknop, melding dat audit wordt vastgelegd.

## Service/API specificaties
- GatePolicyService (DI):
  - Configbestand: `config/approval_gate.yaml` met defaults.
  - Env‑overlay: `APPROVAL_GATE_CONFIG_OVERLAY=/pad/naar/overlay.yaml` (deep‑merge).
  - TTL‑cache: `cache.ttl_seconds` (default 60s).
- DefinitionWorkflowService:
  - `preview_gate(definition_id) -> {status: pass|override_required|blocked, reasons: [...]}` voor UI‑presentatie.
  - `approve(definition_id, user, notes)` voert gate‑check uit; bij `override_required` zijn `notes` verplicht; bij `blocked` geeft `error_message` terug.
  - Status enum consistent met database: `ESTABLISHED`.

## Data/Config
- YAML‑voorbeeld (defaults):
```yaml
hard_requirements:
  require_org_context: true
  require_jur_context: true
  forbid_critical_issues: true

thresholds:
  hard_min_score: 0.75
  soft_min_score: 0.65

soft_requirements:
  allow_high_issues_with_override: true
  missing_wettelijke_basis_soft: true

cache:
  ttl_seconds: 60
```

## Monitoring/Telemetrie
- Tel aantal vaststellingen per dag, overrides, blocks; gemiddelde score bij vaststellen; top reasons voor blok/override.

## Veiligheid/Autorisatie
- Gate is non‑bypassable (service‑enforcement); UI weerspiegelt uitkomst.
- Override reden verplicht, gelogd met user en timestamp.

## Risico’s & Mitigaties
- Te strenge drempel blokkeert doorstroom → policy configureerbaar en zichtbare feedback.
- Inconsistentie UI vs service → service leidend; UI leest service‑uitkomst.

## Belangrijk (technische noot)
- Huidige bug: `DefinitionWorkflowService` gebruikt `APPROVED` i.p.v. `ESTABLISHED`. Dit wordt in Fase B gecorrigeerd samen met de gate‑enforcement.

## Roll‑out plan
- Fase 1: service‑enforcement + UI‑indicatoren (zonder beheer‑UI; YAML defaults).
- Fase 2 (EPIC‑016): beheer‑UI + audit + import/export; conditionele regels.

## Testmatrix (uitgebreid)
- [ ] PASS: score=0.80, geen critical, org/jur gevuld → knop groen, service approve OK.
- [ ] SOFT: score=0.70, geen critical, missing wettelijke_basis → override vereist; service approve met notes OK.
- [ ] BLOCK: score=0.60 of critical aanwezig of org/jur leeg → disabled/blocked; service foutmelding.
