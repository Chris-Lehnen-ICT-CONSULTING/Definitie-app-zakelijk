---
id: US-155
epic: EPIC-004
titel: Expert Approval Interface - Goedkeuren van Definities
type: feature
status: In uitvoering
prioriteit: HIGH
story_points: 5
sprint: backlog
aangemaakt: 2025-09-12
bijgewerkt: 2025-09-12
owner: expert-reviewer
applies_to: definitie-app@current
canonical: false
last_verified: 2025-09-22
vereisten:
  - REQ-007
  - REQ-012
toegewezen_aan: frontend-team
---

# US-155: Expert Approval Interface - Goedkeuren van Definities

**Epic:** EPIC-004 - User Interface

## Gebruikersverhaal

**Als een** juridisch expert / eindredacteur  
**wil ik** definities kunnen goedkeuren (status "established" geven)  
**zodat** alleen gevalideerde en goedgekeurde definities als definitief worden beschouwd

## Probleembeschrijving

Momenteel bestaat de workflow infrastructuur (US-072: DefinitionWorkflowService) met methods voor:
- `submit_for_review()` - werkt al via Generator tab
- `approve()` - backend bestaat, maar geen UI
- `reject()` - backend bestaat, maar geen UI

De Expert Review tab toont wel een review queue maar heeft geen knoppen om definities daadwerkelijk goed te keuren of af te wijzen.

## Huidige Workflow Status

Definities doorlopen deze statussen:
1. **draft** - InitiÃ«le status na generatie
2. **review** - Na "Submit voor Review" (werkt al)
3. **established** - Na goedkeuring door expert (aanwezig in UI via DefinitionWorkflowService + gate)
4. **archived** - Gearchiveerde/verouderde definities

## Acceptatiecriteria

### Functionele Criteria
- [x] Backend service bestaat al (DefinitionWorkflowService)
- [ ] Expert Review tab toont direct de laatst gegenereerde definitie (prefill)
- [ ] Prefill toont alle context (organisatorisch, juridisch, wettelijke basis) readâ€‘only
- [x] Expert Review tab toont "Vaststellen" knop voor definities met status "In review"
- [x] Expert Review tab toont "Afwijzen" knop met verplicht redenâ€‘veld
- [x] Na vaststellen wordt status "Vastgesteld" (DB: established)
- [x] Na afwijzen wordt status terug naar "Concept" (DB: draft) met feedback/reden
- [ ] Approval metadata wordt vastgelegd (approved_by, approved_at, approval_notes)
- [ ] Audit trail via `definitie_geschiedenis` (status_changed) + metadata snapshot
- [x] Voor definities met status "Vastgesteld" is er een actie "Maak bewerkbaar" (status terugzetten) met verplicht redenâ€‘veld en logging
- [ ] Zoekfunctie ondersteunt filteren op status, inclusief "Vastgesteld"

### UI/UX Criteria
- [ ] Duidelijke visuele scheiding tussen Concept / In review / Vastgesteld / Gearchiveerd
- [x] Alle UIâ€‘labels in het Nederlands; DBâ€‘statuscodes blijven ongewijzigd
- [x] Approval workflow met gateâ€‘preview en overrideâ€‘reden (via DefinitionWorkflowService)
- [x] Afwijzen verplicht een reden
- [ ] Optioneel: batch vaststellen voor meerdere definities tegelijk
- [x] Filter op status in overzichten; "Vastgesteld" zichtbaar/selecteerbaar

### Autorisatie
- [ ] Alleen gebruikers met expert rol kunnen goedkeuren (future: rol-based)
- [ ] Voor nu: iedereen kan goedkeuren (single-user app)

## Implementatie Details

### 0. Context (sample data uit schema)
- Het systeem bevat voorbeelddata in `schema.sql` met Ã©Ã©n definitie die direct als "established" is ingevoerd (demonstratiedoeleinden).
- Dit bevestigt dat de status technisch bestaat, maar de UI moet een bewuste gebruikersactie bieden om van "In review" naar "Vastgesteld" te gaan (met confirmatie en logging).

### Terminologie (NL labels in UI; DBâ€‘codes blijven)
- draft â†’ "Concept"
- review â†’ "In review"
- established â†’ "Vastgesteld"
- archived â†’ "Gearchiveerd"

### 1. Expert Review Tab Uitbreiding

```python
# In expert_review_tab.py
def _render_approval_actions(self, definitie: DefinitieRecord):
    """Render approval/rejection acties voor een definitie."""
    col1, col2 = st.columns(2)
    
    with col1:
        if st.button("âœ… Goedkeuren", key=f"approve_{definitie.id}"):
            notes = st.text_area("Goedkeuringsnotities (optioneel)")
            if st.button("Bevestig Goedkeuring"):
                self._approve_definition(definitie.id, notes)
    
    with col2:
        if st.button("âŒ Afwijzen", key=f"reject_{definitie.id}"):
            reason = st.text_area("Reden voor afwijzing (verplicht)")
            if reason and st.button("Bevestig Afwijzing"):
                self._reject_definition(definitie.id, reason)

def _approve_definition(self, definition_id: int, notes: str = ""):
    """Goedkeur een definitie via WorkflowService."""
    workflow_service = st.session_state.service_container.definition_workflow_service()
    result = workflow_service.approve(
        definition_id=definition_id,
        user=st.session_state.get('user', 'expert'),
        notes=notes
    )
    if result.success:
        st.success(f"âœ… Definitie goedgekeurd (status: {result.new_status})")
        st.rerun()
    else:
        st.error(f"âŒ Goedkeuring mislukt: {result.error_message}")
```

### 1b. Prefill + readâ€‘only context
- Generator zet `selected_review_definition_id` na succesvol bewaren/genereren.
- Expertâ€‘tab toont bovenaan (indien aanwezig) een readâ€‘only contextpaneel met ALLEEN de vastgelegde context:
  - Begrip, definitie (samenvatting)
  - Organisatorische context (leeg = â€œâ€”â€)
  - Juridische context (leeg = â€œâ€”â€)
  - Wettelijke basis (lijst; leeg = â€œâ€”â€)
  - Status (badge), aangemaakt/bewerkt door en timestamps
- Globale context (Context Selector) wordt NIET getoond en NIET als fallback gebruikt.

### 2. Status Visualisatie

```python
def _render_status_badge(self, status: str):
    """Render een status badge met juiste kleur."""
    badges = {
        'draft': ('ğŸ“', 'gray'),
        'review': ('ğŸ‘ï¸', 'blue'),
        'established': ('âœ…', 'green'),
        'archived': ('ğŸ“¦', 'orange')
    }
    icon, color = badges.get(status, ('â“', 'gray'))
    st.markdown(f":{color}[{icon} {status.upper()}]")
```

### 3. Established Definities View

Aparte sectie/filter voor goedgekeurde definities:
- Toon alleen established definities
- Metadata: goedgekeurd door, goedgekeurd op
- Export-ready indicator
- Beschermd tegen wijzigingen (tenzij expert)

### 4. Status terugzetten (Vastgesteld â†’ Concept)
- In Expertâ€‘tab bij status Vastgesteld: actie "ğŸ”“ Maak bewerkbaar" met verplicht redenâ€‘veld.
- Zet status terug naar Concept (DB: draft) via `DefinitionWorkflowService` en log reden in geschiedenis (status_changed met context_snapshot + reden).
- Editâ€‘tab wordt weer bewerkbaar.

### 5. Zoeken op status (incl. Vastgesteld)
- Zoekfunctie behoudt statusfilter en toont ook "Vastgesteld".
- Resultaten voor Vastgesteld openen in Expertâ€‘tab (readâ€‘only); via actie "Maak bewerkbaar" kan status worden teruggezet (met logging) om daarna te bewerken in de Bewerkâ€‘tab.

## Integratie met Edit Interface

De Edit Interface (US-064) moet rekening houden met status:
- **Concept** (draft): Vrij bewerkbaar
- **In review** (review): Bewerkbaar met waarschuwing
- **Vastgesteld** (established): Readâ€‘only; via Expertâ€‘tab kan de status expliciet worden teruggezet
- **Gearchiveerd** (archived): Readâ€‘only

## Test Scenario's

1. **Happy Path**
   - Genereer definitie (draft)
   - Submit voor review
   - Open Expert Review tab
   - Prefill toont alle context readâ€‘only
   - Vaststellen â†’ status wordt Vastgesteld
   - Controleer: statusbadge, approval metadata, audit logging aanwezig

2. **Rejection Flow**
   - Definitie in review
   - Afwijzen met reden (verplicht)
   - Controleer status = Concept
   - Controleer feedback/redenen in geschiedenis en metadata

3. **Edit Protection**
   - Definitie met status Vastgesteld
   - Probeer te bewerken in Bewerkâ€‘tab â†’ readâ€‘only met duidelijke melding
   - Expertâ€‘tab: "Maak bewerkbaar" met verplicht redenâ€‘veld
   - Na terugzetten status = Concept â†’ Bewerkâ€‘tab weer bewerkbaar

4. **Zoek op status**
   - Zoekfilter op "Vastgesteld" toont alle vastgestelde definities (incl. sample uit schema)
   - Open Ã©Ã©n record â†’ readâ€‘only; status kan via Expertâ€‘tab teruggezet worden (met logging)

## Definition of Done

- [ ] Expert Review tab heeft approve/reject knoppen
- [ ] Workflow service integratie werkt
- [ ] Status changes worden gelogd in history
- [ ] Visuele status indicators werkend
- [ ] Prefill toont laatst gegenereerde definitie met alle context (readâ€‘only)
- [ ] Filter op status (incl. Vastgesteld) werkt
- [ ] Edit bescherming voor Vastgesteld (readâ€‘only) + expliciet terugzetten mogelijk
- [ ] Tests voor approval workflow
- [ ] Documentatie bijgewerkt

## Dependencies

- **US-072**: DefinitionWorkflowService (âœ… Completed)
- **US-064**: Definition Edit Interface (âœ… Completed)  
- **Database**: approved_by, approved_at, approval_notes kolommen bestaan al

## Notes

- De backend service bestaat al volledig (DefinitionWorkflowService)
- Database kolommen voor approval metadata bestaan al
- Dit is puur een UI implementatie taak
- Single-user app: geen complexe rol-based access control nodig

## Geschatte Implementatietijd

- Expert Review tab uitbreiding: 2 uur
- Status visualisatie: 1 uur  
- Edit protection logic: 1 uur
- Testing: 1 uur
- **Totaal: ~5 uur**
