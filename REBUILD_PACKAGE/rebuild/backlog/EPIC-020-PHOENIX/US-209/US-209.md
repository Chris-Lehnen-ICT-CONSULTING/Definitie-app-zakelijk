---
id: US-209
epic: EPIC-020
title: Separate validation logic from prompt hints
status: open
priority: HIGH
created: 2025-01-18
updated: 2025-01-18
owner: development-team
applies_to: definitie-app@current
canonical: false
last_verified: 2025-10-02
tags:
  - phoenix
  - validation
  - prompts
  - ai
  - separation-of-concerns
estimated_hours: 12
actual_hours: 0
---

# US-209: Separate validation logic from prompt hints

## User Story
Als een **AI engineer** wil ik **validatie logica gescheiden van prompt hints** zodat ik **prompts kan optimaliseren zonder validatie regels te breken**.

## Context
Het huidige systeem mixt validatie logica met AI prompt instructies:
- Validatie regels bevatten prompt hints
- Prompt service haalt hints uit validatie modules
- Wijzigingen in prompts kunnen validatie beïnvloeden
- Moeilijk om prompts te A/B testen
- Geen centrale plek voor prompt management

Dit veroorzaakt:
- Tight coupling tussen validatie en AI generatie
- Inconsistente prompt formuleringen
- Moeilijk te optimaliseren prompts
- Geen versie controle op prompts
- Duplicatie van instructies

## Acceptance Criteria

1. **Clear Separation**
   - [ ] Validatie logica bevat GEEN prompt-specifieke code
   - [ ] Prompt hints in aparte configuratie/modules
   - [ ] Duidelijke interface tussen validatie en prompts

2. **Prompt Hint System**
   - [ ] Centralized prompt hint repository
   - [ ] Versioning voor prompt hints
   - [ ] Mapping tussen regel IDs en prompt hints
   - [ ] Support voor meerdere prompt varianten (A/B testing)

3. **Integration Points**
   - [ ] PromptServiceV2 haalt hints uit nieuwe repository
   - [ ] Validation rules kunnen hint IDs exposen (optional)
   - [ ] Backwards compatible met huidige prompt generation

4. **Prompt Management**
   - [ ] CRUD operations voor prompt hints
   - [ ] Prompt template system
   - [ ] Context-aware hint selection
   - [ ] Performance metrics per prompt variant

5. **Migration**
   - [ ] Alle bestaande prompt hints geëxtraheerd
   - [ ] Prompt hints gecategoriseerd en geoptimaliseerd
   - [ ] Legacy prompt code verwijderd uit validation modules

## Technical Design

### Prompt Hint Repository Structure
```python
# src/prompts/hints/validation_hints.py
from dataclasses import dataclass
from typing import Dict, List, Optional
from enum import Enum

class HintType(Enum):
    INSTRUCTION = "instruction"
    WARNING = "warning"
    EXAMPLE = "example"
    CONTEXT = "context"

@dataclass
class PromptHint:
    """Individual prompt hint for AI generation."""
    id: str
    rule_id: Optional[str]  # Link to validation rule if applicable
    type: HintType
    content: str
    priority: int = 5
    active: bool = True
    version: str = "1.0"
    variants: Dict[str, str] = None  # A/B test variants

class ValidationPromptHints:
    """Repository of all validation-related prompt hints."""

    # Structure hints (STR category)
    STR_HINTS = {
        "STR-01": PromptHint(
            id="hint_str_01_lowercase",
            rule_id="STR-01",
            type=HintType.INSTRUCTION,
            content="Begin de definitie ALTIJD met een kleine letter, tenzij het een eigennaam betreft",
            priority=8,
            variants={
                "a": "Begin de definitie ALTIJD met een kleine letter, tenzij het een eigennaam betreft",
                "b": "Start definities met kleine letter (uitgezonderd eigennamen)",
                "c": "Gebruik geen hoofdletter aan het begin van de definitie"
            }
        ),
        "STR-02": PromptHint(
            id="hint_str_02_no_period",
            rule_id="STR-02",
            type=HintType.WARNING,
            content="Eindig de definitie NOOIT met een punt",
            priority=7
        ),
        # ... more STR hints
    }

    # Integrity hints (INT category)
    INT_HINTS = {
        "INT-01": PromptHint(
            id="hint_int_01_circular",
            rule_id="INT-01",
            type=HintType.WARNING,
            content="Vermijd cirkelredeneringen - gebruik het te definiëren begrip NIET in de definitie zelf",
            priority=9,
            variants={
                "a": "Vermijd cirkelredeneringen - gebruik het te definiëren begrip NIET in de definitie zelf",
                "b": "De definitie mag het begrip zelf niet bevatten (geen cirkelredenering)",
                "c": "Definieer zonder het woord zelf te gebruiken"
            }
        ),
        # ... more INT hints
    }

    # Essential hints (ESS category)
    ESS_HINTS = {
        "ESS-01": PromptHint(
            id="hint_ess_01_genre_differentia",
            rule_id="ESS-01",
            type=HintType.INSTRUCTION,
            content="Gebruik de genus-differentia structuur: [overkoepelend begrip] + [onderscheidend kenmerk]",
            priority=10
        ),
        # ... more ESS hints
    }

    def get_hints_for_rule(self, rule_id: str, variant: Optional[str] = None) -> List[PromptHint]:
        """Get all hints for a specific validation rule."""
        # Implementation
        pass

    def get_hints_by_type(self, hint_type: HintType) -> List[PromptHint]:
        """Get all hints of a specific type."""
        # Implementation
        pass

    def get_active_variant(self, hint_id: str, context: Dict = None) -> str:
        """Get the active variant for a hint (for A/B testing)."""
        # Implementation
        pass
```

### Prompt Builder Integration
```python
# src/prompts/builders/definition_prompt_builder.py
from typing import List, Dict, Optional
from src.prompts.hints.validation_hints import ValidationPromptHints, HintType

class DefinitionPromptBuilder:
    """Builds prompts for definition generation."""

    def __init__(self):
        self.hint_repository = ValidationPromptHints()
        self.template_engine = PromptTemplateEngine()

    def build_generation_prompt(
        self,
        term: str,
        context: Dict,
        include_hints: bool = True,
        hint_variant: Optional[str] = None
    ) -> str:
        """Build a complete prompt for definition generation."""

        # Base prompt template
        prompt = self.template_engine.get_template("definition_generation")

        # Add term and context
        prompt = prompt.format(term=term, context=context.get("description", ""))

        # Add validation hints if requested
        if include_hints:
            instructions = self._build_instruction_section(hint_variant)
            warnings = self._build_warning_section(hint_variant)
            examples = self._build_example_section(hint_variant)

            prompt += f"\n\n## Instructies\n{instructions}"
            prompt += f"\n\n## Let op\n{warnings}"
            prompt += f"\n\n## Voorbeelden\n{examples}"

        return prompt

    def _build_instruction_section(self, variant: Optional[str] = None) -> str:
        """Build instruction section from hints."""
        hints = self.hint_repository.get_hints_by_type(HintType.INSTRUCTION)
        instructions = []

        for hint in sorted(hints, key=lambda h: h.priority, reverse=True):
            if hint.active:
                content = self.hint_repository.get_active_variant(hint.id, {"variant": variant})
                instructions.append(f"- {content}")

        return "\n".join(instructions)

    def _build_warning_section(self, variant: Optional[str] = None) -> str:
        """Build warning section from hints."""
        # Similar implementation
        pass

    def _build_example_section(self, variant: Optional[str] = None) -> str:
        """Build example section from hints."""
        # Similar implementation
        pass
```

### Configuration Management
```yaml
# config/prompt_hints.yaml
version: "2.0"
active_variant: "a"  # For A/B testing

categories:
  structure:
    description: "Hints voor structurele validatie regels"
    hints:
      - id: "hint_str_01_lowercase"
        rule_id: "STR-01"
        type: "instruction"
        content: "Begin de definitie ALTIJD met een kleine letter"
        priority: 8
        active: true

  integrity:
    description: "Hints voor integriteit validatie regels"
    hints:
      - id: "hint_int_01_circular"
        rule_id: "INT-01"
        type: "warning"
        content: "Vermijd cirkelredeneringen"
        priority: 9
        active: true

  essential:
    description: "Hints voor essentiële validatie regels"
    hints:
      - id: "hint_ess_01_genre_differentia"
        rule_id: "ESS-01"
        type: "instruction"
        content: "Gebruik genus-differentia structuur"
        priority: 10
        active: true

# A/B test configurations
experiments:
  - id: "exp_001_instruction_style"
    hints: ["hint_str_01_lowercase", "hint_int_01_circular"]
    variants: ["a", "b", "c"]
    metrics: ["generation_quality", "validation_score"]
    active: true
```

### Metrics and Tracking
```python
# src/prompts/metrics/hint_metrics.py
class PromptHintMetrics:
    """Track performance of different prompt hints."""

    def track_generation(
        self,
        hint_ids: List[str],
        variant: str,
        validation_score: float,
        user_feedback: Optional[str] = None
    ):
        """Track metrics for a generation using specific hints."""
        # Log to database or analytics service
        pass

    def get_performance_report(self, hint_id: str) -> Dict:
        """Get performance metrics for a specific hint."""
        return {
            "hint_id": hint_id,
            "total_uses": 1000,
            "avg_validation_score": 8.5,
            "variants": {
                "a": {"uses": 400, "avg_score": 8.3},
                "b": {"uses": 400, "avg_score": 8.7},
                "c": {"uses": 200, "avg_score": 8.5}
            },
            "recommendation": "Use variant 'b' for best results"
        }
```

## Implementation Notes

1. **Migration Strategy**
   - Extract hints from existing validation modules
   - Create mapping between rule IDs and hint IDs
   - Gradual migration with feature flags
   - Maintain backwards compatibility during transition

2. **Performance Considerations**
   - Cache compiled prompts
   - Lazy load hint repository
   - Minimize database queries for hint retrieval

3. **Testing Requirements**
   - Unit tests for hint repository
   - Integration tests with prompt builder
   - A/B test framework validation
   - Regression tests for prompt quality

4. **Monitoring & Analytics**
   - Track hint usage frequency
   - Monitor validation scores per hint variant
   - User feedback correlation analysis
   - Automatic variant selection based on performance

## Dependencies
- Existing validation rule system (US-208)
- PromptServiceV2
- Configuration management system
- Optional: Analytics/metrics service

## Risks & Mitigations
- **Risk**: Prompt quality degradation during migration
  - **Mitigation**: Extensive testing, gradual rollout, rollback plan

- **Risk**: Increased complexity in prompt management
  - **Mitigation**: Clear documentation, UI for hint management

- **Risk**: Performance overhead from hint lookup
  - **Mitigation**: Caching, optimized data structures

## Definition of Done
- [ ] Prompt hints extracted from all validation modules
- [ ] Hint repository implemented with full CRUD operations
- [ ] Prompt builder integrated with hint repository
- [ ] A/B testing framework operational
- [ ] Migration script tested and executed
- [ ] Legacy prompt code removed from validation modules
- [ ] Unit tests for hint system (>85% coverage)
- [ ] Integration tests with PromptServiceV2
- [ ] Performance benchmarks show <100ms overhead
- [ ] Documentation for hint management
- [ ] Admin UI for hint configuration (optional)
- [ ] Metrics dashboard for hint performance
- [ ] Code review completed
- [ ] Successful test in staging environment

## Notes
- Coordinate met US-208 voor clean validation interfaces
- Consider future ML-based hint optimization
- Prepare for multi-language support in hints
- This enables future prompt engineering workflows