---
id: US-446
epic: EPIC-026
titel: PromptOrchestrator Opsplitsen in Engine en Modules
type: refactor
status: Nog te bepalen
prioriteit: HOOG
story_points: 5
sprint: backlog
owner: code-architect
applies_to: definitie-app@current
canonical: false
last_verified: 2025-10-03
vereisten:
  - REQ-091
---

# US-446: PromptOrchestrator Opsplitsen in Engine en Modules

## Gebruikersverhaal
**Als** prompt-engineer  
**wil ik** de huidige `PromptOrchestrator` opdelen in een kernengine, dependency-graph en uitvoeringslaag  
**zodat** de rebuild dezelfde orchestration kan draaien in een async/servicelaag.

## Acceptatiecriteria
- [ ] Orchestrator bestaat uit duidelijk gescheiden componenten: graph builder, executor (parallel/sequentieel) en output-combiner.  
- [ ] Module-interfaces blijven ongewijzigd zodat bestaande modules compatibel blijven.  
- [ ] Unit-tests dekken topologische sortering, cycle-detectie en parallelle batching.  
- [ ] Documentatie beschrijft hoe de engine in nieuwe architecturen (bijv. FastAPI) ingeplugd kan worden.

## Technische Context
- Bron: `src/services/prompts/modules/prompt_orchestrator.py`.  
- Gebruikt `ThreadPoolExecutor`, dependency-graph en shared state.  
- Cruciaal voor tokenoptimalisatie en module selectie.

## Implementatiestappen
- Identificeer verantwoordelijkheden en creëer afzonderlijke klassen.  
- Zorg voor configuratie (max_workers, module order) via constructor.  
- Update call-sites en houd backward compatibility (facade).  
- Schrijf migration notes voor rebuild-team.

## Teststrategie
- Unit-tests per component (graph builder, executor, combiner).  
- Integratietest met echte modules om regressies te detecteren.  
- Performance test (parallel batches) om regressie te voorkomen.

## Risico's en Mitigatie
- **Risico:** race conditions → **Mitigatie:** concurrency-tests en locks waar nodig.  
- **Risico:** module volgorde wijzigt → **Mitigatie:** snapshot output en diff.  
- **Risico:** compatibiliteit → **Mitigatie:** facade + deprecation plan.

## Definition of Done
- [ ] Nieuwe componenten in gebruik.  
- [ ] Tests groen en documentatie bijgewerkt.  
- [ ] QA bevestigt dat prompt-output ongewijzigd is.  
- [ ] Backward compatibility plan gecommuniceerd.
