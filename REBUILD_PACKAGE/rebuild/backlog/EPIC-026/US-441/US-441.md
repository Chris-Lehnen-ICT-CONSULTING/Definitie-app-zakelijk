---
id: US-441
epic: EPIC-026
titel: Definition Generation Workflow Service Extractie
type: refactor
status: Nog te bepalen
prioriteit: HOOG
story_points: 8
sprint: backlog
owner: code-architect
applies_to: definitie-app@current
canonical: false
last_verified: 2025-10-03
vereisten:
  - REQ-091
---

# US-441: Definition Generation Workflow Service Extractie

## Gebruikersverhaal
**Als** senior developer
**wil ik** de huidige `_handle_definition_generation()` workflow overhevelen naar een dedicated servicecontract  
**zodat** de UI vrij blijft van businesslogica en de rebuild dezelfde flow kan hergebruiken.

## Acceptatiecriteria
- [ ] Er bestaat een `DefinitionGenerationWorkflowService` met een expliciete input/output-structuur.  
- [ ] Alle stappen (duplicate-gate, documentcontext, snippetselectie, servicecall, resultaatmapping) draaien via de service en niet langer in `tabbed_interface.py`.  
- [ ] Integratietesten bewijzen dat zowel forced als niet-forced generatie dezelfde resultaten leveren als voor de refactor.  
- [ ] UI-code roept enkel de nieuwe service aan en bevat geen directe `SessionStateManager`-mutaties voor deze flow.

## Technische Context
- Huidige locatie: `src/ui/tabbed_interface.py:821`  
- Belangrijke afhankelijkheden: `DefinitieChecker`, `DocumentProcessor`, `run_async`, `SessionStateManager`.  
- Documenteer inputvelden (begrip, context, opties) en outputs (resultaat, waarschuwingen) zodat rebuild-teams een API kunnen ontwerpen zonder Streamlit-details.

## Implementatiestappen
- Identificeer en documenteer alle gebruikte session-state keys en vorm deze om tot DTO's.  
- Verplaats workflowlogica incrementeel (duplicate-check → context → generation → opslag) naar service en verwijder dode code in de UI.  
- Introduceer facade/adapter voor tijdelijke compatibiliteit en verwijder na succes.  
- Werk architectuurdocumentatie en responsibility map bij.

## Teststrategie
- Nieuwe unit-tests voor de service (success, duplicate, force, foutpad).  
- Bestaande UI-integratietest uitbreiden zodat button-flows dezelfde resultaten geven.  
- Snapshot van `last_generation_result` voor en na refactor vergelijken met baseline.

## Risico's en Mitigatie
- **Risico:** onvolledige mapping van session-state → **Mitigatie:** lijst alle keys vooraf en review met QA.  
- **Risico:** regressies in duplicate-gate → **Mitigatie:** testcases met bestaande duplicaten uitvoeren.  
- **Risico:** async/sync race conditions → **Mitigatie:** gebruik vaste `run_async` wrapper en schrijf concurrency-test.

## Definition of Done
- [ ] Service geïmplementeerd en aangeroepen door UI.  
- [ ] Unit- en integratietests groen.  
- [ ] Documentatie (responsibility map + architectuur) geüpdatet.  
- [ ] Review door architect + QA akkoord.
