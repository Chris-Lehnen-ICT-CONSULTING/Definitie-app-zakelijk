---
id: US-252
titel: Token‑budget guards en max‑prompt‑length tuning
status: proposed
priority: P2
owner: architecture
applies_to: definitie-app@v2
canonical: false
last_verified: 2025-09-22
links:
  - EPIC-019
---

# US-019-15 — Token guards & max length

Als productteam wil ik harde grenzen op promptlengte en nette truncatie, zodat prompts nooit buiten kaders vallen en kosten beheersbaar blijven.

## As‑Is
- ModularPromptAdapter truncate bij zeer hoge limiet (35k chars).

Bronnen:
- src/services/prompts/modular_prompt_adapter.py:100 (length check), 22 (PromptComponentConfig.max_prompt_length)

## To‑Be
- Verlaag default max_prompt_length (bijv. 12k chars) en voeg optionele tokenbudget guard per sectie.

## Acceptance Criteria
- AC1: Promptlengte overschrijdt de nieuwe limiet niet; truncatie op woordgrenzen.
- AC2: Geen secties afbreken midden in markdown header.

## Implementatie (richting)
1) Verlaag `PromptComponentConfig.max_prompt_length` default naar ~12000.
2) Post‑processing: trim op woordgrens en sectiegrens (herken `\n\n###`).

## Testplan
- Unit: forceer lange prompt; assert truncatie en integriteit sectieopmaak.

## Risks / Mitigations
- Risico: kritieke instructie weggevallen door truncatie
  - Mitigatie: sectie prioriteit toepassen; trim eerst minder kritieke secties (metrics, voorbeelden).
