---
id: US-188
epic: EPIC-017
titel: Iteration Controller voor V2 Orchestrator
type: feature
status: open
prioriteit: HOOG
story_points: 8
aangemaakt: 2025-09-15
bijgewerkt: 2025-09-15
owner: architecture
applies_to: definitie-app@current
canonical: false
last_verified: 2025-09-15
vereisten:
  - REQ-097
---

# US-188: Iteration Controller voor V2 Orchestrator

## Doel
Implementeer een iteratieloop bovenop de V2‑orchestrator met duidelijke stopcriteria en telemetrie: generate → validate → feedback → repeat (≤3 iteraties), stop bij acceptatie of minimale verbetering < 0.05.

## Acceptatiecriteria
- [ ] Iteraties ≤ 3, configurabel met defaults.
- [ ] Stop bij is_acceptable=True (policy), of bij scoreverbetering < 0.05 t.o.v. vorige iteratie.
- [ ] Geen kritieke violations toegestaan; category‑score ≥ 0.75 (policy/layered check).
- [ ] Voorbeelden uit iteratie 1 kunnen hergebruikt worden (prestatieoptimalisatie).
- [ ] Telemetrie per iteratie (score, violations, duration, used_feedback, reused_examples)
- [ ] Contract V2: output blijft UIResponse‑vorm; geen legacy “best_iteration”.

## Definition of Done
- [ ] Nieuwe controller (of orchestrator‑fase) met iteratielogica en configuratie.
- [ ] Telemetrie hooks en samenvatting in metadata.
- [ ] Unit/integratie tests (mocks) voor stopcriteria en prestaties.
- [ ] Documentatie bijgewerkt (EPIC‑017 referentie, configuratiehandleiding).

## Technical Notes
- Config: max_iter=3, improvement_threshold=0.05, acceptance_threshold=0.80 (policy‑gedreven waar zinvol).
- Hergebruik voorbeelden: cache voorbeelden van iteratie 1, pas alleen bij echte verbetering regenereren.
- Telemetry: verzamel per iteratie; UI leest via metadata.iterations[].

### Pseudocode (V2)
```
best = None
prev_score = None
for i in range(1, max_iter + 1):
    if i == 1:
        candidate = generate(request)
    else:
        feedback = feedback_builder.get_feedback_for(prev_violations, i, history)
        candidate = generate(request, feedback=feedback, reuse_examples=True)

    score, violations = validate(candidate)

    if best is None or score > best.score:
        best = candidate

    if gate_pass(score, violations, policy):
        break

    if prev_score is not None and (score - prev_score) < improvement_threshold:
        break

    prev_score = score
    prev_violations = violations

return best
```

## Testplan
- Unit: stop bij acceptatie; stop bij < 0.05; hard‑limit op 3 iteraties; hergebruik voorbeelden.
- Integratie (offline/mocks): 3 scenario’s (accept in 1, accept in 2, stagnatie in 3). Determinisme asserts.
- Performance smoke: iteratiepad < X ms met mocks (budget bepalen).

## Risico’s
- Onnodige iteraties → early‑stop en drempels correct toepassen.
- Contract drift → UI‑contracttest en schema‑asserts.
