---
id: US-192
epic: EPIC-002
status: in_progress
prioriteit: HOOG
story_points: 8
sprint: next
owner: validation
applies_to: definitie-app@current
canonical: false
last_verified: 2025-09-19
---

# US-192 — V2 Validator: JSON‑regel Evaluatie + ESS‑02 + DB‑check CON‑01

Context
De V2‑validator (ModularValidationService) gebruikt nu interne rules (VAL‑*, STR‑*, CON‑CIRC‑*) en evalueert de JSON‑toetsregels nog niet. Ook ontbreekt ESS‑02 in V2, en CON‑01 vraagt een DB‑kruischeck voor duplicate contextcombinaties.

Doel
Implementeer JSON‑toetsregel evaluatie in ModularValidationService, inclusief:
- ESS‑02 eenduidigheidslogica (marker‑override, 1‑hit/ambigu/no‑hit)
- Additional patterns uit legacy interpreter (CON‑01, ESS‑01, INT‑01/03, STR‑01/02)
- DB‑kruischeck voor CON‑01 (duplicate contextcombinatie → waarschuwing met bestaande definitie‑ID)
- Severity/gewicht mapping conform JSON; deterministische violations

Scope
- Modules: `src/services/validation/modular_validation_service.py`
- Loader/manager: (her)gebruik `src/toetsregels/loader.py` en `src/toetsregels/manager.py`
- Geen UI‑wijzigingen; validator levert metadata zodat UI bestaande definitie kan tonen bij duplicates.

Niet in scope
- Prompt metadata propagatie (valt onder EPIC‑010/US‑179)
- Regelherstructurering (valt onder US‑180)

Implementatiestappen
1) Rules‑load & compile
   - Laad alle JSON‑regels via ToetsregelManager en compileer regex per regel.
   - Map `prioriteit/aanbeveling` → weight/severity.
2) Evaluatie per regel
   - FORBIDDEN_PATTERN: match → violation
   - Required element/structure: roep helperchecks aan (zoals in legacy) → violation bij ontbreken
   - ESS‑02: implementeer marker‑override, 1‑hit/ambigu/none‑hit gedrag (zie migratieplan)
3) CON‑01 DB‑kruischeck
   - Normaliseer contextlijsten (casefold/trim/unique), serialize naar JSON
   - Query op (begrip, org_ctx, jur_ctx, optioneel categorie, status != archived)
   - Bij hit: voeg WARNING (code CON‑01‑DUP) met metadata {existing_definition_id, status}
4) Aggregatie & determinisme
   - Violations sorteren op code; consistent score‑aggregation
5) Tests
   - Unit: per kernregel (CON‑01, ESS‑01/02, INT‑01/03, STR‑01/02, VER‑01)
   - Integratie: orchestrator V2 validate_text/validate_definition; schema‑conform resultaat

Acceptatiecriteria
- [ ] JSON‑regels worden geëvalueerd in V2 (zonder legacy validator aanroep)
- [ ] ESS‑02: marker‑override en categorie‑eenduidigheid werken conform plan
- [ ] CON‑01: faalt bij geen context; waarschuwt bij duplicate met bestaande definitie‑ID in metadata
- [ ] Additional patterns (CON‑01, ESS‑01, INT‑01/03, STR‑01/02) toegepast
- [ ] Violations deterministisch gesorteerd; severity/weight volgen JSON
- [ ] Unit en integratietests groen

## Voortgang
- Gereed:
  - JSON‑regel evaluatie actief in V2 voor meerdere regels (CON‑01/02, ESS‑01/02/03/04/05, INT‑01/03, STR‑01/02, VER‑01) met deterministische sortering.
  - Positieve‑patroon interpretatie toegevoegd voor ESS‑03/04/05 (hits zijn bewijs van aanwezigheid; violation alleen bij ontbreken).
  - CON‑01: duplicate‑context waarschuwing via repository‑check met `existing_definition_id` in metadata.
  - Initiële golden tests groen: INT‑01, CON‑01; aanvullende goldens voor STR/INT/VER/ESS toegevoegd en groen.
  - CFR‑BUG‑023 opgelost (2025‑09‑19): UI‑dependencies buiten UI verwijderd; acceptatiegreps leveren 0 hits. Zie docs/backlog/EPIC-010/US-172/CFR-BUG-023/README.md.
- Nog te doen:
  - Uitbreiden goldens naar volledige dekking van ARAI/STR/SAM/VER clusters en randgevallen.
  - Fine‑tunen severity/gewichten conform JSON (waar nodig) en documenteren.

Constraints
- Respecteer CLAUDE.md (geen Streamlit/asyncio.run in services; geen backwards‑compat)
- README gates (EPIC‑010) blijven groen
- Canonical locaties voor docs; V2‑contract (TypedDict) blijft leidend

Risico’s & mitigaties
- Regex vals‑positief: golden tests per regel; compile cache; limiet op matches
- DB‑kruischeck performance: parametrized query + indexgebruik; alleen bij CON‑01 uitvoeren
- Gedragsverandering: documenteer in CHANGELOG; dekken met tests
