
<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EPIC-012 - EPIC-012</title>
  <link rel="stylesheet" href="../assets/style.css" />
</head>
<body>
  <div class="container">
    <div class="breadcrumbs"><a href="../index.html">Requirements</a> / <span>EPIC-012</span></div>
    <h1>EPIC-012: EPIC-012</h1>
    <div><h1>EPIC-012: Legacy Orchestrator Refactoring</h1>

<h2>Epic Overview</h2>
<p>**ID**: EPIC-012</p>
<p>**Titel**: Refactor legacy orchestrators met behoud van business kennis</p>
<p>**Status**: TODO</p>
<p>**Priority**: HIGH - NEXT UP</p>
<p>**Created**: 2025-01-10</p>
<p>**Updated**: 2025-09-11</p>
<p>**Progress**: US-061 COMPLETED - Business kennis geëxtraheerd en gedocumenteerd</p>
<p>**Decision (2025-09-11)**: Start met US-064 vóór US-062 voor maximale waarde</p>
<p>**Follow-up**: Zie [EPIC-014](../EPIC-014/EPIC-014.md) voor implementatie van geëxtraheerde business logic</p>
<p>**Iteratieve verbeteringen verplaatst**: Zie [EPIC-017](../EPIC-017/EPIC-017.md) voor de iteratieve V2‑loop en UI‑koppeling (voorheen o.a. US‑170/US‑152 in deze epic)</p>
<p>**Owner**: Development Team</p>
<p>**Sprint Planning**: Week 2 September 2025 (Na EPIC-010 completion)</p>

<h2>Business Value</h2>
<p>De applicatie bevat waardevolle business logica verspreid over 8 legacy bestanden. Deze refactoring zal:</p>
<ul>
<li>**Business kennis consolideren** in moderne V2 architectuur</li>
<li>**Intelligente feedback logica behouden** met 11+ validatie mappings</li>
<li>**Performance optimalisaties integreren** uit legacy code</li>
<li>**Code kwaliteit verbeteren** zonder functionaliteit verlies</li>
<li>**Single source of truth** creëren voor orchestration</li>
</ul>

<h2>Scope</h2>
<h3>In Scope</h3>
<ul>
<li>Extractie en documentatie van alle business regels uit legacy</li>
<li>Refactoring van business logica naar moderne V2 services</li>
<li>Consolidatie van 8 legacy bestanden naar geïntegreerde V2 modules</li>
<li>Behoud van alle intelligente algoritmes (feedback, status, improvement)</li>
<li>Creatie van nieuwe services waar nodig voor business logica</li>
</ul>

<h3>Out of Scope</h3>
<ul>
<li>Backwards compatibility (single user applicatie)</li>
<li>Database migraties</li>
<li>UI redesign</li>
<li>Feature toevoegingen</li>
</ul>

<h2>Technical Context</h2>

<h3>Legacy Components te REFACTOREN (niet verwijderen!)</h3>
<p>1. **DefinitionOrchestrator V1** (<code>src/services/definition_orchestrator.py</code>) - 530 regels</p>
<ul>
<li>Bevat: Status bepaling algoritme, update flow, stats tracking</li>
</ul>
<p>2. **DefinitieAgent System** (<code>src/orchestration/definitie_agent.py</code>) - 1034 regels</p>
<ul>
<li>Bevat: FeedbackBuilder, iterative improvement, performance optimalisaties</li>
</ul>
<p>3. **Legacy Generator Modules** (6 bestanden):</p>
<ul>
<li>`definition_generator_config.py` - Business configuratie parameters</li>
<li>`definition_generator_context.py` - EnrichedContext management</li>
<li>`definition_generator_enhancement.py` - Enhancement business rules ⚠️ **Bevat domein field references**</li>
<li>`definition_generator_prompts.py` - Prompt building intelligence</li>
<li>`definition_generator_cache.py` - Performance optimalisaties</li>
<li>`definition_generator_monitoring.py` - Metrics en monitoring logica</li>
</ul>

<p>**Note:** Deze modules bevatten de domein field references die door CI gates zijn gedetecteerd.</p>

<h3>Waardevolle Business Kennis te EXTRAHEREN en BEHOUDEN</h3>
<ul>
<li>**FeedbackBuilder** met 11 violation mappings</li>
<li>**Status bepaling** (draft/review/established)</li>
<li>**Iterative improvement** met stop criteria</li>
<li>**Performance optimalisaties** (voorbeelden caching)</li>
<li>**Update flow** met selective validation</li>
<li>**Audit trail** (originele tekst opslag)</li>
</ul>

<h2>User Stories</h2>

<p>| ID | Titel | Priority | Points | Status |</p>
<p>|----|-------|----------|--------|--------|</p>
<p>| US-061 | Extract en documenteer business kennis uit legacy | CRITICAL | 5 | **COMPLETED** ✅ |</p>
<p>| US-064 | Consolideer orchestration logica | HIGH | 8 | TODO | NEXT |</p>
<p>| US-152 | Refactor FeedbackBuilder naar moderne service | CRITICAL | 8 | TODO | (Zie EPIC‑017/US‑189 voor uitwerking) |</p>
<p>| US-063 | Integreer legacy config en context in V2 | HIGH | 5 | TODO |</p>
<p>| US-065 | Moderniseer UI dependencies | MEDIUM | 3 | TODO |</p>
<p>| US-066 | Verwijder Legacy DefinitieAgent uit Integratie/UI | HIGH | 5 | TODO |</p>
<p>| US-067 | ServiceFactory Stateless Maken | HIGH | 3 | TODO |</p>
<p>| US-068 | Verwijder Domein Restanten | MEDIUM | 3 | TODO |</p>
<p>| US-069 | Archiveer V1 Orchestrator | MEDIUM | 8 | TODO |</p>
<p>| US-070 | Refactor Category State Manager | MEDIUM | 3 | TODO |</p>
<p>| US-071 | Resilience-consolidatie naar één module | MEDIUM | 5 | TODO |</p>
<p>| US-072 | Export-consolidatie en mappen-opschoning | MEDIUM | 3 | TODO |</p>
<p>| US-159 | Config-harmonisatie, verwijderen dotenv | HIGH | 3 | TODO |</p>
<p>| US-074 | Import-hygiëne, geen sys.path-hacks | HIGH | 5 | TODO |</p>
<p>| US-075 | Centraliseer async/sync-bridging | HIGH | 5 | TODO |</p>
<p>| US-076 | Validators JSON-first + basisklasse | MEDIUM | 8 | TODO |</p>
<p>| US-078 | Test-hygiëne, scheiding bron/test | LOW | 2 | TODO |</p>
<p>| [US-170](../EPIC-017/US-170/US-170.md) | Koppel Orchestration-tab aan V2 Orchestrator (UI wiring) | HIGH | 5 | TODO | (Verplaatst naar EPIC‑017) |</p>

<p>**Totaal Story Points**: 51 (was 29) + 31 (US-071..US-076, US-078) = 82</p>

<h2>Dependencies</h2>
<ul>
<li>Geen externe dependencies</li>
<li>V2 orchestrator moet volledig functioneel zijn (✅ compleet)</li>
<li>Alle tests moeten groen zijn voor start</li>
<li>EPIC-010 fixes moeten eerst geïmplementeerd zijn voor consistente context flow</li>
</ul>

<h2>Relatie met EPIC-010</h2>
<p>De nieuwe user stories (US-066 t/m US-070) zijn geïdentificeerd tijdens de EPIC-010 analyse:</p>
<ul>
<li>**US-066**: Lost inconsistente context/voorbeelden flow op door DefinitieAgent te verwijderen</li>
<li>**US-067**: Garandeert stateless services principe van EPIC-010</li>
<li>**US-068**: Verwijdert verwarring rond context model (domein vs moderne velden)</li>
<li>**US-069**: Consolideert orchestration naar V2-only</li>
<li>**US-070**: Scheidt UI concerns van service layer</li>
</ul>

<h2>Risks & Mitigations</h2>

<p>| Risk | Impact | Probability | Mitigation |</p>
<p>|------|--------|-------------|------------|</p>
<p>| Verlies business kennis | HIGH | LOW | Uitgebreide documentatie en extractie fase |</p>
<p>| Onduidelijke business rules | MEDIUM | MEDIUM | Business logic eerst documenteren, dan refactoren |</p>
<p>| Performance degradatie | MEDIUM | LOW | Legacy optimalisaties analyseren en overnemen |</p>
<p>| Incomplete refactoring | HIGH | LOW | Stapsgewijze aanpak met verificatie |</p>

<h2>Definition of Done</h2>
<ul>
<li>[ ] Alle business kennis gedocumenteerd en geëxtraheerd</li>
<li>[ ] Legacy code gerefactored naar V2 architectuur</li>
<li>[ ] FeedbackBuilder volledig geïntegreerd in V2</li>
<li>[ ] Status bepaling algoritme behouden in V2</li>
<li>[ ] Iterative improvement logica werkend in V2</li>
<li>[ ] Alle tests groen</li>
<li>[ ] Performance gelijk of beter</li>
<li>[ ] Business logica documentatie compleet</li>
</ul>

<h2>Success Metrics</h2>
<ul>
<li>**Business kennis behoud**: 100% van intelligente algoritmes</li>
<li>**Code kwaliteit**: Moderne V2 patterns overal</li>
<li>**Performance**: Gelijk of beter dan legacy</li>
<li>**Functionaliteit**: Alle features blijven werken</li>
<li>**Documentatie**: Elke business rule gedocumenteerd</li>
</ul>

<h2>Implementation Plan</h2>

<h3>Phase 1: Business Knowledge Extraction (US-061)</h3>
<p>**Week 1** - Documenteer alle business logica</p>
<ul>
<li>Analyseer en documenteer FeedbackBuilder algoritmes</li>
<li>Extract status bepaling regels</li>
<li>Document iterative improvement logica</li>
<li>Identificeer alle performance optimalisaties</li>
</ul>

<h3>Phase 2: Orchestration Consolidation (US-064)</h3>
<p>**Week 1-2** - Verenig orchestration logica (PRIORITY FIRST)</p>
<ul>
<li>Integreer iterative improvement haakjes in V2</li>
<li>Implementeer update_definition flow (edit → re‑validate)</li>
<li>Consolideer stats tracking</li>
</ul>

<h3>Phase 3: FeedbackBuilder Refactoring (US-152)</h3>
<p>**Week 2-3** - Kritieke service ná US‑064</p>
<ul>
<li>Creëer FeedbackServiceV2 met 11 mappings (Fase 1)</li>
<li>Integreer violation feedback (post‑validatie hook in DefinitionOrchestratorV2)</li>
<li>Implementeer pattern suggestions en prioritering</li>
<li>A/B test vs legacy en uitbreiden via mapping‑config</li>
</ul>

<h3>Phase 3: Config & Context Integration (US-063)</h3>
<p>**Week 2** - Consolideer configuratie</p>
<ul>
<li>Merge UnifiedGeneratorConfig naar V2</li>
<li>Refactor EnrichedContext naar ContextServiceV2</li>
<li>Behoud alle business parameters</li>
</ul>

<h3>Phase 4: Config & Context Integration (US-063)</h3>
<p>**Week 3** - Consolideer configuratie</p>
<ul>
<li>Merge UnifiedGeneratorConfig naar V2</li>
<li>Refactor EnrichedContext naar ContextServiceV2</li>
<li>Behoud alle business parameters</li>
</ul>

<h3>Phase 5: UI Modernization (US-065)</h3>
<p>**Week 3** - Update dependencies</p>
<ul>
<li>Refactor imports naar V2 services</li>
<li>Test UI met nieuwe services</li>
<li>Verificatie complete functionaliteit</li>
</ul>

<h2>Notes</h2>
<ul>
<li>**REFACTORING, geen backwards compatibility** - single user applicatie</li>
<li>**Business kennis is prioriteit #1** - eerst extraheren, dan refactoren</li>
<li>**Legacy code pas verwijderen** na verificatie dat alle kennis behouden is</li>
<li>**Documenteer elke business regel** tijdens extractie</li>
<li>**Test driven refactoring** - eerst tests voor business logica, dan refactoren</li>
</ul>

<h2>Related Documentation</h2>
<ul>
<li>Code Audit</li>
<li>EPIC-010 - Related context flow refactoring</li>
<li>US-043 - Related legacy context routes removal</li>
<li>US-056 - Related legacy session state removal</li>
<li>V2 Architecture</li>
<li>Migration Guidelines</li>
</ul></div>
    <p class="muted">Bron: <a href="../../rebuild/backlog/EPIC-012/EPIC-012.md">rebuild/backlog/EPIC-012/EPIC-012.md</a></p>
  </div>
</body>
</html>
        