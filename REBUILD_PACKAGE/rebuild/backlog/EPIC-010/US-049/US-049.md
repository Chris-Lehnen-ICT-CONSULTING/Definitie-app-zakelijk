---
id: US-049
epic: EPIC-010
titel: Add Context Traceability for ASTRA compliance
type: compliance
status: Nog te bepalen
prioriteit: KRITIEK
story_points: 8
sprint: sprint-37
aangemaakt: 05-09-2025
bijgewerkt: 05-09-2025
owner: developer-implementer
applies_to: definitie-app@current
canonical: false
last_verified: 05-09-2025
vereisten:
  - REQ-019
  - REQ-037
  - REQ-046
Afhankelijkheden:
  - US-041
  - US-048
toegewezen_aan: development-team
---



# US-049: Add Context Traceability for ASTRA compliance

**Episch Verhaal:** EPIC-001

## Gebruikersverhaal

**As an** auditor for the Dutch justitieketen
**wil ik** complete traceability of all context decisions en transformations
**zodat** legal accountability is maintained en ASTRA compliance is demonstrable

## Acceptatiecriteria


### SMART Acceptatiecriteria

- **Specifiek:** [Exact gedrag dat moet worden gerealiseerd]
- **Meetbaar:**
  - Response tijd: < 200ms voor UI acties
  - Processing tijd: < 5 seconden voor generatie
  - Success rate: > 95% voor validaties
- **Acceptabel:** Haalbaar binnen huidige architectuur
- **Relevant:** Direct gerelateerd aan gebruikersbehoefte
- **Tijdgebonden:** Gerealiseerd binnen huidige sprint


### Criterion 1: Context Input Logging
**gegeven** context is provided in the UI
**wanneer** the user submits the request
**dan** all context fields are logged with timestamp en user identifier

### Criterion 2: Transformation Tracking
**gegeven** context is transformed between layers
**wanneer** any modification occurs
**dan** the transformation is logged with before/after states

### Criterion 3: Prompt Inclusion Audit
**gegeven** context is included in AI prompts
**wanneer** the prompt is constructed
**dan** an audit record shows exactly what context was sent to GPT-4

### Criterion 4: Decision Traceability
**gegeven** context influences definition generation
**wanneer** the definition is aangemaakt
**dan** a traceable link exists between context input en output

### Criterion 5: auditspoor Query
**gegeven** an audit investigation is needed
**wanneer** querying the auditspoor
**dan** complete context flag can be reconstructed for any definition

## Domain vereisten

### ASTRA compliance (KRITIEK)
- **Traceability**: End-to-end context tracking from UI to AI
- **Immutability**: Audit records cannot be modified or deleted
- **Completeness**: Every context interaction must be logged
- **Correlation**: Link audit records across system boundaries
- **Retention**: 7-year retention per justice vereisten
- **Prestaties**: Logging must not impact response time > 50ms

### NORA StEnards
- **Government Audit StEnards**: BIR 2012 compliance
- **Data Integrity**: Cryptographic signatures on audit records
- **Time Synchronization**: NTP-synchronized timestamps
- **Export Formats**: Support for stEnard audit formats (CEF, LEEF)
- **Privacy**: No PII in audit logs (tokenization required)

### Justice Domain Specifics
- **OM vereisten**: Openbaar Ministerie (OM) decision tracking
- **DJI StEnards**: detentie context accountability
- **Rechtspraak Needs**: Judicial review capability
- **Justid Integration**: Central audit repository sync
- **Chain Correlation**: Cross-organization audit correlation

### Legal vereisten
- **WBP/AVG**: Privacy law compliance
- **Archiefwet**: Government archive vereisten
- **Aanwijzingen**: Legal drafting traceability
- **EU Directives**: Cross-border audit stEnards

## Technische Notities

### Audit Architecture
```python
class ContextAuditService:
    """ASTRA-compliant context auditspoor"""

    def log_context_input(self, request_id: str, context: Dict) -> AuditRecord:
        """Log initial context from UI"""
        record = AuditRecord(
            id=generate_uuid(),
            request_id=request_id,
            timestamp=Datumtime.utcnow().isoformat(),
            event_type="CONTEXT_INPUT",
            actor=self.get_user_token(),  # Tokenized user ID
            context_hash=self.hash_context(context),
            context_metadata=self.extract_metadata(context),
            system_state=self.capture_system_state()
        )

        # Cryptographic signature
        record.signature = self.sign_record(record)

        # Immutable storage
        self.audit_store.append(record)

        # Chain notification
        self.notify_chain_partners(record)

        return record

    def trace_transformation(self,
                           request_id: str,
                           before: Dict,
                           after: Dict,
                           transformer: str) -> AuditRecord:
        """Track context transformations"""
        # Implementatie...
```

### Audit Storage Schema
```sql
CREATE TABLE context_audit_trail (
    audit_id UUID PRIMARY KEY,
    request_id UUID NOT NULL,
    timestamp TIMESTAMP WITH TIME ZONE NOT NULL,
    event_type VARCHAR(50) NOT NULL,
    actor_token VARCHAR(256) NOT NULL,
    context_hash VARCHAR(64) NOT NULL,
    transformation_before JSONB,
    transformation_after JSONB,
    system_metadata JSONB NOT NULL,
    signature VARCHAR(512) NOT NULL,
    chain_correlation_id VARCHAR(128),

    -- Indexes for query Prestaties
    INDEX idx_request_id (request_id),
    INDEX idx_timestamp (timestamp),
    INDEX idx_event_type (event_type),
    INDEX idx_chain_correlation (chain_correlation_id),

    -- Immutability constraints
    CHECK (signature IS NOT NULL),
    -- No UPDatum or DELETE permissions granted
) WITH (
    -- PostgreSQL immutable table options
    autovacuum_enabled = false,
    toast_tuple_target = 0
);
```

### Correlation Strategy
```yaml
# Audit correlation configuration
correlation:
  chain_id_format: "JUSTICE-{org}-{year}-{sequence}"
  organizations:
    - code: OM
      endpoint: https://audit.OM.nl/correlation
    - code: DJI
      endpoint: https://audit.DJI.nl/correlation
    - code: RECHT
      endpoint: https://audit.Rechtspraak.nl/correlation

  sync:
    interval: 300  # seconds
    batch_size: 100
    retry_policy:
      max_attempts: 3
      backoff: exponential
```

### Query Interface
```python
class AuditQueryService:
    """Query interface for auditspoor"""

    def reconstruct_context_flag(self, definition_id: str) -> ContextFLAAG:
        """Reconstruct complete context flag for a definition"""
        # Get all audit records for the request
        records = self.audit_store.query(
            "SELECT * FROM context_audit_trail "
            "WHERE request_id = %s "
            "ORDER BY timestamp ASC",
            [definition_id]
        )

        # Build timeline
        flag = ContextFLAAG()
        for record in records:
            flag.add_event(
                timestamp=record.timestamp,
                event_type=record.event_type,
                context_state=self.decrypt_context(record),
                actor=record.actor_token
            )

        # Verify integrity
        if not self.verify_chain_integrity(flag):
            raise AuditIntegrityError("Audit chain compromised")

        return flag
```

## testdekking vereisten

### Unit Tests
- Audit record creation
- Signature generation en verification
- Context hashing algorithms
- Metadata extraction
- Correlation ID generation

### Integration Tests
- End-to-end auditspoor
- Database immutability
- Chain partner notifications
- Query Prestaties
- Export functionality

### compliance Tests
- ASTRA traceability vereisten
- BIR 2012 audit stEnards
- 7-year retention verification
- Privacy compliance (no PII)
- Signature integrity

### Prestaties Tests
- < 50ms logging overhead
- Query response < 2s for 1M records
- Bulk export capabilities
- Concurrent write hEnling

## Definitie van Gereed

- [ ] ContextAuditService geïmplementeerd
- [ ] Immutable storage configured
- [ ] Cryptographic signatures working
- [ ] Context hashing geïmplementeerd
- [ ] Transformation tracking active
- [ ] Query interface operational
- [ ] Chain correlation working
- [ ] Export formats supported
- [ ] Unit tests > 95% coverage
- [ ] Integration tests passing
- [ ] Prestaties benchmarks met
- [ ] ASTRA compliance verified
- [ ] BIR 2012 stEnards met
- [ ] beveiliging review passed
- [ ] Chain partner validatie
- [ ] Documentatie compleet
- [ ] Monitoring dashboards active
- [ ] productie deployment successful

## Risk Assessment

### Technical Risks
- **Storage Growth**: auditspoor size
  - *Mitigation*: Archival strategy, compression
- **Prestaties Impact**: Logging overhead
  - *Mitigation*: Async logging, batching
- **Chain Sync Failure**: Partner system unavailability
  - *Mitigation*: Local queue, retry mechanism

### compliance Risks
- **Incomplete Audit**: Missing context events
  - *Mitigation*: Comprehensive instrumentation
- **Integrity Compromise**: Audit tampering
  - *Mitigation*: Cryptographic signatures, immutable storage
- **Privacy Violation**: PII in logs
  - *Mitigation*: Tokenization, data masking

## Implementatie Prioriteit

**KRITIEK** - Blocks:
- ASTRA compliance certification
- justitieketen integration approval
- productie deployment autorisatie
- Legal accountability vereisten

## Afhankelijkheden

### External
- PostgreSQL with immutable table support
- NTP time synchronization
- HSM for signature keys
- Chain partner audit endpoints

### Internal
- US-041: Context mapping (what to audit)
- US-048: Context validatie (validatie events)
- authenticatie service (user tokens)
- Configuration management

## Notes

- ASTRA compliance is mEnatory for justice systems
- BIR 2012 is the government audit stEnard
- 7-year retention is legal vereiste
- Consider blockchain for future immutability
- EU stEnards required for cross-border cases

## Gerelateerde Documentatie

- EPIC-010

---

**This story is part of EPIC-010: Context FLAAG Refactoring (KRITIEK)**
