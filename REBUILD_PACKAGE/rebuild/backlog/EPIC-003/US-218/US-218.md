---
id: US-218
epic: EPIC-003
titel: True Async Web Lookup Implementation
status: open
prioriteit: P2
story_points: 5
aangemaakt: 2025-09-30
bijgewerkt: 2025-09-30
owner: tbd
applies_to: definitie-app@current
canonical: false
last_verified: 2025-09-30
---

# US-218: True Async Web Lookup Implementation

## User Story
**Als** gebruiker van de DefinitieAgent applicatie
**Wil ik** dat web lookups snel uitgevoerd worden
**Zodat** de response tijd van 3-5 seconden naar <2 seconden gaat

## Context
Huidige performance problemen:
- Pseudo-concurrent implementation (sequential execution)
- 6-12 sequentiële API calls i.p.v. parallel
- 400-800ms onnodige connection overhead
- Geen connection pooling
- Blocking calls in async context

## Acceptatiecriteria
- [ ] Alle providers draaien echt parallel met asyncio
- [ ] Connection pooling geïmplementeerd
- [ ] Response tijd <2 seconden voor typische queries
- [ ] Geen blocking calls in async functies
- [ ] Timeout budget enforcement werkt
- [ ] DNS caching actief

## Technische Details

### True Async Implementation
```python
async def lookup_all_providers(self, term: str) -> List[Result]:
    """True parallel execution"""
    tasks = []

    # Create connection pool
    async with aiohttp.ClientSession(
        connector=aiohttp.TCPConnector(
            limit=10,
            ttl_dns_cache=300
        )
    ) as session:
        # Start all lookups in parallel
        for provider in self.providers:
            task = asyncio.create_task(
                provider.lookup(term, session)
            )
            tasks.append(task)

        # Wait with timeout budget
        results = await asyncio.gather(
            *tasks,
            return_exceptions=True
        )

    return [r for r in results if not isinstance(r, Exception)]
```

### Connection Pool Config
```python
self.connector = aiohttp.TCPConnector(
    limit=10,  # Total connections
    limit_per_host=3,  # Per provider
    ttl_dns_cache=300,  # 5 min DNS cache
    use_dns_cache=True,
    keepalive_timeout=30
)
```

## Geschatte Effort
**2 dagen**

## Dependencies
- US-321 (canonical interfaces)
- US-324 (DI for session injection)

## Testing
- Performance benchmarks (<2s requirement)
- Verify parallel execution
- Test timeout enforcement
- Connection pool metrics

## Notes
- Focus op echte parallellisatie
- Single-user dus simpele pool config
- Belangrijkste performance verbetering

## Definition of Done
- [ ] True async/await implementation
- [ ] Connection pooling actief
- [ ] Response tijd <2 seconden
- [ ] Geen blocking calls meer
- [ ] Performance tests groen
- [ ] Benchmarks gedocumenteerd

## Linked Items
- Epic: [[EPIC-003]] - Content Verrijking / Web Lookup
- Depends on: US-321, US-324
- Performance requirement: <3s response tijd