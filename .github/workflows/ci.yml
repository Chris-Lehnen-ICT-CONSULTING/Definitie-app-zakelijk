# CI-pipeline: ruff → mypy → bandit → pytest

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1) Haal repo op
      - uses: actions/checkout@v4

      # 2) Installeer Python
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3) Cache pip-packages
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      # 4) Installeer dependencies + tooling
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install ruff mypy bandit

      # 5) Ruff lint
      - name: Ruff
        run: ruff check src tests

      # 6) Mypy type-check
      - name: MyPy
        run: mypy src

      # 7) Bandit security-scan
      - name: Bandit
        run: bandit -r src -ll

      # 8) V1 Code Prevention Check
      - name: Check for forbidden V1 symbols
        run: |
          echo "Checking for forbidden V1 symbols..."
          
          # Check for V1 files that should not exist
          if [ -f "src/services/ai_service.py" ]; then
            echo "ERROR: V1 AI service file found (src/services/ai_service.py)"
            exit 1
          fi
          
          if [ -f "src/services/definition_orchestrator.py" ]; then
            echo "ERROR: V1 orchestrator file found (src/services/definition_orchestrator.py)"
            exit 1
          fi
          
          # Check for V1 function references
          if grep -r "stuur_prompt_naar_gpt" src/ --exclude-dir=__pycache__ --include="*.py" 2>/dev/null; then
            echo "ERROR: Found references to V1 function 'stuur_prompt_naar_gpt'"
            exit 1
          fi
          
          # Check for V1 class references (but allow DefinitionOrchestratorV2 and Interface)
          if grep -r "^class DefinitionOrchestrator[^VI]" src/ --exclude-dir=__pycache__ --include="*.py" 2>/dev/null | grep -v "DefinitionOrchestratorInterface"; then
            echo "ERROR: Found V1 DefinitionOrchestrator class (should use DefinitionOrchestratorV2)"
            exit 1
          fi
          
          # Check for get_ai_service imports
          if grep -r "from services.ai_service import get_ai_service" src/ --exclude-dir=__pycache__ --include="*.py" 2>/dev/null; then
            echo "ERROR: Found imports of V1 get_ai_service function"
            exit 1
          fi
          
          echo "✓ No forbidden V1 symbols found"

      # 9) Pytest
      - name: Pytest
        run: |
          export PYTHONPATH=$PWD/src
          pytest -q
          
      # 10) Forbidden symbols test
      - name: Test for forbidden V1 symbols
        run: |
          export PYTHONPATH=$PWD/src
          pytest tests/ci/test_forbidden_symbols.py -v
