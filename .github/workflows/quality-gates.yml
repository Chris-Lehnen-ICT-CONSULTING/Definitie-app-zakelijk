name: Quality Gates

on:
  pull_request:
  push:
    branches: [main]

jobs:
  verify-pre-commit:
    name: Verify Pre-commit Execution
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to check commits

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Check pre-commit ran on latest commit
        run: |
          # Check if pre-commit hooks were executed
          # Look for pre-commit metadata in commit or validate hooks pass
          echo "Verifying pre-commit execution..."

          # Run pre-commit on changed files to verify
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # For PRs, check changed files
            git fetch origin ${{ github.base_ref }}
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
            if [ -n "$CHANGED_FILES" ]; then
              echo "Changed files: $CHANGED_FILES"
              # Run pre-commit on changed files
              echo "$CHANGED_FILES" | xargs pre-commit run --files || {
                echo "‚ùå Pre-commit hooks failed. Did you run pre-commit before pushing?"
                exit 1
              }
            fi
          else
            # For direct pushes, check last commit
            git show --name-only HEAD | tail -n +2 | xargs -r pre-commit run --files || {
              echo "‚ùå Pre-commit hooks failed. Run 'pre-commit run --all-files' locally."
              exit 1
            }
          fi

          echo "‚úÖ Pre-commit verification passed"

  preflight-checks:
    name: Run Preflight Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ripgrep
        run: |
          sudo apt-get update
          sudo apt-get install -y ripgrep

      - name: Run preflight-checks.sh
        run: |
          # Copy preflight checks from unified agent dir if available
          # Otherwise, create minimal version
          if [ -f "$HOME/.ai-agents/preflight-checks.sh" ]; then
            bash "$HOME/.ai-agents/preflight-checks.sh"
          else
            # Fallback: run key checks inline
            echo "üõ°Ô∏è  Running inline preflight checks..."

            # Check forbidden imports
            echo "üì¶ Checking forbidden imports..."
            if rg -q "import streamlit" src/services/ 2>/dev/null; then
              echo "‚ùå Found 'import streamlit' in services/"
              exit 1
            fi

            # Check for hardcoded secrets
            echo "üîí Checking for hardcoded secrets..."
            if rg -q "api_key.*=.*[\"'][A-Za-z0-9]" --type py 2>/dev/null; then
              echo "‚ùå Potential hardcoded API key found"
              exit 1
            fi

            # Check for TODO markers in staged code
            echo "üìã Checking for TODO markers..."
            if rg -q "TODO|FIXME|XXX|HACK" --type py 2>/dev/null; then
              echo "‚ö†Ô∏è  Found TODO markers (should use backlog)"
              # Warning only, not fatal
            fi

            echo "‚úÖ Preflight checks passed"
          fi

  validate-branch-name:
    name: Validate Branch Name
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Check branch naming convention
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          echo "Validating branch name: $BRANCH_NAME"

          # Valid patterns: feature/*, fix/*, hotfix/*, docs/*, refactor/*, test/*
          if [[ "$BRANCH_NAME" =~ ^(feature|fix|hotfix|docs|refactor|test|chore)/.+ ]]; then
            echo "‚úÖ Branch name follows convention"
          else
            echo "‚ùå Invalid branch name: $BRANCH_NAME"
            echo "Branch names must follow pattern: {type}/{description}"
            echo "Valid types: feature, fix, hotfix, docs, refactor, test, chore"
            exit 1
          fi

  quality-summary:
    name: Quality Gate Summary
    runs-on: ubuntu-latest
    needs: [verify-pre-commit, preflight-checks, validate-branch-name]
    if: always()

    steps:
      - name: Check all gates passed
        run: |
          echo "üìä Quality Gate Summary"
          echo "======================="
          echo "Pre-commit: ${{ needs.verify-pre-commit.result }}"
          echo "Preflight: ${{ needs.preflight-checks.result }}"
          echo "Branch name: ${{ needs.validate-branch-name.result }}"

          if [ "${{ needs.verify-pre-commit.result }}" != "success" ] || \
             [ "${{ needs.preflight-checks.result }}" != "success" ]; then
            echo "‚ùå Quality gates failed"
            exit 1
          fi

          # Branch validation only required for PRs
          if [ "${{ github.event_name }}" == "pull_request" ] && \
             [ "${{ needs.validate-branch-name.result }}" != "success" ]; then
            echo "‚ùå Branch name validation failed"
            exit 1
          fi

          echo "‚úÖ All quality gates passed"
