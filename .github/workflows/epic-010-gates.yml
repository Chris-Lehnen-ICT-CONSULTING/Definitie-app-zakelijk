name: EPIC-010 Legacy Pattern Gates

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  check-legacy-patterns:
    runs-on: ubuntu-latest
    name: Check for Legacy Patterns
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Install ripgrep
        run: |
          sudo apt-get update
          sudo apt-get install -y ripgrep
      
      - name: Check for generation_result imports
        run: |
          echo "Checking for legacy generation_result imports..."
          if rg "from src\.models\.generation_result import" src/; then
            echo "‚ùå FAIL: Legacy generation_result imports found"
            exit 1
          fi
          echo "‚úÖ PASS: No generation_result imports"
      
      - name: Check for deprecated attributes
        run: |
          echo "Checking for deprecated attributes (services scope)..."
          # Scope checks to service layer to avoid false positives in validation/analysis/UI
          VIOLATIONS=$(rg -n -P "^(?!\s*#).*\\.overall_score" src/services/ --type py | \
                      grep -v "ValidationResult" || true)
          BI_VIOLATIONS=$(rg -n -P "^(?!\s*#).*\\bbest_iteration\\b" src/services/ --type py || true)
          
          if [ -n "$VIOLATIONS" ] || [ -n "$BI_VIOLATIONS" ]; then
            echo "‚ùå FAIL: Deprecated attributes found in services (.overall_score or .best_iteration)"
            echo "$VIOLATIONS"
            echo "$BI_VIOLATIONS"
            exit 1
          fi
          echo "‚úÖ PASS: No deprecated attributes in services"
      
      - name: Check for string context usage
        run: |
          echo "Checking for string context usage..."
          # Match request.context but NOT request.context_dict, request.context_*, etc
          if rg "request\.context(?!_|\w)" src/ --type py; then
            echo "‚ùå FAIL: String context usage found (request.context)"
            echo "Context must be a list, not a string. Use request.context_dict instead."
            exit 1
          fi
          echo "‚úÖ PASS: No string context usage"
      
      - name: Check for domein field
        run: |
          echo "Checking for domein field usage..."
          # Exclude comments, docstrings, and specific allowed files
          VIOLATIONS=$(rg "\bdomein\b" src/ --type py | \
                      grep -v "^.*#.*domein" | \
                      grep -v '""".*domein.*"""' | \
                      grep -v "# Legacy" | \
                      grep -v "# Deprecated" || true)
          
          if [ -n "$VIOLATIONS" ]; then
            echo "‚ùå FAIL: Domein field usage found"
            echo "The 'domein' field was removed in EPIC-010. Use context fields instead."
            echo "$VIOLATIONS"
            exit 1
          fi
          echo "‚úÖ PASS: No domein field usage"
      
      - name: Check for asyncio.run in services
        run: |
          echo "Checking for asyncio.run in services..."
          if rg "asyncio\.run\(" src/services/ --type py; then
            echo "‚ùå FAIL: asyncio.run found in services"
            echo "Services should be async-native. Use async_bridge in UI layer instead."
            exit 1
          fi
          echo "‚úÖ PASS: No asyncio.run in services"

      - name: Check for event-loop bridging in services
        run: |
          echo "Checking for event-loop bridging in services..."
          if rg "run_coroutine_threadsafe|new_event_loop|run_until_complete" src/services/ --type py; then
            echo "‚ùå FAIL: Event-loop bridging found in services"
            echo "Services should expose async APIs only; bridging belongs in UI."
            exit 1
          fi
          echo "‚úÖ PASS: No event-loop bridging in services"
      
      - name: Check for sync wrapper calls outside async_bridge
        run: |
          echo "Checking for direct sync wrapper calls..."
          # Find calls but exclude async_bridge.py and imports
          VIOLATIONS=$(rg "generate_definition_sync|search_web_sources\(" src/ --type py | \
                      grep -v "async_bridge\.py" | \
                      grep -v "service_factory\.py" | \
                      grep -v "from.*import" | \
                      grep -v "def generate_definition_sync" | \
                      grep -v "def search_web_sources" || true)
          
          if [ -n "$VIOLATIONS" ]; then
            echo "‚ö†Ô∏è WARNING: Direct sync wrapper calls found (will be error after Sprint 37):"
            echo "$VIOLATIONS"
            echo "These should use async_bridge.run_async() instead."
            # Don't fail yet - these are being phased out in Sprint 37
          else
            echo "‚úÖ PASS: No direct sync wrapper calls"
          fi
      
      - name: Check for streamlit imports in services
        run: |
          echo "Checking for streamlit imports in service layer..."
          VIOLATIONS=$(rg "import streamlit|from streamlit" src/services/ --type py | \
                      grep -v "# Legacy" | \
                      grep -v "# Deprecated" || true)
          
          if [ -n "$VIOLATIONS" ]; then
            echo "‚ùå FAIL: Streamlit imports found in services"
            echo "Services should be framework-agnostic. Move UI logic to src/ui/"
            echo "$VIOLATIONS"
            exit 1
          fi
          echo "‚úÖ PASS: No streamlit imports in services"

      - name: Check for UI imports outside UI layer
        run: |
          echo "Checking for UI imports outside src/ui/..."
          VIOLATIONS=$(rg "\bfrom\s+ui\.|\bimport\s+ui\b" src/ --type py | \
                       grep -v "^src/ui/" | \
                       grep -v "^src/main.py" || true)
          if [ -n "$VIOLATIONS" ]; then
            echo "‚ùå FAIL: UI imports found outside src/ui"
            echo "$VIOLATIONS"
            exit 1
          fi
          echo "‚úÖ PASS: No UI imports outside UI"

      - name: Check for streamlit imports outside UI layer
        run: |
          echo "Checking for streamlit imports outside src/ui/..."
          VIOLATIONS=$(rg "^\s*(import|from)\s+streamlit" src/ --type py | \
                       grep -v "^src/ui/" | \
                       grep -v "^src/main.py" || true)
          if [ -n "$VIOLATIONS" ]; then
            echo "‚ùå FAIL: streamlit imports found outside src/ui"
            echo "$VIOLATIONS"
            exit 1
          fi
          echo "‚úÖ PASS: No streamlit imports outside UI"
      
      - name: Summary
        if: success()
        run: |
          echo "üéâ All legacy pattern checks passed!"
          echo "The codebase is clean of deprecated EPIC-010 patterns."
          echo ""
          echo "Patterns checked:"
          echo "  ‚úÖ No legacy generation_result imports"
          echo "  ‚úÖ No deprecated attributes (.overall_score, .best_iteration)"
          echo "  ‚úÖ No string context usage"
          echo "  ‚úÖ No domein field references"
          echo "  ‚úÖ No asyncio.run in services"
          echo "  ‚úÖ No streamlit imports in services"
          echo "  ‚ö†Ô∏è Sync wrappers being phased out (Sprint 37)"
