"""
Test voor enhanced toetser met rich validation.

Test de nieuwe rich validation features zonder de bestaande
functionaliteit te breken.
"""

import pytest
from generation.definitie_generator import OntologischeCategorie
from ai_toetser import validate_definitie_rich, ToetsregelValidationResult


def test_enhanced_toetser_basic():
    """Test basis functionaliteit van enhanced toetser."""
    # Test definitie
    definitie = "Een persoon is een natuurlijk persoon of rechtspersoon."
    
    # Valideer met rich output
    result = validate_definitie_rich(
        definitie=definitie,
        categorie=OntologischeCategorie.TYPE,
        begrip="persoon"
    )
    
    # Verificaties
    assert isinstance(result, ToetsregelValidationResult)
    assert result.definitie == definitie
    assert isinstance(result.overall_score, float)
    assert 0.0 <= result.overall_score <= 1.0
    assert isinstance(result.passed_rules, list)
    assert isinstance(result.failed_rules, list)
    assert isinstance(result.is_acceptable, bool)


def test_enhanced_toetser_with_context():
    """Test met context die violations moet triggeren."""
    # Definitie met expliciete context
    definitie = "Een verdachte is een persoon in de context van het strafrecht."
    
    result = validate_definitie_rich(
        definitie=definitie,
        categorie=OntologischeCategorie.TYPE,
        begrip="verdachte",
        contexten={"juridisch": ["strafrecht", "OM"]}
    )
    
    # Verwacht failure op CON-01
    assert "CON-01" in result.failed_rules or "CON-01" in result.warning_rules
    assert result.overall_score < 1.0
    assert len(result.improvement_suggestions) > 0


def test_enhanced_toetser_string_compatibility():
    """Test dat string output nog steeds werkt voor UI."""
    definitie = "Een document is een schriftelijk stuk dat informatie bevat."
    
    result = validate_definitie_rich(
        definitie=definitie,
        categorie=OntologischeCategorie.TYPE,
        begrip="document"
    )
    
    # Converteer naar strings
    string_list = result.to_string_list()
    
    assert isinstance(string_list, list)
    assert all(isinstance(s, str) for s in string_list)
    assert any("Toetsing Samenvatting" in s for s in string_list)


def test_enhanced_toetser_violations():
    """Test violation tracking."""
    # Definitie met meerdere problemen
    definitie = "Dit is een test. Het bevat meerdere zinnen."
    
    result = validate_definitie_rich(
        definitie=definitie,
        begrip="test"
    )
    
    # Check violations
    assert hasattr(result, 'get_critical_violations')
    assert hasattr(result, 'get_violation_count_by_severity')
    
    severity_counts = result.get_violation_count_by_severity()
    assert isinstance(severity_counts, dict)


if __name__ == "__main__":
    test_enhanced_toetser_basic()
    print("âœ… Basic test passed")
    
    test_enhanced_toetser_with_context()
    print("âœ… Context test passed")
    
    test_enhanced_toetser_string_compatibility()
    print("âœ… String compatibility test passed")
    
    test_enhanced_toetser_violations()
    print("âœ… Violations test passed")
    
    print("\nðŸŽ‰ All tests passed!")