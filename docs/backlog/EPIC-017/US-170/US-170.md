---
id: US-170
epic: EPIC-017
titel: Koppel Orchestration-tab aan V2 Orchestrator (UI wiring)
type: feature
status: open
prioriteit: HOOG
story_points: 5
aangemaakt: 2025-09-15
bijgewerkt: 2025-09-15
owner: frontend-team
applies_to: definitie-app@current
canonical: false
last_verified: 2025-09-15
vereisten:
  - REQ-097
---

# US-170: Koppel Orchestration-tab aan V2 Orchestrator (productiepad)

## User Story
Als product owner wil ik dat de Orchestration-tab de V2 orchestrator echt aanstuurt, zodat we iteratieve verbetering, validatie en opslag met gate‑enforcement kunnen demonstreren en bedienen vanuit de UI.

## Status
Status: TODO  
Priority: HIGH  
Story Points: 5  
Epic: [EPIC-017: Iteratieve Verbeteringen (V2)](../EPIC-017.md)

## Context
De huidige Orchestration-tab is een demo (gesimuleerd) en staat achter een feature flag. Voor volwassen gebruik koppelen we deze aan de V2 orchestrator iteratieloop (US‑188) met echte generatie/validatie, inclusief gate‑policy en veilige foutafhandeling. FeedbackBuilder V2 (US‑189) levert prioriteerde feedback per iteratie.

## Scope
### In Scope
- UI wiring: Orchestration-tab → `DefinitionOrchestratorV2` (iteratieloop via US‑188)
- Async-bridge gebruik (UI) i.p.v. `asyncio.run` in services
- Validatie/gate‑enforcement met policy (`approval_gate.yaml`)
- Veilige foutafhandeling + duidelijke UI feedback (override flow)
- Respecteer V2 UI‑contract (UIResponseDict) overal

### Out of Scope
- Business‑algoritme wijzigingen in de orchestrator (blijven zoals V2)
- Nieuwe features in de orchestrator
- Document import/pipeline (alleen gebruiken indien al aanwezig)

## Acceptatiecriteria
- [ ] Orchestration-tab roept V2 orchestrator aan (geen demo data)
- [ ] Geen `best_iteration`/legacy objecten; V2 dict‑contract in UI
- [ ] Gate‑preview en approve/override gedrag zichtbaar in UI en consistent met policy
- [ ] Echte validatie/violations worden getoond (mapping naar UI)
- [ ] Robuuste foutmeldingen (network/API error → non‑blocking UI)
- [ ] Geen `asyncio.run` in services; UI gebruikt bridge of event loop

## Technisch ontwerp (samenvatting)
- UI: vervang `_simulate_agent_run(...)` door async call naar iteratieloop van `DefinitionOrchestratorV2` via `ui.helpers.async_bridge`.
- Injection: verkrijg orchestrator via DI container (`ServiceContainer.orchestrator()`).
- Context: gebruik V2 context dict (`organisatorisch[]`, `juridisch[]`, `wettelijk[]`).
- Gate: toon `validation_details` en gate‑status; bij override ask‑for‑reason.
- Response: V2 UIResponseDict; toon iteratiemetrics uit metadata.
- Errors: try/except rond AI/validatie; toon non‑blocking status + retry mogelijkheid.

## Beveiliging & Privacy
- Vereist `OPENAI_API_KEY` (gebruik dev‑key lokaal); nooit loggen.
- Respecteer DPIA/AVG redactie (security service hook aanwezig in V2; activeer indien beschikbaar).

## Testplan
- Unit: UI normalisatie → V2 contract (mock orchestrator responses)
- Integratie: happy path (gate pass), override‑pad (override_required), blocked‑pad (blocked)
- Negatief: netwerkfout/timeout → UI toont melding, geen crash

## Checklist Implementatie
- [ ] Async‑bridge gebruiken voor orchestrator calls (geen `asyncio.run`)
- [ ] UI response normaliseren naar UIResponseDict (indien nodig)
- [ ] Gate‑status/reden(en) tonen en override‑reden afdwingen
- [ ] Logging: zonder secrets, met correlation id waar mogelijk
- [ ] Feature flag: tab blijft achter ENV `ENABLE_LEGACY_TAB=true`

## Dependencies
- V2 orchestrator operationeel (`DefinitionOrchestratorV2`)
- Gate‑policy loader (`GatePolicyService`) beschikbaar
- Iteration Controller (US‑188) en FeedbackBuilder V2 (US‑189)

## Notes
- Tab blijft standaard verborgen (flag), zodat demo/experimentele functionaliteit gescheiden blijft van hoofdflow (Generator‑tab).

## Implementatie Referentie (legacy, gearchiveerd)
- Legacy agent met iteratieve loop is gearchiveerd (niet meer in runtime‑pad):
  - `docs/archief/legacy/orchestration/definitie_agent.py`
- Over te nemen businesskennis (US‑061 extractie):
  - Stopcriteria: max 3 iteraties; acceptatie ≥ 0.80; stagnatie < 0.05
  - FeedbackBuilder: 11+ violation→feedback mappings; prioritering; max 5 items/iteratie
  - Voorbeelden: genereren in iteratie 1; hergebruik in latere iteraties
