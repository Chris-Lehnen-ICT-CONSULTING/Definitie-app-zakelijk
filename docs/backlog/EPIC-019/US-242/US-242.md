---
id: US-242
titel: Context normalisatie & deduplicatie (base_context)
status: proposed
priority: P0
owner: architecture
applies_to: definitie-app@v2
canonical: false
last_verified: 2025-09-22
links:
  - EPIC-019
  - EPIC-010
---

# US-019-05 — Context normalisatie

Als gebruiker wil ik dat contextwaarden genormaliseerd en ontdubbeld worden, zodat de prompt geen herhalingen bevat en afkortingen correct worden uitgebreid.

## As‑Is
- Waarden als ‘DJI’ en ‘["DJI"]’ kunnen beide verschijnen.
- Nested lijsten/strings worden niet altijd genormaliseerd.

Bronnen:
- src/services/definition_generator_context.py:246 (_build_base_context)
- src/services/definition_generator_context.py:318 (_expand_abbreviations)

## To‑Be
- Parse JSON‑achtige strings naar lijsten; flatten nested lists; dedup strings case‑sensitief.
- Afkortingen uitbreiden (CONTEXT_AFKORTINGEN) blijft werken.

## Acceptance Criteria
- AC1: Geen dubbele items (“DJI” verschijnt maximaal 1×).
- AC2: JSON‑achtige strings worden herkend en opgesplitst naar items.
- AC3: get_all_context_text() toont schone, gejointe context zonder redundantie.

## Implementatie (richting)
1) _build_base_context: uitbreiden van `extend_unique` met detectie op JSON‑lijst (try `json.loads` op str)
2) Flatten logic op gemengde types (list[str] of str) vóór dedup.
3) Bewaar originele volgorde waar mogelijk (OrderedSet‑achtige aanpak).

## Testplan
- Unit: invoer met ‘DJI’ + ‘["DJI"]’ → output bevat 1 item.
- Unit: invoer nested lists → geflat en gededuped.
- Snapshot: contextsecties zonder dubbele bullets.

## Risks / Mitigations
- Risico: false positive JSON parse op gewone strings
  - Mitigatie: parse alleen wanneer string begint met ‘[’ en eindigt met ‘]’; fallback op raw string.
