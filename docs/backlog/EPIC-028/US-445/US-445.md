# US-445: Remove Category Regeneration Service

**Epic:** EPIC-028 - Feature Cleanup & UI Simplification
**Priority:** HIGH
**Effort:** 3 story points
**Status:** üîµ TODO

---

## üìñ User Story

**Als** gebruiker
**Wil ik** een simpele workflow om definities te regenereren
**Zodat** ik niet verward raak door complexe cross-tab regeneration flows

---

## üéØ Acceptance Criteria

- [ ] `src/services/regeneration_service.py` verwijderd (130 LOC)
- [ ] Regeneration code verwijderd uit `definition_generator_tab.py` (~200 LOC)
- [ ] Regeneration code verwijderd uit `tabbed_interface.py`
- [ ] Session state cleanup voor regeneration markers
- [ ] Users kunnen nog steeds regenereren via normale flow
- [ ] Tab count blijft 5 (alleen service removal, geen tab)
- [ ] Tests blijven groen

---

## üéØ Alternative Workflow (Simpler)

**OLD (Complex):**
```
Definition tab ‚Üí Wijzig categorie ‚Üí Set regeneration context
  ‚Üí Navigate to Generator ‚Üí Pre-filled ‚Üí Generate ‚Üí Clear context
```

**NEW (Simple):**
```
Generator tab ‚Üí Wijzig categorie dropdown ‚Üí Druk "Genereer Definitie"
```

---

## üîß Technical Tasks

### 1. Remove Service File
```bash
rm src/services/regeneration_service.py
```

### 2. Update `src/ui/tabbed_interface.py`

**Remove import (lines ~154-156):**
```python
from services.regeneration_service import RegenerationService
```

**Remove service initialization (lines ~161):**
```python
self.regeneration_service = RegenerationService(prompt_builder)
```

**Remove regeneration check in generation flow (lines ~932-957):**
```python
# Check voor actieve regeneration context (GVI Rode Kabel)
regeneration_context = self.regeneration_service.get_active_context()
if regeneration_context:
    # Override categorie met nieuwe categorie uit regeneration context
    auto_categorie_original = auto_categorie
    try:
        # Convert string to OntologischeCategorie if needed
        if isinstance(regeneration_context.new_category, str):
            auto_categorie = OntologischeCategorie(
                regeneration_context.new_category.lower()
            )
        else:
            auto_categorie = regeneration_context.new_category

        logger.info(
            f"Regeneration actief: categorie override {auto_categorie_original.value} -> {auto_categorie.value}"
        )

        # Update category reasoning voor UI feedback
        category_reasoning = f"Regeneratie: aangepast van {auto_categorie_original.value} naar {auto_categorie.value}"

    except Exception as e:
        logger.warning(
            f"Could not apply regeneration category override: {e}"
        )
        auto_categorie = auto_categorie_original
```

**Remove regeneration context passing (line ~1015):**
```python
# Pass regeneration context for GVI feedback loop
regeneration_context=regeneration_context,
```

**Remove regeneration cleanup (lines ~1172-1181):**
```python
# Clear regeneration context after successful generation (GVI cleanup)
if regeneration_context:
    self.regeneration_service.clear_context()
    logger.info(
        f"Regeneration context cleared after successful generation for '{begrip}'"
    )

    # Also clear UI session state markers
    SessionStateManager.clear_value("regeneration_active")
    SessionStateManager.clear_value("regeneration_begrip")
    SessionStateManager.clear_value("regeneration_category")
```

### 3. Update `src/ui/components/definition_generator_tab.py`

**Remove method `_trigger_regeneration_with_category` (lines ~2008-2048):**
```python
def _trigger_regeneration_with_category(
    self,
    begrip: str,
    new_category: str,
    old_category: str,
    saved_record: DefinitieRecord,
):
    # ... entire method
```

**Remove method `_render_regeneration_preview` (lines ~2049-2089+):**
```python
def _render_regeneration_preview(
    self,
    begrip: str,
    current_definition: str,
    old_category: str,
    new_category: str,
    generation_result: dict[str, Any],
    saved_record: Any,
):
    # ... entire method
```

**Remove regeneration service initialization:**
```bash
grep -n "RegenerationService\|regeneration_service" src/ui/components/definition_generator_tab.py
```

**Remove any calls to:**
- `set_regeneration_context()`
- `get_active_context()`
- `clear_context()`

### 4. Clean Session State References

**Remove session state keys:**
```python
# In tabbed_interface.py or definition_generator_tab.py
SessionStateManager.clear_value("regeneration_active")
SessionStateManager.clear_value("regeneration_begrip")
SessionStateManager.clear_value("regeneration_category")
```

### 5. Remove Test Files
```bash
rm tests/manual_test_regeneration.py
```

### 6. Scan for All References
```bash
grep -r "RegenerationService\|regeneration_service\|regeneration_context" src/ --include="*.py"
grep -r "regeneration_active\|regeneration_begrip" src/ --include="*.py"
```

### 7. Run Tests
```bash
pytest tests/ -v
```

---

## üìã Testing Checklist

**Functionality:**
- [ ] Can change categorie dropdown in Generator tab
- [ ] Can generate definitie with different categorie
- [ ] No regeneration prompts appear
- [ ] Category override works via normal dropdown

**Technical:**
- [ ] No import errors
- [ ] No references to RegenerationService remain
- [ ] Session state clean (no regeneration_* keys)
- [ ] All tests pass
- [ ] No broken code paths

---

## üìä Impact

**Before:**
- Complex cross-tab regeneration flow
- Dual state management (service + session)
- ~330 LOC regeneration code

**After:**
- Simple regeneration: change dropdown + generate
- No cross-tab navigation needed
- Cleaner state management

**LOC Removed:** ~330
**Files Removed:** 1 + test file

---

## üîó Dependencies

- **After:** US-444 (web lookup tab removal)

---

## üìù Notes

- Users can still regenerate: just change category dropdown and click "Genereer Definitie"
- No functionality loss, just simpler UX
- Regeneration service was over-engineered for edge case
- State management complexity was highest risk
