---
id: US-204
epic_id: EPIC-020-PHOENIX
title: Complete V1 to V2 Migration
status: OPEN
priority: HIGH
story_points: 8
assignee: team
created_date: 2025-01-18
updated_date: 2025-01-18
labels: [phoenix, migration, refactoring, technical-debt]
acceptance_criteria:
  - All V1 code paths removed from codebase
  - All imports updated to V2 services
  - No backwards compatibility code remaining
  - All tests passing with V2 implementations
  - Performance metrics maintained or improved
definition_of_done:
  - Code review completed
  - All unit tests passing
  - Integration tests verified
  - No V1 references in codebase
  - Documentation updated
dependencies:
  - US-201 (migration preparation)
  - US-202 (V2 service validation)
  - US-203 (data migration)
---

# US-204: Complete V1 to V2 Migration

## User Story
**Als** ontwikkelaar
**Wil ik** alle V1 code paden volledig verwijderd hebben
**Zodat** de codebase alleen moderne V2 implementaties bevat zonder technische schuld

## Acceptance Criteria

### Code Migration
- [ ] Alle V1 services verwijderd uit `/src/services/`
- [ ] Alle V1 imports vervangen door V2 equivalenten
- [ ] Backwards compatibility code verwijderd
- [ ] Feature flags voor V1/V2 switching verwijderd
- [ ] Legacy configuratie verwijderd

### Service Updates
- [ ] `AIService` → `AIServiceV2` migratie compleet
- [ ] `PromptService` → `PromptServiceV2` migratie compleet
- [ ] `ValidationService` → `ModularValidationService` migratie compleet
- [ ] `DefinitionGenerator` → `UnifiedDefinitionGenerator` migratie compleet
- [ ] Alle service dependencies bijgewerkt in `ServiceContainer`

### Code Quality
- [ ] Geen enkele file bevat nog "V1" in class/function namen
- [ ] Geen deprecated imports aanwezig
- [ ] Alle TODO/FIXME comments m.b.t. V1→V2 opgelost
- [ ] Code coverage minimaal 80% behouden

### Testing
- [ ] Alle unit tests draaien met V2 services
- [ ] Integration tests werken zonder V1 dependencies
- [ ] Smoke tests slagen volledig
- [ ] Performance benchmarks gelijk of beter dan V1

## Technical Implementation Notes

### Phase 1: Inventory (Day 1)
```bash
# Identificeer alle V1 references
grep -r "V1\|Legacy\|Deprecated" src/
grep -r "import.*[Vv]1" src/
find src -name "*v1*" -o -name "*V1*"
```

### Phase 2: Service Migration (Day 2-3)
1. Update `ServiceContainer` om alleen V2 services te registreren
2. Verwijder alle V1 service files:
   - `src/services/ai_service.py` → gebruik alleen `ai_service_v2.py`
   - `src/services/prompt_service.py` → gebruik alleen `prompt_service_v2.py`
   - `src/services/validation_service.py` → gebruik alleen `modular_validation_service.py`
   - `src/services/definition_generator.py` → gebruik alleen `unified_definition_generator.py`

### Phase 3: Import Updates (Day 4)
```python
# Oude imports
from services.ai_service import AIService
from services.prompt_service import PromptService

# Nieuwe imports
from services.ai.ai_service_v2 import AIServiceV2
from services.prompt.prompt_service_v2 import PromptServiceV2
```

### Phase 4: Configuration Cleanup (Day 5)
- Verwijder `DEV_MODE` environment variable checks
- Verwijder conditional service loading
- Update `config/` files voor V2-only configuratie
- Verwijder legacy prompt templates

### Phase 5: Testing & Validation (Day 6-7)
```bash
# Volledige test suite
pytest tests/ -v --cov=src --cov-report=html

# Specifieke V2 validatie
pytest tests/services/ -k "v2"

# Performance vergelijking
python scripts/performance_benchmark.py
```

## Risks & Mitigations

### Risk: Hidden Dependencies
**Mitigation**: Gebruik dependency analyzer tools
```bash
python scripts/analyze_dependencies.py --check-v1-refs
```

### Risk: Performance Degradation
**Mitigation**: Run performance benchmarks voor en na migration
```bash
make benchmark-before
# ... migration ...
make benchmark-after
make benchmark-compare
```

### Risk: Missed V1 References
**Mitigation**: Comprehensive grep patterns
```bash
# Check voor subtiele V1 patterns
grep -r "version.*1\|v1_\|_v1\|V1_\|_V1" src/
grep -r "legacy\|deprecated\|old_\|Old" src/ --ignore-case
```

## Definition of Done

- [ ] **Code Review**: Minimaal 2 developers hebben code review gedaan
- [ ] **Testing**:
  - Alle unit tests slagen (100%)
  - Integration tests slagen (100%)
  - Smoke tests slagen (100%)
  - Code coverage ≥ 80%
- [ ] **Documentation**:
  - CLAUDE.md bijgewerkt zonder V1 references
  - API documentatie bijgewerkt
  - Migration notes gedocumenteerd in `docs/archief/migrations/`
- [ ] **Performance**:
  - Response tijd ≤ V1 baseline
  - Memory usage ≤ V1 baseline
  - API calls ≤ V1 baseline
- [ ] **Cleanup**:
  - Geen V1 files in repository
  - Geen V1 imports in code
  - Geen compatibility layers
  - Git history shows clear migration commit

## Notes

### Belangrijke Files om te Checken
- `/src/services/container.py` - service registratie
- `/src/main.py` - hoofdapplicatie imports
- `/src/ui/tabs/*.py` - UI component imports
- `/tests/` - test imports en mocks

### Cleanup Checklist
```bash
# Files om te verwijderen
rm src/services/ai_service.py
rm src/services/prompt_service.py
rm src/services/validation_service.py
rm src/services/definition_generator.py
rm -rf src/services/legacy/
rm -rf config/v1/

# Directories om te controleren
ls -la src/services/
ls -la config/
grep -r "TODO.*[Vv]1\|FIXME.*[Vv]1" src/
```

### Success Metrics
- Zero V1 references in codebase
- All tests green
- Performance within 5% of V1 baseline
- Code coverage maintained above 80%
- No regression bugs reported

## Related Items
- Parent: [[EPIC-020-PHOENIX]]
- Depends on: [[US-201]], [[US-202]], [[US-203]]
- Blocks: [[US-207]], [[US-208]]
- Related: [[US-205]] (god class refactoring), [[US-206]] (business logic extraction)