---
id: US-201
epic: EPIC-020
title: "Fix ServiceContainer Caching to Prevent 6x Re-initialization"
status: OPEN
priority: CRITICAL
story_points: 3
tags: [performance, caching, streamlit, initialization]
created: 2025-01-18
updated: 2025-01-18
---

# US-201: Fix ServiceContainer Caching to Prevent 6x Re-initialization

## User Story
**Als** ontwikkelaar
**Wil ik** dat de ServiceContainer slechts eenmaal wordt geïnitialiseerd per sessie
**Zodat** de applicatie niet 6x alle services opnieuw initialiseert bij elke Streamlit rerun

## Probleem
Huidige situatie: ServiceContainer wordt 6x opnieuw geïnitialiseerd bij elke Streamlit rerun, wat leidt tot:
- **6x hogere startup tijd** (6 seconden vs 1 seconde)
- **Onnodige resource allocatie**
- **Potentiële race conditions**
- **Verlies van service state tussen reruns**

## Acceptance Criteria

### Must Have
- [ ] ServiceContainer wordt **exact 1x** geïnitialiseerd per sessie
- [ ] Services behouden hun state tussen Streamlit reruns
- [ ] Geen duplicate initialisaties detecteerbaar in logs
- [ ] Startup tijd gereduceerd van ~6s naar <1s

### Should Have
- [ ] Lazy loading van services (alleen initialiseren wanneer nodig)
- [ ] Clear cache mechanisme voor development/debugging
- [ ] Monitoring/logging van cache hits vs misses

### Performance Targets
- **Current**: ~6 seconden initialisatie tijd
- **Target**: <1 seconde initialisatie tijd
- **Cache hit ratio**: >95% na eerste initialisatie

## Technical Implementation

### Approach 1: @st.cache_resource (Recommended)
```python
# src/services/container.py
@st.cache_resource
def get_service_container() -> ServiceContainer:
    """Singleton ServiceContainer with proper caching."""
    return ServiceContainer()

# In main.py / UI components
def get_container():
    if 'service_container' not in st.session_state:
        st.session_state.service_container = get_service_container()
    return st.session_state.service_container
```

### Approach 2: Session State Pattern
```python
# src/utils/container_manager.py
class ContainerManager:
    @staticmethod
    def get_or_create():
        if 'service_container' not in st.session_state:
            with st.spinner("Initializing services..."):
                st.session_state.service_container = ServiceContainer()
                st.session_state.init_timestamp = time.time()
        return st.session_state.service_container
```

### Key Files to Modify
1. `src/services/container.py` - Add caching decorator
2. `src/main.py` - Update initialization pattern
3. `src/ui/tabs/*.py` - Use cached container reference
4. `src/utils/session_manager.py` - Centralize session state management

## Test Scenarios

### Unit Tests
```python
def test_singleton_pattern():
    """Container should return same instance."""
    container1 = get_service_container()
    container2 = get_service_container()
    assert container1 is container2

def test_service_persistence():
    """Services should maintain state between calls."""
    container = get_service_container()
    service1 = container.get_service('validation')
    service2 = container.get_service('validation')
    assert service1 is service2
```

### Integration Tests
- Measure initialization time with profiler
- Verify no duplicate log entries for service creation
- Test cache behavior across simulated reruns

### Manual Testing
1. Start application and monitor console logs
2. Trigger Streamlit rerun (change input, click button)
3. Verify no re-initialization messages
4. Check performance metrics in browser DevTools

## Definition of Done

- [ ] Code implementation complete with caching mechanism
- [ ] Unit tests pass (100% coverage on caching logic)
- [ ] Integration tests confirm single initialization
- [ ] Performance benchmark shows >80% reduction in startup time
- [ ] No regression in existing functionality
- [ ] Code review completed
- [ ] Documentation updated (architecture diagrams if needed)
- [ ] Monitoring/logging implemented for cache behavior

## Dependencies
- None - This is a foundational fix

## Risks & Mitigations
| Risk | Impact | Mitigation |
|------|---------|------------|
| Cache invalidation issues | HIGH | Implement clear cache mechanism for dev mode |
| Memory leaks from cached services | MEDIUM | Add memory monitoring, implement cleanup |
| State corruption between users | LOW | Streamlit handles user isolation |

## Notes
- This is the **highest priority** performance fix
- Blocks all other optimization work
- Expected to reduce overall response time by 40-50%
- Consider implementing cache warming strategy

## Progress Tracking
- [ ] Implementation started
- [ ] Tests written
- [ ] Code review requested
- [ ] Merged to main
- [ ] Performance validated in production