---
id: US-211
epic: EPIC-020-PHOENIX
titel: Document Upload Functionality (PDF/DOCX)
type: feature
status: proposed
prioriteit: MEDIUM
story_points: 13
sprint: week-4
aangemaakt: 2025-09-18
bijgewerkt: 2025-09-18
owner: developer
applies_to: definitie-app@phoenix
canonical: false
last_verified: 2025-09-18
vereisten:
  - REQ-020-05
toegewezen_aan: development-team
---

# US-211: Document Upload Functionality (PDF/DOCX)

**Epic:** EPIC-020-PHOENIX - Complete Technical Rebuild (Phoenix)
**Week:** 4 - External Integration

## Gebruikersverhaal

**Als een** juridisch medewerker
**wil ik** PDF en DOCX documenten kunnen uploaden voor context
**zodat** de AI definitiegenerator relevante context uit bestaande documenten kan gebruiken

## Probleembeschrijving

Gebruikers werken vaak met bestaande juridische documenten die waardevolle context bevatten voor definitiegeneratie. Het systeem moet in staat zijn om documenten te verwerken, relevante secties te identificeren, en deze als context te gebruiken bij het genereren van definities.

## Acceptatiecriteria

### Functionele Criteria
- [ ] Upload interface voor PDF en DOCX bestanden
- [ ] Drag & drop functionaliteit
- [ ] Multi-file upload ondersteuning
- [ ] Document preview functionaliteit
- [ ] Text extractie uit PDF (inclusief OCR voor scans)
- [ ] Text extractie uit DOCX met behoud van structuur
- [ ] Document sectie selectie voor context
- [ ] Automatische taaldetectie (NL/EN)
- [ ] Document metadata extractie
- [ ] Search binnen ge√ºploade documenten

### Technische Criteria
- [ ] File size limiet (max 50MB per bestand)
- [ ] Virus scanning voor uploads
- [ ] Secure file storage met encryption
- [ ] Async document processing
- [ ] Progress tracking voor processing
- [ ] Chunking voor grote documenten
- [ ] Text cleaning en normalisatie
- [ ] Document versioning support

### UI/UX Criteria
- [ ] Upload progress indicator
- [ ] Processing status feedback
- [ ] Document thumbnails/preview
- [ ] Sectie highlighting in preview
- [ ] Context selection interface
- [ ] Document management (view/delete)
- [ ] Error handling met duidelijke messages

## Implementatie Details

### Document Processing Pipeline
```python
class DocumentProcessor:
    """Processes uploaded documents for context extraction"""

    async def process_document(
        self,
        file: UploadedFile,
        options: ProcessingOptions
    ) -> ProcessedDocument:
        # 1. Validate file
        # 2. Extract text
        # 3. Clean and normalize
        # 4. Extract structure
        # 5. Generate embeddings
        # 6. Store in database
        pass

class PDFExtractor:
    """Extract text from PDF files"""

    def extract_text(self, pdf_bytes: bytes) -> str
    def extract_with_ocr(self, pdf_bytes: bytes) -> str
    def extract_metadata(self, pdf_bytes: bytes) -> DocumentMetadata
    def extract_structure(self, pdf_bytes: bytes) -> DocumentStructure

class DOCXExtractor:
    """Extract text from DOCX files"""

    def extract_text(self, docx_bytes: bytes) -> str
    def extract_structured_text(self, docx_bytes: bytes) -> List[Section]
    def extract_metadata(self, docx_bytes: bytes) -> DocumentMetadata
    def extract_styles(self, docx_bytes: bytes) -> Dict[str, Any]
```

### Storage Structure
```
data/
‚îú‚îÄ‚îÄ uploads/
‚îÇ   ‚îú‚îÄ‚îÄ temp/           # Temporary uploads
‚îÇ   ‚îî‚îÄ‚îÄ processed/      # Processed documents
‚îÇ       ‚îú‚îÄ‚îÄ {user_id}/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ {doc_id}/
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ original.{ext}
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ extracted.txt
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ metadata.json
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ embeddings.pkl
```

### Database Schema
```sql
-- Document storage
CREATE TABLE uploaded_documents (
    id TEXT PRIMARY KEY,
    user_id TEXT NOT NULL,
    filename TEXT NOT NULL,
    file_type TEXT NOT NULL,
    file_size INTEGER NOT NULL,
    upload_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    processing_status TEXT DEFAULT 'pending',
    extracted_text TEXT,
    metadata JSON,
    language TEXT,
    word_count INTEGER,
    page_count INTEGER,
    error_message TEXT,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- Document sections for granular context
CREATE TABLE document_sections (
    id TEXT PRIMARY KEY,
    document_id TEXT NOT NULL,
    section_type TEXT,  -- 'heading', 'paragraph', 'list', etc.
    section_number INTEGER,
    content TEXT NOT NULL,
    embedding BLOB,
    relevance_score REAL,
    FOREIGN KEY (document_id) REFERENCES uploaded_documents(id)
);
```

### Processing Libraries
```python
# requirements.txt additions
pdfplumber>=0.9.0     # PDF text extraction
pytesseract>=0.3.10   # OCR for scanned PDFs
python-docx>=0.8.11   # DOCX processing
langdetect>=1.0.9     # Language detection
pypdf>=3.0.0          # PDF manipulation
pillow>=10.0.0        # Image processing for OCR
```

## Definition of Done

- [ ] Upload UI component ge√Ømplementeerd
- [ ] PDF extractor met OCR support
- [ ] DOCX extractor met structure preservation
- [ ] Document processing pipeline werkend
- [ ] Database schema en migrations
- [ ] File storage met encryption
- [ ] Virus scanning integratie
- [ ] Document preview functionaliteit
- [ ] Context selection interface
- [ ] Unit tests voor extractors
- [ ] Integration tests voor pipeline
- [ ] Performance test (10MB PDF <30s)
- [ ] Security audit voor file handling
- [ ] Gebruikersdocumentatie

## UI Mockup Concept

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üìÑ Document Upload & Context       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ   Drop files here or browse  ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ   PDF, DOCX (max 50MB)      ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  Uploaded Documents:               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ Type ‚îÇ Name     ‚îÇ Status    ‚îÇ   ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§   ‚îÇ
‚îÇ  ‚îÇ PDF  ‚îÇ wet.pdf  ‚îÇ ‚úì Ready  ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ DOCX ‚îÇ nota.docx‚îÇ ‚ü≥ Process‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  Selected Context:                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ wet.pdf - Art. 3.1-3.5      ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ "Deze bepalingen..."         ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## Risico's

| Risico | Impact | Mitigatie |
|--------|--------|-----------|
| Malicious files | High | Virus scanning, sandboxing |
| Large file processing | Medium | Async processing, queuing |
| OCR accuracy | Medium | Manual review option |
| Storage costs | Low | Retention policy, compression |
| Privacy concerns | High | Encryption, access control |

## Performance Requirements

- Upload: <2s voor 10MB file
- Text extraction: <30s voor 100 pagina PDF
- OCR processing: <2min voor 20 pagina scan
- Search in documents: <500ms response
- Context retrieval: <1s voor relevante secties

## Security Considerations

- File type validation (magic bytes, not just extension)
- Antivirus scanning met ClamAV of cloud service
- Encrypted storage at rest
- Access control per document
- Audit logging voor document access
- GDPR compliance voor document retention

## Testing Strategie

1. **Unit Tests**: Individual extractors
2. **Integration Tests**: Full pipeline
3. **Performance Tests**: Large file handling
4. **Security Tests**: Malicious file handling
5. **UI Tests**: Upload and selection flow
6. **OCR Tests**: Various scan qualities

## Dependencies on Other Stories

- Requires storage infrastructure from Week 1
- Benefits from caching from Week 2
- Integrates with context management system

## Notes

- Consider PDF.js voor client-side preview
- Implement progressive loading voor grote documenten
- Add support voor andere formaten later (RTF, TXT, HTML)
- Consider integration met cloud storage (OneDrive, Google Drive)
- Implement smart chunking based on document structure