---
id: US-224
epic: EPIC-003
titel: "US-224: titel: Verwijder enable_fallback Feature Flags"
type: technical-debt
status: open
prioriteit: MEDIUM
story_points: 8
sprint: backlog
aangemaakt: 19-09-2025
bijgewerkt: 19-09-2025
owner: development-team
applies_to: definitie-app@current
canonical: false
last_verified: 19-09-2025
vereisten:
  - REQ-021
  - REQ-040
Afhankelijkheden: []
toegewezen_aan: development-team
---

# US-224: Verwijder enable_fallback Feature Flags

## Gebruikersverhaal

**Als een** ontwikkelaar
**wil ik** dat resilience patterns altijd actief zijn zonder feature flags
**zodat** het systeem robuust is tegen failures zonder configuratie complexity

## Context

De `enable_fallback` flag komt 10+ keer voor in resilience.py:
- Zonder fallback → API failures = crashes
- Inconsistent gebruik over modules
- Silent failures wanneer uitgeschakeld

Dit moet vervangen worden door proper circuit breaker patterns.

## Acceptatiecriteria

### Criterion 1: Circuit Breaker Pattern
**gegeven** een externe service faalt
**wanneer** de failure threshold bereikt wordt
**dan** schakelt de circuit breaker automatisch over naar fallback

### Criterion 2: Geen Manual Toggle
**gegeven** resilience is essentieel
**wanneer** het systeem draait
**dan** zijn fallback mechanisms ALTIJD actief

### Criterion 3: Observable Behavior
**gegeven** een fallback wordt gebruikt
**wanneer** dit gebeurt
**dan** wordt dit gelogd en gemonitord

## Technische Implementatie

### Te Wijzigen Bestanden

1. **src/utils/resilience.py**
   - 10+ instances van `enable_fallback` verwijderen
   - Vervangen door circuit breaker pattern

2. **src/utils/integrated_resilience.py**
   - Regel 57, 58: Verwijder `enable_monitoring`, `enable_cost_tracking`
   - Regel 150, 261, 353: Verwijder `enable_fallback` parameters

3. **src/utils/optimized_resilience.py**
   - Regel 63, 67, 68, 71: Verwijder enable flags
   - Implementeer altijd-aan resilience

### Circuit Breaker Implementatie

```python
# VOOR (flag-based):
if enable_fallback:
    return fallback_value
else:
    raise Exception("Service failed")  # CRASH!

# NA (circuit breaker):
class CircuitBreaker:
    def __init__(self, failure_threshold=5, reset_timeout=60):
        self.failure_count = 0
        self.failure_threshold = failure_threshold
        self.state = "CLOSED"  # CLOSED, OPEN, HALF_OPEN
        self.last_failure_time = None

    async def call(self, func, fallback_func):
        if self.state == "OPEN":
            if self._should_attempt_reset():
                self.state = "HALF_OPEN"
            else:
                # Circuit open, use fallback
                logger.warning(f"Circuit open, using fallback")
                return await fallback_func()

        try:
            result = await func()
            self._on_success()
            return result
        except Exception as e:
            self._on_failure()
            if self.state == "OPEN":
                logger.error(f"Circuit opened after {self.failure_count} failures")
                return await fallback_func()
            raise
```

### Monitoring Integration

```python
# Altijd monitoring, geen flag
class ResilientService:
    def __init__(self):
        self.circuit_breaker = CircuitBreaker()
        self.metrics = MetricsCollector()  # ALTIJD aan

    async def call_external_service(self):
        start = time.time()
        try:
            result = await self.circuit_breaker.call(
                self._make_api_call,
                self._get_cached_fallback
            )
            self.metrics.record_success(time.time() - start)
            return result
        except Exception as e:
            self.metrics.record_failure(str(e))
            raise
```

## Test Coverage Vereisten

### Critical Tests
- Test circuit breaker state transitions
- Test automatic fallback activation
- Test recovery behavior
- Test metrics collection

### Performance Tests
- Fallback response tijd <100ms
- Circuit breaker overhead <10ms

## Definitie van Gereed

- [ ] Alle `enable_fallback` flags verwijderd
- [ ] Circuit breaker pattern geïmplementeerd
- [ ] Monitoring altijd actief
- [ ] Fallback metrics dashboard
- [ ] Tests voor alle failure scenarios
- [ ] Documentatie over circuit breaker configuratie

## Impact Analyse

### Positief
- **Reliability**: Systeem automatisch resilient
- **Observability**: Betere monitoring van failures
- **Simpliciteit**: Geen manual flags meer

### Risico's
- **Complexity**: Circuit breaker pattern is complexer
- **Testing**: Meer failure scenarios te testen
- **Performance**: Kleine overhead voor monitoring

## Dependencies

- Monitoring infrastructure moet klaar zijn
- Metrics collection moet werken
- Cache voor fallback values

## Migration Strategy

1. Implementeer circuit breaker naast bestaande code
2. Test uitgebreid in staging
3. Migreer service voor service
4. Verwijder oude flag-based code

---

*Deze story verbetert system resilience significant*