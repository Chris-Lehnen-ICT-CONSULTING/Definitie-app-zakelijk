---
Afhankelijkheden: [US-135]
aangemaakt: 19-09-2025
applies_to: definitie-app@current
bijgewerkt: 19-09-2025
canonical: true
epic: EPIC-003
id: US-220
last_verified: 19-09-2025
owner: development-team
prioriteit: HOOG
sprint: backlog
status: Todo
story_points: 5
titel: Verwijder enable_web_lookup Feature Flag
toegewezen_aan: development-team
type: technical-debt
vereisten:
- REQ-017
- REQ-020
- REQ-021
---

# US-220: Verwijder enable_web_lookup Feature Flag

## Gebruikersverhaal

**Als een** ontwikkelaar
**wil ik** dat de web lookup functionaliteit altijd actief is zonder feature flag
**zodat** de code eenvoudiger wordt en er geen inconsistente configuratie meer mogelijk is

## Context

De `enable_web_lookup` flag wordt op 4+ verschillende plekken gebruikt met inconsistente defaults:
- `orchestrator_v2.py`: `getattr(self.config, "enable_web_lookup", True)`
- `definition_orchestrator.py`: `if self.config.enable_web_lookup`
- `definition_generator_context.py`: `if self.config.enable_web_lookup`
- Meerdere config files met `enable_web_lookup: bool = True`

Dit is een single-user applicatie waar web lookup altijd moet draaien voor context verrijking.

## Acceptatiecriteria

### Criterion 1: Flag Verwijdering
**gegeven** de enable_web_lookup flag bestaat op meerdere plekken
**wanneer** de refactoring is voltooid
**dan** is er geen enkele referentie meer naar enable_web_lookup in de codebase

### Criterion 2: Service Altijd Actief
**gegeven** de web lookup service is ge誰njecteerd
**wanneer** een definitie wordt gegenereerd
**dan** wordt web lookup altijd uitgevoerd (met timeout protection)

### Criterion 3: Graceful Failure
**gegeven** web lookup wordt altijd uitgevoerd
**wanneer** de lookup faalt of timeout
**dan** gaat de definitie generatie gewoon door zonder web context

### Criterion 4: Performance Garanties
**gegeven** web lookup draait zonder flag
**wanneer** een lookup wordt uitgevoerd
**dan** duurt dit maximaal 1.5 seconden (hard timeout)

## Technische Implementatie

### Te Wijzigen Bestanden

1. **src/services/orchestrators/definition_orchestrator_v2.py**
   - Regel 249-250: Verwijder `getattr(self.config, "enable_web_lookup", True)` check
   - Behoud alleen: `if self.web_lookup_service:`

2. **src/services/definition_orchestrator.py**
   - Regel 527: Verwijder `if self.config.enable_web_lookup and WEB_LOOKUP_AVAILABLE:`
   - Vervang door: `if self.web_lookup_service:`

3. **src/services/definition_generator_context.py**
   - Regel 120, 192: Verwijder `enable_web_lookup` checks
   - Service wordt altijd gebruikt indien aanwezig

4. **src/services/definition_generator_config.py**
   - Regel 90: Verwijder `enable_web_lookup: bool = True`
   - Regel 238: Verwijder `self.context.enable_web_lookup = False`

5. **src/services/interfaces.py**
   - Regel 1166: Verwijder `enable_web_lookup: bool = True` uit OrchestratorConfig

6. **Service Factory Updates**
   - Ensure web_lookup_service wordt ALTIJD ge誰njecteerd
   - Gebruik DisabledWebLookupService als fallback indien nodig

### Implementatie Strategie

```python
# VOOR (met flag):
if getattr(self.config, "enable_web_lookup", True) and self.web_lookup_service:
    try:
        web_results = await self.web_lookup_service.lookup(lookup_request)
    except Exception:
        pass  # Silent fail

# NA (zonder flag):
if self.web_lookup_service:  # Service bestaat = gebruik het
    try:
        web_results = await asyncio.wait_for(
            self.web_lookup_service.lookup(lookup_request),
            timeout=1.5  # Hard timeout
        )
        # Process results...
    except asyncio.TimeoutError:
        logger.warning(f"Web lookup timeout for {term}")
    except Exception as e:
        logger.error(f"Web lookup failed: {e}")
        # Continue zonder web context
```

## Test Coverage Vereisten

### Unit Tests aan te passen
- `tests/services/test_definition_orchestrator.py`
- `tests/services/test_orchestrator_v2.py`
- `tests/services/test_definition_context.py`

### Integration Tests
- Test dat web lookup altijd wordt aangeroepen
- Test timeout behavior (1.5 sec max)
- Test graceful failure handling

## Definitie van Gereed

- [ ] Alle references naar `enable_web_lookup` verwijderd
- [ ] Web lookup service wordt altijd ge誰njecteerd
- [ ] Timeout protection ge誰mplementeerd (1.5 sec)
- [ ] Error handling verbeterd (geen silent failures)
- [ ] Alle tests aangepast en groen
- [ ] Performance metrics toegevoegd voor monitoring
- [ ] Documentatie bijgewerkt

## Impact Analyse

### Positief
- **Code Simpliciteit**: -50 regels conditional logic
- **Consistentie**: Geen conflicterende configuraties meer
- **Performance**: Altijd predictable timeout behavior
- **Debugging**: Betere error logging, geen silent failures

### Risico's
- **Performance**: Elke generatie doet nu web lookup (mitigatie: 1.5 sec timeout)
- **Network Load**: Meer API calls (mitigatie: caching strategy)
- **Test Updates**: 15+ tests moeten aangepast worden

## Dependencies

- US-135: Modern Web Lookup Implementatie (moet eerst stabiel zijn)
- Caching strategy moet robuust zijn
- Monitoring moet actief zijn voor metrics

## Notes

- Dit is deel 1 van de feature flag cleanup initiative
- Start met web_lookup omdat dit high-impact maar low-risk is
- Success metrics: Response tijd blijft <3 sec totaal

---

*Deze story is onderdeel van de Technical Debt reductie in EPIC-003*