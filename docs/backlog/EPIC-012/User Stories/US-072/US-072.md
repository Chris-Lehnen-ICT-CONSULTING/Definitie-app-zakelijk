---
id: US-072
titel: DefinitionWorkflowService – combineer Workflow en Repository acties
epic: EPIC-012
status: Open
prioriteit: HIGH
story_points: 5
sprint: backlog
toegewezen_aan: backend-team
aangemaakt: 2025-09-11
bijgewerkt: 2025-09-11
owner: architect
type: refactor
vereisten:
- REQ-015
applies_to: definitie-app@current
canonical: true
last_verified: 2025-09-11
---

# US-072: DefinitionWorkflowService – combineer Workflow en Repository acties

## Gebruikersverhaal
Als developer wil ik één service die workflowtransities (review/approve/reject) afhandelt én de bijbehorende repository-updates en audit/event-publicatie verzorgt zodat UI-code geen losse services hoeft te coördineren en we consistente businessregels afdwingen.

## Context en Herkomst
- TODO in code: `src/ui/components/definition_generator_tab.py:896` – “In Phase 2, create a DefinitionWorkflowService that combines both”.
- EPIC-012 (Legacy Orchestrator Refactoring) richt zich op consolidatie van orchestration/business-logica.

## Acceptatiecriteria
- [ ] Publieke API:
  - `submit_for_review(definition_id: int, user: str, notes: str) -> WorkflowResult`
  - `approve(definition_id: int, user: str, notes: str) -> WorkflowResult`
  - `reject(definition_id: int, user: str, reason: str) -> WorkflowResult`
- [ ] Valideert transities tegen businessregels (WorkflowService logica)
- [ ] Persistente statuswijziging via repository (atomair)
- [ ] Audit logging + (optioneel) event publishing (indien Event Bus actief)
- [ ] Retourneert gestandaardiseerde `WorkflowResult` met nieuwe status en metadata
- [ ] UI roept alleen deze service aan (geen directe repo-calls meer voor status)

## Technische Uitwerking
### Service Contract
```python
@dataclass
class WorkflowResult:
    success: bool
    new_status: str | None
    updated_by: str | None
    notes: str | None
    events: list[str]

class DefinitionWorkflowService:
    def __init__(self, workflow_service, repository, event_bus=None, audit_logger=None): ...
    def submit_for_review(self, definition_id: int, user: str, notes: str = "") -> WorkflowResult: ...
    def approve(self, definition_id: int, user: str, notes: str = "") -> WorkflowResult: ...
    def reject(self, definition_id: int, user: str, reason: str = "") -> WorkflowResult: ...
```

### Migratie
- UI: vervang in `definition_generator_tab.py` de directe repository-statuswijziging door `DefinitionWorkflowService` calls.
- Behoud backward compatibility met bestaande `WorkflowService` door interne compositie.

## Tests
- Unit: geldige/ongeldige transities, atomaire updates, audit/event aanroepen.
- Integratie: UI actie → service → statuswijziging & audit trail.

## Definition of Done
- [ ] Service geïmplementeerd met bovengenoemd contract
- [ ] UI aangepast om nieuwe service te gebruiken
- [ ] Unit/integratietests groen
- [ ] Documentatie en sequentiediagram in EPIC-012 bijgewerkt
