# US-062: Refactor FeedbackBuilder naar moderne service

## User Story
**Als** ontwikkelaar  
**Wil ik** de FeedbackBuilder logica in een moderne V2 service  
**Zodat** feedback generatie testbaar, onderhoudbaar en herbruikbaar wordt  

## Status
**Status**: TODO  
**Priority**: CRITICAL  
**Story Points**: 8  
**Epic**: [EPIC-012: Legacy Orchestrator Refactoring](../EPIC-012.md)  
**Created**: 2025-09-11  
**Sprint Planning**: Week 2 September 2025  

## Business Context
De FeedbackBuilder bevat kritieke business intelligence voor het genereren van actionable feedback tijdens definitie iteraties. Deze logica zit nu verweven in de legacy `definitie_agent.py` (1034 regels) en moet gemoderniseerd worden zonder functionaliteitsverlies.

### Kritieke Business Value
- **11+ violation-to-feedback mappings** voor concrete verbeterinstructies
- **Intelligente prioritering** die voorkomt dat AI overwhelmed raakt
- **Iteratie-bewuste feedback** die stagnatie voorkomt
- **3+ jaar aan optimalisaties** in feedback effectiviteit

## Acceptance Criteria
- [ ] FeedbackServiceV2 geÃ¯mplementeerd met alle legacy functionaliteit
- [ ] Alle 11 violation mappings behouden en werkend
- [ ] Prioritering algoritme identiek aan legacy (Kritiek â†’ Suggesties â†’ Overig)
- [ ] Maximum 5 feedback items per iteratie gerespecteerd
- [ ] Stagnatie detectie werkend (threshold: 0.05)
- [ ] Iteratie-aware feedback (verschillend per iteratie 1/2/3)
- [ ] FIFO history management (max 10 items)
- [ ] Deduplicatie van feedback items
- [ ] Test coverage >95%
- [ ] Performance <100ms response time
- [ ] Geen regressie in feedback kwaliteit

## Technical Details

### Kern Functionaliteit te Migreren
1. **Feedback Prioritering**
   - Max 3 kritieke issues tegelijk
   - Groepering per violation type
   - Volgorde: Critical â†’ High â†’ Medium â†’ Low

2. **Iteratie StrategieÃ«n**
   - Iteratie 1: Directe instructies
   - Iteratie 2: Alternatieve suggesties
   - Iteratie 3: Fundamentele herformulering

3. **Intelligentie Features**
   - Stagnatie detectie (<0.05 verbetering)
   - Regressie detectie (huidige < vorige score)
   - Lerende feedback patronen

### Service Interface (Proposed)
```python
class FeedbackServiceV2:
    def generate_feedback(context: FeedbackContext) -> list[FeedbackItem]
    def detect_stagnation(scores: list[float]) -> bool
    def suggest_alternative_approach(iteration: int, pattern: str) -> str
```

## Implementation Plan
ðŸ“„ **[Gedetailleerd Implementation Plan](./IMPLEMENTATION_PLAN.md)**

## Dependencies
- ValidationOrchestratorV2 moet violations kunnen leveren
- ServiceContainer voor dependency injection
- Validation models voor data types

## Testing Requirements
- Unit tests voor alle publieke methods
- Integration tests met orchestrator
- Performance benchmarks
- Business rules validation tests
- Regression tests tegen legacy output

## Definition of Done
- [ ] Code geÃ¯mplementeerd volgens V2 patterns
- [ ] Alle tests groen
- [ ] Code review completed
- [ ] Business logica behouden (geverifieerd)
- [ ] Performance targets gehaald
- [ ] Documentatie updated
- [ ] Integration met orchestrator werkend
- [ ] Legacy code gearchiveerd (niet verwijderd)

## Risks
| Risk | Impact | Mitigation |
|------|--------|------------|
| Verlies business logica | HIGH | Side-by-side testing, extensive validation |
| Performance degradatie | MEDIUM | Benchmarks, profiling, caching |
| Integration complexiteit | MEDIUM | Phased rollout, feature flags |

## Notes
- Legacy code bevat 3+ jaar aan iteratieve verbeteringen - wees voorzichtig
- FeedbackBuilder is kritiek voor definitie acceptatie rates
- Prioritering algoritme is fine-tuned over honderden definities
- Test uitgebreid met echte validatie scenarios

## Related Documentation
- [Business Knowledge Extraction](../US-061/BUSINESS_KNOWLEDGE_EXTRACTION.md)
- [EPIC-012 Overview](../EPIC-012.md)
- Legacy code: `src/orchestration/definitie_agent.py:299-544`