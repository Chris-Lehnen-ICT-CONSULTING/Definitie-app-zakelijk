# US-062: Refactor FeedbackBuilder naar moderne service

## User Story
**Als** ontwikkelaar  
**Wil ik** de FeedbackBuilder logica in een moderne V2 service  
**Zodat** feedback generatie testbaar, onderhoudbaar en herbruikbaar wordt  

## Status
**Status**: TODO  
**Priority**: CRITICAL  
**Story Points**: 8  
**Epic**: [EPIC-012: Legacy Orchestrator Refactoring](../EPIC-012.md)  
**Created**: 2025-09-11  
**Sprint Planning**: Week 2 September 2025  

## Business Context
De FeedbackBuilder bevat kritieke business intelligence voor het genereren van actionable feedback tijdens definitie iteraties. Deze logica zit nu verweven in de legacy `definitie_agent.py` (1034 regels) en moet gemoderniseerd worden zonder functionaliteitsverlies.

### Kritieke Business Value
- **45 violation-to-feedback mappings** voor concrete verbeterinstructies (11 gedocumenteerd, rest te extraheren)
- **Intelligente prioritering** die voorkomt dat AI overwhelmed raakt
- **Iteratie-bewuste feedback** die stagnatie voorkomt
- **3+ jaar aan optimalisaties** in feedback effectiviteit
- **Directe waarde** ook zonder edit/import features door huidige validatie output te verbeteren

### Waarom Nu Refactoren?
1. **Huidige validatie output is technisch en onbegrijpelijk** voor gebruikers
2. **FeedbackBuilder werkt als vertaallaag** tussen technische validation en menselijke feedback
3. **Geen duplicatie maar aanvulling** op bestaande validation services
4. **Voorbereid voor toekomstige edit feature** (US-064) maar niet afhankelijk ervan

## Acceptance Criteria
- [ ] FeedbackServiceV2 ge√Ømplementeerd met alle legacy functionaliteit
- [ ] Alle 45 validation rules hebben feedback mappings (begin met 11 gedocumenteerde)
- [ ] Prioritering algoritme identiek aan legacy (Kritiek ‚Üí Suggesties ‚Üí Overig)
- [ ] Maximum 5 feedback items per iteratie gerespecteerd
- [ ] Stagnatie detectie werkend (threshold: 0.05)
- [ ] Iteratie-aware feedback (verschillend per iteratie 1/2/3)
- [ ] FIFO history management (max 10 items)
- [ ] Deduplicatie van feedback items
- [ ] Integratie met bestaande validation services (geen duplicatie)
- [ ] UI toont zowel technische als menselijke feedback
- [ ] Test coverage >95%
- [ ] Performance <100ms response time
- [ ] Geen regressie in feedback kwaliteit
- [ ] API design klaar voor US-064 (edit interface)

## Technical Details

### Architectuur: FeedbackBuilder als Vertaallaag
```
ValidationService (bestaand) ‚Üí [Technische Output] ‚Üí FeedbackServiceV2 (nieuw) ‚Üí [Menselijke Feedback]
```

**Kernprincipe:** FeedbackBuilder is een AANVULLING, geen vervanging. Het vertaalt technische validation output naar actionable menselijke instructies.

### Integratie Strategie (Decorator Pattern - Aanbevolen)
```python
class ValidationOrchestratorV2:
    def validate_definition(self, definition: str) -> ValidationResult:
        # Bestaande validatie blijft intact
        result = self.validation_service.validate(definition)
        
        # Nieuwe feedback laag (opt-in)
        if self.feedback_service:
            result.human_feedback = self.feedback_service.generate_feedback(
                violations=result.violations,
                context=FeedbackContext(...)
            )
        return result
```

### Kern Functionaliteit te Migreren
1. **Feedback Prioritering**
   - Max 3 kritieke issues tegelijk (voorkomt overwhelming)
   - Groepering per violation type
   - Volgorde: Critical ‚Üí High ‚Üí Medium ‚Üí Low

2. **Iteratie Strategie√´n** 
   - Iteratie 1: Directe instructies ("Vermijd X")
   - Iteratie 2: Alternatieve suggesties ("Probeer Y in plaats van X")
   - Iteratie 3: Fundamentele herformulering ("Overweeg complete herstructurering")

3. **Intelligentie Features**
   - Stagnatie detectie (<0.05 verbetering)
   - Regressie detectie (huidige < vorige score)
   - Context-aware suggesties per violation type

### Service Interface (Edit-Ready Design)
```python
@dataclass
class FeedbackItem:
    message: str           # Menselijke instructie
    violation_code: str    # Link naar technische regel
    priority: Priority     # CRITICAL/HIGH/MEDIUM/LOW
    suggestion: str | None # Concrete tekstsuggestie
    
class FeedbackServiceV2:
    def generate_feedback(
        self, 
        violations: list[Violation],
        context: FeedbackContext
    ) -> list[FeedbackItem]:
        """Vertaal violations naar menselijke feedback"""
        
    def get_edit_suggestion(
        self,
        text: str,
        violation: Violation  
    ) -> str:
        """Genereer concrete tekst verbetering (voor US-064)"""
        
    def detect_stagnation(
        self,
        score_history: list[float]
    ) -> tuple[bool, str]:
        """Detecteer stagnatie met advies"""
```

## Implementation Plan
üìÑ **[Gedetailleerd Implementation Plan](./IMPLEMENTATION_PLAN.md)**

## Dependencies

### Direct Dependencies
- ValidationOrchestratorV2 moet violations kunnen leveren
- ServiceContainer voor dependency injection  
- Validation models voor data types
- Alle 45 validation rules voor complete mappings

### Feature Dependencies voor Volledige Waarde
| Dependency | User Story | Priority | Impact |
|------------|------------|----------|---------|
| **Edit Interface** | US-064 | HIGH | Maakt feedback actionable |
| Import Validation | US-027 | HIGH | Feedback voor imports |
| Bulk Import | US-062 | HIGH | Batch feedback |

**‚ö†Ô∏è Kritiek:** US-064 (Edit Interface) bepaalt of feedback van informatief naar actionable gaat

## Use Cases & Waarde

### Directe Waarde (zonder dependencies)
1. **Generatie Flow**: Gebruiker past prompt aan op basis van feedback
2. **Validatie Verbetering**: Technische errors worden begrijpelijk
3. **History Learning**: Gebruikers leren van eerdere pogingen

### Toekomstige Waarde (met US-064)
4. **Real-time Coaching**: Feedback tijdens het editten
5. **Iteratieve Verbetering**: Stap-voor-stap definitie verbeteren

## Testing Requirements
- Unit tests voor alle publieke methods
- Integration tests met orchestrator
- A/B testing feedback kwaliteit vs legacy
- Performance benchmarks (<100ms)
- Business rules validation tests
- UI integration tests (feedback display)
- Edit-ready API tests (voor US-064)

## Definition of Done
- [ ] Code ge√Ømplementeerd volgens V2 patterns
- [ ] Alle tests groen
- [ ] Code review completed
- [ ] Business logica behouden (geverifieerd)
- [ ] Performance targets gehaald
- [ ] Documentatie updated
- [ ] Integration met orchestrator werkend
- [ ] Legacy code gearchiveerd (niet verwijderd)

## Risks
| Risk | Impact | Mitigation |
|------|--------|------------|
| Verlies business logica | HIGH | Side-by-side testing, extensive validation |
| Performance degradatie | MEDIUM | Benchmarks, profiling, caching |
| Integration complexiteit | MEDIUM | Phased rollout, feature flags |

## Notes
- Legacy code bevat 3+ jaar aan iteratieve verbeteringen - wees voorzichtig
- FeedbackBuilder is kritiek voor definitie acceptatie rates
- Prioritering algoritme is fine-tuned over honderden definities
- Test uitgebreid met echte validatie scenarios

## Related Documentation
- [Business Knowledge Extraction](../US-061/BUSINESS_KNOWLEDGE_EXTRACTION.md)
- [EPIC-012 Overview](../EPIC-012.md)
- Legacy code: `src/orchestration/definitie_agent.py:299-544`