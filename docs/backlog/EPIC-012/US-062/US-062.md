# US-062: Refactor FeedbackBuilder naar moderne service

## User Story
**Als** ontwikkelaar  
**Wil ik** de FeedbackBuilder refactoren naar een moderne V2 service  
**Zodat** alle feedback logica centraal beheerd wordt zonder legacy dependencies  

## Status
**Status**: IN PROGRESS ðŸš§  
**Start Date**: 2025-09-11  
**Priority**: CRITICAL  
**Story Points**: 8  
**Epic**: [EPIC-012: Legacy Orchestrator Refactoring](../EPIC-012.md)  

## Business Context
De FeedbackBuilder bevat kritieke business logica voor iteratieve verbetering van definities. Deze logica moet behouden blijven maar in een moderne, testbare service structuur.

## Current Situation
- FeedbackBuilder zit embedded in `src/orchestration/definitie_agent.py` (regels 299-544)
- Bevat 11+ violation-to-feedback mappings
- Heeft complexe prioritering logica
- Is tight-coupled met legacy DefinitieAgent

## Acceptance Criteria
- [ ] Extract FeedbackBuilder als standalone service
- [ ] Behoud alle 11 violation mappings
- [ ] Behoud 5-staps prioritering algoritme
- [ ] Implementeer dependency injection pattern
- [ ] Voeg comprehensive unit tests toe
- [ ] Integreer met V2 orchestrator
- [ ] Verwijder dependency op legacy DefinitieAgent

## Technical Approach

### 1. Nieuwe Service Structuur
```python
# src/services/feedback/feedback_builder_service.py
class FeedbackBuilderService:
    def __init__(self, config: FeedbackConfig = None):
        self.config = config or FeedbackConfig()
        self.violation_mapper = ViolationMapper()
        self.prioritizer = FeedbackPrioritizer()
        
    def build_feedback(
        self, 
        violations: List[RuleViolation],
        iteration_context: IterationContext
    ) -> List[FeedbackItem]:
        # Core logic hier
```

### 2. Behoud Business Logic
- Violation feedback mapping (exact zoals gedocumenteerd in US-061)
- Pattern suggestions voor veelvoorkomende problemen
- Iteratie-bewuste feedback generatie
- Stagnatie detectie integratie

### 3. Testing Strategy
- Unit tests voor elke feedback categorie
- Integration tests met validation results
- Performance tests (moet <100ms blijven)

## Dependencies
- Validation results van ModularValidationService
- Iteration context van orchestrator
- Business rules uit US-061 extraction

## Implementation Tasks
1. âœ… Analyseer huidige FeedbackBuilder implementatie
2. â¬œ Create nieuwe service structure
3. â¬œ Migrate violation mappings
4. â¬œ Migrate prioritering logic
5. â¬œ Implement pattern suggestions
6. â¬œ Add iteration awareness
7. â¬œ Create unit tests
8. â¬œ Integrate met V2 orchestrator
9. â¬œ Remove legacy dependencies

## Related Documentation
- Business Knowledge Extraction - Sectie 1: FeedbackBuilder Algoritmes
- EPIC-014 US-107 - FeedbackBuilder Priority Algorithm spec
- EPIC-014 US-108 - Violation-to-Feedback Mapping spec

## Notes
- CRITICAL priority omdat veel andere refactoring hiervan afhangt
- Moet backwards compatible zijn tijdens transitie
- Performance is cruciaal - feedback generatie moet snel blijven