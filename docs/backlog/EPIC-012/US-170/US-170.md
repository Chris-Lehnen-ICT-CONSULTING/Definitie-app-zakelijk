# US-170: Koppel Orchestration-tab aan V2 Orchestrator (productiepad)

## User Story
**Als** product owner  
**Wil ik** dat de Orchestration-tab de V2 orchestrator echt aanstuurt  
**Zodat** we iteratieve verbetering, validatie en opslag met gate‑enforcement kunnen demonstreren en bedienen vanuit de UI.

## Status
**Status**: TODO  
**Priority**: HIGH  
**Story Points**: 5  
**Epic**: [EPIC-012: Legacy Orchestrator Refactoring](../EPIC-012.md)  

## Context
De huidige Orchestration-tab is een demo (gesimuleerd) en staat achter een feature flag. Voor volwassen gebruik willen we deze koppelen aan de V2 orchestrator flow (11 fasen) met echte generatie/validatie, inclusief gate‑policy en veilige foutafhandeling.

## Scope
### In Scope
- UI wiring: Orchestration-tab → `DefinitionOrchestratorV2`
- Async-bridge gebruik (UI) i.p.v. `asyncio.run` in services
- Validatie/gate‑enforcement met policy (`approval_gate.yaml`)
- Veilige foutafhandeling + duidelijke UI feedback (override flow)
- Respecteer V2 UI‑contract (UIResponseDict) overal

### Out of Scope
- Business‑algoritme wijzigingen (blijven zoals V2)
- Nieuwe features in de orchestrator
- Document import/pipeline (alleen gebruiken indien al aanwezig)

## Acceptatiecriteria
- [ ] Orchestration-tab roept V2 orchestrator aan (geen demo data)
- [ ] Geen `best_iteration`/legacy objecten; V2 dict‑contract in UI
- [ ] Gate‑preview en approve/override gedrag zichtbaar in UI en consistent met policy
- [ ] Echte validatie/violations worden getoond (mapping naar UI)
- [ ] Robuuste foutmeldingen (network/API error → non‑blocking UI)
- [ ] Geen `asyncio.run` in services; UI gebruikt bridge of event loop

## Technisch ontwerp (samenvatting)
- UI: vervang `_simulate_agent_run(...)` door async call naar `DefinitionOrchestratorV2.create_definition(...)` via `ui.helpers.async_bridge`.
- Injection: verkrijg orchestrator via DI container (`ServiceContainer.orchestrator()`).
- Context: gebruik V2 context dict (`organisatorisch[]`, `juridisch[]`, `wettelijk[]`).
- Gate: toon `validation_details` en gate‑status; bij override ask‑for‑reason.
- Response: normaliseer naar UIResponseDict (indien orchestrator al conform is → pass‑through).
- Errors: try/except rond AI/validatie; toon non‑blocking status + retry mogelijkheid.

## Beveiliging & Privacy
- Vereist `OPENAI_API_KEY` (gebruik dev‑key lokaal); nooit loggen.
- Respecteer DPIA/AVG redactie (security service hook aanwezig in V2; activeer indien beschikbaar).

## Testplan
- Unit: UI normalisatie → V2 contract (mock orchestrator responses)
- Integratie: happy path (gate pass), override‑pad (override_required), blocked‑pad (blocked)
- Negatief: netwerkfout/timeout → UI toont melding, geen crash

## Checklist Implementatie
- [ ] Async‑bridge gebruiken voor orchestrator calls (geen `asyncio.run`)
- [ ] UI response normaliseren naar UIResponseDict (indien nodig)
- [ ] Gate‑status/reden(en) tonen en override‑reden afdwingen
- [ ] Logging: zonder secrets, met correlation id waar mogelijk
- [ ] Feature flag: tab blijft achter ENV `ENABLE_LEGACY_TAB=true`

## Dependencies
- V2 orchestrator operationeel (`DefinitionOrchestratorV2`)
- Gate‑policy loader (`GatePolicyService`) beschikbaar

## Notes
- Tab blijft standaard verborgen (flag), zodat demo/experimentele functionaliteit gescheiden blijft van hoofdflow (Generator‑tab).
