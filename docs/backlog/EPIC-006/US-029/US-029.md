---
id: US-029
epic: EPIC-006
titel: "US-029: titel: Security headers (CSP/HSTS/X-Frame-Options) + CSRF + UI rate limiting"
status: Nog te bepalen
prioriteit: HOOG
story_points: 5
sprint: sprint-37
owner: security-engineer
applies_to: definitie-app@current
canonical: false
last_verified: 2025-09-12
vereisten:
  - REQ-006
links:
  - docs/backlog/DEEP_DIVE_IMPROVEMENT_PLAN.md#security--privacy-req006-owasp
afhankelijkheden:
  - EPIC-006/US-028
---

# US-029: Security headers (CSP/HSTS/X-Frame-Options) + CSRF + UI rate limiting

## Gebruikersverhaal
Als security officer wil ik standaard security headers, CSRF‑bescherming en UI‑rate limiting zodat de applicatie OWASP Top‑10 mitigaties toepast en risico’s op XSS/Clickjacking/CSRF minimaliseert.

## Acceptatiecriteria (SMART)
- Specifiek: Header‑set (CSP, HSTS, X‑Frame‑Options, X‑Content‑Type‑Options, X‑XSS‑Protection) actief; CSRF‑token voor state‑wijzigende acties; UI‑rate limiting op submit‑acties.
- Meetbaar:
  - SecurityHeaders scan score: A (of gelijkwaardig) zonder High findings.
  - 100% POST‑acties voorzien van CSRF‑token (mock‑API of middleware path voor Streamlit).
  - Rate limiting: dubbele klikken of bots worden geblokkeerd/loggen.
- Acceptabel: Streamlit heeft beperkte header‑controle; alternatief via reverse proxy of werkbare middleware.
- Relevant: REQ‑006.
- Tijdgebonden: sprint‑37.

## Implementatienotities
- Indien Streamlit headers niet zet: documenteer Nginx/Traefik configuratie in `docs/handleidingen/deployment/` en voeg runtime check toe die waarschuwt als headers ontbreken.
- CSRF: minimalistisch via per‑sessie nonce en hidden field in formulieren; verifieer op submit.
- UI rate limit: client‑side throttle + server‑side eenvoudige limiter (session‑scoped).

## Refinement (2025-10-14)

### Scope
- Zet security headers vanuit de Streamlit wrapper of via eenvoudige middleware (bijv. `werkzeug.middleware.proxy_fix` + custom response hook).
- Voeg per-sessie CSRF token toe aan formulieren in Generator/Edit tab (POST-achtige acties).
- Implementeer lichte server-side rate limit (bijv. max 5 submit-acties per 10 seconden per sessie).

### Buiten scope
- Geen reverse proxy configuratie leveren voor productie; enkel voorbeeldconfig in documentatie.
- Geen uitgebreide WAF of bot-detectie.

### Definition of Ready
- [ ] Overzicht van alle formulieren/acties die mutaties uitvoeren beschikbaar.
- [ ] Keuze gemaakt voor headerinjectie (direct in Streamlit vs. uvicorn wrapper).
- [ ] Testlijst voor headers (curl/ZAP) opgesteld.
- [ ] Rate-limit parameters afgestemd (default 5/10s).

### Werkpakketten
- [ ] Middleware die headers toevoegt (`Content-Security-Policy`, `Strict-Transport-Security`, `X-Frame-Options`, `X-Content-Type-Options`, `Referrer-Policy`).
- [ ] CSRF helper: genereer token, sla op in session state, valideer bij submit endpoints.
- [ ] UI updates: voeg verborgen velden of parameters toe aan acties (bv. `st.form_submit_button` wrappers).
- [ ] Rate limiter: simpele in-memory teller per sessie + melding bij overschrijding.
- [ ] Logging + alerts: log blokkades met IP/sessieId (gemaskeerd).
- [ ] Documentatie en checklist voor lokale tests (`scripts/security/check_headers.py`).

## Testplan
- Security header integration test (requests naar lokale server; validate headers).
- CSRF unit/integration tests met geldige/ongeldige tokens.
- Rate limiting test: snelle herhaalde submits → geblokkeerd met nette melding.

## Definition of Done
- [ ] Automatische test bevestigt aanwezigheid van headers.
- [ ] CSRF-token is vereist en foutmelding verschijnt bij ontbrekende/ongeldige token.
- [ ] Rate limiter blokkeert overmatig gebruik en toont melding.
- [ ] Documentatie (`docs/security/security-headers.md`) bijgewerkt met implementatie + eventuele reverse proxy instructies.
- [ ] ZAP baseline (of gelijkwaardige scan) toont geen High findings voor headers/CSRF.
