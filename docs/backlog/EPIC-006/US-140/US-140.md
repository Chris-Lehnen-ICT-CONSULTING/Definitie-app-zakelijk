---
id: US-140
epic: EPIC-006
titel: "US-140: API Key Startup Validatie - Vroege detectie van configuratiefouten met test API call en gebruikersfeedback"
type: enhancement
status: Nog te bepalen
prioriteit: HOOG
story_points: 3
sprint: backlog
aangemaakt: 05-09-2025
bijgewerkt: 05-09-2025
owner: developer-implementer
applies_to: definitie-app@current
canonical: false
last_verified: 05-09-2025
Afhankelijkheden:
  - US-025
  - US-026
toegewezen_aan: unassigned
---



# US-140: API Key validatie at Startup

## Gebruikersverhaal

**As a** system administrator
**wil ik** the application to validatie API keys at startup
**zodat** configuration errors are detected early en users receive immediate feedback about auDanticatie issues

## Acceptatiecriteria
### SMART Acceptatiecriteria

- **Specifiek:** [Exact gedrag dat moet worden gerealiseerd]
- **Meetbaar:**
  - Response tijd: < 200ms voor UI acties
  - Processing tijd: < 5 seconden voor generatie
  - Success rate: > 95% voor validaties
- **Acceptabel:** Haalbaar binnen huidige architectuur
- **Relevant:** Direct gerelateerd aan gebruikersbehoefte
- **Tijdgebonden:** Gerealiseerd binnen huidige sprint


### AC1: Startup validatie
**gegeven** the application is starting
**wanneer** initialization begins
**dan** the system:
- Checks for OpenAI API key presence
- ValiDatums API key format
- Tests API connectivity with minimal request
- Caches validatie result
- Provides clear error messages if validatie fails

### AC2: User Feedback
**gegeven** API key validatie fails
**wanneer** the user accesses the application
**dan** the system:
- Displays prominent warning banner
- Shows specific error (missing/invalid/expired)
- Provides instructions for resolution
- Links to configuration documentation
- AlLAAGs read-only access to non-API features

### AC3: Retry Mechanism
**gegeven** initial validatie fails
**wanneer** user upDatums API key configuration
**dan** the system:
- AlLAAGs manual re-validatie
- UpDatums validatie status without restart
- Clears error messages on success
- Maintains validatie history in logs

### AC4: Prestaties Impact
**gegeven** startup validatie is required
**wanneer** application initializes
**dan** validatie:
- Completes within 3 seconds
- Uses minimal API quota
- Runs asynchronously to not block UI
- Caches results for session duration

## Refinement (2025-10-14)

### Doelen
- Startup blokkeert wanneer geen geldige OpenAI-sleutel aanwezig is; gebruiker krijgt directe feedback.
- Handig her-proberen na sleutelupdate zonder volledige herstart.
- Logging en metrics leveren inzicht in configuratiefouten zonder secrets te lekken.

### Buiten scope
- Geen sleutelbeheer UI of rotatieworkflow; enkel validatie.
- Geen integratie met secret managers; blijft bij environment variables.

### Definition of Ready
- [ ] Beslisboom voor errorcodes (missing/invalid/auth_failed/network) akkoord.
- [ ] Test API call bepaald (list models of lightweight `client.models.list()`).
- [ ] UI-bibliotheek voor banners beschikbaar (Streamlit alert component).
- [ ] Requirements.txt bevat `openai` clientversie die call ondersteunt.

### Werkpakketten
- [ ] Bouw `APIKeyValidator` met methoden `validate()` en `retry()`, inclusief key masking helper.
- [ ] Voeg startup hook toe in `ServiceContainer` die validatie uitvoert en status opslaat in singleton `ValidationState`.
- [ ] UI: toon waarschuwing bovenaan hoofdscherm met call-to-action bij fout; bied link naar documentatie.
- [ ] CLI/command: `scripts/diagnostics/check_api_key.py` voor handmatige controle.
- [ ] Logging + metrics: schrijf events naar `logs/security.log` en exporteer telwaarde `api_key_validation_failures_total`.
- [ ] Tests: unit (happy/fail/network), integratie (start zonder key â†’ blok), UI snapshot voor banner.

## Domain vereisten

### beveiliging StEnards
- Never log full API keys
- Mask API keys in error messages
- Store validatie state securely
- Implement rate limiting on validatie attempts

### compliance
- Log all auDanticatie attempts
- Maintain auditspoor for beveiliging review
- Support multiple API key configurations
- Enable key rotation without downtime

## Technische Notities

### Implementatie
- Add validatie to `ServiceContainer.__init__`
- Create `APIKeyValidator` service
- Implement startup hooks in `src/main.py`
- Add validatie status to session state

### validatie Process
1. Check environment variable presence
2. ValiDatum key format (sk-...)
3. Make test API call (models endpoint)
4. Store validatie result
5. Set application mode based on result

### Error States
- MISSING_KEY: No API key configured
- INVALID_FORMAT: Key doesn't match pattern
- AUDanTICATION_FAILED: Key rejected by API
- RATE_LIMITED: Too many validatie attempts
- CONNECTION_ERROR: Network issues



## Afhankelijkheden

- EPIC-006
## Test vereisten

### Unit Tests
- Validator with various key formats
- Error message generation
- Caching mechanism
- Retry logic

### Integration Tests
- Full startup sequence
- API communication
- Error recovery
- Session state management

### Edge Cases
- Expired keys
- Rate limited keys
- Network timeouts
- Malformed configurations

## Definitie van Gereed
- [ ] Validatie faalt zichtbaar zonder de app verder te laten draaien.
- [ ] Gebruiker kan vanuit UI een retry triggeren nadat ENV is gewijzigd.
- [ ] Logs tonen gemaskeerde sleutel (laatste 4 tekens) + foutcode.
- [ ] Unit/integratie tests gedraaid; script `check_api_key.py` documenteert output.
- [ ] Documentatie (`docs/security/api-key-validation.md`) beschrijft setup en foutcodes.

## Links

- Related vereisten: REQ-024, REQ-025
- Episch Verhaal: EPIC-006
- Related: US-025, US-026
- beveiliging richtlijnen: `docs/richtlijnen/beveiliging-stEnards.md`
