---
id: US-028
epic: EPIC-006
titel: "US-028: titel: SecurityService adapter + DPIA/AVG‑sanitization en injectie in V2 orchestrator"
status: Nog te bepalen
prioriteit: KRITIEK
story_points: 5
sprint: sprint-37
owner: security-engineer
applies_to: definitie-app@current
canonical: false
last_verified: 2025-09-12
vereisten:
  - REQ-006
  - REQ-045
links:
  - docs/backlog/DEEP_DIVE_IMPROVEMENT_PLAN.md#security--privacy-req006-owasp
afhankelijkheden:
  - EPIC-012
---

# US-028: SecurityService adapter + DPIA/AVG‑sanitization en injectie in V2 orchestrator

## Gebruikersverhaal
Als beveiligingsverantwoordelijke wil ik dat elke generation‑aanvraag door een SecurityService gaat voor DPIA/AVG‑sanitization, zodat gevoelige gegevens niet in prompts of logs terechtkomen en OWASP/AVG‑eisen worden geborgd.

## Acceptatiecriteria (SMART)
- Specifiek: Implementatie van `SecurityServiceInterface` met methodes `sanitize_request()`, `redact_pii()`, `validate_compliance()` en injectie in `DefinitionOrchestratorV2` via `ServiceContainer`.
- Meetbaar:
  - 100% van de orchestration‑paden roepen sanitization aan (gecheckt via tests/patching spies).
  - 0 PII‑velden in logs/metadata (tests controleren redactie op voorbeelddata).
  - Rate: extra overhead < 5ms p95 per call (zonder IO).
- Acceptabel: Gebaseerd op bestaande `security/security_middleware.py` sanitizer/validator.
- Relevant: REQ‑006/REQ‑045; justitiesector privacy‑compliance.
- Tijdgebonden: afronden in sprint‑37.

## Implementatienotities
- Adapter in `src/security/security_service_adapter.py` die `SecurityServiceInterface` implementeert met onder water `security_middleware.get_security_middleware()`.
- `ServiceContainer.orchestrator()` uitbreiden: instantie van adapter aan `DefinitionOrchestratorV2(security_service=...)` meegeven.
- Logs: masker API keys en PII (e‑mail, BSN, telefoons) in adapter.

## Testplan
- Unit: tests/security/test_security_service_adapter.py
  - Sanitize: verwijdert/maskt PII; laat niet‑gevoelige velden intact.
  - Redact: niveaus low/medium/high; content‑checks.
  - Compliance: returns dict met regels true/false.
- Integration: tests/services/test_orchestrator_security_integration.py
  - Orchestrator roept sanitize aan (spy/assert calls).
  - Metadata bevat geen PII na flow.
- Performance: pytest‑benchmark check p95 overhead < 5ms (mocks).

## Regressie/GUARDS
- ZAP baseline: 0 High (uitgevoerd in CI aparte stap).
- Geen raw OpenAI errors naar UI door securitylaag.

## Definition of Done
- Code + tests groen; CI‑stappen geüpdatet; README/SECURITY sectie kort aangevuld waar nodig.

