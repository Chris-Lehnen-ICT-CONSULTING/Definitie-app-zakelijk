---
id: US-032
epic: EPIC-006
titel: "US-032: Als security officer wil ik dat data at rest versleuteld is, zodat diefstal van bestanden geen lek veroorzaakt."
status: Nog te bepalen
prioriteit: KRITIEK
story_points: 8
sprint: sprint-38
owner: security-engineer
applies_to: definitie-app@current
canonical: false
last_verified: 2025-09-12
vereisten:
  - REQ-006
  - REQ-044
links:
  - docs/backlog/DEEP_DIVE_IMPROVEMENT_PLAN.md#database--repository
---

# US-032: Database‑encryptie at rest (SQLCipher of field‑level encryptie)

## Gebruikersverhaal
Als security officer wil ik dat data at rest versleuteld is, zodat diefstal van bestanden geen lek veroorzaakt.

## Acceptatiecriteria (SMART)
- Specifiek: Encryptie op `data/definities.db` via SQLCipher of field‑level (kolomsgewijs) met veilige key‑handling.
- Meetbaar: data op schijf niet leesbaar zonder sleutel; decrypt‑tests slagen; performance overhead p95 < 10%.
- Acceptabel: key via omgeving/secret manager; geen hardcoding.
- Relevant: REQ‑006/044.
- Tijdgebonden: sprint‑38.

## Implementatienotities
- Optie A: SQLCipher driver (pysqlcipher3). Optie B: veldencryptie (cryptography) voor gevoelige kolommen.
- Key‑rotatieproces documenteren.

## Refinement (2025-10-14)

### Scope
- Quick win: versleutel SQLite via SQLCipher (indien beschikbaar) of fallback field-level encryptie voor teksten (definitie, context).
- Zorg dat sleutel via environment variable wordt aangeleverd en nooit in code/logs terechtkomt.
- Bied eenvoudige migratie voor bestaande database (export → import).

### Buiten scope
- Geen geautomatiseerd key-rotatiesysteem; alleen beschreven procedure.
- Geen enterprise HSM-integratie.

### Definition of Ready
- [ ] Beslissing genomen: SQLCipher beschikbaar? (check `brew install sqlcipher` op dev machine).
- [ ] Bibliotheek keuze gemaakt (`pysqlcipher3` of fallback `cryptography`).
- [ ] Migratieplan (stappen + rollback) uitgewerkt.

### Werkpakketten
- [ ] Abstractielaag in `DefinitionRepository` die transparant encrypt/decrypt toepast.
- [ ] Initialisatie: laad key uit `ENCRYPTION_KEY` env; valideer sterkte (min 32 chars).
- [ ] Migratiescript `scripts/migrations/encrypt_database.py` (export -> encrypt -> import).
- [ ] Tests: unit (encrypt/decrypt), integratie (CRUD met sleutel, failure zonder sleutel).
- [ ] Monitoring/logging: waarschuwing indien key ontbreekt of fout; blokkeer start.
- [ ] Documentatie: runbook voor sleutelbeheer en backup/herstel.

## Testplan
- Unit/integration: schrijven/lezen met en zonder juiste sleutel.
- Security: verify dat ruwe `*.db` geen platte tekst bevat.

## Definition of Done
- [ ] Applicatie start niet zonder sleutel en logt duidelijke fout.
- [ ] Data op schijf is versleuteld (handmatige inspectie toont geen platte tekst).
- [ ] Tests dekken lezen/schrijven + foutscenario zonder sleutel.
- [ ] Runbook/documentatie beschikbaar voor migratie en herstel.
- [ ] Opslag van sleutel buiten repo (ENV of secrets store) bevestigd.
