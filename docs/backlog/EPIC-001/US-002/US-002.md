---
id: US-002
epic: EPIC-001
titel: "US-002: Modulair Prompt Systeem - Context-bewuste templates met 40% token reductie (7250→3000)"
status: completed
prioriteit: HOOG
story_points: 5
sprint: Voltooid
aangemaakt: 02-01-2025
bijgewerkt: 05-09-2025
owner: development-team
applies_to: definitie-app@current
canonical: false
last_verified: 2025-10-02
vereisten:
  - REQ-018
  - REQ-038
  - REQ-059
Afhankelijkheden:
  - US-001
toegewezen_aan: development-team
---



# US-002: Build Modular Prompt Template System with Context-Aware Selection

## Gebruikersverhaal
**As a** juridische definitie author working across OM/DJI/Rechtspraak domains
**wil ik** modular, context-aware prompt templates that automatically adapt to legal domain
**zodat** I achieve 95% consistency in definition structure while reducing prompt tokens by 40%

## Problem Statement

**Current Situation:**
- Single monolithic prompt template using 7,250 tokens
- No adaptation to different legal contexts (criminal vs civil)
- 65% of prompt content is irrelevant for specific requests
- Template Wijzigingen require code deployment
- No Versieing or A/B testing capability

**Desired Outcome:**
- Modular templates using < 3,000 tokens per request
- Context-aware template selection (criminal/civil/administrative)
- Load templates from configuration files (no code Wijzigingen)
- Template Versieing with fallback support
- 40% reduction in API costs through optimization

## Acceptatiecriteria


### SMART Acceptatiecriteria

- **Specifiek:** Modulair prompt template systeem met context-aware selectie voor juridische domeinen
- **Meetbaar:**
  - Template load tijd: < 50ms
  - Token reductie: 40% (van 7250 naar < 3000 tokens)
  - Template hit rate: > 95% voor standaard contexten
  - Configuratie updates zonder code deployment
- **Acceptabel:** YAML-based templates met Jinja2 templating
- **Relevant:** Kostenreductie en verbeterde onderhoudbaarheid
- **Tijdgebonden:** Geïmplementeerd in Sprint 2, operationeel sinds Week 4

### ASTRA/NORA Compliance
- **ASTRA-ARC-002**: Modulaire architectuur principes
- **NORA-BP-07**: Herbruikbare componenten
- **DJI-ARCH-004**: Configuratie-gedreven systemen


### Criterion 1: Modular Template Architecture
```gherkin
Scenario: Context-specifieke template selectie
  Gegeven templates opgeslagen in 'config/prompts/templates/'
  En een gebruiker selecteert context "strafrecht"
  Wanneer een definitie wordt aangevraagd voor "voorlopige hechtenis"
  Dan laadt het systeem 'criminal_law_template.yaml'
  En voegt deze samen met 'base_template.yaml'
  En includeert alleen strafrecht-relevante validatieregels
  En is de totale prompt size < 3,000 tokens
  En wordt een trace log gegenereerd met template selectie details
```

### Criterion 2: Dynamic Variable Substitution
```gherkin
Scenario: Dynamische variabele vervanging
  Gegeven een template met variabelen '{term}', '{context}', '{domain}', '{examples}'
  En waarden: term="vonnis", context="strafrecht", domain="OM"
  Wanneer de prompt wordt samengesteld
  Dan worden alle variabelen vervangen met actuele waarden
  En worden ongebruikte optionele variabelen verwijderd
  En worden speciale karakters correct ge-escaped
  En blijven Nederlandse formatteringsregels behouden
  En wordt de output gevalideerd tegen het template schema
```

### Criterion 3: Template Validatie & Completeness
```gherkin
Scenario: Template volledigheidscontrole
  Gegeven een gegenereerde prompt uit templates
  Wanneer deze wordt gevalideerd voor GPT-4 verzending
  Dan controleert het systeem op:
    | Check | Vereiste |
    | Minimale lengte | > 100 karakters |
    | Maximale lengte | < 10000 karakters |
    | Verplichte secties | Aanwezig |
    | Taalconsistentie | 100% Nederlands |
  En bij validatiefalen wordt fallback template gebruikt
  En wordt een validatie rapport gelogd
```
**dan** it must contain:
- Required sections: instruction, term, context, output format
- Maximum 45 validatieregels (context-filtered)
- Valid JSON structure for structured output
- Token count validatie (< 3,000)

### Criterion 4: Template Hot-Reload
**gegeven** templates are modified in `config/prompts/templates/`
**wanneer** the application is running
**dan**:
- Wijzigingen are detected within 30 seconds
- New templates are loaded without restart
- Active sessions continue with old templates (graceful)
- Admin notification of template upDatum

## Technical Implementatie

### Implementatie Approach

1. **Step 1**: Create template structure in `config/prompts/templates/`
   ```
   templates/
   ├── base_template.yaml
   ├── criminal_law_template.yaml
   ├── civil_law_template.yaml
   ├── administrative_law_template.yaml
   └── validation_rules/
       ├── criminal_rules.yaml
       └── civil_rules.yaml
   ```

2. **Step 2**: Implement `PromptServiceV2` in `src/services/prompt_service_v2.py`
   ```python
   class PromptServiceV2:
       def build_prompt(self, term, context, domain, examples=None):
           template = self._select_template(context)
           rules = self._get_relevant_rules(context)
           return self._merge_En_substitute(template, rules, locals())
   ```

3. **Step 3**: Add template caching with file watcher
   - Use `watchdog` library for file system monitoring
   - Implement LRU cache with 15-minute TTL
   - Cache key: hash(template_path + modification_time)

4. **Step 4**: Implement token counting en optimization
   - Use `tiktoken` for accurate GPT-4 token counts
   - Implement `optimize_prompt()` to remove redundancy
   - Add telemetry for token usage tracking

### Code Locations
- Primary files:
  - `src/services/prompt_service_v2.py` (main service)
  - `src/services/template_loader.py` (template management)
  - `src/utils/token_counter.py` (token optimization)
  - `config/prompts/templates/*.yaml` (template files)
- Key functions:
  - `PromptServiceV2.build_prompt()` - main entry point
  - `PromptServiceV2._select_template()` - context-aware selection
  - `PromptServiceV2._merge_templates()` - template composition
  - `TemplateLoader.load_with_cache()` - cached loading
  - `TokenCounter.count_tokens()` - accurate counting

### Technical Decisions
- Format: YAML for templates (human-readable, supports multiline)
- Parser: Jinja2 for variable substitution (industry stEnard)
- Cache: Redis for production, in-memory for development
- File watching: watchdog library (cross-platform)
- Token counting: tiktoken with cl100k_base encoding

## Domain & compliance

### Domeinregels
- **ASTRA guideline**: Templates externalized from code (configuration as code)
- **NORA principle**: Reusable components across government systems
- **Justice stEnards**:
  - OM: Openbaar Ministerie (OM)-focused language en structure
  - DJI: Rehabilitation en detentie terminology
  - Rechtspraak: rechtbank procedure alignment
  - All templates must support Dutch en English

### beveiliging & Privacy
- **beveiliging**: Templates stored read-only in production
- **Privacy**: No PII in template examples or structure
- **Audit**: Log template selection en Versie for each request
- **Access**: Template modification requires admin role



## Afhankelijkheden

- EPIC-001
## Test Scenario's

### Unit Tests

1. **Test**: `test_template_selection_by_context()`
   - Input: Various contexts ("strafrecht", "bestuursrecht", "civiel")
   - Expected: Correct template file selected
   - Assert: `selected_template.name == expected_template`
   - Coverage: All context types

2. **Test**: `test_variable_substitution_completeness()`
   - Input: Template with 10 variables, provide 7 values
   - Expected: 7 replaced, 3 optional removed cleanly
   - Assert: No `{` or `}` in output, all values present

3. **Test**: `test_token_count_optimization()`
   - Setup: Load template with all rules (7,250 tokens)
   - Action: Apply context filter for "strafrecht"
   - Expected: Reduced to < 3,000 tokens
   - Assert: `token_count < 3000`, `"straf" in output`

### Integration Tests

1. **Test**: `test_template_hot_reload()`
   - Setup: Start application, modify template file
   - Wait: 30 seconds
   - Action: Generate new prompt
   - Assert: New template content used, no restart needed

2. **Test**: `test_concurrent_template_access()`
   - Setup: 50 concurrent requests with different contexts
   - Action: Generate prompts simultaneously
   - Assert: Correct templates used, no race conditions

### Prestaties Tests

1. **Test**: `test_template_loading_Prestaties()`
   - Setup: Clear cache, load 100 different prompts
   - maatregel: Load time per template
   - Assert: `first_load < 100ms`, `cached_load < 5ms`

## Definitie van Gereed

- [x] Template file structure aangemaakt in `config/prompts/`
- [x] PromptServiceV2 geïmplementeerd with modular loading
- [x] Token counting integrated with tiktoken
- [x] Template caching with Redis/in-memory
- [x] File watcher for hot-reload capability
- [x] Unit tests written (> 85% coverage)
- [x] Integration tests for template selection
- [x] Prestaties tests validatie < 3,000 tokens
- [x] beveiliging review (no code injection possible)
- [x] Documentation: template authoring guide
- [x] Code review by senior architect
- [x] A/B test shows 40% token reduction
- [x] Deployed with feature flag

## Risks & Mitigation

1. **Risk**: Template syntax errors break generation
   - Probability: GEMIDDELD
   - Impact: HOOG
   - Mitigation: Template validatie on load, fallback to last valid

2. **Risk**: Context mapping incomplete
   - Probability: LAAG
   - Impact: GEMIDDELD
   - Mitigation: Default template fallback, logging of unmapped contexts

3. **Risk**: Cache invalidation issues
   - Probability: LAAG
   - Impact: LAAG
   - Mitigation: Conservative TTL, manual cache clear option

## Notes & References

### Implementatie Milestones
- Template design: 05-01-2025
- Initial Implementatie: 08-01-2025
- Token optimization: 12-01-2025
- Hot-reload added: 15-01-2025
- productie deployment: 20-01-2025

### Metrics Achieved
- Token reduction: 58% (target: 40%) ✅
- Template load time: 3ms cached (target: < 10ms) ✅
- Context accuracy: 98% (target: 95%) ✅
- Template Wijzigingen without deploy: 100% (target: 100%) ✅

### Gerelateerde Documentatie
- Template authoring guide: `docs/guides/template-authoring.md`
- Token optimization: `docs/architectuur/prompt-refactoring/`
- Configuration: `config/prompts/README.md`

---

*This story is part of EPIC-001: Basis Definitie Generatie*
