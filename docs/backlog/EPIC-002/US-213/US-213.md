---
id: US-213
titel: "US-213: Elimineer alle duplicate code patterns in de codebase door systematische adoptie van de `src/utils/dry_helpers.py` mo..."
epic: EPIC-002
status: open
prioriteit: MEDIUM
story_points: 13
sprint: future
owner: backend
applies_to: definitie-app@current
canonical: false
last_verified: 2025-10-02
created_at: 2025-09-19
dependencies: [US-193]
---

# US-213 — Volledige adoptie van dry_helpers module door gehele codebase

## Doel
Elimineer alle duplicate code patterns in de codebase door systematische adoptie van de `src/utils/dry_helpers.py` module, wat resulteert in betere onderhoudbaarheid, consistentie en minder bugs.

## Context
Uit de US-193 multi-agent review blijkt dat er 1789+ `.get()` patterns en andere duplicates in de codebase zijn. De dry_helpers module is gecreëerd met 17 helper functies maar wordt slechts in 5 files gebruikt. Deze US beoogt de volledige adoptie.

## Scope

### In scope
- Vervang alle 1789 `.get()` patterns met `safe_dict_get()`
- Vervang 205+ logger initialisaties met `get_logger()`
- Migreer session state access naar dry_helper functies
- Vervang try/except blocks met `error_handler` decorator waar applicable
- Update alle validation result processing naar helper functies
- Creëer migratie script voor automatische conversie

### Niet in scope
- Nieuwe helper functies toevoegen (aparte US)
- Runtime gedrag wijzigen (alleen refactoring)
- Test files (tenzij ze production patterns gebruiken)

## Acceptance Criteria

### Functioneel
- [ ] Alle `.get()` patterns met defaults gebruik dry_helpers
- [ ] Geen duplicate logger initialisaties meer
- [ ] Consistente error handling via helpers
- [ ] Alle tests blijven groen
- [ ] Performance niet negatief beïnvloed (< 5% overhead)

### Technisch
- [ ] 0 imports van `logging.getLogger()` direct (alleen via helper)
- [ ] < 50 `.get()` calls remaining (alleen waar geen default nodig)
- [ ] dry_helpers geïmporteerd in 150+ files
- [ ] Automated migration script beschikbaar
- [ ] Rollback plan gedocumenteerd

## Implementatie Strategie

### Phase 1: High-Risk Areas (Week 1)
**Target: 30 critical files**
- `src/services/validation/` - alle validation services
- `src/services/orchestrators/` - orchestration layer
- `src/database/` - data access layer
- **Rationale**: Core business logic, hoogste impact bij bugs

### Phase 2: UI Components (Week 2)
**Target: 50 UI files**
- `src/ui/components/` - alle UI componenten
- `src/ui/tabs/` - tab implementations
- `src/ui/helpers/` - UI helper modules
- **Rationale**: User-facing, veel duplicate patterns

### Phase 3: Toetsregels (Week 3)
**Target: 100+ regel files**
- `src/toetsregels/regels/` - regel implementaties
- `src/toetsregels/validators/` - validators
- **Rationale**: Veel files, relatief simpele patterns

### Phase 4: Remaining Modules (Week 4)
**Target: Overige ~70 files**
- `src/utils/` - utility modules
- `src/config/` - configuratie
- `src/export/` - export functionaliteit
- **Rationale**: Lower risk, cleanup fase

## Migration Script

```python
# scripts/migrate_to_dry_helpers.py
"""
Automated migration naar dry_helpers patterns.
Gebruik: python scripts/migrate_to_dry_helpers.py [--dry-run] [--file FILE]
"""

REPLACEMENTS = [
    # Logger pattern
    (r'logger = logging\.getLogger\(__name__\)',
     'logger = get_logger(__name__)'),

    # Dict.get with list default
    (r'(\w+)\.get\(["\'](\w+)["\']\s*,\s*\[\]\)',
     r'ensure_list(safe_dict_get(\1, "\2", []))'),

    # Dict.get with dict default
    (r'(\w+)\.get\(["\'](\w+)["\']\s*,\s*\{\}\)',
     r'ensure_dict(safe_dict_get(\1, "\2", {}))'),

    # Session state patterns
    (r'st\.session_state\.get\(["\']service_container["\']\)',
     'safe_get_service_container()'),
]
```

## Test Plan

### Pre-Migration
1. Full test suite groen
2. Performance baseline measurement
3. Code coverage report

### Per Phase Testing
1. Run migration script op target files
2. Unit tests voor gemigreerde modules
3. Integration tests voor affected flows
4. Manual smoke test van UI

### Post-Migration
1. Full regression test
2. Performance comparison
3. Code quality metrics (duplication %)
4. Static analysis (ruff, mypy)

## Risico's & Mitigatie

| Risico | Impact | Kans | Mitigatie |
|--------|--------|------|-----------|
| Breaking changes | HIGH | MEDIUM | Phased rollout, extensive testing |
| Performance degradatie | MEDIUM | LOW | Benchmark voor/na, profile hotspots |
| Merge conflicts | MEDIUM | HIGH | Coordineer met team, kleine batches |
| Incomplete migration | LOW | MEDIUM | Tracking dashboard, automation |

## Metrics

### Voor Migration
- **Duplicate code**: 15% (SonarQube)
- **`.get()` patterns**: 1789
- **Logger patterns**: 205
- **Files using dry_helpers**: 5

### Target na Migration
- **Duplicate code**: < 5%
- **`.get()` patterns**: < 50
- **Logger patterns**: 0
- **Files using dry_helpers**: 200+

## Dependencies
- US-193 (voltooid) - Initial dry_helpers creation
- Geen blocking dependencies

## Notities
- Gebruik automation waar mogelijk om human error te voorkomen
- Communiceer changes breed aan team
- Consider pre-commit hook voor nieuwe code
- Update CLAUDE.md om dry_helpers gebruik te mandateren

## Links
- [dry_helpers.py source](src/utils/dry_helpers.py)
- Parent issue: US-193
- Python DRY principles: https://en.wikipedia.org/wiki/Don%27t_repeat_yourself