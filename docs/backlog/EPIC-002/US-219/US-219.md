---
id: US-219
epic: EPIC-002
titel: "US-219: titel: Duplicate‑check uitbreiden met synoniemen (context‑aware)"
status: proposed
prioriteit: HOOG
story_points: 5
sprint: backlog
aangemaakt: 2025-09-26
bijgewerkt: 2025-09-26
owner: development-team
applies_to: definitie-app@current
canonical: false
last_verified: 2025-10-02
vereisten:
  - REQ-040
  - REQ-049
  - REQ-052
---

# US-219 — Duplicate‑check uitbreiden met synoniemen (context‑aware)

**Als** definitie‑auteur
**wil ik** dat de duplicate‑check vóór definitie‑generatie óók synoniemen van het begrip herkent
**zodat** invoer via een synoniem dezelfde harde duplicate‑gate triggert wanneer de context gelijk is.

## Context & Rationale
- Huidige duplicate‑check (DB‑laag + DUP‑01 regel) matcht primair op `definities.begrip` in combinatie met context (organisatorisch, juridisch, wettelijk). Synoniemen in `definitie_voorbeelden` tellen niet mee, waardoor een invoer via een synoniem niet als duplicaat wordt gezien.
- De UI (Generator/Bewerk/Expert Review) hergebruikt één pad voor duplicate‑check; uitbreiding op DB‑/service‑laag dekt alle tabs.
- Voorkeursterm‑keuze (begrip of synoniem) mag geen invloed hebben op het kunnen herkennen van duplicaten: alle actieve synoniemen moeten meetellen.

## Scope
- Alleen Definitie Generatie flow (pre‑check). Bewerk en Expert Review blijven zonder duplicate‑gate.
- Uitbreiden duplicate‑detectie in repository met exacte synoniem‑matches (case‑insensitive).
- Optionele index voor performante case‑insensitive synoniem‑lookups.
- DUP‑01 aanpassing van reason‑labels optioneel (follow‑up).

## Acceptatiecriteria
- AC1: Exact begrip + context (org, jur, wet) geeft harde duplicate‑gate (USE_EXISTING/UPDATE_EXISTING) — ongewijzigd.
- AC2: Exact synoniem + context (case‑insensitive; actief synoniem) geeft dezelfde harde duplicate‑gate als AC1.
- AC3: Orde‑onafhankelijkheid op wettelijke_basis blijft gelden in beide paden.
- AC4: Voorkeursterm‑keuze (begrip of synoniem) heeft geen invloed op de gate; alle actieve synoniemen tellen mee.
- AC5: Performance < 100 ms bij ~10k records (CI‑index op synoniemtekst aanwezig).

## Implementatie (korte samenvatting)
- Repository: `src/database/definitie_repository.py`
  - `find_definitie(...)` uitgebreid met exact synoniem + context pad (JOIN op `definitie_voorbeelden`).
  - `find_duplicates(...)` uitgebreid met exact synoniem + context pad, met reden "Exact match: synoniem + context".
- Migratie/Index (SQLite): `src/database/schema.sql` en `src/database/migrate_database.py`
  - Index: `idx_synonyms_text_ci` voor case‑insensitive synoniem‑lookups.
  - Idempotent aangemaakt in migrator.
- Niet in scope: fuzzy synoniem‑match en DUP‑01 reason‑labels (follow‑up mogelijk).

## Testplan
- Unit/integration tests:
  - `tests/integration/test_duplicate_check_synonyms.py::test_exact_synonym_match_counts_as_duplicate`
  - `tests/integration/test_duplicate_check_synonyms.py::test_synonym_match_with_different_context_is_not_duplicate`
- Handmatig (UI):
  1) Maak definitie A: begrip=“Identiteitsmiddel”, synoniemen=[“Identiteitsbewijs”, “ID‑kaart”], org=OM, jur=Strafrecht, wet=[Art. 27 Sv].
  2) Start generator met begrip=“ID‑kaart” en identieke context → duplicate‑UI (Exact synoniem + context).
  3) Varieer context (bv. wet=[Art. 67 Sv]) → geen duplicate‑UI.
  4) (optioneel) Fuzzy via synoniem — niet in scope.

## Niet‑functioneel
- Idempotente migraties; geen dataverlies.
- Case‑insensitive matching voor synoniemen (SQLite `COLLATE NOCASE`).
- Geen netwerkafhankelijkheden.

## Risico's en mitigatie
- Extra index vergroot DB‑bestand — Alleen aanmaken als niet bestaat; evalueren bij >10k records.
- False positives via fuzzy — Drempel 0.85 en redenrapportage zodat gebruiker kan beoordelen.

## Traceability
- Koppelt aan REQ‑040 (duplicate flow), REQ‑049 (UI beslispunten), REQ‑052 (database integriteit): zie Portal.

## Open Besluiten
- Fuzzy drempel eventueel configureerbaar maken via settings.
