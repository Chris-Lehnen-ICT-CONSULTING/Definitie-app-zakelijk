---
id: US-214
epic: EPIC-002
status: open
prioriteit: MEDIUM
story_points: 5
sprint: next
owner: backend
applies_to: definitie-app@current
canonical: false
last_verified: 2025-10-02
created_at: 2025-09-19
dependencies: [US-193]
---

# US-214 — Implementeer Type Hints voor ValidationDetailsDict en gerelateerde types

## Doel
Versterk type safety in de validation layer door complete type annotations toe te voegen, wat leidt tot minder runtime errors, betere IDE ondersteuning en duidelijkere code documentatie.

## Context
Uit de US-193 multi-agent review (P3-12) blijkt dat validation data structures geen type hints hebben, wat leidt tot onvoorspelbaar gedrag en moeilijk te debuggen code. ValidationDetailsDict is de centrale datastructuur maar mist type definities.

## Scope

### In scope
- Creëer TypedDict definities voor alle validation structures
- Implementeer type hints op alle validation service methods
- Voeg runtime type validation helpers toe
- Update alle validation consumers met typed interfaces
- Configureer mypy voor stricte type checking

### Niet in scope
- Pydantic models (aparte US indien gewenst)
- UI type definitions (frontend verantwoordelijkheid)
- Legacy V1 validation code

## Acceptance Criteria

### Functioneel
- [ ] TypedDict voor ValidationDetailsDict compleet gedefinieerd
- [ ] Alle validation methods hebben return type annotations
- [ ] IDE autocomplete werkt voor validation objects
- [ ] Type errors worden compile-time gedetecteerd
- [ ] Documentatie gegenereerd uit type hints

### Technisch
- [ ] `src/services/validation/types.py` bevat alle type definitions
- [ ] Mypy draait zonder errors op validation modules
- [ ] 100% van public methods heeft type hints
- [ ] Runtime type guards voor externe data
- [ ] Generic types voor flexibele responses

## Implementatie

### 1. Core Type Definitions
```python
# src/services/validation/types.py
from typing import TypedDict, List, Dict, Optional, Literal, Any, Union
from typing_extensions import NotRequired, Required

class ViolationDict(TypedDict):
    """Represents a validation rule violation."""
    rule_id: Required[str]
    severity: Required[Literal["high", "medium", "low"]]
    description: Required[str]
    suggestion: NotRequired[str]
    metadata: NotRequired[Dict[str, Any]]
    line_number: NotRequired[int]
    category: NotRequired[str]

class ValidationDetailsDict(TypedDict):
    """Complete validation result structure."""
    overall_score: Required[float]  # 0.0 - 1.0
    is_acceptable: Required[bool]
    violations: Required[List[ViolationDict]]
    passed_rules: Required[List[str]]
    metadata: NotRequired[Dict[str, Any]]
    processing_time: NotRequired[float]
    correlation_id: NotRequired[str]
    rule_timings: NotRequired[Dict[str, float]]

class ValidationContext(TypedDict):
    """Context for validation operations."""
    begrip: Required[str]
    organisatorische_context: NotRequired[List[str]]
    juridische_context: NotRequired[List[str]]
    wettelijke_basis: NotRequired[List[str]]
    ontologische_categorie: NotRequired[str]
    correlation_id: NotRequired[str]
```

### 2. Service Method Signatures
```python
# src/services/validation/modular_validation_service.py
from typing import Protocol

class ValidationServiceProtocol(Protocol):
    """Protocol defining validation service interface."""

    async def validate_definition(
        self,
        begrip: str,
        text: str,
        context: ValidationContext | None = None,
        **kwargs: Any
    ) -> ValidationDetailsDict:
        """Validate a definition with full type safety."""
        ...

    def get_rule_weights(self) -> Dict[str, float]:
        """Get current rule weight configuration."""
        ...
```

### 3. Type Guards
```python
# src/services/validation/type_guards.py
from typing import TypeGuard

def is_validation_details(obj: Any) -> TypeGuard[ValidationDetailsDict]:
    """Runtime check if object matches ValidationDetailsDict."""
    return (
        isinstance(obj, dict) and
        "overall_score" in obj and
        isinstance(obj["overall_score"], (int, float)) and
        "is_acceptable" in obj and
        isinstance(obj["is_acceptable"], bool) and
        "violations" in obj and
        isinstance(obj["violations"], list) and
        "passed_rules" in obj and
        isinstance(obj["passed_rules"], list)
    )

def ensure_validation_details(obj: Any) -> ValidationDetailsDict:
    """Ensure object is valid ValidationDetailsDict or raise."""
    if not is_validation_details(obj):
        raise TypeError(f"Invalid validation details: {obj}")
    return obj
```

## Migration Path

### Phase 1: Type Definitions (Day 1-2)
- Create all TypedDict definitions
- Add to existing modules without breaking changes

### Phase 2: Service Layer (Day 3-4)
- Add type hints to all service methods
- Update internal helper functions

### Phase 3: Integration Points (Day 5)
- Update orchestrator interfaces
- Type service factory methods
- Add guards at API boundaries

## Test Strategie

### Type Testing
```python
# tests/unit/test_validation_types.py
def test_validation_details_typing():
    """Test type definitions are correct."""
    details: ValidationDetailsDict = {
        "overall_score": 0.85,
        "is_acceptable": True,
        "violations": [],
        "passed_rules": ["RULE1", "RULE2"]
    }
    # This should type-check correctly
    assert details["overall_score"] <= 1.0

def test_type_guard():
    """Test runtime type validation."""
    invalid = {"score": 0.5}  # Wrong structure
    assert not is_validation_details(invalid)

    valid = {
        "overall_score": 0.5,
        "is_acceptable": False,
        "violations": [],
        "passed_rules": []
    }
    assert is_validation_details(valid)
```

### Mypy Configuration
```ini
# pyproject.toml
[tool.mypy]
python_version = "3.11"
strict = true
warn_return_any = true
warn_unused_configs = true
disallow_untyped_defs = true
disallow_any_generics = true
check_untyped_defs = true
no_implicit_optional = true
warn_redundant_casts = true
warn_unused_ignores = true
warn_no_return = true
```

## Impact Analysis

### Positieve Impact
- **Developer Experience**: Auto-complete en inline docs
- **Bug Prevention**: Compile-time type checking
- **Refactoring Safety**: Type-safe changes
- **Documentation**: Self-documenting code
- **Testing**: Clearer test interfaces

### Risico's
- Initial development overhead
- Potential test updates needed
- Learning curve voor team
- Stricter coding requirements

## Metrics

### Success Metrics
- Mypy coverage: 100% validation modules
- Type errors detected pre-production: > 10
- IDE satisfaction survey: > 80% positive
- Bug reduction: -30% type-related bugs

## Dependencies
- Python 3.11+ voor moderne typing features
- typing-extensions==4.8+
- mypy==1.5+

## Notities
- Prioriteit P3 uit US-193 review
- Coordinate met UI team voor consistente types
- Consider gradual typing adoption
- Document type conventions in CLAUDE.md

## Links
- [Python Typing Documentation](https://docs.python.org/3/library/typing.html)
- [TypedDict PEP 589](https://www.python.org/dev/peps/pep-0589/)
- [Mypy Documentation](http://mypy-lang.org/)
- Parent: US-193