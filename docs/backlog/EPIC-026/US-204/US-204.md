---
id: US-204
titel: "US-204: title: Complete V1 to V2 Migration"
title: Complete V1 to V2 Migration
status: in_progress
priority: HIGH
story_points: 8
owner: development-team
applies_to: definitie-app@current
canonical: false
last_verified: 2025-10-02
epic_id: EPIC-026
assignee: team
created_date: 2025-01-18
updated_date: 2025-01-18
progress: 20%
labels: [phoenix, migration, refactoring, technical-debt]
acceptance_criteria:
  - All V1 code paths removed from codebase
  - All imports updated to V2 services
  - No backwards compatibility code remaining
  - All tests passing with V2 implementations
  - Performance metrics maintained or improved
definition_of_done:
  - Code review completed
  - All unit tests passing
  - Integration tests verified
  - No V1 references in codebase (currently: 513)
  - Documentation updated
dependencies:
  - US-201 (COMPLETED - ServiceContainer caching)
  - US-202 (COMPLETED - Validation rules caching)
  - US-203 (COMPLETED - Token analysis)
---

# US-204: Complete V1 to V2 Migration

## User Story
**Als** ontwikkelaar
**Wil ik** alle V1 code paden volledig verwijderd hebben
**Zodat** de codebase alleen moderne V2 implementaties bevat zonder technische schuld

## ðŸ“Š Current Status (2025-01-18)

### Progress Overview
- **V1/Legacy references gevonden**: 513
- **Feature flags te verwijderen**: 4
- **Legacy functions te verwijderen**: 8
- **Files met V1 imports**: ~20
- **Geschatte tijd**: 50 minuten

### Completed âœ…
- US-201: ServiceContainer caching implemented
- US-202: Validation rules caching implemented
- US-203: Token optimization research completed

### In Progress ðŸ”„
- Inventory van alle V1 references (513 gevonden)
- Migration plan opgesteld

## Acceptance Criteria

### Code Migration
- [ ] Alle V1 services verwijderd uit `/src/services/`
- [ ] Alle V1 imports vervangen door V2 equivalenten
- [ ] Backwards compatibility code verwijderd
- [ ] Feature flags voor V1/V2 switching verwijderd
- [ ] Legacy configuratie verwijderd

### Service Updates
- [ ] `AIService` â†’ `AIServiceV2` migratie compleet
- [ ] `PromptService` â†’ `PromptServiceV2` migratie compleet
- [ ] `ValidationService` â†’ `ModularValidationService` migratie compleet
- [ ] `DefinitionGenerator` â†’ `UnifiedDefinitionGenerator` migratie compleet
- [ ] Alle service dependencies bijgewerkt in `ServiceContainer`

### Code Quality
- [ ] Geen enkele file bevat nog "V1" in class/function namen
- [ ] Geen deprecated imports aanwezig
- [ ] Alle TODO/FIXME comments m.b.t. V1â†’V2 opgelost
- [ ] Code coverage minimaal 80% behouden

### Testing
- [ ] Alle unit tests draaien met V2 services
- [ ] Integration tests werken zonder V1 dependencies
- [ ] Smoke tests slagen volledig
- [ ] Performance benchmarks gelijk of beter dan V1

## Technical Implementation Notes

### ðŸŽ¯ UPDATED IMPLEMENTATION PLAN (50 min total)

#### Quick Win 1: Feature Flags Cleanup (5 min)
```bash
# Files te wijzigen:
config/feature_flags.py         # Verwijder ENABLE_V1_ORCHESTRATOR
ui/helpers/feature_toggle.py    # Verwijder render_legacy_warning()
```

#### Quick Win 2: Legacy Functions Removal (15 min)
```python
# Te verwijderen functies:
ui/tabbed_interface.py:
  - _legacy_pattern_matching()
  - legacy_scores variabelen

ui/session_state.py:
  - Legacy metadata restoration code

services/validation/config.py:
  - extract_v1_config()
```

#### Quick Win 3: V1 Service References (10 min)
```python
# Clean up in services/:
ai_service_v2.py:
  - Remove "V1-compatible caching" comments
  - Remove V1 cache key generation

interfaces.py:
  - Remove "DEPRECATED" warnings
```

#### Quick Win 4: Import Updates (10 min)
```python
# Check en fix alle imports
# OLD: from services.ai_service import AIService
# NEW: from services.ai.ai_service_v2 import AIServiceV2
```

#### Quick Win 5: Test & Validate (10 min)
```bash
# Verify no V1 references remain
grep -r "V1\|v1_\|Legacy\|deprecated" src/ --include="*.py"

# Run tests
pytest tests/ -v
```

### Phase 2: Service Migration (UPDATED)
1. Update `ServiceContainer` om alleen V2 services te registreren
2. Verwijder alle V1 service files:
   - `src/services/ai_service.py` â†’ gebruik alleen `ai_service_v2.py`
   - `src/services/prompt_service.py` â†’ gebruik alleen `prompt_service_v2.py`
   - `src/services/validation_service.py` â†’ gebruik alleen `modular_validation_service.py`
   - `src/services/definition_generator.py` â†’ gebruik alleen `unified_definition_generator.py`

### Phase 3: Import Updates (Day 4)
```python
# Oude imports
from services.ai_service import AIService
from services.prompt_service import PromptService

# Nieuwe imports
from services.ai.ai_service_v2 import AIServiceV2
from services.prompt.prompt_service_v2 import PromptServiceV2
```

### Phase 4: Configuration Cleanup (Day 5)
- Verwijder `DEV_MODE` environment variable checks
- Verwijder conditional service loading
- Update `config/` files voor V2-only configuratie
- Verwijder legacy prompt templates

### Phase 5: Testing & Validation (Day 6-7)
```bash
# Volledige test suite
pytest tests/ -v --cov=src --cov-report=html

# Specifieke V2 validatie
pytest tests/services/ -k "v2"

# Performance vergelijking
python scripts/performance_benchmark.py
```

## Risks & Mitigations

### Risk: Hidden Dependencies
**Mitigation**: Gebruik dependency analyzer tools
```bash
python scripts/analyze_dependencies.py --check-v1-refs
```

### Risk: Performance Degradation
**Mitigation**: Run performance benchmarks voor en na migration
```bash
make benchmark-before
# ... migration ...
make benchmark-after
make benchmark-compare
```

### Risk: Missed V1 References
**Mitigation**: Comprehensive grep patterns
```bash
# Check voor subtiele V1 patterns
grep -r "version.*1\|v1_\|_v1\|V1_\|_V1" src/
grep -r "legacy\|deprecated\|old_\|Old" src/ --ignore-case
```

## Definition of Done

- [ ] **Code Review**: Minimaal 2 developers hebben code review gedaan
- [ ] **Testing**:
  - Alle unit tests slagen (100%)
  - Integration tests slagen (100%)
  - Smoke tests slagen (100%)
  - Code coverage â‰¥ 80%
- [ ] **Documentation**:
  - CLAUDE.md bijgewerkt zonder V1 references
  - API documentatie bijgewerkt
  - Migration notes gedocumenteerd in `docs/archief/migrations/`
- [ ] **Performance**:
  - Response tijd â‰¤ V1 baseline
  - Memory usage â‰¤ V1 baseline
  - API calls â‰¤ V1 baseline
- [ ] **Cleanup**:
  - Geen V1 files in repository
  - Geen V1 imports in code
  - Geen compatibility layers
  - Git history shows clear migration commit

## Notes

### Belangrijke Files om te Checken
- `/src/services/container.py` - service registratie
- `/src/main.py` - hoofdapplicatie imports
- `/src/ui/tabs/*.py` - UI component imports
- `/tests/` - test imports en mocks

### Cleanup Checklist
```bash
# Files om te verwijderen
rm src/services/ai_service.py
rm src/services/prompt_service.py
rm src/services/validation_service.py
rm src/services/definition_generator.py
rm -rf src/services/legacy/
rm -rf config/v1/

# Directories om te controleren
ls -la src/services/
ls -la config/
grep -r "TODO.*[Vv]1\|FIXME.*[Vv]1" src/
```

### Success Metrics
- Zero V1 references in codebase
- All tests green
- Performance within 5% of V1 baseline
- Code coverage maintained above 80%
- No regression bugs reported

## Related Items
- Parent: [[EPIC-020-PHOENIX]]
- Depends on: [[US-201]], [[US-202]], [[US-203]]
- Blocks: [[US-207]], [[US-208]]
- Related: [[US-205]] (god class refactoring), [[US-206]] (business logic extraction)