---
Afhankelijkheden:
- US-001
- US-002
aangemaakt: 03-01-2025
bijgewerkt: 05-09-2025
epic: EPIC-001
id: US-003
prioriteit: KRITIEK
sprint: Voltooid
status: GEREED
story_points: 13
titel: Eliminate Legacy V1 Orchestrator en Migrate to V2 Service Architecture
toegewezen_aan: development-team
vereisten:
- REQ-018
- REQ-020
- REQ-059
- REQ-078
---



# US-003: Eliminate Legacy V1 Orchestrator en Migrate to V2 Service Architecture

## Gebruikersverhaal
**As a** system architect responsible for DefinitieAgent maintainability
**wil ik** to eliminate the legacy V1 orchestrator en complete migration to V2 service architecture
**zodat** we reduce code complexity by 40%, eliminate 6x service initialization bug, En improve Prestaties by 30%

## Problem Statement

**Current Situation:**
- V1 en V2 orchestrators running in parallel (code duplication)
- Services initialized 6x per session due to V1 legacy hooks
- 15,000 lines of deprecated V1 code still in codebase
- Memory usage 2x hoger due to duplicate service instances
- Complex branching logic to support both Versies
- V1 hardcoded configurations blocking environment flexibility

**Desired Outcome:**
- Single V2 orchestrator with clean architecture
- Services initialized once per session (singleton pattern)
- Remove all V1 code (15,000 lines reduction)
- Memory usage reduced by 50%
- Simplified codebase with single execution path
- Full environment-based configuration support

## Acceptatiecriteria


### SMART Acceptatiecriteria

- **Specifiek:** Migreer volledig van V1 naar V2 orchestrator met singleton pattern
- **Meetbaar:**
  - Code reductie: 15.000 regels V1 code verwijderd
  - Service init: 1x i.p.v. 6x per sessie
  - Memory gebruik: < 250MB (50% reductie)
  - Startup tijd: < 2 seconden (was 12s)
  - Test coverage: > 80% behouden
  - 0 V1 references in codebase
- **Acceptabel:** Gefaseerde migratie met rollback optie
- **Relevant:** Elimineert technische schuld en verbetert performance
- **Tijdgebonden:** Voltooid in Sprint 3 (2 weken)


### Criterion 1: Complete V1 Code Removal
**gegeven** the codebase contains V1 orchestrator files
**wanneer** migration is complete
**dan**:
- All files matching `*_v1.py` are deleted
- No imports from `legacy` package remain
- No references to `DefinitionOrchestrator` (V1 class)
- Code coverage remains > 80%

### Criterion 2: V2 Service Architecture Active
**gegeven** the application starts
**wanneer** checking service initialization
**dan**:
- `ValidationOrchestratorV2` is the only orchestrator
- Services initialized exactly once (verified in logs)
- All afhankelijkheid injection via `ServiceContainer`
- No hardcoded service instantiation

### Criterion 3: Prestaties Improvements Achieved
**gegeven** V2 architecture is fully active
**wanneer** measuring system Prestaties
**dan**:
- Service initialization time < 2 seconds (was 12 seconds)
- Memory usage < 250MB per session (was 500MB)
- Definition generation time < 3 seconds (was 5 seconds)
- No memory leaks after 1000 operations

### Criterion 4: Feature Parity Maintained
**gegeven** all V1 features are migrated
**wanneer** running regression test suite
**dan**:
- All 45 validatieregels still working
- All UI tabs functional
- Database operations intact
- Export/import features operational
- Zero functional regression

## Technical Implementatie

### Implementatie Approach

1. **Step 1**: Map V1 to V2 service Afhankelijkheden
   ```python
   # V1 -> V2 Mapping
   DefinitionOrchestrator -> ValidationOrchestratorV2
   AIService -> AIServiceV2
   PromptService -> PromptServiceV2
   ValidationService -> ModularValidationService
   ```

2. **Step 2**: UpDatum ServiceContainer in `src/services/container.py`
   - Remove V1 service registrations
   - Ensure singleton pattern with `@st.cache_resource`
   - Add lazy loading for Prestaties

3. **Step 3**: Refactor entry points
   - UpDatum `src/main.py` to use V2 only
   - Remove feature flags for V1/V2 selection
   - Clean up session state management

4. **Step 4**: Delete V1 files en upDatum imports
   ```bash
   # Files to delete
   src/services/definition_orchestrator.py
   src/services/ai_service.py  # (V1)
   src/services/prompt_service.py  # (V1)
   src/services/validation_service.py  # (V1)
   src/legacy/*
   ```

5. **Step 5**: UpDatum all UI components
   - Refactor `src/ui/tabs/*.py` to use V2 services
   - Remove V1 compatibility code
   - UpDatum state management

### Code Locations
- Files to modify:
  - `src/main.py` (entry point)
  - `src/services/container.py` (DI container)
  - `src/ui/tabs/*.py` (all UI tabs)
  - `src/services/__init__.py` (exports)
- Files to delete:
  - `src/services/*_v1.py`
  - `src/legacy/`
  - `src/compat/`
- New patterns:
  - Singleton: `@st.cache_resource` on ServiceContainer
  - Lazy loading: Services aangemaakt on first use
  - Dependency injection: All services from container

### Technical Decisions
- Use singleton pattern to prevent re-initialization
- Implement lazy loading to improve startup time
- Add service health checks for monitoring
- Use interfaces for all service contracts
- Implement circuit breaker pattern for resilience

## Domain & compliance

### Domeinregels
- **ASTRA vereiste**: Service-oriented architecture with loose coupling
- **NORA principle**: Eliminate technical debt systematically
- **justitieketen impact**: Zero disruption to OM/DJI/Rechtspraak workflags
- **Continuity**: Maintain backward compatibility for data formats

### beveiliging & Privacy
- **beveiliging**: Remove deprecated auDanticatie methods from V1
- **Privacy**: Ensure V2 maintains same privacy controls
- **Audit**: Log migration completion en service Versies
- **Rollback**: Keep V1 backup for 30 days post-migration



## Afhankelijkheden

- EPIC-001
## Test Scenario's

### Unit Tests

1. **Test**: `test_v2_orchestrator_singleton()`
   - Setup: Initialize ServiceContainer multiple times
   - Expected: Same instance returned
   - Assert: `id(container1) == id(container2)`
   - File: `tests/services/test_container.py`

2. **Test**: `test_no_v1_imports()`
   - Action: Scan all Python files for V1 imports
   - Expected: Zero V1 references found
   - Assert: `"_v1" not in imports`, `"legacy" not in imports`

3. **Test**: `test_service_initialization_count()`
   - Setup: Clear logs, start application, generate definition
   - Count: Service init messages in logs
   - Assert: Each service initialized exactly once

### Integration Tests

1. **Test**: `test_full_flag_with_v2()`
   - Actions: Generate -> ValiDatum -> Export -> Import
   - maatregel: Success rate, Prestaties
   - Assert: All operations successful, time < V1 baseline

2. **Test**: `test_memory_usage_after_migration()`
   - Setup: Generate 100 definitions sequentially
   - maatregel: Memory before/after
   - Assert: `memory_after - memory_before < 50MB`

### Prestaties Tests

1. **Test**: `test_startup_Prestaties()`
   - maatregel: Time from start to ready
   - Assert: `startup_time < 2 seconds`

2. **Test**: `test_concurrent_operations()`
   - Setup: 50 concurrent definition requests
   - Assert: No service re-initialization, all complete < 10s

## Definitie van Gereed

- [x] V1 to V2 service mapping documented
- [x] ServiceContainer bijgewerkt with singleton pattern
- [x] All V1 files deleted from codebase
- [x] All imports bijgewerkt to V2 services
- [x] UI components refactored for V2
- [x] Unit tests bijgewerkt en passing (82% coverage)
- [x] Integration tests confirm feature parity
- [x] Prestaties benchmarks met (35% improvement)
- [x] Memory usage reduced by 55%
- [x] Zero V1 references in codebase
- [x] Code review by senior architects
- [x] Gradual rollout with monitoring
- [x] Documentation bijgewerkt
- [x] Rollback plan tested

## Risks & Mitigation

1. **Risk**: Hidden V1 Afhankelijkheden cause runtime errors
   - Probability: GEMIDDELD
   - Impact: HOOG
   - Mitigation: Comprehensive integration testing, gradual rollout

2. **Risk**: Prestaties regression in edge cases
   - Probability: LAAG
   - Impact: GEMIDDELD
   - Mitigation: Prestaties monitoring, quick rollback capability

3. **Risk**: Data format incompatibility
   - Probability: LAAG
   - Impact: HOOG
   - Mitigation: Data migration scripts, compatibility layer

## Notes & References

### Migration Timeline
- Planning: 10-01-2025
- V1 analysis: 12-01-2025
- V2 Implementatie: 15-01-2025
- Testen phase: 18-01-2025
- Gradual rollout: 20-01-2025
- V1 removal: 25-01-2025
- Production stable: 01-02-2025

### Metrics Achieved
- Code reduction: 15,000 lines removed ✅
- Service init: 1x instead of 6x ✅
- Memory usage: 55% reduction ✅
- Prestaties: 35% faster ✅
- testdekking: 82% maintained ✅

### Gerelateerde Documentatie
- Migration plan: `docs/migration/v1-to-v2.md`
- Architecture: `docs/architectuur/SOLUTION_ARCHITECTURE.md`
- Service docs: `docs/services/orchestrator_v2.md`

---

*This story is part of EPIC-001: Basis Definitie Generatie*
