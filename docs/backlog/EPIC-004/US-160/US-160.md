---
id: US-160
titel: Validatie‑gate bij Vaststellen (Option B)
epic: EPIC-004
status: Backlog
prioriteit: HOOG
story_points: 5
sprint: backlog
toegezegd_door: product-owner
aangemaakt: 2025-09-13
bijgewerkt: 2025-09-13
owner: frontend-team
type: feature
applies_to: definitie-app@current
canonical: true
last_verified: 2025-09-13
vereisten:
- REQ-093
---

# US-160: Validatie‑gate bij Vaststellen (Option B)

## Gebruikersverhaal
**Als** expert reviewer
**wil ik** dat het vaststellen van definities aan kwaliteitsregels voldoet (met duidelijke drempels en eventueel override)
**zodat** alleen kwalitatief acceptabele definities als Vastgesteld de keten in gaan

## Context en scope
- Gate wordt zowel in de UI zichtbaar als in de service afgedwongen.
- Option B gekozen: 
  - Hard verplicht: organisatorische_context, juridische_context ingevuld.
  - Soft verplicht: wettelijke_basis (waarschuwing/override met reden verplicht).
  - Score‑drempel: overall_score ≥ 0.75 en geen ‘critical’ issues (configurabel).
- Uitbreidingen/andere opties worden expliciet NIET in deze US geïmplementeerd en worden vastgelegd (zie “Niet opgenomen in scope”).

## Acceptatiecriteria (SMART)
1) UI‑gate duidelijk zichtbaar:
- Expert‑tab toont validatiescore en issues.
- Knop “Vaststellen” is:
  - Groen (enabled) wanneer gate gehaald is.
  - Oranje (enabled, met “Vaststellen met override” + reden verplicht) bij soft‑violations (bijv. ontbrekende wettelijke basis of enkel ‘high’ issues, score ≥ 0.65).
  - Grijs (disabled) wanneer hard‑gate niet gehaald is (score < 0.75 of ‘critical’ issues of ontbrekende org/jur context).
2) Service‑gate enforced:
- DefinitionWorkflowService blokkeert transitie naar established indien hard‑gate niet gehaald is.
- Bij override (soft‑gate) is “reden” verplicht en wordt als notes/geschiedenis vastgelegd.
3) Logging/Audit:
- Gate‑uitkomst (pass/blocked/override) en eventuele override‑reden in `definitie_geschiedenis` (notes/reden) terug te vinden.
4) Configurabel:
- Drempel (min_overall_score), forbid_critical, soft‑override‑drempel en require_fields via centrale policy (YAML/DI). Defaults gedocumenteerd.
5) Regressie‑vrij:
- Bestaande Vaststellen/Afwijzen/Terugzetten functionaliteit blijft werken; UI geeft duidelijke meldingen.

## Niet opgenomen in scope (vastgelegd voor vervolg‑US’en)
- Option C (alle drie contextvelden hard) – NIET nu.
- Conditioneel vereisen van wettelijke_basis (bijv. op status/categorie) – NIET nu.
- UI‑beheer van policy (variabelen) – opgenomen in EPIC‑016.

## UI Specificaties (Expert‑tab)
- Badge/indicator bij score (groen/oranje/grijs) met toelichting op niet‑gehaalde criteria.
- Override‑dialoog (reden verplicht) bij soft‑gate; reden wordt gelogd.

## Service Specificaties
- DefinitionWorkflowService consulteert ApprovalGatePolicy (DI) en beslist gate‑uitkomst voor statuswijziging.
- Bij override: statuswijziging toegestaan met notes.

## Testscenario’s
- Gate pass (score ≥ 0.75, geen critical, org/jur gevuld) → Vaststellen lukt.
- Soft‑gate (score 0.65–0.74 of enkel ‘high’ issues) → Vaststellen met override (reden verplicht) lukt en logt.
- Hard‑fail (score < 0.65 of critical issues of org/jur leeg) → Vaststellen disabled en service‑block met melding.

## Definition of Done
- [ ] UI‑gate zichtbaar en correct (groen/oranje/grijs + override flow)
- [ ] Service‑gate enforced (block/override met logging)
- [ ] Policy laadbaar/configureerbaar via DI (YAML)
- [ ] Documentatie bijgewerkt (README/architectuur)
- [ ] Smoke‑tests handmatig gedraaid voor pass/soft‑override/block

## Achtergrond & Businesswaarde
- Verhoogt kwaliteit en consistentie van “Vastgestelde” definities; vermindert herwerk.
- Maakt besluitvorming transparant (override met reden) en auditeerbaar.

## In scope / Out of scope
In scope:
- Gate‑policy toepassen bij Vaststellen (UI + service), Option B.
- Duidelijke gebruikersfeedback en logging.
Out of scope:
- UI‑beheer van policy (EPIC‑016), conditionele vereisten voor wettelijke_basis, Option C.

## Businessregels
- Gate beslist op basis van: overall_score, violation severities, aanwezigheid vereiste velden.
- Soft‑gate: override vereist “reden” (notes) → audit.
- Gate beslist vóór statuswijziging (service), UI toont status van de gate.

## UI/UX specificaties (verder uitgewerkt)
- Indicator bij validatiescore: groen (≥0.75, geen critical), oranje (≥0.65 en alleen high/soft‑issues), grijs (onder drempel of missing hard‑fields).
- Tooltip/expander met exacte criteria (drempels, ontbrekende velden, issues samenvatting).
- Override dialoog: tekstveld (min 10 chars), bevestigknop, melding dat audit wordt vastgelegd.

## Service/API specificaties
- Nieuw GatePolicyReader (DI) die policy leest (YAML→object) met caching (TTL 60s).
- DefinitionWorkflowService.approve() roept gate.validate(definition, validation_result) aan en beslist Allow/AllowWithOverride/Block.
- Bij Override: notes toevoegen aan history; bij Block: foutcode + boodschap (UI toont deze).

## Data/Config
- YAML‑voorbeeld (defaults):
```yaml
policy:
  mode: hard
  min_overall_score: 0.75
  forbid_critical: true
  forbid_high: false
  override_min_overall_score: 0.65
  require_fields: [organisatorische_context, juridische_context]
  notes_required: true
```

## Monitoring/Telemetrie
- Tel aantal vaststellingen per dag, overrides, blocks; gemiddelde score bij vaststellen; top reasons voor blok/override.

## Veiligheid/Autorisatie
- Gate is non‑bypassable (service‑enforcement); UI weerspiegelt uitkomst.
- Override reden verplicht, gelogd met user en timestamp.

## Risico’s & Mitigaties
- Te strenge drempel blokkeert doorstroom → policy configureerbaar en zichtbare feedback.
- Inconsistentie UI vs service → service leidend; UI leest service‑uitkomst.

## Roll‑out plan
- Fase 1: service‑enforcement + UI‑indicatoren (zonder beheer‑UI; YAML defaults).
- Fase 2 (EPIC‑016): beheer‑UI + audit + import/export; conditionele regels.

## Testmatrix (uitgebreid)
- [ ] PASS: score=0.80, geen critical, org/jur gevuld → knop groen, service approve OK.
- [ ] SOFT: score=0.70, geen critical, missing wettelijke_basis → override vereist; service approve met notes OK.
- [ ] BLOCK: score=0.60 of critical aanwezig of org/jur leeg → disabled/blocked; service foutmelding.
