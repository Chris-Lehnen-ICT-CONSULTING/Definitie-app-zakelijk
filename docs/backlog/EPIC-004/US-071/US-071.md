---
id: US-071
titel: Database schema aligneren met code en richtlijnen (reconciliatie)
epic: EPIC-004
status: Open
prioriteit: HIGH
story_points: 5
sprint: backlog
owner: architecture
applies_to: definitie-app@current
canonical: true
last_verified: 2025-09-12
---

# US-071: Database schema aligneren met code en richtlijnen (reconciliatie)

## Gebruikersverhaal
Als architect wil ik dat het databaseschema volledig in lijn is met het actuele gedrag van de applicatie en de projectrichtlijnen, zodat opslag, migraties en audittrail betrouwbaar zijn en toekomstige features (zoals de Edit Interface) geen schema-frictie veroorzaken.

## Context
- In [US-069](../US-069/US-069.md) is de kolom `wettelijke_basis` toegevoegd aan `definities` en gemigreerd.
- In [US-070](../US-070/US-070.md) is normalisatie naar een aparte tabel uitgewerkt (ontwerp) voor rijkere query’s.
- In de huidige code zijn er verschillen tussen wat geüpdatet mag worden (whitelist) en wat het schema ondersteunt; ook is het fallback-schema (noodpad) minder compleet dan `schema.sql`.

Document- en bronverwijzingen (controle):
- Schema: `src/database/schema.sql` (bestaat)
- Migratie: `src/database/migrate_database.py` (bestaat)
- DB-repository (CRUD/whitelist): `src/database/definitie_repository.py` (bestaat)
- Services-repository mapping: `src/services/definition_repository.py` (bestaat)

## Scope
In scope
- Whitelist-consolidatie in DB-repository: enkel schema-kolommen toestaan en noodzakelijke velden toevoegen (o.a. context, validatie, approval, export tracking, wettelijke_basis).
- Fallback-schema aligneren met `schema.sql` (zelfde kolommen incl. `previous_version_id`, `validation_date`, `validation_issues`, `source_reference`, `imported_from`, `updated_by`, `approved_*`, `export_*`, `wettelijke_basis`).
- Workflow-traceability velden (optioneel) voorbereiden in schema-ontwerp: `archived_by`, `archived_at`, `archive_reason`, `restored_by`, `restored_at` — of als alternatief: expliciete keuze om dit alleen via history vast te leggen. Keuze vastleggen in deze US.
- Triggers uitbreiden waar zinvol (context_snapshot bevat al status/context/wettelijke_basis; optie om `updated_by` mee te nemen).
- Index-review (behouden/bijsturen) op status, categorie, context en (optioneel) approval/updated_at voor rapportages.

Out of scope
- Implementatie van US-070 (aparte tabel) — apart opgenomen.
- UI-wijzigingen (vallen onder [US-064](../US-064/US-064.md)).

## Analyse (gap-overzicht)
1) Whitelist in `update_definitie()` bevat verouderde/niet-bestaande velden en mist schema-kolommen.
2) Fallback CREATE TABLE (alleen gebruikt als `schema.sql` ontbreekt) is incompleet t.o.v. `schema.sql`.
3) Workflow traceability bij archiveren/restoren wordt nu alleen via `definitie_geschiedenis` gelogd; expliciet schema-ondersteuning ontbreekt (bewuste keuze nodig).
4) JSON-kolom `wettelijke_basis` bestaat (US-069); consistentie met toekomstige normalisatie (US-070) borgen (transitieplan).

## Ontwerpbeslissingen (definitief)
- Whitelist: aligneren met schema; alleen bestaande kolommen toestaan. Toevoegen: `organisatorische_context`, `juridische_context`, `wettelijke_basis`, `validation_score`, `validation_date`, `validation_issues`, `approved_by`, `approved_at`, `approval_notes`, `last_exported_at`, `export_destinations`, `source_type`, `source_reference`, `imported_from`, `updated_by`.
- Fallback-schema: volledig gelijk trekken met `schema.sql`, incl. `wettelijke_basis` en alle genoemde kolommen; voorkomt runtime-drift op nieuwe omgevingen.
- Workflow-traceability: GEKOZEN OPTIE A — extra kolommen in `definities` toevoegen voor expliciete query’s:
  - `archived_by VARCHAR(255)`, `archived_at TIMESTAMP`, `archive_reason TEXT`
  - `restored_by VARCHAR(255)`, `restored_at TIMESTAMP`
- Triggers: context_snapshot uitbreiden met `updated_by` (optioneel) voor betere audit.

## Migraties (concept)
1) Whitelist-consolidatie vergt geen DDL, maar codewijziging; wel testen.
2) Fallback-schema DDL aanpassen (geen impact op bestaande DB’s; alleen op fresh installs zonder `schema.sql`).
3) Workflow-traceability (gekozen optie A — exacte DDL):
   - `ALTER TABLE definities ADD COLUMN archived_by VARCHAR(255);`
   - `ALTER TABLE definities ADD COLUMN archived_at TIMESTAMP;`
   - `ALTER TABLE definities ADD COLUMN archive_reason TEXT;`
   - `ALTER TABLE definities ADD COLUMN restored_by VARCHAR(255);`
   - `ALTER TABLE definities ADD COLUMN restored_at TIMESTAMP;`
   - (Optioneel) index op `archived_at`:
     - `CREATE INDEX IF NOT EXISTS idx_definities_archived_at ON definities(archived_at);`
4) Trigger-update (optioneel): `log_definitie_changes` → context_snapshot uitbreiden met `updated_by`.

## Acceptatiecriteria
- [ ] Whitelist in DB-repository bevat uitsluitend schema-kolommen en alle benodigde velden (zie ontwerpbeslissingen).
- [ ] Fallback-schema is inhoudelijk gelijk aan `schema.sql` (inclusief `wettelijke_basis`).
- [ ] Workflow-traceability: extra kolommen (`archived_*`, `restored_*`) bestaan en zijn opgenomen in fallback-schema.
- [ ] Triggers vastgelegd en (indien gekozen) uitgebreid met `updated_by` in snapshot.
- [ ] Documentatie gelinkt en klopt (schema, migratie, repository, services-repository).

## Teststrategie (concept)
- Eenheidstests: update-definitie met alle toegestane velden (geen silent drops), fout op niet-bestaande kolommen.
- Integratie: fresh install met fallback-schema → CRUD/validatie werken; install met `schema.sql` idem.
- Migratie (indien A): kolommen toegevoegd; schrijven/lezing van archief-/restore-informatie werkt en wordt gereflecteerd in history.

## Referenties (gecontroleerd)
- `src/database/schema.sql` — actueel
- `src/database/migrate_database.py` — actueel
- `src/database/definitie_repository.py` — actueel, bevat whitelist en CRUD
- `src/services/definition_repository.py` — actueel, mapping metadata↔DB
- Gerelateerd: [US‑064](../US-064/US-064.md), [US‑069](../US-069/US-069.md), [US‑070](../US-070/US-070.md), [EPIC‑004](../EPIC-004.md)
