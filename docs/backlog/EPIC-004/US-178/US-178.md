---
id: US-178
titel: Drafts & versies in repository (get_or_create_draft, history, rollback)
epic: EPIC-004
status: TODO
prioriteit: HIGH
story_points: 8
sprint: 2025-09
type: feature
applies_to: definitie-app@current
canonical: true
owner: backend-team
---

# US-178: Drafts & versies in repository (get_or_create_draft, history, rollback)

Doel: US‑064 uitbreiden met robuuste draft/versiebeheer conform `schema.sql` (JSON arrays als TEXT, UNIQUE‑combinatie).

## Scope
- `src/database/definitie_repository.py` toevoegen/uitbreiden met:
  - `get_or_create_draft(combinatie)` (idempotent; respecteert UNIQUE)
  - `create_draft_from(id)`
  - `get_history(begrip, context, categorie)`
  - `rollback_to(id)` (optimistic locking via `updated_at`)
- Service‑adapter voor UI (geen DB‑details in UI).

## Acceptatiecriteria
- Unit tests groen voor de 4 methoden; UNIQUE conflicts correct afgehandeld.
- Integratie: end‑to‑end flow Generate→Create draft→Edit→Validate→Publish→History→Rollback werkt.

## Testplan
- Unit: één draft per combinatie invariant; optimistic lock conflict bij verouderde timestamp.
- Integratie: smoke met mocks; geen UI‑state afhankelijkheden.

