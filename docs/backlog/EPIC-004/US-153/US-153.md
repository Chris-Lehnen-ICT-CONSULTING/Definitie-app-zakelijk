---
id: US-153
titel: Voeg wettelijke_basis toe aan DB schema en datalaag
epic: EPIC-004
status: IN_UITVOERING
prioriteit: HIGH
story_points: 3
sprint: backlog
toegevoegde_waarde: Persistente wettelijke basis voor definities (bronverantwoording)
owner: architecture
applies_to: definitie-app@current
canonical: true
last_verified: 2025-09-12
---

# US-153: Voeg `wettelijke_basis` toe aan DB schema en datalaag

## Gebruikersverhaal
Als jurist wil ik dat de wettelijke basis (verwijzingen naar wetten/regelingen) bij een definitie wordt opgeslagen in de database zodat deze traceerbaar is, kan worden hergebruikt en getoond in UI/exports.

## Achtergrond
- Contextvelden (organisatorisch/juridisch) worden al opgeslagen, maar `wettelijke_basis` stond alleen in requests/metadata.
- US-064 (Edit Interface) vereist dat wettelijke basis bewerkbaar en persistent is.

## Scope
- DB: kolom `wettelijke_basis TEXT` (JSON array) in tabel `definities` + historie‑trigger uitbreiden.
- Migratie: bestaande databases automatisch aanpassen.
- Datalaag: `DefinitieRecord` uitbreiden + helpers + CRUD‑paden opnemen.
- Services‑repository mapping: metadata <-> DB kolom.

## Implementatie (technisch)
- Schema (src/database/schema.sql)
  - Toegevoegd: `wettelijke_basis TEXT`
  - Trigger `log_definitie_changes`: include `wettelijke_basis` in `context_snapshot`.
- Migratie (src/database/migrate_database.py)
  - Voeg kolom toe indien ontbreekt (`ALTER TABLE definities ADD COLUMN wettelijke_basis TEXT`).
- DB‑Repository (src/database/definitie_repository.py)
  - Dataclass: veld `wettelijke_basis: str | None` + helpers `get_wettelijke_basis_list()` / `set_wettelijke_basis(list[str])`.
  - INSERT/SELECT/UPDATE: kolom toevoegen in beide codepaden (met/zonder legacy kolommen).
  - Whitelist uitbreiden: `organisatorische_context`, `juridische_context`, `wettelijke_basis` toegestaan.
  - Fallback schema (indien `schema.sql` ontbreekt) uitgebreid met `wettelijke_basis`.
- Services‑repository (src/services/definition_repository.py)
  - Mapping: `definition.metadata['wettelijke_basis']` ↔ `DefinitieRecord.wettelijke_basis` (via helpers).

## Acceptatiecriteria
- [ ] Nieuwe installs hebben kolom `wettelijke_basis` in `definities`.
- [ ] Migratiescript voegt de kolom toe aan bestaande DB’s zonder dataverlies.
- [ ] CRUD: aanmaken, lezen, updaten met wettelijke basis werkt end‑to‑end.
- [ ] Historie‑trigger logt wijzigingen inclusief `wettelijke_basis` in `context_snapshot`.
- [ ] Services‑repository rondt mapping correct af (metadata ↔ DB).

## Testen
- Unit: helpers (get/set), insert/select/update met waarden (1 en meerdere items), JSON‑validatie.
- Integratie: end‑to‑end flow (generate/edit → persist → export/preview) met wettelijke basis zichtbaar.
- Migratie: draaiproef op bestaande DB (zonder kolom) → kolom aanwezig, bestaande records behouden.

## Risico’s
- JSON‑parsing fouten: mitigatie via defensieve parsing en lege lijst fallback.
- Query performance: TEXT opslag volstaat; normalisatie naar aparte tabel kan later.

## Definition of Done
- [ ] Kolom aanwezig in schema en runtime DB (nieuwe + gemigreerde omgevingen)
- [ ] Datalaag en mapping afgerond
- [ ] Tests groen (unit + integratie)
- [ ] Documentatie en release notes bijgewerkt
