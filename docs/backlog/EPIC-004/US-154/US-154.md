---
id: US-154
titel: Normaliseer Wettelijke Basis naar eigen tabel(len) met rijke query-ondersteuning
epic: EPIC-004
status: Open
prioriteit: HIGH
story_points: 5
sprint: backlog
owner: architecture
applies_to: definitie-app@current
canonical: true
last_verified: 2025-09-12
---

# US-154: Normaliseer Wettelijke Basis naar eigen tabel(len) met rijke query-ondersteuning

## Gebruikersverhaal
Als data-analist en jurist wil ik dat de wettelijke basis van definities genormaliseerd wordt opgeslagen in een aparte tabel zodat ik rijke zoekvragen, rapportages en kwaliteitscontroles kan uitvoeren (bijv. per wet/artikel/jurisdictie), zonder de beperkingen van een JSON‑veld.

## Context
- Huidig: `wettelijke_basis` is een JSON array in `definities` (zie [US‑153](../US-153/US-153.md)). Dat is voldoende voor weergeven/basale opslag, maar beperkt voor query’s en datakwaliteit.
- Doel: Eerste‑klas entiteit(en) voor wettelijke verwijzingen met indexen en optionele masterdata, zonder bestaande flows te breken.
- Gerelateerd werk: [US‑064 (Edit Interface)](../US-064/US-064.md) — UI moet wettelijk kunnen bewerken; normalisatie maakt validatie en filters beter.
- Epic: [EPIC‑004](../EPIC-004.md)

## Scope
In scope
- Nieuwe tabel `definitie_wettelijke_basis` (many‑to‑one: verwijzingen per definitie).
- Optioneel (fase 2): mastertabel `wettelijke_bron` met metadata (BWBR, titel, jurisdictie, uri) en verwijzing vanuit de verwijzingstabel.
- Migratie: backfill uit `definities.wettelijke_basis` JSON (best effort) naar verwijzingstabel.
- Repo‑API’s: lezen/schrijven/DELTA‑updates op verwijzingen; geen sessiestate‑afhankelijkheden.
- UI‑schema: uitbreidingskader in Edit Interface (structuurvelden) — implementatie volgt in US‑064.

Out of scope
- Volledige implementatie van UI/Services (valt onder US‑064); deze US dekt ontwerp + migratie + repo‑contract.
- Verplichte masterdata‑lookup (kan later via Web Lookup epics/US’s).

## Ontwerp

### DDL (fase 1 — verwijzingstabel)
```sql
-- Verwijzingen naar wettelijke basis per definitie
CREATE TABLE IF NOT EXISTS definitie_wettelijke_basis (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    definitie_id INTEGER NOT NULL REFERENCES definities(id) ON DELETE CASCADE,

    -- Kernvelden (vrij te vullen; bron_id/citeerstring zijn optioneel/normeerbaar)
    bron_type VARCHAR(50),            -- bijv. "wet", "regeling", "richtlijn", "verdrag"
    bron_id VARCHAR(100),             -- bijv. BWBR-nummer of ECLI, vrij tekst
    citeerstring TEXT NOT NULL,       -- menselijke verwijzing; minimaal 1 veld verplicht
    artikel VARCHAR(50),              -- bijv. "2", "2.1.3"
    lid VARCHAR(50),                  -- bijv. "3"
    onderdeel VARCHAR(50),            -- bijv. "a"
    jurisdictie VARCHAR(50),          -- "NL", "EU"
    uri VARCHAR(500),                 -- link naar brontekst
    herkomst VARCHAR(100),            -- bijv. "manual", "lookup:wikipedia"

    actief BOOLEAN NOT NULL DEFAULT TRUE,
    aangemaakt_op TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    bijgewerkt_op TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Indexen voor query-prestaties
CREATE INDEX IF NOT EXISTS idx_wet_basis_definitie_id ON definitie_wettelijke_basis(definitie_id);
CREATE INDEX IF NOT EXISTS idx_wet_basis_bron_id ON definitie_wettelijke_basis(bron_id);
CREATE INDEX IF NOT EXISTS idx_wet_basis_bron_type ON definitie_wettelijke_basis(bron_type);

-- Trigger voor automatische timestamp updates
CREATE TRIGGER IF NOT EXISTS trg_wet_basis_update
AFTER UPDATE ON definitie_wettelijke_basis
FOR EACH ROW WHEN NEW.bijgewerkt_op = OLD.bijgewerkt_op
BEGIN
    UPDATE definitie_wettelijke_basis
    SET bijgewerkt_op = CURRENT_TIMESTAMP
    WHERE id = NEW.id;
END;
```

### DDL (fase 2 — optionele mastertabel)
```sql
CREATE TABLE IF NOT EXISTS wettelijke_bron (
    bron_id VARCHAR(100) PRIMARY KEY, -- bijv. BWBR-nummer
    titel TEXT,
    afkorting TEXT,
    jurisdictie VARCHAR(50),
    uri VARCHAR(500),
    actief BOOLEAN NOT NULL DEFAULT TRUE,
    aangemaakt_op TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    bijgewerkt_op TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Eventueel FK vanuit definitie_wettelijke_basis (niet verplicht in fase 1)
-- ALTER TABLE definitie_wettelijke_basis ADD COLUMN bron_id VARCHAR(100);
-- en zorg dat bron_id (optioneel) verwijst naar wettelijke_bron(bron_id)
```

### Migratie (backfill)
Stap 1: DDL uitvoeren (fase 1)
- Voeg tabel + indexen + trigger toe.

Stap 2: Backfill uit JSON kolom
- Voor elk record in `definities` met `wettelijke_basis` (JSON array):
  - Parse lijst van strings; maak per item een verwijzingsrecord in `definitie_wettelijke_basis` met `citeerstring = item` en `herkomst = 'migratie:json'`.
  - Laat overige velden NULL; verrijking volgt in latere epics.

Stap 3: Consistentie
- Laat `definities.wettelijke_basis` voorlopig staan (compatibiliteit/preview/cache).
- (Optioneel) maak een periodic task (niet in deze US) om verwijzingen ↔ JSON te synchroniseren tijdens transitie.

### Repository‑API (voorstel, DB‑laag)
Bestand: `src/database/definitie_repository.py` (of aparte module `wettelijke_basis_repository.py`)

Dataclass (concept):
```python
@dataclass
class WettelijkeVerwijzing:
    id: int | None
    definitie_id: int
    citeerstring: str
    bron_type: str | None = None
    bron_id: str | None = None
    artikel: str | None = None
    lid: str | None = None
    onderdeel: str | None = None
    jurisdictie: str | None = None
    uri: str | None = None
    herkomst: str | None = None
    actief: bool = True
    aangemaakt_op: datetime | None = None
    bijgewerkt_op: datetime | None = None
```

Methodes (signatures, geen implementatie in deze US):
- `list_wettelijke_basis(definitie_id: int) -> list[WettelijkeVerwijzing]`
- `add_wettelijke_basis(definitie_id: int, verwijzingen: list[WettelijkeVerwijzing]) -> list[int]`
- `update_wettelijke_basis_delta(definitie_id: int, nieuwe: list[WettelijkeVerwijzing]) -> dict`
  - Voert diffs uit op basis van (citeerstring, artikel, lid, onderdeel) om ruis te voorkomen.
- `delete_wettelijke_basis_for_definition(definitie_id: int) -> int`

### UI‑implicaties (US‑064)
- Edit Interface toont een sectie “Wettelijke basis (gestructureerd)” met rijen:
  - Velden: citeerstring (verplicht), evt. bron_id, artikel, lid, onderdeel, jurisdictie, uri.
  - Acties: toevoegen/verwijderen, validatie (basis inputcontrole), opslaan als concept.
- Bij opslaan: roep delta‑API aan; JSON‑kolom kan als preview/cache blijven.

## Acceptatiecriteria
- [ ] Tabel `definitie_wettelijke_basis` bestaat met indexen en update‑trigger.
- [ ] Backfill script (of migratiestap) zet bestaande JSON‑waarden om naar verwijzingsrecords (best effort, zonder verlies van data in JSON‑kolom).
- [ ] Repo‑contract gedefinieerd (signatures en dataclass) voor CRUD + delta‑updates.
- [ ] Links en verwijzingen in dit document werken (EPIC, US‑064, US‑069, bronbestanden).

## Teststrategie (concept)
- Migratie: op een kopie van de DB met `wettelijke_basis` JSON‑data — controleer aantal records in `definitie_wettelijke_basis` en steekproeven op inhoud (citeerstring + definitie_id).
- Integratie (na implementatie in andere US’en): UI → repo delta‑update → DB records; JSON‑kolom blijft consistent of wordt later gesynchroniseerd.

## Risico’s en mitigatie
- Onvolledige parsing van vrije citeerstrings — mitigatie: bewaar altijd raw `citeerstring`; normalisatie kan later.
- Extra complexiteit bij dubbele opslag (JSON + tabel) — mitigatie: overgangsperiode beperken; plan voor synchronisatie/opschoning.
- Query‑prestaties — mitigatie: indexen voorzien; FTS5/verdere indexen pas toevoegen bij bewezen noodzaak.

## Referenties
- Schema: `src/database/schema.sql`
- Migratie: `src/database/migrate_database.py`
- Gerelateerd: [US‑064](../US-064/US-064.md), [US‑153](../US-153/US-153.md), [EPIC‑004](../EPIC-004.md)
