---
id: US-058
epic: EPIC-010
titel: Implement Comprehensive Audit Trail for Context Operations
type: feature
status: open
priority: critical
story_points: 8
sprint: sprint-36
created: 2025-09-09
updated: 2025-09-09
owner: developer-implementer
applies_to: definitie-app@v1.1
canonical: false
last_verified: 2025-09-09
dependencies: [US-056]
assigned_to: security-team
---

# US-058: Implement Comprehensive Audit Trail for Context Operations

## Gebruikersverhaal
**Als een** compliance officer
**wil ik** een volledig audit trail voor alle context operaties
**zodat** ik kan aantonen dat het systeem voldoet aan ASTRA/NORA/AVG vereisten en forensisch onderzoek mogelijk is

## Context
Het huidige systeem heeft geen audit trail voor context operaties, wat een kritieke ASTRA/NORA compliance overtreding is. Voor justice sector systemen is volledige traceerbaarheid een wettelijke vereiste met 7 jaar bewaartermijn.

## Acceptatiecriteria

### SMART Acceptatiecriteria

- **Specifiek:** Elk context operatie wordt gelogd met volledige metadata
- **Meetbaar:**
  - 100% van context operaties geaudit
  - 0 audit gaps in compliance rapport
  - Query response < 500ms voor audit trails
- **Acceptabel:** Voldoet aan justice sector audit requirements
- **Relevant:** Elimineert €20M AVG compliance risico
- **Tijdgebonden:** Implementatie binnen 3 dagen

### Criterion 1: Audit Event Capture
**Gegeven** een gebruiker voert een context operatie uit
**Wanneer** de operatie plaatsvindt
**Dan** wordt een audit event gecreëerd met:
- Unique event ID (UUID)
- Timestamp (ISO 8601 met timezone)
- User identifier (gehashed voor privacy)
- Organization identifier
- Operation type (CREATE, UPDATE, DELETE, VIEW)
- Previous value (volledig)
- New value (volledig)
- IP address (geanonimiseerd)
- Session ID
- Correlation ID (voor gekoppelde events)

### Criterion 2: Immutable Storage
**Gegeven** een audit event is gecreëerd
**Wanneer** het opgeslagen wordt
**Dan** wordt het opgeslagen in een immutable audit log
**En** kan het niet gewijzigd worden
**En** kan het niet verwijderd worden (alleen via retention policy)
**En** wordt een cryptografische hash gecreëerd voor integriteit

### Criterion 3: Query Capabilities
**Gegeven** een auditor wil audit trails onderzoeken
**Wanneer** zij een query uitvoeren
**Dan** kunnen ze zoeken op:
- Tijdsperiode
- Gebruiker
- Organisatie
- Operation type
- Context type
- Correlation ID
**En** krijgen ze resultaten binnen 500ms
**En** kunnen ze exporteren naar CSV/JSON

### Criterion 4: Compliance Reporting
**Gegeven** een compliance audit wordt uitgevoerd
**Wanneer** rapporten gegenereerd worden
**Dan** bevatten deze:
- Volledigheid metrics (coverage percentage)
- Anomalie detectie (unusual patterns)
- User activity summaries
- Context usage statistics
- Data lineage voor specifieke waarden
**En** voldoen aan ASTRA/NORA/AVG format requirements

### Criterion 5: Privacy Protection
**Gegeven** audit logs bevatten mogelijk gevoelige informatie
**Wanneer** data opgeslagen wordt
**Dan** wordt:
- PII data gehashed of gepseudonimiseerd
- IP adressen geanonimiseerd (laatste octet)
- Geen wachtwoorden of auth tokens gelogd
- Encryption at rest toegepast
- Access control geïmplementeerd

## Technische Notities

### Audit Service Implementation
```python
from dataclasses import dataclass
from datetime import datetime
from typing import Optional, Dict, Any
import hashlib
import json

@dataclass
class AuditEvent:
    """Immutable audit event"""
    event_id: str
    timestamp: datetime
    user_id_hash: str
    organization: str
    operation: str
    entity_type: str
    entity_id: str
    previous_value: Optional[Dict[str, Any]]
    new_value: Optional[Dict[str, Any]]
    ip_address_anon: str
    session_id: str
    correlation_id: str
    metadata: Dict[str, Any]

    def calculate_hash(self) -> str:
        """Calculate cryptographic hash for integrity"""
        content = json.dumps({
            'event_id': self.event_id,
            'timestamp': self.timestamp.isoformat(),
            'operation': self.operation,
            'previous': self.previous_value,
            'new': self.new_value
        }, sort_keys=True)
        return hashlib.sha256(content.encode()).hexdigest()

class AuditService:
    """Centralized audit service for ASTRA compliance"""

    def audit_context_operation(
        self,
        operation: str,
        context_type: str,
        previous_value: Optional[Any],
        new_value: Optional[Any],
        user: str,
        metadata: Dict[str, Any] = None
    ) -> str:
        """Audit a context operation"""
        event = AuditEvent(
            event_id=str(uuid4()),
            timestamp=datetime.now(timezone.utc),
            user_id_hash=self._hash_user_id(user),
            organization=self._get_user_organization(user),
            operation=operation,
            entity_type=f"context.{context_type}",
            entity_id=context_type,
            previous_value=previous_value,
            new_value=new_value,
            ip_address_anon=self._anonymize_ip(request.remote_addr),
            session_id=self._get_session_id(),
            correlation_id=self._get_correlation_id(),
            metadata=metadata or {}
        )

        # Store immutably
        self._store_audit_event(event)

        # Real-time compliance check
        self._check_compliance_rules(event)

        return event.event_id
```

### Database Schema
```sql
-- Immutable audit log table
CREATE TABLE audit_log (
    event_id UUID PRIMARY KEY,
    timestamp TIMESTAMPTZ NOT NULL,
    user_id_hash VARCHAR(64) NOT NULL,
    organization VARCHAR(100) NOT NULL,
    operation VARCHAR(20) NOT NULL,
    entity_type VARCHAR(100) NOT NULL,
    entity_id VARCHAR(200),
    previous_value JSONB,
    new_value JSONB,
    ip_address_anon VARCHAR(45),
    session_id VARCHAR(100),
    correlation_id UUID,
    metadata JSONB,
    integrity_hash VARCHAR(64) NOT NULL,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- Indexes for query performance
CREATE INDEX idx_audit_timestamp ON audit_log(timestamp DESC);
CREATE INDEX idx_audit_user ON audit_log(user_id_hash, timestamp DESC);
CREATE INDEX idx_audit_org ON audit_log(organization, timestamp DESC);
CREATE INDEX idx_audit_operation ON audit_log(operation, timestamp DESC);
CREATE INDEX idx_audit_correlation ON audit_log(correlation_id);

-- Prevent updates and deletes (immutability)
CREATE TRIGGER enforce_audit_immutability
BEFORE UPDATE OR DELETE ON audit_log
FOR EACH ROW EXECUTE FUNCTION raise_exception('Audit logs are immutable');

-- Partitioning for performance (monthly)
CREATE TABLE audit_log_2025_09 PARTITION OF audit_log
FOR VALUES FROM ('2025-09-01') TO ('2025-10-01');
```

### Integration Points
```python
# In ContextManager
class ContextManager:
    def set_context(self, context_data, source, actor):
        previous = self.get_context()

        # Audit before change
        self.audit_service.audit_context_operation(
            operation="UPDATE",
            context_type="full_context",
            previous_value=previous.to_dict() if previous else None,
            new_value=context_data,
            user=actor,
            metadata={"source": source.value}
        )

        # Perform operation
        self._context = ContextData.from_dict(context_data)
```

## Domain Requirements

### ASTRA Requirements
- **Traceability:** Complete audit trail van bron tot gebruik
- **Non-repudiation:** Cryptografische integriteit waarborging
- **Accountability:** Alle acties herleidbaar naar gebruiker
- **Transparency:** Audit logs beschikbaar voor compliance

### NORA Standards
- **Logging standaard:** NEN-ISO/IEC 27002:2017
- **Timestamp format:** ISO 8601 met timezone
- **Retention:** Minimaal 7 jaar voor justice sector
- **Export formats:** Open standaarden (CSV, JSON, XML)

### Justice Sector Specifics
- **Bewaartermijn:** 7 jaar voor strafrechtelijke context
- **Integriteit:** Hashchain voor forensisch bewijs
- **Toegang:** Role-based met 4-ogen principe voor gevoelige data
- **Rapportage:** Maandelijkse compliance rapporten

## Test Coverage Requirements

### Unit Tests
```python
def test_audit_event_creation():
    """Verify audit events contain all required fields"""

def test_immutability():
    """Verify audit logs cannot be modified"""

def test_hash_integrity():
    """Verify cryptographic hash calculation"""

def test_privacy_protection():
    """Verify PII is properly anonymized"""
```

### Integration Tests
```python
def test_context_operations_audited():
    """Verify all context operations create audit events"""

def test_audit_query_performance():
    """Verify query response times < 500ms"""

def test_compliance_report_generation():
    """Verify reports meet compliance requirements"""
```

### Compliance Tests
```python
def test_astra_compliance():
    """Verify ASTRA traceability requirements"""

def test_nora_compliance():
    """Verify NORA logging standards"""

def test_avg_compliance():
    """Verify GDPR privacy requirements"""
```

## Definition of Done

- [ ] Audit service geïmplementeerd
- [ ] Alle context operaties creëren audit events
- [ ] Immutable storage geconfigureerd
- [ ] Database schema en triggers geïmplementeerd
- [ ] Query interface gebouwd
- [ ] Compliance rapportage functionaliteit
- [ ] Privacy bescherming geïmplementeerd
- [ ] Integriteit hashing werkend
- [ ] Unit tests >95% coverage
- [ ] Integration tests passed
- [ ] Performance benchmarks gehaald
- [ ] Security review completed
- [ ] Compliance review goedgekeurd
- [ ] Documentatie compleet
- [ ] Monitoring alerts configured

## Afhankelijkheden
- **US-056:** Unified state management moet geïmplementeerd zijn
- Database moet audit log tables ondersteunen
- Time synchronization (NTP) moet geconfigureerd zijn
- Backup strategie voor 7 jaar retention

## Risico's en Mitigaties

| Risico | Kans | Impact | Mitigatie |
|--------|------|--------|-----------|
| Performance impact | Medium | Medium | Async logging + partitioning |
| Storage growth | Hoog | Medium | Partitioning + archival strategy |
| Privacy violations | Laag | Kritiek | Anonymization + encryption |
| Data loss | Laag | Kritiek | Replication + backup |

## Notities
- Consider event streaming (Kafka) voor high-volume scenarios
- Implement audit log analysis dashboard voor security team
- Plan voor quarterly audit reviews
- Coordinate met legal voor retention policy details

---

**Story Status:** Ready for Development
**Estimated Effort:** 8 story points
**Business Value:** Eliminates €20M compliance risk, enables forensic investigation
