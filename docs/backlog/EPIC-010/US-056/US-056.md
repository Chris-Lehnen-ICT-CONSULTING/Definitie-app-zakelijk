---
id: US-056
epic: EPIC-010
titel: "US-056: titel: Remove Legacy Session State Management System"
type: technical_debt
status: open
priority: critical
story_points: 13
sprint: sprint-36
created: 2025-09-09
updated: 2025-09-09
owner: developer-implementer
applies_to: definitie-app@v1.1
canonical: false
last_verified: 2025-09-09
dependencies: []
assigned_to: development-team
---

# US-056: Remove Legacy Session State Management System

## Gebruikersverhaal
**Als een** systeem architect
**wil ik** dat het legacy session state management systeem volledig verwijderd wordt
**zodat** er geen conflicten meer zijn tussen dual state systems en de applicatie stabiel functioneert

## Context
Het huidige systeem heeft twee conflicterende state management systemen die tegelijkertijd opereren. Het legacy systeem in `tabbed_interface.py` conflicteert met het moderne ContextManager systeem, wat leidt tot race conditions, data corruptie, en de "Anders..." optie crash.

## Acceptatiecriteria

### SMART Acceptatiecriteria

- **Specifiek:** Alle directe session state manipulatie uit UI componenten verwijderen
- **Meetbaar:**
  - 0 directe `st.session_state` aanroepen in UI layer
  - 100% state operaties via ContextManager
  - 0 "Anders..." optie crashes
- **Acceptabel:** Backward compatibility behouden voor bestaande data
- **Relevant:** Elimineert root cause van state conflicts
- **Tijdgebonden:** Compleet binnen Sprint 36 (5 dagen)

### Criterion 1: Legacy Code Verwijdering
**Gegeven** het legacy session state systeem bestaat in `tabbed_interface.py`
**Wanneer** de refactoring compleet is
**Dan** zijn alle directe session state manipulaties verwijderd uit:
- Lines 641-662: `_cleanup_context_session_state()`
- Lines 678-790: Fallback implementatie
- Alle `st.session_state.org_context_values` references
- Alle `st.session_state.jur_context_values` references
- Alle `st.session_state.wet_basis_values` references

### Criterion 2: ContextManager Adoptie
**Gegeven** ContextManager is de goedgekeurde state management oplossing
**Wanneer** UI componenten context data nodig hebben
**Dan** gebruiken ze uitsluitend:
```python
from services.context.context_manager import get_context_manager
context_manager = get_context_manager()
context_data = context_manager.get_context()
```

### Criterion 3: Geen Hardcoded Test Data
**Gegeven** hardcoded test waardes vervuilen de productie code
**Wanneer** de cleanup compleet is
**Dan** zijn deze waardes volledig verwijderd:
- `["test", "testen", "rest"]`
- `["auto", "cargo", "inbraak"]`
- Alle andere hardcoded context waardes

### Criterion 4: Feature Flag Protection
**Gegeven** we moeten een veilige rollout garanderen
**Wanneer** de nieuwe implementatie deployed wordt
**Dan** is het beschermd door feature flags:
```python
if feature_flags.is_enabled("unified_state_management"):
    return self._use_context_manager()
else:
    return self._use_legacy_with_warning()
```

### Criterion 5: Audit Trail
**Gegeven** ASTRA compliance vereist volledige traceerbaarheid
**Wanneer** context operaties uitgevoerd worden
**Dan** wordt elke operatie gelogd met:
- Timestamp
- User identifier
- Operation type
- Previous value
- New value
- Correlation ID

## Technische Notities

### Bestanden om te Wijzigen
1. **src/ui/tabbed_interface.py**
   - Verwijder `_cleanup_context_session_state()` methode
   - Verwijder legacy fallback in `_render_simplified_context_selector()`
   - Vervang met ContextManager calls

2. **src/ui/components/context_selector.py**
   - Deprecate volledig (legacy component)
   - Redirect naar enhanced_context_manager_selector

3. **src/services/container.py**
   - Ensure ContextManager is singleton
   - Add proper initialization

### Migration Strategy
```python
class StateManagementMigrator:
    """Handles migration from legacy to unified state"""

    def migrate_session_state(self):
        """One-time migration of existing session state"""
        legacy_keys = [
            "org_context_values",
            "jur_context_values",
            "wet_basis_values"
        ]

        for key in legacy_keys:
            if key in st.session_state:
                # Migrate to ContextManager
                self._migrate_to_context_manager(key, st.session_state[key])
                # Remove from session state
                del st.session_state[key]
```

### Monitoring Requirements
- Track state conflict occurrences (target: 0)
- Monitor "Anders..." option success rate (target: 100%)
- Log migration completions
- Alert on any legacy state access attempts

## Domain Requirements

### ASTRA Compliance
- **Layered Architecture:** UI layer mag geen business logic bevatten
- **Service Orientation:** State management via service layer
- **Component Independence:** Geen tight coupling tussen UI en state

### NORA Standards
- **Traceability:** Alle state changes moeten geaudit worden
- **Transparency:** User moet kunnen zien welke context gebruikt wordt
- **Standardization:** Gebruik standaard patterns voor state management

### Justice Chain Specifics
- Context moet uitwisselbaar zijn met ketenpartners
- Audit trail moet 7 jaar bewaard blijven
- Geen persoonlijke data in state (AVG/GDPR)

## Test Coverage Requirements

### Unit Tests
```python
def test_no_direct_session_state_access():
    """Verify UI components don't access session state directly"""

def test_context_manager_singleton():
    """Ensure only one ContextManager instance exists"""

def test_legacy_data_migration():
    """Verify existing data migrates correctly"""

def test_feature_flag_protection():
    """Ensure feature flags work correctly"""
```

### Integration Tests
```python
def test_ui_context_manager_integration():
    """Full flow from UI to ContextManager"""

def test_anders_option_with_unified_state():
    """Verify Anders... option works without crashes"""
```

### Performance Tests
- State operations < 50ms
- No memory leaks during state transitions
- Concurrent access handling

## Definition of Done

- [ ] Alle legacy session state code verwijderd
- [ ] ContextManager volledig geïntegreerd
- [ ] Feature flags geïmplementeerd en getest
- [ ] Audit trail functioneert voor alle operaties
- [ ] Unit tests geschreven (>90% coverage)
- [ ] Integration tests passed
- [ ] Performance benchmarks gehaald
- [ ] Code review door architect goedgekeurd
- [ ] Security review completed
- [ ] Documentation updated
- [ ] Migration script getest
- [ ] Rollback plan gedocumenteerd
- [ ] Monitoring alerts configured
- [ ] ASTRA/NORA compliance geverifieerd

## Afhankelijkheden
- ContextManager service moet operationeel zijn
- Feature flag framework moet geïmplementeerd zijn
- Audit service moet beschikbaar zijn

## Risico's en Mitigaties

| Risico | Kans | Impact | Mitigatie |
|--------|------|--------|-----------|
| Data verlies tijdens migratie | Laag | Hoog | Backup + parallel operation |
| Gebruikers ervaren breaking changes | Medium | Medium | Feature flags + communication |
| Performance degradatie | Laag | Medium | Benchmarking + optimization |
| Incomplete migratie | Laag | Hoog | Automated validation checks |

## Notities
- Dit is een kritieke refactoring die de root cause van de "Anders..." bug oplost
- Moet zeer voorzichtig uitgevoerd worden met adequate testing
- Coördinatie met DevOps team vereist voor production rollout
- Consider paired programming voor kritieke secties

---

**Story Status:** Ready for Development
**Estimated Effort:** 13 story points (1 sprint)
**Business Value:** Elimineert kritieke bugs en compliance issues
