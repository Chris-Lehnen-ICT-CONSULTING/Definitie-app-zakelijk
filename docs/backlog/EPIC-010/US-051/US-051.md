---
id: US-051
epic: EPIC-010
titel: "US-051: titel: Fix CFR-BUG-014 Synoniemen/Antoniemen Generatie"
type: bug-fix
status: proposed
prioriteit: KRITIEK
story_points: 5
sprint: sprint-37
aangemaakt: 2025-09-10
bijgewerkt: 2025-09-10
owner: developer-implementer
applies_to: definitie-app@current
canonical: false
last_verified: 2025-09-10
vereisten:
  - REQ-020
  - REQ-033
toegewezen_aan: development-team
Afhankelijkheden:
  - US-041
  - US-043
---

# US-051: Fix CFR-BUG-014 Synoniemen/Antoniemen Generatie

**Epic:** EPIC-010 - Context Flow Refactoring
**Bug Report:** CFR-BUG-014

## Gebruikersverhaal

**Als een** juridisch professional in de Nederlandse justitieketen
**wil ik** dat synoniemen en antoniemen consistent het juiste aantal items genereren
**zodat** ik betrouwbare en complete juridische definities kan maken met alle gerelateerde termen

## Probleembeschrijving

Het systeem genereert inconsistent 2-3 synoniemen/antoniemen terwijl er 5 gevraagd worden. Daarnaast worden items met bullets ("• ") weergegeven wat niet consistent is met andere lijsten in de applicatie.

### Root Causes
1. **Prompts te simpel**: Geen definitie/context meegegeven aan AI
2. **Parser te rigid**: Verwacht alleen newline-separated, geen komma fallback
3. **Geen retry logic**: Bij te weinig items geen tweede poging
4. **UI inconsistentie**: Bullets voor synoniemen/antoniemen

## Acceptatiecriteria

### Functionele Criteria
- [ ] Synoniemen prompts bevatten definitie + context
- [ ] Antoniemen prompts bevatten definitie + context
- [ ] Parser ondersteunt zowel newline als komma-gescheiden items
- [ ] Retry logic: max 1 retry bij te weinig items
- [ ] Op laatste poging: accepteer wat er is (voorkom infinite loops)
- [ ] UI toont synoniemen/antoniemen ZONDER bullets
- [ ] Andere voorbeeldtypes behouden bullets

### Technische Criteria
- [ ] `unified_voorbeelden.py` aangepast met verbeterde prompts
- [ ] `_parse_response()` methode met komma-fallback
- [ ] `_generate_with_retry()` methode met max 1 retry
- [ ] UI rendering logic aangepast voor type-specifieke formatting
- [ ] max_tokens consistent (2000) voor sync en async

### Performance Criteria
- [ ] Generatie tijd < 5 seconden per type
- [ ] Retry voegt max 3 seconden toe
- [ ] Minimaal 3 items gegenereerd (acceptabel minimum)
- [ ] Ideaal 5 items gegenereerd (target)

## Implementatie Details

### 1. Prompt Verbetering
```python
# In unified_voorbeelden.py
if request.example_type == ExampleType.SYNONIEMEN:
    return f"""Voor het begrip '{begrip}' met de volgende definitie:
{definitie}

Context: {context_text if context_text else 'Algemeen juridisch'}

Geef EXACT {request.max_examples} synoniemen of verwante termen.
BELANGRIJK:
- PRECIES {request.max_examples} items, niet meer en niet minder
- Één synoniem per regel
- GEEN nummering, bullets, streepjes of andere formatting
- Als er geen {request.max_examples} perfecte synoniemen zijn, gebruik verwante termen"""
```

### 2. Parser met Fallback
```python
def _parse_response(self, text: str, example_type: ExampleType) -> list[str]:
    """Enhanced parser met fallback voor verschillende formaten."""
    text = text.strip()

    # Primary: nieuwe regels
    lines = [line.strip() for line in text.split('\n') if line.strip()]

    # Clean prefixes
    cleaned = []
    for line in lines:
        line = re.sub(r'^\d+[\.\)]\s*', '', line)  # Remove numbers
        line = re.sub(r'^[-•*]\s*', '', line)      # Remove bullets
        if line:
            cleaned.append(line)

    # Fallback: komma-gescheiden
    if len(cleaned) < 3 and ',' in text:
        items = [item.strip() for item in text.split(',')]
        if len(items) > len(cleaned):
            cleaned = items

    return cleaned
```

### 3. Retry Logic
```python
async def _generate_with_retry(self, request: ExampleRequest, max_retries: int = 1):
    """Generate met 1 retry bij incorrect aantal."""
    for attempt in range(max_retries + 1):
        result = await self._generate_async(request)

        if request.example_type in [ExampleType.SYNONIEMEN, ExampleType.ANTONIEMEN]:
            expected = request.max_examples

            if len(result) > expected:
                return result[:expected]  # Trim excess

            if len(result) >= expected or attempt == max_retries:
                if len(result) < expected:
                    logger.warning(f"Accepting {len(result)}/{expected} items after {attempt+1} attempts")
                return result

            # Enhance prompt voor retry
            request.extra_instruction = f"Je gaf {len(result)} items, maar er zijn EXACT {expected} nodig."

    return result
```

### 4. UI Display Fix
```python
# In UI rendering
if example_type in ["synoniemen", "antoniemen"]:
    for item in examples:
        st.write(item)  # Zonder bullet
else:
    for item in examples:
        st.write(f"• {item}")  # Met bullet
```

## Test Scenarios

### Unit Tests
1. Test prompt generatie met definitie/context
2. Test parser met newline-separated input
3. Test parser met comma-separated fallback
4. Test retry logic bij te weinig items
5. Test trim logic bij te veel items
6. Test UI rendering zonder bullets

### Integration Tests
1. End-to-end synoniemen generatie
2. End-to-end antoniemen generatie
3. Performance test met retry
4. Edge case: zeldzame termen met <5 synoniemen

## Verificatie

```bash
# Test synoniemen/antoniemen generatie
python -c "
from src.voorbeelden.unified_voorbeelden import UnifiedVoorbeeldenService
from src.voorbeelden.interfaces import ExampleRequest, ExampleType

service = UnifiedVoorbeeldenService()
for etype in [ExampleType.SYNONIEMEN, ExampleType.ANTONIEMEN]:
    req = ExampleRequest(
        begrip='contract',
        definitie='Een juridische overeenkomst tussen partijen',
        context_dict={'organisatie': 'Rechtbank'},
        example_type=etype,
        max_examples=5
    )
    result = service.generate(req)
    print(f'{etype}: {len(result.examples)} items - {result.examples}')
    assert len(result.examples) >= 3, f'Minimum 3 items vereist, kreeg {len(result.examples)}'
"
```

## Definition of Done

- [ ] Code complete met alle acceptatiecriteria
- [ ] Unit tests geschreven en groen
- [ ] Integration tests groen
- [ ] Verificatie script succesvol
- [ ] Code review completed
- [ ] UI test: synoniemen/antoniemen zonder bullets
- [ ] Performance binnen targets
- [ ] Documentatie bijgewerkt

## Risico's

| Risico | Impact | Mitigatie |
|--------|--------|-----------|
| AI geeft consistent <5 items | Medium | Accepteer minimum 3, log warning |
| Retry vertraagt UX | Low | Max 1 retry, timeout 3s |
| Parser mist edge cases | Low | Uitgebreide unit tests |

## Notes

- Deze fix is KRITIEK voor Sprint 37
- Directe refactor aanpak: geen backwards compatibility nodig
- Test vooral met zeldzame juridische termen
