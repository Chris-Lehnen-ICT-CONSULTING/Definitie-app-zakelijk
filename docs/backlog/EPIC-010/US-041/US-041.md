---
Afhankelijkheden:
- CFR-BUG-003
aangemaakt: 04-09-2025
applies_to: definitie-app@current
bijgewerkt: 08-09-2025
bug_id: CFR-BUG-001
canonical: true
epic: EPIC-010
id: US-041
last_verified: 08-09-2025
owner: developer-implementer
prioriteit: KRITIEK
sprint: sprint-36
status: Nog te bepalen
story_points: 8
titel: Fix Context Field Mapping to Prompts
toegewezen_aan: development-team
type: bug
implementation_plan: docs/implementation/EPIC-010-implementation-plan.md#fase-3
related_bugs:
- CFR-BUG-001
- CFR-BUG-003
---



# US-041: Fix Context Field Mapping to Prompts

**Episch Verhaal:** EPIC-001

## ðŸš¨ KRITIEK BUG

**Context fields (juridische_context, wettelijke_basis, organisatorische_context) are NOT being passed to AI prompts, resulting in non-compliant definitions.**

## Gebruikersverhaal

**As a** legal professional
**wil ik** all three context types included in my definition prompts
**zodat** generated definitions have complete legal en organizational context

## Acceptatiecriteria


### SMART Acceptatiecriteria

- **Specifiek:** [Exact gedrag dat moet worden gerealiseerd]
- **Meetbaar:**
  - Response tijd: < 200ms voor UI acties
  - Processing tijd: < 5 seconden voor generatie
  - Success rate: > 95% voor validaties
- **Acceptabel:** Haalbaar binnen huidige architectuur
- **Relevant:** Direct gerelateerd aan gebruikersbehoefte
- **Tijdgebonden:** Gerealiseerd binnen huidige sprint


### Criterion 1: Organisatorische Context
**gegeven** a user selects organisatorische_context values in the UI
**wanneer** the definition is generated
**dan** the organisatorische_context appears in the AI prompt

### Criterion 2: Juridische Context
**gegeven** a user selects juridische_context values in the UI
**wanneer** the definition is generated
**dan** the juridische_context appears in the AI prompt

### Criterion 3: Wettelijke Basis
**gegeven** a user selects wettelijke_basis values in the UI
**wanneer** the definition is generated
**dan** the wettelijke_basis appears in the AI prompt

### Criterion 4: Debug Visibility
**gegeven** all three context types are selected
**wanneer** viewing the debug prompt
**dan** all context values are visible in the constructed prompt

### Criterion 5: Logging
**gegeven** context values are passed to the prompt
**wanneer** the prompt is logged
**dan** context appears in the structured sections of the prompt

## Domain vereisten

### ASTRA vereisten
- All justice definitions MUST include organizational context
- Context terminology MUST match Justid stEnards

### NORA compliance
- Legal basis MUST be traceable to specific laws
- Juridical context MUST align with Dutch legal system categories

### Privacy & beveiliging
- No sensitive case data in context fields
- Context fields must not contain PII
- Context should add < 100 tokens to prompt

## Root Cause Analysis

The `_convert_request_to_context` method in `prompt_service_v2.py` creates `base_context` Maar doesn't properly extract en map the UI context fields from the request object.

### Current Code Issue
```python
# Line 158-176 in prompt_service_v2.py
def _convert_request_to_context(self, request):
    base_context = {
        'juridische_context': [],  # NOT MAPPED FROM REQUEST
        'wettelijke_basis': [],    # NOT MAPPED FROM REQUEST
        'organisatorische_context': []  # NOT MAPPED FROM REQUEST
    }
```

## Technische Notities

### Affected Components
- `src/services/prompts/prompt_service_v2.py` (lines 158-176)
- `src/ui/tabbed_interface.py` (context collection)
- `src/services/definition_generator_context.py`
- `src/services/interfaces.py` (GenerationRequest)

### Key Functions to Fix
- `PromptServiceV2._convert_request_to_context()`
- `TabbedInterface._hEnle_definition_generation()`
- `EnrichedContext` initialization

### Fix Implementatie
```python
def _convert_request_to_context(self, request):
    """Properly extract context from request"""
    base_context = {
        'juridische_context': request.juridische_context or [],
        'wettelijke_basis': request.wettelijke_basis or [],
        'organisatorische_context': request.organisatorische_context or []
    }
    return base_context
```

## testdekking vereisten

### Unit Tests
- Test context extraction from request
- Test empty context hEnling
- Test context type validatie
- Test prompt inclusion

### Integration Tests
- UI to prompt flag
- All context combinations
- Debug output verification

### Test Scenario's
1. All three context types populated
2. Single context type only
3. No context selected
4. Mixed empty en populated

## Test Files

### Primary Test Suite
- **`tests/unit/test_us041_context_field_mapping.py`** (250+ test cases)
  - Context field type validation
  - PromptServiceV2 integration tests
  - Context propagation flow validation
  - Justice domain-specific scenarios
  - ASTRA compliance basics
  - Edge cases and error conditions

### Supporting Test Files
- **`tests/integration/test_context_flow_epic_cfr.py`**
  - End-to-end context flow testing
  - Integration with all three user stories
  - Context audit trail validation

- **`tests/unit/test_anders_edge_cases.py`**
  - Extreme input scenarios
  - Security validation (XSS, SQL injection prevention)
  - Unicode and encoding edge cases

### Test Execution Commands
```bash
# Run US-041 specific unit tests
pytest tests/unit/test_us041_context_field_mapping.py -v

# Run integration tests for context flow
pytest tests/integration/test_context_flow_epic_cfr.py::TestContextFlowIntegration -v

# Run with coverage report
pytest tests/unit/test_us041_context_field_mapping.py --cov=src.services.prompts --cov-report=html

# Quick smoke test
pytest tests/unit/test_us041_context_field_mapping.py -k "test_basic" -v
```

### Expected Test Outcomes
- **Before Fix**: All tests should FAIL (context not propagated)
- **After Fix**: 100% pass rate for context mapping tests
- **Performance**: Context processing < 50ms
- **Coverage**: >95% for modified code

## Definitie van Gereed

- [ ] Context properly extracted from request
- [ ] All three context types mapped correctly
- [ ] Context visible in generated prompts
- [ ] Unit tests written en passing
- [ ] Integration tests passing
- [ ] Debug logging shows context
- [ ] Code review Voltooid
- [ ] Deployed to test environment
- [ ] User validatie successful

## Bug Report Details

### Steps to Reproduce
1. Open Definition Generator
2. Enter term: "voorlopige hechtenis"
3. Select values in all context fields
4. Generate definition
5. Check debug prompt output
6. **BUG**: Context fields are empty in prompt

### Expected vs Actual
- **Expected**: Context values in prompt
- **Actual**: Empty context arrays
- **Impact**: Definitions lack legal context

## Risk Assessment

### Business Risk
- **Legal compliance**: HOOG - Definitions not meeting justice stEnards
- **User Trust**: HOOG - System not using provided input
- **Quality**: HOOG - Generic definitions without context

### Technical Risk
- **Complexity**: LAAG - Simple mapping fix
- **Testen**: GEMIDDELD - Need comprehensive tests
- **Regression**: LAAG - Isolated change

## Implementatie Prioriteit

**IMMEDIATE HOTFIX REQUIRED**

This is blocking compliant definition generation en must be fixed before any new features.

## Notes

- Bug discovered: 04-09-2025
- Root cause identified: 04-09-2025
- Fix planned: Sprint 36 (current)
- **Workaround**: None available

## Gerelateerde Documentatie

- EPIC-010

---

*This story is part of EPIC-010: Context FLAAG Refactoring (KRITIEK)*
