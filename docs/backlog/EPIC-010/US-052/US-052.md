---
id: US-052
epic: EPIC-010
titel: "US-052: titel: Orchestrator Async Voorbeelden Migration"
type: technical-debt
status: proposed
prioriteit: HOOG
story_points: 3
sprint: sprint-37
aangemaakt: 2025-09-10
bijgewerkt: 2025-09-10
owner: developer-implementer
applies_to: definitie-app@current
canonical: false
last_verified: 2025-09-10
vereisten:
  - REQ-032
  - REQ-033
toegewezen_aan: development-team
Afhankelijkheden:
  - US-043
  - US-051
---

# US-052: Orchestrator Async Voorbeelden Migration

**Epic:** EPIC-010 - Context Flow Refactoring

## Gebruikersverhaal

**Als een** system architect
**wil ik** dat de orchestrator volledig async werkt zonder sync bridging in de service laag
**zodat** we een clean async architectuur hebben zonder anti-patterns

## Probleembeschrijving

De `DefinitionOrchestratorV2` gebruikt momenteel de synchrone `genereer_alle_voorbeelden()` methode binnen een async flow. Dit veroorzaakt sync bridging in de service laag wat tegen het architectuur principe is dat alleen de UI laag mag bridgen tussen sync en async.

### Current Anti-Pattern
```python
# In definition_orchestrator_v2.py
async def generate_definition(...):
    # FOUT: Sync call in async context
    voorbeelden = self.voorbeelden_service.genereer_alle_voorbeelden(
        begrip, definitie, context_dict
    )
```

### Desired Pattern
```python
# In definition_orchestrator_v2.py
async def generate_definition(...):
    # GOED: Async call in async context
    voorbeelden = await self.voorbeelden_service.genereer_alle_voorbeelden_async(
        begrip, definitie, context_dict
    )
```

## Acceptatiecriteria

### Functionele Criteria
- [ ] Orchestrator gebruikt `genereer_alle_voorbeelden_async()`
- [ ] Alle voorbeelden types worden nog steeds gegenereerd
- [ ] Parallel processing blijft behouden
- [ ] Error handling werkt correct voor async flow

### Technische Criteria
- [ ] Geen `_run_async_safe()` calls in orchestrator
- [ ] Geen `asyncio.run()` in services directory
- [ ] Geen `run_coroutine_threadsafe()` in services
- [ ] Alleen `ui/helpers/async_bridge.py` mag sync/async bridging doen
- [ ] Tests aangepast voor async flow

### Performance Criteria
- [ ] Voorbeelden generatie tijd gelijk of beter
- [ ] Parallel processing werkend
- [ ] Geen deadlocks of race conditions

## Implementatie Details

### 1. Update Orchestrator
```python
# In src/services/orchestrators/definition_orchestrator_v2.py

# Van:
voorbeelden = self.voorbeelden_service.genereer_alle_voorbeelden(
    begrip=begriff,
    definitie=generated_definition,
    context_dict=context_dict,
    max_examples=max_examples
)

# Naar:
voorbeelden = await self.voorbeelden_service.genereer_alle_voorbeelden_async(
    begrip=begriff,
    definitie=generated_definition,
    context_dict=context_dict,
    max_examples=max_examples
)
```

### 2. Verwijder Sync Bridging
```python
# Verwijder uit services:
def _run_async_safe(self, coro):
    """REMOVE THIS - alleen UI mag bridgen"""
    pass

# Vervang alle instances met proper async:
# Van: self._run_async_safe(some_async_method())
# Naar: await some_async_method()
```

### 3. Update Tests
```python
# In tests/services/test_orchestrator_v2.py
@pytest.mark.asyncio
async def test_orchestrator_uses_async_voorbeelden():
    orchestrator = DefinitionOrchestratorV2(...)

    # Mock async voorbeelden service
    mock_voorbeelden = AsyncMock()
    mock_voorbeelden.genereer_alle_voorbeelden_async.return_value = {...}

    result = await orchestrator.generate_definition(...)

    # Verify async method was called
    mock_voorbeelden.genereer_alle_voorbeelden_async.assert_called_once()
```

## Test Scenarios

### Unit Tests
1. Test orchestrator roept async voorbeelden aan
2. Test error handling in async flow
3. Test parallel processing blijft werkend
4. Test timeout handling

### Integration Tests
1. End-to-end definition generation met async voorbeelden
2. Performance test: meet parallel vs sequential
3. Stress test: meerdere concurrent requests

### Verificatie Script
```bash
# Check geen sync bridging in services
echo "=== Checking for sync bridging in services ==="
! rg "_run_async_safe|asyncio\.run" src/services/ || {
    echo "FAIL: Sync bridging gevonden in services"
    exit 1
}

# Check orchestrator gebruikt async
echo "=== Checking orchestrator uses async ==="
rg "await.*genereer_alle_voorbeelden_async" src/services/orchestrators/ || {
    echo "FAIL: Orchestrator gebruikt geen async voorbeelden"
    exit 1
}

echo "SUCCESS: Alle checks passed"
```

## Verificatie

```bash
# 1. Check geen sync patterns in services
rg -n "_run_async_safe|asyncio\.run|run_coroutine_threadsafe" src/services/

# 2. Verify orchestrator uses async
rg -n "genereer_alle_voorbeelden_async" src/services/orchestrators/

# 3. Run tests
pytest tests/services/test_orchestrator_v2.py -v

# 4. Performance check
python -c "
import asyncio
import time
from src.services.orchestrators.definition_orchestrator_v2 import DefinitionOrchestratorV2

async def test_performance():
    orchestrator = DefinitionOrchestratorV2(...)
    start = time.time()
    await orchestrator.generate_definition(...)
    duration = time.time() - start
    print(f'Generation took {duration:.2f}s')
    assert duration < 10, 'Performance degraded'

asyncio.run(test_performance())
"
```

## Definition of Done

- [ ] Code complete met alle acceptatiecriteria
- [ ] Unit tests groen
- [ ] Integration tests groen
- [ ] Geen sync bridging in services directory
- [ ] Verificatie script succesvol
- [ ] Performance gelijk of beter
- [ ] Code review completed
- [ ] Documentatie bijgewerkt

## Risico's

| Risico | Impact | Mitigatie |
|--------|--------|-----------|
| Deadlocks in async flow | High | Uitgebreide async tests |
| Performance degradatie | Medium | Benchmark voor/na |
| Test complexity | Low | Goede async test helpers |

## Notes

- Dit is een pure technical debt story
- Geen functionele wijzigingen voor gebruikers
- Critical voor clean architecture
- Moet voor US-043-C om sync wrappers te kunnen verwijderen
