---
id: US-057
epic: EPIC-010
titel: "US-057: titel: Fix "Anders..." Custom Context Option Functionality"Anders..." Custom Context Option Functionality
type: bug
status: open
priority: critical
story_points: 8
sprint: sprint-36
created: 2025-09-09
updated: 2025-09-09
owner: developer-implementer
applies_to: definitie-app@v1.1
canonical: false
last_verified: 2025-09-09
dependencies: [US-056]
assigned_to: development-team
---

# US-057: Fix "Anders..." Custom Context Option Functionality

## Gebruikersverhaal
**Als een** OM officier van justitie
**wil ik** custom context waarden kunnen invoeren via de "Anders..." optie
**zodat** ik domein-specifieke context kan toevoegen die niet in de voorgedefinieerde lijst staat

## Context
De "Anders..." optie crasht momenteel met de foutmelding "The default value 'test' is not part of the options". Dit verhindert justice professionals om organisatie-specifieke context toe te voegen die essentieel is voor juridisch correcte definities.

## Acceptatiecriteria

### SMART Acceptatiecriteria

- **Specifiek:** "Anders..." optie werkt zonder crashes voor alle drie context velden
- **Meetbaar:**
  - 100% success rate voor custom input
  - 0 crashes bij selecteren "Anders..."
  - Response tijd < 200ms voor custom value toevoeging
- **Acceptabel:** Intuïtieve UX voor justice professionals
- **Relevant:** Kritiek voor domein-specifieke definities
- **Tijdgebonden:** Opgelost binnen 3 dagen

### Criterion 1: Custom Input Interface
**Gegeven** een gebruiker selecteert "Anders..." in een context veld
**Wanneer** de selectie gemaakt is
**Dan** verschijnt er een tekstveld voor custom input
**En** het tekstveld accepteert maximaal 200 karakters
**En** er is een duidelijke placeholder tekst

### Criterion 2: Value Validation & Sanitization
**Gegeven** een gebruiker voert custom tekst in
**Wanneer** de gebruiker de waarde submit
**Dan** wordt de input gevalideerd tegen:
- SQL injection patterns
- XSS attack vectors
- Minimum lengte (3 karakters)
- Maximum lengte (200 karakters)
- Verboden karakters
**En** wordt de input gesanitized voordat opslag

### Criterion 3: Integration with Context Selection
**Gegeven** een gebruiker heeft een custom waarde ingevoerd
**Wanneer** de waarde gevalideerd is
**Dan** wordt de waarde toegevoegd aan de geselecteerde context lijst
**En** verschijnt de waarde in de multiselect widget
**En** blijft de waarde behouden tijdens sessie

### Criterion 4: Persistence & Reusability
**Gegeven** een gebruiker heeft eerder custom waarden ingevoerd
**Wanneer** de gebruiker later terugkeert
**Dan** zijn de custom waarden beschikbaar voor hergebruik
**En** worden ze aangeboden als suggesties
**En** kunnen ze geselecteerd worden zonder opnieuw in te voeren

### Criterion 5: Error Handling
**Gegeven** er treedt een validatie fout op
**Wanneer** de gebruiker ongeldige input probeert
**Dan** wordt een duidelijke Nederlandse foutmelding getoond
**En** blijft de applicatie stabiel
**En** kan de gebruiker de input corrigeren

## Technische Notities

### Implementation Approach
```python
class CustomContextHandler:
    """Handles custom context input via Anders... option"""

    def render_custom_input(self, context_type: str) -> Optional[str]:
        """Render custom input field when Anders... is selected"""
        if "Anders..." in st.session_state.get(f"{context_type}_selected", []):
            custom_value = st.text_input(
                f"Voer aangepaste {context_type} in:",
                max_chars=200,
                key=f"custom_{context_type}_input",
                placeholder="Bijv: 'FIOD - Witwassen' of 'Rechtbank Amsterdam - Strafkamer'"
            )

            if custom_value:
                validated = self.validate_and_sanitize(custom_value)
                if validated:
                    self.add_to_context(context_type, validated)
                    return validated
        return None

    def validate_and_sanitize(self, value: str) -> Optional[str]:
        """Validate and sanitize custom input"""
        # Remove dangerous characters
        sanitized = self.sanitizer.sanitize(
            value,
            level=SanitizationLevel.STRICT
        )

        # Validate against rules
        if len(sanitized) < 3:
            st.error("Waarde moet minimaal 3 karakters bevatten")
            return None

        # Check for injection patterns
        if self.detector.has_injection_risk(sanitized):
            st.error("Ongeldige karakters gedetecteerd")
            return None

        return sanitized
```

### Widget State Management Fix
```python
def fix_multiselect_state(options: List[str], defaults: List[str]) -> List[str]:
    """Ensure defaults are subset of options to prevent crashes"""
    # Filter defaults to only include values that exist in options
    valid_defaults = [d for d in defaults if d in options]

    # Add custom values to options if they exist in defaults
    custom_values = [d for d in defaults if d not in options and d != "Anders..."]
    if custom_values:
        options = options[:-1] + custom_values + ["Anders..."]
        valid_defaults.extend(custom_values)

    return options, valid_defaults
```

### Database Schema for Custom Values
```sql
CREATE TABLE custom_context_values (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    context_type VARCHAR(50) NOT NULL,
    value VARCHAR(200) NOT NULL,
    normalized_value VARCHAR(200) NOT NULL,
    created_by VARCHAR(100) NOT NULL,
    organization VARCHAR(100) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    usage_count INTEGER DEFAULT 0,
    last_used TIMESTAMP,
    status VARCHAR(20) DEFAULT 'active',
    CHECK (context_type IN ('organisatorisch', 'juridisch', 'wettelijk'))
);

CREATE INDEX idx_custom_context_org ON custom_context_values(organization, context_type);
CREATE INDEX idx_custom_context_usage ON custom_context_values(usage_count DESC);
```

## Domain Requirements

### Justice Domain Validation Rules
- Custom organisatie namen moeten valide justice organisaties zijn of daaraan gerelateerd
- Juridische context moet Nederlandse rechtsterminologie gebruiken
- Wettelijke basis moet verwijzen naar bestaande of concept wetgeving
- Geen persoonsnamen of BSN nummers in custom waarden

### Compliance Requirements
- **AVG/GDPR:** Geen PII in custom context waarden
- **ASTRA:** Audit trail voor alle custom waarde creaties
- **NORA:** Gebruik open standaarden voor data opslag
- **BIR:** Input validatie volgens OWASP guidelines

## Test Coverage Requirements

### Unit Tests
```python
def test_anders_option_renders_input_field():
    """Verify input field appears when Anders... selected"""

def test_custom_value_validation():
    """Test all validation rules"""

def test_sql_injection_prevention():
    """Verify SQL injection attempts are blocked"""

def test_xss_prevention():
    """Verify XSS attempts are sanitized"""

def test_custom_value_persistence():
    """Verify custom values are saved correctly"""
```

### Integration Tests
```python
def test_custom_context_in_generation():
    """Verify custom context reaches GPT-4 prompt"""

def test_custom_context_in_export():
    """Verify custom context appears in exports"""

def test_multiselect_with_custom_values():
    """Verify widget doesn't crash with custom values"""
```

### User Acceptance Tests
1. OM gebruiker voegt "Landelijk Parket - Cybercrime" toe
2. DJI gebruiker voegt "PI Vught - TBS Kliniek" toe
3. Rechtbank gebruiker voegt "Rechtbank Noord-Holland - Familie" toe
4. Custom waarden verschijnen in gegenereerde definities
5. Custom waarden zijn herbruikbaar in volgende sessies

## Definition of Done

- [ ] "Anders..." optie werkt zonder crashes
- [ ] Custom input field verschijnt correct
- [ ] Validatie regels geïmplementeerd
- [ ] Sanitization voorkomt security issues
- [ ] Custom waarden worden opgeslagen in database
- [ ] Custom waarden zijn herbruikbaar
- [ ] Audit trail logs alle custom value creaties
- [ ] Unit tests >95% coverage
- [ ] Integration tests passed
- [ ] Security review completed
- [ ] UX review door gebruiker goedgekeurd
- [ ] Performance benchmarks gehaald
- [ ] Documentatie bijgewerkt
- [ ] Rollback plan aanwezig

## Afhankelijkheden
- **US-056:** Legacy state management moet eerst verwijderd zijn
- Database schema moet geüpdatet zijn
- Sanitization service moet beschikbaar zijn
- Audit service moet operationeel zijn

## Risico's en Mitigaties

| Risico | Kans | Impact | Mitigatie |
|--------|------|--------|-----------|
| Security vulnerabilities | Medium | Kritiek | OWASP validation + security review |
| Performance impact | Laag | Medium | Caching + optimization |
| UX verwarring | Medium | Medium | Clear instructions + tooltips |
| Data quality issues | Medium | Laag | Validation + review process |

## Notities
- Focus op gebruiksvriendelijkheid voor justice professionals
- Consider auto-complete/suggestions uit historical data
- Mogelijk future enhancement: AI-suggested custom values
- Coordinate met UX team voor optimale interface

---

**Story Status:** Ready for Development
**Estimated Effort:** 8 story points
**Business Value:** Enables domain-specific context critical for legal definitions
