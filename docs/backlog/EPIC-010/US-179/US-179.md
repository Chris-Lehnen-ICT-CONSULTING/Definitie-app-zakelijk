---
id: US-179
titel: "US-179: - V2‑flow via `PromptServiceV2` + `HybridContextManager` + modulaire promptmodules."
status: active
prioriteit: HOOG
story_points: 5
sprint: next
owner: engineering
applies_to: definitie-app@current
canonical: false
last_verified: 16-09-2025
---

# US-179 — Ontologische categorie doorgeven aan promptmodules en categorie-specifieke instructies toepassen

Doel: Wanneer een gebruiker een begrip + context invult, wordt eerst de ontologische categorie intern bepaald (zonder extra AI‑call), en die categorie wordt vervolgens expliciet gebruikt om de prompt richting het model categorie‑specifiek te maken.

Reikwijdte
- V2‑flow via `PromptServiceV2` + `HybridContextManager` + modulaire promptmodules.
- Geen extra ChatGPT‑call voor categoriebepaling (blijft intern: OntologischeAnalyzer/regels).

Probleem
- In de huidige V2‑flow komt `ontologische_categorie` niet (altijd) terecht in de module‑context; daardoor:
  - `SemanticCategorisationModule` voegt geen categorie‑specifieke instructies toe (alleen generieke ESS‑02 tekst).
  - `TemplateModule` valt uit met “Geen semantische categorie beschikbaar” (verwacht sleutel `semantic_category`).

Oplossing (functioneel)
- Propagatie:
  - Zet na `build_enriched_context(...)` in `PromptServiceV2` expliciet:
    - `enriched_context.metadata['ontologische_categorie'] = request.ontologische_categorie`
    - `enriched_context.metadata['semantic_category'] = <waarde>` (mapping als nodig, zie onder).
- Module‑compat:
  - `SemanticCategorisationModule` gebruikt `ontologische_categorie` (ESS: type/proces/resultaat/exemplaar) voor concrete instructies.
  - `TemplateModule` verwacht `semantic_category` (domeincategorieën: Proces, Object, Actor, …). Opties:
    1) Mapping ESS → domeincategorie (bijv. proces→“Proces”, type→“Object”/“Informatie” afhankelijk van context, resultaat→“Maatregel”/“Toestand”, exemplaar→“Object”).
    2) Of TemplateModule tolerant maken: fallback op `ontologische_categorie` als `semantic_category` ontbreekt en minimale templates bieden per ESS.

Acceptatiecriteria
- AC1: Bij een request met `ontologische_categorie=proces` bevat de gegenereerde prompt de PROCES‑specifieke instructies uit `SemanticCategorisationModule`.
- AC2: De waarschuwing “Geen semantische categorie beschikbaar voor templates” komt niet meer voor in de logs bij requests mét categorie.
- AC3: `TemplateModule` levert categorie‑afhankelijke templates wanneer een (afgeleide) `semantic_category` beschikbaar is.
- AC4: Er wordt géén extra AI‑call gedaan voor categoriebepaling.
- AC5: Bestaande integratietesten voor promptopbouw blijven groen; voeg een gerichte test toe die de aanwezigheid van categorie‑specifieke instructies controleert.

Niet‑functioneel
- Geen merkbare performance‑regressie in promptopbouw (< 50ms extra in batch).
- Logging blijft informatief, zonder ruisende warnings.

Uitwerking (technisch – voorstel)
1. `PromptServiceV2.build_generation_prompt`: na `enriched_context = await context_manager.build_enriched_context(request)`:
   - `enriched_context.metadata['ontologische_categorie'] = request.ontologische_categorie`
   - `enriched_context.metadata['semantic_category'] = mapping(request.ontologische_categorie)` (optioneel, zie 2).
2. Mapping (indien gekozen): definieer eenvoudige mapping ESS→domein (kan later verdiept worden):
   - proces → "Proces"
   - type → "Object" (of "Informatie" afhankelijk van context; begin met "Object")
   - resultaat → "Maatregel" of "Toestand" (kies één consistente startwaarde, bv. "Maatregel")
   - exemplaar → "Object"
3. (Alternatief) `TemplateModule.validate_input`: fallback op `ontologische_categorie` wanneer `semantic_category` ontbreekt, en minimale templates aanbieden per ESS.
4. Tests:
   - Nieuwe test die `PromptServiceV2` aanroept met `ontologische_categorie=proces` en controleert dat de prompt PROCES‑instructies bevat.
   - Test dat `TemplateModule` niet meer uitvalt en output levert zodra `semantic_category` aanwezig is.

Risico’s & randgevallen
- Mapping ESS→domeincategorie is interpretatief; kan in latere stories verfijnd worden.
- Backwards compat: bestaande code die `semantic_category` verwacht blijft werken.

Definition of Done
- Code + tests gemerged.
- Geen template‑categorie warnings meer in integratieruns.
- Korte ontwikkelaarsnotitie in README/CHANGELOG over propagatie en (tijdelijke) mapping.

