---
id: US-053
titel: Implement CI Gates tegen Legacy Patterns
epic: EPIC-010
status: Open
prioriteit: MEDIUM
story_points: 2
sprint: sprint-37
toegewezen_aan: devops-team
aangemaakt: 2025-09-10
bijgewerkt: 2025-09-10
owner: devops-engineer
type: ci-cd
vereisten:
- REQ-068
- REQ-069
Afhankelijkheden:
- US-043
- US-051
- US-052
applies_to: definitie-app@current
canonical: true
last_verified: 2025-09-10
---

# US-053: Implement CI Gates tegen Legacy Patterns

**Epic:** EPIC-010 - Context Flow Refactoring

## Gebruikersverhaal

**Als een** DevOps engineer
**wil ik** automatische CI gates die legacy patterns blokkeren
**zodat** we regressie voorkomen en de codebase clean houden na de refactor

## Probleembeschrijving

Na het verwijderen van legacy patterns en deprecated code tijdens de EPIC-010 refactor, bestaat het risico dat ontwikkelaars per ongeluk deze patterns weer introduceren. We hebben automatische checks nodig die de CI pipeline laten falen wanneer verboden patterns gedetecteerd worden.

### Te Blokkeren Patterns

1. **Legacy imports**: `from src.models.generation_result import`
2. **Deprecated attributes**: `.overall_score`, `.best_iteration`
3. **String context**: `request.context` (zonder underscore)
4. **Domein field**: Alle references naar `domein`
5. **Sync bridging in services**: `asyncio.run()` buiten async_bridge
6. **Direct sync wrapper calls**: `generate_definition_sync()` buiten async_bridge

## Acceptatiecriteria

### Functionele Criteria
- [ ] GitHub Actions workflow geconfigureerd
- [ ] Workflow runt op elke push en PR
- [ ] Duidelijke error messages bij violations
- [ ] Exit code 1 bij gevonden violations
- [ ] Groene check bij clean code

### Technische Criteria
- [ ] Workflow file: `.github/workflows/epic-010-gates.yml`
- [ ] Gebruikt grep/ripgrep voor pattern matching
- [ ] Exclude patterns voor valse positieven
- [ ] Performance: < 30 seconden runtime
- [ ] Configureerbare pattern lijst

### Pattern Checks
- [ ] Check legacy imports geblokkeerd
- [ ] Check deprecated attributes geblokkeerd
- [ ] Check string context geblokkeerd
- [ ] Check domein field geblokkeerd
- [ ] Check asyncio.run in services geblokkeerd
- [ ] Check directe sync wrapper calls geblokkeerd

## Implementatie Details

### GitHub Actions Workflow

```yaml
# .github/workflows/epic-010-gates.yml
name: EPIC-010 Legacy Pattern Gates

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  check-legacy-patterns:
    runs-on: ubuntu-latest
    name: Check for Legacy Patterns

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install ripgrep
        run: |
          sudo apt-get update
          sudo apt-get install -y ripgrep

      - name: Check for generation_result imports
        run: |
          echo "Checking for legacy generation_result imports..."
          if rg "from src\.models\.generation_result import" src/; then
            echo "‚ùå FAIL: Legacy generation_result imports found"
            exit 1
          fi
          echo "‚úÖ PASS: No generation_result imports"

      - name: Check for deprecated attributes
        run: |
          echo "Checking for deprecated attributes..."
          if rg "\.overall_score|\.best_iteration" src/ --type py; then
            echo "‚ùå FAIL: Deprecated attributes found"
            exit 1
          fi
          echo "‚úÖ PASS: No deprecated attributes"

      - name: Check for string context usage
        run: |
          echo "Checking for string context usage..."
          # Match request.context but NOT request.context_dict
          if rg "request\.context(?!_dict)" src/ --type py; then
            echo "‚ùå FAIL: String context usage found"
            exit 1
          fi
          echo "‚úÖ PASS: No string context usage"

      - name: Check for domein field
        run: |
          echo "Checking for domein field usage..."
          # Exclude comments and docstrings
          if rg "\bdomein\b" src/ --type py | grep -v "^.*#.*domein" | grep -v '""".*domein.*"""'; then
            echo "‚ùå FAIL: Domein field usage found"
            exit 1
          fi
          echo "‚úÖ PASS: No domein field usage"

      - name: Check for asyncio.run in services
        run: |
          echo "Checking for asyncio.run in services..."
          if rg "asyncio\.run\(" src/services/ --type py; then
            echo "‚ùå FAIL: asyncio.run found in services (only allowed in async_bridge)"
            exit 1
          fi
          echo "‚úÖ PASS: No asyncio.run in services"

      - name: Check for sync wrapper calls outside async_bridge
        run: |
          echo "Checking for direct sync wrapper calls..."
          # Find calls but exclude async_bridge.py and imports
          VIOLATIONS=$(rg "generate_definition_sync|search_web_sources" src/ui/ --type py | \
                      grep -v "async_bridge\.py" | \
                      grep -v "from.*async_bridge import")

          if [ -n "$VIOLATIONS" ]; then
            echo "‚ùå FAIL: Direct sync wrapper calls found:"
            echo "$VIOLATIONS"
            exit 1
          fi
          echo "‚úÖ PASS: No direct sync wrapper calls"

      - name: Summary
        if: success()
        run: |
          echo "üéâ All legacy pattern checks passed!"
          echo "The codebase is clean of deprecated patterns."
```

### Local Verification Script

```bash
#!/bin/bash
# scripts/check-legacy-patterns.sh

echo "Running local legacy pattern checks..."

FAILED=0

# Function to check pattern
check_pattern() {
    local pattern=$1
    local description=$2
    local path=${3:-"src/"}

    echo -n "Checking $description... "
    if rg "$pattern" "$path" --type py -q; then
        echo "‚ùå FAIL"
        echo "  Found in:"
        rg "$pattern" "$path" --type py -l | head -5
        FAILED=$((FAILED + 1))
    else
        echo "‚úÖ PASS"
    fi
}

# Run checks
check_pattern "from src\.models\.generation_result import" "generation_result imports"
check_pattern "\.overall_score|\.best_iteration" "deprecated attributes"
check_pattern "request\.context(?!_dict)" "string context"
check_pattern "\bdomein\b" "domein field"
check_pattern "asyncio\.run\(" "asyncio.run in services" "src/services/"

# Check sync wrappers
echo -n "Checking direct sync wrapper calls... "
VIOLATIONS=$(rg "generate_definition_sync|search_web_sources" src/ui/ --type py | \
            grep -v "async_bridge" | \
            grep -v "from.*import")
if [ -n "$VIOLATIONS" ]; then
    echo "‚ùå FAIL"
    FAILED=$((FAILED + 1))
else
    echo "‚úÖ PASS"
fi

# Summary
echo ""
if [ $FAILED -eq 0 ]; then
    echo "üéâ All checks passed!"
    exit 0
else
    echo "‚ùå $FAILED checks failed"
    exit 1
fi
```

## Test Scenarios

### Unit Tests
1. Test workflow syntax valid
2. Test pattern matching accuracy
3. Test false positive exclusions
4. Test performance < 30s

### Integration Tests
1. Test op PR met clean code (moet slagen)
2. Test op PR met legacy patterns (moet falen)
3. Test verschillende branch strategies
4. Test parallel runs

## Verificatie

```bash
# 1. Valideer workflow syntax
yamllint .github/workflows/epic-010-gates.yml

# 2. Test lokaal
bash scripts/check-legacy-patterns.sh

# 3. Test met opzettelijke violations
echo "from src.models.generation_result import OldModel" > test_violation.py
bash scripts/check-legacy-patterns.sh
rm test_violation.py

# 4. Dry run van workflow
act -n  # Gebruik 'act' tool voor lokale GitHub Actions
```

## Definition of Done

- [ ] Workflow file aangemaakt en gecommit
- [ ] Lokaal verificatie script aangemaakt
- [ ] Alle pattern checks ge√Ømplementeerd
- [ ] False positives uitgesloten
- [ ] Workflow getest op test branch
- [ ] Documentatie toegevoegd aan CI/CD docs
- [ ] Team ge√Ønformeerd over nieuwe gates

## Risico's

| Risico | Impact | Mitigatie |
|--------|--------|-----------|
| False positives | Medium | Goede exclude patterns |
| Performance impact | Low | Gebruik ripgrep, cache |
| Bypass attempts | Low | Protected branches |

## Notes

- Deze gates zijn permanent, niet alleen voor Sprint 37
- Patterns kunnen uitgebreid worden in de toekomst
- Consider integratie met SonarQube voor uitgebreidere checks
- Lokaal script helpt developers voor ze pushen
