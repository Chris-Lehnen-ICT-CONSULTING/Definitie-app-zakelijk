---
id: REQ-097
titel: Iteratieve Verbetering van Definities (V2 Orchestrator)
type: functional
status: TODO
prioriteit: HOOG
aangemaakt: 13-09-2025
bijgewerkt: 13-09-2025
owner: product
applies_to: definitie-app@current
canonical: false
last_verified: 2025-09-29
epics: 
stories: 
links: 
sources: 
docs: 
- line: DefinitionOrchestratorV2 (11-fasen)
path: src/services/orchestrators/definition_orchestrator_v2.py
---



# REQ-097: Iteratieve Verbetering van Definities (V2 Orchestrator)

## Domeincontext
- EPIC-012 consolideert legacy naar V2 services met een stateless orchestrator.
- Deze requirement borgt dat definities iteratief worden verbeterd met duidelijke stop‑criteria, kwaliteitsgates en consistente UI‑presentatie.

## Beschrijving
Het systeem moet definities iteratief kunnen verbeteren via de V2 orchestrator, met per iteratie valideerbare kwaliteitsmetingen en heldere stop‑criteria. De UI (Orchestration‑tab, achter feature flag) moet dezelfde V2‑contractvorm presenteren als de hoofdgenerator (platte dict, geen legacy objecten).

## Acceptatiecriteria
1. Iteratieve loop
   - Maximaal 3 iteraties (configureerbaar)
   - Vroegtijdig stoppen bij acceptatie (gate pass) of stagnatie (< 0.05 verbetering)
2. Kwaliteitsmeting per iteratie
   - Score en violations beschikbaar per iteratie
   - “Beste” resultaat wordt vastgelegd (hoogste score)
3. Gate‑enforcement
   - Acceptatiecriteria via policy (`approval_gate.yaml`): minimale score, geen kritieke violations, “minimaal één context” vereist
   - UI toont pass / override_required / blocked en vraagt reden bij override
4. V2‑contract in UI
   - Response in UIResponseDict‑vorm: `success`, `definitie_gecorrigeerd`, `final_score`, `validation_details`, `voorbeelden`, `metadata`, `sources`
   - Context in `metadata.context` met drie lijsten: `organisatorisch`, `juridisch`, `wettelijk`
5. Async‑conform
   - Geen `asyncio.run` in services; UI gebruikt bridge of event loop

### SMART Acceptatiecriteria
- Specifiek: iteratieve verbetering met kwaliteitsgates en V2‑UI‑contract
- Meetbaar:
  - Iteraties: ≤ 3 per run; verbetering per iteratie ≥ 0.05 (indien niet geaccepteerd)
  - Gate: `overall_score ≥ policy.hard_min_score` én 0 kritieke violations
  - UI: 100% velden van UIResponseDict aanwezig
- Acceptabel: implementatie via bestaande V2 orchestrator en policy loader
- Relevant: ondersteunt expert‑review door zichtbare kwaliteitsstappen
- Tijdgebonden: oplevering samen met US‑170 koppeling

### BDD Scenario’s
```gherkin
Scenario: Acceptatie in iteratie 1
  Gegeven een initieel voorstel met score ≥ drempel en 0 kritieke violations
  Wanneer de orchestrator een iteratie uitvoert
  Dan is de gate status "pass" en stopt de loop
  En wordt definitie_gecorrigeerd getoond met final_score

Scenario: Verbetering in iteratie 2
  Gegeven een initieel voorstel met score < drempel
  En verbetering ≥ 0.05 in iteratie 2
  Wanneer de orchestrator twee iteraties uitvoert
  Dan wordt iteratie 2 als beste resultaat gekozen
  En toont de UI final_score en validation_details

Scenario: Stagnatie → vroege stop
  Gegeven verbetering < 0.05 tussen opeenvolgende iteraties
  Wanneer een nieuwe iteratie gepland staat
  Dan stopt de loop en wordt beste resultaat tot dan gebruikt

Scenario: Gate override vereist
  Gegeven score tussen soft en hard drempel of alleen "high" violations
  Wanneer de expert vaststelt met override
  Dan vraagt de UI om een reden en registreert deze in metadata
```

## Implementatie‑aanwijzingen
- UI Orchestration‑tab blijft achter feature flag (`ENABLE_LEGACY_TAB=true`) totdat productie‑koppeling klaar is (US‑170)
- UI gebruikt `ui.helpers.async_bridge` voor orchestrator calls
- Normaliseer responses naar UIResponseDict (zo nodig); V2 orchestrator levert dit al
- Gate‑policy laden via `GatePolicyService` (TTL‑cache)

## Testplan
- Unit (UI): normalisatie naar V2‑contract; rendering van gate status en override‑reason
- Integratie: orchestrator call → gate → UI; scenario’s pass/override/blocked
- Negatief: API/timeout → UI melding, geen crash

## Afhankelijkheden
- DefinitionOrchestratorV2
- GatePolicyService en `config/approval_gate.yaml`
- Async bridge in UI

## Compliance
- Geen `best_iteration` of legacy objecten in UI
- Geen `asyncio.run` in services; UI doet bridging
- Context Model V2 (drie lijsten) overal gehandhaafd

## Implementatie Referentie (legacy, gearchiveerd)
- Gearchiveerde legacy implementatie met iteratieve logica en FeedbackBuilder:
  - `docs/archief/legacy/orchestration/definitie_agent.py`
- Relevante businesskennis (US‑061 extractie):
  - Stop‑criteria: max 3 iteraties; improvement_threshold 0.05; acceptance_threshold 0.80
  - FeedbackBuilder: 11+ violation→feedback mappings; prioritering (kritiek → suggesties → overig); max 5 items/iteratie; deduplicatie
  - Voorbeelden optimalisatie: genereer in iteratie 1; hergebruik in volgende iteraties
