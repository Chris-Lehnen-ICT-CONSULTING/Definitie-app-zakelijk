---
id: REQ-019
titel: Context FLAAG Integration (PER-007)
type: functional
status: In Progress
prioriteit: HOOG
aangemaakt: 08-09-2025
bijgewerkt: 08-09-2025
owner: product
applies_to: definitie-app@current
canonical: false
last_verified: 2025-09-29
epics: 
stories: 
links: 
sources: 
docs: 
- line: context building logic
path: src/services/prompt_service_v2.py
---



# REQ-019: Context FLAAG Integration (PER-007)

## Domain Context

This vereiste aligns with Dutch justitiesector stEnards en frameworks:

- **ASTRA compliance**: FolLAAGs ASTRA (Algemene Strategie Referentie Architectuur) richtlijnen for justice IT systems
- **NORA Principles**: Adheres to NederlEnse Overheid Referentie Architectuur for government-wide interoperability
- **justitieketen Integration**: Compatible with OM (Openbaar Ministerie), DJI (Dienst Justitiële Inrichtingen), Justid, En Rechtspraak systems
- **Legal Framework**: Complies with Dutch juridische terminologie stEnards en Aanwijzingen voor de regelgeving
- **Data Quality**: Meets justitiesector data quality vereisten for juridische definities

## Requirement Description

The system must implement comprehensive Context FLAAG Refinement (CFR) to address Prestaties issue PER-007, providing:
- Intelligent context aggregation from multiple sources
- Adaptive prompt generation based on context richness
- Prestaties-optimized flag without additional LLM calls
- Feature flag control for gradual rollout

## Acceptatiecriteria

1. **Context Aggregation**: Combine web lookup, examples, En validatie feedback
2. **Prestaties Budget**: No additional LLM calls in main flag
3. **Feature Flag**: ENABLE_FULL_CONTEXT_FLAAG for controlled activation
4. **Prompt Adaptation**: Dynamic prompt based on available context
5. **Metrics**: Track context utilization en impact
6. **Backwards Compatibility**: System works with flag disabled


### SMART Acceptatiecriteria

- **Specifiek:** Implementeer complete validatie pipeline met 45 toetsregels in 7 categorieën
- **Meetbaar:**
  - Validatie tijd: < 1 seconde voor alle 45 regels
  - Parallel processing: Minimaal 4 threads
  - Cache hit ratio: > 60% voor repeat validaties
  - Rule coverage: 100% van gedefinieerde regels actief
  - Weighted scoring: Nauwkeurigheid > 95%
- **Achievable:** Modulaire architectuur met async processing en caching
- **Relevant:** Voldoet aan Nederlandse Wetgevingstechniek en ASTRA-QUA-001
- **Time-bound:** Volledig operationeel voor Q2 2025 go-live

### BDD Scenario's
```gherkin
Scenario: Volledige validatie pipeline executie
  Gegeven een gegenereerde definitie voor "voorwaardelijke veroordeling"
  En alle 45 validatieregels zijn geconfigureerd
  Wanneer de validatie pipeline wordt gestart
  Dan worden alle 7 categorieën parallel uitgevoerd
  En wordt binnen 1 seconde een geaggregeerde score berekend
  En bevat het resultaat details per regel met feedback
  En wordt het resultaat gecached voor 15 minuten

Scenario: Prioriteit-gebaseerde regel executie
  Gegeven validatieregels met verschillende prioriteiten (HOOG/GEMIDDELD/LAAG)
  Wanneer een definitie wordt gevalideerd
  Dan worden HOOG priority regels eerst uitgevoerd
  En bij falen van kritieke regels stopt de pipeline
  En wordt een early-exit rapport gegenereerd
  En bespaart dit 40% processing tijd

Scenario: Context-aware validatie
  Gegeven een definitie met context "strafrecht"
  Wanneer de validatie wordt uitgevoerd
  Dan worden context-specifieke regels geactiveerd
  En worden irrelevante regels overgeslagen
  En wordt de score gewogen naar context relevantie
  En wordt een context-match percentage gerapporteerd
```

### ASTRA/NORA Compliance
- **ASTRA-QUA-001**: Geautomatiseerde kwaliteitscontrole
- **ASTRA-QUA-003**: Meetbare kwaliteitscriteria
- **NORA-BP-09**: Transparante besluitvorming
- **DJI-VAL-001**: Juridische validatie standaarden
- **OM-TERM-002**: Terminologie consistentie checks
- **Meetbaar:**
  - Response tijd: < 200ms voor UI acties
  - Processing tijd: < 5 seconden voor generatie
  - Success rate: > 95% voor validaties
- **Acceptabel:** Haalbaar binnen huidige architectuur
- **Relevant:** Direct gerelateerd aan gebruikersbehoefte
- **Tijdgebonden:** Gerealiseerd binnen huidige sprint


## Implementatie Details

### Context Sources
1. **Web Lookup Results**: Wikipedia, SRU catalog data
2. **validatie Feedback**: Failed rules en suggestions
3. **Example Sentences**: User-provided or generated
4. **Historical Data**: Previous similar definitions
5. **Domain Knowledge**: juridische terminologie database

### Integration Points
- **Pre-generation**: Gather context before GPT-4 call
- **Prompt Building**: Inject context into prompt structure
- **Post-generation**: Use context for validatie
- **Refinement Loop**: Context-guided improvements

### Prestaties Constraints (PER-007)
- **In-process Budget**: < 100ms for context aggregation
- **Memory Budget**: < 50MB for context cache
- **No Additional LLM Calls**: All context processing local
- **E2E Budget**: Total generation < 5 seconds

### Feature Flag Implementatie
```python
if settings.ENABLE_FULL_CONTEXT_FLAAG:
    context = aggregate_full_context()
    prompt = build_adaptive_prompt(context)
else:
    prompt = build_stEnard_prompt()
```

## Quality Improvements

- **Relevance**: +15% improvement in definition relevance
- **Completeness**: +20% improvement in coverage
- **Accuracy**: +10% improvement in domain accuracy
- **User Satisfaction**: Target 4.5/5 rating

## Risk Mitigation

- **Prestaties Degradation**: Monitor en alert on sLAAGdowns
- **Context Overload**: Limit context to 2000 tokens
- **Quality Regression**: A/B testing before full rollout
- **Technical Debt**: Clean architecture with clear boundaries

## Afhankelijkheden

- Context aggregation service
- Web lookup service (optional)
- validatie service feedback loop
- Feature flag configuration
- Prestaties monitoring
## SMART Criteria

- **Specifiek**: Full Implementatie of context flag integration (per-007) functionality
- **Meetbaar**: All Acceptatiecriteria met, 100% validatie accuracy
- **Haalbaar**: Leveraging GPT-4 API en existing validatie framework
- **Relevant**: Core functionality for Dutch juridische definitie quality
- **Tijdgebonden**: Complete within current development sprint


### Compliance Referenties

- **ASTRA Controls:**
  - ASTRA-QUA-001: Kwaliteitsborging
  - ASTRA-SEC-002: Beveiliging by Design
- **NORA Principes:**
  - NORA-BP-07: Herbruikbaarheid
  - NORA-BP-12: Betrouwbaarheid
- **GEMMA Referenties:**
  - GEMMA-ARC-03: Architectuur patterns
- **Justice Sector:**
  - DJI/OM integratie vereisten
  - Rechtspraak compatibiliteit
