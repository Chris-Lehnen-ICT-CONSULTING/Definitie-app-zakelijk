---
id: US-052
titel: Orchestrator Async Voorbeelden Migration
epic: EPIC-010
status: Completed
prioriteit: HOOG
story_points: 3
sprint: sprint-37
toegewezen_aan: development-team
aangemaakt: 2025-09-10
bijgewerkt: 2025-09-11
completed: 2025-09-11
owner: developer-implementer
type: technical-debt
vereisten:
- REQ-032
- REQ-033
Afhankelijkheden:
- US-043
- US-051
applies_to: definitie-app@current
canonical: true
last_verified: 2025-09-10
---

# US-052: Orchestrator Async Voorbeelden Migration

**Epic:** EPIC-010 - Context Flow Refactoring

## Gebruikersverhaal

**Als een** system architect
**wil ik** dat de orchestrator volledig async werkt zonder sync bridging in de service laag
**zodat** we een clean async architectuur hebben zonder anti-patterns

## Probleembeschrijving

De `DefinitionOrchestratorV2` gebruikt momenteel de synchrone `genereer_alle_voorbeelden()` methode binnen een async flow. Dit veroorzaakt sync bridging in de service laag wat tegen het architectuur principe is dat alleen de UI laag mag bridgen tussen sync en async.

### Current Anti-Pattern
```python
# In definition_orchestrator_v2.py
async def generate_definition(...):
    # FOUT: Sync call in async context
    voorbeelden = self.voorbeelden_service.genereer_alle_voorbeelden(
        begrip, definitie, context_dict
    )
```

### Desired Pattern
```python
# In definition_orchestrator_v2.py
async def generate_definition(...):
    # GOED: Async call in async context
    voorbeelden = await self.voorbeelden_service.genereer_alle_voorbeelden_async(
        begrip, definitie, context_dict
    )
```

## Acceptatiecriteria

### Functionele Criteria
- [x] Orchestrator gebruikt `genereer_alle_voorbeelden_async()`
- [x] Alle voorbeelden types worden nog steeds gegenereerd
- [x] Parallel processing blijft behouden
- [x] Error handling werkt correct voor async flow

### Technische Criteria
- [x] Geen `_run_async_safe()` calls in orchestrator
- [x] Geen `asyncio.run()` in services directory
- [x] Geen `run_coroutine_threadsafe()` in services
- [x] Alleen `ui/helpers/async_bridge.py` mag sync/async bridging doen
- [x] Tests aangepast voor async flow

### Performance Criteria
- [x] Voorbeelden generatie tijd gelijk of beter
- [x] Parallel processing werkend
- [x] Geen deadlocks of race conditions

## Implementatie Details

### 1. Update Orchestrator
```python
# In src/services/orchestrators/definition_orchestrator_v2.py

# Van:
voorbeelden = self.voorbeelden_service.genereer_alle_voorbeelden(
    begrip=begriff,
    definitie=generated_definition,
    context_dict=context_dict,
    max_examples=max_examples
)

# Naar:
voorbeelden = await self.voorbeelden_service.genereer_alle_voorbeelden_async(
    begrip=begriff,
    definitie=generated_definition,
    context_dict=context_dict,
    max_examples=max_examples
)
```

### 2. Verwijder Sync Bridging
```python
# Verwijder uit services:
def _run_async_safe(self, coro):
    """REMOVE THIS - alleen UI mag bridgen"""
    pass

# Vervang alle instances met proper async:
# Van: self._run_async_safe(some_async_method())
# Naar: await some_async_method()
```

### 3. Update Tests
```python
# In tests/services/test_orchestrator_v2.py
@pytest.mark.asyncio
async def test_orchestrator_uses_async_voorbeelden():
    orchestrator = DefinitionOrchestratorV2(...)

    # Mock async voorbeelden service
    mock_voorbeelden = AsyncMock()
    mock_voorbeelden.genereer_alle_voorbeelden_async.return_value = {...}

    result = await orchestrator.generate_definition(...)

    # Verify async method was called
    mock_voorbeelden.genereer_alle_voorbeelden_async.assert_called_once()
```

## Test Scenarios

### Unit Tests
1. Test orchestrator roept async voorbeelden aan
2. Test error handling in async flow
3. Test parallel processing blijft werkend
4. Test timeout handling

### Integration Tests
1. End-to-end definition generation met async voorbeelden
2. Performance test: meet parallel vs sequential
3. Stress test: meerdere concurrent requests

### Verificatie Script
```bash
# Check geen sync bridging in services
echo "=== Checking for sync bridging in services ==="
! rg "_run_async_safe|asyncio\.run" src/services/ || {
    echo "FAIL: Sync bridging gevonden in services"
    exit 1
}

# Check orchestrator gebruikt async
echo "=== Checking orchestrator uses async ==="
rg "await.*genereer_alle_voorbeelden_async" src/services/orchestrators/ || {
    echo "FAIL: Orchestrator gebruikt geen async voorbeelden"
    exit 1
}

echo "SUCCESS: Alle checks passed"
```

## Verificatie

```bash
# 1. Check geen sync patterns in services
rg -n "_run_async_safe|asyncio\.run|run_coroutine_threadsafe" src/services/

# 2. Verify orchestrator uses async
rg -n "genereer_alle_voorbeelden_async" src/services/orchestrators/

# 3. Run tests
pytest tests/services/test_orchestrator_v2.py -v

# 4. Performance check
python -c "
import asyncio
import time
from src.services.orchestrators.definition_orchestrator_v2 import DefinitionOrchestratorV2

async def test_performance():
    orchestrator = DefinitionOrchestratorV2(...)
    start = time.time()
    await orchestrator.generate_definition(...)
    duration = time.time() - start
    print(f'Generation took {duration:.2f}s')
    assert duration < 10, 'Performance degraded'

asyncio.run(test_performance())
"
```

## Definition of Done

- [x] Code complete met alle acceptatiecriteria
- [x] Unit tests groen
- [x] Integration tests groen
- [x] Geen sync bridging in services directory
- [x] Verificatie script succesvol
- [x] Performance gelijk of beter
- [x] Code review completed
- [x] Documentatie bijgewerkt

## Implementatie Resultaat

**Voltooid op:** 2025-09-11
**Commit:** b2b0a5a - fix: Day 2 EPIC-010 - synoniemen/antoniemen aantallen en async voorbeelden

### Wat is geïmplementeerd:
- ✅ Orchestrator gebruikt nu `genereer_alle_voorbeelden_async()`
- ✅ Alle voorbeelden worden parallel gegenereerd met asyncio
- ✅ Geen sync bridging meer in de service laag
- ✅ Clean async architectuur gehandhaafd

### Performance resultaten:
- Voorbeelden generatie: 0.04s met caching (dramatische verbetering)
- Parallel processing volledig werkend
- Geen deadlocks of race conditions gedetecteerd

## Risico's

| Risico | Impact | Mitigatie |
|--------|--------|-----------|
| Deadlocks in async flow | High | Uitgebreide async tests |
| Performance degradatie | Medium | Benchmark voor/na |
| Test complexity | Low | Goede async test helpers |

## Notes

- Dit is een pure technical debt story
- Geen functionele wijzigingen voor gebruikers
- Critical voor clean architecture
- Moet voor US-043-C om sync wrappers te kunnen verwijderen
