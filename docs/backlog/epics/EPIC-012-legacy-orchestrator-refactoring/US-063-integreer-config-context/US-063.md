# US-063: Integreer Legacy Config en Context in V2

## Story Overview
**ID**: US-063
**Epic**: EPIC-012 - Legacy Orchestrator Refactoring
**Status**: TODO
**Priority**: HIGH
**Points**: 5
**Sprint**: Sprint 2

## User Story
**Als** developer
**Wil ik** legacy configuratie en context management integreren in V2
**Zodat** alle business parameters en context handling behouden blijven

## Business Context
De legacy modules bevatten belangrijke configuratie parameters en context management die essentieel zijn voor de werking. Deze moeten geconsolideerd worden in de V2 architectuur zonder functionaliteit verlies.

## Acceptance Criteria
- [ ] UnifiedGeneratorConfig geïntegreerd in V2 interfaces
- [ ] EnrichedContext functionaliteit in ContextServiceV2
- [ ] HybridContextManager logica behouden
- [ ] Alle business parameters gemigreerd
- [ ] Context flow door services werkend
- [ ] Geen functionaliteit verlies
- [ ] Tests voor context management

## Technical Implementation

### 1. Config Consolidatie
**Van**: `definition_generator_config.py`
**Naar**: `src/services/interfaces.py` uitbreiden

```python
@dataclass
class GeneratorConfigV2:
    """Consolidated configuration from legacy."""

    # Business parameters te behouden:
    save_drafts: bool = True
    min_quality_score: float = 0.6
    parallel_enrichment: bool = True
    retry_on_failure: bool = True
    max_retries: int = 3

    # Van UnifiedGeneratorConfig:
    enable_web_lookup: bool = True
    enable_examples: bool = True
    temperature: float = 0.7
    max_tokens: int = 300

    # Context configuratie:
    context_expansion: bool = True
    source_confidence_threshold: float = 0.7
```

### 2. Context Service Creatie
**Nieuw bestand**: `src/services/context_service_v2.py`

```python
class ContextServiceV2:
    """
    Moderne implementatie van EnrichedContext en HybridContextManager.
    Behoudt alle context intelligence uit legacy.
    """

    def __init__(self, config: GeneratorConfigV2):
        self.config = config

    def create_enriched_context(
        self,
        base_context: Dict,
        sources: List[Source],
        metadata: Dict
    ) -> ContextV2:
        """Create enriched context zoals legacy EnrichedContext."""

    def manage_hybrid_context(
        self,
        documents: List[str],
        web_sources: List[Source]
    ) -> HybridContext:
        """Hybrid context management uit legacy."""
```

### 3. Legacy Context Structuren
**Te behouden van** `definition_generator_context.py`:

```python
class ContextV2:
    """Refactored van EnrichedContext."""
    base_context: Dict[str, List[str]]
    sources: List[Source]
    expanded_terms: Dict[str, str]
    confidence_scores: Dict[str, float]
    metadata: Dict[str, Any]

    # Business logica te behouden:
    def get_relevant_context(self, threshold: float)
    def expand_abbreviations(self)
    def calculate_confidence(self)
```

### 4. Integration Points Update
**Files te updaten**:
- `src/services/prompts/prompt_service_v2.py`
- `src/services/orchestrators/definition_orchestrator_v2.py`

```python
# Oude import:
from services.definition_generator_context import EnrichedContext

# Nieuwe import:
from services.context_service_v2 import ContextServiceV2, ContextV2
```

### 5. Business Rules te Behouden

**Context Prioritering**:
- Juridische context > Organisatorische context
- Web sources met confidence > 0.7
- Document context boven algemene context

**Config Defaults**:
- Temperature: 0.7 voor consistentie
- Max tokens: 300 voor definities
- Min quality score: 0.6 voor drafts

## Testing Requirements
```python
# tests/services/test_context_service_v2.py
class TestContextServiceV2:
    def test_enriched_context_creation()
    def test_hybrid_context_management()
    def test_context_prioritization()
    def test_config_parameters_retained()
    def test_backwards_data_compatibility()
```

## Migration Checklist
- [ ] Analyseer alle usage van UnifiedGeneratorConfig
- [ ] Identificeer alle EnrichedContext instanties
- [ ] Map legacy parameters naar V2
- [ ] Update alle imports
- [ ] Test context flow end-to-end

## Dependencies
- US-061 compleet (business kennis document)
- V2 interfaces stabiel
- PromptServiceV2 beschikbaar

## Definition of Done
- [ ] ContextServiceV2 volledig geïmplementeerd
- [ ] Alle config parameters gemigreerd
- [ ] Context flow werkend door hele applicatie
- [ ] Unit tests voor alle context functies
- [ ] Integration tests met prompt service
- [ ] Geen regression in functionaliteit
- [ ] Performance metrics gelijk of beter

## Notes
- Legacy modules nog NIET verwijderen
- Focus op consolidatie, niet simplificatie
- Alle business rules moeten behouden blijven
- Documenteer elke parameter's purpose
