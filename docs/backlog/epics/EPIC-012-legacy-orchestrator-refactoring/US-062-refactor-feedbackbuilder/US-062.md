# US-062: Refactor FeedbackBuilder naar Moderne Service

## Story Overview
**ID**: US-062
**Epic**: EPIC-012 - Legacy Orchestrator Refactoring
**Status**: TODO
**Priority**: CRITICAL
**Points**: 8
**Sprint**: Sprint 1-2

## User Story
**Als** developer
**Wil ik** de FeedbackBuilder refactoren naar een moderne V2 service
**Zodat** alle intelligente feedback logica behouden blijft in moderne architectuur

## Business Context
De FeedbackBuilder bevat de meest waardevolle business logica voor iteratieve verbetering van definities. Deze 11 violation mappings en 4 pattern categorieën zijn het resultaat van jaren ervaring en moeten volledig behouden blijven.

## Acceptance Criteria
- [ ] FeedbackServiceV2 gecreëerd met alle legacy functionaliteit
- [ ] Alle 11 violation feedback mappings werkend
- [ ] Alle 4 pattern suggestion categorieën geïmplementeerd
- [ ] Feedback prioritering algoritme behouden
- [ ] Learning feedback mechanisme werkend
- [ ] Score stagnatie detectie functioneel
- [ ] Integratie met V2 ValidationService
- [ ] Unit tests voor alle business rules

## Technical Implementation

### 1. Nieuwe Service Structuur
```python
# src/services/feedback_service_v2.py
class FeedbackServiceV2:
    """
    Moderne implementatie van legacy FeedbackBuilder.
    Behoudt alle business kennis en intelligente algoritmes.
    """

    def __init__(self, validation_service: ValidationServiceInterface):
        self.validation_service = validation_service
        self._init_violation_mappings()
        self._init_pattern_suggestions()
```

### 2. Violation Feedback Mappings (11 regels)
**Van**: `definitie_agent.py` regels 354-368
**Naar**: `feedback_service_v2.py`

```python
VIOLATION_FEEDBACK_MAPPINGS = {
    "CON-01": "Maak de definitie context-specifiek zonder expliciete vermelding...",
    "CON-02": "Baseer de definitie op authentieke bronnen...",
    "ESS-01": "Beschrijf WAT het begrip is, niet waarvoor...",
    "ESS-02": "Maak expliciet duidelijk of het een type/soort...",
    "ESS-03": "Voeg unieke identificerende kenmerken toe...",
    "ESS-04": "Gebruik objectief meetbare criteria...",
    "ESS-05": "Benadruk de onderscheidende eigenschappen...",
    "INT-01": "Formuleer als één enkele zin...",
    "INT-03": "Vervang onduidelijke verwijzingen...",
    "STR-01": "Start met centrale zelfstandig naamwoord...",
    "STR-02": "Gebruik concrete terminologie..."
}
```

### 3. Pattern Suggestions (4 categorieën)
**Van**: `definitie_agent.py` regels 370-393
**Naar**: `feedback_service_v2.py`

- forbidden_context_words
- vague_terminology
- goal_oriented_language
- unclear_references

### 4. Intelligente Algoritmes
**Te behouden**:
- Prioritering: Max 3 kritieke issues tegelijk
- Score stagnatie: < 0.05 verschil detectie
- Learning: Analyse van vorige pogingen
- Reinforcement: Behoud succesvolle patronen

### 5. Interface Design
```python
class FeedbackServiceInterface(ABC):
    @abstractmethod
    async def generate_improvement_feedback(
        self,
        violations: List[RuleViolation],
        iteration_number: int,
        history: FeedbackHistory
    ) -> List[str]:
        """Generate intelligent feedback for improvement."""

    @abstractmethod
    def detect_stagnation(
        self,
        score_history: List[float]
    ) -> bool:
        """Detect if improvement has stagnated."""
```

## Integration Points
- **ValidationServiceV2**: Voor violation data
- **DefinitionOrchestratorV2**: Voor iterative improvement
- **MonitoringService**: Voor metrics tracking

## Testing Requirements
```python
# tests/services/test_feedback_service_v2.py
class TestFeedbackServiceV2:
    def test_all_violation_mappings_present()
    def test_pattern_suggestions_complete()
    def test_prioritization_max_three_critical()
    def test_stagnation_detection()
    def test_learning_feedback()
    def test_reinforcement_feedback()
```

## Migration Strategy
1. **Fase 1**: Creëer nieuwe service met interfaces
2. **Fase 2**: Kopieer en refactor business logica
3. **Fase 3**: Schrijf comprehensive tests
4. **Fase 4**: Integreer met V2 orchestrator
5. **Fase 5**: Verificatie tegen legacy output

## Dependencies
- US-061 moet compleet zijn (business kennis document)
- ValidationServiceV2 moet beschikbaar zijn
- V2 interfaces moeten stabiel zijn

## Definition of Done
- [ ] FeedbackServiceV2 volledig geïmplementeerd
- [ ] Alle 11 violation mappings aanwezig en werkend
- [ ] Alle 4 pattern categorieën functioneel
- [ ] Unit tests 100% coverage voor business rules
- [ ] Integration test met ValidationService
- [ ] Performance gelijk aan of beter dan legacy
- [ ] Code review completed
- [ ] Documentatie bijgewerkt

## Notes
- **GEEN functionaliteit weglaten** - alles moet behouden blijven
- Legacy code nog NIET verwijderen tot verificatie compleet
- Focus op behoud van business kennis
- Test-driven development approach
