# US-070: Refactor Category State Manager naar UI Layer

## User Story
**Als** architect  
**Wil ik** dat CategoryStateManager geen UI state schrijft vanuit de service laag  
**Zodat** er een clean separation of concerns is tussen services en UI

## Context
`src/services/category_state_manager.py` importeert en schrijft naar `ui.session_state.SessionStateManager`.
Dit is een architectuur schending: services moeten stateless zijn en niet direct UI state manipuleren.

## Probleem
```python
# src/services/category_state_manager.py - HUIDIGE SITUATIE
from ui.session_state import SessionStateManager  # ❌ Service → UI dependency

class CategoryStateManager:
    def set_category(self, category):
        # Service schrijft direct naar UI state ❌
        SessionStateManager.set_value("category", category)
```

## Acceptatiecriteria
- [ ] CategoryStateManager schrijft niet naar UI state
- [ ] Service retourneert alleen data/events
- [ ] UI layer handelt state updates af
- [ ] Geen imports van ui.* in services/
- [ ] Functionaliteit blijft identiek

## Technische Oplossing

### Optie 1: Event-Based Pattern
```python
# services/category_state_manager.py
class CategoryStateManager:
    def determine_category(self, begrip: str) -> CategoryResult:
        """Pure function: returns category without side effects."""
        category = self._analyze_category(begrip)
        return CategoryResult(
            category=category,
            confidence=0.95,
            reasoning="..."
        )

# ui/adapters/category_adapter.py
class CategoryUIAdapter:
    def handle_category_change(self, result: CategoryResult):
        """UI adapter handles state updates."""
        SessionStateManager.set_value("category", result.category)
        SessionStateManager.set_value("category_confidence", result.confidence)
```

### Optie 2: Return Values Pattern
```python
# Service retourneert wat moet gebeuren
result = category_manager.process(begrip)
# UI beslist wat te doen met result
if result.should_update:
    update_ui_state(result.category)
```

### Optie 3: Callback Pattern
```python
# UI geeft callback mee
def ui_state_updater(category):
    SessionStateManager.set_value("category", category)

# Service roept callback aan
category_manager.process(begrip, on_category_change=ui_state_updater)
```

## Implementatie Stappen
1. Identificeer alle UI state writes in CategoryStateManager
2. Refactor naar pure functions die data returnen
3. Creëer UI adapter voor state management
4. Update alle call sites
5. Verwijder ui.* imports uit services/
6. Test UI gedrag ongewijzigd

## Dependencies
- Coördineer met US-067 (ServiceFactory cleanup)
- Check impact op ontology analyzer

## Risico's
- UI state timing issues
- Test dependencies op direct state access
- Mogelijke race conditions

## Verificatie
1. Services hebben geen ui.* imports
2. CategoryStateManager is pure functional
3. UI state updates werken correct
4. Ontology detection blijft werken
5. Tests draaien zonder Streamlit

## Story Points: 3

## Priority: MEDIUM

## Sprint: TBD

## Notes
- Overweeg algemeen event bus pattern
- Documenteer nieuwe adapter pattern
- Update architecture diagrams