# US-064: Consolideer Orchestration Logica

## Story Overview
**ID**: US-064
**Epic**: EPIC-012 - Legacy Orchestrator Refactoring
**Status**: TODO
**Priority**: HIGH
**Points**: 8
**Sprint**: Sprint 2-3

## User Story
**Als** developer
**Wil ik** alle orchestration logica consolideren in V2
**Zodat** iterative improvement, status bepaling en update flows behouden blijven

## Business Context
De legacy orchestrators bevatten cruciale business logica voor iteratieve verbetering, status bepaling en update management. Deze intelligente algoritmes zijn het hart van de applicatie en moeten volledig geïntegreerd worden in V2.

## Acceptance Criteria
- [ ] Iterative improvement loop werkend in V2
- [ ] Status bepaling algoritme geïntegreerd
- [ ] Update definition flow met selective validation
- [ ] Stats tracking en average calculations
- [ ] Performance optimalisaties behouden
- [ ] Alle stop criteria functioneel
- [ ] Tests voor alle orchestration logica

## Technical Implementation

### 1. Iterative Improvement Integration
**Van**: `definitie_agent.py` (DefinitieAgent class)
**Naar**: `definition_orchestrator_v2.py` uitbreiden

```python
class IterativeImprovementConfig:
    """Business rules voor iteratieve verbetering."""
    max_iterations: int = 3
    acceptance_threshold: float = 0.8
    improvement_threshold: float = 0.05
    enable_learning: bool = True

class DefinitionOrchestratorV2:
    async def create_definition_with_improvement(
        self,
        request: GenerationRequest,
        config: IterativeImprovementConfig
    ) -> DefinitionResponseV2:
        """
        Iteratieve verbetering uit legacy DefinitieAgent.
        """
        best_score = 0.0
        iterations = []

        for iteration in range(config.max_iterations):
            # Generate
            result = await self.create_definition(request)

            # Check acceptance
            if result.validation.score >= config.acceptance_threshold:
                return result

            # Check improvement
            if iteration > 0:
                improvement = result.validation.score - best_score
                if improvement < config.improvement_threshold:
                    # Stagnatie gedetecteerd
                    feedback = await self.feedback_service.suggest_alternative()

            # Update voor volgende iteratie
            request = self._update_request_with_feedback(request, result)
```

### 2. Status Bepaling Algoritme
**Van**: `definition_orchestrator.py` regels 333-339
**Naar**: `definition_orchestrator_v2.py`

```python
def determine_definition_status(score: float, min_quality: float = 0.6) -> str:
    """
    Business rule voor status bepaling.
    MOET exact hetzelfde blijven als legacy!
    """
    if score >= 0.8:
        return "established"
    elif score >= min_quality:
        return "review"
    else:
        return "draft"
```

### 3. Update Definition Flow
**Van**: `definition_orchestrator.py` update_definition method
**Naar**: Nieuwe method in V2

```python
async def update_definition(
    self,
    definition_id: int,
    updates: Dict[str, Any]
) -> DefinitionResponseV2:
    """
    Selective validation bij updates.
    Business rule: alleen valideren wat gewijzigd is.
    """
    existing = await self.repository.get(definition_id)

    # Selective validation
    if "definitie" in updates or "begrip" in updates:
        validation = await self.validation_service.validate(existing)
        if validation.score < self.config.min_quality_score:
            return DefinitionResponseV2(
                success=False,
                message=f"Update geweigerd: score {validation.score}"
            )
```

### 4. Stats Tracking Enhancement
**Van**: `definition_orchestrator.py` _stats dictionary
**Naar**: Enhanced monitoring in V2

```python
class OrchestrationStats:
    """Tracking van orchestration metrics."""

    def update_average_processing_time(self, new_time: float):
        """
        Legacy algoritme voor gemiddelde berekening.
        """
        if self.total_requests == 0:
            self.average_time = new_time
        else:
            self.average_time = (
                self.average_time * (self.total_requests - 1) + new_time
            ) / self.total_requests
```

### 5. Performance Optimalisaties
**Te integreren**:
- Voorbeelden caching tussen iteraties
- Parallel enrichment wanneer mogelijk
- Retry mechanisme met exponential backoff

```python
class PerformanceOptimizations:
    """Legacy performance tricks."""

    _example_cache: Dict[str, List[str]] = {}

    def cache_examples_for_iteration(self, key: str, examples: List[str]):
        """Cache voorbeelden voor hergebruik."""
        self._example_cache[key] = examples

    def get_cached_examples(self, key: str) -> Optional[List[str]]:
        """Hergebruik voorbeelden uit cache."""
        return self._example_cache.get(key)
```

## Integration Points
- **FeedbackServiceV2**: Voor iterative feedback
- **ValidationServiceV2**: Voor quality checks
- **RepositoryService**: Voor updates
- **MonitoringService**: Voor stats

## Testing Requirements
```python
# tests/services/orchestrators/test_orchestration_consolidation.py
class TestOrchestrationConsolidation:
    def test_iterative_improvement_loop()
    def test_status_determination_exact_match()
    def test_update_with_selective_validation()
    def test_stats_tracking_accuracy()
    def test_performance_optimizations()
    def test_stagnation_detection()
```

## Migration Strategy
1. **Fase 1**: Implementeer iterative improvement
2. **Fase 2**: Integreer status bepaling
3. **Fase 3**: Add update flow
4. **Fase 4**: Stats en monitoring
5. **Fase 5**: Performance optimalisaties

## Dependencies
- US-062 (FeedbackServiceV2) moet klaar zijn
- US-063 (Config consolidatie) moet compleet zijn
- V2 orchestrator basis moet stabiel zijn

## Definition of Done
- [ ] Alle orchestration logica geconsolideerd
- [ ] Iterative improvement volledig werkend
- [ ] Status bepaling exact als legacy
- [ ] Update flow met selective validation
- [ ] Stats tracking accuraat
- [ ] Performance gelijk of beter
- [ ] 100% test coverage voor business rules
- [ ] Integration tests compleet

## Notes
- **EXACTE business rules behouden** - geen "verbeteringen"
- Test tegen legacy output voor verificatie
