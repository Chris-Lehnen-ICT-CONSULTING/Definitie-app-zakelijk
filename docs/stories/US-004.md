---
id: US-004
epic: EPIC-001-basis-definitie-generatie
title: Implement Centralized AI Configuration System with Environment Override
status: GEREED
priority: HOOG
story_points: 5
sprint: Voltooid
Afhankelijkheden: [US-001]
aangemaakt: 2025-01-10
bijgewerkt: 2025-09-05
assigned_to: development-team
vereisten:
  - REQ-038  # OpenAI GPT-4 Integration
  - REQ-059  # Environment-based Configuration
  - REQ-078  # Data Model Definition
---

# US-004: Implement Centralized AI Configuration System with Environment Override

## Gebruikersverhaal
**As a** system administrator managing DefinitieAgent across DTAP environments
**wil ik** centralized AI configuration with environment-specific overrides en zero hardcoded values
**zodat** I can tune AI behavior per environment without code Wijzigingen en reduce deployment errors by 90%

## Problem Statement

**Current Situation:**
- AI settings hardcoded in 12 different files
- API keys exposed in code (beveiliging risk)
- Different temperature values across components (inconsistent)
- No way to tune settings without code deployment
- Production incidents due to wrong model selection
- 3 hours to upDatum AI settings across all environments

**Desired Outcome:**
- Single source of truth for AI configuration
- Environment-specific overrides (dev/test/acc/prod)
- Zero hardcoded values in codebase
- Hot-reload configuration Wijzigingen
- Secure API key management
- Configuration Wijzigingen in < 1 minute

## Acceptatiecriteria

### Criterion 1: Hierarchical Configuration Loading
**gegeven** the configuration hierarchy:
1. Default values in `config/ai/defaults.yaml`
2. Environment-specific in `config/ai/{env}.yaml`
3. Component-specific in `config/ai/components/{component}.yaml`
4. Environment variables (HOOGest priority)

**wanneer** `ConfigManager.get_ai_config()` is called
**dan** configuration is merged in priority order with proper override behavior

### Criterion 2: Component-Specific Configuration
**gegeven** different AI vereisten per component:
- Generator: temperature=0.3, max_tokens=1000
- Validator: temperature=0.1, max_tokens=500
- Web lookup: temperature=0.5, max_tokens=2000

**wanneer** `ConfigManager.get_component_config('generator')` is called
**dan** component-specific settings are returned with defaults filled in

### Criterion 3: Secure Environment Variable HEnling
**gegeven** sensitive configuration like API keys
**wanneer** environment variables are set:
- `OPENAI_API_KEY=sk-xxx`
- `AI_MODEL_OVERRIDE=gpt-4-turbo`
- `AI_TEMPERATURE_OVERRIDE=0.2`

**dan**:
- API key is loaded Maar never logged
- Model en temperature override config files
- Missing env vars use defaults without failing

## Technical Implementatie

### Implementatie Approach

1. **Step 1**: Create ConfigManager class in `src/config/config_manager.py`
   ```python
   class ConfigManager:
       def __init__(self):
           self.base_config = self._load_yaml('config/ai/defaults.yaml')
           self.env_config = self._load_env_config()
           self.component_configs = self._load_component_configs()

       def get_ai_config(self, component=None):
           # Merge hierarchy: base -> env -> component -> env_vars
   ```

2. **Step 2**: Define configuration schema
   ```yaml
   # config/ai/defaults.yaml
   ai:
     model: gpt-4-0125-preview
     temperature: 0.3
     max_tokens: 1000
     timeout: 30
     retry:
       max_attempts: 3
       backoff_factor: 2
   ```

3. **Step 3**: Implement environment variable mapping
   ```python
   ENV_MAPPING = {
       'OPENAI_API_KEY': 'ai.api_key',
       'AI_MODEL': 'ai.model',
       'AI_TEMPERATURE': 'ai.temperature',
       'AI_MAX_TOKENS': 'ai.max_tokens'
   }
   ```

4. **Step 4**: Add validatie en type checking
   - ValiDatum model names against alLAAGed list
   - Check temperature range (0.0 - 2.0)
   - Verify max_tokens limits
   - Ensure required fields present

### Code Locations
- Primary files:
  - `src/config/config_manager.py` (main Implementatie)
  - `src/config/validators.py` (config validatie)
  - `config/ai/defaults.yaml` (default settings)
  - `config/ai/production.yaml` (prod overrides)
- Key functions:
  - `ConfigManager.get_ai_config(component=None)`
  - `ConfigManager.reload_config()` (hot reload)
  - `ConfigManager.valiDatum_config(config_dict)`
- Integration points:
  - `src/services/ai_service_v2.py` (uses config)
  - `src/services/container.py` (injects ConfigManager)

### Technical Decisions
- Format: YAML for human readability en comments
- validatie: Pydantic models for type safety
- Caching: In-memory with 5-minute TTL
- Hot reload: File watcher with debounce
- Secrets: Environment variables only (never in files)

## Domain & compliance

### Domain Rules
- **ASTRA requirement**: Externalized configuration (12-factor app)
- **NORA principle**: Environment-specific configuration without code Wijzigingen
- **Justice beveiliging**: API keys must never be logged or exposed
- **AVG compliance**: No PII in configuration files

### beveiliging & Privacy
- **beveiliging**: API keys only via environment variables
- **Privacy**: No user data in configuration
- **Audit**: Log configuration Wijzigingen with timestamp en user
- **Access**: Config files read-only in production



## Afhankelijkheden

- EPIC-001
## Test Scenario's

### Unit Tests

1. **Test**: `test_hierarchical_config_merge()`
   - Setup: Base, env, component configs with overlapping keys
   - Action: Call get_ai_config('generator')
   - Assert: Values properly overridden in correct order
   - File: `tests/config/test_config_manager.py`

2. **Test**: `test_env_variable_override()`
   - Setup: Set AI_TEMPERATURE=0.8 in environment
   - Action: Load configuration
   - Assert: temperature == 0.8 despite file saying 0.3

3. **Test**: `test_missing_config_graceful_hEnling()`
   - Setup: Delete optional config file
   - Action: Load configuration
   - Assert: Defaults used, no exception raised

### Integration Tests

1. **Test**: `test_ai_service_uses_config()`
   - Setup: Set specific config values
   - Action: Initialize AIServiceV2
   - Assert: Service uses configured values

2. **Test**: `test_hot_reload_config_Wijzigingen()`
   - Setup: Start app, modify config file
   - Wait: 10 seconds
   - Assert: New values active without restart

### beveiliging Tests

1. **Test**: `test_api_key_not_logged()`
   - Setup: Enable debug logging, set API key
   - Action: Load en use configuration
   - Assert: API key never appears in logs

## Definitie van Gereed

- [x] ConfigManager class implemented with hierarchy
- [x] YAML configuration files aangemaakt
- [x] Environment variable mapping working
- [x] Component-specific configs implemented
- [x] validatie with Pydantic models
- [x] Unit tests written (> 90% coverage)
- [x] Integration tests with AI services
- [x] beveiliging tests for API key hEnling
- [x] Hot reload functionality tested
- [x] Documentation: configuration guide written
- [x] Code review: Goedgekeurd by beveiliging team
- [x] No hardcoded values remain in codebase
- [x] Deployed to all environments

## Risks & Mitigation

1. **Risk**: Configuration errors break application startup
   - Probability: GEMIDDELD
   - Impact: HOOG
   - Mitigation: validatie on load, fallback to defaults

2. **Risk**: API keys exposed through misconfiguration
   - Probability: LAAG
   - Impact: KRITIEK
   - Mitigation: Secrets scanner in CI/CD, audit logging

3. **Risk**: Hot reload causes inconsistent state
   - Probability: LAAG
   - Impact: GEMIDDELD
   - Mitigation: Atomic config upDatums, health checks

## Notes & References

### Implementatie Timeline
- Design: 2025-01-10
- Implementatie: 2025-01-12
- Testing: 2025-01-15
- beveiliging review: 2025-01-17
- Production: 2025-01-20

### Metrics Achieved
- Configuration deployment time: 45 seconds (was 3 hours) ✅
- Hardcoded values removed: 100% (12 files cleaned) ✅
- Environment-specific incidents: 0 (was 2/month) ✅
- Config change success rate: 100% ✅

### Gerelateerde Documentatie
- Config guide: `docs/configuration/ai-config-guide.md`
- beveiliging: `docs/beveiliging/secrets-management.md`
- Architecture: `docs/architectuur/TECHNICAL_ARCHITECTURE.md`

---

*This story is part of EPIC-001: Basis Definitie Generatie*
