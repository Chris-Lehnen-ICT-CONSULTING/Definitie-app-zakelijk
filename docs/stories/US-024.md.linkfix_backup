---
id: US-024
epic: EPIC-006
title: API Key validatie at Startup
canonical: true
status: Nog te bepalen
owner: developer-implementer
last_verified: 2025-09-05
applies_to: definitie-app@current
type: enhancement
priority: HOOG
story_points: 3
sprint: backlog
Afhankelijkheden: [US-025, US-026]
aangemaakt: 2025-09-05
bijgewerkt: 2025-09-05
assigned_to: unassigned
---

# US-024: API Key validatie at Startup

## Gebruikersverhaal

**As a** system administrator
**wil ik** the application to valiDatum API keys at startup
**zodat** configuration errors are detected early en users receive immediate feedback about auDanticatie issues

## Acceptatiecriteria

### AC1: Startup validatie
**gegeven** the application is starting
**wanneer** initialization begins
**dan** the system:
- Checks for OpenAI API key presence
- ValiDatums API key format
- Tests API connectivity with minimal request
- Caches validatie result
- Provides clear error messages if validatie fails

### AC2: User Feedback
**gegeven** API key validatie fails
**wanneer** the user accesses the application
**dan** the system:
- Displays prominent warning banner
- Shows specific error (missing/invalid/expired)
- Provides instructions for resolution
- Links to configuration documentation
- AlLAAGs read-only access to non-API features

### AC3: Retry Mechanism
**gegeven** initial validatie fails
**wanneer** user upDatums API key configuration
**dan** the system:
- AlLAAGs manual re-validatie
- UpDatums validatie status without restart
- Clears error messages on success
- Maintains validatie history in logs

### AC4: Prestaties Impact
**gegeven** startup validatie is required
**wanneer** application initializes
**dan** validatie:
- Completes within 3 seconds
- Uses minimal API quota
- Runs asynchronously to not block UI
- Caches results for session duration

## Domain vereisten

### beveiliging StEnards
- Never log full API keys
- Mask API keys in error messages
- Store validatie state securely
- Implement rate limiting on validatie attempts

### compliance
- Log all auDanticatie attempts
- Maintain auditspoor for beveiliging review
- Support multiple API key configurations
- Enable key rotation without downtime

## Technische Notities

### Implementatie
- Add validatie to `ServiceContainer.__init__`
- Create `APIKeyValidator` service
- Implement startup hooks in `src/main.py`
- Add validatie status to session state

### validatie Process
1. Check environment variable presence
2. ValiDatum key format (sk-...)
3. Make test API call (models endpoint)
4. Store validatie result
5. Set application mode based on result

### Error States
- MISSING_KEY: No API key configured
- INVALID_FORMAT: Key doesn't match pattern
- AUDanTICATION_FAILED: Key rejected by API
- RATE_LIMITED: Too many validatie attempts
- CONNECTION_ERROR: Network issues



## Afhankelijkheden

- EPIC-006
## Test vereisten

### Unit Tests
- Validator with various key formats
- Error message generation
- Caching mechanism
- Retry logic

### Integration Tests
- Full startup sequence
- API communication
- Error recovery
- Session state management

### Edge Cases
- Expired keys
- Rate limited keys
- Network timeouts
- Malformed configurations

## Definitie van Gereed

- [ ] API key validator implemented
- [ ] Startup validatie integrated
- [ ] Error UI components aangemaakt
- [ ] Retry mechanism functional
- [ ] Caching implemented
- [ ] Unit tests >90% coverage
- [ ] Integration tests passing
- [ ] Prestaties vereisten met
- [ ] beveiliging review Voltooid
- [ ] Documentation bijgewerkt
- [ ] Error messages user-friendly

## Links

- Related vereisten: [REQ-024](../vereisten/REQ-024.md), [REQ-025](../vereisten/REQ-025.md)
- Epic: [EPIC-006-beveiliging-auth](../../EPIC-006-beveiliging-auth.md)
- Related: [US-025](US-025.md), [US-026](US-026.md)
- beveiliging richtlijnen: `docs/richtlijnen/beveiliging-stEnards.md`
