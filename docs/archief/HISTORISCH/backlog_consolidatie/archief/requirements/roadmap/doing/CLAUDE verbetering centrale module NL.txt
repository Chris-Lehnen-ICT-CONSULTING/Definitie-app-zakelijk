# ================================
# ðŸ—ï¸ GEREFACTORED DEFINITIE KWALITEIT SYSTEEM
# ================================

# ================================
# ðŸ“ BESTANDSSTRUCTUUR (Voorstel)
# ================================
"""
src/
â”œâ”€â”€ main.py                    # Streamlit toegangspunt
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ instellingen.py       # Applicatie instellingen
â”‚   â””â”€â”€ afhankelijkheden.py   # Dependency injection
â”œâ”€â”€ kern/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ modellen.py           # Datamodellen
â”‚   â”œâ”€â”€ services.py           # Bedrijfslogica services
â”‚   â””â”€â”€ uitzonderingen.py     # Aangepaste uitzonderingen
â”œâ”€â”€ ui/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ componenten.py        # Herbruikbare UI componenten
â”‚   â”œâ”€â”€ tabbladen.py          # Tabblad implementaties
â”‚   â””â”€â”€ status.py             # Status beheer
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ validatie.py          # Invoer validatie
â”‚   â””â”€â”€ opmaak.py             # Tekst opmaak utilities
â””â”€â”€ tests/
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ test_services.py
    â””â”€â”€ test_modellen.py
"""

# ================================
# ðŸ“‹ KERN MODELLEN (kern/modellen.py)
# ================================
from dataclasses import dataclass, field
from typing import List, Dict, Optional, Any
from datetime import datetime
from enum import Enum

class Prioriteit(Enum):
    LAAG = "laag"
    MIDDEL = "midden"
    HOOG = "hoog"

class TestResultaat(Enum):
    GESLAAGD = "âœ”ï¸"
    GEFAALD = "âŒ"
    INFO = "â„¹ï¸"

@dataclass
class Context:
    """Context informatie voor definitie generatie"""
    organisatorisch: List[str] = field(default_factory=list)
    juridisch: List[str] = field(default_factory=list)
    wettelijk: List[str] = field(default_factory=list)
    
    def naar_dict(self) -> Dict[str, List[str]]:
        return {
            "organisatorisch": self.organisatorisch,
            "juridisch": self.juridisch,
            "wettelijk": self.wettelijk
        }

@dataclass
class TestRegel:
    """Test regel voor definitie validatie"""
    id: str
    uitleg: str
    prioriteit: Prioriteit
    verplicht: bool = True
    
    @classmethod
    def van_dict(cls, gegevens: Dict[str, Any]) -> 'TestRegel':
        return cls(
            id=gegevens["id"],
            uitleg=gegevens["uitleg"],
            prioriteit=Prioriteit(gegevens.get("prioriteit", "midden")),
            verplicht=gegevens.get("aanbeveling") == "verplicht"
        )

@dataclass
class TestRegelResultaat:
    """Resultaat van het toepassen van een test regel"""
    regel_id: str
    resultaat: TestResultaat
    bericht: str
    details: Optional[str] = None

@dataclass
class Definitie:
    """Definitie met metadata"""
    tekst: str
    begrip: str
    context: Context
    originele_tekst: Optional[str] = None
    geschoonde_tekst: Optional[str] = None
    metadata: Dict[str, Any] = field(default_factory=dict)
    
    def krijg_weergave_tekst(self) -> str:
        """Krijg de beste versie van de definitie voor weergave"""
        return self.geschoonde_tekst or self.tekst

@dataclass
class DefinitieResultaat:
    """Compleet resultaat van definitie generatie en testen"""
    definitie: Definitie
    test_resultaten: List[TestRegelResultaat] = field(default_factory=list)
    voorbeelden: List[str] = field(default_factory=list)
    praktische_voorbeelden: List[str] = field(default_factory=list)
    tegenvoorbeelden: List[str] = field(default_factory=list)
    uitleg: str = ""
    synoniemen: List[str] = field(default_factory=list)
    antoniemen: List[str] = field(default_factory=list)
    bronnen: List[str] = field(default_factory=list)
    aangemaakt_op: datetime = field(default_factory=datetime.now)
    
    def krijg_slagings_percentage(self) -> float:
        """Bereken percentage van geslaagde tests"""
        if not self.test_resultaten:
            return 0.0
        geslaagd = sum(1 for r in self.test_resultaten if r.resultaat == TestResultaat.GESLAAGD)
        return (geslaagd / len(self.test_resultaten)) * 100

# ================================
# ðŸ”§ KERN SERVICES (kern/services.py)
# ================================
from abc import ABC, abstractmethod
from typing import Protocol

class AIService(Protocol):
    """Protocol voor AI services"""
    def genereer_definitie(self, begrip: str, context: Context) -> Definitie:
        ...
    
    def genereer_voorbeelden(self, definitie: Definitie) -> List[str]:
        ...
    
    def genereer_uitleg(self, definitie: Definitie) -> str:
        ...

class ValidatieService(Protocol):
    """Protocol voor validatie services"""
    def valideer_definitie(self, definitie: Definitie, regels: List[TestRegel]) -> List[TestRegelResultaat]:
        ...

class ExportService(Protocol):
    """Protocol voor export services"""
    def exporteer_naar_txt(self, resultaat: DefinitieResultaat) -> str:
        ...
    
    def exporteer_naar_csv(self, resultaten: List[DefinitieResultaat]) -> str:
        ...

class DefinitieService:
    """Hoofdservice voor definitie bewerkingen"""
    
    def __init__(
        self,
        ai_service: AIService,
        validatie_service: ValidatieService,
        export_service: ExportService
    ):
        self.ai_service = ai_service
        self.validatie_service = validatie_service
        self.export_service = export_service
    
    def maak_definitie(
        self,
        begrip: str,
        context: Context,
        test_regels: List[TestRegel]
    ) -> DefinitieResultaat:
        """Maak een complete definitie met validatie en voorbeelden"""
        try:
            # Genereer definitie
            definitie = self.ai_service.genereer_definitie(begrip, context)
            
            # Schoon en valideer
            definitie.geschoonde_tekst = self._schoon_definitie(definitie.tekst, begrip)
            test_resultaten = self.validatie_service.valideer_definitie(definitie, test_regels)
            
            # Genereer aanvullende inhoud
            voorbeelden = self.ai_service.genereer_voorbeelden(definitie)
            uitleg = self.ai_service.genereer_uitleg(definitie)
            
            return DefinitieResultaat(
                definitie=definitie,
                test_resultaten=test_resultaten,
                voorbeelden=voorbeelden,
                uitleg=uitleg
            )
            
        except Exception as e:
            # Log fout en geef minimaal resultaat terug
            return DefinitieResultaat(
                definitie=Definitie(
                    tekst=f"Fout bij genereren definitie: {str(e)}",
                    begrip=begrip,
                    context=context
                )
            )
    
    def _schoon_definitie(self, tekst: str, begrip: str) -> str:
        """Schoon definitie tekst van veelvoorkomende problemen"""
        # Importeer schoonmaak logica van bestaande opschoning module
        from opschoning.opschoning import opschonen
        return opschonen(tekst, begrip)

# ================================
# ðŸŽ›ï¸ CONFIGURATIE (config/instellingen.py)
# ================================
from pathlib import Path
from typing import Dict, List
import json

class Instellingen:
    """Applicatie instellingen"""
    
    def __init__(self):
        self.basis_dir = Path(__file__).parent.parent
        self.log_dir = self.basis_dir / "log"
        self.config_dir = self.basis_dir / "config"
        self.test_regels_bestand = self.config_dir / "toetsregels.json"
        self.verboden_woorden_bestand = self.config_dir / "verboden_woorden.json"
        
        # AI instellingen
        self.ai_model = "gpt-4"
        self.ai_temperatuur = 0.3
        self.ai_max_tokens = 1000
        
        # UI instellingen
        self.pagina_titel = "DefinitieAgent"
        self.pagina_icoon = "ðŸ§ "
    
    def laad_test_regels(self) -> List[TestRegel]:
        """Laad test regels uit configuratie"""
        try:
            with open(self.test_regels_bestand, 'r', encoding='utf-8') as f:
                gegevens = json.load(f)
                return [TestRegel.van_dict(regel) for regel in gegevens.values()]
        except FileNotFoundError:
            return []
    
    def laad_verboden_woorden(self) -> List[str]:
        """Laad verboden woorden uit configuratie"""
        try:
            with open(self.verboden_woorden_bestand, 'r', encoding='utf-8') as f:
                return json.load(f)
        except FileNotFoundError:
            return []

# ================================
# ðŸŽ¨ UI COMPONENTEN (ui/componenten.py)
# ================================
import streamlit as st
from typing import Callable, Optional

class UIComponenten:
    """Herbruikbare UI componenten"""
    
    @staticmethod
    def context_kiezer(
        label: str,
        opties: List[str],
        sleutel: str,
        sta_aangepast_toe: bool = True
    ) -> List[str]:
        """Herbruikbare context kiezer met optionele aangepaste invoer"""
        geselecteerd = st.multiselect(label, opties + (["Anders..."] if sta_aangepast_toe else []), key=sleutel)
        
        if sta_aangepast_toe and "Anders..." in geselecteerd:
            aangepast = st.text_input(f"Aangepaste {label.lower()}", key=f"{sleutel}_aangepast")
            geselecteerd = [opt for opt in geselecteerd if opt != "Anders..."]
            if aangepast.strip():
                geselecteerd.append(aangepast.strip())
        
        return geselecteerd
    
    @staticmethod
    def test_resultaten_weergave(resultaten: List[TestRegelResultaat], titel: str = "Test Resultaten"):
        """Toon test resultaten met juiste styling"""
        st.markdown(f"### {titel}")
        
        for resultaat in resultaten:
            bericht = f"{resultaat.resultaat.value} {resultaat.regel_id}: {resultaat.bericht}"
            
            if resultaat.resultaat == TestResultaat.GESLAAGD:
                st.success(bericht)
            elif resultaat.resultaat == TestResultaat.GEFAALD:
                st.error(bericht)
            else:
                st.info(bericht)
    
    @staticmethod
    def definitie_weergave(definitie: Definitie, toon_metadata: bool = True):
        """Toon definitie met optionele metadata"""
        st.markdown("### Definitie")
        st.markdown(definitie.krijg_weergave_tekst())
        
        if toon_metadata and definitie.metadata:
            with st.expander("Metadata", expanded=False):
                for sleutel, waarde in definitie.metadata.items():
                    st.write(f"**{sleutel}:** {waarde}")
    
    @staticmethod
    def export_sectie(resultaat: DefinitieResultaat, export_service: ExportService):
        """Export functionaliteit"""
        col1, col2 = st.columns(2)
        
        with col1:
            if st.button("ðŸ“¤ Exporteer naar TXT"):
                pad = export_service.exporteer_naar_txt(resultaat)
                st.success(f"âœ… GeÃ«xporteerd naar: {pad}")
        
        with col2:
            if st.button("ðŸ“Š Exporteer naar CSV"):
                pad = export_service.exporteer_naar_csv([resultaat])
                st.success(f"âœ… GeÃ«xporteerd naar: {pad}")

# ================================
# ðŸ“± STATUS BEHEER (ui/status.py)
# ================================
from typing import TypeVar, Generic, Optional, Dict, Any

T = TypeVar('T')

class SessieStatus:
    """Gecentraliseerd sessie status beheer"""
    
    def __init__(self):
        self._status = st.session_state
    
    def krijg(self, sleutel: str, standaard: Any = None) -> Any:
        """Krijg waarde uit sessie status"""
        return self._status.get(sleutel, standaard)
    
    def zet(self, sleutel: str, waarde: Any) -> None:
        """Zet waarde in sessie status"""
        self._status[sleutel] = waarde
    
    def wis(self, sleutel: str) -> None:
        """Wis specifieke sleutel uit sessie status"""
        if sleutel in self._status:
            del self._status[sleutel]
    
    def reset(self) -> None:
        """Reset alle sessie status"""
        self._status.clear()
    
    # Specifieke status eigenschappen
    @property
    def huidig_resultaat(self) -> Optional[DefinitieResultaat]:
        return self.krijg("huidig_resultaat")
    
    @huidig_resultaat.setter
    def huidig_resultaat(self, waarde: DefinitieResultaat) -> None:
        self.zet("huidig_resultaat", waarde)
    
    @property
    def toon_ai_testen(self) -> bool:
        return self.krijg("toon_ai_testen", False)
    
    @toon_ai_testen.setter
    def toon_ai_testen(self, waarde: bool) -> None:
        self.zet("toon_ai_testen", waarde)

# ================================
# ðŸ–¥ï¸ HOOFD APPLICATIE (main.py)
# ================================
import streamlit as st
from datetime import datetime
from config.instellingen import Instellingen
from config.afhankelijkheden import krijg_definitie_service
from ui.componenten import UIComponenten
from ui.status import SessieStatus
from kern.modellen import Context

def main():
    """Hoofd applicatie toegangspunt"""
    # Initialiseer
    instellingen = Instellingen()
    st.set_page_config(page_title=instellingen.pagina_titel, page_icon=instellingen.pagina_icoon)
    
    # Services
    definitie_service = krijg_definitie_service()
    test_regels = instellingen.laad_test_regels()
    
    # Status
    status = SessieStatus()
    ui = UIComponenten()
    
    # UI Header
    st.title("ðŸ§¾ Definitie Kwaliteit")
    
    # Invoer formulier
    with st.form("definitie_formulier"):
        begrip = st.text_input("Voer een term in waarvoor een definitie moet worden gegenereerd")
        
        # Context kiezers
        organisatorisch = ui.context_kiezer(
            "Organisatorische context",
            ["OM", "ZM", "Reclassering", "DJI", "NP", "Justid", "KMAR", "FIOD", "CJIB"],
            "org_context"
        )
        
        juridisch = ui.context_kiezer(
            "Juridische context",
            ["Strafrecht", "Civiel recht", "Bestuursrecht", "Internationaal recht"],
            "juridisch_context"
        )
        
        wettelijk = ui.context_kiezer(
            "Wettelijke basis",
            ["Wetboek van Strafvordering", "Wet op de Identificatieplicht", "Wetboek van Strafrecht"],
            "wettelijk_context"
        )
        
        datum = st.date_input("Datum voorstel", value=datetime.today())
        voorsteller = st.text_input("Voorgesteld door")
        
        ingediend = st.form_submit_button("Genereer definitie")
    
    # Verwerk formulier indiening
    if ingediend and begrip:
        context = Context(
            organisatorisch=organisatorisch,
            juridisch=juridisch,
            wettelijk=wettelijk
        )
        
        with st.spinner("Genereren van definitie..."):
            resultaat = definitie_service.maak_definitie(begrip, context, test_regels)
            status.huidig_resultaat = resultaat
    
    # Toon resultaten
    if status.huidig_resultaat:
        toon_resultaten(status.huidig_resultaat, ui, definitie_service)

def toon_resultaten(resultaat: DefinitieResultaat, ui: UIComponenten, definitie_service):
    """Toon definitie resultaten in tabbladen"""
    tab1, tab2, tab3 = st.tabs([
        "ðŸ¤– AI-gegenereerde definitie",
        "âœï¸ Aangepaste definitie", 
        "ðŸ“‹ Expert-review"
    ])
    
    with tab1:
        ui.definitie_weergave(resultaat.definitie)
        
        if resultaat.voorbeelden:
            st.markdown("### ðŸ” Voorbeelden")
            for voorbeeld in resultaat.voorbeelden:
                st.markdown(f"- {voorbeeld}")
        
        if resultaat.uitleg:
            st.markdown("### â„¹ï¸ Toelichting")
            st.info(resultaat.uitleg)
        
        # Schakelaar voor test resultaten
        if st.button("ðŸ“Š Toon/verberg AI-toetsing"):
            status = SessieStatus()
            status.toon_ai_testen = not status.toon_ai_testen
        
        if SessieStatus().toon_ai_testen:
            ui.test_resultaten_weergave(resultaat.test_resultaten, "AI-toetsing resultaten")
        
        ui.export_sectie(resultaat, definitie_service.export_service)
    
    with tab2:
        st.markdown("### âœï¸ Aangepaste definitie")
        # Implementatie voor aangepaste definitie tabblad
        pass
    
    with tab3:
        st.markdown("### ðŸ“‹ Expert-review")
        # Implementatie voor expert review tabblad
        pass

if __name__ == "__main__":
    main()

# ================================
# ðŸ”Œ DEPENDENCY INJECTION (config/afhankelijkheden.py)
# ================================
from kern.services import DefinitieService
from implementaties.ai_service import GPTAIService
from implementaties.validatie_service import RegelValidatieService
from implementaties.export_service import BestandExportService

def krijg_definitie_service() -> DefinitieService:
    """Factory functie voor definitie service met alle afhankelijkheden"""
    ai_service = GPTAIService()
    validatie_service = RegelValidatieService()
    export_service = BestandExportService()
    
    return DefinitieService(
        ai_service=ai_service,
        validatie_service=validatie_service,
        export_service=export_service
    )

# ================================
# ðŸ§ª VOORBEELD IMPLEMENTATIE (implementaties/ai_service.py)
# ================================
from kern.modellen import Definitie, Context
from kern.services import AIService
from prompt_builder.prompt_builder import stuur_prompt_naar_gpt

class GPTAIService(AIService):
    """GPT-gebaseerde AI service implementatie"""
    
    def genereer_definitie(self, begrip: str, context: Context) -> Definitie:
        """Genereer definitie met GPT"""
        prompt = self._bouw_prompt(begrip, context)
        
        reactie = stuur_prompt_naar_gpt(
            prompt,
            model="gpt-4",
            temperatuur=0.3,
            max_tokens=1000
        )
        
        return Definitie(
            tekst=reactie,
            begrip=begrip,
            context=context
        )
    
    def genereer_voorbeelden(self, definitie: Definitie) -> List[str]:
        """Genereer voorbeelden voor definitie"""
        prompt = f"Genereer 3 korte voorbeelden voor: {definitie.tekst}"
        reactie = stuur_prompt_naar_gpt(prompt, temperatuur=0.4, max_tokens=300)
        return [vb.strip() for vb in reactie.split('\n') if vb.strip()]
    
    def genereer_uitleg(self, definitie: Definitie) -> str:
        """Genereer uitleg voor definitie"""
        prompt = f"Geef een korte toelichting op: {definitie.tekst}"
        return stuur_prompt_naar_gpt(prompt, temperatuur=0.3, max_tokens=200)
    
    def _bouw_prompt(self, begrip: str, context: Context) -> str:
        """Bouw prompt voor definitie generatie"""
        # Gebruik bestaande prompt builder logica
        from prompt_builder.prompt_builder import PromptBouwer, PromptConfiguratie
        
        config = PromptConfiguratie(
            begrip=begrip,
            context_dict=context.naar_dict()
        )
        
        bouwer = PromptBouwer(config)
        return bouwer.bouw_prompt()

# ================================
# ðŸ“Š TEST VOORBEELD (tests/test_services.py)
# ================================
import unittest
from unittest.mock import Mock, patch
from kern.modellen import Definitie, Context, TestRegel, Prioriteit
from kern.services import DefinitieService

class TestDefinitieService(unittest.TestCase):
    """Test cases voor DefinitieService"""
    
    def setUp(self):
        self.ai_service = Mock()
        self.validatie_service = Mock()
        self.export_service = Mock()
        
        self.service = DefinitieService(
            self.ai_service,
            self.validatie_service,
            self.export_service
        )
    
    def test_maak_definitie_succes(self):
        """Test succesvolle definitie creatie"""
        # Regelen
        begrip = "Test begrip"
        context = Context(organisatorisch=["OM"])
        test_regels = [TestRegel("R1", "Test regel", Prioriteit.HOOG)]
        
        definitie = Definitie(tekst="Test definitie", begrip=begrip, context=context)
        self.ai_service.genereer_definitie.return_value = definitie
        self.ai_service.genereer_voorbeelden.return_value = ["Voorbeeld 1"]
        self.ai_service.genereer_uitleg.return_value = "Test uitleg"
        self.validatie_service.valideer_definitie.return_value = []
        
        # Handelen
        resultaat = self.service.maak_definitie(begrip, context, test_regels)
        
        # Bevestigen
        self.assertEqual(resultaat.definitie.begrip, begrip)
        self.assertEqual(len(resultaat.voorbeelden), 1)
        self.assertEqual(resultaat.uitleg, "Test uitleg")
    
    def test_maak_definitie_met_fout(self):
        """Test definitie creatie met AI service fout"""
        # Regelen
        begrip = "Test begrip"
        context = Context()
        test_regels = []
        
        self.ai_service.genereer_definitie.side_effect = Exception("AI Fout")
        
        # Handelen
        resultaat = self.service.maak_definitie(begrip, context, test_regels)
        
        # Bevestigen
        self.assertIn("Fout bij genereren definitie", resultaat.definitie.tekst)

if __name__ == '__main__':
    unittest.main()

# ================================
# ðŸŽ¯ SAMENVATTING VAN VERBETERINGEN
# ================================
"""
BELANGRIJKSTE VERBETERINGEN:

1. **Scheiding van Verantwoordelijkheden**
   - UI logica gescheiden van bedrijfslogica
   - Duidelijke service grenzen
   - Herbruikbare componenten

2. **Type Veiligheid**
   - Sterke typing met dataclasses
   - Protocols voor service interfaces
   - Betere foutbehandeling

3. **Testbaarheid**
   - Dependency injection
   - Mock-vriendelijke interfaces
   - Unit test voorbeelden

4. **Onderhoudbaarheid**
   - Modulaire bestandsstructuur
   - Duidelijke naamgevingsconventies
   - Gecentraliseerde configuratie

5. **Uitbreidbaarheid**
   - Plugin-stijl architectuur
   - Makkelijk nieuwe services toevoegen
   - Configureerbare componenten

6. **Prestaties**
   - Lazy loading
   - EfficiÃ«nt status beheer
   - Verminderde koppeling

7. **Foutbehandeling**
   - Consistente fout patronen
   - Gracieuze degradatie
   - Gebruiksvriendelijke berichten

MIGRATIE STRATEGIE:
1. Nieuwe bestandsstructuur maken
2. Bestaande functies naar juiste services verplaatsen
3. Imports geleidelijk updaten
4. Tests toevoegen voor kritieke paden
5. UI componenten refactoren
6. Configuratie beheer updaten
"""