<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EPIC-010 Direct Refactor Plan - Sprint 37</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">‚Üê Terug naar Portal</a>
    <p>---</p>
<p>titel: EPIC-010 Direct Refactor Plan - Sprint 37</p>
<p>aangemaakt: 2025-09-10</p>
<p>updated: 2025-09-10</p>
<p>status: Planning</p>
<p>prioriteit: KRITIEK</p>
<p>approach: DIRECT REFACTOR - GEEN BACKWARDS COMPATIBILITY</p>
<p>---</p>

<h1>üöÄ EPIC-010 Direct Refactor Plan - Sprint 37</h1>

<h2>Executive Summary</h2>

<p>Dit document beschrijft de DIRECTE refactor aanpak om EPIC-010 af te ronden in <strong>5 dagen</strong> i.p.v. 11 dagen. We volgen het "REFACTOR, GEEN BACKWARDS COMPATIBILITY" principe uit CLAUDE.md - alles wordt in √©√©n keer aangepast zonder migratiepaden.</p>

<h2>üìä Analyse Huidige Situatie</h2>

<h3>1. Sync Wrapper Status (service_factory.py)</h3>

<p><strong>Gevonden deprecated methods:</strong></p>
<ul>
<li>`generate_definition_sync()` op regel 404</li>
<li>`search_web_sources()` op regel 447</li>
</ul>

<p><strong>Kenmerken:</strong></p>
<ul>
<li>Beide gebruiken `asyncio.run()` voor sync-async conversie</li>
<li>Gemarkeerd met "DEPRECATED" en "TODO: Remove after UI migration"</li>
<li>Worden direct aangeroepen vanuit UI componenten</li>
</ul>

<h3>2. Async Bridge Status (ui/helpers/async_bridge.py)</h3>

<p><strong>Bestaande functionaliteit:</strong></p>
<ul>
<li>‚úÖ `run_async()` - Centrale async-to-sync conversie met timeout support</li>
<li>‚úÖ `generate_definition_sync()` - Wrapper voor definitie generatie</li>
<li>‚úÖ `search_web_sources_sync()` - Wrapper voor web lookup</li>
<li>‚úÖ Event loop detectie en thread-safe execution</li>
</ul>

<p><strong>Ontbrekende functionaliteit:</strong></p>
<ul>
<li>‚ö†Ô∏è Gecentraliseerde timeout configuratie</li>
<li>‚ö†Ô∏è Monitoring en metrics</li>
</ul>

<h3>3. CFR-BUG-014 Analyse</h3>

<p><strong>Probleem:</strong> Synoniemen/antoniemen generatie produceert inconsistente aantallen</p>

<p><strong>Gevonden issues:</strong></p>
<ol>
<li>**Prompt formaat** (regel 485-492 in unified_voorbeelden.py):</li>
</ol>
<ul>
<li>  - Prompts vragen om "EXACT X items"</li>
<li>  - Geen context of definitie meegegeven (alleen begrip)</li>
<li>  - Te simpele instructies voor complexe termen</li>
</ul>

<ol>
<li>**Parsing logic:**</li>
</ol>
<ul>
<li>  - Parser verwacht items op nieuwe regels</li>
<li>  - Geen fallback voor komma-gescheiden lijsten</li>
<li>  - Geen validatie op aantal geretourneerde items</li>
</ul>

<ol>
<li>**Response handling:**</li>
</ol>
<ul>
<li>  - max_tokens=2000 voor sync, 1500 voor async (inconsistent)</li>
<li>  - Geen retry bij te weinig items</li>
</ul>

<h2>‚ö° Direct Refactor Strategie</h2>

<h3>Waarom Direct Refactor?</h3>

<p>Per CLAUDE.md principes:</p>
<ul>
<li>**Single-user applicatie** - geen externe gebruikers</li>
<li>**Development omgeving** - errors tijdens refactor zijn acceptabel</li>
<li>**Clean code focus** - geen legacy baggage</li>
<li>**Fast feedback** - problemen direct zichtbaar en oplosbaar</li>
</ul>

<h3>Voorbereiding (30 minuten)</h3>

<pre><code># 1. Commit huidige staat voor rollback optie
git add -A
git commit -m "chore: checkpoint voor EPIC-010 direct refactor"

# 2. Maak refactor branch
git checkout -b refactor/epic-010-direct-completion

# 3. Identificeer alle te wijzigen locaties
echo "=== Sync wrapper calls in UI ==="
rg "generate_definition_sync|search_web_sources" src/ui/ --glob "!async_bridge.py"

echo "=== Deprecated methods in services ==="
rg "def (generate_definition_sync|search_web_sources)" src/services/

echo "=== Direct asyncio.run usage ==="
rg "asyncio\.run" src/ --glob "!async_bridge.py"</code></pre>

<h2>üìÖ 5-Daags Actieplan</h2>

<h3>Dag 1: CFR-BUG-014 Fix + Service Cleanup</h3>

<h4>Ochtend: Bug Fix (2 uur)</h4>

<p><strong>Bestanden om aan te passen:</strong></p>
<ul>
<li>`src/voorbeelden/unified_voorbeelden.py`</li>
</ul>

<p><strong>Acties:</strong></p>
<ol>
<li>Verbeter prompts voor synoniemen/antoniemen (voeg definitie + context toe)</li>
<li>Fix parser met komma-fallback</li>
<li>Voeg retry logic toe</li>
<li>Maak max_tokens consistent (2000 voor beide)</li>
</ol>

<h4>Middag: Service Cleanup (4 uur)</h4>

<p><strong>Bestanden om aan te passen:</strong></p>
<ul>
<li>`src/services/service_factory.py` - VERWIJDER deprecated methods</li>
<li>`src/ui/helpers/async_bridge.py` - Verificeer dat replacements werken</li>
</ul>

<p><strong>Acties:</strong></p>
<pre><code># In service_factory.py - VERWIJDER deze methods volledig:
# - generate_definition_sync() op regel 404-444
# - search_web_sources() op regel 447-472

# Geen deprecation warnings, geen comments - gewoon weg!</code></pre>

<h3>Dag 2: UI Direct Refactor</h3>

<h4>Ochtend: Alle UI Imports Updaten (3 uur)</h4>

<p><strong>Search & Replace Strategie:</strong></p>

<pre><code># 1. Identificeer alle files die aanpassing nodig hebben
rg -l "generate_definition_sync|search_web_sources" src/ui/ --glob "!async_bridge.py"

# 2. Voor elk bestand, pas het import pattern aan:</code></pre>

<p><strong>Van:</strong></p>
<pre><code>from services.service_factory import get_definition_service

def some_handler():
    factory = get_definition_service()
    result = factory.generate_definition_sync(begrip, context, **kwargs)</code></pre>

<p><strong>Naar:</strong></p>
<pre><code>from services.service_factory import get_definition_service
from ui.helpers.async_bridge import generate_definition_sync

def some_handler():
    factory = get_definition_service()
    result = generate_definition_sync(factory, begrip, context, **kwargs)</code></pre>

<h4>Middag: Test & Fix (3 uur)</h4>

<pre><code># 1. Start de app en kijk wat breekt
OPENAI_API_KEY="$OPENAI_API_KEY_PROD" streamlit run src/main.py

# 2. Voor elke error:
#    - Fix de import/call
#    - Test opnieuw
#    - Repeat

# 3. Test alle tabs systematisch:
#    - Definitie Generator tab
#    - Validatie tab
#    - Export functionaliteit
#    - Web lookup</code></pre>

<h3>Dag 3: Timeout Config + Async Cleanup</h3>

<h4>Ochtend: Implementeer Timeout Config (2 uur)</h4>

<p><strong>1. Voeg timeout config toe aan config_default.yaml:</strong></p>
<pre><code># Voeg toe aan config/config_default.yaml
timeouts:
  definition_generation: 30.0
  example_generation: 15.0
  validation: 10.0
  web_lookup: 15.0
  ui_default: 30.0</code></pre>

<p><strong>2. Update async_bridge.py met config loading:</strong></p>
<ul>
<li>Laad timeouts uit config</li>
<li>Pas toe op alle wrapper functions</li>
</ul>

<h4>Middag: Verwijder Alle Async Anti-patterns (4 uur)</h4>

<pre><code># 1. Vind alle directe asyncio.run usage
rg "asyncio\.run" src/ --glob "!async_bridge.py"

# 2. Voor elke gevonden locatie:
#    - Vervang met async_bridge.run_async()
#    - OF refactor naar proper async flow

# 3. Verwijder onnodige async complexity
rg "run_coroutine_threadsafe" src/ --glob "!async_bridge.py"</code></pre>

<h3>Dag 4: Test Suite Reparatie</h3>

<h4>Hele Dag: Fix Alle Failing Tests</h4>

<pre><code># 1. Run alle tests en capture failures
pytest tests/ -v &gt; test_failures.txt 2&gt;&amp;1

# 2. Common fixes nodig:
#    - Update mocks voor verwijderde sync methods
#    - Fix imports die niet meer bestaan
#    - Update test calls naar async_bridge

# 3. Focus op high-value test modules:
pytest tests/services/test_definition_generator.py    # 99% coverage
pytest tests/services/test_definition_validator.py    # 98% coverage
pytest tests/services/test_service_factory.py        # Fix voor removed methods

# 4. Itereer tot alles groen is
while ! pytest tests/ -q; do
    # Fix next failing test
    # Re-run
done</code></pre>

<h3>Dag 5: Documentatie & Final Verification</h3>

<h4>Ochtend: Update Documentatie (2 uur)</h4>

<p><strong>Te updaten files:</strong></p>
<ul>
<li>`docs/backlog/EPIC-010/EPIC-010.md` ‚Üí Status: 100% COMPLETE</li>
<li>`docs/architectuur/SOLUTION_ARCHITECTURE.md` ‚Üí Document async pattern</li>
<li>`CHANGELOG.md` ‚Üí Document breaking changes</li>
<li>Verwijder `docs/handover-epic-010-completion.md` (niet meer nodig)</li>
</ul>

<h4>Middag: Final Testing (4 uur)</h4>

<pre><code># 1. Full app test
OPENAI_API_KEY="$OPENAI_API_KEY_PROD" streamlit run src/main.py

# 2. Test elke functionaliteit:
#    - Genereer definitie
#    - Valideer definitie
#    - Genereer voorbeelden (vooral synoniemen/antoniemen!)
#    - Export naar PDF/Word
#    - Web lookup

# 3. Performance check
#    - Moet even snel zijn als voorheen
#    - Geen merkbare async overhead

# 4. Final commit
git add -A
git commit -m "feat: complete EPIC-010 - direct refactor zonder backwards compatibility"</code></pre>

<h2>‚úÖ Definition of Done Checklist</h2>

<h4>Na Dag 1:</h4>
<ul>
<li>[ ] CFR-BUG-014 opgelost (test: 5/5 synoniemen)</li>
<li>[ ] Deprecated methods verwijderd uit ServiceFactory</li>
<li>[ ] App start zonder errors</li>
</ul>

<h4>Na Dag 2:</h4>
<ul>
<li>[ ] Alle UI imports gebruik async_bridge</li>
<li>[ ] Geen directe factory.generate_definition_sync() calls meer</li>
<li>[ ] App volledig functioneel</li>
</ul>

<h4>Na Dag 3:</h4>
<ul>
<li>[ ] Timeout config werkend</li>
<li>[ ] Geen asyncio.run buiten async_bridge</li>
<li>[ ] Geen run_coroutine_threadsafe buiten async_bridge</li>
</ul>

<h4>Na Dag 4:</h4>
<ul>
<li>[ ] Alle tests groen</li>
<li>[ ] Test coverage minimaal gelijk gebleven</li>
</ul>

<h4>Na Dag 5:</h4>
<ul>
<li>[ ] EPIC-010 status: 100% COMPLETE</li>
<li>[ ] Documentatie bijgewerkt</li>
<li>[ ] Final test: alle functionaliteit werkt</li>
</ul>

<h2>üéØ Key Success Metrics</h2>

<p>| Metric | Target | Hoe Meten |</p>
<p>|--------|--------|-----------|</p>
<p>| Synoniemen/Antoniemen | 5/5 consistent | Test script |</p>
<p>| Test Pass Rate | 100% | pytest |</p>
<p>| Performance | <100ms overhead | Time measurements |</p>
<p>| Code Cleanliness | 0 deprecated | grep searches |</p>
<p>| App Stability | 0 crashes | Manual testing |</p>

<h2>üí™ Voordelen van Direct Refactor</h2>

<ol>
<li>**Sneller klaar**: 5 dagen i.p.v. 11 dagen</li>
<li>**Cleaner code**: Geen legacy baggage</li>
<li>**Minder complex**: Geen migration paths</li>
<li>**Direct feedback**: Errors meteen zichtbaar</li>
<li>**Geen technical debt**: Alles in √©√©n keer goed</li>
</ol>

<h2>üö´ Wat We NIET Doen</h2>

<ul>
<li>‚ùå Deprecation warnings</li>
<li>‚ùå Backwards compatibility layers</li>
<li>‚ùå Feature flags voor migratie</li>
<li>‚ùå Gefaseerde rollout</li>
<li>‚ùå Legacy support</li>
<li>‚ùå Migration helpers</li>
<li>‚ùå Compatibility tests</li>
</ul>

<h2>‚úÖ Wat We WEL Doen</h2>

<ul>
<li>‚úÖ Direct refactoren</li>
<li>‚úÖ Breaking changes accepteren</li>
<li>‚úÖ Tests fixen die breken</li>
<li>‚úÖ Business logica behouden</li>
<li>‚úÖ Clean architecture</li>
<li>‚úÖ Fast iteration</li>
</ul>

<h2>üìù Final Notes</h2>

<p>Dit plan volgt het "REFACTOR, GEEN BACKWARDS COMPATIBILITY" principe uit CLAUDE.md. We accepteren dat dingen tijdelijk breken tijdens development en fixen ze meteen. Dit is effici√´nter voor een single-user development applicatie.</p>

<p><strong>Remember</strong>: Als iets breekt, fix het. Geen workarounds, geen compatibility layers - gewoon de juiste oplossing implementeren.</p>

  </div>
</body>
</html>