<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DEF-38, DEF-35, DEF-106, DEF-45: Comprehensive Dependency & Impact Analysis</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">â† Terug naar Portal</a>
    <h1>DEF-38, DEF-35, DEF-106, DEF-45: Comprehensive Dependency & Impact Analysis</h1>

<p><strong>Date:</strong> 2025-11-05</p>
<p><strong>Analyst:</strong> Code Explorer</p>
<p><strong>Scope:</strong> All 4 issues + coupling analysis</p>
<p><strong>Status:</strong> Complete codebase mapping</p>

<p>---</p>

<h2>ğŸ“Š EXECUTIVE SUMMARY</h2>

<h3>Issue Overview</h3>

<p>| ID | Title | Type | Status | Est. Effort | Blocker | Blocked By |</p>
<p>|---|---|---|---|---|---|---|</p>
<p>| <strong>DEF-35</strong> | MVP Term-Based Classifier Essentials | Feature | OPEN | 16-20h | DEF-38, DEF-40 | None |</p>
<p>| <strong>DEF-38</strong> | Ontologische Promptinjecties (5 contradictions) | Bug/Fix | OPEN | 6-8h | DEF-40 | DEF-35 |</p>
<p>| <strong>DEF-106</strong> | PromptValidator Integration | Feature | OPEN | 4-6h | None | DEF-35 (partial) |</p>
<p>| <strong>DEF-45</strong> | Voorbeelden consistent met term | Enhancement | OPEN | 4h | None | DEF-69 |</p>

<h3>Critical Dependencies</h3>

<pre><code>DEF-35 (Classifier MVP)
â”œâ”€â”€ Unblocks: DEF-38 (prompt fixes depend on working classifier)
â”œâ”€â”€ Unblocks: DEF-40 (ontological enhancements)
â””â”€â”€ Coupled: DEF-106 (validator needs classifier confidence scores)

DEF-38 (Prompt Contradictions Fix)
â”œâ”€â”€ Blocked By: DEF-35 (can't validate fixes without classifier)
â”œâ”€â”€ Enables: Better prompt quality for DEF-106
â””â”€â”€ Coupled: Error prevention module shared with DEF-106

DEF-106 (PromptValidator Integration)
â”œâ”€â”€ Depends On: DEF-35 (for classification metadata)
â”œâ”€â”€ Can run parallel: With DEF-38 (different modules)
â””â”€â”€ Shared: prompt_orchestrator, modules

DEF-45 (Voorbeelden Consistency)
â”œâ”€â”€ Independent: Can run anytime
â”œâ”€â”€ Related: Uses classification result from DEF-35
â””â”€â”€ Data: Depends on DEF-69 (import service fix)</code></pre>

<p>---</p>

<h2>ğŸ”´ ISSUE 1: DEF-35 - MVP Term-Based Classifier</h2>

<h3>Status: **CRITICAL BLOCKER** for DEF-38, DEF-40</h3>

<h3>What It Is</h3>
<p>Improves the ontological classifier used in tabbed_interface.py to better determine TYPE/PROCES/RESULTAAT/EXEMPLAAR categories with 3-context support (organisatorische, juridische, wettelijke).</p>

<h3>Current Implementation</h3>
<ul>
<li>**Location:** `src/ontologie/improved_classifier.py`</li>
<li>**Already exists:** Full ImprovedOntologyClassifier with pattern matching</li>
<li>**Used by:** `src/ui/tabbed_interface.py` lines 251-270 (in `_determine_ontological_category()`)</li>
<li>**UI Integration:** Lines 283-299 (`_render_category_preview()`)</li>
</ul>

<h3>Files Affected</h3>
<pre><code>src/ontologie/improved_classifier.py         â† Main implementation (DONE)
src/ontologie/__init__.py                    â† Exports (DONE)
src/ui/tabbed_interface.py                   â† Integration point (NEEDS UPDATE)
  - Lines 251-270: _determine_ontological_category()
  - Lines 283-299: _render_category_preview()
src/services/container.py                    â† Classifier registration (NEEDS CHECK)</code></pre>

<h3>Coupling Points</h3>

<h4>1. **Tight Coupling: UI â†’ Classifier**</h4>
<pre><code># src/ui/tabbed_interface.py:251
from ontologie.improved_classifier import ImprovedOntologyClassifier
classifier = ImprovedOntologyClassifier()
result = classifier.classify(
    begrip=begrip,
    org_context=org_context,
    jur_context=jur_context,
    wet_context=""
)</code></pre>

<p><strong>Risk:</strong> UI directly instantiates classifier (no DI). If classifier changes, UI breaks.</p>

<h4>2. **Semantic Integration: Classifier â†’ SemanticCategorisationModule**</h4>
<p>The classifier determines the <code>ontological_category</code> which is then:</p>
<ol>
<li>Stored in `SessionStateManager.get_value("determined_category")`</li>
<li>Passed as `ontologische_categorie` in GenerationRequest</li>
<li>Read by SemanticCategorisationModule (lines 86-90):</li>
<pre><code>categorie = context.get_metadata("ontologische_categorie")
if categorie:
    context.set_shared("ontological_category", categorie)</code></pre>
</ol>

<p><strong>Risk:</strong> If classifier output format changes, module breaks.</p>

<h3>What DEF-35 Needs to Complete</h3>

<ol>
<li>**Add to ServiceContainer** (src/services/container.py):</li>
</ol>
<ul>
<li>  - Register ImprovedOntologyClassifier as singleton</li>
<li>  - Provide `get_ontology_classifier()` method</li>
</ul>

<ol>
<li>**Update UI Integration** (src/ui/tabbed_interface.py):</li>
</ol>
<ul>
<li>  - Use container instead of direct import</li>
<li>  - Handle async classification if needed</li>
</ul>

<ol>
<li>**Add Tests**:</li>
</ol>
<ul>
<li>  - Pattern matching accuracy tests</li>
<li>  - 3-context scoring tests</li>
<li>  - Edge cases (empty context, ambiguous terms)</li>
</ul>

<p>---</p>

<h2>ğŸ”´ ISSUE 2: DEF-38 - Ontologische Promptinjecties (5 Contradictions)</h2>

<h3>Status: **BLOCKED BY DEF-35**</h3>

<h3>What It Is</h3>
<p>Fix 5 contradictions in prompt modules where ESS-02 (semantic categorisation) instructions conflict with STR-01 (structure rules) and error prevention modules.</p>

<h3>The 5 Contradictions</h3>

<p>| # | Conflict | ESS-02 Says | STR-01/Error Says | Fix Needed |</p>
<p>|---|---|---|---|---|</p>
<p>| 1 | "is" usage | âœ… "Use 'is een activiteit'" | âŒ "Don't start with 'is'" | Exception clause |</p>
<p>| 2 | Container terms | âœ… "Use 'proces', 'activiteit'" | âŒ "Avoid container terms" | Exemption |</p>
<p>| 3 | Relative clauses | âœ… "Use 'die', 'waarbij'" | âŒ "Avoid 'die', 'waarin'" | Conditional |</p>
<p>| 4 | Article "een" | âœ… "Use 'een' in kick-off" | âŒ "No 'een' at start" | Exception |</p>
<p>| 5 | Context usage | âŒ "Don't mention context" | âœ… "Use context-specific" | Operational guide |</p>

<h3>Files Affected</h3>

<pre><code>src/services/prompts/modules/semantic_categorisation_module.py
  â”œâ”€ Lines 140-144: Base section with contradictions
  â”œâ”€ Lines 180-197: Category-specific guidance (PROCES example)
  â”œâ”€ Lines 182-185: "is een activiteit" injection
  â””â”€ Lines 200+: TYPE, RESULTAAT, EXEMPLAAR guidance

src/services/prompts/modules/structure_rules_module.py
  â”œâ”€ Lines 132-151: _build_str01_rule()
  â”œâ”€ Line 136: Example with "is een maatregel"
  â””â”€ Line 147: "âŒ is een" example

src/services/prompts/modules/error_prevention_module.py
  â”œâ”€ Lines 143-153: _build_basic_errors()
  â”œâ”€ Line 146: "âŒ Begin niet met lidwoorden ('een')"
  â”œâ”€ Line 147: "âŒ Geen koppelwerkwoord ('is')"
  â”œâ”€ Line 150: "âŒ Vermijd containerbegrippen"
  â”œâ”€ Line 151: "âŒ Vermijd bijzinnen ('die', 'waarin')"
  â”œâ”€ Lines 155-194: _build_forbidden_starters()
  â”œâ”€ Line 157: "is" in forbidden list
  â””â”€ Lines 196-248: _build_context_forbidden()</code></pre>

<h3>Coupling Analysis</h3>

<h4>1. **Module Interdependency**</h4>
<pre><code>PromptOrchestrator (orchestrator.py:354-372)
â”œâ”€ semantic_categorisation (Position 5)  â† ESS-02 instructions
â”œâ”€ structure_rules (Position 10)         â† STR-01 contradicts!
â”œâ”€ error_prevention (Position 14)        â† FORBIDS what ESS-02 says!</code></pre>

<p><strong>Problem:</strong> Execution order places contradictions in sequence. GPT-4 gets FIRST instruction A, then contradicting instruction NOT-A.</p>

<h4>2. **Shared State Channel**</h4>
<pre><code># semantic_categorisation_module.py:90
context.set_shared("ontological_category", categorie)

# definition_task_module.py:82
ontological_category = context.get_shared("ontological_category")</code></pre>

<p>All modules read the ontological_category from shared state. If ESS-02 sets a category, BOTH must respect its implications.</p>

<h4>3. **Prompt Content Injection**</h4>
<pre><code>ModuleContext (base_module.py:17-36)
â”œâ”€ content: str              â† What gets added to prompt
â”œâ”€ metadata: dict[str, Any]
â””â”€ shared_state: dict        â† Inter-module communication

# All modules execute in isolation but produce ordered sections:
PromptOrchestrator._combine_outputs() â†’ "\n\n".join(all_outputs)</code></pre>

<p><strong>Risk:</strong> Concatenation order matters. If error_prevention (position 14) contradicts semantic_categorisation (position 5), GPT-4 may follow the last instruction (recency bias).</p>

<h3>What DEF-38 Needs to Complete (Per DEF-102 Analysis)</h3>

<p><strong>Priority 1:</strong> Add ESS-02 exception notice</p>
<ul>
<li>File: `semantic_categorisation_module.py`</li>
<li>Lines 180+ (before guidance injection)</li>
<li>Add: "âš ï¸ EXCEPTION for Ontological Category (ESS-02)..."</li>
</ul>

<p><strong>Priority 2:</strong> Add STR-01 exception clause</p>
<ul>
<li>File: `structure_rules_module.py`  </li>
<li>Lines 132-151</li>
<li>Add: "âš ï¸ EXEMPTION: When ontological category marking (ESS-02) is used..."</li>
</ul>

<p><strong>Priority 3-5:</strong> Update error_prevention_module.py</p>
<ul>
<li>Modify forbidden_starters to note ESS-02 exception</li>
<li>Add conditions for "die"/"waarbij" usage</li>
<li>Clarify context usage rules with operational examples</li>
</ul>

<h3>Validation Requirement</h3>
<p><strong>Cannot be tested without DEF-35:</strong></p>
<ul>
<li>Classifier determines `ontological_category` metadata</li>
<li>That metadata is read by SemanticCategorisationModule</li>
<li>Fix validation requires comparing classifier output + prompt output</li>
<li>Without working classifier, can't validate that exceptions apply correctly</li>
</ul>

<p>---</p>

<h2>ğŸŸ¡ ISSUE 3: DEF-106 - PromptValidator Integration</h2>

<h3>Status: **PARTIALLY BLOCKED BY DEF-35**</h3>

<h3>What It Is</h3>
<p>Add a PromptValidator service to validate generated prompts for contradictions, coverage, and quality before sending to GPT-4.</p>

<h3>No Existing Implementation</h3>
<ul>
<li>**No files found** with "PromptValidator" (grep search returned 0 results)</li>
<li>Validator doesn't exist yet</li>
<li>Needs to be built</li>
</ul>

<h3>Required Architecture</h3>

<pre><code>PromptValidator (NEW)
â”œâ”€ Input: Complete prompt string + metadata
â”œâ”€ Output: ValidationResult with:
â”‚  â”œâ”€ is_valid: bool
â”‚  â”œâ”€ contradictions: list[str]
â”‚  â”œâ”€ coverage: dict[str, bool]  (ESS-02, STR-01, etc.)
â”‚  â”œâ”€ warnings: list[str]
â”‚  â””â”€ suggestions: list[str]
â””â”€ Integration point: UnifiedDefinitionGenerator
   (before calling AI service)

Integration Flow:
User Input â†’ ServiceContainer â†’ DefinitionOrchestrator
  â”œâ”€ Classifier.classify() â†’ ontological_category
  â”œâ”€ PromptOrchestrator.build_prompt() â†’ full prompt
  â”œâ”€ PromptValidator.validate() â† NEW! â† Needs DEF-38 validation rules
  â””â”€ (If valid) â†’ AIServiceV2.generate()
     (If invalid) â†’ Return validation errors to UI</code></pre>

<h3>Files Needed</h3>

<pre><code>src/services/validation/prompt_validator.py      â† NEW
  â”œâ”€ PromptValidator class
  â”œâ”€ PromptValidationResult dataclass
  â”œâ”€ Methods:
  â”‚  â”œâ”€ validate() â†’ ValidationResult
  â”‚  â”œâ”€ _check_contradictions()
  â”‚  â”œâ”€ _check_module_coverage()
  â”‚  â”œâ”€ _check_semantic_consistency()
  â”‚  â””â”€ _check_injection_safety()
  â””â”€ Tests in tests/services/validation/test_prompt_validator.py

src/services/interfaces.py      â† UPDATE
  â”œâ”€ Add PromptValidationResult interface
  â””â”€ Add PromptValidatorInterface (abstract)

src/services/container.py       â† UPDATE
  â”œâ”€ Register PromptValidator singleton
  â””â”€ Wire to UnifiedDefinitionGenerator

src/services/definition_generator.py â† UPDATE
  â”œâ”€ Call PromptValidator.validate()
  â”œâ”€ Handle validation errors
  â””â”€ Return errors to UI if invalid</code></pre>

<h3>Coupling Points</h3>

<h4>1. **Depends on Module Interfaces**</h4>
<p>To validate prompt coverage, validator needs to know:</p>
<ul>
<li>Which modules MUST be present</li>
<li>Which modules are optional per category</li>
<li>What injection points each module has</li>
</ul>

<p><strong>Coupled to:</strong></p>
<ul>
<li>`src/services/prompts/modules/prompt_orchestrator.py` (module registry)</li>
<li>`src/services/prompts/modules/base_module.py` (module interface)</li>
</ul>

<p><strong>Data needed:</strong></p>
<pre><code># From PromptOrchestrator
modules = orchestrator.get_registered_modules()
# Returns: [
#   {module_id, module_name, priority, dependencies, info}
# ]

# Validator extracts:
required_modules = {m["module_id"] for m in modules if m["priority"] &gt; 70}
optional_modules = {m["module_id"] for m in modules if m["priority"] &lt;= 70}</code></pre>

<h4>2. **Depends on Validation Rules (DEF-38)**</h4>
<p>To check for contradictions, validator needs rules from DEF-38:</p>

<pre><code># Examples from DEF-102 analysis
CONTRADICTION_RULES = {
    "is_usage": {
        "allows": ["semantic_categorisation"],  # ESS-02
        "forbids": ["error_prevention", "structure_rules"],
        "exception": "Only when ontological_category is set"
    },
    "container_terms": {
        "allows": ["semantic_categorisation"],
        "forbids": ["error_prevention"],
        "terms": ["proces", "activiteit"]
    },
    # ... etc
}</code></pre>

<p><strong>If DEF-38 not fixed yet:</strong></p>
<ul>
<li>Validator has outdated contradiction rules</li>
<li>False positives on valid prompts</li>
<li>**SOLUTION:** DEF-35 + DEF-38 must complete first, then DEF-106 adds validation rules</li>
</ul>

<h4>3. **Depends on Classifier (DEF-35)**</h4>
<pre><code># PromptValidator needs to know:
# - Which category was determined
# - Confidence level of determination
# - Context used for determination

# For validation like:
def _check_semantic_consistency(prompt, metadata):
    category = metadata.get("ontological_category")
    if category == "proces":
        # Check that prompt uses "activiteit"/"handeling" pattern
        if "is een" not in prompt:
            return Warning("ESS-02 PROCES pattern missing")</code></pre>

<p><strong>Blocked by:</strong> DEF-35 (needs classifier metadata format)</p>

<h3>What DEF-106 Needs to Complete</h3>

<ol>
<li>**Analyze existing validation patterns** (from DEF-38 analysis)</li>
<li>**Design PromptValidator interface**</li>
<li>**Implement contradiction detection**</li>
<li>**Implement module coverage checking**</li>
<li>**Integrate with GenerationRequest flow**</li>
<li>**Add comprehensive tests**</li>
<li>**Handle validation errors in UI**</li>
</ol>

<h3>Can Run Parallel With</h3>
<ul>
<li>DEF-38 (different concern: validation rules vs. prompt fixes)</li>
<li>However, should wait for DEF-38 completion to avoid duplicate work</li>
</ul>

<p>---</p>

<h2>ğŸŸ  ISSUE 4: DEF-45 - Voorbeelden Consistent with Term</h2>

<h3>Status: **INDEPENDENT** (no blockers)</h3>

<h3>What It Is</h3>
<p>Ensure voorbeeldzinnen (example sentences) are generated using the same ontological category and context as the definition itself.</p>

<h3>Current State</h3>

<pre><code>Definition Generation Flow:
User Input (Begrip + Context)
  â†“
Classifier determines ontological_category
  â†“
GenerationRequest created with ontologische_categorie
  â†“
DefinitionOrchestrator.create_definition()
  â”œâ”€ Generates definition via PromptOrchestrator
  â””â”€ Generates voorbeelden via unified_voorbeelden.py â† HERE!</code></pre>

<h3>Files Affected</h3>

<pre><code>src/voorbeelden/unified_voorbeelden.py
  â”œâ”€ Lines 75+: class ExampleRequest
  â””â”€ Lines 100+: generate_examples()
  â””â”€ NEEDS: ontologische_categorie field + context awareness

src/services/orchestrators/definition_orchestrator_v2.py
  â”œâ”€ create_definition() method
  â””â”€ NEEDS: Pass classifier result to voorbeelden generation

src/ui/components/definition_generator_tab.py
  â”œâ”€ NEEDS: Display voorbeelden with category context

tests/unit/voorbeelden_functionality_tests.py
  â”œâ”€ NEEDS: Tests for category-aware voorbeelden</code></pre>

<h3>Coupling Analysis</h3>

<h4>1. **Weak Coupling: Optional Enhancement**</h4>
<p>Voorbeelden generation is separate from definition generation. Can work with/without category awareness.</p>

<h4>2. **Data Flow Dependency**</h4>
<pre><code># Current (lacks context):
request = ExampleRequest(
    definitie=definition_text,
    term=term,
    context=generic_context
)
voorbeelden = example_generator.generate_examples(request)

# Needs DEF-35 for category:
request = ExampleRequest(
    definitie=definition_text,
    term=term,
    context=generic_context,
    ontologische_categorie=category,  â† From classifier (DEF-35)
    organisatorische_context=org_ctx,
    juridische_context=jur_ctx,
    wettelijke_basis=wet_ctx
)</code></pre>

<h4>3. **Related to DEF-69 (Data Loss)**</h4>
<p>The dependency graph shows DEF-45 blocked by DEF-69 (import service data loss).</p>

<p>This suggests: voorbeelden consistency depends on voorbeelden being saved correctly first.</p>

<h3>What DEF-45 Needs</h3>

<ol>
<li>**Update ExampleRequest** (voorbeelden.py:75)</li>
</ol>
<ul>
<li>  - Add `ontologische_categorie` field</li>
<li>  - Add context fields (organisatorische, juridische, wettelijke)</li>
</ul>

<ol>
<li>**Update example generator** (unified_voorbeelden.py)</li>
</ol>
<ul>
<li>  - Use category to guide example generation</li>
<li>  - Ensure examples match definition structure</li>
</ul>

<ol>
<li>**Update orchestrator** (definition_orchestrator_v2.py)</li>
</ol>
<ul>
<li>  - Pass classifier result to voorbeelden generation</li>
<li>  - Maintain consistency between definition + examples</li>
</ul>

<ol>
<li>**Add tests**</li>
</ol>
<ul>
<li>  - Examples match term category</li>
<li>  - Examples use correct context</li>
<li>  - Examples structure matches definition</li>
</ul>

<h3>No Direct Blockers</h3>
<ul>
<li>Can implement independently</li>
<li>Just needs classifier metadata available</li>
<li>DEF-69 fix ensures voorbeelden are saved (separate concern)</li>
</ul>

<p>---</p>

<h2>ğŸ“‹ DEPENDENCY GRAPH</h2>

<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DEF-35: Classifier MVP (16-20h)           â”‚
â”‚  âœ“ Implementation: Done                    â”‚
â”‚  âœ— Integration: Needs ServiceContainer DI  â”‚
â”‚  âœ— Tests: Needs unit tests                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”œâ”€â”€â”€â”€â”€â”€â†’ DEF-38 (Prompt Fixes: 6-8h)
             â”‚        â””â”€ BLOCKED: Needs classifier working
             â”‚           â”œâ”€ Validate fixes with real classifier
             â”‚           â”œâ”€ Check prompt generation quality
             â”‚           â””â”€ Contradiction detection
             â”‚
             â”œâ”€â”€â”€â”€â”€â”€â†’ DEF-40 (Ontological Enhancements)
             â”‚        â””â”€ BLOCKED: Needs classifier
             â”‚           â””â”€ Enhancement to semantic rules
             â”‚
             â”œâ”€â”€â”€â”€â”€â”€â†’ DEF-106 (PromptValidator: 4-6h)
             â”‚        â””â”€ PARTIALLY BLOCKED: Needs DEF-35 + DEF-38
             â”‚           â”œâ”€ Needs classifier metadata format
             â”‚           â”œâ”€ Needs contradiction rules from DEF-38
             â”‚           â””â”€ Can implement in parallel with DEF-38
             â”‚
             â””â”€â”€â”€â”€â”€â”€â†’ DEF-45 (Voorbeelden Consistency: 4h)
                      â””â”€ INDEPENDENT: No blockers
                         â”œâ”€ Uses classifier result from DEF-35
                         â”œâ”€ Related to (not blocked by) DEF-69
                         â””â”€ Can start anytime</code></pre>

<p>---</p>

<h2>ğŸ¯ RECOMMENDED IMPLEMENTATION ORDER</h2>

<h3>Phase 1: Foundation (DEF-35) - Week 1</h3>
<p><strong>Duration:</strong> 16-20 hours</p>
<p><strong>Deliverable:</strong> Working classifier in ServiceContainer</p>

<ol>
<li>**Finalize DEF-35**</li>
</ol>
<ul>
<li>  - Add ImprovedOntologyClassifier to ServiceContainer</li>
<li>  - Update UI to use DI instead of direct import</li>
<li>  - Add unit tests for classifier accuracy</li>
<li>  - Validate pattern matching on test corpus</li>
</ul>

<ol>
<li>**Validation Gate:** Classifier must correctly classify 90%+ of test cases</li>
</ol>

<h3>Phase 2: Bug Fixes (DEF-38) - Week 1-2</h3>
<p><strong>Duration:</strong> 6-8 hours</p>
<p><strong>Prerequisite:</strong> DEF-35 complete</p>
<p><strong>Deliverable:</strong> No contradictions in generated prompts</p>

<ol>
<li>**Add Exception Clauses** (in dependency order):</li>
</ol>
<ul>
<li>  - SemanticCategorisationModule: Add ESS-02 exception notice</li>
<li>  - StructureRulesModule: Add STR-01 exemption clause</li>
<li>  - ErrorPreventionModule: Add conditions (3 updates)</li>
</ul>

<ol>
<li>**Testing Strategy:**</li>
</ol>
<ul>
<li>  - Generate prompts for each category (TYPE, PROCES, RESULTAAT, EXEMPLAAR)</li>
<li>  - Check for contradictions in output</li>
<li>  - Compare with DEF-102 contradiction checklist</li>
</ul>

<ol>
<li>**Validation Gate:** Zero contradictions in test prompts</li>
</ol>

<h3>Phase 3A: Validation Layer (DEF-106) - Week 2</h3>
<p><strong>Duration:</strong> 4-6 hours</p>
<p><strong>Prerequisites:</strong> DEF-35 (for metadata), DEF-38 (for contradiction rules)</p>
<p><strong>Can run:</strong> PARALLEL with Phase 2 (different layers)</p>
<p><strong>Deliverable:</strong> Validator service + tests</p>

<ol>
<li>**Implement PromptValidator**</li>
</ol>
<ul>
<li>  - Create prompt_validator.py</li>
<li>  - Implement contradiction detection</li>
<li>  - Implement module coverage checking</li>
<li>  - Add to ServiceContainer</li>
</ul>

<ol>
<li>**Integrate with DefinitionGenerator**</li>
</ol>
<ul>
<li>  - Call validator before AI service</li>
<li>  - Return validation errors to UI</li>
<li>  - Add error handling</li>
</ul>

<ol>
<li>**Testing:** Validator catches 100% of known contradictions</li>
</ol>

<h3>Phase 3B: Enhancement (DEF-45) - Week 2</h3>
<p><strong>Duration:</strong> 4 hours</p>
<p><strong>Prerequisites:</strong> DEF-35 (for category metadata)</p>
<p><strong>Can run:</strong> PARALLEL with Phase 3A (independent concern)</p>
<p><strong>Deliverable:</strong> Category-aware voorbeelden</p>

<ol>
<li>**Update ExampleRequest** with category + context fields</li>
<li>**Update example generator** to use category</li>
<li>**Update orchestrator** to pass category</li>
<li>**Add tests** for consistency</li>
</ol>

<p>---</p>

<h2>âš ï¸ CRITICAL RISKS</h2>

<h3>Risk 1: Contradictions Persist After DEF-38</h3>
<p><strong>Impact:</strong> MEDIUM</p>
<p><strong>Likelihood:</strong> LOW</p>
<p><strong>Mitigation:</strong> DEF-106 validator catches contradictions; can return error instead of calling AI</p>

<h3>Risk 2: Classifier Output Format Changes</h3>
<p><strong>Impact:</strong> HIGH</p>
<p><strong>Likelihood:</strong> MEDIUM</p>
<p><strong>Mitigation:</strong> Lock classifier interface early; add backward compatibility layer</p>

<h3>Risk 3: Prompt Quality Gets Worse</h3>
<p><strong>Impact:</strong> HIGH</p>
<p><strong>Likelihood:</strong> LOW</p>
<p><strong>Mitigation:</strong> Compare generation quality before/after fixes using scoring metrics</p>

<h3>Risk 4: Data Loss During voorbeelden Update (DEF-45)</h3>
<p><strong>Impact:</strong> MEDIUM</p>
<p><strong>Likelihood:</strong> MEDIUM</p>
<p><strong>Mitigation:</strong> Fix DEF-69 first (import service data loss), then update voorbeelden</p>

<p>---</p>

<h2>ğŸ“Š COUPLING STRENGTH MATRIX</h2>

<pre><code>        DEF-35  DEF-38  DEF-106  DEF-45
DEF-35   -      ğŸ”´      ğŸ”´       ğŸŸ¡
DEF-38  ğŸ”´      -       ğŸŸ¡       âŒ
DEF-106 ğŸ”´      ğŸŸ¡      -        âŒ
DEF-45  ğŸŸ¡      âŒ      âŒ       -

Legend:
ğŸ”´ Strong coupling (blocks implementation)
ğŸŸ¡ Weak coupling (uses but can work around)
âŒ No coupling</code></pre>

<h3>Coupling Details</h3>

<h4>DEF-35 â†” DEF-38 (STRONG)</h4>
<ul>
<li>**Direction:** DEF-35 â†’ DEF-38</li>
<li>**Type:** Data dependency</li>
<li>**Why:** Classifier generates ontological_category that DEF-38 fixes depend on</li>
<li>**Mitigation:** Test DEF-38 fixes against classifier output</li>
</ul>

<h4>DEF-35 â†” DEF-106 (STRONG)</h4>
<ul>
<li>**Direction:** DEF-35 â†’ DEF-106</li>
<li>**Type:** Metadata dependency</li>
<li>**Why:** Validator needs classifier metadata format</li>
<li>**Mitigation:** Define metadata interface early</li>
</ul>

<h4>DEF-38 â†” DEF-106 (WEAK)</h4>
<ul>
<li>**Direction:** DEF-38 â†’ DEF-106</li>
<li>**Type:** Rule dependency</li>
<li>**Why:** Validator needs contradiction rules from fixes</li>
<li>**Mitigation:** Can implement validator rules as DEF-38 completes</li>
</ul>

<h4>DEF-35 â†” DEF-45 (WEAK)</h4>
<ul>
<li>**Direction:** DEF-35 â†’ DEF-45</li>
<li>**Type:** Data source</li>
<li>**Why:** DEF-45 uses category from classifier</li>
<li>**Mitigation:** Can use fallback category if classifier not ready</li>
</ul>

<p>---</p>

<h2>ğŸ” SHARED CODE ELEMENTS</h2>

<h3>Files Used by Multiple Issues</h3>

<pre><code>src/services/prompts/modules/prompt_orchestrator.py
â”œâ”€ DEF-35: Reads registered modules
â”œâ”€ DEF-38: Executes module with changes
â”œâ”€ DEF-106: Analyzes module coverage
â””â”€ DEF-45: Passes context through modules

src/services/prompts/modules/semantic_categorisation_module.py
â”œâ”€ DEF-35: Reads ontological_category from context
â”œâ”€ DEF-38: Gets modified (exception clauses added)
â””â”€ DEF-106: Validates semantic consistency

src/services/interfaces.py
â”œâ”€ DEF-35: GenerationRequest.ontologische_categorie
â”œâ”€ DEF-38: No changes
â”œâ”€ DEF-106: Needs PromptValidationResult (NEW)
â””â”€ DEF-45: ExampleRequest (updates needed)

src/services/container.py
â”œâ”€ DEF-35: Register classifier (NEW)
â”œâ”€ DEF-106: Register validator (NEW)
â””â”€ DEF-45: Updates to flow (minor)

src/ui/tabbed_interface.py
â”œâ”€ DEF-35: Use container instead of direct import
â”œâ”€ DEF-38: No changes (fixes are in modules)
â”œâ”€ DEF-106: Handle validation errors from prompt
â””â”€ DEF-45: Display category-aware voorbeelden</code></pre>

<h3>Shared Module Dependencies</h3>

<pre><code>src/services/prompts/modules/error_prevention_module.py
â”œâ”€ DEF-38: Gets modified (3 exception clauses)
â””â”€ DEF-106: Validator needs to know about these rules

src/services/prompts/modules/structure_rules_module.py
â”œâ”€ DEF-38: Gets modified (1 exception clause)
â””â”€ DEF-106: Validator checks this rule

src/ontologie/improved_classifier.py
â”œâ”€ DEF-35: Core implementation (mostly done)
â”œâ”€ DEF-38: Classifier must work to test fixes
â”œâ”€ DEF-106: Validator reads classifier output
â””â”€ DEF-45: Uses classifier category</code></pre>

<p>---</p>

<h2>ğŸ“‹ IMPLEMENTATION CHECKLIST</h2>

<h3>DEF-35: Classifier MVP</h3>

<ul>
<li>[ ] Move ImprovedOntologyClassifier to ServiceContainer</li>
<li>[ ] Remove direct imports in tabbed_interface.py</li>
<li>[ ] Add unit tests (90%+ accuracy target)</li>
<li>[ ] Test with database corpus</li>
<li>[ ] Validate metadata format output</li>
<li>[ ] Document classifier interface</li>
</ul>

<h3>DEF-38: Prompt Contradictions</h3>

<ul>
<li>[ ] Add ESS-02 exception notice (semantic_categorisation_module.py)</li>
<li>[ ] Add STR-01 exemption clause (structure_rules_module.py)</li>
<li>[ ] Modify error_prevention_module.py (3 updates)</li>
<li>[ ] Generate test prompts for each category</li>
<li>[ ] Compare against DEF-102 checklist</li>
<li>[ ] Manual validation with GPT-4</li>
<li>[ ] Update documentation</li>
</ul>

<h3>DEF-106: PromptValidator</h3>

<ul>
<li>[ ] Design validator interface</li>
<li>[ ] Implement contradiction detection</li>
<li>[ ] Implement module coverage checking</li>
<li>[ ] Add to ServiceContainer</li>
<li>[ ] Integrate with DefinitionGenerator</li>
<li>[ ] Write comprehensive tests</li>
<li>[ ] Add error handling in UI</li>
</ul>

<h3>DEF-45: Voorbeelden Consistency</h3>

<ul>
<li>[ ] Update ExampleRequest dataclass</li>
<li>[ ] Update unified_voorbeelden.py</li>
<li>[ ] Update definition_orchestrator_v2.py</li>
<li>[ ] Add category-aware logic to example generator</li>
<li>[ ] Write tests for consistency</li>
<li>[ ] Test with various categories</li>
</ul>

<p>---</p>

<h2>ğŸ“š Related Documentation</h2>

<ul>
<li>**DEF-102:** Injection Call Stack Analysis</li>
<li> - Details all 5 contradictions with exact line numbers</li>
</ul>

<ul>
<li>**ONTOLOGICAL_CATEGORIE_COMPREHENSIVE_EXPLORATION.md**</li>
<li> - Classification system architecture</li>
<li> - Pattern coverage bias analysis</li>
<li> - Database distribution of categories</li>
</ul>

<ul>
<li>**LINEAR_ISSUES_DEPENDENCY_RISK_ANALYSIS.md**</li>
<li> - Broader dependency chains</li>
<li> - Data loss risks (DEF-68, DEF-69, DEF-74)</li>
<li> - Implementation roadmap</li>
</ul>

<p>---</p>

<h2>âœ… SUCCESS CRITERIA</h2>

<h3>DEF-35 Success</h3>
<ul>
<li>[ ] Classifier in ServiceContainer</li>
<li>[ ] 90%+ accuracy on test corpus</li>
<li>[ ] No direct imports in UI</li>
<li>[ ] All tests pass</li>
</ul>

<h3>DEF-38 Success</h3>
<ul>
<li>[ ] Zero contradictions in generated prompts</li>
<li>[ ] All 5 contradiction fixes in place</li>
<li>[ ] Definition quality maintained/improved</li>
</ul>

<h3>DEF-106 Success</h3>
<ul>
<li>[ ] Validator catches 100% of known contradictions</li>
<li>[ ] No false positives on valid prompts</li>
<li>[ ] < 100ms validation time</li>
</ul>

<h3>DEF-45 Success</h3>
<ul>
<li>[ ] Examples use correct category patterns</li>
<li>[ ] Examples use specified context</li>
<li>[ ] 100% voorbeelden consistency with definition</li>
</ul>

<p>---</p>

<p><strong>Analysis Complete</strong> âœ…</p>
<p>Generated: 2025-11-05</p>
<p>Thoroughness: Comprehensive codebase mapping with all coupling points identified</p>


  </div>
</body>
</html>