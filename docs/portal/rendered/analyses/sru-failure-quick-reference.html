<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SRU Lookup Failures - Quick Reference Guide</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">← Terug naar Portal</a>
    <h1>SRU Lookup Failures - Quick Reference Guide</h1>
<p><strong>Date:</strong> 2025-10-08</p>
<p><strong>For:</strong> Development Team</p>

<p>---</p>

<h2>Problem Statement</h2>

<p><strong>Symptom:</strong> All SRU queries to overheid.nl return "No records found"</p>

<p><strong>Reality:</strong> Overheid.nl DOES have data - simple query "samenhang strafzaak" returns 3 results when tested directly</p>

<p><strong>Root Cause:</strong> Application adds too much context to queries, making them over-specific</p>

<p>---</p>

<h2>The Three Problems</h2>

<h3>1. Context Pollution (CRITICAL)</h3>

<p><strong>What happens:</strong></p>
<pre><code>User searches: "samenhang strafzaak"
Context detected: Sv, Wetboek van Strafvordering, OM, ZM, NP

Application builds query:
  (samenhang strafzaak) AND (Wetboek van Strafvordering OR Sv)

Result: 0 records (too specific!)</code></pre>

<p><strong>Why it's wrong:</strong></p>
<ul>
<li>Legal context (Sv, Wetboek) added as **REQUIRED** constraint (AND logic)</li>
<li>Documents about "samenhang strafzaak" don't always explicitly mention "Sv"</li>
<li>Over-specification filters out all relevant results</li>
</ul>

<p><strong>The fix:</strong></p>
<ul>
<li>Query term-only FIRST: `samenhang strafzaak` → Get all results</li>
<li>Add legal context SECOND (only if too many results): Refine to Sv-specific</li>
</ul>

<p>---</p>

<h3>2. Circuit Breaker Too Aggressive (HIGH)</h3>

<p><strong>What happens:</strong></p>
<pre><code>Query 1: DC fields with legal context → 0 results (empty count: 1)
Query 2: serverChoice all with legal context → 0 results (empty count: 2)
Circuit breaker triggers! (threshold: 2)

Queries 3-5 never execute:
  - Hyphen variant (not tried)
  - serverChoice any (not tried)
  - Wildcard fallback (not tried)</code></pre>

<p><strong>Why it's wrong:</strong></p>
<ul>
<li>Threshold of 2 is too low for legal queries with multiple fallback strategies</li>
<li>Fallback strategies that WOULD work never get a chance to execute</li>
</ul>

<p><strong>The fix:</strong></p>
<ul>
<li>Increase threshold to 4 (allow at least 4 query strategies before giving up)</li>
</ul>

<p>---</p>

<h3>3. Unknown Prefix "overheidnl" (MEDIUM)</h3>

<p><strong>What happens:</strong></p>
<pre><code>query = f'{query} AND overheidnl.collection="rijksoverheid"'</code></pre>

<p><strong>SRU server response:</strong></p>
<pre><code>&lt;diagnostic&gt;
  &lt;message&gt;Unsupported Index&lt;/message&gt;
  &lt;details&gt;unknown prefix overheidnl&lt;/details&gt;
&lt;/diagnostic&gt;</code></pre>

<p><strong>Why it's wrong:</strong></p>
<ul>
<li>`overheidnl.collection` is not a registered prefix in overheid.nl SRU endpoint</li>
<li>Should query SRU explain first to discover supported indexes</li>
</ul>

<p><strong>The fix:</strong></p>
<ul>
<li>Remove the collection filter (causes diagnostic errors)</li>
</ul>

<p>---</p>

<h2>Evidence Supporting Diagnosis</h2>

<h3>User Report</h3>
<blockquote>"Overheid.nl returns 3 results for simple queries like 'samenhang strafzaak'"</blockquote>

<h3>Log Evidence</h3>
<pre><code>2025-10-07 15:31:06,678 - Parsed 0 results from Wetgeving.nl
2025-10-07 15:31:06,680 - Parsed 0 results from Overheid.nl Zoekservice
2025-10-07 15:31:06,694 - Parsed 0 results from Overheid.nl
(Circuit breaker triggers here - remaining queries never execute)</code></pre>

<h3>Wikipedia Evidence</h3>
<pre><code>Wikipedia lookup voor term: verticaal NP Civiel recht
Geen Wikipedia pagina gevonden
(NP = Nederlandse Politie - not relevant to Wikipedia!)

Wikipedia lookup voor term: verticaal
SUCCESS! (term-only works)</code></pre>

<p><strong>Conclusion:</strong> Simpler queries work; context pollution breaks them.</p>

<p>---</p>

<h2>User Hypothesis Validation</h2>

<h3>Hypothesis 1: Organizational abbreviations break queries</h3>
<p><strong>Status:</strong> ✅ CONFIRMED (but already handled via <code>_strip_org_tokens()</code>)</p>
<p><strong>Impact:</strong> LOW (already mitigated)</p>

<h3>Hypothesis 2: Legal domain terms are too restrictive</h3>
<p><strong>Status:</strong> ✅ CONFIRMED - <strong>THIS IS THE PRIMARY ROOT CAUSE</strong></p>
<p><strong>Impact:</strong> CRITICAL</p>

<h3>Hypothesis 3: Wikipedia fails due to context specificity</h3>
<p><strong>Status:</strong> ✅ CONFIRMED (organizational tokens leak into Wikipedia)</p>
<p><strong>Impact:</strong> HIGH</p>

<p>---</p>

<h2>Query Strategy Comparison</h2>

<h3>Current Strategy (Precision-First)</h3>

<pre><code>1. Query: (term) AND (legal context) → 0 results
2. Query: serverChoice all + legal context → 0 results
3. Circuit breaker triggers (threshold: 2)
4-5. Fallback queries never execute

Result: 0% success rate</code></pre>

<h3>Recommended Strategy (Recall-First)</h3>

<pre><code>1. Query: term only → Get all relevant results
2. If &gt;50 results: Add legal context → Refine to specific law
3. Hyphen variant → Alternative word form
4. Wildcard fallback → Partial match

Result: Expected 70-80% success rate</code></pre>

<p>---</p>

<h2>Quick Wins (High-Impact, Low-Effort)</h2>

<h3>Fix 1: Increase Circuit Breaker Threshold</h3>
<p><strong>File:</strong> <code>config/web_lookup_defaults.yaml</code> line 85</p>
<p><strong>Change:</strong> <code>consecutive_empty_threshold: 2</code> → <code>4</code></p>
<p><strong>Impact:</strong> Allows fallback strategies to execute</p>
<p><strong>Effort:</strong> 1 line change</p>

<h3>Fix 2: Remove Invalid Collection Filter</h3>
<p><strong>File:</strong> <code>src/services/web_lookup/sru_service.py</code> lines 689-690</p>
<p><strong>Change:</strong> Comment out <code>overheidnl.collection</code> filter</p>
<p><strong>Impact:</strong> Eliminates diagnostic errors</p>
<p><strong>Effort:</strong> 2 lines commented</p>

<h3>Fix 3: Reverse Query Order</h3>
<p><strong>File:</strong> <code>src/services/web_lookup/sru_service.py</code> lines 449-554</p>
<p><strong>Change:</strong> Execute term-only query BEFORE legal context query</p>
<p><strong>Impact:</strong> Maximizes recall, legal context becomes refinement</p>
<p><strong>Effort:</strong> Reorder query execution sequence</p>

<p>---</p>

<h2>Expected Outcomes</h2>

<h3>Before Fixes</h3>
<ul>
<li>**SRU Success Rate:** 0%</li>
<li>**Circuit Breaker Triggers:** After 2 failures</li>
<li>**Fallback Strategies:** Never execute</li>
<li>**User Experience:** No external legal sources in definitions</li>
</ul>

<h3>After Fixes</h3>
<ul>
<li>**SRU Success Rate:** 70-80% (estimated)</li>
<li>**Circuit Breaker Triggers:** After 4 failures (allows fallbacks)</li>
<li>**Fallback Strategies:** Hyphen/wildcard variants execute</li>
<li>**User Experience:** Authoritative legal sources enrich definitions</li>
</ul>

<p>---</p>

<h2>Code Locations for Reference</h2>

<p>| Issue | File | Lines | Description |</p>
<p>|-------|------|-------|-------------|</p>
<p>| Circuit Breaker Config | <code>config/web_lookup_defaults.yaml</code> | 84-91 | Threshold settings |</p>
<p>| Circuit Breaker Logic | <code>src/services/web_lookup/sru_service.py</code> | 434-494 | Query loop + breaker |</p>
<p>| Query Construction | <code>src/services/web_lookup/sru_service.py</code> | 606-700 | CQL query builder |</p>
<p>| Invalid Prefix | <code>src/services/web_lookup/sru_service.py</code> | 689-690 | Collection filter |</p>
<p>| Context Classification | <code>src/services/modern_web_lookup_service.py</code> | 177-239 | Token classification |</p>
<p>| Stage-Based Backoff | <code>src/services/modern_web_lookup_service.py</code> | 620-634 | SRU stage logic |</p>
<p>| Wikipedia Context | <code>src/services/modern_web_lookup_service.py</code> | 431-442 | Wikipedia stages |</p>

<p>---</p>

<h2>Testing Recommendations</h2>

<h3>Test 1: Simple Term Query</h3>
<p><strong>Query:</strong> "samenhang strafzaak" (no context)</p>
<p><strong>Expected:</strong> Should return 3 results from overheid.nl</p>
<p><strong>Validates:</strong> Basic SRU connectivity works</p>

<h3>Test 2: Term with Legal Context</h3>
<p><strong>Query:</strong> "(samenhang strafzaak) AND (Sv)"</p>
<p><strong>Expected:</strong> Should return 0 results (too specific)</p>
<p><strong>Validates:</strong> Confirms legal context is the problem</p>

<h3>Test 3: Circuit Breaker Threshold</h3>
<p><strong>Setup:</strong> Set threshold to 4, force 3 consecutive failures</p>
<p><strong>Expected:</strong> Query 4 should still execute</p>
<p><strong>Validates:</strong> Circuit breaker respects threshold</p>

<h3>Test 4: Wikipedia Without Org Context</h3>
<p><strong>Query:</strong> "verticaal" (no NP/OM/ZM)</p>
<p><strong>Expected:</strong> Should find Wikipedia page</p>
<p><strong>Validates:</strong> Organizational context is filtered out</p>

<p>---</p>

<h2>Summary</h2>

<p><strong>Root Cause:</strong> Legal context tokens (Sv, Wetboek van Strafvordering) are added as <strong>required constraints</strong> (AND logic), filtering out all results that don't explicitly mention the law code.</p>

<p><strong>User Impact:</strong> 100% SRU lookup failure rate; definitions lack authoritative external sources.</p>

<p><strong>Solution:</strong> Three quick wins:</p>
<ol>
<li>Increase circuit breaker threshold (4 instead of 2)</li>
<li>Remove invalid `overheidnl.collection` filter</li>
<li>Reverse query order (term-only first, legal context second)</li>
</ol>

<p><strong>Expected Improvement:</strong> From 0% to 70-80% SRU success rate with these changes.</p>

<p>---</p>

<p><strong>See full analysis:</strong> <code>/docs/analyses/sru-web-lookup-failure-analysis.md</code></p>

  </div>
</body>
</html>