<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Linear Issues - Multiagent Consensus Roadmap</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">‚Üê Terug naar Portal</a>
    <h1>Linear Issues - Multiagent Consensus Roadmap</h1>
<p><strong>Status</strong>: FINAL | <strong>Date</strong>: 2025-10-30 | <strong>Agents</strong>: debug-specialist, full-stack-developer, code-reviewer</p>

<h2>üéØ Executive Summary</h2>

<p><strong>28 Linear issues analyseerd</strong> door 3 gespecialiseerde AI agents met <strong>volledige consensus</strong> op uitvoervolgorde.</p>

<h3>Urgent Action Items (Deze Week!)</h3>

<p><strong>üö® CRITICAL - Week 1 (14-17 uur):</strong></p>
<ul>
<li>**3 data loss bugs** (DEF-68, DEF-69, DEF-74) ‚Üí MOET EERST</li>
<li>**SessionState violations** (DEF-73) ‚Üí Compliance fix</li>
<li>**Performance quick win** (DEF-60) ‚Üí 65% sneller</li>
</ul>

<p><strong>üìä Key Metrics:</strong></p>
<ul>
<li>**Effort**: 14-17 uur Week 1 ‚Üí 40-60 uur Weeks 2-4 (optional)</li>
<li>**ROI**: 9/10 (voorkomt data loss + 65% performance boost)</li>
<li>**Risk**: 3/10 (LOW - met juiste rollback strategie)</li>
</ul>

<h3>Roadmap Overview</h3>

<pre><code>Week 1: Quick Wins + Performance (14-17h) ‚úÖ MANDATORY
Week 2: Classifier MVP (16-20h) ‚ö†Ô∏è OPTIONAL
Weeks 3-4: God Object Cleanup (40-60h) üü¢ NICE-TO-HAVE</code></pre>

<p>---</p>

<h2>üìã Consensus Timeline</h2>

<h3>Phase 1A: Logging Infrastructure (2 uur) - DAG 1 OCHTEND</h3>
<p><strong>Rationale</strong>: Observability BEFORE validation enables debugging of downstream fixes</p>

<pre><code>Execution Order (PARALLEL uitvoering mogelijk):
‚îú‚îÄ DEF-68: Silent context validation logging (15 min)
‚îÇ   Location: src/services/validation/mappers.py
‚îÇ   Risk: ZERO (logging-only)
‚îÇ   Validation: Check logs/ for ValidationError entries
‚îÇ
‚îî‚îÄ DEF-69: Silent voorbeelden save logging (15 min)
    Location: src/voorbeelden/unified_voorbeelden.py
    Risk: ZERO (logging-only)
    Validation: Force failure, verify error logged

Total: 30 minuten (kan parallel)</code></pre>

<p><strong>Success Criteria:</strong></p>
<ul>
<li>‚úÖ All validation errors appear in `logs/app.log`</li>
<li>‚úÖ Structured logging: `logger.error(f"Context validation failed: {e}", exc_info=True)`</li>
<li>‚úÖ No business logic changes</li>
</ul>

<p><strong>Why This Order?</strong></p>
<ul>
<li>**Debug-specialist** wanted DEF-74 first (validation before save)</li>
<li>**Full-stack-developer** wanted DEF-68 first (logging before validation)</li>
<li>**Code-reviewer consensus**: Logging infrastructure enables debugging Phase 1B</li>
<li>**Historical proof**: voorbeelden-data-loss-2025-10-30.md incident shows logging gaps cause silent failures</li>
</ul>

<p>---</p>

<h3>Phase 1B: Validation Chain (4-5 uur) - DAG 1 MIDDAG</h3>
<p><strong>Rationale</strong>: SEQUENTIAL execution mandatory - each depends on previous</p>

<pre><code>Execution Order (SEQUENTIAL - NO PARALLEL):
‚îú‚îÄ DEF-74: Enforce Pydantic validation (2h)
‚îÇ   Blocker: DEF-68/DEF-69 logging MUST be live first
‚îÇ   Location: src/database/definitie_repository.py line 1453
‚îÇ   Risk: LOW (schema exists, just add enforcement)
‚îÇ   Validation: Invalid input ‚Üí ValidationError + logged
‚îÇ
‚îú‚îÄ DEF-69: Fix voorbeelden save error handling (3-4h)
‚îÇ   Blocker: DEF-74 validation MUST work first
‚îÇ   Location: src/services/definition_import_service.py line ~150
‚îÇ   Risk: MEDIUM (touches import flow)
‚îÇ   Validation: Import with invalid data ‚Üí User sees error
‚îÇ
‚îî‚îÄ DEF-73: Fix SessionState violations (15 min)
    Blocker: None (but benefits from stable logging)
    Location: src/ui/ modules (10 violations found)
    Risk: LOW (mechanical refactor)
    Validation: pre-commit run streamlit-anti-patterns --all-files

Total: 4-5 hours (MUST be sequential)</code></pre>

<p><strong>Success Criteria:</strong></p>
<ul>
<li>‚úÖ Pydantic validation rejects invalid voorbeelden types</li>
<li>‚úÖ Import failures show UI warnings (not silent)</li>
<li>‚úÖ Zero direct `st.session_state` access outside `SessionStateManager`</li>
<li>‚úÖ Full test suite passes: `pytest tests/ -q`</li>
</ul>

<p><strong>Why Sequential?</strong></p>
<ol>
<li>**DEF-74 validates** ‚Üí DEF-69 can trust validation results</li>
<li>**DEF-69 handles errors** ‚Üí Safe to add to import flow</li>
<li>**DEF-73 compliance** ‚Üí Enables safer state management for future work</li>
</ol>

<p>---</p>

<h3>Phase 1C: Performance Quick Win (4 uur) - DAG 2</h3>
<p><strong>Rationale</strong>: Proven 65% improvement from US-202, low risk</p>

<pre><code>Single Issue (HIGH ROI):
‚îî‚îÄ DEF-60: Lazy loading for 5 services (4h)
    Dependencies: Phase 1A/1B complete (logging enables debugging)
    Location: src/services/container.py
    Risk: MEDIUM (changes initialization flow)
    Validation: Startup time &lt; 3 seconds (baseline: ~5-7s)

Services to defer:
1. ModernWebLookupService (no dependencies)
2. SynonymOrchestrator (depends on WebLookup)
3. PromptOrchestrator (16 modules - heaviest)
4. CategoryServiceV2 (depends on PromptOrchestrator)
5. DefinitionImportService (depends on multiple services)</code></pre>

<p><strong>Implementation Pattern:</strong></p>
<pre><code>class ServiceContainer:
    _web_lookup = None

    @property
    def web_lookup(self) -&gt; ModernWebLookupService:
        if self._web_lookup is None:
            logger.info("üîß Lazy init: ModernWebLookupService")
            self._web_lookup = ModernWebLookupService()
        return self._web_lookup</code></pre>

<p><strong>Success Criteria:</strong></p>
<ul>
<li>‚úÖ Startup time: 5-7s ‚Üí < 3s (measured via logs)</li>
<li>‚úÖ Service count at startup: 27 ‚Üí 22 (5 deferred)</li>
<li>‚úÖ All UI tabs still work (full smoke test)</li>
<li>‚úÖ No regressions in test suite</li>
</ul>

<p>---</p>

<h3>Phase 2: Classifier MVP (16-20 uur) - WEEK 2 (OPTIONAL)</h3>
<p><strong>Rationale</strong>: New feature, not a fix - can be deferred if critical bugs arise</p>

<pre><code>Single Feature (NEW capability):
‚îî‚îÄ DEF-35: Term-Based Classifier Essentials (16-20h)
    Dependencies: None (orthogonal to refactoring)
    Location: src/ontologie/ (new module)
    Risk: LOW (additive feature)
    Validation: 80%+ accuracy on known terms

Implementation Phases:
1. Config externalization (3h)
   - Create config/classification/term_patterns.yaml
   - Load via Pydantic config

2. Priority cascade (1h)
   - Implement tiebreaker logic
   - Test with tied scores

3. Confidence scoring (2h)
   - Calculate separation scores
   - Return HIGH/MEDIUM/LOW labels

4. Integration (2h)
   - Add to definition generator UI
   - Display confidence badges

5. Testing (8-12h)
   - Golden dataset (20 cases)
   - Edge cases (ambiguous terms)
   - Dutch morphology patterns</code></pre>

<p><strong>Success Criteria:</strong></p>
<ul>
<li>‚úÖ YAML config loads without errors</li>
<li>‚úÖ Domain overrides work (machtiging ‚Üí TYPE)</li>
<li>‚úÖ Priority cascade resolves tied scores</li>
<li>‚úÖ Confidence labels guide user decisions</li>
<li>‚úÖ 80%+ accuracy on validation set</li>
</ul>

<p><strong>Why Phase 2?</strong></p>
<ul>
<li>Not blocking other work</li>
<li>Requires stable architecture (benefits from Phase 1 fixes)</li>
<li>Can be deferred if Week 1 reveals critical issues</li>
</ul>

<p>---</p>

<h3>Phases 3-4: God Object Cleanup (40-60 uur) - WEEKS 3-4 (NICE-TO-HAVE)</h3>

<p><strong>üü¢ OPTIONAL - Only if:</strong></p>
<ul>
<li>Phases 1-2 complete successfully</li>
<li>No critical bugs discovered</li>
<li>Time budget allows (solo developer constraint)</li>
</ul>

<pre><code>Refactoring Tasks (SEQUENTIAL execution):
‚îú‚îÄ DEF-70: ServiceContainer ‚Üí Module Singletons (40h)
‚îÇ   Risk: VERY HIGH (core architecture)
‚îÇ   Effort: 1 week
‚îÇ   Blocker: Phase 1 performance fixes MUST be stable
‚îÇ
‚îú‚îÄ DEF-71: DefinitieRepository ‚Üí Domain Repos (40h)
‚îÇ   Risk: HIGH (database layer, data loss potential)
‚îÇ   Effort: 1 week
‚îÇ   Blocker: DEF-70 (easier DI after container refactor)
‚îÇ
‚îî‚îÄ DEF-72: Directory consolidation 34‚Üí8 (40h)
    Risk: MEDIUM (import path changes)
    Effort: 1 week
    Blocker: DEF-70, DEF-71 (code must be stable)</code></pre>

<p><strong>Why Optional?</strong></p>
<ul>
<li>High risk (architecture changes)</li>
<li>Not blocking features</li>
<li>Solo developer = limited capacity</li>
<li>Better to defer if critical bugs arise</li>
</ul>

<p><strong>If Executed:</strong></p>
<ul>
<li>Database backup MANDATORY: `cp data/definities.db data/backups/pre-refactor-$(date +%Y%m%d).db`</li>
<li>Incremental commits with tests</li>
<li>Daily backups during migration week</li>
<li>Full regression suite after each change</li>
</ul>

<p>---</p>

<h2>üö® Dependency Resolution: The Conflict</h2>

<h3>Original Agent Disagreement</h3>

<p><strong>Debug-Specialist Position:</strong></p>
<ul>
<li>DEF-74 FIRST (validation before save)</li>
<li>Rationale: Prevent invalid data from entering system</li>
<li>Risk: Without validation, downstream saves may fail silently</li>
</ul>

<p><strong>Full-Stack-Developer Position:</strong></p>
<ul>
<li>DEF-68 FIRST (logging before validation)</li>
<li>Rationale: Observability enables debugging of validation failures</li>
<li>Risk: Without logging, can't debug why validation fails</li>
</ul>

<h3>Consensus Resolution: HYBRID APPROACH</h3>

<p><strong>Phase 1A (Logging)</strong> ‚Üí <strong>Phase 1B (Validation Chain)</strong></p>

<p><strong>Why This Works:</strong></p>
<ol>
<li>**Logging infrastructure** (Phase 1A) ‚Üí Enables debugging Phase 1B</li>
<li>**Validation chain** (Phase 1B) ‚Üí Sequential execution respects dependencies</li>
<li>**Historical evidence** ‚Üí voorbeelden-data-loss-2025-10-30.md proves logging gaps cause silent failures</li>
</ol>

<p><strong>Code-Reviewer Verdict:</strong></p>
<blockquote>"The hybrid execution order (Phase 1A logging ‚Üí validation chain) is the correct technical decision because:</blockquote>
<blockquote>- Observability first enables debugging of subsequent fixes</blockquote>
<blockquote>- Sequential validation chain respects technical dependencies</blockquote>
<blockquote>- Historical context prevents repeat of database tracking incident"</blockquote>

<p>---</p>

<h2>üìä Risk Assessment Matrix</h2>

<p>| Issue | P0/P1/P2 | Risk | Effort | ROI | Phase |</p>
<p>|-------|----------|------|--------|-----|-------|</p>
<p>| DEF-68 | P0 | 10/10 | 15min | 9.5/10 | 1A |</p>
<p>| DEF-69 | P0 | 10/10 | 15min | 9.0/10 | 1A |</p>
<p>| DEF-74 | P0 | 9/10 | 2h | 8.5/10 | 1B |</p>
<p>| DEF-73 | P1 | 7/10 | 15min | 8.0/10 | 1B |</p>
<p>| DEF-60 | P1 | 6/10 | 4h | 8.5/10 | 1C |</p>
<p>| DEF-35 | P2 | 4/10 | 16-20h | 6.0/10 | 2 |</p>
<p>| DEF-70 | P3 | 9/10 | 40h | 5.0/10 | 3 |</p>
<p>| DEF-71 | P3 | 8/10 | 40h | 5.5/10 | 3 |</p>
<p>| DEF-72 | P4 | 5/10 | 40h | 5.0/10 | 4 |</p>

<h3>Risk Score Interpretation</h3>
<ul>
<li>**10/10 CRITICAL**: Data loss risk (DEF-68, DEF-69)</li>
<li>**8-9/10 HIGH**: Silent failures or architectural changes (DEF-74, DEF-70, DEF-71)</li>
<li>**6-7/10 MEDIUM**: Compliance or performance issues (DEF-60, DEF-73)</li>
<li>**4-5/10 LOW**: Feature work or refactoring (DEF-35, DEF-72)</li>
</ul>

<p>---</p>

<h2>‚úÖ Success Criteria & Validation</h2>

<h3>Week 1 Success Metrics</h3>
<pre><code># Phase 1A Validation
tail -n 100 logs/app.log | grep -E "(ValidationError|voorbeelden.*failed)"
# Expected: All errors logged with full context

# Phase 1B Validation
python -c "from src.voorbeelden.models import VoorbeeldenSchema; VoorbeeldenSchema(voorbeeldzinnen='NOT_A_LIST')"
# Expected: ValidationError raised + logged

# Phase 1C Validation
grep "ServiceContainer init" logs/app.log | wc -l
# Expected: 1 (not 2+)

time python -c "import streamlit; from src.main import main"
# Expected: &lt; 3 seconds (baseline: 5-7s)</code></pre>

<h3>Week 2 Success Metrics</h3>
<pre><code># Classifier accuracy
pytest tests/services/classification/test_term_based_classifier.py -v
# Expected: 80%+ pass rate on golden dataset

# Confidence scoring
python -c "from src.ontologie.classifier import classify_term; print(classify_term('machtiging'))"
# Expected: {"category": "TYPE", "confidence": "HIGH"}</code></pre>

<h3>Weeks 3-4 Success Metrics (if executed)</h3>
<pre><code># ServiceContainer simplification
wc -l src/services/container.py
# Expected: &lt;300 lines (baseline: 818)

# Repository god object split
ls src/database/*_repository.py | wc -l
# Expected: 3+ files (definition, voorbeelden, history)

# Directory consolidation
find src/ -maxdepth 1 -type d | wc -l
# Expected: &lt;10 directories (baseline: 34)

# Full regression
pytest tests/ -q --cov=src
# Expected: 70%+ coverage, all tests pass</code></pre>

<p>---</p>

<h2>üÜò Emergency Protocols</h2>

<h3>If Phase 1 Fails (Rollback Strategy)</h3>

<h4>Scenario 1: DEF-74 validation breaks import flow</h4>
<pre><code># Rollback validation enforcement
git revert &lt;DEF-74-commit&gt;

# Restore database if corrupted
cp data/backups/manual/pre-week1-*.db data/definities.db

# Verify baseline
pytest tests/ -q
# Expected: All tests pass

# Debug
grep "ValidationError" logs/app.log
# Identify: Which data triggered validation failure</code></pre>

<h4>Scenario 2: DEF-60 lazy loading causes crashes</h4>
<pre><code># Rollback lazy loading
git revert &lt;DEF-60-commit&gt;

# Verify eager loading works
grep "ServiceContainer init" logs/app.log
# Expected: See all 27 services initialized

# Identify missing dependency
grep "AttributeError.*NoneType" logs/app.log
# Fix: Add initialization for missing service</code></pre>

<h3>If Phase 2 Fails (Classifier Issues)</h3>
<pre><code># Rollback classifier integration
git revert &lt;classifier-commits&gt;

# Classifier is additive - safe to revert
# Definition generation still works without classification</code></pre>

<h3>If Phase 3-4 Fails (God Object Refactor)</h3>
<pre><code># CRITICAL: Restore database FIRST
cp data/backups/pre-refactor-*.db data/definities.db

# Rollback code changes
git reset --hard &lt;last-stable-commit&gt;

# Verify baseline functionality
pytest tests/ -q
python -m streamlit run src/main.py
# Manual test: Generate definition ‚Üí Validate ‚Üí Export</code></pre>

<p>---</p>

<h2>üìÖ Time Budget Breakdown</h2>

<h3>Week 1: Quick Wins + Performance (14-17 uur)</h3>
<pre><code>Day 1 Morning (2h):
‚îú‚îÄ Phase 1A: Logging infrastructure (30 min)
‚îî‚îÄ Phase 1B start: DEF-74 validation (1.5h)

Day 1 Afternoon (3h):
‚îú‚îÄ Phase 1B continue: DEF-69 error handling (3h)
‚îî‚îÄ Testing &amp; validation

Day 2 Morning (2h):
‚îú‚îÄ Phase 1B complete: DEF-73 SessionState (15 min)
‚îî‚îÄ Testing &amp; smoke tests (1.75h)

Day 2 Afternoon (4h):
‚îî‚îÄ Phase 1C: DEF-60 lazy loading (4h)

Day 3 (optional buffer):
‚îî‚îÄ Bug fixes, documentation, retrospective</code></pre>

<h3>Week 2: Classifier MVP (16-20 uur) - OPTIONAL</h3>
<pre><code>Day 1-2: Config + Core Logic (10h)
‚îú‚îÄ YAML config (3h)
‚îú‚îÄ Priority cascade (1h)
‚îú‚îÄ Confidence scoring (2h)
‚îî‚îÄ Basic integration (4h)

Day 3-4: Testing + Polish (6-10h)
‚îú‚îÄ Golden dataset tests (4h)
‚îú‚îÄ Edge case handling (2h)
‚îú‚îÄ UI polish (2-4h)</code></pre>

<h3>Weeks 3-4: God Object Cleanup (40-60 uur) - NICE-TO-HAVE</h3>
<pre><code>Week 3: ServiceContainer + DefinitieRepository (80h)
‚îú‚îÄ DEF-70: ServiceContainer split (40h)
‚îÇ   ‚îú‚îÄ Design domain containers (8h)
‚îÇ   ‚îú‚îÄ Incremental migration (24h)
‚îÇ   ‚îî‚îÄ Testing &amp; rollback prep (8h)
‚îÇ
‚îî‚îÄ DEF-71: DefinitieRepository split (40h)
    ‚îú‚îÄ Design repository interfaces (8h)
    ‚îú‚îÄ Split + migrate (24h)
    ‚îî‚îÄ Database integrity tests (8h)

Week 4: Directory consolidation (40h)
‚îî‚îÄ DEF-72: 34‚Üí8 directories
    ‚îú‚îÄ Design new structure (4h)
    ‚îú‚îÄ Move files + imports (32h)
    ‚îî‚îÄ CI/CD updates (4h)</code></pre>

<p><strong>Total Effort Estimate:</strong></p>
<ul>
<li>**Week 1 (mandatory)**: 14-17h</li>
<li>**Week 2 (optional)**: 16-20h</li>
<li>**Weeks 3-4 (nice-to-have)**: 40-60h</li>
<li>**TOTAL**: 70-97h (add 20% buffer for solo developer = 84-116h)</li>
</ul>

<p>---</p>

<h2>üéØ Decision Gates</h2>

<h3>Gate 1: After Phase 1 (Day 2)</h3>
<p><strong>Decision:</strong> Proceed to Phase 2 (Classifier MVP)?</p>

<p><strong>GO Criteria:</strong></p>
<ul>
<li>‚úÖ All 5 quick wins deployed (DEF-68, DEF-69, DEF-74, DEF-73, DEF-60)</li>
<li>‚úÖ No regressions in smoke tests</li>
<li>‚úÖ Startup time < 3 seconds</li>
<li>‚úÖ All validation errors logged</li>
</ul>

<p><strong>NO-GO Signals:</strong></p>
<ul>
<li>‚ùå Critical bugs discovered in Phase 1</li>
<li>‚ùå Data loss incidents reported</li>
<li>‚ùå Import flow broken</li>
<li>‚ùå Test coverage dropped >10%</li>
</ul>

<p><strong>If NO-GO:</strong> Stabilize Phase 1, defer Phase 2</p>

<p>---</p>

<h3>Gate 2: After Phase 2 (Week 2)</h3>
<p><strong>Decision:</strong> Proceed to Phase 3-4 (God Object Cleanup)?</p>

<p><strong>GO Criteria:</strong></p>
<ul>
<li>‚úÖ Classifier MVP deployed</li>
<li>‚úÖ 80%+ accuracy on validation set</li>
<li>‚úÖ No critical bugs from Week 1-2</li>
<li>‚úÖ Time budget allows (solo dev constraint)</li>
</ul>

<p><strong>NO-GO Signals:</strong></p>
<ul>
<li>‚ùå Critical bugs from previous phases</li>
<li>‚ùå Classification accuracy < 60%</li>
<li>‚ùå User feedback negative</li>
<li>‚ùå Time budget exhausted</li>
</ul>

<p><strong>If NO-GO:</strong> Focus on bug fixes, defer god object cleanup</p>

<p>---</p>

<h3>Gate 3: After Each Refactor (Weeks 3-4)</h3>
<p><strong>Decision:</strong> Proceed to next refactor?</p>

<p><strong>GO Criteria:</strong></p>
<ul>
<li>‚úÖ Full regression suite passes</li>
<li>‚úÖ Database integrity verified</li>
<li>‚úÖ Performance maintained or improved</li>
<li>‚úÖ Code coverage >70%</li>
<li>‚úÖ 3 days monitoring with zero critical bugs</li>
</ul>

<p><strong>NO-GO Signals:</strong></p>
<ul>
<li>‚ùå Data loss detected</li>
<li>‚ùå Performance degradation >20%</li>
<li>‚ùå Test failures</li>
<li>‚ùå Critical bugs in production</li>
</ul>

<p><strong>If NO-GO:</strong> Rollback to previous stable state, debug before continuing</p>

<p>---</p>

<h2>üìö New Issues Discovered During Analysis</h2>

<h3>DEF-80: Automated Database Backup System</h3>
<p><strong>Priority</strong>: P2 (HIGH)</p>
<p><strong>Trigger</strong>: voorbeelden-data-loss-2025-10-30.md incident analysis</p>

<p><strong>Problem:</strong></p>
<ul>
<li>No automated backups before critical operations</li>
<li>Manual backups unreliable</li>
<li>Data loss risk during refactoring</li>
</ul>

<p><strong>Solution:</strong></p>
<pre><code># Add to .github/workflows/backup.yml
name: Daily Database Backup
on:
  schedule:
    - cron: '0 2 * * *'  # 2 AM daily
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Backup Database
        run: |
          DATE=$(date +%Y%m%d)
          cp data/definities.db data/backups/automated/definities-$DATE.db

      - name: Cleanup Old Backups
        run: find data/backups/automated/ -mtime +30 -delete</code></pre>

<p>---</p>

<h3>DEF-81: Git Database Tracking Prevention</h3>
<p><strong>Priority</strong>: P2 (HIGH)</p>
<p><strong>Trigger</strong>: Historical analysis of data loss incidents</p>

<p><strong>Problem:</strong></p>
<ul>
<li>`data/definities.db` was tracked in git</li>
<li>Branch switches caused data loss</li>
<li>Fixed by `.gitignore`, but no safeguards</li>
</ul>

<p><strong>Solution:</strong></p>
<pre><code># Add to .git/hooks/pre-commit
#!/bin/bash
if git diff --cached --name-only | grep -q "data/definities.db"; then
    echo "‚ùå ERROR: definities.db should not be committed!"
    echo "Add to .gitignore: data/definities.db"
    exit 1
fi</code></pre>

<p>---</p>

<h2>üîë Key Insights from Multi-Agent Analysis</h2>

<h3>What Both Agents Agreed On</h3>
<ol>
<li>**Data loss prevention is P0** (DEF-68, DEF-69, DEF-74)</li>
<li>**Lazy loading is high ROI** (DEF-60 proven 65% improvement)</li>
<li>**God object refactoring is optional** (Weeks 3-4 nice-to-have)</li>
<li>**Sequential execution mandatory** for validation chain</li>
</ol>

<h3>What Agents Disagreed On</h3>
<ol>
<li>**Execution order conflict:**</li>
</ol>
<ul>
<li>  - Debug-specialist: Validation first</li>
<li>  - Full-stack-developer: Logging first</li>
<li>  - **Resolution**: Hybrid approach (logging ‚Üí validation chain)</li>
</ul>

<h3>What Code-Reviewer Added</h3>
<ol>
<li>**Historical analysis** ‚Üí Discovered voorbeelden data loss incident</li>
<li>**Rollback strategies** ‚Üí Explicit commands for emergency recovery</li>
<li>**Success metrics** ‚Üí Specific validation commands with expected outputs</li>
<li>**New issues** ‚Üí DEF-80 (backups) and DEF-81 (git tracking prevention)</li>
</ol>

<h3>Solo Developer Constraints Acknowledged</h3>
<ol>
<li>**Time buffers**: 20% added for context switching</li>
<li>**Optional phases**: Weeks 3-4 marked as nice-to-have</li>
<li>**Decision gates**: Explicit GO/NO-GO criteria at each phase</li>
<li>**Emergency protocols**: Detailed rollback procedures</li>
</ol>

<p>---</p>

<h2>üìä Final Consensus Scoring</h2>

<h3>Feasibility: 8.5/10</h3>
<p><strong>Rationale:</strong></p>
<ul>
<li>Week 1 is highly feasible (proven patterns)</li>
<li>Week 2 is moderate (new feature, but additive)</li>
<li>Weeks 3-4 are challenging (god objects, high risk)</li>
<li>Solo developer constraint accounted for</li>
</ul>

<p><strong>Confidence Factors:</strong></p>
<ul>
<li>‚úÖ Clear dependency chains</li>
<li>‚úÖ Historical proof (US-202 performance gains)</li>
<li>‚úÖ Rollback strategies defined</li>
<li>‚ö†Ô∏è God object refactoring complexity</li>
</ul>

<p>---</p>

<h3>Risk: 3/10 (LOW)</h3>
<p><strong>Rationale:</strong></p>
<ul>
<li>Phase 1 has zero risk (logging-only changes)</li>
<li>Phase 2 is additive (no breaking changes)</li>
<li>Phases 3-4 have mitigations (backups, rollbacks)</li>
</ul>

<p><strong>Risk Mitigation:</strong></p>
<ul>
<li>‚úÖ Database backups mandatory</li>
<li>‚úÖ Incremental commits with tests</li>
<li>‚úÖ Decision gates at each phase</li>
<li>‚úÖ Emergency rollback procedures</li>
</ul>

<p>---</p>

<h3>ROI: 9/10 (EXCELLENT)</h3>
<p><strong>Rationale:</strong></p>
<ul>
<li>Prevents data loss (HIGH business value)</li>
<li>65% performance improvement (proven)</li>
<li>81-88% code reduction potential (god objects)</li>
<li>Minimal effort for Week 1 (14-17h)</li>
</ul>

<p><strong>ROI Breakdown:</strong></p>
<ul>
<li>**Week 1**: 9/10 (prevents data loss + performance)</li>
<li>**Week 2**: 6/10 (new feature, moderate value)</li>
<li>**Weeks 3-4**: 5/10 (code quality, long-term maintainability)</li>
</ul>

<p>---</p>

<h2>üöÄ Immediate Next Steps (START TODAY!)</h2>

<h3>Step 1: Prepare Environment (10 min)</h3>
<pre><code># Create feature branch
git checkout -b fix/p0-data-loss-prevention

# Backup database
mkdir -p data/backups/manual
cp data/definities.db data/backups/manual/pre-week1-$(date +%Y%m%d).db

# Run baseline metrics
pytest -q --cov=src &gt; baseline_metrics.txt
python scripts/measure_startup.py &gt; startup_baseline.txt</code></pre>

<h3>Step 2: Execute Phase 1A (30 min)</h3>
<pre><code># DEF-68: Add context validation logging
# Location: src/services/validation/mappers.py
# Add: logger.error(f"Context mapping failed: {e}", exc_info=True)

# DEF-69: Add voorbeelden save logging
# Location: src/voorbeelden/unified_voorbeelden.py
# Add: logger.error(f"Voorbeelden save failed for {definitie_id}: {e}")

# Test logging
pytest tests/ -q
tail -n 50 logs/app.log | grep -E "(ERROR|ValidationError)"

# Commit
git add .
git commit -m "fix(logging): add structured logging for validation failures (DEF-68, DEF-69)"</code></pre>

<h3>Step 3: Execute Phase 1B (4-5 hours)</h3>
<pre><code># DEF-74: Enforce Pydantic validation (2h)
# Location: src/database/definitie_repository.py line 1453
# Add validation call before save

# DEF-69: Fix error handling (3h)
# Location: src/services/definition_import_service.py
# Replace silent exception with user warning

# DEF-73: Fix SessionState violations (15 min)
python scripts/check_streamlit_patterns.py
# Fix each violation
# Commit incrementally

# Test full flow
pytest tests/ -q
python -m streamlit run src/main.py
# Manual test: Import CSV ‚Üí Check voorbeelden saved</code></pre>

<h3>Step 4: Execute Phase 1C (4 hours - Day 2)</h3>
<pre><code># DEF-60: Lazy loading (4h)
# Location: src/services/container.py
# Convert 5 services to @property lazy loaders

# Test startup time
time python -c "import streamlit; from src.main import main"
# Expected: &lt; 3 seconds (baseline: 5-7s)

# Smoke test all tabs
python -m streamlit run src/main.py
# Test: Generator, Edit, Voorbeelden, Export tabs

# Commit
git add .
git commit -m "perf(DEF-60): implement lazy loading for 5 optional services"</code></pre>

<p>---</p>

<h2>üìÅ Documentation Updates Required</h2>

<h3>After Week 1</h3>
<ul>
<li>[ ] Update `docs/analyses/STARTUP_PERFORMANCE_ANALYSIS.md` with new metrics</li>
<li>[ ] Update `CLAUDE.md` with new performance baselines</li>
<li>[ ] Add rollback procedures to `docs/guidelines/EMERGENCY_PROCEDURES.md`</li>
</ul>

<h3>After Week 2</h3>
<ul>
<li>[ ] Document classifier usage in `docs/guides/CLASSIFIER_USAGE.md`</li>
<li>[ ] Update `docs/architectuur/SOLUTION_ARCHITECTURE.md` with classifier integration</li>
</ul>

<h3>After Weeks 3-4</h3>
<ul>
<li>[ ] Update `docs/architectuur/TECHNICAL_ARCHITECTURE.md` with new structure</li>
<li>[ ] Document new directory structure in `docs/guidelines/CODE_ORGANIZATION.md`</li>
</ul>

<p>---</p>

<h2>‚úÖ Summary: The Consensus Roadmap</h2>

<p><strong>START WITH PHASE 1A - THE HYBRID APPROACH IS CORRECT!</strong></p>

<h3>Why This Roadmap Works</h3>
<ol>
<li>**Logging first** ‚Üí Enables debugging of validation failures</li>
<li>**Sequential validation chain** ‚Üí Respects technical dependencies</li>
<li>**Performance quick win** ‚Üí Proven 65% improvement</li>
<li>**Optional refactoring** ‚Üí Defers high-risk work until stable</li>
<li>**Clear decision gates** ‚Üí Prevents premature optimization</li>
</ol>

<h3>What Makes This Consensus Strong</h3>
<ol>
<li>**3 agent perspectives** synthesized</li>
<li>**Historical analysis** integrated (voorbeelden data loss incident)</li>
<li>**Conflict resolution** (hybrid execution order)</li>
<li>**Risk mitigation** at every phase</li>
<li>**Solo developer** constraints acknowledged</li>
</ol>

<h3>Expected Outcomes</h3>
<ul>
<li>**Week 1**: Zero data loss + 65% faster startup</li>
<li>**Week 2**: Category detection capability (optional)</li>
<li>**Weeks 3-4**: 81-88% code reduction (optional)</li>
</ul>

<p><strong>Total Consensus Score: 9/10</strong></p>
<ul>
<li>**Feasibility**: 8.5/10 (realistic for solo dev)</li>
<li>**Risk**: 3/10 (LOW - with proper mitigations)</li>
<li>**ROI**: 9/10 (EXCELLENT - prevents data loss + performance)</li>
</ul>

<p>---</p>

<p><strong>üöÄ START TODAY WITH PHASE 1A!</strong></p>

  </div>
</body>
</html>