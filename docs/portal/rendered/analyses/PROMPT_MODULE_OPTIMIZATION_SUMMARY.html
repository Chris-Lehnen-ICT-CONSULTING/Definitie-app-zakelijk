<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prompt Module Optimization - Executive Summary</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">← Terug naar Portal</a>
    <h1>Prompt Module Optimization - Executive Summary</h1>
<p><strong>Date:</strong> 2025-01-12</p>

<h2>TL;DR</h2>

<p><strong>Consolidate 16 modules → 7 modules</strong></p>
<ul>
<li>**Token savings:** 1,250+ tokens (17% reduction, conservative estimate)</li>
<li>**Line reduction:** 1,934 lines (44% reduction)</li>
<li>**Complexity:** 7/10 → 3/10</li>
<li>**Implementation:** 16-20 hours across 4 phases</li>
<li>**Risk:** MEDIUM (requires testing, but phased approach minimizes risk)</li>
</ul>

<p>---</p>

<h2>Quick Win Recommendations</h2>

<h3>Phase 1: Critical Fixes (4 hours) - **DO FIRST**</h3>
<p>Fix broken module and contradictions:</p>
<ol>
<li>**TemplateModule validation** - Change `semantic_category` → `ontological_category`</li>
<li>**Kick-off contradiction** - Clarify noun vs. verb (resolve Semantic ↔ ErrorPrev conflict)</li>
<li>**Hardcoded STR/INT rules** - Convert to load from cache (US-202 compliance)</li>
</ol>

<p><strong>Impact:</strong> All modules functional, zero contradictions, US-202 compliant</p>

<p>---</p>

<h2>Key Findings</h2>

<h3>Critical Issues (Must Fix)</h3>
<ol>
<li>**TemplateModule BROKEN** - Never runs due to validation checking non-existent field</li>
<li>**Major contradiction** - SemanticCategorisationModule instructs "proces waarbij", ErrorPreventionModule forbids it</li>
<li>**Hardcoded rules** - STR and INT modules bypass cache, defeating US-202 optimization</li>
<li>**645 lines duplication** - Identical `_format_rule()` method in 5 modules (14.5% of codebase)</li>
</ol>

<h3>Consolidation Opportunities</h3>
<ol>
<li>**OutputSpec → Expertise** (merge) - Tightly coupled, minimal logic</li>
<li>**Template → Semantic** (merge) - Template broken, duplicates ESS-02 guidance</li>
<li>**7 rule modules → 1** (merge) - Identical structure, single source of truth</li>
<li>**ErrorPrev → Validation** (merge) - Inverse of rules, logically grouped</li>
</ol>

<p>---</p>

<h2>Proposed Architecture (7 Modules)</h2>

<p>| Module | Source | Lines | Tokens | Priority |</p>
<p>|--------|--------|-------|--------|----------|</p>
<p>| CoreInstructionsModule | Expertise + OutputSpec | 250 | 800 | 100 |</p>
<p>| ContextAwarenessModule | (unchanged) | 433 | 1,200 | 80 |</p>
<p>| CategoryGuidanceModule | Semantic + Template | 350 | 900 | 70 |</p>
<p>| GrammarModule | (simplified) | 150 | 400 | 70 |</p>
<p>| ValidationRulesModule | 7 rules + ErrorPrev | 800 | 2,200 | 65 |</p>
<p>| DefinitionTaskModule | (simplified) | 200 | 500 | 50 |</p>
<p>| MetricsModule | (optional) | 326 | 400 | 30 |</p>
<p>| <strong>TOTAL</strong> | | <strong>2,509</strong> | <strong>6,400</strong> | |</p>

<p><strong>vs. Current:</strong> 4,443 lines, ~7,250 tokens</p>

<p>---</p>

<h2>Contradictions to Resolve</h2>

<h3>1. Kick-off Terms (CRITICAL)</h3>
<p><strong>Problem:</strong> SemanticCategorisationModule instructs "proces waarbij", ErrorPreventionModule forbids it</p>

<p><strong>Resolution:</strong></p>
<ul>
<li>**Clarify:** "proces" is a NOUN (handelingsnaamwoord), not a VERB</li>
<li>**Forbidden:** VERBS like "is", "betekent", "omvat"</li>
<li>**Allowed:** NOUNS like "proces", "activiteit", "handeling"</li>
<li>**Update:** ErrorPreventionModule forbidden list to specify verbs only</li>
</ul>

<h3>2. Category Naming (MEDIUM)</h3>
<p><strong>Problem:</strong> 3 incompatible naming schemes (ontological_category, semantic_category, domain_contexts)</p>

<p><strong>Resolution:</strong></p>
<ul>
<li>**PRIMARY:** `ontological_category` (lowercase)</li>
<li>**VALUES:** `proces`, `type`, `resultaat`, `exemplaar`</li>
<li>**DEPRECATED:** `semantic_category`, `domain_contexts`</li>
</ul>

<h3>3. Hardcoded Rules (HIGH)</h3>
<p><strong>Problem:</strong> STR and INT modules bypass cached_toetsregel_manager</p>

<p><strong>Resolution:</strong></p>
<ul>
<li>Convert all rule modules to load from cache</li>
<li>Single source of truth (JSON definitions)</li>
<li>US-202 compliant (no duplicate loading)</li>
</ul>

<p>---</p>

<h2>Token Savings Breakdown</h2>

<p>| Source | Before | After | Savings |</p>
<p>|--------|--------|-------|---------|</p>
<p>| Module headers (9 eliminated) | 450 | 0 | -450 ✓ |</p>
<p>| Code duplication | 645 | 80 | -565 ✓ |</p>
<p>| OutputSpec merge | 400 | 200 | -200 ✓ |</p>
<p>| Template merge | 550 | 0 | -550 ✓ |</p>
<p>| 7 rule module consolidation | 2,100 | 900 | -1,200 ✓ |</p>
<p>| ErrorPrevention merge | 600 | 0 | -600 ✓ |</p>
<p>| Grammar simplification | 650 | 400 | -250 ✓ |</p>
<p>| DefinitionTask simplification | 600 | 500 | -100 ✓ |</p>
<p>| <strong>TOTAL SAVINGS</strong> | | | <strong>-3,915</strong> |</p>

<p><strong>Conservative estimate:</strong> ~1,250 tokens saved (17% reduction)</p>
<p><strong>Stretch goal:</strong> ~2,500 tokens saved (35% reduction with aggressive optimization)</p>

<p>---</p>

<h2>Implementation Phases</h2>

<h3>Phase 1: Fix Critical Issues (4 hours)</h3>
<ul>
<li>Fix TemplateModule validation</li>
<li>Resolve kick-off contradiction</li>
<li>Convert STR/INT to cache loading</li>
<li>**Result:** All modules functional, zero contradictions</li>
</ul>

<h3>Phase 2: Simple Merges (6 hours)</h3>
<ul>
<li>Merge OutputSpec → Expertise</li>
<li>Merge Template → Semantic</li>
<li>Merge ErrorPrev → Validation (prep)</li>
<li>**Result:** 16 → 10 modules, ~1,000 tokens saved</li>
</ul>

<h3>Phase 3: Major Consolidation (8 hours)</h3>
<ul>
<li>Create ValidationRulesModule (7→1)</li>
<li>Remove 7 individual rule modules</li>
<li>**Result:** 10 → 7 modules, ~2,500 tokens saved</li>
</ul>

<h3>Phase 4: Refinement (2 hours)</h3>
<ul>
<li>Simplify GrammarModule</li>
<li>Simplify DefinitionTaskModule</li>
<li>**Result:** Polish, final optimization</li>
</ul>

<p><strong>Total:</strong> 20 hours (~3 weeks part-time or 3 days full-time)</p>

<p>---</p>

<h2>Risk Assessment</h2>

<p>| Risk | Level | Mitigation |</p>
<p>|------|-------|------------|</p>
<p>| ValidationRules consolidation (7→1) | HIGH | Rule inventory, diff check, regression tests |</p>
<p>| Category naming unification | MEDIUM | Global search/replace, test all 4 categories |</p>
<p>| TemplateModule merge | MEDIUM | Export templates first, test each category |</p>
<p>| Simple merges (OutputSpec, ErrorPrev) | LOW | Unit tests, clean git history |</p>

<p><strong>Rollback plan:</strong> Git revert, feature flag, parallel run (old + new)</p>

<p>---</p>

<h2>Success Metrics</h2>

<h3>Token Efficiency</h3>
<ul>
<li>**Baseline:** 7,250 tokens/prompt</li>
<li>**Target:** <6,000 tokens/prompt (17% savings)</li>
<li>**Stretch:** <5,000 tokens/prompt (31% savings)</li>
</ul>

<h3>Code Quality</h3>
<ul>
<li>**Baseline:** 16 modules, 4,443 lines, complexity 7/10</li>
<li>**Target:** 7 modules, <2,600 lines, complexity 3/10</li>
<li>**No code duplication** (DRY principle)</li>
</ul>

<h3>Functionality</h3>
<ul>
<li>**All 45 validation rules present**</li>
<li>**Zero contradictions**</li>
<li>**All tests passing**</li>
<li>**Same or better definition quality**</li>
</ul>

<p>---</p>

<h2>Next Steps</h2>

<ol>
<li>**Review** this analysis with team</li>
<li>**Approve** Phase 1 (critical fixes) to start immediately</li>
<li>**Create** feature branch: `feature/prompt-module-consolidation`</li>
<li>**Measure** baseline (current token usage, test coverage)</li>
<li>**Implement** Phase 1 (4 hours) - Fix critical issues</li>
<li>**Validate** improvements before proceeding to Phase 2</li>
<li>**Document** all changes in `docs/refactor-log.md`</li>
</ol>

<p>---</p>

<h2>Files Created</h2>

<ol>
<li>`/docs/analyses/PROMPT_MODULE_OPTIMIZATION_ANALYSIS.md` - Detailed analysis (16 modules breakdown)</li>
<li>`/docs/analyses/PROMPT_MODULE_CONSOLIDATION_VISUAL.md` - Visual guide (diagrams, flow charts)</li>
<li>`/docs/analyses/PROMPT_MODULE_OPTIMIZATION_SUMMARY.md` - This executive summary (TL;DR)</li>
</ol>

<p>---</p>

<p><strong>Analysis completed:</strong> 2025-01-12</p>
<p><strong>Prepared by:</strong> Claude Code (DefinitieAgent)</p>
<p><strong>Approval required:</strong> Yes (>100 lines affected, architectural changes)</p>
<p><strong>UNIFIED compliance:</strong> ✅ Follows APPROVAL LADDER, REFACTOR principles</p>

  </div>
</body>
</html>