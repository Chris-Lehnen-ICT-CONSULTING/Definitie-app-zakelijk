<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Voorbeelden Generatie Fix - Definitie ID-23</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">← Terug naar Portal</a>
    <h1>Voorbeelden Generatie Fix - Definitie ID-23</h1>

<p><strong>Datum:</strong> 2025-10-29</p>
<p><strong>Issue:</strong> Voorbeelden generatie werkt niet voor definitie ID-23 (biografisch identiteitskenmerk)</p>
<p><strong>Status:</strong> ✅ ROOT CAUSE IDENTIFIED - USER ACTION REQUIRED</p>

<h2>Probleem</h2>

<p>Voorbeelden werden niet gegenereerd voor definitie ID-23. Alle API calls faalden met 401 Unauthorized errors.</p>

<h2>Root Cause</h2>

<p>De <code>OPENAI_API_KEY_PROD</code> environment variabele bevat een <strong>incorrecte/verlopen API key</strong> die eindigt met <code>...JF4A</code>.</p>

<p><strong>OpenAI error:</strong></p>
<pre><code>Error code: 401 - Incorrect API key provided: sk-proj-***...JF4A</code></pre>

<h2>Fixes Toegepast</h2>

<h3>1. `config/config.yaml`</h3>
<ul>
<li>❌ **Voor:** `default_model: gpt-4.1` (model bestaat niet!)</li>
<li>✅ **Na:** `default_model: gpt-4o-mini`</li>
<li>❌ **Voor:** Hardcoded incorrecte API key</li>
<li>✅ **Na:** `openai_api_key: null` (gebruik env variable)</li>
<li>✅ Updated pricing voor gpt-4o en gpt-4o-mini</li>
</ul>

<h3>2. `src/config/config_manager.py`</h3>
<ul>
<li>❌ **Voor:** `default_model: str = "gpt-4.1"`</li>
<li>✅ **Na:** `default_model: str = "gpt-4o-mini"`</li>
<li>✅ Updated default_temperature van 0.0 naar 0.7 (beter voor voorbeelden)</li>
</ul>

<h3>3. Cache Cleanup</h3>
<ul>
<li>✅ Alle pickle en JSON cache files verwijderd uit `cache/`</li>
</ul>

<h2>Vereiste Gebruikersactie</h2>

<p><strong>UPDATE DE OPENAI API KEY:</strong></p>

<pre><code># 1. Check huidige key
echo $OPENAI_API_KEY_PROD

# 2. Verkrijg nieuwe geldige API key van OpenAI
#    https://platform.openai.com/account/api-keys

# 3. Update environment variabele (in ~/.zshrc of ~/.bashrc)
export OPENAI_API_KEY_PROD="sk-proj-YOUR_VALID_API_KEY_HERE"

# 4. Reload shell configuratie
source ~/.zshrc  # of ~/.bashrc

# 5. Verify
echo $OPENAI_API_KEY_PROD</code></pre>

<h2>Testing</h2>

<p><strong>Debug Script Beschikbaar:</strong></p>
<pre><code>python scripts/debug_voorbeelden_id_23.py</code></pre>

<p>Dit script test de volledige voorbeelden generatie flow voor definitie ID-23 en toont:</p>
<ul>
<li>Definitie data</li>
<li>Bestaande voorbeelden</li>
<li>Nieuwe voorbeelden generatie (met logging)</li>
<li>Database save operatie</li>
</ul>

<h2>Verwacht Resultaat Na Fix</h2>

<p>Na het updaten van de API key moet de voorbeelden generatie:</p>
<ol>
<li>✅ Succesvol 6 types voorbeelden genereren:</li>
</ol>
<ul>
<li>  - voorbeeldzinnen (3 items)</li>
<li>  - praktijkvoorbeelden (3 items)</li>
<li>  - tegenvoorbeelden (3 items)</li>
<li>  - synoniemen (5 items)</li>
<li>  - antoniemen (5 items)</li>
<li>  - toelichting (1 item)</li>
</ul>

<ol>
<li>✅ Voorbeelden opslaan in `definitie_voorbeelden` tabel</li>
<li>✅ Geen 401 authentication errors meer</li>
</ol>

<h2>Impact</h2>

<ul>
<li>**Files Modified:** 2 (config.yaml, config_manager.py)</li>
<li>**Breaking Changes:** Geen (alleen configuratie fixes)</li>
<li>**User Action Required:** Ja (update OPENAI_API_KEY_PROD)</li>
<li>**Deployment Impact:** Streamlit app restart vereist na key update</li>
</ul>

<h2>Validatie Checklist</h2>

<ul>
<li>[x] Incorrect model name (gpt-4.1) vervangen door gpt-4o-mini</li>
<li>[x] Hardcoded API key verwijderd uit config.yaml</li>
<li>[x] Default model in config_manager.py updated</li>
<li>[x] Cache gecleared</li>
<li>[x] Debug script gemaakt voor testen</li>
<li>[ ] **USER ACTION:** API key updated in environment</li>
<li>[ ] **USER ACTION:** Streamlit app herstart</li>
<li>[ ] **USER ACTION:** Voorbeelden generatie getest voor ID-23</li>
</ul>

<h2>Related Issues</h2>

<ul>
<li>Invalid model names in config (gpt-4.1 doesn't exist)</li>
<li>Hardcoded credentials in config files (security issue)</li>
<li>Oude cache met incorrecte config</li>
</ul>

<h2>Lessons Learned</h2>

<ol>
<li>**Nooit hardcode credentials in config files** - altijd environment variables gebruiken</li>
<li>**Validate model names** - OpenAI models veranderen (gpt-4.1 bestaat niet)</li>
<li>**Cache cleanup** na config changes - oude config kan blijven hangen</li>
<li>**Dual sources of truth** - zowel config.yaml als dataclass defaults moeten synchroon zijn</li>
</ol>

  </div>
</body>
</html>