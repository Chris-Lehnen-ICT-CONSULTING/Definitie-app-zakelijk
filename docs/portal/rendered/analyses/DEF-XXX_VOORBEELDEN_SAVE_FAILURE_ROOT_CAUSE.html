<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DEF-XXX: Root Cause Analysis - Voorbeelden Save Failure</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">â† Terug naar Portal</a>
    <h1>DEF-XXX: Root Cause Analysis - Voorbeelden Save Failure</h1>

<p><strong>Date:</strong> 2025-11-11</p>
<p><strong>Status:</strong> Analysis Complete</p>
<p><strong>Priority:</strong> HIGH (Data Loss Bug)</p>
<p><strong>Analyzed By:</strong> Debug Specialist</p>

<h2>Executive Summary</h2>

<p>Voorbeelden generated for "simplificeren" (ID 143, 2025-11-11 14:15:04) were <strong>NOT saved to database</strong>, while an older version (ID 92, 2025-10-31) has 40 voorbeelden successfully stored. This is a <strong>data loss bug</strong> where generated content is lost despite no error messages.</p>

<h2>Evidence</h2>

<h3>Database Verification</h3>
<pre><code>-- ID 143 (NEW): NO voorbeelden âŒ
SELECT COUNT(*) FROM definitie_voorbeelden WHERE definitie_id = 143;
-- Result: 0

-- ID 92 (OLD): 40 voorbeelden âœ…
SELECT COUNT(*) FROM definitie_voorbeelden WHERE definitie_id = 92;
-- Result: 40 (antonyms=5, counter=12, explanation=1, practical=14, sentence=3, synonyms=5)</code></pre>

<h3>Timeline Context</h3>
<ul>
<li>**DEF-108** (2025-11-04): Timeout fixes (20s â†’ 45s for praktijkvoorbeelden)</li>
<li>**DEF-110** (2025-11-04): Stale voorbeelden fix (context-aware sync)</li>
<li>**ID 92** generated: 2025-10-31 (BEFORE fixes)</li>
<li>**ID 143** generated: 2025-11-11 (AFTER fixes)</li>
</ul>

<h2>Complete Voorbeelden Save Flow</h2>

<h3>Flow Diagram (Step-by-Step)</h3>

<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 5: Voorbeelden Generation (DefinitionOrchestratorV2)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Line 666: genereer_alle_voorbeelden_async()
         â”‚           â””â”€&gt; Returns: voorbeelden dict
         â”‚
         â”‚ Line 695: DEBUG logging point A [if DEBUG_EXAMPLES]
         â”‚           Log: voorbeelden types/counts
         â”‚
         â”‚ Line 925: Store in Definition.metadata["voorbeelden"]
         â”‚           â””â”€&gt; Passed to Definition object constructor
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 8: Definition Object Creation (_create_definition_object)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Line 924-925: metadata["voorbeelden"] = voorbeelden
         â”‚               â””â”€&gt; Embedded in Definition.metadata
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 9: Storage (repository.save())                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ definitie_repository.py::save()
         â”‚ â””â”€&gt; Saves Definition to 'definities' table
         â”‚     (metadata stored as JSON string)
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UI: definition_generator_tab.py::_render_generation_results()  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Line 467: voorbeelden = agent_result.get("voorbeelden", {})
         â”‚           â””â”€&gt; Extract from agent_result dict
         â”‚
         â”‚ Line 486: self._render_voorbeelden_section(voorbeelden)
         â”‚           â””â”€&gt; Display in UI (successful!)
         â”‚
         â”‚ Line 501: self._maybe_persist_examples(saved_id, agent_result)
         â”‚           â””â”€&gt; AUTO-SAVE TRIGGER
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CRITICAL PATH: _maybe_persist_examples()                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Line 797-801: Extract metadata from agent_result
         â”‚ Line 802: gen_id = meta.get("generation_id")
         â”‚ Line 803-806: flag_key = f"examples_saved_for_gen_{gen_id}"
         â”‚
         â”‚ Line 808: if SessionStateManager.get_value(flag_key): return  âš ï¸
         â”‚           â””â”€&gt; EARLY EXIT if already saved
         â”‚
         â”‚ Line 811-817: Extract voorbeelden from agent_result
         â”‚               if not raw: return  âš ï¸
         â”‚               â””â”€&gt; EARLY EXIT if no voorbeelden
         â”‚
         â”‚ Line 822: canonicalize_examples(raw)
         â”‚ Line 831-843: Convert to save format (dict[str, list[str]])
         â”‚
         â”‚ Line 846-848: if total_new == 0: return  âš ï¸
         â”‚               â””â”€&gt; EARLY EXIT if no new content
         â”‚
         â”‚ Line 852: current = repo.get_voorbeelden_by_type(definitie_id)
         â”‚           â””â”€&gt; Check existing DB voorbeelden
         â”‚
         â”‚ Line 874-876: if _norm(current_canon) == _norm(to_save): return  âš ï¸
         â”‚               â””â”€&gt; EARLY EXIT if identical to DB
         â”‚
         â”‚ Line 887-895: validate_save_voorbeelden_input() + repo.save_voorbeelden()
         â”‚               â””â”€&gt; ACTUAL SAVE TO DATABASE
         â”‚
         â”‚ Line 900: SessionStateManager.set_value(flag_key, True)
         â”‚           â””â”€&gt; Mark as saved (prevent duplicate saves)
         â”‚
         â””â”€&gt; END</code></pre>

<h2>Potential Failure Points (Ranked by Likelihood)</h2>

<h3>HYPOTHESIS 1: Session State Flag Reuse (MOST LIKELY) ğŸ”´</h3>
<p><strong>Probability:</strong> 90%</p>
<p><strong>Evidence:</strong></p>
<ul>
<li>Line 808: Early exit if `flag_key` already set in session state</li>
<li>Flag key format: `examples_saved_for_gen_{gen_id}` (if gen_id exists)</li>
<li>**RISK:** If same `generation_id` used twice in same session, second call skips save</li>
<li>**Scenario:** User regenerates definition â†’ same gen_id â†’ flag still set â†’ auto-save skipped</li>
</ul>

<p><strong>Code:</strong></p>
<pre><code># definition_generator_tab.py:808
if SessionStateManager.get_value(flag_key):
    return  # âš ï¸ SILENT EXIT - no logging, no warning!</code></pre>

<p><strong>Why This Is Most Likely:</strong></p>
<ol>
<li>ID 143 was generated **after DEF-110** (stale voorbeelden fix)</li>
<li>DEF-110 introduced extensive session state management changes</li>
<li>No error logging at this exit point (silent failure)</li>
<li>Matches symptom: voorbeelden generated BUT not saved</li>
</ol>

<p><strong>Verification Steps:</strong></p>
<pre><code># Check if gen_id collision possible:
# 1. Check logs for "examples_saved_for_gen_" flag usage
# 2. Check if same gen_id used multiple times in session
# 3. Verify gen_id uniqueness (should be UUID, but check format)</code></pre>

<p>---</p>

<h3>HYPOTHESIS 2: Empty/Invalid Voorbeelden Dict (LIKELY) ğŸŸ¡</h3>
<p><strong>Probability:</strong> 60%</p>
<p><strong>Evidence:</strong></p>
<ul>
<li>Line 816-817: Early exit if `raw` is empty</li>
<li>Line 846-848: Early exit if `total_new == 0` after conversion</li>
</ul>

<p><strong>Failure Scenario:</strong></p>
<ol>
<li>Orchestrator generates voorbeelden (Phase 5)</li>
<li>Voorbeelden dict has STRUCTURE but empty lists:</li>
<pre><code>   voorbeelden = {
       "voorbeeldzinnen": [],
       "praktijkvoorbeelden": [],
       "synoniemen": [],
       ...
   }</code></pre>
<li>Line 846: `total_new = sum(len(v) for v in to_save.values())` â†’ 0</li>
<li>Early exit at line 848 (no save)</li>
</ol>

<p><strong>Why This Matters:</strong></p>
<ul>
<li>Orchestrator logs "Voorbeelden generated (X types)" (line 713)</li>
<li>This counts KEYS, not VALUES â†’ misleading if all lists empty</li>
<li>Timeout issues (DEF-108) could cause partial generation â†’ empty lists</li>
</ul>

<p><strong>Verification:</strong></p>
<pre><code># Check orchestrator logs for:
# Line 695-710: [EXAMPLES-A] with counts={...}
# If counts show 0 for all types â†’ confirms this hypothesis</code></pre>

<p>---</p>

<h3>HYPOTHESIS 3: Pydantic Validation Failure (MEDIUM) ğŸŸ¡</h3>
<p><strong>Probability:</strong> 40%</p>
<p><strong>Evidence:</strong></p>
<ul>
<li>Line 887-895: `validate_save_voorbeelden_input()` validation (DEF-74)</li>
<li>Line 896-899: ValidationError catch with SILENT failure in auto-save context</li>
</ul>

<p><strong>Code:</strong></p>
<pre><code># definition_generator_tab.py:896-899
except ValidationError as e:
    logger.error(f"Voorbeelden validation failed: {e}")
    # Don't raise in auto-save context, just log
    return  # âš ï¸ SILENT EXIT after validation failure</code></pre>

<p><strong>Why This Could Happen:</strong></p>
<ol>
<li>DEF-74 introduced strict Pydantic validation (2025-10-30)</li>
<li>Schema changes might reject valid data structures</li>
<li>Error logged but NOT shown to user (auto-save context)</li>
</ol>

<p><strong>Check Logs:</strong></p>
<pre><code>grep "Voorbeelden validation failed" logs/*.log
# If found â†’ confirms validation issue</code></pre>

<p>---</p>

<h3>HYPOTHESIS 4: Duplicate Comparison False Positive (LOW) ğŸŸ¢</h3>
<p><strong>Probability:</strong> 20%</p>
<p><strong>Evidence:</strong></p>
<ul>
<li>Line 874-876: Comparison between `current_canon` (DB) and `to_save` (new)</li>
<li>Exit if identical (avoids redundant writes)</li>
</ul>

<p><strong>Failure Scenario:</strong></p>
<ol>
<li>Previous save partially succeeded (e.g., only synoniemen)</li>
<li>New voorbeelden identical to partial DB state</li>
<li>Auto-save skips because "_norm(current_canon) == _norm(to_save)"</li>
</ol>

<p><strong>Why This Is Unlikely:</strong></p>
<ul>
<li>ID 143 has **0 voorbeelden** in DB (verified via query)</li>
<li>Empty dict cannot match non-empty voorbeelden</li>
<li>Would only cause issue if ID 143 had PARTIAL voorbeelden</li>
</ul>

<p>---</p>

<h3>HYPOTHESIS 5: Exception in Canonicalization (LOW) ğŸŸ¢</h3>
<p><strong>Probability:</strong> 15%</p>
<p><strong>Evidence:</strong></p>
<ul>
<li>Line 904-905: Catch-all exception handler</li>
<li>Silent failure with only warning log</li>
</ul>

<p><strong>Code:</strong></p>
<pre><code># definition_generator_tab.py:904-905
except Exception as e:
    logger.warning("Automatisch opslaan voorbeelden mislukt: %s", e)
    # No re-raise, no user notification</code></pre>

<p><strong>Why This Is Unlikely:</strong></p>
<ul>
<li>`canonicalize_examples()` is defensive with fallbacks</li>
<li>Would require unexpected data structure to fail</li>
<li>Logs would show "Automatisch opslaan voorbeelden mislukt" warning</li>
</ul>

<p>---</p>

<h2>Recommended Investigation Steps</h2>

<h3>IMMEDIATE (Do First)</h3>
<ol>
<li>**Check Session State Flags:**</li>
<pre><code>   # In Streamlit debug console:
   import streamlit as st
   matching_keys = [k for k in st.session_state.keys() if 'examples_saved' in k]
   print(matching_keys)
   # Look for duplicate gen_ids</code></pre>
</ol>

<ol>
<li>**Enable DEBUG_EXAMPLES Logging:**</li>
<pre><code>   export DEBUG_EXAMPLES=1
   streamlit run src/main.py
   # Regenerate "simplificeren" definition
   # Check logs for [EXAMPLES-A] through [EXAMPLES-D]</code></pre>
</ol>

<ol>
<li>**Check Application Logs:**</li>
<pre><code>   grep -E "voorbeelden generated|Voorbeelden automatisch opgeslagen|validation failed" logs/*.log | tail -50</code></pre>
</ol>

<h3>SECONDARY (If Immediate Checks Fail)</h3>
<ol>
<li>**Verify Orchestrator Phase 5:**</li>
</ol>
<ul>
<li>  - Check if `genereer_alle_voorbeelden_async()` returns empty dict</li>
<li>  - Validate timeout settings (DEF-108 fix applied?)</li>
</ul>

<ol>
<li>**Database Integrity Check:**</li>
<pre><code>   SELECT id, begrip, created_at,
          json_extract(metadata, '$.voorbeelden') as voorbeelden_meta
   FROM definities
   WHERE id = 143;</code></pre>
</ol>

<ol>
<li>**Compare ID 92 vs ID 143 Generation Flow:**</li>
</ol>
<ul>
<li>  - Check generation_prompt_data differences</li>
<li>  - Verify orchestrator version used (V2 for both?)</li>
</ul>

<p>---</p>

<h2>Top 3 Hypotheses Summary</h2>

<p>| Rank | Hypothesis | Probability | Evidence Level | Fix Effort |</p>
<p>|------|------------|-------------|----------------|------------|</p>
<p>| 1 | Session state flag reuse | 90% | HIGH | LOW (add UUID validation) |</p>
<p>| 2 | Empty voorbeelden dict | 60% | MEDIUM | LOW (add count validation) |</p>
<p>| 3 | Pydantic validation failure | 40% | MEDIUM | MEDIUM (check schema) |</p>

<h2>Smoking Gun Indicators</h2>

<p><strong>If HYPOTHESIS 1 is correct, you will find:</strong></p>
<ul>
<li>âœ… Same `generation_id` in session state twice</li>
<li>âœ… Log line: "Voorbeelden automatisch opgeslagen" for DIFFERENT definitie_id</li>
<li>âœ… Session state key `examples_saved_for_gen_{gen_id}` = True BEFORE ID 143 save attempt</li>
</ul>

<p><strong>If HYPOTHESIS 2 is correct, you will find:</strong></p>
<ul>
<li>âœ… Orchestrator log: "Voorbeelden generated (6 types)" BUT counts all 0</li>
<li>âœ… DEBUG log [EXAMPLES-A]: `counts={voorbeeldzinnen: 0, praktijkvoorbeelden: 0, ...}`</li>
<li>âœ… Line 848 early exit (total_new == 0)</li>
</ul>

<p><strong>If HYPOTHESIS 3 is correct, you will find:</strong></p>
<ul>
<li>âœ… Error log: "Voorbeelden validation failed" for definitie_id 143</li>
<li>âœ… Pydantic error details showing schema mismatch</li>
<li>âœ… NO session state flag set (because validation failed before line 900)</li>
</ul>

<h2>Code Improvements Needed</h2>

<h3>1. Add Defensive Logging (CRITICAL)</h3>
<pre><code># definition_generator_tab.py:808
if SessionStateManager.get_value(flag_key):
    logger.warning(f"âš ï¸ Voorbeelden save skipped for definitie {definitie_id} - already saved (flag: {flag_key})")
    return

# Line 848
if total_new == 0:
    logger.warning(f"âš ï¸ Voorbeelden save skipped for definitie {definitie_id} - no new content (raw keys: {list(raw.keys())})")
    return

# Line 876
if _norm(current_canon) == _norm(to_save):
    logger.info(f"â„¹ï¸ Voorbeelden save skipped for definitie {definitie_id} - identical to DB")
    SessionStateManager.set_value(flag_key, True)
    return</code></pre>

<h3>2. Generation ID Validation</h3>
<pre><code># definition_generator_tab.py:802
gen_id = meta.get("generation_id")
if gen_id:
    # Validate UUID format
    import uuid
    try:
        uuid.UUID(gen_id)
    except ValueError:
        logger.error(f"âŒ Invalid generation_id format: {gen_id}")
        gen_id = None  # Fall back to def_id key</code></pre>

<h3>3. User Notification for Silent Failures</h3>
<pre><code># Line 899 - ValidationError catch
except ValidationError as e:
    logger.error(f"Voorbeelden validation failed: {e}")
    # ADD USER NOTIFICATION
    st.warning(f"âš ï¸ Voorbeelden konden niet worden opgeslagen: validatiefout")
    return</code></pre>

<h2>Files Requiring Changes</h2>

<ol>
<li>**`src/ui/components/definition_generator_tab.py`**</li>
</ol>
<ul>
<li>  - Lines 808, 848, 876: Add warning logs for early exits</li>
<li>  - Line 802: Add gen_id UUID validation</li>
<li>  - Line 896-899: Add user notification for validation failures</li>
</ul>

<ol>
<li>**`src/services/orchestrators/definition_orchestrator_v2.py`**</li>
</ol>
<ul>
<li>  - Line 713: Change log from "X types" to "X types, Y total items"</li>
<li>  - Add count validation before storing in metadata</li>
</ul>

<ol>
<li>**`src/database/definitie_repository.py`**</li>
</ol>
<ul>
<li>  - Line 1497-1536: Add logging for voorbeelden save operations</li>
<li>  - Log actual items saved per type</li>
</ul>

<h2>Conclusion</h2>

<p>The most probable root cause is <strong>session state flag reuse</strong> (Hypothesis 1), causing the auto-save logic to silently skip database writes when it incorrectly believes voorbeelden have already been saved. This would occur if:</p>

<ol>
<li>Same `generation_id` used for multiple definitions in one session</li>
<li>Or, flag not cleared between definition switches</li>
</ol>

<p>The <strong>second most likely cause</strong> is empty voorbeelden dict after generation (Hypothesis 2), which could result from:</p>
<ul>
<li>Timeout issues causing partial generation</li>
<li>Orchestrator returning structure with empty lists</li>
<li>Misleading log messages counting types instead of items</li>
</ul>

<p><strong>Next steps:</strong> Run the IMMEDIATE investigation steps above to identify which hypothesis matches the actual failure mode, then implement the defensive logging improvements to prevent recurrence.</p>

  </div>
</body>
</html>