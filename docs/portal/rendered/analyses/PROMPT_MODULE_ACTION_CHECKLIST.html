<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prompt Module Optimization - Action Checklist</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">‚Üê Terug naar Portal</a>
    <h1>Prompt Module Optimization - Action Checklist</h1>
<p><strong>Date:</strong> 2025-01-12</p>
<p><strong>Status:</strong> Ready to implement</p>

<h2>Phase 1: Critical Fixes (START HERE)</h2>
<p><strong>Goal:</strong> Fix broken module + resolve contradictions</p>
<p><strong>Time:</strong> 4 hours</p>
<p><strong>Risk:</strong> LOW (fixes only, no major refactoring)</p>

<h3>Task 1.1: Fix TemplateModule Validation (1 hour)</h3>

<p><strong>File:</strong> <code>/Users/chrislehnen/Projecten/Definitie-app/src/services/prompts/modules/template_module.py</code></p>

<p><strong>Changes:</strong></p>
<pre><code># Line 63: BEFORE
category = context.get_metadata("semantic_category")

# Line 63: AFTER
category = context.get_metadata("ontologische_categorie")</code></pre>

<p><strong>Additional change:</strong></p>
<pre><code># Line 81: BEFORE
category = context.get_metadata("semantic_category", "algemeen")

# Line 81: AFTER
category = context.get_metadata("ontologische_categorie", "algemeen")</code></pre>

<p><strong>Test:</strong></p>
<pre><code>pytest tests/services/prompts/test_modules_basic.py::test_template_module_runs -v</code></pre>

<p><strong>Verification:</strong></p>
<ul>
<li>[ ] Module validation passes</li>
<li>[ ] Module executes without errors</li>
<li>[ ] Category-specific templates generated</li>
<li>[ ] Test passes</li>
</ul>

<p>---</p>

<h3>Task 1.2: Resolve Kick-off Contradiction (1 hour)</h3>

<p><strong>File:</strong> <code>/Users/chrislehnen/Projecten/Definitie-app/src/services/prompts/modules/error_prevention_module.py</code></p>

<p><strong>Problem:</strong> Line 178-179 forbids "proces waarbij", "handeling die" which SemanticCategorisationModule instructs to use</p>

<p><strong>Change 1 - Update forbidden_starters list (line 156-191):</strong></p>
<pre><code># BEFORE: Includes noun phrases
forbidden_starters = [
    "proces waarbij",       # ‚ùå REMOVE (noun, not verb)
    "handeling die",        # ‚ùå REMOVE (noun, not verb)
    ...
]

# AFTER: Only verb phrases
forbidden_starters = [
    "is",                   # ‚úì KEEP (verb)
    "betreft",              # ‚úì KEEP (verb)
    "omvat",                # ‚úì KEEP (verb)
    "betekent",             # ‚úì KEEP (verb)
    "verwijst naar",        # ‚úì KEEP (verb phrase)
    "houdt in",             # ‚úì KEEP (verb phrase)
    "heeft betrekking op",  # ‚úì KEEP (verb phrase)
    "duidt op",             # ‚úì KEEP (verb phrase)
    "staat voor",           # ‚úì KEEP (verb phrase)
    "impliceert",           # ‚úì KEEP (verb)
    "definieert",           # ‚úì KEEP (verb)
    "beschrijft",           # ‚úì KEEP (verb)
    "wordt",                # ‚úì KEEP (verb)
    "zijn",                 # ‚úì KEEP (verb)
    "was",                  # ‚úì KEEP (verb)
    "waren",                # ‚úì KEEP (verb)
    "behelst",              # ‚úì KEEP (verb)
    "bevat",                # ‚úì KEEP (verb)
    "bestaat uit",          # ‚úì KEEP (verb phrase)
    "de",                   # ‚úì KEEP (article)
    "het",                  # ‚úì KEEP (article)
    "een",                  # ‚úì KEEP (article)
    # REMOVED: "proces waarbij", "handeling die", "activiteit waarbij" (nouns)
    "vorm van",             # ‚úì KEEP (meta-word)
    "type van",             # ‚úì KEEP (meta-word)
    "soort van",            # ‚úì KEEP (meta-word)
    "methode voor",         # ‚úì KEEP (too generic)
    "wijze waarop",         # ‚úì KEEP (too generic)
    "manier om",            # ‚úì KEEP (too generic)
    "een belangrijk",       # ‚úì KEEP (subjective)
    "een essentieel",       # ‚úì KEEP (subjective)
    "een vaak gebruikte",   # ‚úì KEEP (subjective)
    "een veelvoorkomende",  # ‚úì KEEP (subjective)
]</code></pre>

<p><strong>Change 2 - Add clarification comment (after line 191):</strong></p>
<pre><code># BELANGRIJK: Deze lijst verbiedt WERKWOORDEN en META-WOORDEN.
# Zelfstandige naamwoorden zoals "proces", "activiteit", "handeling"
# zijn TOEGESTAAN als kick-off (handelingsnaamwoorden, niet werkwoorden).
#
# ‚úÖ GOED: "proces dat...", "activiteit waarbij...", "handeling die..."
# ‚ùå FOUT: "is een proces", "betekent een activiteit"</code></pre>

<p><strong>Test:</strong></p>
<pre><code># Test that noun kick-offs are not flagged as errors
pytest tests/services/prompts/test_modules_basic.py::test_error_prevention_noun_kickoffs -v</code></pre>

<p><strong>Verification:</strong></p>
<ul>
<li>[ ] "proces waarbij" removed from forbidden list</li>
<li>[ ] "handeling die" removed from forbidden list</li>
<li>[ ] "activiteit waarbij" removed from forbidden list</li>
<li>[ ] Verbs still forbidden ("is", "betekent", etc.)</li>
<li>[ ] Clarification comment added</li>
<li>[ ] Test passes</li>
</ul>

<p>---</p>

<h3>Task 1.3: Fix Hardcoded STR Rules (1 hour)</h3>

<p><strong>File:</strong> <code>/Users/chrislehnen/Projecten/Definitie-app/src/services/prompts/modules/structure_rules_module.py</code></p>

<p><strong>Problem:</strong> Lines 80-332 hardcode rules instead of loading from cache</p>

<p><strong>Change - Replace hardcoded methods with cache loading:</strong></p>

<pre><code># BEFORE (lines 70-332): 9 hardcoded _build_str0X_rule() methods

# AFTER: Replace execute() method with cache loading
def execute(self, context: ModuleContext) -&gt; ModuleOutput:
    """Genereer STR validatieregels."""
    try:
        sections = []
        sections.append("### üèóÔ∏è Structuur Regels (STR):")
        sections.append("")

        # Load toetsregels on-demand from cached singleton
        from toetsregels.cached_manager import get_cached_toetsregel_manager

        manager = get_cached_toetsregel_manager()
        all_rules = manager.get_all_regels()

        # Filter alleen STR regels
        str_rules = {k: v for k, v in all_rules.items() if k.startswith("STR-")}

        # Sorteer regels
        sorted_rules = sorted(str_rules.items())

        for regel_key, regel_data in sorted_rules:
            sections.extend(self._format_rule(regel_key, regel_data))

        content = "\n".join(sections)

        return ModuleOutput(
            content=content,
            metadata={
                "rules_count": len(str_rules),
                "include_examples": self.include_examples,
                "rule_prefix": "STR",
            },
        )

    except Exception as e:
        logger.error(f"StructureRulesModule execution failed: {e}", exc_info=True)
        return ModuleOutput(
            content="",
            metadata={"error": str(e)},
            success=False,
            error_message=f"Failed to generate STR rules: {e!s}",
        )

def _format_rule(self, regel_key: str, regel_data: dict) -&gt; list[str]:
    """Formateer een regel uit JSON data."""
    lines = []

    # Header met emoji
    naam = regel_data.get("naam", "Onbekende regel")
    lines.append(f"üîπ **{regel_key} - {naam}**")

    # Uitleg
    uitleg = regel_data.get("uitleg", "")
    if uitleg:
        lines.append(f"- {uitleg}")

    # Toetsvraag
    toetsvraag = regel_data.get("toetsvraag", "")
    if toetsvraag:
        lines.append(f"- Toetsvraag: {toetsvraag}")

    # Voorbeelden (indien enabled)
    if self.include_examples:
        # Goede voorbeelden
        goede_voorbeelden = regel_data.get("goede_voorbeelden", [])
        for goed in goede_voorbeelden:
            lines.append(f"  ‚úÖ {goed}")

        # Foute voorbeelden
        foute_voorbeelden = regel_data.get("foute_voorbeelden", [])
        for fout in foute_voorbeelden:
            lines.append(f"  ‚ùå {fout}")

    lines.append("")  # Empty line between rules
    return lines

# REMOVE: All 9 _build_str0X_rule() methods (lines 132-332)</code></pre>

<p><strong>Test:</strong></p>
<pre><code># Verify all STR rules load correctly
pytest tests/services/prompts/test_modules_basic.py::test_structure_rules_from_cache -v

# Compare output before/after
python scripts/compare_str_rules_output.py</code></pre>

<p><strong>Verification:</strong></p>
<ul>
<li>[ ] All 9 STR rules present in output</li>
<li>[ ] Rules loaded from cache (no hardcoded)</li>
<li>[ ] Format matches original output</li>
<li>[ ] Examples included (if enabled)</li>
<li>[ ] Test passes</li>
</ul>

<p>---</p>

<h3>Task 1.4: Fix Hardcoded INT Rules (1 hour)</h3>

<p><strong>File:</strong> <code>/Users/chrislehnen/Projecten/Definitie-app/src/services/prompts/modules/integrity_rules_module.py</code></p>

<p><strong>Problem:</strong> Similar to STR, hardcoded instead of loading from cache</p>

<p><strong>Change - Apply same pattern as Task 1.3:</strong></p>

<pre><code># Replace execute() method with cache loading (same pattern as STR)
# Replace _format_rule() method (same as STR)
# Remove all hardcoded _build_intXX_rule() methods</code></pre>

<p><strong>Test:</strong></p>
<pre><code># Verify all INT rules load correctly
pytest tests/services/prompts/test_modules_basic.py::test_integrity_rules_from_cache -v

# Compare output before/after
python scripts/compare_int_rules_output.py</code></pre>

<p><strong>Verification:</strong></p>
<ul>
<li>[ ] All INT rules present in output</li>
<li>[ ] Rules loaded from cache (no hardcoded)</li>
<li>[ ] Format matches original output</li>
<li>[ ] Examples included (if enabled)</li>
<li>[ ] Test passes</li>
</ul>

<p>---</p>

<h3>Phase 1 Completion Checklist</h3>

<p><strong>Before proceeding to Phase 2, verify:</strong></p>

<ul>
<li>[ ] All 16 modules execute without errors</li>
<li>[ ] TemplateModule validation passes</li>
<li>[ ] Zero contradictions between modules</li>
<li>[ ] All STR rules loaded from cache</li>
<li>[ ] All INT rules loaded from cache</li>
<li>[ ] US-202 compliant (no duplicate loading)</li>
<li>[ ] All existing tests pass</li>
<li>[ ] No regression in definition quality</li>
</ul>

<p><strong>Commit:</strong></p>
<pre><code>git add src/services/prompts/modules/template_module.py
git add src/services/prompts/modules/error_prevention_module.py
git add src/services/prompts/modules/structure_rules_module.py
git add src/services/prompts/modules/integrity_rules_module.py
git commit -m "fix(prompts): resolve critical module issues

- Fix TemplateModule validation (ontologische_categorie)
- Resolve kick-off contradiction (noun vs verb)
- Convert STR rules to cache loading (US-202)
- Convert INT rules to cache loading (US-202)

All 16 modules now functional, zero contradictions.
Refs: DEF-XXX"</code></pre>

<p>---</p>

<h2>Phase 2: Simple Merges (6 hours)</h2>
<p><strong>Status:</strong> Ready after Phase 1 complete</p>

<h3>Task 2.1: Merge OutputSpec ‚Üí Expertise (1 hour)</h3>

<p><strong>Steps:</strong></p>
<ol>
<li>Read `/Users/chrislehnen/Projecten/Definitie-app/src/services/prompts/modules/output_specification_module.py`</li>
<li>Extract format methods</li>
<li>Integrate into ExpertiseModule</li>
<li>Remove OutputSpecificationModule</li>
<li>Update orchestrator registration</li>
<li>Test prompt generation</li>
</ol>

<p><strong>Files affected:</strong></p>
<ul>
<li>`src/services/prompts/modules/expertise_module.py` (edit)</li>
<li>`src/services/prompts/modules/output_specification_module.py` (delete)</li>
<li>`src/services/prompts/modules/prompt_orchestrator.py` (edit - registration)</li>
</ul>

<p>---</p>

<h3>Task 2.2: Merge Template ‚Üí Semantic (3 hours)</h3>

<p><strong>Steps:</strong></p>
<ol>
<li>Read both modules</li>
<li>Extract template methods from TemplateModule</li>
<li>Integrate into SemanticCategorisationModule ‚Üí CategoryGuidanceModule</li>
<li>Unify category guidance (ESS-02 + templates)</li>
<li>Remove TemplateModule</li>
<li>Update orchestrator registration</li>
<li>Test all 4 categories (proces, type, resultaat, exemplaar)</li>
</ol>

<p><strong>Files affected:</strong></p>
<ul>
<li>`src/services/prompts/modules/semantic_categorisation_module.py` (edit + rename)</li>
<li>`src/services/prompts/modules/template_module.py` (delete)</li>
<li>`src/services/prompts/modules/prompt_orchestrator.py` (edit)</li>
</ul>

<p>---</p>

<h3>Task 2.3: Merge ErrorPrev ‚Üí Validation (prep) (2 hours)</h3>

<p><strong>Steps:</strong></p>
<ol>
<li>Document ErrorPreventionModule structure</li>
<li>Identify forbidden patterns logic</li>
<li>Prepare integration plan for Phase 3</li>
<li>Keep module for now (merge in Phase 3)</li>
</ol>

<p><strong>Note:</strong> This is preparation only, actual merge happens in Phase 3</p>

<p>---</p>

<h2>Phase 3: Major Consolidation (8 hours)</h2>
<p><strong>Status:</strong> Ready after Phase 2 complete</p>

<h3>Task 3.1: Create ValidationRulesModule (4 hours)</h3>

<p><strong>Goal:</strong> Consolidate 7 rule modules + ErrorPrev into 1</p>

<p><strong>Steps:</strong></p>
<ol>
<li>Create new ValidationRulesModule</li>
<li>Implement unified rule loading (all categories)</li>
<li>Add forbidden patterns section (from ErrorPrev)</li>
<li>Test with subset of categories (ARAI, CON, ESS)</li>
<li>Add remaining categories (STR, INT, SAM, VER)</li>
<li>Full testing (45 rules present)</li>
</ol>

<p>---</p>

<h3>Task 3.2: Remove 7 old rule modules (2 hours)</h3>

<p><strong>Steps:</strong></p>
<ol>
<li>Delete individual rule modules</li>
<li>Update orchestrator registration</li>
<li>Run regression tests</li>
<li>Verify token count reduction</li>
</ol>

<p><strong>Files to delete:</strong></p>
<ul>
<li>`arai_rules_module.py`</li>
<li>`con_rules_module.py`</li>
<li>`ess_rules_module.py`</li>
<li>`structure_rules_module.py`</li>
<li>`integrity_rules_module.py`</li>
<li>`sam_rules_module.py`</li>
<li>`ver_rules_module.py`</li>
<li>`error_prevention_module.py`</li>
</ul>

<p>---</p>

<h2>Phase 4: Refinement (2 hours)</h2>
<p><strong>Status:</strong> Ready after Phase 3 complete</p>

<h3>Task 4.1: Simplify GrammarModule (1 hour)</h3>

<p><strong>Changes:</strong></p>
<ul>
<li>Remove strict mode (dead code)</li>
<li>Remove word type duplication</li>
<li>Focus on grammar only</li>
</ul>

<p>---</p>

<h3>Task 4.2: Simplify DefinitionTaskModule (1 hour)</h3>

<p><strong>Changes:</strong></p>
<ul>
<li>Reduce checklist (6‚Üí4 items)</li>
<li>Simplify metadata</li>
<li>Remove redundant sections</li>
</ul>

<p>---</p>

<h2>Testing Strategy</h2>

<h3>After each phase:</h3>

<pre><code># Unit tests
pytest tests/services/prompts/ -v

# Integration tests
pytest tests/integration/test_prompt_generation.py -v

# Regression tests
pytest tests/regression/ -v

# Token count measurement
python scripts/measure_prompt_tokens.py</code></pre>

<p>---</p>

<h2>Success Criteria</h2>

<h3>Phase 1 (Critical Fixes)</h3>
<ul>
<li>[ ] All 16 modules functional</li>
<li>[ ] Zero contradictions</li>
<li>[ ] US-202 compliant (all rules from cache)</li>
<li>[ ] All tests passing</li>
</ul>

<h3>Phase 2 (Simple Merges)</h3>
<ul>
<li>[ ] 16 ‚Üí 10 modules</li>
<li>[ ] ~1,000 tokens saved</li>
<li>[ ] All tests passing</li>
</ul>

<h3>Phase 3 (Major Consolidation)</h3>
<ul>
<li>[ ] 10 ‚Üí 7 modules</li>
<li>[ ] ~2,500 tokens saved</li>
<li>[ ] All 45 rules present</li>
<li>[ ] All tests passing</li>
</ul>

<h3>Phase 4 (Refinement)</h3>
<ul>
<li>[ ] Final optimization</li>
<li>[ ] Complexity: 3/10</li>
<li>[ ] All documentation updated</li>
</ul>

<p>---</p>

<h2>Rollback Plan</h2>

<p>If issues occur:</p>

<pre><code># Rollback last phase
git revert HEAD

# Or reset to before consolidation
git reset --hard &lt;commit-before-phase-X&gt;

# Feature flag fallback (if implemented)
export USE_LEGACY_MODULES=true</code></pre>

<p>---</p>

<h2>Documentation Updates</h2>

<p>After completion:</p>

<ul>
<li>[ ] Update `docs/refactor-log.md`</li>
<li>[ ] Update module documentation</li>
<li>[ ] Update architecture diagrams</li>
<li>[ ] Create PR with summary</li>
<li>[ ] Update `CLAUDE.md` if needed</li>
</ul>

<p>---</p>

<p><strong>Analysis files:</strong></p>
<ol>
<li>`PROMPT_MODULE_OPTIMIZATION_ANALYSIS.md` - Detailed analysis</li>
<li>`PROMPT_MODULE_CONSOLIDATION_VISUAL.md` - Visual guide</li>
<li>`PROMPT_MODULE_OPTIMIZATION_SUMMARY.md` - Executive summary</li>
<li>`PROMPT_MODULE_ACTION_CHECKLIST.md` - This file (action steps)</li>
</ol>

<p><strong>Ready to implement:</strong> Phase 1 can start immediately (4 hours, low risk)</p>

  </div>
</body>
</html>