<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CONTEXT INJECTION SCATTER - KEY FINDINGS</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">‚Üê Terug naar Portal</a>
    <h1>CONTEXT INJECTION SCATTER - KEY FINDINGS</h1>

<h2>Quick Reference: Where Context Instructions Are Scattered</h2>

<h3>üö® PROBLEM: Context handling is SPLIT across 3 different modules</h3>

<p>| # | Module | File | Line(s) | Injection | Token Cost |</p>
<p>|----|--------|------|---------|-----------|------------|</p>
<p>| 1Ô∏è‚É£ | <strong>ContextAwarenessModule</strong> | <code>context_awareness_module.py</code> | 239, 201, 277 | "üìå VERPLICHTE CONTEXT INFORMATIE" | ~200 |</p>
<p>| 2Ô∏è‚É£ | <strong>ErrorPreventionModule</strong> | <code>error_prevention_module.py</code> | 99 | "üö® CONTEXT-SPECIFIEKE VERBODEN" | ~100 |</p>
<p>| 3Ô∏è‚É£ | <strong>DefinitionTaskModule</strong> | <code>definition_task_module.py</code> | 204 | "Context verwerkt zonder expliciete benoeming" | ~80 |</p>

<p><strong>Total Redundant Token Cost: ~380 tokens</strong></p>

<p>---</p>

<h2>INJECTION POINT #1: ContextAwarenessModule</h2>

<p><strong>File:</strong> <code>src/services/prompts/modules/context_awareness_module.py</code></p>

<h3>What It Does:</h3>
<ul>
<li>Calculates `context_richness_score` (0.0-1.0) based on context quality</li>
<li>Generates adaptive formatting:</li>
<li> - Rich (‚â•0.8): "üìä UITGEBREIDE CONTEXT ANALYSE"</li>
<li> - Moderate (0.5-0.8): "üìå VERPLICHTE CONTEXT INFORMATIE"</li>
<li> - Minimal (<0.5): "üìç VERPLICHTE CONTEXT"</li>
<li>**Shares context via shared_state:**</li>
<pre><code>  context.set_shared("organization_contexts", org_contexts)
  context.set_shared("juridical_contexts", jur_contexts)
  context.set_shared("legal_basis_contexts", wet_contexts)</code></pre>
</ul>

<h3>Context Instruction Text (Lines 239-242):</h3>
<pre><code>"üìå VERPLICHTE CONTEXT INFORMATIE:"
"‚ö†Ô∏è BELANGRIJKE INSTRUCTIE: Gebruik onderstaande context om de definitie 
specifiek te maken voor deze organisatorische, juridische en wettelijke context. 
Formuleer de definitie zodanig dat deze past binnen deze specifieke context, 
zonder de context expliciet te benoemen."</code></pre>

<h3>Problem:</h3>
<ul>
<li>**Score-based formatting** not propagated to other modules</li>
<li>Other modules don't know if context is rich/moderate/minimal</li>
<li>Can't adapt their output based on context richness</li>
</ul>

<p>---</p>

<h2>INJECTION POINT #2: ErrorPreventionModule</h2>

<p><strong>File:</strong> <code>src/services/prompts/modules/error_prevention_module.py</code></p>

<h3>What It Does:</h3>
<ul>
<li>**Reads shared_state** from ContextAwarenessModule (Lines 75-79):</li>
<pre><code>  org_contexts = context.get_shared("organization_contexts", [])
  jur_contexts = context.get_shared("juridical_contexts", [])
  wet_contexts = context.get_shared("legal_basis_contexts", [])</code></pre>
<li>Maps organization codes to full names (Lines 209-219):</li>
<pre><code>  org_mappings = {
      "NP": "Nederlands Politie",
      "DJI": "Dienst Justiti√´le Inrichtingen",
      ...
  }</code></pre>
<li>Generates context-specific forbidden patterns (Lines 193-245)</li>
</ul>

<h3>Context Injection (Lines 95-100):</h3>
<pre><code>context_forbidden = self._build_context_forbidden(...)
if context_forbidden:
    sections.append("\n### üö® CONTEXT-SPECIFIEKE VERBODEN:")
    sections.extend(context_forbidden)</code></pre>

<h3>Generated Output Example:</h3>
<pre><code>### üö® CONTEXT-SPECIFIEKE VERBODEN:
- Gebruik de term 'NP' niet letterlijk in de definitie.
- Gebruik de term 'Nederlands Politie' niet letterlijk in de definitie.
- Vermijd expliciete vermelding van juridisch context 'Strafrecht' in de definitie.
- Vermijd expliciete vermelding van wetboek 'Wetboek van Strafrecht' in de definitie.</code></pre>

<h3>Problems:</h3>
<ol>
<li>**Organization mappings hardcoded** - Not centralized, not reusable</li>
<li>**Re-lists contexts already shown** - User sees same contexts 2-3 times</li>
<li>**Tight coupling** - Depends on ContextAwarenessModule's shared_state</li>
<li>**Dependency marked explicitly** - `get_dependencies() = ["context_awareness"]`</li>
</ol>

<p>---</p>

<h2>INJECTION POINT #3: DefinitionTaskModule</h2>

<p><strong>File:</strong> <code>src/services/prompts/modules/definition_task_module.py</code></p>

<h3>What It Does:</h3>
<ul>
<li>Generates final instructions and metadata</li>
<li>Reads context **directly from base_context** (NOT via shared_state) - Lines 84-104:</li>
<pre><code>  base_ctx = context.enriched_context.base_context
  jur_contexts = base_ctx.get("juridische_context") or base_ctx.get("juridisch") or []
  wet_basis = base_ctx.get("wettelijke_basis") or base_ctx.get("wettelijk") or []
  has_context = bool(org_contexts or jur_contexts or wet_basis)</code></pre>
<li>Adapts quality control questions based on `has_context`</li>
<li>Generates context metadata listing</li>
</ul>

<h3>Context References:</h3>

<p><strong>In Checklist (Line 204):</strong></p>
<pre><code>‚Üí Context verwerkt zonder expliciete benoeming</code></pre>

<p><strong>Quality Control Adaption (Lines 206-223):</strong></p>
<pre><code>if has_context:
    q3 = "Is de formulering specifiek genoeg voor de gegeven context?"
else:
    q3 = "Is de formulering specifiek genoeg voor algemeen gebruik?"</code></pre>

<p><strong>Metadata Generation (Lines 259-299):</strong></p>
<pre><code>if jur_contexts:
    lines.append(f"- Juridische context: {', '.join(jur_contexts)}")
if wet_basis:
    lines.append(f"- Wettelijke basis: {', '.join(wet_basis)}")</code></pre>

<h3>Problems:</h3>
<ol>
<li>**Inconsistent data access** - Reads base_context directly (unlike ErrorPreventionModule)</li>
<li>**Doesn't use shared_state** - Ignores score or context richness</li>
<li>**Static checklist text** - Always the same, not context-aware</li>
<li>**Re-lists contexts again** - Third place where contexts are mentioned</li>
</ol>

<p>---</p>

<h2>DATA FLOW VISUALIZATION</h2>

<pre><code>GenerationRequest
    ‚Üì
HybridContextManager.build_enriched_context()
    ‚Üì
EnrichedContext:
  base_context = {
    "organisatorisch": ["NP"],
    "juridisch": ["Strafrecht"],
    "wettelijk": ["Wetboek..."]
  }
    ‚Üì
PromptOrchestrator.build_prompt()
    ‚îú‚îÄ‚Üí ContextAwarenessModule
    ‚îÇ   ‚îú‚îÄ Calculates: context_score = 0.35
    ‚îÇ   ‚îú‚îÄ Generates: "üìå VERPLICHTE CONTEXT INFORMATIE"
    ‚îÇ   ‚îî‚îÄ Shares:
    ‚îÇ      - organization_contexts: ["NP"]
    ‚îÇ      - juridical_contexts: ["Strafrecht"]
    ‚îÇ      - legal_basis_contexts: ["Wetboek..."]
    ‚îÇ      - context_richness_score: 0.35
    ‚îÇ
    ‚îú‚îÄ‚Üí ErrorPreventionModule (depends on context_awareness)
    ‚îÇ   ‚îú‚îÄ Reads: shared_state
    ‚îÇ   ‚îú‚îÄ Maps: NP ‚Üí "Nederlands Politie"
    ‚îÇ   ‚îú‚îÄ Generates: "üö® CONTEXT-SPECIFIEKE VERBODEN"
    ‚îÇ   ‚îî‚îÄ Lists contexts again:
    ‚îÇ      - NP (literal)
    ‚îÇ      - Nederlands Politie (full name)
    ‚îÇ      - Strafrecht
    ‚îÇ      - Wetboek...
    ‚îÇ
    ‚îî‚îÄ‚Üí DefinitionTaskModule (depends on semantic_categorisation)
        ‚îú‚îÄ Reads: base_context DIRECTLY
        ‚îú‚îÄ Detects: has_context = True
        ‚îú‚îÄ Generates:
        ‚îÇ  - Quality control (context-aware)
        ‚îÇ  - Metadata section
        ‚îÇ  - Checklist line: "Context verwerkt zonder..."
        ‚îî‚îÄ Lists contexts THIRD time:
           - Organisatorische: NP
           - Juridische: Strafrecht
           - Wettelijke basis: Wetboek...</code></pre>

<p>---</p>

<h2>CONSOLIDATION OPPORTUNITY</h2>

<h3>Current Situation:</h3>
<ul>
<li>**3 modules** generate context-related content</li>
<li>**380 tokens** wasted on redundancy</li>
<li>**No single source of truth** for context guidance</li>
<li>**Inconsistent data access** patterns</li>
</ul>

<h3>Proposed Solution:</h3>

<p><strong>Create a single ContextInjectionModule</strong> that:</p>

<ol>
<li>**Consolidates all context output** into one place</li>
<li>**Uses context_richness_score** to determine output level</li>
<li>**Generates all three parts together:**</li>
</ol>
<ul>
<li>  - Initial context instructions (adaptive)</li>
<li>  - Context-specific forbidden patterns</li>
<li>  - Context metadata</li>
</ul>
<ol>
<li>**Centralizes organization mappings**</li>
<li>**Enforces consistent data access** via shared_state</li>
</ol>

<h3>Benefits:</h3>
<ul>
<li>‚úÖ Reduce token usage by ~200-300 tokens</li>
<li>‚úÖ Single source of truth for context handling</li>
<li>‚úÖ Easier maintenance and updates</li>
<li>‚úÖ Clear responsibility separation</li>
<li>‚úÖ Reusable organization mappings</li>
</ul>

<p>---</p>

<h2>DETAILED CONTEXT LOCATIONS FOR CONSOLIDATION</h2>

<h3>Module 1: ContextAwarenessModule</h3>
<ul>
<li>**File:** `src/services/prompts/modules/context_awareness_module.py`</li>
<li>**Lines to consolidate:**</li>
<li> - 239: Moderate context header</li>
<li> - 201: Rich context header</li>
<li> - 277: Minimal context fallback</li>
<li> - 368-395: Shared state distribution</li>
</ul>

<h3>Module 2: ErrorPreventionModule</h3>
<ul>
<li>**File:** `src/services/prompts/modules/error_prevention_module.py`</li>
<li>**Lines to consolidate:**</li>
<li> - 75-79: Context retrieval</li>
<li> - 95-100: Context forbidden injection</li>
<li> - 193-245: _build_context_forbidden() method</li>
<li> - 209-219: Organization mappings</li>
</ul>

<h3>Module 3: DefinitionTaskModule</h3>
<ul>
<li>**File:** `src/services/prompts/modules/definition_task_module.py`</li>
<li>**Lines to consolidate:**</li>
<li> - 84-104: Context detection from base_context</li>
<li> - 206-223: Context-aware quality control</li>
<li> - 259-299: Context metadata generation</li>
<li> - 204: Checklist line "Context verwerkt..."</li>
</ul>

<p>---</p>

<h2>EXECUTION ORDER IMPACT</h2>

<pre><code>Current order (PromptOrchestrator, lines 354-372):

...
4. context_awareness           (Priority: 70)
...
14. error_prevention           (Depends: ["context_awareness"])
16. definition_task            (Depends: ["semantic_categorisation"])

New proposed order (after consolidation):

...
4. context_injection           (Priority: 75, single source of truth)
...
(error_prevention and definition_task no longer handle context)</code></pre>

<p>---</p>

<h2>NEXT STEPS FOR IMPLEMENTATION</h2>

<h3>Phase 1: Analysis & Planning</h3>
<ul>
<li>‚úÖ **DONE:** Identify all context injection points (3 modules)</li>
<li>‚úÖ **DONE:** Map data dependencies</li>
<li>‚úÖ **DONE:** Quantify token waste</li>
<li>**TODO:** Design new ContextInjectionModule interface</li>
<li>**TODO:** Plan fallback/compatibility strategy</li>
</ul>

<h3>Phase 2: Consolidation</h3>
<ul>
<li>**TODO:** Create new ContextInjectionModule</li>
<li>**TODO:** Test context richness scoring</li>
<li>**TODO:** Verify organization mappings work</li>
<li>**TODO:** Update ErrorPreventionModule to remove context logic</li>
<li>**TODO:** Update DefinitionTaskModule to remove context logic</li>
</ul>

<h3>Phase 3: Integration & Testing</h3>
<ul>
<li>**TODO:** Update ModularPromptAdapter registration</li>
<li>**TODO:** Test with various context combinations</li>
<li>**TODO:** Verify token reduction</li>
<li>**TODO:** Test UI integration</li>
</ul>

<h3>Phase 4: Documentation</h3>
<ul>
<li>**TODO:** Update architecture documentation</li>
<li>**TODO:** Document ContextInjectionModule design</li>
<li>**TODO:** Update developer guidelines</li>
</ul>


  </div>
</body>
</html>