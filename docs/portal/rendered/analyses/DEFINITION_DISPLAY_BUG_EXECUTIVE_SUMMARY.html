<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EXECUTIVE SUMMARY: Definitie Display Bug</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">← Terug naar Portal</a>
    <h1>EXECUTIVE SUMMARY: Definitie Display Bug</h1>

<p><strong>Date:</strong> 2025-10-07</p>
<p><strong>Status:</strong> CRITICAL - Root Cause Identified</p>
<p><strong>Impact:</strong> UI displays unwanted metadata in generated definitions</p>

<p>---</p>

<h2>THE PROBLEM</h2>

<p>Users see this:</p>
<pre><code>Ontologische categorie: soord
Vervoersverbod: maatregel die een persoon verbiedt zich met een vervoermiddel...</code></pre>

<p>Users expect this:</p>
<pre><code>Maatregel die een persoon verbiedt zich met een vervoermiddel...</code></pre>

<p>---</p>

<h2>ROOT CAUSE (In Plain English)</h2>

<h3>Issue 1: "Ontologische categorie: soort" Header</h3>

<p><strong>Why it appears:</strong> The prompt tells GPT to output this as the first line.</p>

<p><strong>Why it's not removed:</strong> The cleaning function <code>extract_definition_from_gpt_response()</code> correctly removes lines starting with "ontologische categorie:", but the user reported "soord" (typo?) which suggests either:</p>
<ul>
<li>User typo in report</li>
<li>OR the line comes from a different data source</li>
</ul>

<p><strong>Fix status:</strong> Already implemented in code, may be a reporting error.</p>

<h3>Issue 2: "Vervoersverbod:" Prefix (REGRESSION)</h3>

<p><strong>Why it appears:</strong></p>
<ol>
<li>The prompt says: "Geef nu de definitie van het begrip **vervoersverbod**"</li>
<li>GPT interprets this as: "Output should include the term being defined"</li>
<li>GPT generates: "Vervoersverbod: maatregel die..."</li>
</ol>

<p><strong>Why it's not removed:</strong></p>
<ul>
<li>The "definitie_origineel" field uses `extract_definition_from_gpt_response()`</li>
<li>This function only removes "Ontologische categorie:" lines</li>
<li>It does NOT remove the term prefix from the definition line itself</li>
</ul>

<p><strong>Why this is a regression:</strong></p>
<ul>
<li>The full cleaning pipeline (`opschonen()`) DOES remove term prefixes</li>
<li>But it's only applied to "definitie_gecorrigeerd", not "definitie_origineel"</li>
<li>Before the recent fix, this wasn't an issue because the cleaning was different</li>
</ul>

<p>---</p>

<h2>DATA FLOW BREAKDOWN</h2>

<pre><code>PROMPT GENERATION
↓
GPT-4 generates:
  Line 1: "Ontologische categorie: resultaat"
  Line 2: "Vervoersverbod: maatregel die..."
↓
CLEANING PIPELINE (TWO PATHS)
↓
Path A: cleaning_service.clean_text() → opschonen()
  Result: "Maatregel die..."
  Used for: definitie_gecorrigeerd ✅ WORKS
↓
Path B: extract_definition_from_gpt_response()
  Removes: "Ontologische categorie:" line ✅
  Keeps: "Vervoersverbod: maatregel die..." ❌ BUG
  Used for: definitie_origineel
↓
UI DISPLAY
  Shows: "Vervoersverbod: maatregel die..." ❌ VISIBLE TO USER</code></pre>

<p>---</p>

<h2>THE FIX</h2>

<h3>Recommended: Hybrid Approach</h3>

<p><strong>Short-term (Quick Fix):</strong></p>
<p>Enhance <code>extract_definition_from_gpt_response()</code> to also remove term prefixes.</p>

<pre><code># In opschoning_enhanced.py
def extract_definition_from_gpt_response(text: str, begrip: str = None) -&gt; str:
    lines = text.strip().split("\n")
    filtered_lines = []

    for line in lines:
        line_lower = line.lower().strip()

        # Skip ontologische categorie regels
        if line_lower.startswith("ontologische categorie:"):
            continue

        # Skip lege regels
        if not line.strip():
            continue

        # NEW: Remove term prefix if present
        if begrip and line_lower.startswith(begrip.lower() + ":"):
            line = line.split(":", 1)[1].strip()

        filtered_lines.append(line)

    return "\n".join(filtered_lines).strip()</code></pre>

<p><strong>Long-term (Prevent at Source):</strong></p>
<p>Update prompt to explicitly tell GPT NOT to include the term prefix.</p>

<pre><code># In definition_task_module.py
def _build_final_instruction(self, begrip: str) -&gt; str:
    return f"""✏️ Geef nu de definitie van het begrip **{begrip}** in één enkele zin, zonder toelichting.

⚠️ BELANGRIJK: Begin DIRECT met de definitie. Gebruik NIET het begrip zelf aan het begin.

FOUT: "Vervoersverbod: maatregel die..."
GOED: "Maatregel die een persoon verbiedt..."
"""</code></pre>

<p>---</p>

<h2>FILES TO CHANGE</h2>

<ol>
<li>**src/opschoning/opschoning_enhanced.py**</li>
</ol>
<ul>
<li>  - Line 42: Update function signature to accept `begrip` parameter</li>
<li>  - Line 80: Add logic to remove "term:" prefix</li>
</ul>

<ol>
<li>**src/services/orchestrators/definition_orchestrator_v2.py**</li>
</ol>
<ul>
<li>  - Line 595: Pass `begrip` to `extract_definition_from_gpt_response()`</li>
</ul>

<ol>
<li>**src/services/prompts/modules/definition_task_module.py**</li>
</ol>
<ul>
<li>  - Line 256: Update prompt to prohibit term prefix in output</li>
</ul>

<p>---</p>

<h2>TESTING CHECKLIST</h2>

<ul>
<li>[ ] Test "vervoersverbod" - verify no "Vervoersverbod:" prefix</li>
<li>[ ] Test "elektronisch toezicht" - multi-word term</li>
<li>[ ] Test "sanctie" - verify no "Sanctie:" prefix</li>
<li>[ ] Verify "Ontologische categorie:" header is removed</li>
<li>[ ] Test both definitie_origineel AND definitie_gecorrigeerd</li>
<li>[ ] Regression test: verify opschonen() still works for other cases</li>
</ul>

<p>---</p>

<h2>RISK ASSESSMENT</h2>

<p><strong>Risk Level:</strong> LOW</p>

<p><strong>Why:</strong></p>
<ul>
<li>Changes are localized to cleaning functions</li>
<li>Existing tests should catch regressions</li>
<li>The `opschonen()` function already handles term prefixes correctly</li>
<li>We're just applying the same logic earlier in the pipeline</li>
</ul>

<p><strong>Rollback Plan:</strong></p>
<ul>
<li>If issues arise, simply revert the changes to `extract_definition_from_gpt_response()`</li>
<li>The "definitie_gecorrigeerd" path will still work correctly</li>
</ul>

<p>---</p>

<h2>ESTIMATED EFFORT</h2>

<ul>
<li>**Code changes:** 30 minutes</li>
<li>**Testing:** 1 hour</li>
<li>**Total:** ~1.5 hours</li>
</ul>

<p>---</p>

<h2>NEXT STEPS</h2>

<ol>
<li>Implement short-term fix (enhance `extract_definition_from_gpt_response()`)</li>
<li>Update caller in `definition_orchestrator_v2.py` to pass `begrip`</li>
<li>Run test suite</li>
<li>Manual testing with real examples</li>
<li>Implement long-term fix (update prompt) if needed</li>
<li>Document changes in refactor log</li>
</ol>

<p>---</p>

<h2>REFERENCE</h2>

<p>Full technical analysis: <code>/Users/chrislehnen/Projecten/Definitie-app/docs/analyses/ROOT_CAUSE_ANALYSIS_DEFINITION_DISPLAY_BUG.md</code></p>

  </div>
</body>
</html>