<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DEF-101 Technical Complexity & Dependencies Analysis</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">← Terug naar Portal</a>
    <h1>DEF-101 Technical Complexity & Dependencies Analysis</h1>

<p><strong>Document Status:</strong> Complete - Ready for Implementation Planning</p>
<p><strong>Date:</strong> 2025-11-10</p>
<p><strong>Analyst:</strong> Debug Specialist</p>
<p><strong>Purpose:</strong> Technical debugging assessment for DEF-101 prompt optimization implementation</p>

<p>---</p>

<h2>Executive Summary</h2>

<h3>Problem Statement</h3>

<p>DEF-101 addresses <strong>5 BLOCKING contradictions</strong> in the prompt generation system that make it currently unusable (100% of definitions violate contradictory rules). This analysis provides the technical dependency graph, risk assessment, and execution strategy from a debugging perspective.</p>

<h3>Key Findings</h3>

<ol>
<li>**Architecture Type:** Modular pipeline with dependency injection (PromptOrchestrator + 16 modules)</li>
<li>**Critical Path:** 3 modules (error_prevention, semantic_categorisation, arai_rules) contain ALL 5 blockers</li>
<li>**Parallel Capability:** HIGH - 60% of issues can run simultaneously</li>
<li>**Rollback Complexity:** LOW - Module isolation makes rollback straightforward</li>
<li>**Test Coverage:** Currently 33% (test_prompt_orchestrator.py exists, no contradiction tests)</li>
</ol>

<p>---</p>

<h2>1. DEPENDENCY GRAPH & BLOCKING ANALYSIS</h2>

<h3>1.1 Issue Dependency Matrix</h3>

<pre><code>LEGEND:
→ Blocks (must complete before dependent starts)
|| Can run in parallel
⊕ Bundled (no extra cost to do together)

PHASE 1 (CRITICAL - Week 1):
┌─────────────────────────────────────────────────────────────────┐
│ CONTRADICTION FIXES (Day 1 - 3 hours)                           │
├─────────────────────────────────────────────────────────────────┤
│ 1.1: ESS-02 "is" exception      [1h]  →  1.4: Article bundled  │
│ 1.2: Container exemption         [30m] || 1.3: Relative clauses │
│ 1.3: Relative clause clarity     [30m] || 1.2: Container        │
│ 1.4: Article "een" (bundled)     [0h]  ⊕  with 1.1              │
│                                                                   │
│ DEPENDENCIES:                                                    │
│ - 1.4 BLOCKED BY 1.1 (same fix location)                        │
│ - 1.2 || 1.3 (different modules, no conflict)                   │
│ - 4.1/4.2 SHOULD WAIT FOR 1.3 (uses relative clause guidance)   │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│ COGNITIVE LOAD (Day 2 - 2 hours)                                │
├─────────────────────────────────────────────────────────────────┤
│ 2.1: Categorize 42 patterns      [1h]  →  2.4: Koppelwerkwoord │
│ 2.5: Add 3-tier system           [1h]  || 2.1: Categorize      │
│                                                                   │
│ DEPENDENCIES:                                                    │
│ - 2.4 BLOCKED BY 2.1 (forbidden verb list merges into 2.1)     │
│ - 2.5 || 2.1 (different concerns: organization vs prioritization)│
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│ STRUCTURE &amp; REDUNDANCY (Day 3 - 3 hours)                        │
├─────────────────────────────────────────────────────────────────┤
│ 3.1: Reorder modules             [1h]  →  3.2: Metadata bundled │
│ 3.2: Move metadata (bundled)     [0h]  ⊕  with 3.1              │
│ 2.2: Consolidate ESS-02          [2h]  || 2.3: Enkelvoud        │
│ 2.3: Consolidate enkelvoud       [30m] || 2.4: Koppelwerkwoord  │
│ 2.4: Consolidate koppelwerkwoord [1h]  WAIT 2.1                 │
│                                                                   │
│ DEPENDENCIES:                                                    │
│ - 3.2 BUNDLED WITH 3.1 (orchestrator config)                    │
│ - 2.2 || 2.3 || 2.4 (different modules)                         │
│ - 2.4 WAITS FOR 2.1 (merge forbidden list)                      │
└─────────────────────────────────────────────────────────────────┘

PHASE 2 (QUALITY - Week 2):
┌─────────────────────────────────────────────────────────────────┐
│ TEMPLATE &amp; VALIDATION (Day 1 - 4 hours)                         │
├─────────────────────────────────────────────────────────────────┤
│ 4.1: Fix template Line 112       [1h]  ⊕  with 4.2              │
│ 4.2: Fix template Line 115       [0h]  (bundled)                │
│ 4.3: Visual priority badges      [1h]  WAIT 2.5                 │
│ 1.5: Clarify context usage       [1h]  || 4.1/4.2               │
│                                                                   │
│ DEPENDENCIES:                                                    │
│ - 4.1 + 4.2 bundled (same file, same pattern)                   │
│ - 4.3 WAITS FOR 2.5 (needs tier definitions)                    │
│ - 1.5 independent (context_awareness_module.py)                  │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│ AUTOMATION (Day 2 - 2 hours)                                    │
├─────────────────────────────────────────────────────────────────┤
│ 5.1: PromptValidator             [2h]  →  5.2: Regression tests │
│                                                                   │
│ DEPENDENCIES:                                                    │
│ - 5.2 BLOCKED BY 5.1 (uses PromptValidator)                     │
└─────────────────────────────────────────────────────────────────┘

PHASE 3 (DOCUMENTATION - Week 3):
┌─────────────────────────────────────────────────────────────────┐
│ TESTING &amp; DOCS (Day 1-2 - 4 hours)                              │
├─────────────────────────────────────────────────────────────────┤
│ 5.2: Regression test suite       [2h]  WAIT 5.1                 │
│ 5.3: Module dependency docs      [1h]  WAIT ALL                 │
│                                                                   │
│ DEPENDENCIES:                                                    │
│ - 5.2 WAITS FOR 5.1 (validator dependency)                      │
│ - 5.3 WAITS FOR ALL (documents final state)                     │
└─────────────────────────────────────────────────────────────────┘</code></pre>

<h3>1.2 Blocking Chain Analysis</h3>

<p><strong>CRITICAL PATH (Must execute sequentially):</strong></p>
<pre><code>1.1 ESS-02 exception → 1.4 Article bundled → 4.1/4.2 Template fixes

2.1 Categorize patterns → 2.4 Koppelwerkwoord consolidation

3.1 Module reorder → 3.2 Metadata move

2.5 Tier system → 4.3 Visual badges

5.1 PromptValidator → 5.2 Regression tests → 5.3 Documentation</code></pre>

<p><strong>PARALLEL TRACKS (Can run simultaneously):</strong></p>
<pre><code>TRACK A: 1.2 Container + 1.3 Relative + 1.5 Context
TRACK B: 2.2 ESS-02 + 2.3 Enkelvoud (until 2.4 ready)
TRACK C: 2.1 Categorize || 2.5 Tier system</code></pre>

<p><strong>Parallelization Potential:</strong> 11 of 18 tasks (61%) can run in parallel</p>

<p>---</p>

<h2>2. RISK ASSESSMENT PER ISSUE</h2>

<h3>2.1 Risk Scoring Matrix</h3>

<p><strong>Risk Score = (Breaking Potential × Scope × Reversibility) / 10</strong></p>

<p>| Issue | Breaking Potential | Scope (files) | Reversibility | Risk Score | Rationale |</p>
<p>|-------|-------------------|---------------|---------------|------------|-----------|</p>
<p>| <strong>1.1</strong> ESS-02 "is" | 7/10 (HIGH) | 1 file | 9/10 (EASY) | <strong>6.3 (MEDIUM)</strong> | Changes exception logic, but isolated to error_prevention_module.py. Clear rollback path. |</p>
<p>| <strong>1.2</strong> Container | 5/10 (MED) | 1 file | 10/10 (EASY) | <strong>5.0 (MEDIUM)</strong> | Exempts ontological markers from ARAI-02. Low impact - makes validation more permissive. |</p>
<p>| <strong>1.3</strong> Relative clause | 6/10 (MED-HIGH) | 1 file | 9/10 (EASY) | <strong>5.4 (MEDIUM)</strong> | Clarifies existing ambiguity. Risk: might make AI use relative clauses MORE. |</p>
<p>| <strong>1.4</strong> Article bundled | 2/10 (LOW) | 0 files | 10/10 (EASY) | <strong>2.0 (LOW)</strong> | Bundled with 1.1, no separate risk. |</p>
<p>| <strong>1.5</strong> Context usage | 4/10 (MED-LOW) | 1 file | 8/10 (EASY) | <strong>4.0 (MEDIUM-LOW)</strong> | Guidance only, doesn't change rules. Low breaking potential. |</p>
<p>| <strong>2.1</strong> Categorize 42 | 3/10 (MED-LOW) | 1 file | 7/10 (MEDIUM) | <strong>3.0 (MEDIUM-LOW)</strong> | Reorganizes display, doesn't change rules. Risk: harder to revert (text structure change). |</p>
<p>| <strong>2.2</strong> ESS-02 redundancy | 8/10 (HIGH) | 1 file | 6/10 (MEDIUM) | <strong>8.0 (HIGH)</strong> | Consolidates 38→20 lines. Risk: might lose nuance. NEEDS CAREFUL REVIEW. |</p>
<p>| <strong>2.3</strong> Enkelvoud consolidate | 3/10 (LOW) | 2 files | 8/10 (EASY) | <strong>3.0 (MEDIUM-LOW)</strong> | Cross-references only. Low risk. |</p>
<p>| <strong>2.4</strong> Koppelwerkwoord | 6/10 (MED-HIGH) | 2 files | 7/10 (MEDIUM) | <strong>5.4 (MEDIUM)</strong> | Deletes ARAI-06, merges into STR-01. Risk: lose rule if merge incomplete. |</p>
<p>| <strong>2.5</strong> 3-tier system | 5/10 (MEDIUM) | 1 file + ALL | 8/10 (EASY) | <strong>5.0 (MEDIUM)</strong> | Adds metadata, doesn't remove rules. Risk: AI focuses only on TIER 1. |</p>
<p>| <strong>3.1</strong> Reorder modules | 7/10 (MED-HIGH) | 1 file | 9/10 (EASY) | <strong>6.3 (MEDIUM)</strong> | Changes execution order. Risk: dependency breaks. GOOD TESTS REQUIRED. |</p>
<p>| <strong>3.2</strong> Metadata move | 2/10 (LOW) | 1 file | 10/10 (EASY) | <strong>2.0 (LOW)</strong> | Bundled with 3.1, no separate risk. |</p>
<p>| <strong>4.1/4.2</strong> Template fixes | 4/10 (MED-LOW) | 1 file | 9/10 (EASY) | <strong>4.0 (MEDIUM-LOW)</strong> | Fixes template compliance. Low risk - makes templates BETTER. |</p>
<p>| <strong>4.3</strong> Visual badges | 2/10 (LOW) | 10 files | 8/10 (EASY) | <strong>2.5 (LOW)</strong> | Adds emojis. Risk: visual clutter, but easy to revert. |</p>
<p>| <strong>5.1</strong> PromptValidator | 3/10 (LOW) | 0 files (new) | 10/10 (EASY) | <strong>3.0 (MEDIUM-LOW)</strong> | New code, no existing system changes. Can disable if buggy. |</p>
<p>| <strong>5.2</strong> Regression tests | 1/10 (VERY LOW) | 0 files (new) | 10/10 (EASY) | <strong>1.0 (LOW)</strong> | Tests only. No production code risk. |</p>
<p>| <strong>5.3</strong> Documentation | 0/10 (NONE) | 0 files (new) | 10/10 (EASY) | <strong>0.0 (NONE)</strong> | Documentation only. Zero breaking risk. |</p>

<h3>2.2 Top 3 Riskiest Changes</h3>

<p><strong>1. Issue 2.2: ESS-02 Consolidation (Risk Score: 8.0)</strong></p>
<ul>
<li>**Risk:** Consolidating 38 lines to 20 might lose critical nuance in category-specific guidance</li>
<li>**Impact:** TYPE/EXEMPLAAR definitions might become less specific</li>
<li>**Mitigation:**</li>
<li> - Create golden reference set of 10 definitions (before consolidation)</li>
<li> - Re-generate same definitions after change</li>
<li> - Compare quality scores</li>
<li> - If quality drops >5%, revert and iterate</li>
<li>**Rollback:** Git revert straightforward</li>
<li>**Testing:** MANDATORY A/B testing with real definitions</li>
</ul>

<p><strong>2. Issue 3.1: Module Reordering (Risk Score: 6.3)</strong></p>
<ul>
<li>**Risk:** Changing execution order might break module dependencies or shared state</li>
<li>**Impact:** Modules expecting data from previous modules might get empty context</li>
<li>**Mitigation:**</li>
<li> - Audit `get_dependencies()` for ALL modules (already exists in code!)</li>
<li> - Run `orchestrator.resolve_execution_order()` and validate output</li>
<li> - Check shared_state access patterns (grep for `context.set_shared` and `context.get_shared`)</li>
<li>**Rollback:** One-line revert in `_get_default_module_order()`</li>
<li>**Testing:** Existing test `test_orchestrator_resolves_dependencies_and_builds_prompt()` MUST PASS</li>
</ul>

<p><strong>3. Issue 1.1: ESS-02 "is" Exception (Risk Score: 6.3)</strong></p>
<ul>
<li>**Risk:** Exception clause might be misinterpreted by AI, leading to overuse of "is"</li>
<li>**Impact:** AI might start EVERY definition with "is" thinking it's always allowed</li>
<li>**Mitigation:**</li>
<li> - Make exception VERY specific: "ONLY for ontological category marking"</li>
<li> - Add counter-examples: "❌ is een document (NO! Unless TYPE category)"</li>
<li> - Test with 20 definitions across all 4 categories</li>
<li>**Rollback:** Remove exception clause (simple text deletion)</li>
<li>**Testing:** Validate ESS-02 compliance rate before/after (should go from 0% → 80%+)</li>
</ul>

<p>---</p>

<h2>3. PARALLEL EXECUTION STRATEGY</h2>

<h3>3.1 Optimal Execution Batches</h3>

<p><strong>Day 1 (3 hours) - CONTRADICTIONS:</strong></p>
<pre><code>BATCH 1 (Sequential - 1.5h):
└─ 1.1 ESS-02 "is" exception + 1.4 Article bundled

BATCH 2 (Parallel - 1h):
├─ Developer A: 1.2 Container exemption
└─ Developer B: 1.3 Relative clause clarity

BATCH 3 (Sequential - 0.5h):
└─ 4.1 + 4.2 Template fixes (bundled)</code></pre>

<p><strong>Day 2 (2 hours) - COGNITIVE LOAD:</strong></p>
<pre><code>BATCH 4 (Parallel - 1h):
├─ Developer A: 2.1 Categorize 42 patterns
└─ Developer B: 2.5 Add 3-tier system

BATCH 5 (Sequential - 1h):
└─ 2.4 Koppelwerkwoord consolidation (waits for 2.1)</code></pre>

<p><strong>Day 3 (3 hours) - STRUCTURE:</strong></p>
<pre><code>BATCH 6 (Sequential - 1.5h):
└─ 3.1 Module reorder + 3.2 Metadata move (bundled)

BATCH 7 (Parallel - 1.5h):
├─ Developer A: 2.2 ESS-02 consolidation (HIGH RISK - needs careful review)
├─ Developer B: 2.3 Enkelvoud consolidation
└─ (2.4 already done in Day 2)</code></pre>

<p><strong>Week 2 - QUALITY:</strong></p>
<pre><code>BATCH 8 (Parallel - 2h):
├─ Developer A: 1.5 Context usage clarity
└─ Developer B: 4.3 Visual priority badges (waits for 2.5)

BATCH 9 (Sequential - 2h):
└─ 5.1 PromptValidator automation</code></pre>

<p><strong>Week 3 - TESTING:</strong></p>
<pre><code>BATCH 10 (Sequential - 2h):
└─ 5.2 Regression test suite (waits for 5.1)

BATCH 11 (Solo - 1h):
└─ 5.3 Documentation (waits for all)</code></pre>

<h3>3.2 Single Developer vs Multi-Developer</h3>

<p><strong>Single Developer Timeline (Sequential):</strong></p>
<ul>
<li>Week 1: 8 hours (as planned)</li>
<li>Week 2: 4 hours</li>
<li>Week 3: 3 hours</li>
<li>**Total: 15 hours**</li>
</ul>

<p><strong>Two Developer Timeline (Optimal Parallel):</strong></p>
<ul>
<li>Week 1: 5.5 hours (save 2.5h via parallel execution)</li>
<li>Week 2: 3 hours (save 1h)</li>
<li>Week 3: 3 hours (no parallelization benefit)</li>
<li>**Total: 11.5 hours**</li>
</ul>

<p><strong>Recommendation:</strong> SINGLE DEVELOPER execution acceptable</p>
<ul>
<li>Parallelization saves only 3.5 hours (23%)</li>
<li>Coordination overhead: 1-2 hours</li>
<li>Net benefit: 1.5-2.5 hours</li>
<li>**NOT WORTH** the merge conflict risk for this scope</li>
</ul>

<p>---</p>

<h2>4. TESTING STRATEGY</h2>

<h3>4.1 Minimum Viable Test Coverage</h3>

<p><strong>CRITICAL (Must have before merge):</strong></p>

<ol>
<li>**Contradiction Detection Tests (5.2)** - 2 hours</li>
<pre><code>   # tests/services/prompts/test_prompt_contradictions.py
   def test_ess02_exception_present():
       """Verify ESS-02 exception clause exists."""
       prompt = generate_prompt("vermogen", "resultaat")
       assert "EXCEPTION voor Ontologische Categorie" in prompt

   def test_no_container_contradiction():
       """Verify proces/activiteit allowed for ESS-02."""
       prompt = generate_prompt("onderzoek", "proces")
       assert "proces waarbij" in prompt  # Should be allowed
       # Should have exception clause if forbidden elsewhere
       if "❌ Vermijd containerbegrippen ('proces'" in prompt:
           assert "EXCEPTION" in prompt

   def test_relative_clause_guidance():
       """Verify relative clauses have usage guidance."""
       prompt = generate_prompt("test", "type")
       assert "Beperk relatieve bijzinnen" in prompt
       assert "ALLEEN wanneer" in prompt  # Should have conditional

   def test_redundancy_below_threshold():
       """Verify critical rules not repeated &gt;3 times."""
       prompt = generate_prompt("test", "type")
       assert prompt.count("enkelvoud") &lt;= 3
       assert prompt.count("koppelwerkwoord") &lt;= 3

   def test_module_order_correct():
       """Verify semantic_categorisation before line 50."""
       prompt = generate_prompt("test", "proces")
       ess02_line = find_line_number(prompt, "Ontologische categorie")
       assert ess02_line &lt; 50, f"ESS-02 at line {ess02_line}, should be &lt;50"</code></pre>
</ol>

<ol>
<li>**Module Dependency Tests** - 30 minutes</li>
<pre><code>   # tests/services/prompts/test_module_dependencies.py
   def test_resolve_execution_order_no_cycles():
       """Verify no circular dependencies after reorder."""
       orchestrator = PromptOrchestrator()
       # Register all modules
       batches = orchestrator.resolve_execution_order()
       assert len(batches) &gt; 0  # Should complete without DependencyCycleError

   def test_metadata_available_early():
       """Verify definition_task module runs first."""
       orchestrator = PromptOrchestrator()
       order = orchestrator.get_modules_by_priority()
       assert order[0] == "definition_task"</code></pre>
</ol>

<ol>
<li>**Golden Reference Comparison** - 1 hour</li>
<pre><code>   # tests/services/prompts/test_golden_references.py
   GOLDEN_DEFINITIONS = {
       "vermogen": {
           "category": "resultaat",
           "expected_keywords": ["resultaat", "maatregel", "toegepast"],
           "forbidden_patterns": ["is een", "de vermogen"],
           "min_quality_score": 80
       },
       "onderzoek": {
           "category": "proces",
           "expected_keywords": ["activiteit", "waarbij", "verzamelen"],
           "forbidden_patterns": ["is", "het onderzoek"],
           "min_quality_score": 85
       }
   }

   def test_golden_definition_quality_maintained():
       """Verify quality doesn't degrade after changes."""
       for term, spec in GOLDEN_DEFINITIONS.items():
           definition = generate_definition(term, spec["category"])

           # Check expected patterns present
           for keyword in spec["expected_keywords"]:
               assert keyword in definition.lower()

           # Check forbidden patterns absent
           for forbidden in spec["forbidden_patterns"]:
               assert forbidden not in definition.lower()

           # Check quality score
           score = validate_definition(definition)
           assert score &gt;= spec["min_quality_score"]</code></pre>
</ol>

<p><strong>NICE TO HAVE (Post-merge validation):</strong></p>

<ol>
<li>**Integration Tests** - 2 hours</li>
</ol>
<ul>
<li>  - Full prompt generation with all 16 modules</li>
<li>  - Token count validation (<10,000 tokens)</li>
<li>  - Generation time (<500ms)</li>
</ul>

<ol>
<li>**Prompt Validator Automation** - 2 hours</li>
</ol>
<ul>
<li>  - Run PromptValidator on every commit (CI/CD)</li>
<li>  - Fail build if contradictions detected</li>
</ul>

<h3>4.2 Test Execution Order</h3>

<pre><code>PRE-MERGE (MANDATORY):
1. Run existing tests: pytest tests/services/prompts/
2. Add contradiction tests (test_prompt_contradictions.py)
3. Add dependency tests (test_module_dependencies.py)
4. Run golden reference tests (generate 10 definitions, compare before/after)
5. Manual review: Generate 5 definitions per category (20 total), check quality

POST-MERGE (Week 3):
6. Add integration tests
7. Add PromptValidator to CI/CD
8. Performance benchmarking (token count, generation time)</code></pre>

<p><strong>Coverage Target:</strong> 80%+ for modified modules</p>

<p>---</p>

<h2>5. ROLLBACK COMPLEXITY ANALYSIS</h2>

<h3>5.1 Rollback Difficulty Ranking</h3>

<p>| Issue | Rollback Method | Time to Rollback | Data Loss Risk | Difficulty |</p>
<p>|-------|----------------|------------------|----------------|------------|</p>
<p>| 1.1 ESS-02 | <code>git revert <commit></code> | 2 min | NONE | ⭐ EASY |</p>
<p>| 1.2 Container | <code>git revert <commit></code> | 2 min | NONE | ⭐ EASY |</p>
<p>| 1.3 Relative | <code>git revert <commit></code> | 2 min | NONE | ⭐ EASY |</p>
<p>| 1.4 Article | Bundled with 1.1 | 2 min | NONE | ⭐ EASY |</p>
<p>| 1.5 Context | <code>git revert <commit></code> | 2 min | NONE | ⭐ EASY |</p>
<p>| 2.1 Categorize | <code>git revert <commit></code> | 2 min | NONE | ⭐ EASY |</p>
<p>| 2.2 ESS-02 consolidate | <code>git revert <commit></code> | 2 min | <strong>Possible nuance loss</strong> | ⭐⭐ MEDIUM |</p>
<p>| 2.3 Enkelvoud | <code>git revert <commit></code> | 2 min | NONE | ⭐ EASY |</p>
<p>| 2.4 Koppelwerkwoord | Manual restore ARAI-06 | 10 min | <strong>Rule deletion</strong> | ⭐⭐ MEDIUM |</p>
<p>| 2.5 Tier system | <code>git revert <commit></code> | 2 min | NONE | ⭐ EASY |</p>
<p>| 3.1 Module reorder | Revert one line | 1 min | NONE | ⭐ EASY |</p>
<p>| 3.2 Metadata | Bundled with 3.1 | 1 min | NONE | ⭐ EASY |</p>
<p>| 4.1/4.2 Templates | <code>git revert <commit></code> | 2 min | NONE | ⭐ EASY |</p>
<p>| 4.3 Visual badges | <code>git revert <commit></code> (10 files) | 5 min | NONE | ⭐⭐ MEDIUM |</p>
<p>| 5.1 Validator | Delete file | 1 min | NONE (new code) | ⭐ EASY |</p>
<p>| 5.2 Tests | Delete file | 1 min | NONE (tests) | ⭐ EASY |</p>
<p>| 5.3 Docs | Delete file | 1 min | NONE (docs) | ⭐ EASY |</p>

<h3>5.2 Emergency Rollback Procedure</h3>

<p><strong>SCENARIO: Major issue discovered post-merge (Week 1 deployment)</strong></p>

<p><strong>Option 1: Full Rollback (5 minutes)</strong></p>
<pre><code># Identify merge commit
git log --oneline --grep="DEF-101" -n 5

# Full revert
git revert &lt;merge-commit-hash&gt;
git push origin main

# Redeploy previous version
./scripts/deploy.sh</code></pre>

<p><strong>Option 2: Selective Rollback (10 minutes)</strong></p>
<pre><code># Keep safe changes, revert problematic ones
git revert &lt;commit-2.2&gt;  # Revert ESS-02 consolidation (high risk)
git revert &lt;commit-3.1&gt;  # Revert module reorder (if dependency issue)

# Keep other changes (contradiction fixes, categorization)
git push origin main</code></pre>

<p><strong>Option 3: Feature Flag (0 downtime)</strong></p>
<pre><code># Add to prompt_orchestrator.py BEFORE merge
USE_LEGACY_PROMPT = os.getenv("USE_LEGACY_PROMPT", "false") == "true"

def build_prompt(...):
    if USE_LEGACY_PROMPT:
        return self._legacy_prompt_builder(...)
    else:
        return self._new_modular_prompt(...)</code></pre>
<p><strong>Deploy with:</strong> <code>USE_LEGACY_PROMPT=false</code> (new prompt)</p>
<p><strong>Rollback with:</strong> <code>USE_LEGACY_PROMPT=true</code> (old prompt)</p>

<p><strong>Recommendation:</strong> Use Feature Flag for Week 1 deployment, remove after Week 2 validation</p>

<p>---</p>

<h2>6. TECHNICAL IMPLEMENTATION NOTES</h2>

<h3>6.1 Module Architecture Understanding</h3>

<p><strong>PromptOrchestrator Pattern:</strong></p>
<pre><code># From prompt_orchestrator.py analysis:

class PromptOrchestrator:
    def __init__(self, max_workers=4, module_order=None):
        self.modules = {}  # Registry
        self.dependency_graph = defaultdict(set)  # Dependency tracking
        self.module_order = module_order or self._get_default_module_order()

    def register_module(self, module: BasePromptModule):
        self.modules[module.module_id] = module
        self.dependency_graph[module.module_id] = set(module.get_dependencies())

    def resolve_execution_order(self) -&gt; list[list[str]]:
        # Kahn's algorithm for topological sort
        # Returns batches: [[batch1_modules], [batch2_modules], ...]

    def build_prompt(self, begrip, context, config) -&gt; str:
        # 1. Create ModuleContext (shared state container)
        # 2. Execute modules in batches (parallel where possible)
        # 3. Combine outputs via _combine_outputs()
        # 4. Return complete prompt string</code></pre>

<p><strong>Key Insight:</strong> Modules are LOOSELY COUPLED</p>
<ul>
<li>Each module receives `ModuleContext` (shared state container)</li>
<li>Modules can `set_shared()` and `get_shared()` data</li>
<li>Dependencies declared via `get_dependencies()` method</li>
<li>**Rollback impact:** Changing ONE module doesn't affect others (unless dependency)</li>
</ul>

<h3>6.2 Critical Code Paths</h3>

<p><strong>Issue 1.1 (ESS-02 Exception) - Implementation:</strong></p>
<pre><code># File: src/services/prompts/modules/error_prevention_module.py
# Line: ~145 (in _build_basic_errors method)

def _build_basic_errors(self) -&gt; list[str]:
    return [
        "- ❌ Begin niet met lidwoorden ('de', 'het', 'een')",
        "- ❌ Gebruik geen koppelwerkwoord aan het begin ('is', 'betekent', 'omvat')",
        # ADD HERE:
        "\n⚠️ **EXCEPTION voor Ontologische Categorie (ESS-02):**",
        "Bij het markeren van ontologische categorie MAG je starten met:",
        "- 'activiteit waarbij...' (PROCES)",
        "- 'resultaat van...' (RESULTAAT)",
        "- [kernwoord] dat/die... (TYPE)",
        "- 'exemplaar van...' (EXEMPLAAR)",
        "Dit is de ENIGE uitzondering op de 'geen werkwoord/lidwoord aan start' regel.\n",

        "- ❌ Herhaal het begrip niet letterlijk",
        # ... rest of rules
    ]</code></pre>

<p><strong>Issue 3.1 (Module Reorder) - Implementation:</strong></p>
<pre><code># File: src/services/prompts/modules/prompt_orchestrator.py
# Line: 347-372 (_get_default_module_order method)

def _get_default_module_order(self) -&gt; list[str]:
    # CURRENT (BAD):
    return [
        "expertise",
        "output_specification",
        "grammar",
        "context_awareness",
        "semantic_categorisation",  # Line 71! TOO LATE
        ...
    ]

    # NEW (GOOD):
    return [
        "definition_task",          # 1. TASK METADATA FIRST
        "expertise",                # 2. Role
        "semantic_categorisation",  # 3. ONTOLOGICAL (most critical!)
        "output_specification",     # 4. Format
        "grammar",                  # 5. Grammar baseline
        "context_awareness",        # 6. Context details
        "structure_rules",          # 7. Structural (TIER 1)
        "template",                 # 8. Templates (AFTER rules!)
        "ess_rules", "integrity_rules", "arai_rules",
        "con_rules", "sam_rules", "ver_rules",
        "error_prevention",         # 15. Forbidden (categorized)
        "metrics",                  # 16. Metrics (APPENDIX)
    ]</code></pre>

<p><strong>Issue 2.1 (Categorize 42 Patterns) - Implementation:</strong></p>
<pre><code># File: src/services/prompts/modules/error_prevention_module.py
# Line: 155-194 (_build_forbidden_starters method)

def _build_forbidden_starters(self) -&gt; list[str]:
    # CURRENT (BAD): 42 individual bullets
    return [f"- ❌ Start niet met '{starter}'" for starter in forbidden_starters]

    # NEW (GOOD): 7 categories
    forbidden_categories = {
        "KOPPELWERKWOORDEN": ["is", "betreft", "omvat", "betekent", ...],
        "CONSTRUCTIES": ["bestaat uit", "bevat", "behelst", ...],
        "LIDWOORDEN": ["de", "het", "een"],
        "PROCES-FRAGMENTEN": ["proces waarbij", "handeling die", ...],
        "EVALUATIEVE TERMEN": ["een belangrijk", "een essentieel", ...],
        "TIJD-VORMEN": ["wordt", "zijn", "was", "waren"],
        "OVERIGE": ["methode voor", "manier om", ...]
    }

    result = ["### ⚠️ Veelgemaakte fouten (CATEGORIZED):"]
    for category, patterns in forbidden_categories.items():
        result.append(f"**{category}:** ❌ {', '.join(patterns)}")
    return result</code></pre>

<h3>6.3 Testing Hooks</h3>

<p><strong>Existing Test Infrastructure:</strong></p>
<pre><code># tests/services/prompts/test_prompt_orchestrator.py
# Tests already exist for:
- Module registration
- Dependency resolution (test_orchestrator_resolves_dependencies_and_builds_prompt)
- Execution order validation
- Module skipping (test_orchestrator_skips_invalid_module_and_keeps_content)

# LEVERAGE THESE for regression testing!</code></pre>

<p><strong>Where to Add New Tests:</strong></p>
<pre><code>tests/services/prompts/
├── test_prompt_orchestrator.py          (existing - add reorder test)
├── test_prompt_contradictions.py        (NEW - Issue 5.2)
├── test_module_dependencies.py          (NEW - validate no cycles)
├── test_golden_references.py            (NEW - quality comparison)
└── test_prompt_validator.py             (NEW - Issue 5.1)</code></pre>

<p>---</p>

<h2>7. EXECUTION RECOMMENDATION</h2>

<h3>7.1 Phased Deployment Strategy</h3>

<p><strong>PHASE 1: CRITICAL FIXES (Week 1) - Deploy to Staging</strong></p>
<pre><code>Day 1-3: Implement Issues 1.1-4.2, 2.1-2.5, 3.1-3.2
Day 4: Deploy to staging, run smoke tests
Day 5: A/B test (10 definitions old vs new prompt)
Weekend: Monitor staging, collect feedback</code></pre>
<p><strong>GO/NO-GO Decision:</strong> If quality score ≥80% on 10 test definitions → Deploy to prod Monday</p>

<p><strong>PHASE 2: QUALITY IMPROVEMENTS (Week 2) - Feature Flag</strong></p>
<pre><code>Day 1-2: Implement Issues 1.5, 4.3, 5.1
Deploy with feature flag: 50% traffic to new prompt
Monitor: Definition quality, user feedback, error rate
Day 3-5: Ramp to 100% if no issues</code></pre>

<p><strong>PHASE 3: VALIDATION & DOCS (Week 3) - Stabilization</strong></p>
<pre><code>Day 1-2: Implement Issues 5.2, 5.3
Run full regression suite
Remove feature flag (new prompt becomes default)
Archive legacy prompt code</code></pre>

<h3>7.2 Success Criteria Per Phase</h3>

<p><strong>Phase 1 (Week 1):</strong></p>
<ul>
<li>✅ Zero blocking contradictions (PromptValidator passes)</li>
<li>✅ ESS-02 compliance rate: 0% → 80%+</li>
<li>✅ Cognitive load: 9/10 → 6/10 (measurable: rule count, redundancy)</li>
<li>✅ All existing tests pass</li>
<li>✅ 10 golden reference definitions maintain quality ≥80%</li>
</ul>

<p><strong>Phase 2 (Week 2):</strong></p>
<ul>
<li>✅ Visual hierarchy improves scanning time (manual test: <30s to find TIER 1 rule)</li>
<li>✅ Context usage clarity: <5% user questions about context (vs current 50%)</li>
<li>✅ PromptValidator catches new contradictions (CI/CD integration)</li>
</ul>

<p><strong>Phase 3 (Week 3):</strong></p>
<ul>
<li>✅ Regression test suite: 0 failures</li>
<li>✅ Documentation complete (dependency map, testing guide)</li>
<li>✅ Token count reduced by 15% (measure: avg prompt length before/after)</li>
<li>✅ 4-week uptime with zero critical issues</li>
</ul>

<h3>7.3 Final Recommendation</h3>

<p><strong>PROCEED WITH DEF-101 IMMEDIATELY</strong></p>

<p><strong>Rationale:</strong></p>
<ol>
<li>**Risk is MANAGEABLE:** 82% of issues are LOW-MEDIUM risk (≤5.4 score)</li>
<li>**Architecture supports safe rollback:** Modular design, feature flags available</li>
<li>**Parallelization possible:** 61% of tasks can run simultaneously</li>
<li>**Testing infrastructure exists:** Leverage existing test_prompt_orchestrator.py</li>
<li>**Impact is HIGH:** System currently UNUSABLE (5 blocking contradictions)</li>
</ol>

<p><strong>Confidence Level:</strong> 85% (High confidence)</p>
<ul>
<li>15% uncertainty due to ESS-02 consolidation (Issue 2.2) - NEEDS CAREFUL A/B TESTING</li>
</ul>

<p><strong>Recommended Start:</strong> Week of 2025-11-11 (this week)</p>

<p>---</p>

<h2>8. APPENDIX: FILE IMPACT SUMMARY</h2>

<h3>8.1 Files to Modify (10 files)</h3>

<p>| File | Issues | Lines Changed | Risk | Dependencies |</p>
<p>|------|--------|---------------|------|--------------|</p>
<p>| <code>error_prevention_module.py</code> | 1.1, 1.3, 2.1 | ~50 lines | MEDIUM | None |</p>
<p>| <code>semantic_categorisation_module.py</code> | 2.2 | ~18 lines | HIGH | None |</p>
<p>| <code>arai_rules_module.py</code> | 1.2, 2.4 | ~10 lines | MEDIUM | None |</p>
<p>| <code>prompt_orchestrator.py</code> | 2.5, 3.1 | ~30 lines | MEDIUM | All modules |</p>
<p>| <code>template_module.py</code> | 4.1, 4.2 | ~5 lines | LOW | None |</p>
<p>| <code>ver_rules_module.py</code> | 2.3 | ~5 lines | LOW | grammar_module |</p>
<p>| <code>grammar_module.py</code> | 2.3 | ~0 lines (ref only) | LOW | None |</p>
<p>| <code>definition_task_module.py</code> | 3.2 | ~10 lines | LOW | None |</p>
<p>| <code>context_awareness_module.py</code> | 1.5 | ~20 lines | LOW | None |</p>
<p>| <code>structure_rules_module.py</code> | 4.3 | ~2 lines/rule | LOW | None |</p>

<p><strong>Total Estimated Lines Changed:</strong> ~150 lines across 10 files</p>

<h3>8.2 Files to Create (3 files)</h3>

<p>| File | Purpose | Size | Dependencies |</p>
<p>|------|---------|------|--------------|</p>
<p>| <code>prompt_validator.py</code> | Contradiction detection | ~200 lines | None (standalone) |</p>
<p>| <code>test_prompt_contradictions.py</code> | Regression tests | ~300 lines | PromptValidator, pytest |</p>
<p>| <code>prompt_module_dependency_map.md</code> | Documentation | ~150 lines | None (docs) |</p>

<h3>8.3 Dependency Impact Map</h3>

<pre><code>┌─────────────────────────────────────────────────────────┐
│ HIGH IMPACT (10+ dependent modules)                     │
├─────────────────────────────────────────────────────────┤
│ prompt_orchestrator.py (3.1) → ALL 16 modules           │
│   Risk: Module reorder could break execution flow       │
│   Mitigation: Validate with resolve_execution_order()   │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│ MEDIUM IMPACT (1-3 dependent modules)                   │
├─────────────────────────────────────────────────────────┤
│ error_prevention_module.py (1.1, 1.3, 2.1)              │
│   Depends on: context_awareness (for context data)      │
│   Risk: Exception clause might conflict with other mods │
│                                                          │
│ semantic_categorisation_module.py (2.2)                 │
│   Depends on: None                                       │
│   Used by: template_module, definition_task_module      │
│   Risk: Consolidation might remove data other mods use  │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│ LOW IMPACT (0 dependencies)                             │
├─────────────────────────────────────────────────────────┤
│ All other modules: Standalone changes, no dependencies  │
└─────────────────────────────────────────────────────────┘</code></pre>

<p>---</p>

<h2>9. DEBUGGING CHECKLIST (Pre-Implementation)</h2>

<p><strong>Before starting ANY issue:</strong></p>

<ul>
<li>[ ] Read module source code (understand current logic)</li>
<li>[ ] Check `get_dependencies()` method (understand data flow)</li>
<li>[ ] Grep for `set_shared()` calls (what data does this module provide?)</li>
<li>[ ] Grep for `get_shared()` calls (what data does this module consume?)</li>
<li>[ ] Run existing tests for this module (establish baseline)</li>
<li>[ ] Create branch: `feature/DEF-101-issue-X.X`</li>
</ul>

<p><strong>After implementing issue:</strong></p>

<ul>
<li>[ ] Run module-specific tests (if exist)</li>
<li>[ ] Run full test suite: `pytest tests/services/prompts/`</li>
<li>[ ] Generate 5 test definitions (manual quality check)</li>
<li>[ ] Check prompt length (shouldn't increase >5%)</li>
<li>[ ] Validate no new warnings in logs</li>
<li>[ ] Git commit with conventional format: `fix(DEF-101): [description]`</li>
</ul>

<p><strong>Before merging to main:</strong></p>

<ul>
<li>[ ] All tests pass (pytest exit code 0)</li>
<li>[ ] Code review completed (or self-review checklist)</li>
<li>[ ] Golden reference comparison (10 definitions before/after)</li>
<li>[ ] No blocking contradictions (run PromptValidator if available)</li>
<li>[ ] Documentation updated (if architecture changed)</li>
</ul>

<p>---</p>

<h2>10. CONCLUSION</h2>

<h3>Key Takeaways</h3>

<ol>
<li>**Feasibility:** DEF-101 is HIGHLY FEASIBLE with current codebase architecture</li>
<li>**Risk:** MANAGEABLE - 82% of issues are low-medium risk, rollback is straightforward</li>
<li>**Parallelization:** 61% of tasks can run simultaneously (but single dev is fine)</li>
<li>**Testing:** Leverage existing infrastructure, add 3 new test files</li>
<li>**Timeline:** 3 weeks is REALISTIC (8h + 4h + 3h = 15h total effort)</li>
</ol>

<h3>Confidence Assessment</h3>

<p><strong>Overall Implementation Confidence: 85%</strong></p>

<p><strong>Breakdown:</strong></p>
<ul>
<li>Architecture understanding: 95% (code is clear, well-modularized)</li>
<li>Risk mitigation: 85% (rollback straightforward, tests available)</li>
<li>Issue 2.2 (ESS-02 consolidation): 65% (needs careful A/B testing)</li>
<li>Timeline accuracy: 90% (effort estimates are conservative)</li>
<li>Parallel execution: 75% (dependencies well-understood, but some unknowns)</li>
</ul>

<p><strong>Recommendation:</strong> PROCEED with implementation, but:</p>
<ul>
<li>Deploy Phase 1 to staging FIRST (not prod)</li>
<li>Use feature flags for Week 2 deployment</li>
<li>Run A/B tests on Issue 2.2 (ESS-02 consolidation) before full rollout</li>
</ul>

<h3>Next Steps</h3>

<ol>
<li>**This week:** Stakeholder approval for DEF-101 start</li>
<li>**Monday 2025-11-11:** Create Linear Epic + sub-issues</li>
<li>**Tuesday 2025-11-12:** Start Phase 1 - Day 1 (Issues 1.1-1.4, 4.1-4.2)</li>
<li>**Friday 2025-11-15:** Deploy to staging, weekend smoke test</li>
<li>**Monday 2025-11-18:** Production deployment (if staging green)</li>
</ol>

<p>---</p>

<p><strong>Document Status:</strong> ✅ COMPLETE</p>
<p><strong>Created:</strong> 2025-11-10</p>
<p><strong>Analyst:</strong> Debug Specialist (AI-assisted)</p>
<p><strong>Review Required:</strong> Lead Developer, Product Owner</p>
<p><strong>Next Action:</strong> Stakeholder approval → Linear Epic creation → Start implementation</p>

<p><strong>Related Documents:</strong></p>
<ul>
<li>`docs/planning/CONSENSUS_IMPLEMENTATION_PLAN.md` (source)</li>
<li>`docs/analyses/DEF_111_vs_DEF_101_ROI_ANALYSIS.md` (ROI analysis)</li>
<li>`docs/analyses/PROMPT_COMPREHENSIVE_ANALYSIS_AND_IMPROVEMENT_PLAN.md` (detailed issues)</li>
</ul>

  </div>
</body>
</html>