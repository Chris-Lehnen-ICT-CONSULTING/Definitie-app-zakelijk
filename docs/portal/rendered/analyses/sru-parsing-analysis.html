<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SRU XML Parsing Analysis</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">‚Üê Terug naar Portal</a>
    <h1>SRU XML Parsing Analysis</h1>

<p><strong>Datum:</strong> 2025-10-08</p>
<p><strong>Auteur:</strong> Claude Code (Analyse Specialist)</p>
<p><strong>Context:</strong> Onderzoek naar waarom SRU endpoints geen resultaten opleveren</p>

<h2>Executive Summary</h2>

<p>De SRU service (<code>src/services/web_lookup/sru_service.py</code>) heeft een <strong>kritiek namespace probleem</strong> waardoor SRU 2.0 responses niet correct worden geparsed. Dit verklaart waarom bepaalde endpoints (met name Wetgeving.nl/BWB) geen resultaten opleveren ondanks succesvolle HTTP 200 responses.</p>

<p><strong>Impact:</strong> üî¥ HIGH - SRU 2.0 endpoints worden volledig gemist</p>
<p><strong>Fix Complexity:</strong> üü¢ LOW - √â√©n regel aanpassing in namespace dictionary</p>

<p>---</p>

<h2>Probleem Analyse</h2>

<h3>1. Namespace Mismatch (KRITIEK)</h3>

<p><strong>Locatie:</strong> <code>src/services/web_lookup/sru_service.py</code>, regel 749-755</p>

<pre><code># Huidige code (INCORRECT voor SRU 2.0)
namespaces = {
    "srw": "http://www.loc.gov/zing/srw/",  # ‚Üê SRU 1.2 namespace
    "dc": "http://purl.org/dc/elements/1.1/",
    "dcterms": "http://purl.org/dc/terms/",
    "gzd": "http://overheid.nl/gzd",
}

# Records zoeken
records = root.findall(".//srw:record", namespaces)  # ‚Üê FAILS voor SRU 2.0</code></pre>

<p><strong>Probleem:</strong></p>
<ul>
<li>SRU 1.2 gebruikt: `http://www.loc.gov/zing/srw/`</li>
<li>SRU 2.0 gebruikt: `http://docs.oasis-open.org/ns/search-ws/sruResponse` ‚Üê **ANDERE namespace!**</li>
</ul>

<p><strong>Gevolg:</strong></p>
<ul>
<li>`findall(".//srw:record", namespaces)` retourneert **lege lijst** voor SRU 2.0 responses</li>
<li>Code denkt dat er geen records zijn ‚Üí `return []`</li>
<li>Fallback local-name logica wordt NOOIT bereikt</li>
</ul>

<h3>2. Test Bewijs</h3>

<p>Debug script (<code>scripts/debug_sru_parsing.py</code>) toont aan:</p>

<pre><code>TEST: SRU 2.0 Response (OAI-DC)
Zoeken naar records...
  Gevonden met namespace prefix (1.2): 0 records  ‚Üê FAIL
  Gevonden met namespace prefix (2.0): 1 records  ‚Üê SUCCESS

RESULTAAT: ‚ùå FAIL
  Records gevonden zonder namespace, maar niet met namespace prefix</code></pre>

<p><strong>Bewijs:</strong></p>
<ul>
<li>SRU 1.2 namespace: 0 records gevonden</li>
<li>SRU 2.0 namespace: 1 record gevonden</li>
<li>Data zit ER wel, maar wordt NIET gevonden door huidige code</li>
</ul>

<h3>3. Betreffende Endpoints</h3>

<p><strong>SRU 2.0 endpoints (BROKEN):</strong></p>
<ul>
<li>‚úÖ Wetgeving.nl (BWB): `https://zoekservice.overheid.nl/sru/Search` (SRU 2.0)</li>
<li> - Config: `sru_version: "2.0"`</li>
<li> - Verwacht: records</li>
<li> - Werkelijk: lege lijst door namespace mismatch</li>
</ul>

<p><strong>SRU 1.2 endpoints (WORKING):</strong></p>
<ul>
<li>‚úÖ Overheid.nl: `https://repository.overheid.nl/sru` (SRU 1.2)</li>
<li>‚úÖ Rechtspraak.nl: `https://zoeken.rechtspraak.nl/SRU/Search` (SRU 1.2)</li>
<li>‚úÖ Overheid Zoekservice (met gzd): `https://zoekservice.overheid.nl/sru/Search` (SRU 1.2)</li>
</ul>

<p>---</p>

<h2>Oplossingen</h2>

<h3>Oplossing 1: Multi-Namespace Record Search (AANBEVOLEN)</h3>

<p><strong>Strategie:</strong> Probeer beide SRU namespaces bij record search</p>

<pre><code>def _parse_sru_response(self, xml_content: str, term: str, config: SRUConfig) -&gt; list[LookupResult]:
    """Parse SRU XML response naar LookupResult objecten."""
    try:
        root = ET.fromstring(xml_content)

        # SRU namespace variants (1.2 en 2.0)
        namespace_variants = [
            {
                "srw": "http://www.loc.gov/zing/srw/",  # SRU 1.2
                "dc": "http://purl.org/dc/elements/1.1/",
                "dcterms": "http://purl.org/dc/terms/",
                "gzd": "http://overheid.nl/gzd",
            },
            {
                "srw": "http://docs.oasis-open.org/ns/search-ws/sruResponse",  # SRU 2.0
                "dc": "http://purl.org/dc/elements/1.1/",
                "dcterms": "http://purl.org/dc/terms/",
                "gzd": "http://overheid.nl/gzd",
            }
        ]

        # Probeer beide namespaces
        records = []
        namespaces = None
        for ns_variant in namespace_variants:
            records = root.findall(".//srw:record", ns_variant)
            if records:
                namespaces = ns_variant  # Gebruik werkende namespace voor parse_record
                break

        if not records:
            logger.warning(
                f"No records found in SRU response from {config.name}. "
                f"Response preview: {xml_content[:200]}"
            )
            return []

        results = []
        for record in records:
            result = self._parse_record(record, term, config, namespaces)
            if result:
                results.append(result)

        # ... rest van de method</code></pre>

<p><strong>Voordelen:</strong></p>
<ul>
<li>‚úÖ Backward compatible (SRU 1.2 blijft werken)</li>
<li>‚úÖ Forward compatible (SRU 2.0 wordt ondersteund)</li>
<li>‚úÖ Minimale code wijziging</li>
<li>‚úÖ Geen performance impact</li>
</ul>

<p><strong>Nadelen:</strong></p>
<ul>
<li>Geen</li>
</ul>

<h3>Oplossing 2: Namespace Auto-Detection (ALTERNATIEF)</h3>

<p><strong>Strategie:</strong> Detecteer welke namespace gebruikt wordt in de response</p>

<pre><code>def _detect_sru_namespace(self, root: ET.Element) -&gt; dict[str, str]:
    """Detecteer SRU namespace variant uit XML root."""
    # Check root element namespace
    root_ns = root.tag.split('}')[0][1:] if '}' in root.tag else ""

    if "sruResponse" in root_ns:  # SRU 2.0 namespace
        return {
            "srw": "http://docs.oasis-open.org/ns/search-ws/sruResponse",
            "dc": "http://purl.org/dc/elements/1.1/",
            "dcterms": "http://purl.org/dc/terms/",
            "gzd": "http://overheid.nl/gzd",
        }
    else:  # SRU 1.2 namespace (default)
        return {
            "srw": "http://www.loc.gov/zing/srw/",
            "dc": "http://purl.org/dc/elements/1.1/",
            "dcterms": "http://purl.org/dc/terms/",
            "gzd": "http://overheid.nl/gzd",
        }</code></pre>

<p><strong>Voordelen:</strong></p>
<ul>
<li>‚úÖ Dynamische namespace detectie</li>
<li>‚úÖ Future-proof voor nieuwe SRU versies</li>
</ul>

<p><strong>Nadelen:</strong></p>
<ul>
<li>‚ö†Ô∏è Complexer dan Oplossing 1</li>
<li>‚ö†Ô∏è Edge cases mogelijk bij malformed XML</li>
</ul>

<p>---</p>

<h2>Debug Logging Verbeteringen</h2>

<h3>Probleem 2: Onvoldoende Debug Visibility</h3>

<p><strong>Huidige situatie:</strong></p>
<ul>
<li>Bij `records = []` wordt gelogd: `"Parsed {len(results)} results from {config.name}"`</li>
<li>Geen info over WAAROM er geen records zijn</li>
<li>Geen raw XML logging bij parse failures</li>
</ul>

<p><strong>Aanbevolen logging toevoegingen:</strong></p>

<h4>1. Log Raw XML bij Empty Results</h4>

<pre><code>def _parse_sru_response(self, xml_content: str, term: str, config: SRUConfig) -&gt; list[LookupResult]:
    try:
        root = ET.fromstring(xml_content)
        # ... namespace en record search ...

        if not records:
            # Log raw XML preview voor debugging
            logger.warning(
                f"No records found in SRU response from {config.name}. "
                f"XML preview: {xml_content[:500]}",
                extra={
                    "endpoint": config.name,
                    "term": term,
                    "xml_length": len(xml_content),
                }
            )
            return []</code></pre>

<h4>2. Log SRU Diagnostics (al ge√Ømplementeerd, maar niet prominent genoeg)</h4>

<p><strong>Locatie:</strong> regel 270-302 (in <code>_try_query</code>)</p>

<p>De diagnostic parsing is al aanwezig, maar wordt alleen gebruikt in attempt records.</p>

<p><strong>Verbetering:</strong></p>
<pre><code># Na regel 347 (waar diagnostics worden ge-extract)
diag = _extract_diag(txt)
if diag:
    logger.warning(
        f"SRU diagnostic from {config.name}: {diag.get('diag_message')}",
        extra={
            "diagnostic_uri": diag.get("diag_uri"),
            "diagnostic_details": diag.get("diag_details"),
            "endpoint": config.name,
        }
    )</code></pre>

<h4>3. Log Namespace Mismatch Detection</h4>

<pre><code># In _parse_sru_response, bij namespace detection
detected_ns = set()
for elem in root.iter():
    if '}' in elem.tag:
        ns = elem.tag.split('}')[0][1:]
        detected_ns.add(ns)

logger.debug(
    f"Detected namespaces in SRU response: {detected_ns}",
    extra={"endpoint": config.name}
)</code></pre>

<p>---</p>

<h2>Test Coverage</h2>

<h3>Bestaande Tests</h3>

<p><strong>SRU parsing tests:</strong></p>
<ul>
<li>‚úÖ `tests/web_lookup/test_sru_gzd_parser.py` - Test GZD local-name parsing</li>
<li>‚úÖ `tests/services/web_lookup/test_sru_integration.py` - Integration tests</li>
<li>‚úÖ `tests/services/web_lookup/test_sru_circuit_breaker.py` - Circuit breaker behavior</li>
</ul>

<p><strong>Ontbrekende test:</strong></p>
<ul>
<li>‚ùå **SRU 2.0 namespace handling** - NIET getest!</li>
</ul>

<h3>Nieuwe Test (AANBEVOLEN)</h3>

<pre><code># tests/web_lookup/test_sru_namespace_variants.py
import pytest


def test_sru_20_namespace_parsing():
    """Test dat SRU 2.0 responses correct worden geparsed."""
    from services.web_lookup.sru_service import SRUConfig, SRUService

    svc = SRUService()
    cfg = SRUConfig(
        name="Test SRU 2.0",
        base_url="https://example.com/sru",
        default_collection="",
        record_schema="oai_dc",
        sru_version="2.0",
    )

    # SRU 2.0 response met correcte namespace
    xml = """&lt;?xml version="1.0" encoding="UTF-8"?&gt;
    &lt;srw:searchRetrieveResponse xmlns:srw="http://docs.oasis-open.org/ns/search-ws/sruResponse"&gt;
      &lt;srw:version&gt;2.0&lt;/srw:version&gt;
      &lt;srw:numberOfRecords&gt;1&lt;/srw:numberOfRecords&gt;
      &lt;srw:records&gt;
        &lt;srw:record&gt;
          &lt;srw:recordData&gt;
            &lt;oai_dc:dc xmlns:oai_dc="http://www.openarchives.org/OAI/2.0/oai_dc/"
                        xmlns:dc="http://purl.org/dc/elements/1.1/"&gt;
              &lt;dc:title&gt;Wetboek van Strafrecht&lt;/dc:title&gt;
              &lt;dc:description&gt;Test description&lt;/dc:description&gt;
              &lt;dc:identifier&gt;https://example.com/sr&lt;/dc:identifier&gt;
            &lt;/oai_dc:dc&gt;
          &lt;/srw:recordData&gt;
        &lt;/srw:record&gt;
      &lt;/srw:records&gt;
    &lt;/srw:searchRetrieveResponse&gt;"""

    results = svc._parse_sru_response(xml, term="wetboek", config=cfg)

    assert len(results) &gt; 0, "SRU 2.0 responses should be parsed"
    assert results[0].metadata.get("dc_title") == "Wetboek van Strafrecht"


def test_sru_12_namespace_parsing():
    """Test dat SRU 1.2 responses correct blijven werken (backward compat)."""
    from services.web_lookup.sru_service import SRUConfig, SRUService

    svc = SRUService()
    cfg = SRUConfig(
        name="Test SRU 1.2",
        base_url="https://example.com/sru",
        default_collection="",
        record_schema="dc",
        sru_version="1.2",
    )

    xml = """&lt;?xml version="1.0" encoding="UTF-8"?&gt;
    &lt;srw:searchRetrieveResponse xmlns:srw="http://www.loc.gov/zing/srw/"&gt;
      &lt;srw:version&gt;1.2&lt;/srw:version&gt;
      &lt;srw:numberOfRecords&gt;1&lt;/srw:numberOfRecords&gt;
      &lt;srw:records&gt;
        &lt;srw:record&gt;
          &lt;srw:recordData&gt;
            &lt;dc:dc xmlns:dc="http://purl.org/dc/elements/1.1/"&gt;
              &lt;dc:title&gt;Gemeentewet&lt;/dc:title&gt;
              &lt;dc:description&gt;Test description&lt;/dc:description&gt;
            &lt;/dc:dc&gt;
          &lt;/srw:recordData&gt;
        &lt;/srw:record&gt;
      &lt;/srw:records&gt;
    &lt;/srw:searchRetrieveResponse&gt;"""

    results = svc._parse_sru_response(xml, term="gemeentewet", config=cfg)

    assert len(results) &gt; 0, "SRU 1.2 responses should still work"
    assert results[0].metadata.get("dc_title") == "Gemeentewet"</code></pre>

<p>---</p>

<h2>Implementation Checklist</h2>

<h3>High Priority (Fix namespace issue)</h3>
<ul>
<li>[ ] Implementeer multi-namespace record search (Oplossing 1)</li>
<li>[ ] Voeg test toe voor SRU 2.0 namespace parsing</li>
<li>[ ] Test met live Wetgeving.nl endpoint</li>
<li>[ ] Verify backward compatibility met SRU 1.2 endpoints</li>
</ul>

<h3>Medium Priority (Improve debugging)</h3>
<ul>
<li>[ ] Log raw XML preview bij empty results</li>
<li>[ ] Log SRU diagnostics op WARNING level (niet alleen in attempts)</li>
<li>[ ] Log detected namespaces op DEBUG level</li>
<li>[ ] Voeg `xml_preview` toe aan attempt records bij parse failures</li>
</ul>

<h3>Low Priority (Nice to have)</h3>
<ul>
<li>[ ] Voeg metrics toe voor namespace variant usage</li>
<li>[ ] Create dashboard voor SRU endpoint health per namespace variant</li>
<li>[ ] Documenteer SRU namespace verschillen in docstrings</li>
</ul>

<p>---</p>

<h2>Root Cause</h2>

<p><strong>Waarom is dit niet eerder opgevallen?</strong></p>

<ol>
<li>**Test Coverage Gap:** Geen test voor SRU 2.0 namespace variant</li>
<li>**Silent Failure:** Code retourneert lege lijst (geen exception), lijkt normaal gedrag</li>
<li>**Fallback Masking:** Local-name fallback logica werkt WEL voor content, maar records worden nooit gevonden</li>
<li>**Circuit Breaker:** Bij lege results triggert circuit breaker ‚Üí lijkt alsof endpoint gewoon leeg is</li>
</ol>

<p><strong>Wanneer ge√Øntroduceerd?</strong></p>
<ul>
<li>Waarschijnlijk bij initi√´le implementatie (namespace dict was altijd SRU 1.2)</li>
<li>Wetgeving.nl endpoint met SRU 2.0 toegevoegd zonder namespace fix</li>
</ul>

<p>---</p>

<h2>Related Issues</h2>

<p><strong>Mogelijk gerelateerde problemen:</strong></p>
<ul>
<li>US-XXX: "Wetgeving.nl levert geen resultaten" (als dit bestaat)</li>
<li>Performance: Circuit breaker triggert vroeg ‚Üí endpoints lijken leeg</li>
<li>Metrics: False negatives in endpoint health monitoring</li>
</ul>

<p><strong>Volgende stappen:</strong></p>
<ol>
<li>Fix namespace issue (hoogste prioriteit)</li>
<li>Voeg debug logging toe</li>
<li>Voeg integration test toe met live Wetgeving.nl endpoint</li>
<li>Monitor of Wetgeving.nl resultaten gaat opleveren na fix</li>
</ol>

<p>---</p>

<h2>Debug Scripts</h2>

<p><strong>Beschikbare tools:</strong></p>
<ul>
<li>`scripts/debug_sru_parsing.py` - Test parsing met mock XML responses</li>
<li>`scripts/test_live_sru_response.py` - Test live endpoints en toon raw responses</li>
</ul>

<p><strong>Gebruik:</strong></p>
<pre><code># Test parsing logica
python scripts/debug_sru_parsing.py

# Test live endpoints (requires network)
python scripts/test_live_sru_response.py</code></pre>

<p>---</p>

<h2>Conclusie</h2>

<p>Het SRU parsing probleem is een <strong>klassiek namespace mismatch issue</strong>:</p>
<ul>
<li>SRU 2.0 gebruikt andere namespace dan SRU 1.2</li>
<li>Code probeert alleen SRU 1.2 namespace</li>
<li>Result: alle SRU 2.0 endpoints lijken leeg</li>
</ul>

<p><strong>Fix: 1 regel code aanpassing, grote impact op SRU 2.0 endpoint coverage.</strong></p>

<p>Prioriteit: <strong>HIGH</strong> - direct implementeren.</p>

  </div>
</body>
</html>