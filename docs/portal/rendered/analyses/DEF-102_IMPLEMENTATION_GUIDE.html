<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DEF-102: Implementation Guide - Fix Blocking Contradictions</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">‚Üê Terug naar Portal</a>
    <h1>DEF-102: Implementation Guide - Fix Blocking Contradictions</h1>

<p><strong>Status:</strong> Ready to implement</p>
<p><strong>Effort:</strong> 3 uur</p>
<p><strong>Risk:</strong> LOW (surgical fixes, proven exception pattern)</p>

<p>---</p>

<h2>üéØ Het Probleem in 1 Zin</h2>

<p>ESS-02 VEREIST "is een activiteit waarbij..." maar STR-01 + error_prevention VERBIEDEN starten met "is" ‚Üí <strong>ONMOGELIJK om valide PROCES definities te maken.</strong></p>

<p>---</p>

<h2>‚úÖ De Oplossing: Exception Clauses</h2>

<p>Voeg <strong>expliciete exception clauses</strong> toe die zeggen: "ESS-02 ontologische markers OVERRIDEN de algemene verboden."</p>

<p><strong>Pattern:</strong> Al 4√ó gebruikt in codebase ("tenzij", "uitzondering", "behalve")</p>

<p>---</p>

<h2>üìã Wat Moet Je Aanpassen (5 Wijzigingen)</h2>

<h3>1Ô∏è‚É£ ESS-02: Add Exception Notice (PRIORITEIT 1)</h3>

<p><strong>Waarom:</strong> Maak duidelijk dat "is een activiteit" TOEGESTAAN is voor ontologische precisie</p>

<p><strong>Waar:</strong> <code>src/services/prompts/modules/semantic_categorisation_module.py</code></p>

<p><strong>Functie:</strong> <code>_get_category_specific_guidance(categorie: str)</code></p>

<p><strong>Lijn:</strong> Voor regel 182 (in PROCES category block)</p>

<p><strong>Wat toevoegen:</strong></p>
<pre><code>"proces": """
‚ö†Ô∏è UITZONDERING - Ontologische Categorie Marking:
Voor PROCES categorie√´n MAG je starten met:
- "is een activiteit waarbij..."
- "is het proces waarin..."
Dit is de ENIGE uitzondering op STR-01 en forbidden starts.

**PROCES CATEGORIE - Focus op HANDELING en VERLOOP:**
Gebruik formuleringen zoals:
- 'is een activiteit waarbij...'
- 'is het proces waarin...'
...</code></pre>

<p><strong>Waarom deze fix:</strong></p>
<ul>
<li>ESS-02 is TIER 1 regel (ontologische precisie is kritiek)</li>
<li>Nederlandse grammatica VEREIST "is" voor procesdefinitiess</li>
<li>ASTRA framework (bron van ESS-02) vereist dit patroon</li>
</ul>

<p>---</p>

<h3>2Ô∏è‚É£ STR-01: Add Exception Clause (PRIORITEIT 2)</h3>

<p><strong>Waarom:</strong> Voorkom dat STR-01 ESS-02 patronen blokkeert</p>

<p><strong>Waar:</strong> <code>src/services/prompts/modules/structure_rules_module.py</code></p>

<p><strong>Functie:</strong> <code>_build_str01_rule()</code></p>

<p><strong>Lijn:</strong> Na regel 141 (na toetsvraag)</p>

<p><strong>Wat toevoegen:</strong></p>
<pre><code>rules.append("üîπ **STR-01 - definitie start met zelfstandig naamwoord**")
rules.append(
    "- De definitie moet starten met een zelfstandig naamwoord of naamwoordgroep, niet met een werkwoord."
)
rules.append(
    "- Toetsvraag: Begint de definitie met een zelfstandig naamwoord of naamwoordgroep, en niet met een werkwoord?"
)

# TOEVOEGEN:
rules.append("")
rules.append("‚ö†Ô∏è **UITZONDERING voor ESS-02 (Ontologische Categorie):**")
rules.append("Bij ontologische categorie marking MAG 'is een activiteit/proces/resultaat' gebruikt worden.")
rules.append("Dit is nodig voor ontologische precisie en overschrijft STR-01.")
rules.append("")

if self.include_examples:
    rules.append("  ‚úÖ proces dat beslissers identificeert...")</code></pre>

<p><strong>Waarom deze fix:</strong></p>
<ul>
<li>STR-01 is TIER 2 regel (structuur)</li>
<li>ESS-02 is TIER 1 regel (ontologie) ‚Üí TIER 1 wins</li>
<li>Expliciete hi√´rarchie voorkomt verwarring</li>
</ul>

<p>---</p>

<h3>3Ô∏è‚É£ error_prevention: Modify Koppelwerkwoord Regel (PRIORITEIT 3)</h3>

<p><strong>Waarom:</strong> Voorkom dat error_prevention ESS-02 blokkeert</p>

<p><strong>Waar:</strong> <code>src/services/prompts/modules/error_prevention_module.py</code></p>

<p><strong>Functie:</strong> <code>_build_basic_errors()</code></p>

<p><strong>Lijn:</strong> 147</p>

<p><strong>Wat wijzigen:</strong></p>
<pre><code># VOOR:
"- ‚ùå Gebruik geen koppelwerkwoord aan het begin ('is', 'betekent', 'omvat')",

# NA:
"- ‚ùå Gebruik geen koppelwerkwoord aan het begin ('is', 'betekent', 'omvat'), tenzij vereist voor ontologische categorie (ESS-02)",</code></pre>

<p><strong>Waarom deze fix:</strong></p>
<ul>
<li>Behoudt algemene regel (geen "is" voor vage definities)</li>
<li>Maakt exception expliciet (ESS-02 patronen toegestaan)</li>
<li>Consistent met bestaand "tenzij" patroon in codebase</li>
</ul>

<p>---</p>

<h3>4Ô∏è‚É£ error_prevention: Modify Containerbegrippen Regel (PRIORITEIT 4)</h3>

<p><strong>Waarom:</strong> "proces" en "activiteit" zijn VAGE containers (slecht) vs ONTOLOGISCHE markers (goed)</p>

<p><strong>Waar:</strong> <code>src/services/prompts/modules/error_prevention_module.py</code></p>

<p><strong>Functie:</strong> <code>_build_basic_errors()</code></p>

<p><strong>Lijn:</strong> 150</p>

<p><strong>Wat wijzigen:</strong></p>
<pre><code># VOOR:
"- ‚ùå Vermijd containerbegrippen ('proces', 'activiteit')",

# NA:
"- ‚ùå Vermijd vage containerbegrippen ('proces', 'activiteit'), behalve als ontologische marker (ESS-02: 'is een proces dat...', 'is een activiteit waarbij...')",</code></pre>

<p><strong>Waarom deze fix:</strong></p>
<ul>
<li>Onderscheid tussen VAGE gebruik (‚ùå "proces dat plaatsvindt") vs SPECIFIEKE gebruik (‚úÖ "is een activiteit waarbij gecontroleerd wordt...")</li>
<li>Context matters: same word, different meaning</li>
<li>ARAI-02 bedoeling was vage fillers verbieden, niet ontologische markers</li>
</ul>

<p>---</p>

<h3>5Ô∏è‚É£ error_prevention: Clarify Bijzinnen Regel (PRIORITEIT 5)</h3>

<p><strong>Waarom:</strong> "die", "waarbij" zijn SOMS nodig voor precisie, niet altijd verboden</p>

<p><strong>Waar:</strong> <code>src/services/prompts/modules/error_prevention_module.py</code></p>

<p><strong>Functie:</strong> <code>_build_basic_errors()</code></p>

<p><strong>Lijn:</strong> 151</p>

<p><strong>Wat wijzigen:</strong></p>
<pre><code># VOOR:
"- ‚ùå Vermijd bijzinnen zoals 'die', 'waarin', 'zoals'",

# NA:
"- ‚ö†Ô∏è Beperk relatieve bijzinnen ('die', 'waarin', 'waarbij'). Gebruik ALLEEN wanneer: (1) Nodig voor ontologische categorie (ESS-02), (2) Essentieel voor specificiteit. Prefereer zelfstandig naamwoord constructies.",</code></pre>

<p><strong>Waarom deze fix:</strong></p>
<ul>
<li>Verandert ABSOLUTE verbod (‚ùå) naar VOORKEURSREGEL (‚ö†Ô∏è)</li>
<li>Geeft VOORWAARDEN wanneer toegestaan</li>
<li>Nederlandse juridische taal vereist soms bijzinnen voor precisie</li>
<li>Grammar module leert al comma usage met bijzinnen ‚Üí consistent maken</li>
</ul>

<p>---</p>

<h2>üéØ Prioritering & Volgorde</h2>

<h3>Fase 1: Critical (1 uur)</h3>
<ol>
<li>‚úÖ **Wijziging #1** - ESS-02 exception notice</li>
<li>‚úÖ **Wijziging #2** - STR-01 exception clause</li>
</ol>

<p><strong>Test na Fase 1:</strong> Generate prompt voor begrip "registratie" (PROCES) ‚Üí Check voor contradictions</p>

<h3>Fase 2: Important (1 uur)</h3>
<ol>
<li>‚úÖ **Wijziging #3** - error_prevention koppelwerkwoord</li>
<li>‚úÖ **Wijziging #4** - error_prevention containerbegrippen</li>
</ol>

<p><strong>Test na Fase 2:</strong> Generate prompts voor alle 4 categorie√´n (TYPE, PROCES, RESULTAAT, EXEMPLAAR)</p>

<h3>Fase 3: Polish (1 uur)</h3>
<ol>
<li>‚úÖ **Wijziging #5** - error_prevention bijzinnen clarificatie</li>
<li>‚úÖ **Integration test** - Volledige validatie flow</li>
<li>‚úÖ **Documentation update** - Update CLAUDE.md indien nodig</li>
</ol>

<p>---</p>

<h2>üß™ Test Strategy</h2>

<h3>Unit Tests (per wijziging)</h3>

<p><strong>Test 1: ESS-02 Exception Aanwezig</strong></p>
<pre><code>def test_ess02_exception_clause_present():
    """Verify ESS-02 exception clause in semantic categorisation."""
    module = SemanticCategorisationModule()
    module.initialize({})
    context = ModuleContext(begrip="test", enriched_context=..., config=...)
    context.set_metadata("ontologische_categorie", "proces")

    output = module.execute(context)

    assert "UITZONDERING" in output.content
    assert "is een activiteit waarbij" in output.content
    assert "Dit is de ENIGE uitzondering" in output.content</code></pre>

<p><strong>Test 2: STR-01 Exception Aanwezig</strong></p>
<pre><code>def test_str01_exception_clause():
    """Verify STR-01 has exception for ESS-02."""
    module = StructureRulesModule()
    module.initialize({})
    context = ModuleContext(...)

    output = module.execute(context)

    assert "UITZONDERING voor ESS-02" in output.content
    assert "ontologische categorie marking MAG" in output.content</code></pre>

<p><strong>Test 3: error_prevention Modifications</strong></p>
<pre><code>def test_error_prevention_exceptions():
    """Verify error prevention has ESS-02 exceptions."""
    module = ErrorPreventionModule()
    module.initialize({})
    context = ModuleContext(...)

    output = module.execute(context)

    # Check "tenzij vereist voor ontologische categorie"
    assert "tenzij vereist voor ontologische categorie" in output.content
    # Check "behalve als ontologische marker"
    assert "behalve als ontologische marker" in output.content
    # Check bijzinnen clarification
    assert "Beperk relatieve bijzinnen" in output.content</code></pre>

<h3>Integration Test</h3>

<p><strong>Test 4: No Blocking Contradictions</strong></p>
<pre><code>def test_no_blocking_contradictions_in_full_prompt():
    """Verify no blocking contradictions in generated prompt."""
    orchestrator = PromptOrchestrator()
    # ... register all modules

    prompt = orchestrator.build_prompt(
        begrip="registratie",
        context=EnrichedContext(
            organisatorische_context=["Politie"],
            juridische_context=["Strafrecht"]
        ),
        config=UnifiedGeneratorConfig()
    )

    # If ESS-02 requires "is", must have exception in STR-01/error_prevention
    if "is een activiteit waarbij" in prompt or "is het proces" in prompt:
        assert "UITZONDERING" in prompt or "tenzij" in prompt, \
            "ESS-02 'is' usage without exception clause"

    # Container terms must have exemption
    if "‚ùå Vermijd containerbegrippen ('proces'" in prompt:
        assert "behalve" in prompt or "ontologische marker" in prompt, \
            "Container terms forbidden without exemption"</code></pre>

<p>---</p>

<h2>‚úÖ Success Criteria</h2>

<h3>Functioneel</h3>
<ul>
<li>[ ] Prompt voor "registratie" (PROCES) bevat geen contradictions</li>
<li>[ ] Alle 4 ontologische categorie√´n genereren valide prompts</li>
<li>[ ] GPT-4 kan "is een activiteit waarbij..." gebruiken zonder validatie errors</li>
<li>[ ] Ontologische precisie behouden (>95% consistency)</li>
</ul>

<h3>Technisch</h3>
<ul>
<li>[ ] Alle 5 wijzigingen ge√Ømplementeerd</li>
<li>[ ] 4 unit tests passing</li>
<li>[ ] 1 integration test passing</li>
<li>[ ] Pre-commit hooks passing</li>
<li>[ ] No regressions in existing tests</li>
</ul>

<h3>Business</h3>
<ul>
<li>[ ] PROCES definities mogelijk (40% van use cases)</li>
<li>[ ] ASTRA framework compliance (ontologische precisie)</li>
<li>[ ] Nederlandse juridische grammatica correct</li>
</ul>

<p>---</p>

<h2>üìä Risk Analysis</h2>

<h3>Risico's</h3>

<p>| Risico | Impact | Likelihood | Mitigatie |</p>
<p>|--------|--------|------------|-----------|</p>
<p>| Exception clause te breed | MED | LOW | Test met edge cases, specifieke formulering |</p>
<p>| GPT-4 interpreteert exception verkeerd | MED | LOW | Expliciete voorbeelden toevoegen |</p>
<p>| Regression in andere categorie√´n | HIGH | LOW | Integration tests voor alle 4 categorie√´n |</p>
<p>| Exception pattern inconsistent | LOW | MED | Gebruik bestaand "tenzij" patroon |</p>

<h3>Waarom LOW Risk</h3>

<ol>
<li>**Pattern is proven** - Al 4√ó gebruikt in codebase (INT-08, Grammar, etc.)</li>
<li>**Surgical fixes** - 5-10 lijnen per module, geen architectuur wijzigingen</li>
<li>**Backwards compatible** - Geen breaking changes, alleen verduidelijkingen</li>
<li>**Testable** - Concrete success criteria, meetbare output</li>
</ol>

<p>---</p>

<h2>üéØ Deliverables Checklist</h2>

<h3>Code Changes</h3>
<ul>
<li>[ ] `semantic_categorisation_module.py` - Exception notice toegevoegd</li>
<li>[ ] `structure_rules_module.py` - Exception clause toegevoegd</li>
<li>[ ] `error_prevention_module.py` - 3 regel modificaties</li>
</ul>

<h3>Tests</h3>
<ul>
<li>[ ] 4 unit tests geschreven en passing</li>
<li>[ ] 1 integration test geschreven en passing</li>
<li>[ ] Regression tests passing (bestaande test suite)</li>
</ul>

<h3>Documentation</h3>
<ul>
<li>[ ] Deze implementation guide (‚úÖ DONE)</li>
<li>[ ] Code comments toegevoegd bij exceptions</li>
<li>[ ] CLAUDE.md update (indien nodig)</li>
</ul>

<h3>Validation</h3>
<ul>
<li>[ ] Prompt gegenereerd voor alle 4 categorie√´n</li>
<li>[ ] Geen contradictions gedetecteerd</li>
<li>[ ] GPT-4 test: definitie genereren met nieuwe prompt</li>
</ul>

<p>---</p>

<h2>üí° Pro Tips</h2>

<ol>
<li>**Test incrementeel:** Na elke wijziging, genereer een prompt en check visueel</li>
<li>**Gebruik diff:** Check dat je ALLEEN de bedoelde regels wijzigt</li>
<li>**Pre-commit:** Run `pre-commit run --all-files` na elke wijziging</li>
<li>**Backup:** Commit na elke succesvolle wijziging (niet alles tegelijk)</li>
<li>**Visual check:** Gebruik `print(prompt)` om de output te inspecteren</li>
</ol>

<p>---</p>

<h2>üìû Hulp Nodig?</h2>

<p><strong>Blockers:</strong></p>
<ul>
<li>Exception clause syntax onduidelijk? ‚Üí Check INT-08 module voor voorbeeld</li>
<li>Test faalt? ‚Üí Check `docs/analyses/DEF-102_INJECTION_CALL_STACK.md` voor call stack</li>
<li>Merge conflict? ‚Üí Wijzigingen zijn in verschillende functies, geen conflicts verwacht</li>
</ul>

<p><strong>Resources:</strong></p>
<ul>
<li>Architectuur map: `docs/analyses/DEF-102_ARCHITECTURE_MAP.md`</li>
<li>Forensic analysis: `docs/analyses/DEF-102_CONTRADICTION_FORENSIC_ANALYSIS.md`</li>
<li>Call stack trace: `docs/analyses/DEF-102_INJECTION_CALL_STACK.md`</li>
</ul>

<p>---</p>

<p><strong>Ready to implement!</strong> Start met wijziging #1 (ESS-02 exception), test, dan volgende. üöÄ</p>

  </div>
</body>
</html>