<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Performance Regression Summary - Quick Reference</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">‚Üê Terug naar Portal</a>
    <h1>Performance Regression Summary - Quick Reference</h1>

<p><strong>Date:</strong> 2025-11-06</p>
<p><strong>Severity:</strong> CRITICAL</p>
<p><strong>Status:</strong> Root cause identified, fix ready</p>

<p>---</p>

<h2>The Problem in 3 Points</h2>

<ol>
<li>**RuleCache loading 4x** instead of 1x (US-202 regression)</li>
<li>**Context cleaner running 4x** (rerun cascade)</li>
<li>**35.7 second render** instead of 48ms (74,569% slower!)</li>
</ol>

<p>---</p>

<h2>Root Cause (Simple Explanation)</h2>

<p><strong>DEF-110 added this line:</strong></p>
<pre><code># tabbed_interface.py:220
init_context_cleaner(force_clean=True)  # In render() method</code></pre>

<p><strong>The problem:</strong></p>
<ul>
<li>`render()` is called on EVERY Streamlit interaction</li>
<li>`force_clean=True` ALWAYS modifies session state</li>
<li>State changes trigger Streamlit rerun</li>
<li>Rerun calls `render()` again ‚Üí infinite loop!</li>
<li>Streamlit stops after 4 reruns (safety limit)</li>
</ul>

<p><strong>Result:</strong> 4 complete app restarts in 7 seconds</p>

<p>---</p>

<h2>Why Caching Broke</h2>

<p>Each Streamlit rerun creates a <strong>NEW Python process</strong>:</p>
<ul>
<li>New process = all module-level singletons reset</li>
<li>`_rule_cache = None` ‚Üí RuleCache recreated 4x</li>
<li>`_default_container = None` ‚Üí ServiceContainer recreated 4x</li>
<li>All lazy-loaded services reloaded 4x</li>
</ul>

<p><strong>The @cached decorator can't help</strong> because it's process-local cache, and we're getting 4 new processes!</p>

<p>---</p>

<h2>The Fix (Simple)</h2>

<p><strong>Change 1 line:</strong></p>
<pre><code># tabbed_interface.py:220 (BEFORE)
init_context_cleaner(force_clean=True)  # ‚ùå WRONG

# tabbed_interface.py:220 (AFTER)
init_context_cleaner()  # ‚úÖ CORRECT - respects already-cleaned flag</code></pre>

<p><strong>But wait!</strong> This breaks DEF-110's fix for stale voorbeelden.</p>

<p><strong>Better fix:</strong> Move force_clean to Edit Tab only:</p>
<pre><code># examples_block.py (Edit Tab)
def render_voorbeelden_section(self, definitie_id: int, ...):
    current_def = definitie_id
    last_def = SessionStateManager.get_value("last_voorbeelden_def_id")

    # Only force clean when SWITCHING definitions
    if current_def != last_def:
        from ui.session_state import force_cleanup_voorbeelden
        force_cleanup_voorbeelden()
        SessionStateManager.set_value("last_voorbeelden_def_id", current_def)</code></pre>

<p>---</p>

<h2>Evidence from Your Logs</h2>

<h3>1. RuleCache Loading 4x</h3>
<pre><code>10:10:46,104 - Loading 53 regel files
10:10:46,104 - Loading 53 regel files  ‚Üê Same millisecond!
10:10:46,105 - Loading 53 regel files
10:10:46,106 - Loading 53 regel files</code></pre>
<p><strong>Analysis:</strong> 4 loads within 2ms = separate processes, not cache misses</p>

<h3>2. Context Cleaning 4x</h3>
<pre><code>10:10:37,094 - Context state cleaned on app initialization
10:10:39,331 - Context state cleaned on app initialization  (+2.2s)
10:10:42,843 - Context state cleaned on app initialization  (+3.5s)
10:10:44,735 - Context state cleaned on app initialization  (+1.9s)</code></pre>
<p><strong>Analysis:</strong> 4 "app initialization" logs = 4 complete restarts</p>

<h3>3. Render Regression</h3>
<pre><code>10:11:20,503 - CRITICAL regression voor streamlit_render_ms:
              35761.3 vs baseline 48.0 (74569.6%)</code></pre>
<p><strong>Analysis:</strong> 35.7 seconds = 4 startups √ó 6s + business logic overhead</p>

<p>---</p>

<h2>Impact Breakdown</h2>

<p>| Component | Before DEF-110 | After DEF-110 | Regression |</p>
<p>|-----------|---------------|---------------|------------|</p>
<p>| <strong>Startup</strong> | 6s | 36s | <strong>6x slower</strong> |</p>
<p>| <strong>RuleCache</strong> | 1x load | 4x loads | <strong>4x disk I/O</strong> |</p>
<p>| <strong>Prompt Init</strong> | 435ms | 1.7s | <strong>4x slower</strong> |</p>
<p>| <strong>Validation Init</strong> | 345ms | 1.4s | <strong>4x slower</strong> |</p>
<p>| <strong>Container Init</strong> | 200ms | 800ms | <strong>4x slower</strong> |</p>
<p>| <strong>Render</strong> | 48ms | 35,761ms | <strong>745x slower</strong> |</p>

<p>---</p>

<h2>Quick Fix Steps</h2>

<ol>
<li>**Revert force_clean in render():**</li>
<pre><code>   # Edit src/ui/tabbed_interface.py line 220
   -    init_context_cleaner(force_clean=True)
   +    init_context_cleaner()</code></pre>
</ol>

<ol>
<li>**Add definition-switch detection in Edit Tab** (see full fix in PERFORMANCE_REGRESSION_2025-11-06.md)</li>
</ol>

<ol>
<li>**Test locally:**</li>
<pre><code>   bash scripts/verify_performance_regression.sh
   # Should show: ‚úÖ NO REGRESSION DETECTED</code></pre>
</ol>

<ol>
<li>**Deploy and monitor** for 24h</li>
</ol>

<p>---</p>

<h2>Why This Happened</h2>

<p><strong>DEF-110's intent:</strong> Fix stale voorbeelden when switching definitions in Edit Tab</p>

<p><strong>What went wrong:</strong> Put the fix in <code>render()</code> instead of Edit Tab's definition-switch logic</p>

<p><strong>The lesson:</strong></p>
<ul>
<li>`render()` runs on EVERY interaction (button click, text input, tab switch)</li>
<li>State-modifying code in `render()` = rerun cascade</li>
<li>Force cleanup should be **event-based** (definition switch), not **render-based**</li>
</ul>

<p>---</p>

<h2>Prevention</h2>

<p><strong>Added to codebase:</strong></p>
<ol>
<li>‚úÖ Verification script: `scripts/verify_performance_regression.sh`</li>
<li>‚úÖ Full analysis: `docs/analyses/PERFORMANCE_REGRESSION_2025-11-06.md`</li>
<li>üîú Pre-commit hook to detect `force_clean=True` in `render()`</li>
<li>üîú Regression test in `tests/performance/test_startup_regression.py`</li>
</ol>

<p>---</p>

<h2>Related Fixes That Regressed</h2>

<p>All these optimizations were undone by the 4x rerun cascade:</p>

<ul>
<li>**US-202** (Oct 7): RuleCache 1x loading ‚Üí regressed to 4x</li>
<li>**DEF-66** (Oct 7): Lazy PromptService ‚Üí regressed to 4x init</li>
<li>**DEF-90** (Oct 7): Lazy ValidationOrchestrator ‚Üí regressed to 4x init</li>
</ul>

<p><strong>Good news:</strong> Once we fix the rerun cascade, all these optimizations work again automatically!</p>

<p>---</p>

<h2>Next Steps</h2>

<ol>
<li>**Implement fix** (30 min)</li>
<li>**Test locally** (15 min)</li>
<li>**Deploy to staging** (15 min)</li>
<li>**Monitor logs** (24h)</li>
<li>**Add regression tests** (2h)</li>
</ol>

<p><strong>ETA to fix:</strong> 1 hour</p>
<p><strong>ETA to prevent:</strong> 2 hours</p>

<p>---</p>

<p><strong>Full technical details:</strong> See <code>docs/analyses/PERFORMANCE_REGRESSION_2025-11-06.md</code></p>

<p><strong>Verification script:</strong> <code>scripts/verify_performance_regression.sh</code></p>

<p><strong>Analysis by:</strong> Claude Code (Debug Specialist)</p>

  </div>
</body>
</html>