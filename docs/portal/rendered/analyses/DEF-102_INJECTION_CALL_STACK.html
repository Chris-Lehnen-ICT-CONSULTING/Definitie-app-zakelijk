<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DEF-102: Exacte Functie Injection Call Stack Analyse</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">‚Üê Terug naar Portal</a>
    <h1>DEF-102: Exacte Functie Injection Call Stack Analyse</h1>

<p><strong>Datum:</strong> 2025-11-04</p>
<p><strong>Status:</strong> Complete trace van alle 5 contradictions</p>
<p><strong>Doel:</strong> Laat EXACT zien welke functie welk contradictie-deel injecteert</p>

<p>---</p>

<h2>üéØ Overzicht</h2>

<p>Dit document traced de <strong>exacte call stack</strong> van de PromptOrchestrator naar de specifieke functies die de <strong>5 contradicterende delen</strong> van de prompt injecteren.</p>

<p>---</p>

<h2>üìã Call Stack Structuur</h2>

<pre><code>PromptOrchestrator.build_prompt()          # src/services/prompts/modules/prompt_orchestrator.py:143
    ‚Üì
resolve_execution_order()                   # Lijn 169 - bepaalt module volgorde
    ‚Üì
_execute_module(module_id, context)        # Lijn 213 - execute elke module
    ‚Üì
module.execute(context)                     # Lijn 243 - roept specifieke module aan
    ‚Üì
[SPECIFIEKE MODULE FUNCTIE]                 # Hier wordt de prompt tekst gegenereerd</code></pre>

<p>---</p>

<h2>üî¥ Contradiction #1: "is" Usage Deadlock</h2>

<h3>‚úÖ REQUIRES "is" (ESS-02)</h3>

<p><strong>Call Stack:</strong></p>
<pre><code>PromptOrchestrator.build_prompt()
    ‚Üí _execute_module("semantic_categorisation", context)
    ‚Üí SemanticCategorisationModule.execute(context)
    ‚Üí _build_ess02_section(categorie)
    ‚Üí _get_category_specific_guidance("proces")</code></pre>

<p><strong>Exacte Injectie Functie:</strong></p>
<ul>
<li>**File:** `src/services/prompts/modules/semantic_categorisation_module.py`</li>
<li>**Function:** `_get_category_specific_guidance(categorie: str) -> str | None`</li>
<li>**Lijnen:** **180-197** (PROCES category)</li>
</ul>

<p><strong>Ge√Ønjecteerde Tekst (Lijn 182-185):</strong></p>
<pre><code>"proces": """**PROCES CATEGORIE - Focus op HANDELING en VERLOOP:**
Gebruik formuleringen zoals:
- 'is een activiteit waarbij...'      # ‚Üê VEREIST "is"!
- 'is het proces waarin...'            # ‚Üê VEREIST "is"!
- 'behelst de handeling van...'
- 'omvat de stappen die...'</code></pre>

<p><strong>Ook in base section (Lijn 140-144):</strong></p>
<pre><code>base_section = """### üìê Let op betekenislaag (ESS-02 - Ontologische categorie):
Je **moet** √©√©n van de vier categorie√´n expliciet maken:
Gebruik formuleringen zoals:
- 'is een activiteit waarbij...'       # ‚Üê VEREIST "is"!
- 'is het resultaat van...'            # ‚Üê VEREIST "is"!</code></pre>

<p>---</p>

<h3>‚ùå FORBIDS "is" (STR-01 + error_prevention)</h3>

<h4>A. STR-01 Regel</h4>

<p><strong>Call Stack:</strong></p>
<pre><code>PromptOrchestrator.build_prompt()
    ‚Üí _execute_module("structure_rules", context)
    ‚Üí StructureRulesModule.execute(context)
    ‚Üí _build_str01_rule()</code></pre>

<p><strong>Exacte Injectie Functie:</strong></p>
<ul>
<li>**File:** `src/services/prompts/modules/structure_rules_module.py`</li>
<li>**Function:** `_build_str01_rule() -> list[str]`</li>
<li>**Lijnen:** **132-151**</li>
</ul>

<p><strong>Ge√Ønjecteerde Tekst (Lijn 136-148):</strong></p>
<pre><code>rules.append("üîπ **STR-01 - definitie start met zelfstandig naamwoord**")
rules.append(
    "- De definitie moet starten met een zelfstandig naamwoord of naamwoordgroep, niet met een werkwoord."
)

if self.include_examples:
    rules.append("  ‚ùå is een maatregel die recidive voorkomt")  # ‚Üê VERBIEDT "is"!</code></pre>

<h4>B. Error Prevention Lijst</h4>

<p><strong>Call Stack:</strong></p>
<pre><code>PromptOrchestrator.build_prompt()
    ‚Üí _execute_module("error_prevention", context)
    ‚Üí ErrorPreventionModule.execute(context)
    ‚Üí _build_forbidden_starters()</code></pre>

<p><strong>Exacte Injectie Functie:</strong></p>
<ul>
<li>**File:** `src/services/prompts/modules/error_prevention_module.py`</li>
<li>**Function:** `_build_forbidden_starters() -> list[str]`</li>
<li>**Lijnen:** **155-194**</li>
</ul>

<p><strong>Ge√Ønjecteerde Tekst (Lijn 157-194):</strong></p>
<pre><code>forbidden_starters = [
    "is",                    # ‚Üê EXPLICIETE VERBOD regel 1!
    "betreft",
    "omvat",
    # ... rest
]

return [f"- ‚ùå Start niet met '{starter}'" for starter in forbidden_starters]
# Resulteert in: "- ‚ùå Start niet met 'is'"</code></pre>

<p><strong>Ook in basic errors (Lijn 143-153):</strong></p>
<pre><code>def _build_basic_errors(self) -&gt; list[str]:
    return [
        "- ‚ùå Begin niet met lidwoorden ('de', 'het', 'een')",
        "- ‚ùå Gebruik geen koppelwerkwoord aan het begin ('is', 'betekent', 'omvat')",  # ‚Üê VERBIEDT "is"!
        # ...
    ]</code></pre>

<p>---</p>

<h2>üî¥ Contradiction #2: Container Terms Conflict</h2>

<h3>‚ùå FORBIDS "proces", "activiteit" (ARAI-02)</h3>

<p><strong>Call Stack:</strong></p>
<pre><code>PromptOrchestrator.build_prompt()
    ‚Üí _execute_module("error_prevention", context)
    ‚Üí ErrorPreventionModule.execute(context)
    ‚Üí _build_basic_errors()</code></pre>

<p><strong>Exacte Injectie Functie:</strong></p>
<ul>
<li>**File:** `src/services/prompts/modules/error_prevention_module.py`</li>
<li>**Function:** `_build_basic_errors() -> list[str]`</li>
<li>**Lijn:** **143-153** (lijn 150 specifiek)</li>
</ul>

<p><strong>Ge√Ønjecteerde Tekst (Lijn 150):</strong></p>
<pre><code>return [
    "- ‚ùå Begin niet met lidwoorden ('de', 'het', 'een')",
    "- ‚ùå Gebruik geen koppelwerkwoord aan het begin ('is', 'betekent', 'omvat')",
    "- ‚ùå Herhaal het begrip niet letterlijk",
    "- ‚ùå Gebruik geen synoniem als definitie",
    "- ‚ùå Vermijd containerbegrippen ('proces', 'activiteit')",  # ‚Üê VERBIEDT!
    # ...
]</code></pre>

<p>---</p>

<h3>‚úÖ USES "proces", "activiteit" (ESS-02 templates)</h3>

<p><strong>Call Stack:</strong> (Zelfde als Contradiction #1)</p>
<pre><code>PromptOrchestrator.build_prompt()
    ‚Üí _execute_module("semantic_categorisation", context)
    ‚Üí SemanticCategorisationModule.execute(context)
    ‚Üí _build_ess02_section(categorie)
    ‚Üí _get_category_specific_guidance("proces")</code></pre>

<p><strong>Exacte Injectie Functie:</strong></p>
<ul>
<li>**File:** `src/services/prompts/modules/semantic_categorisation_module.py`</li>
<li>**Function:** `_get_category_specific_guidance(categorie: str) -> str | None`</li>
<li>**Lijnen:** **180-197**</li>
</ul>

<p><strong>Ge√Ønjecteerde Tekst (Lijn 182-184):</strong></p>
<pre><code>"proces": """**PROCES CATEGORIE - Focus op HANDELING en VERLOOP:**
Gebruik formuleringen zoals:
- 'is een activiteit waarbij...'       # ‚Üê GEBRUIKT "activiteit"!
- 'is het proces waarin...'            # ‚Üê GEBRUIKT "proces"!</code></pre>

<p>---</p>

<h2>üü° Contradiction #3: Relative Clauses Paradox</h2>

<h3>‚ùå FORBIDS "die", "waarbij"</h3>

<p><strong>Call Stack:</strong></p>
<pre><code>PromptOrchestrator.build_prompt()
    ‚Üí _execute_module("error_prevention", context)
    ‚Üí ErrorPreventionModule.execute(context)
    ‚Üí _build_basic_errors()</code></pre>

<p><strong>Exacte Injectie Functie:</strong></p>
<ul>
<li>**File:** `src/services/prompts/modules/error_prevention_module.py`</li>
<li>**Function:** `_build_basic_errors() -> list[str]`</li>
<li>**Lijn:** **151**</li>
</ul>

<p><strong>Ge√Ønjecteerde Tekst:</strong></p>
<pre><code>"- ‚ùå Vermijd bijzinnen zoals 'die', 'waarin', 'zoals'"  # ‚Üê VERBIEDT "die"!</code></pre>

<p>---</p>

<h3>‚úÖ USES "die", "waarbij" (ESS-02 + templates)</h3>

<p><strong>Call Stack:</strong> (Zelfde als Contradiction #1)</p>

<p><strong>Exacte Injectie Functie:</strong></p>
<ul>
<li>**File:** `src/services/prompts/modules/semantic_categorisation_module.py`</li>
<li>**Lijnen:** **182, 196, etc.**</li>
</ul>

<p><strong>Ge√Ønjecteerde Tekst:</strong></p>
<pre><code>- 'is een activiteit waarbij...'          # ‚Üê GEBRUIKT "waarbij"!
- 'activiteit waarbij systematisch gevolgd wordt...'  # ‚Üê GEBRUIKT "waarbij"!
- 'maatregel die volgt op...'             # ‚Üê GEBRUIKT "die"!</code></pre>

<p>---</p>

<h2>üî¥ Contradiction #4: Article "een"</h2>

<h3>‚ùå FORBIDS "een"</h3>

<p><strong>Call Stack:</strong></p>
<pre><code>PromptOrchestrator.build_prompt()
    ‚Üí _execute_module("error_prevention", context)
    ‚Üí ErrorPreventionModule.execute(context)
    ‚Üí _build_basic_errors()</code></pre>

<p><strong>Exacte Injectie Functie:</strong></p>
<ul>
<li>**File:** `src/services/prompts/modules/error_prevention_module.py`</li>
<li>**Function:** `_build_basic_errors() -> list[str]`</li>
<li>**Lijn:** **146**</li>
</ul>

<p><strong>Ge√Ønjecteerde Tekst:</strong></p>
<pre><code>"- ‚ùå Begin niet met lidwoorden ('de', 'het', 'een')"  # ‚Üê VERBIEDT "een"!</code></pre>

<p><strong>Ook in forbidden_starters (Lijn 178-179):</strong></p>
<pre><code>forbidden_starters = [
    # ...
    "de",
    "het",
    "een",    # ‚Üê EXPLICIETE VERBOD!
    # ...
]</code></pre>

<p>---</p>

<h3>‚úÖ USES "een" (ESS-02)</h3>

<p><strong>Call Stack:</strong> (Zelfde als Contradiction #1)</p>

<p><strong>Exacte Injectie Functie:</strong></p>
<ul>
<li>**File:** `src/services/prompts/modules/semantic_categorisation_module.py`</li>
<li>**Lijnen:** **140-144, 182-185, etc.**</li>
</ul>

<p><strong>Ge√Ønjecteerde Tekst:</strong></p>
<pre><code>- 'is een activiteit waarbij...'       # ‚Üê GEBRUIKT "een"! (66.7% van patronen)
- 'is een soort...'
- 'is een categorie van...'</code></pre>

<p>---</p>

<h2>üü° Contradiction #5: Context Usage Ambiguity</h2>

<h3>‚ùå FORBIDS Explicit Context</h3>

<p><strong>Call Stack:</strong></p>
<pre><code>PromptOrchestrator.build_prompt()
    ‚Üí _execute_module("error_prevention", context)
    ‚Üí ErrorPreventionModule.execute(context)
    ‚Üí _build_context_forbidden(org_contexts, jur_contexts, wet_contexts)</code></pre>

<p><strong>Exacte Injectie Functie:</strong></p>
<ul>
<li>**File:** `src/services/prompts/modules/error_prevention_module.py`</li>
<li>**Function:** `_build_context_forbidden(...) -> list[str]`</li>
<li>**Lijnen:** **196-248**</li>
</ul>

<p><strong>Ge√Ønjecteerde Tekst (Lijn 226-246):</strong></p>
<pre><code># Organisatorische context verboden (Lijn 224-234)
for org in org_contexts:
    forbidden.append(
        f"- Gebruik de term '{org}' of een variant daarvan niet letterlijk in de definitie."
    )

# Juridische context verboden (Lijn 236-240)
for jur in jur_contexts:
    forbidden.append(
        f"- Vermijd expliciete vermelding van juridisch context '{jur}' in de definitie."
    )

# Wettelijke basis verboden (Lijn 242-246)
for wet in wet_contexts:
    forbidden.append(
        f"- Vermijd expliciete vermelding van wetboek '{wet}' in de definitie."
    )</code></pre>

<p><strong>Laatste waarschuwing (Lijn 107-109):</strong></p>
<pre><code>sections.append(
    "\nüö´ Let op: context en bronnen mogen niet letterlijk of herleidbaar in de definitie voorkomen."
)</code></pre>

<p>---</p>

<h3>‚úÖ REQUIRES Context Usage (CON-01)</h3>

<p><strong>Probleem:</strong> CON-01 zegt "context-specific" maar geeft GEEN operationele definitie van HOE context te gebruiken zonder het "traceable" te maken.</p>

<p><strong>Deze regel is NIET expliciet ge√Ønjecteerd in een module</strong>, maar is implied in:</p>
<ul>
<li>ContextAwarenessModule (set contexts)</li>
<li>Validation rules (check context relevance)</li>
</ul>

<p><strong>Operational Gap:</strong></p>
<ul>
<li>User moet context gebruiken ("Strafrecht")</li>
<li>User mag "Strafrecht" niet noemen</li>
<li>GEEN voorbeeld van HOE dit te doen</li>
</ul>

<p>---</p>

<h2>üìä Module Execution Order (Probleem Amplifier)</h2>

<p><strong>Default Module Order (Lijn 354-372):</strong></p>

<pre><code>return [
    "expertise",                    # 1
    "output_specification",         # 2
    "grammar",                      # 3
    "context_awareness",            # 4
    "semantic_categorisation",      # 5 ‚Üê ZEGT: "gebruik 'is een activiteit'"
    "template",                     # 6
    "arai_rules",                   # 7
    "con_rules",                    # 8
    "ess_rules",                    # 9
    "structure_rules",              # 10 ‚Üê ZEGT: "niet starten met 'is'"
    "integrity_rules",              # 11
    "sam_rules",                    # 12
    "ver_rules",                    # 13
    "error_prevention",             # 14 ‚Üê ZEGT: "- ‚ùå Start niet met 'is'"
    "metrics",                      # 15
    "definition_task",              # 16
]</code></pre>

<p><strong>Probleem:</strong></p>
<ul>
<li>ESS-02 (lijn 140-144, 182-185) zegt EERST: "gebruik 'is een activiteit'"</li>
<li>STR-01 (lijn 147) zegt LATER: "‚ùå is een maatregel"</li>
<li>error_prevention (lijn 157) zegt LAATSTE: "‚ùå Start niet met 'is'"</li>
</ul>

<p><strong>Gevolg:</strong> GPT-4 krijgt EERST instructie A, daarna instructie NOT-A ‚Üí cognitive dissonance!</p>

<p>---</p>

<h2>üéØ Critical Insight: Function Locations</h2>

<h3>Priority 1: ESS-02 Exception Clause Toevoegen</h3>

<p><strong>Target Function:</strong></p>
<ul>
<li>**File:** `src/services/prompts/modules/semantic_categorisation_module.py`</li>
<li>**Function:** `_get_category_specific_guidance(categorie: str)`</li>
<li>**Lijnen:** **180-197** (PROCES category)</li>
<li>**Action:** Add exception notice BOVEN line 182</li>
</ul>

<pre><code># TOEVOEGEN (voor lijn 182):
"""
‚ö†Ô∏è EXCEPTION voor Ontologische Categorie (ESS-02):
Bij PROCES categorie√´n MAG je starten met:
- "is een activiteit waarbij..."
- "is het proces waarin..."
Dit is de ENIGE uitzondering op STR-01 en error_prevention regels.
"""</code></pre>

<h3>Priority 2: STR-01 Exception Clause Toevoegen</h3>

<p><strong>Target Function:</strong></p>
<ul>
<li>**File:** `src/services/prompts/modules/structure_rules_module.py`</li>
<li>**Function:** `_build_str01_rule()`</li>
<li>**Lijnen:** **132-151**</li>
<li>**Action:** Add exception NA line 139</li>
</ul>

<pre><code># TOEVOEGEN (na lijn 139):
rules.append("‚ö†Ô∏è UITZONDERING: Bij ontologische categorie marking (ESS-02) MAG 'is een activiteit/proces/resultaat' gebruikt worden.")</code></pre>

<h3>Priority 3: error_prevention Exception Clause</h3>

<p><strong>Target Function:</strong></p>
<ul>
<li>**File:** `src/services/prompts/modules/error_prevention_module.py`</li>
<li>**Function:** `_build_basic_errors()`</li>
<li>**Lijnen:** **143-153**</li>
<li>**Action:** Modify line 147</li>
</ul>

<pre><code># WIJZIG lijn 147 van:
"- ‚ùå Gebruik geen koppelwerkwoord aan het begin ('is', 'betekent', 'omvat')",

# NAAR:
"- ‚ùå Gebruik geen koppelwerkwoord aan het begin ('is', 'betekent', 'omvat') tenzij vereist voor ontologische categorie (ESS-02)",</code></pre>

<h3>Priority 4: ARAI-02 Container Terms Exemption</h3>

<p><strong>Target Function:</strong></p>
<ul>
<li>**File:** `src/services/prompts/modules/error_prevention_module.py`</li>
<li>**Function:** `_build_basic_errors()`</li>
<li>**Lijnen:** **150**</li>
<li>**Action:** Modify line 150</li>
</ul>

<pre><code># WIJZIG lijn 150 van:
"- ‚ùå Vermijd containerbegrippen ('proces', 'activiteit')",

# NAAR:
"- ‚ùå Vermijd containerbegrippen ('proces', 'activiteit') behalve als ontologische marker (ESS-02)",</code></pre>

<h3>Priority 5: Relative Clauses Clarification</h3>

<p><strong>Target Function:</strong></p>
<ul>
<li>**File:** `src/services/prompts/modules/error_prevention_module.py`</li>
<li>**Function:** `_build_basic_errors()`</li>
<li>**Lijnen:** **151**</li>
<li>**Action:** Modify line 151</li>
</ul>

<pre><code># WIJZIG lijn 151 van:
"- ‚ùå Vermijd bijzinnen zoals 'die', 'waarin', 'zoals'",

# NAAR:
"- ‚ùå Beperk bijzinnen ('die', 'waarin', 'waarbij'). Gebruik ALLEEN wanneer: (1) Nodig voor ontologische categorie (ESS-02), (2) Essentieel voor specificiteit",</code></pre>

<p>---</p>

<h2>üéØ Summary: Exact Injection Points</h2>

<p>| Contradiction | Module | Function | Lijnen | Action |</p>
<p>|---------------|--------|----------|--------|--------|</p>
<p>| #1: "is" (REQUIRES) | <code>semantic_categorisation_module.py</code> | <code>_get_category_specific_guidance()</code> | 180-197 | Add exception notice |</p>
<p>| #1: "is" (FORBIDS) | <code>structure_rules_module.py</code> | <code>_build_str01_rule()</code> | 132-151 | Add exception clause |</p>
<p>| #1: "is" (FORBIDS) | <code>error_prevention_module.py</code> | <code>_build_basic_errors()</code> | 147 | Modify with "tenzij ESS-02" |</p>
<p>| #2: Container (FORBIDS) | <code>error_prevention_module.py</code> | <code>_build_basic_errors()</code> | 150 | Add "behalve ontologische marker" |</p>
<p>| #2: Container (USES) | <code>semantic_categorisation_module.py</code> | <code>_get_category_specific_guidance()</code> | 182-184 | (Blijft zoals is) |</p>
<p>| #3: Relative (FORBIDS) | <code>error_prevention_module.py</code> | <code>_build_basic_errors()</code> | 151 | Clarify with conditions |</p>
<p>| #4: "een" (FORBIDS) | <code>error_prevention_module.py</code> | <code>_build_basic_errors()</code> | 146 | (Blijft - geldt niet voor ESS-02 pattern) |</p>
<p>| #5: Context | <code>error_prevention_module.py</code> | <code>_build_context_forbidden()</code> | 196-248 | Add operational examples |</p>

<p>---</p>

<h2>üöÄ Implementation Strategy</h2>

<ol>
<li>**Start met Priority 1:** ESS-02 exception clause (semantic_categorisation_module.py)</li>
<li>**Dan Priority 2:** STR-01 exception (structure_rules_module.py)</li>
<li>**Dan Priority 3-5:** error_prevention modifications</li>
<li>**Test na elke wijziging:** Generate prompt en check for contradictions</li>
</ol>

<p><strong>Estimated Effort:</strong> 3 uur (zoals gespecificeerd in DEF-102)</p>

<p>---</p>

<p><strong>Document Compleet</strong> ‚úÖ</p>
<p>Nu heb je EXACT welke functie welk deel injecteert, met regelnummers en call stacks!</p>

  </div>
</body>
</html>