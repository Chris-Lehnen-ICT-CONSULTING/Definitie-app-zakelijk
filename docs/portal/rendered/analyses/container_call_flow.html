<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ServiceContainer Call Flow Diagram</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">â† Terug naar Portal</a>
    <h1>ServiceContainer Call Flow Diagram</h1>

<h2>Visual Call Path Analysis</h2>

<h3>Container Creation Flow</h3>

<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         APPLICATION STARTUP                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚      main.py (line 63)    â”‚
                    â”‚ SessionStateManager.      â”‚
                    â”‚ initialize_session_state()â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ ui/session_state.py (line 78-80)      â”‚
                    â”‚ from ui.cached_services import        â”‚
                    â”‚     initialize_services_once          â”‚
                    â”‚ initialize_services_once()            â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ ui/cached_services.py (line 45-51)    â”‚
                    â”‚ def initialize_services_once():       â”‚
                    â”‚   if service_container is None:       â”‚
                    â”‚     set_value("service_container",    â”‚
                    â”‚       get_cached_service_container()) â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ ui/cached_services.py (line 32-35)    â”‚
                    â”‚ def get_cached_service_container(     â”‚
                    â”‚     config=None):                     â”‚
                    â”‚   if config is None:                  â”‚
                    â”‚     return get_cached_container() â—„â”€â”€â”€â”¼â”€â”€ PATH A
                    â”‚   else:                               â”‚
                    â”‚     return get_container_with_config()â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ utils/container_manager.py (line 48)  â”‚
                    â”‚ @lru_cache(maxsize=1)                 â”‚
                    â”‚ def get_cached_container():           â”‚
                    â”‚   logger.info("ğŸš€ Initialiseer...")   â”‚
                    â”‚   config = ContainerConfigs.prod...() â”‚
                    â”‚   return ServiceContainer(config)     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚ CONTAINER #1 â”‚  âœ… Created
                           â”‚ (Cached A)   â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TABBED INTERFACE INIT                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ ui/tabbed_interface.py (line 90-94)   â”‚
                    â”‚ class TabbedInterface:                â”‚
                    â”‚   def __init__(self):                 â”‚
                    â”‚     self.container =                  â”‚
                    â”‚       get_cached_container() â—„â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€ PATH B
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ utils/container_manager.py (line 48)  â”‚
                    â”‚ @lru_cache(maxsize=1)                 â”‚
                    â”‚ def get_cached_container():           â”‚
                    â”‚   [CACHE HIT - Returns Container #1]  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚ CONTAINER #1 â”‚  â™»ï¸ Reused (Cache Hit)
                           â”‚ (Cached A)   â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  DEFINITION SERVICE INIT                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ ui/tabbed_interface.py (line 101-102) â”‚
                    â”‚   self.definition_service =           â”‚
                    â”‚     get_definition_service() â—„â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€ PATH C
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ services/service_factory.py           â”‚
                    â”‚   (line 745-756)                      â”‚
                    â”‚ def get_definition_service(           â”‚
                    â”‚     use_container_config=None):       â”‚
                    â”‚   config = use_container_config or    â”‚
                    â”‚            _get_environment_config()  â”‚ â† ALWAYS dict!
                    â”‚   container = get_container(config)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ services/service_factory.py           â”‚
                    â”‚   (line 32-42)                        â”‚
                    â”‚ def get_container(config=None):       â”‚
                    â”‚   if config is None:                  â”‚
                    â”‚     return get_cached_container()     â”‚
                    â”‚   from utils.container_manager import â”‚
                    â”‚     get_container_with_config         â”‚
                    â”‚   return get_container_with_config(   â”‚
                    â”‚     config) â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€ PATH C1
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ utils/container_manager.py            â”‚
                    â”‚   (line 88-114)                       â”‚
                    â”‚ def get_container_with_config(config):â”‚
                    â”‚   if config is None:                  â”‚
                    â”‚     return get_cached_container()     â”‚
                    â”‚   config_hash = _get_config_hash(cfg) â”‚
                    â”‚   return _create_custom_container(    â”‚
                    â”‚     config_hash, json.dumps(config))  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ utils/container_manager.py            â”‚
                    â”‚   (line 24-29)                        â”‚
                    â”‚ @lru_cache(maxsize=8)                 â”‚
                    â”‚ def _create_custom_container(         â”‚
                    â”‚     _hash, _config_json):             â”‚
                    â”‚   logger.info("ğŸ”§ Maak custom...")    â”‚
                    â”‚   return ServiceContainer(            â”‚
                    â”‚     json.loads(_config_json))         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚ CONTAINER #2 â”‚  âœ… Created (Different Cache!)
                           â”‚ (Cached B)   â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>

<p>---</p>

<h2>Cache Architecture</h2>

<h3>Cache Layers</h3>

<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CACHE LAYER 1                             â”‚
â”‚                  @lru_cache(maxsize=1)                            â”‚
â”‚                  get_cached_container()                           â”‚
â”‚                                                                   â”‚
â”‚  Key: None (singleton)                                            â”‚
â”‚  Value: Container with environment config                         â”‚
â”‚                                                                   â”‚
â”‚  â”œâ”€ Used by: SessionStateManager (PATH A)                         â”‚
â”‚  â””â”€ Used by: TabbedInterface (PATH B)                             â”‚
â”‚                                                                   â”‚
â”‚  Status: âœ… Working as intended (singleton)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CACHE LAYER 2                             â”‚
â”‚                  @lru_cache(maxsize=8)                            â”‚
â”‚                  _create_custom_container()                       â”‚
â”‚                                                                   â”‚
â”‚  Key: (config_hash, config_json)                                  â”‚
â”‚  Value: Container with custom config                              â”‚
â”‚                                                                   â”‚
â”‚  â”œâ”€ Used by: get_container_with_config()                          â”‚
â”‚  â””â”€ Triggered by: ServiceFactory (PATH C)                         â”‚
â”‚                                                                   â”‚
â”‚  Status: âš ï¸ Creates separate container despite same config        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CACHE LAYER 3                             â”‚
â”‚              _SERVICE_ADAPTER_CACHE: dict                         â”‚
â”‚                                                                   â”‚
â”‚  Key: frozen(config)                                              â”‚
â”‚  Value: ServiceAdapter instance                                   â”‚
â”‚                                                                   â”‚
â”‚  â””â”€ Used by: get_definition_service()                             â”‚
â”‚                                                                   â”‚
â”‚  Status: â„¹ï¸ Caches adapters, not containers                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>

<p>---</p>

<h2>Why Two Containers Are Created</h2>

<h3>The Config Paradox</h3>

<p><strong>Problem:</strong> Even with IDENTICAL configs, two containers are created because they use <strong>different cache mechanisms</strong>.</p>

<h4>Container #1 Flow:</h4>
<pre><code># PATH A: SessionStateManager
config = None
  â†’ get_cached_container()          # Uses Cache Layer 1
    â†’ Environment config internally
    â†’ ServiceContainer(config)
    â†’ âœ… CACHED in LRU cache (maxsize=1)</code></pre>

<h4>Container #2 Flow:</h4>
<pre><code># PATH C: ServiceFactory
config = _get_environment_config()   # Returns dict
  â†’ get_container(config)            # config is dict, not None
    â†’ get_container_with_config(config)
      â†’ _create_custom_container()   # Uses Cache Layer 2
        â†’ ServiceContainer(config)
        â†’ âœ… CACHED in LRU cache (maxsize=8)</code></pre>

<p><strong>Key Issue:</strong></p>
<ul>
<li>Cache 1 key: `None` (uses internal env config)</li>
<li>Cache 2 key: `(hash, json)` (explicit config dict)</li>
<li>**Same config, different cache keys â†’ 2 instances!**</li>
</ul>

<p>---</p>

<h2>Config Comparison</h2>

<h3>Are the configs actually identical?</h3>

<p><strong>Container #1 config:</strong></p>
<pre><code># utils/container_manager.py line 65-72
env = os.getenv("APP_ENV", "production")
if env == "development":
    config = ContainerConfigs.development()
elif env == "testing":
    config = ContainerConfigs.testing()
else:
    config = ContainerConfigs.production()  # â† Default</code></pre>

<p><strong>Container #2 config:</strong></p>
<pre><code># services/service_factory.py line 107-117
def _get_environment_config() -&gt; dict:
    env = os.getenv("APP_ENV", "production")
    if env == "development":
        return ContainerConfigs.development()
    if env == "testing":
        return ContainerConfigs.testing()
    return ContainerConfigs.production()      # â† Default</code></pre>

<p><strong>Result:</strong> âœ… <strong>IDENTICAL</strong> configs (same logic, same ContainerConfigs methods)</p>

<p><strong>BUT:</strong> Different cache mechanisms treat them as different instances!</p>

<p>---</p>

<h2>Solution Architecture</h2>

<h3>Proposed Single Cache Strategy</h3>

<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    UNIFIED CACHE LAYER                            â”‚
â”‚                  @lru_cache(maxsize=1)                            â”‚
â”‚                  get_cached_container()                           â”‚
â”‚                                                                   â”‚
â”‚  Single Entry Point for ALL container requests                    â”‚
â”‚                                                                   â”‚
â”‚  â”œâ”€ PATH A: SessionStateManager â†’ get_cached_container()          â”‚
â”‚  â”œâ”€ PATH B: TabbedInterface â†’ get_cached_container()              â”‚
â”‚  â””â”€ PATH C: ServiceFactory â†’ get_cached_container()               â”‚
â”‚                                                                   â”‚
â”‚  Result: âœ… ALWAYS returns SAME instance (true singleton)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

REMOVE:
  âŒ _create_custom_container()
  âŒ get_container_with_config()
  âŒ Custom config support
  âŒ _SERVICE_ADAPTER_CACHE dict</code></pre>

<h3>Implementation Changes</h3>

<p><strong>1. Simplify container_manager.py:</strong></p>
<pre><code>@lru_cache(maxsize=1)
def get_cached_container() -&gt; ServiceContainer:
    """Single source of truth for ServiceContainer."""
    env = os.getenv("APP_ENV", "production")
    config = {
        "development": ContainerConfigs.development,
        "testing": ContainerConfigs.testing,
    }.get(env, ContainerConfigs.production)()

    return ServiceContainer(config)

# REMOVE: _create_custom_container
# REMOVE: get_container_with_config
# REMOVE: _get_config_hash</code></pre>

<p><strong>2. Simplify service_factory.py:</strong></p>
<pre><code>def get_definition_service():
    """Always use singleton container."""
    # Simple function-level cache (no config hashing needed)
    if not hasattr(get_definition_service, '_adapter'):
        container = get_cached_container()  # Singleton
        get_definition_service._adapter = ServiceAdapter(container)

    return get_definition_service._adapter

# REMOVE: _SERVICE_ADAPTER_CACHE
# REMOVE: _get_environment_config
# REMOVE: _freeze_config</code></pre>

<p><strong>3. Simplify cached_services.py:</strong></p>
<pre><code>def get_cached_service_container():
    """Direct pass-through to singleton."""
    return get_cached_container()

# REMOVE: config parameter
# REMOVE: if/else logic</code></pre>

<p>---</p>

<h2>Expected Results</h2>

<h3>Before (Current State):</h3>
<pre><code>Startup sequence:
1. SessionStateManager.init â†’ Container #1 (Cache A) [300ms]
2. TabbedInterface.init â†’ Container #1 (Cache hit) [0ms] âœ…
3. ServiceFactory.init â†’ Container #2 (Cache B) [300ms]

Total: 600ms overhead, 2 containers, 3 cache layers</code></pre>

<h3>After (Proposed):</h3>
<pre><code>Startup sequence:
1. SessionStateManager.init â†’ Container #1 (Singleton) [300ms]
2. TabbedInterface.init â†’ Container #1 (Cache hit) [0ms] âœ…
3. ServiceFactory.init â†’ Container #1 (Cache hit) [0ms] âœ…

Total: 300ms overhead, 1 container, 1 cache layer</code></pre>

<p><strong>Improvement:</strong></p>
<ul>
<li>âš¡ 50% faster startup (300ms saved)</li>
<li>ğŸ’¾ 66% less memory (1 vs 2 active containers)</li>
<li>ğŸ§¹ 70% simpler code (remove 3 functions, 1 dict cache)</li>
<li>ğŸ› 100% fewer cache bugs (single mechanism)</li>
</ul>

<p>---</p>

<h2>Testing Strategy</h2>

<h3>Verification Steps:</h3>

<p><strong>1. Log Analysis:</strong></p>
<pre><code># Should see ONLY ONE line:
"ğŸš€ Initialiseer ServiceContainer (gebeurt 1x per sessie)"
"ServiceContainer geÃ¯nitialiseerd (init count: 1)"

# Should NOT see:
"ğŸ”§ Maak custom ServiceContainer (hash: ...)"</code></pre>

<p><strong>2. Container Identity Test:</strong></p>
<pre><code># All should reference SAME instance
container_a = get_cached_container()
container_b = get_container()  # via service_factory
container_c = SessionStateManager.get_value("service_container")

assert container_a is container_b
assert container_b is container_c
assert id(container_a) == id(container_b) == id(container_c)</code></pre>

<p><strong>3. Cache Hit Rate:</strong></p>
<pre><code># Should be 100% after first init
stats = get_cached_container.cache_info()
assert stats.hits &gt; stats.misses  # After warmup</code></pre>

<p>---</p>

<h2>Migration Checklist</h2>

<ul>
<li>[ ] Backup current container_manager.py</li>
<li>[ ] Remove `_create_custom_container()` function</li>
<li>[ ] Remove `get_container_with_config()` function</li>
<li>[ ] Remove `_get_config_hash()` function</li>
<li>[ ] Update `get_container()` in service_factory.py to use singleton</li>
<li>[ ] Remove `_SERVICE_ADAPTER_CACHE` dict</li>
<li>[ ] Remove `_get_environment_config()` duplicate</li>
<li>[ ] Remove `_freeze_config()` function</li>
<li>[ ] Update `get_definition_service()` to use function-level cache</li>
<li>[ ] Update `get_cached_service_container()` to simple pass-through</li>
<li>[ ] Run full test suite</li>
<li>[ ] Verify log output (should show 1 container init)</li>
<li>[ ] Measure startup time improvement</li>
<li>[ ] Update documentation</li>
</ul>

<p>---</p>

<p><strong>Diagram Author:</strong> Claude Code (Debug Specialist)</p>
<p><strong>Date:</strong> 2025-10-06</p>
<p><strong>Related:</strong> DOUBLE_CONTAINER_ANALYSIS.md</p>

  </div>
</body>
</html>