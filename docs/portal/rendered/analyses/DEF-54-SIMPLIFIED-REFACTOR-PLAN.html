<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DEF-54: Simplified & Safer Dual Repository Elimination Plan</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">‚Üê Terug naar Portal</a>
    <h1>DEF-54: Simplified & Safer Dual Repository Elimination Plan</h1>

<p><strong>Date</strong>: 2025-10-29</p>
<p><strong>Status</strong>: PROPOSED (Safer Alternative to Original 5-Phase Plan)</p>
<p><strong>Risk Level</strong>: LOW ‚Üí MEDIUM (reduced from original MEDIUM)</p>
<p><strong>Timeline</strong>: 7-10 phases, 6-8 days (vs original 5 phases, 5 days)</p>

<p>---</p>

<h2>Executive Summary</h2>

<p><strong>PROBLEM</strong>: Current 5-phase plan merges 500+ lines at once (Phase 2), high blast radius if issues occur, difficult rollback.</p>

<p><strong>SOLUTION</strong>: 10-phase Strangler Pattern with method-by-method migration:</p>
<ul>
<li>Each phase touches 50-150 lines (not 500+)</li>
<li>Each phase is independently committable</li>
<li>Each phase can be rolled back without affecting others</li>
<li>Feature flag enables instant rollback without git operations</li>
<li>Schema changes decoupled from code changes</li>
</ul>

<p><strong>KEY IMPROVEMENTS</strong>:</p>
<ol>
<li>**Incremental**: 10 smaller phases vs 5 large phases</li>
<li>**Safer**: Feature flag for instant rollback</li>
<li>**Testable**: Write tests BEFORE each merge</li>
<li>**Documented**: Migration guide + architecture docs updated inline</li>
<li>**Pragmatic**: No over-engineering, just safer execution</li>
</ol>

<p>---</p>

<h2>BEFORE ‚Üí AFTER Metrics</h2>

<p>| Metric | Original Plan | Simplified Plan | Benefit |</p>
<p>|--------|---------------|-----------------|---------|</p>
<p>| <strong>Largest Single Change</strong> | 500+ lines | ~150 lines | 70% smaller blast radius |</p>
<p>| <strong>Phases</strong> | 5 phases | 10 phases | 2x more granular |</p>
<p>| <strong>Rollback Strategy</strong> | Git revert only | Feature flag + git | Instant rollback |</p>
<p>| <strong>Test Strategy</strong> | Test after merge | Test-first each phase | Confidence before commit |</p>
<p>| <strong>Schema Changes</strong> | Mixed with code | Separate phase (0) | Decouple data from code |</p>
<p>| <strong>Callsite Updates</strong> | 23 files at once | 3-5 files per phase | Easier debugging |</p>
<p>| <strong>Documentation</strong> | After completion | Inline with phases | Always up-to-date |</p>

<p>---</p>

<h2>Core Principles</h2>

<h3>1. **Strangler Pattern** (Not Big-Bang)</h3>
<ul>
<li>Keep BOTH repositories temporarily</li>
<li>Migrate callsites one-by-one</li>
<li>Delete legacy only when 0 callsites remain</li>
<li>**Trade-off**: Longer timeline, but MUCH safer</li>
</ul>

<h3>2. **Feature Flag Strategy**</h3>
<p>Even though solo user, use environment flag:</p>
<pre><code>USE_LEGACY_REPO = os.getenv("USE_LEGACY_REPO", "false") == "true"</code></pre>
<p><strong>Benefit</strong>: Instant rollback without git, just flip env var</p>

<h3>3. **Test-First Per Phase**</h3>
<ol>
<li>Write NEW tests for merged functionality FIRST</li>
<li>Ensure they FAIL with current implementation</li>
<li>Implement merge to make tests PASS</li>
<li>Old tests should also still pass</li>
</ol>

<h3>4. **Database Schema First**</h3>
<p>Schema changes FIRST (separate PR) before code refactor:</p>
<ul>
<li>Does DefinitieRecord have fields that Definition doesn't?</li>
<li>Do we need ALTER TABLE migrations?</li>
<li>**Benefit**: Decouple data structure from code refactor</li>
</ul>

<h3>5. **Document As You Go**</h3>
<p>Update docs inline with each phase:</p>
<ul>
<li>CLAUDE.md architecture section</li>
<li>Architecture diagrams</li>
<li>API documentation</li>
<li>**Benefit**: Future-you will thank you</li>
</ul>

<p>---</p>

<h2>ALTERNATIVE PLAN: 10-Phase Incremental Migration</h2>

<h3>PHASE 0: Schema Validation & Preparation (0.5 days)</h3>
<p><strong>Goal</strong>: Ensure database schema is ready for merged repository</p>

<p><strong>Tasks</strong>:</p>
<ul>
<li>[ ] Compare DefinitieRecord vs Definition fields</li>
<li>[ ] Identify any missing columns in `definities` table</li>
<li>[ ] Run ALTER TABLE migrations if needed</li>
<li>[ ] Add database indexes for performance (if missing)</li>
<li>[ ] **TEST**: Smoke test that schema changes don't break existing code</li>
</ul>

<p><strong>Deliverable</strong>: Schema migration script (if needed), schema verification test</p>

<p><strong>Risk</strong>: LOW (read-only analysis + backwards-compatible schema changes)</p>

<p><strong>Rollback</strong>: N/A (schema changes are additive, not destructive)</p>

<p>---</p>

<h3>PHASE 1: Feature Flag Infrastructure (0.5 days)</h3>
<p><strong>Goal</strong>: Add safety mechanism for instant rollback</p>

<p><strong>Tasks</strong>:</p>
<ul>
<li>[ ] Add `USE_LEGACY_REPO` environment variable support</li>
<li>[ ] Update ServiceContainer to respect flag</li>
<li>[ ] Document flag in CLAUDE.md and .env.example</li>
<li>[ ] **TEST**: Verify flag toggles between repositories correctly</li>
</ul>

<p><strong>Code Change</strong> (~50 lines):</p>
<pre><code># src/services/container.py
def _create_definition_repository(self) -&gt; DefinitionRepositoryInterface:
    if os.getenv("USE_LEGACY_REPO", "false") == "true":
        # Fallback to legacy wrapper
        from services.definition_repository import DefinitionRepository
        return DefinitionRepository(self.db_path)
    else:
        # Use merged repository (default)
        from database.definitie_repository import DefinitieRepositoryV2
        return DefinitieRepositoryV2(self.db_path)</code></pre>

<p><strong>Risk</strong>: LOW (additive change, doesn't modify existing code)</p>

<p><strong>Rollback</strong>: Set <code>USE_LEGACY_REPO=true</code> in environment</p>

<p>---</p>

<h3>PHASE 2: Core CRUD Tests (Test-First) (1 day)</h3>
<p><strong>Goal</strong>: Write comprehensive tests BEFORE merging methods</p>

<p><strong>Tasks</strong>:</p>
<ul>
<li>[ ] Write tests for `save()` (create + update paths)</li>
<li>[ ] Write tests for `get()` and `search()`</li>
<li>[ ] Write tests for `delete()` and `hard_delete()`</li>
<li>[ ] Write tests for `find_by_begrip()`</li>
<li>[ ] Write tests for `get_by_status()`</li>
<li>[ ] **Ensure tests FAIL** with current implementation</li>
<li>[ ] Document expected behavior in test docstrings</li>
</ul>

<p><strong>Deliverable</strong>: <code>tests/database/test_definitie_repository_v2_crud.py</code> (~300 lines)</p>

<p><strong>Risk</strong>: NONE (tests only, no production code changes)</p>

<p><strong>Rollback</strong>: N/A (tests can be deleted if needed)</p>

<p>---</p>

<h3>PHASE 3a: Merge Core CRUD Methods (1 day)</h3>
<p><strong>Goal</strong>: Migrate basic persistence operations to legacy repository</p>

<p><strong>Methods to Migrate</strong> (~226 lines total):</p>
<ul>
<li>‚úÖ `save()` ‚Üí Already exists as `create_definitie()` + `update_definitie()`</li>
<li>‚úÖ `get()` ‚Üí Already exists as `get_definitie()`</li>
<li>‚úÖ `search()` ‚Üí Already exists as `search_definities()`</li>
<li>‚úÖ `delete()` ‚Üí Map to `change_status(ARCHIVED)`</li>
<li>‚úÖ `hard_delete()` ‚Üí New method in legacy repo</li>
<li>‚úÖ `find_by_begrip()` ‚Üí Already exists as `find_definitie()`</li>
</ul>

<p><strong>Tasks</strong>:</p>
<ul>
<li>[ ] Copy missing methods to `definitie_repository.py`</li>
<li>[ ] Add type conversion helpers (`_definition_to_record`, `_record_to_definition`)</li>
<li>[ ] Update callsites in ServiceContainer only (1 file)</li>
<li>[ ] Run Phase 2 tests ‚Üí Should PASS</li>
<li>[ ] Run full test suite ‚Üí Should PASS</li>
</ul>

<p><strong>Risk</strong>: LOW (well-tested CRUD, small scope)</p>

<p><strong>Rollback</strong>: Set <code>USE_LEGACY_REPO=true</code></p>

<p>---</p>

<h3>PHASE 3b: Migrate Duplicate Detection (1 day)</h3>
<p><strong>Goal</strong>: Move duplicate finding logic to legacy repository</p>

<p><strong>Methods to Migrate</strong> (~112 lines):</p>
<ul>
<li>‚úÖ `find_duplicates()` ‚Üí Already exists in legacy repo</li>
<li>‚úÖ `set_duplicate_service()` ‚Üí Dependency injection for DuplicateDetectionService</li>
</ul>

<p><strong>Tasks</strong>:</p>
<ul>
<li>[ ] Write tests for duplicate detection FIRST</li>
<li>[ ] Update `find_duplicates()` to use injected service (if available)</li>
<li>[ ] Update callsites in validation services (3 files)</li>
<li>[ ] Verify duplicate detection still works end-to-end</li>
</ul>

<p><strong>Risk</strong>: LOW (isolated functionality, existing tests)</p>

<p><strong>Rollback</strong>: Set <code>USE_LEGACY_REPO=true</code></p>

<p>---</p>

<h3>PHASE 3c: Migrate Status & Draft Management (1 day)</h3>
<p><strong>Goal</strong>: Move status management and draft creation</p>

<p><strong>Methods to Migrate</strong> (~185 lines):</p>
<ul>
<li>‚úÖ `get_by_status()` ‚Üí Already exists in legacy repo</li>
<li>‚úÖ `get_or_create_draft()` ‚Üí New method in legacy repo</li>
<li>‚úÖ `change_status()` ‚Üí Already exists in legacy repo</li>
</ul>

<p><strong>Tasks</strong>:</p>
<ul>
<li>[ ] Write tests for draft creation FIRST</li>
<li>[ ] Add `get_or_create_draft()` to legacy repo</li>
<li>[ ] Update callsites in UI tabs (5 files)</li>
<li>[ ] Verify draft workflow end-to-end</li>
</ul>

<p><strong>Risk</strong>: MEDIUM (complex business logic, affects UI)</p>

<p><strong>Rollback</strong>: Set <code>USE_LEGACY_REPO=true</code></p>

<p>---</p>

<h3>PHASE 4: Migrate Voorbeelden (Examples) Management (1 day)</h3>
<p><strong>Goal</strong>: Move example management to legacy repository</p>

<p><strong>Methods to Migrate</strong> (~150 lines):</p>
<ul>
<li>‚úÖ `save_voorbeelden()` ‚Üí Already exists in legacy repo (1,453-1,680)</li>
<li>‚úÖ `get_voorbeelden()` ‚Üí Already exists in legacy repo (1,680-1,759)</li>
<li>‚úÖ `get_voorbeelden_by_type()` ‚Üí Already exists in legacy repo (1,759-1,779)</li>
</ul>

<p><strong>Tasks</strong>:</p>
<ul>
<li>[ ] Write tests for voorbeelden CRUD FIRST</li>
<li>[ ] Verify synonym sync logic (`_sync_synonyms_to_registry`)</li>
<li>[ ] Update callsites in UI helpers (2 files)</li>
<li>[ ] Test example editing workflow end-to-end</li>
</ul>

<p><strong>Risk</strong>: MEDIUM (complex synonym sync logic)</p>

<p><strong>Rollback</strong>: Set <code>USE_LEGACY_REPO=true</code></p>

<p>---</p>

<h3>PHASE 5: Eliminate Type Conversions (1 day)</h3>
<p><strong>Goal</strong>: Remove conversion layer between Definition ‚Üî DefinitieRecord</p>

<p><strong>Tasks</strong>:</p>
<ul>
<li>[ ] Identify all callsites using Definition interface (23 files)</li>
<li>[ ] Update callsites to use DefinitieRecord directly</li>
<li>[ ] Remove `_definition_to_record()` and `_record_to_definition()` helpers</li>
<li>[ ] Update DefinitionRepositoryInterface to use DefinitieRecord</li>
<li>[ ] Run full test suite</li>
</ul>

<p><strong>Risk</strong>: HIGH (touches 23 files, affects entire codebase)</p>

<p><strong>Rollback</strong>: Set <code>USE_LEGACY_REPO=true</code>, revert interface changes</p>

<p><strong>ALTERNATIVE</strong>: Keep conversions if they provide value (don't dogmatically eliminate)</p>

<p>---</p>

<h3>PHASE 6a: Update Callsites - Batch 1 (UI Tabs) (0.5 days)</h3>
<p><strong>Goal</strong>: Migrate 5 UI tab files to use merged repository</p>

<p><strong>Files</strong> (5 files):</p>
<ul>
<li>`src/ui/components/definition_generator_tab.py`</li>
<li>`src/ui/components/definition_edit_tab.py`</li>
<li>`src/ui/components/expert_review_tab.py`</li>
<li>`src/ui/components/tabs/import_export_beheer/orchestrator.py`</li>
<li>`src/ui/components/tabs/import_export_beheer/database_manager.py`</li>
</ul>

<p><strong>Tasks</strong>:</p>
<ul>
<li>[ ] Update imports to use `definitie_repository`</li>
<li>[ ] Test each tab manually in Streamlit</li>
<li>[ ] Run UI smoke tests</li>
<li>[ ] Verify no regressions</li>
</ul>

<p><strong>Risk</strong>: LOW (UI-only changes, easy to test manually)</p>

<p><strong>Rollback</strong>: Set <code>USE_LEGACY_REPO=true</code></p>

<p>---</p>

<h3>PHASE 6b: Update Callsites - Batch 2 (Services) (0.5 days)</h3>
<p><strong>Goal</strong>: Migrate 8 service files to use merged repository</p>

<p><strong>Files</strong> (8 files):</p>
<ul>
<li>`src/services/orchestrators/definition_orchestrator_v2.py`</li>
<li>`src/services/export_service.py`</li>
<li>`src/services/definition_import_service.py`</li>
<li>`src/services/data_aggregation_service.py`</li>
<li>`src/services/definition_edit_repository.py`</li>
<li>`src/services/workflow_service.py`</li>
<li>`src/services/definition_workflow_service.py`</li>
<li>`src/services/category_service.py`</li>
</ul>

<p><strong>Risk</strong>: MEDIUM (core business logic, requires thorough testing)</p>

<p><strong>Rollback</strong>: Set <code>USE_LEGACY_REPO=true</code></p>

<p>---</p>

<h3>PHASE 6c: Update Callsites - Batch 3 (Tools & Utils) (0.5 days)</h3>
<p><strong>Goal</strong>: Migrate remaining files (tools, utils, validation rules)</p>

<p><strong>Files</strong> (~10 files):</p>
<ul>
<li>`src/tools/setup_database.py`</li>
<li>`src/tools/definitie_manager.py`</li>
<li>`src/integration/definitie_checker.py`</li>
<li>`src/toetsregels/validators/CON_01.py`</li>
<li>`src/toetsregels/regels/DUP_01.py`</li>
<li>`src/toetsregels/regels/CON-01.py`</li>
<li>`src/ui/helpers/examples.py`</li>
<li>`src/ui/services/definition_ui_service.py`</li>
<li>`src/utils/container_manager.py`</li>
</ul>

<p><strong>Risk</strong>: LOW (peripheral files, limited impact)</p>

<p><strong>Rollback</strong>: Set <code>USE_LEGACY_REPO=true</code></p>

<p>---</p>

<h3>PHASE 7: Delete Legacy Wrapper (0.5 days)</h3>
<p><strong>Goal</strong>: Remove <code>src/services/definition_repository.py</code></p>

<p><strong>Prerequisites</strong>:</p>
<ul>
<li>‚úÖ All 31 callsites migrated to legacy repository</li>
<li>‚úÖ All tests passing</li>
<li>‚úÖ Manual smoke tests completed</li>
<li>‚úÖ Feature flag set to `USE_LEGACY_REPO=false` for 2+ days without issues</li>
</ul>

<p><strong>Tasks</strong>:</p>
<ul>
<li>[ ] Verify 0 imports of `services.definition_repository`</li>
<li>[ ] Delete `src/services/definition_repository.py` (887 lines)</li>
<li>[ ] Remove feature flag infrastructure (Phase 1 code)</li>
<li>[ ] Update CLAUDE.md to document new architecture</li>
<li>[ ] Run full test suite + smoke tests</li>
</ul>

<p><strong>Risk</strong>: LOW (all callsites already migrated)</p>

<p><strong>Rollback</strong>: Git revert (feature flag already removed)</p>

<p>---</p>

<h3>PHASE 8: Code Quality Improvements (1 day)</h3>
<p><strong>Goal</strong>: Simplify merged repository after elimination</p>

<p><strong>Opportunities</strong> (from complexity analysis):</p>
<ol>
<li>**Extract SQL Query Builders**</li>
</ol>
<ul>
<li>  - `_build_insert_columns()` is complex (lines 350-419)</li>
<li>  - Extract into `database/sql_builder.py` module</li>
</ul>

<ol>
<li>**Consolidate Error Handling**</li>
</ol>
<ul>
<li>  - Duplicate error handling in `create_definitie()` and `update_definitie()`</li>
<li>  - Extract into `_handle_db_error()` helper</li>
</ul>

<ol>
<li>**Simplify Type Signatures**</li>
</ol>
<ul>
<li>  - Remove `| None` from return types where possible</li>
<li>  - Use `Optional[]` consistently</li>
</ul>

<ol>
<li>**Extract Validation Logic**</li>
</ol>
<ul>
<li>  - `_calculate_similarity()` belongs in validation service, not repository</li>
<li>  - Move to `services/duplicate_detection_service.py`</li>
</ul>

<p><strong>Tasks</strong>:</p>
<ul>
<li>[ ] Apply DRY principle to error handling</li>
<li>[ ] Extract SQL builders</li>
<li>[ ] Move validation logic to services</li>
<li>[ ] Simplify type signatures</li>
<li>[ ] Add docstrings for complex methods</li>
</ul>

<p><strong>Risk</strong>: LOW (refactoring only, behavior unchanged)</p>

<p><strong>Rollback</strong>: Git revert</p>

<p>---</p>

<h3>PHASE 9: Documentation & Migration Guide (0.5 days)</h3>
<p><strong>Goal</strong>: Update all documentation to reflect new architecture</p>

<p><strong>Tasks</strong>:</p>
<ul>
<li>[ ] Update `CLAUDE.md` - Remove dual repository references</li>
<li>[ ] Update `docs/architectuur/ENTERPRISE_ARCHITECTURE.md`</li>
<li>[ ] Update `docs/architectuur/SOLUTION_ARCHITECTURE.md`</li>
<li>[ ] Update `docs/architectuur/TECHNICAL_ARCHITECTURE.md`</li>
<li>[ ] Create `docs/guides/REPOSITORY_MIGRATION_GUIDE.md` for future developers</li>
<li>[ ] Update API documentation (if exists)</li>
<li>[ ] Archive this plan in `docs/archief/refactors/DEF-54/`</li>
</ul>

<p><strong>Risk</strong>: NONE (documentation only)</p>

<p><strong>Rollback</strong>: N/A</p>

<p>---</p>

<h2>Complexity Hotspot Analysis</h2>

<h3>üî¥ HIGH COMPLEXITY (Refactor BEFORE merging)</h3>

<p><strong>1. <code>save_voorbeelden()</code> (226 lines, 1453-1680)</strong></p>
<ul>
<li>**Problem**: God method, too many responsibilities</li>
<li>**Complexity**: Handles insert, update, duplicate checks, synonym sync</li>
<li>**Recommendation**:</li>
<li> - Extract `_sync_synonyms_to_registry()` FIRST (Phase 4 prerequisite)</li>
<li> - Extract `_validate_voorbeeld_data()` helper</li>
<li> - Extract `_insert_voorbeeld()` and `_update_voorbeeld()` helpers</li>
<li>**Benefit**: Easier to test, easier to debug</li>
</ul>

<p><strong>2. <code>_sync_synonyms_to_registry()</code> (185 lines, implied)</strong></p>
<ul>
<li>**Problem**: Complex business logic buried in repository</li>
<li>**Complexity**: Bidirectional sync, conflict resolution</li>
<li>**Recommendation**:</li>
<li> - Move to `services/synonym_service.py` (belongs in business layer)</li>
<li> - Repository should just call `synonym_service.sync()`</li>
<li>**Benefit**: Separation of concerns, testable in isolation</li>
</ul>

<p><strong>3. Type Conversion Logic (186 lines total)</strong></p>
<ul>
<li>**Problem**: Adapter pattern adds indirection</li>
<li>**Complexity**: `_definition_to_record()`, `_record_to_definition()`, `_definition_to_updates()`</li>
<li>**Recommendation**:</li>
<li> - **Keep conversions** if they provide value (domain model vs data model)</li>
<li> - **Delete conversions** if DefinitieRecord can serve as domain model</li>
<li> - **Decision point**: Phase 5 - measure cognitive load before deciding</li>
<li>**Benefit**: Simpler if removed, but may lose domain model benefits</li>
</ul>

<p>---</p>

<h2>Safety Enhancements</h2>

<h3>1. Feature Flag (Phase 1)</h3>
<pre><code># Instant rollback without git
export USE_LEGACY_REPO=true
streamlit run src/main.py</code></pre>

<h3>2. Schema Decoupling (Phase 0)</h3>
<ul>
<li>Schema changes FIRST (separate PR)</li>
<li>Code changes can't break if schema is ready</li>
</ul>

<h3>3. Test-First Approach (Phase 2)</h3>
<ul>
<li>Write tests BEFORE merging methods</li>
<li>Tests fail ‚Üí implement ‚Üí tests pass</li>
<li>Old tests still pass (regression safety)</li>
</ul>

<h3>4. Batch Callsite Updates (Phases 6a-6c)</h3>
<ul>
<li>3-5 files per batch, not 23 at once</li>
<li>Easier debugging if issues occur</li>
<li>Each batch is committable</li>
</ul>

<h3>5. Manual Verification Beyond Tests</h3>
<p>After each phase:</p>
<ul>
<li>[ ] Run app manually</li>
<li>[ ] Test full user workflow (generate ‚Üí validate ‚Üí export)</li>
<li>[ ] Load test with 100 definitions (if applicable)</li>
<li>[ ] Smoke test all UI tabs</li>
</ul>

<p>---</p>

<h2>Quick Wins (Code Quality)</h2>

<p><strong>Can be simplified DURING merge:</strong></p>

<h3>1. Remove Duplicate Error Handling</h3>
<p><strong>Before</strong> (duplicated in <code>create_definitie</code> and <code>update_definitie</code>):</p>
<pre><code>except sqlite3.IntegrityError as e:
    if "UNIQUE constraint" in str(e):
        raise ValueError(f"Definitie '{begrip}' bestaat al")
    # ... more error handling</code></pre>

<p><strong>After</strong> (extracted to helper):</p>
<pre><code>def _handle_db_error(self, e: Exception, begrip: str, operation: str):
    """Centralized error handling for database operations."""
    if isinstance(e, sqlite3.IntegrityError):
        if "UNIQUE constraint" in str(e):
            raise ValueError(f"Definitie '{begrip}' bestaat al")
        # ... more error handling</code></pre>

<h3>2. Extract SQL Query Builders</h3>
<p><strong>Before</strong> (inline SQL in methods):</p>
<pre><code>cursor.execute("""
    INSERT INTO definities (begrip, definitie, categorie, ...)
    VALUES (?, ?, ?, ...)
""", (record.begrip, record.definitie, ...))</code></pre>

<p><strong>After</strong> (extracted to builder):</p>
<pre><code>from database.sql_builder import build_insert_query
query, params = build_insert_query("definities", record)
cursor.execute(query, params)</code></pre>

<h3>3. Consolidate Validation Logic</h3>
<p><strong>Before</strong> (in repository):</p>
<pre><code>def _calculate_similarity(self, str1: str, str2: str) -&gt; float:
    """Calculate Levenshtein similarity"""
    # ... complex logic</code></pre>

<p><strong>After</strong> (moved to service):</p>
<pre><code>from services.duplicate_detection_service import calculate_similarity
similarity = calculate_similarity(str1, str2)</code></pre>

<p>---</p>

<h2>Verification Beyond Tests</h2>

<h3>Manual Smoke Tests (After Each Phase)</h3>
<ol>
<li>**Generate Definition**</li>
</ol>
<ul>
<li>  - Input: "Burger"</li>
<li>  - Verify: Definition generated, validation runs, save to DB works</li>
</ul>

<ol>
<li>**Edit Definition**</li>
</ol>
<ul>
<li>  - Load existing definition</li>
<li>  - Edit definitie text</li>
<li>  - Verify: Update persists, history tracked</li>
</ul>

<ol>
<li>**Export Definitions**</li>
</ol>
<ul>
<li>  - Select 10 definitions</li>
<li>  - Export to CSV, Excel, Markdown</li>
<li>  - Verify: Files created, data correct</li>
</ul>

<ol>
<li>**Import Definitions**</li>
</ol>
<ul>
<li>  - Import sample CSV</li>
<li>  - Verify: Duplicates detected, data imported correctly</li>
</ul>

<ol>
<li>**Full Workflow**</li>
</ol>
<ul>
<li>  - Generate ‚Üí Validate ‚Üí Edit ‚Üí Export ‚Üí Import</li>
<li>  - Verify: No errors, data persists correctly</li>
</ul>

<h3>Load Testing (Phase 7)</h3>
<ul>
<li>Create 100 test definitions</li>
<li>Measure save time (should be <5s total)</li>
<li>Measure search time (should be <200ms)</li>
<li>Verify no memory leaks (check `st.session_state` size)</li>
</ul>

<p>---</p>

<h2>Risk Assessment Per Phase</h2>

<p>| Phase | Risk | Lines Changed | Files Changed | Rollback Ease | Blast Radius |</p>
<p>|-------|------|---------------|---------------|---------------|--------------|</p>
<p>| 0: Schema | LOW | ~50 | 1 | Easy (additive) | Minimal |</p>
<p>| 1: Feature Flag | LOW | ~50 | 2 | Instant (env var) | Minimal |</p>
<p>| 2: Tests | NONE | ~300 | 1 | N/A | None |</p>
<p>| 3a: CRUD | LOW | ~226 | 2 | Instant (flag) | Small |</p>
<p>| 3b: Duplicates | LOW | ~112 | 4 | Instant (flag) | Small |</p>
<p>| 3c: Status | MEDIUM | ~185 | 6 | Instant (flag) | Medium |</p>
<p>| 4: Voorbeelden | MEDIUM | ~150 | 3 | Instant (flag) | Medium |</p>
<p>| 5: Conversions | HIGH | ~186 | 23 | Hard (revert) | Large |</p>
<p>| 6a: UI Tabs | LOW | ~50 | 5 | Instant (flag) | Small |</p>
<p>| 6b: Services | MEDIUM | ~80 | 8 | Instant (flag) | Medium |</p>
<p>| 6c: Utils | LOW | ~40 | 10 | Instant (flag) | Small |</p>
<p>| 7: Delete Legacy | LOW | -887 | 1 | Easy (git) | Minimal |</p>
<p>| 8: Code Quality | LOW | ~100 | 3 | Easy (git) | Minimal |</p>
<p>| 9: Docs | NONE | ~200 | 5 | N/A | None |</p>

<p><strong>Total Timeline</strong>: 7-10 phases, 6-8 days (vs original 5 phases, 5 days)</p>
<p><strong>Total Risk</strong>: MEDIUM (vs original MEDIUM, but with more safety mechanisms)</p>

<p>---</p>

<h2>Success Metrics</h2>

<h3>Functional Metrics</h3>
<ul>
<li>‚úÖ All 31 callsites migrated to legacy repository</li>
<li>‚úÖ All existing tests passing (100% pass rate)</li>
<li>‚úÖ No regressions in manual smoke tests</li>
<li>‚úÖ Legacy wrapper deleted (887 lines removed)</li>
<li>‚úÖ Code quality improved (DRY, separation of concerns)</li>
</ul>

<h3>Quality Metrics</h3>
<ul>
<li>‚úÖ Test coverage maintained or improved (>80% for repository)</li>
<li>‚úÖ Cyclomatic complexity reduced (target: <10 per method)</li>
<li>‚úÖ Documentation updated (CLAUDE.md + architecture docs)</li>
<li>‚úÖ No new TODO/FIXME comments introduced</li>
</ul>

<h3>Performance Metrics</h3>
<ul>
<li>‚úÖ Save time <5s (unchanged from before)</li>
<li>‚úÖ Search time <200ms (unchanged from before)</li>
<li>‚úÖ Memory usage stable (no leaks in `st.session_state`)</li>
</ul>

<p>---</p>

<h2>Decision Points</h2>

<h3>Should We Keep Type Conversions? (Phase 5)</h3>

<p><strong>Arguments FOR keeping</strong>:</p>
<ul>
<li>Separation of domain model (Definition) from data model (DefinitieRecord)</li>
<li>Business logic works with clean Definition interface</li>
<li>Repository can evolve schema without affecting services</li>
</ul>

<p><strong>Arguments AGAINST keeping</strong>:</p>
<ul>
<li>Adds indirection (186 lines of conversion code)</li>
<li>Performance overhead (serialization/deserialization)</li>
<li>Cognitive load (two models to understand)</li>
</ul>

<p><strong>Recommendation</strong>:</p>
<ul>
<li>**Measure first**: Track how often services need Definition vs DefinitieRecord</li>
<li>**Decide later**: Phase 5 is optional, can skip if conversions provide value</li>
<li>**Pragmatic approach**: Keep if used >10 places, delete if <5 places</li>
</ul>

<p>---</p>

<h2>Lessons Learned (Post-Completion)</h2>

<p><em>(To be filled after completion)</em></p>

<h3>What Went Well</h3>
<ul>
<li>[ ] Feature flag saved us from rollback</li>
<li>[ ] Test-first approach caught bugs early</li>
<li>[ ] Incremental phases easier to debug</li>
</ul>

<h3>What Went Wrong</h3>
<ul>
<li>[ ] Phase X took longer than expected because...</li>
<li>[ ] Missed edge case in Phase Y...</li>
</ul>

<h3>Improvements for Next Time</h3>
<ul>
<li>[ ] Better estimation for complex phases</li>
<li>[ ] More manual testing before commit</li>
</ul>

<p>---</p>

<h2>Appendix A: Original 5-Phase Plan Comparison</h2>

<p>| Aspect | Original Plan | Simplified Plan | Winner |</p>
<p>|--------|---------------|-----------------|--------|</p>
<p>| <strong>Phase Count</strong> | 5 phases | 10 phases | Simplified (more granular) |</p>
<p>| <strong>Largest Change</strong> | 500+ lines | ~226 lines | Simplified (56% smaller) |</p>
<p>| <strong>Rollback</strong> | Git only | Feature flag + git | Simplified (instant) |</p>
<p>| <strong>Testing</strong> | After merge | Test-first | Simplified (confidence) |</p>
<p>| <strong>Schema</strong> | Mixed | Separate phase | Simplified (decoupled) |</p>
<p>| <strong>Timeline</strong> | 5 days | 6-8 days | Original (faster) |</p>
<p>| <strong>Risk</strong> | MEDIUM | MEDIUM (with safeguards) | Simplified (safer) |</p>

<p><strong>Verdict</strong>: Simplified plan trades 1-3 extra days for significantly more safety and rollback ease.</p>

<p>---</p>

<h2>Appendix B: Callsite Inventory</h2>

<p><strong>Total</strong>: 31 files importing repository</p>

<h3>UI Layer (10 files)</h3>
<ul>
<li>`src/ui/tabbed_interface.py`</li>
<li>`src/ui/components/tabs/import_export_beheer/orchestrator.py`</li>
<li>`src/ui/components/tabs/import_export_beheer/format_exporter.py`</li>
<li>`src/ui/components/tabs/import_export_beheer/database_manager.py`</li>
<li>`src/ui/components/tabs/import_export_beheer/csv_importer.py`</li>
<li>`src/ui/components/tabs/import_export_beheer/bulk_operations.py`</li>
<li>`src/ui/components/expert_review_tab.py`</li>
<li>`src/ui/components/definition_generator_tab.py`</li>
<li>`src/ui/components/definition_edit_tab.py`</li>
<li>`src/ui/helpers/examples.py`</li>
</ul>

<h3>Service Layer (12 files)</h3>
<ul>
<li>`src/services/orchestrators/definition_orchestrator_v2.py`</li>
<li>`src/services/definition_repository.py` (wrapper to delete)</li>
<li>`src/services/export_service.py`</li>
<li>`src/services/definition_import_service.py`</li>
<li>`src/services/container.py`</li>
<li>`src/services/data_aggregation_service.py`</li>
<li>`src/services/definition_edit_repository.py`</li>
<li>`src/services/workflow_service.py`</li>
<li>`src/services/definition_workflow_service.py`</li>
<li>`src/services/category_service.py`</li>
<li>`src/services/null_repository.py`</li>
<li>`src/ui/services/definition_ui_service.py`</li>
</ul>

<h3>Data Layer (1 file)</h3>
<ul>
<li>`src/database/definitie_repository.py` (target for merge)</li>
</ul>

<h3>Tools & Utils (4 files)</h3>
<ul>
<li>`src/tools/setup_database.py`</li>
<li>`src/tools/definitie_manager.py`</li>
<li>`src/integration/definitie_checker.py`</li>
<li>`src/utils/container_manager.py`</li>
</ul>

<h3>Validation Rules (4 files)</h3>
<ul>
<li>`src/toetsregels/validators/CON_01.py`</li>
<li>`src/toetsregels/regels/DUP_01.py`</li>
<li>`src/toetsregels/regels/CON-01.py`</li>
<li>`src/services/interfaces.py`</li>
</ul>

<p>---</p>

<h2>Appendix C: Code Complexity Metrics</h2>

<h3>Before Merge</h3>

<p><strong>Legacy Repository</strong> (<code>src/database/definitie_repository.py</code>):</p>
<ul>
<li>Lines: 2,100</li>
<li>Methods: 40+</li>
<li>Cyclomatic Complexity: High (some methods >15)</li>
<li>Test Coverage: ~85%</li>
</ul>

<p><strong>Service Wrapper</strong> (<code>src/services/definition_repository.py</code>):</p>
<ul>
<li>Lines: 887</li>
<li>Methods: 25</li>
<li>Cyclomatic Complexity: Medium (mostly <10)</li>
<li>Test Coverage: ~90%</li>
</ul>

<p><strong>Total</strong>: 2,987 lines (with duplication)</p>

<h3>After Merge (Target)</h3>

<p><strong>Merged Repository</strong> (<code>src/database/definitie_repository.py</code>):</p>
<ul>
<li>Lines: ~2,200 (2,100 + 100 new methods - 100 duplicates)</li>
<li>Methods: 45+</li>
<li>Cyclomatic Complexity: Medium (target <10 per method after Phase 8)</li>
<li>Test Coverage: >85%</li>
</ul>

<p><strong>Reduction</strong>: -787 lines (26% reduction from 2,987 to 2,200)</p>

<p>---</p>

<h2>Appendix D: Testing Strategy</h2>

<h3>Unit Tests (Per Phase)</h3>

<p><strong>Phase 2: Core CRUD Tests</strong></p>
<pre><code># tests/database/test_definitie_repository_v2_crud.py

def test_save_create_new_definition():
    """Test creating a new definition."""
    repo = DefinitieRepositoryV2()
    definition = Definition(begrip="Test", definitie="Test def")

    definition_id = repo.save(definition)

    assert definition_id &gt; 0
    saved = repo.get(definition_id)
    assert saved.begrip == "Test"

def test_save_update_existing_definition():
    """Test updating an existing definition."""
    # ... similar pattern</code></pre>

<h3>Integration Tests (After Each Phase)</h3>

<p><strong>End-to-End Workflow Test</strong></p>
<pre><code>def test_full_definition_workflow():
    """Test complete workflow: create ‚Üí edit ‚Üí validate ‚Üí export."""
    # 1. Create
    definition = create_definition("Burger")

    # 2. Edit
    definition.definitie = "Updated definition"
    update_definition(definition)

    # 3. Validate
    results = validate_definition(definition)
    assert results.is_valid

    # 4. Export
    exported = export_to_csv([definition])
    assert len(exported) &gt; 0</code></pre>

<h3>Manual Smoke Tests (Checklist)</h3>

<p>After each phase, execute:</p>
<ul>
<li>[ ] Start app: `streamlit run src/main.py`</li>
<li>[ ] Generate definition for "Burger"</li>
<li>[ ] Edit definition text</li>
<li>[ ] Run validation</li>
<li>[ ] Export to CSV</li>
<li>[ ] Import CSV back</li>
<li>[ ] Check no errors in console</li>
</ul>

<p>---</p>

<h2>Appendix E: Rollback Procedures</h2>

<h3>Immediate Rollback (Feature Flag)</h3>
<pre><code># Set environment variable
export USE_LEGACY_REPO=true

# Restart Streamlit
streamlit run src/main.py</code></pre>
<p><strong>Time</strong>: <30 seconds</p>
<p><strong>Risk</strong>: None</p>
<p><strong>Use When</strong>: Phase 1-6c, immediate issues detected</p>

<h3>Git Rollback (Revert Commit)</h3>
<pre><code># Find commit to revert
git log --oneline -n 10

# Revert specific commit
git revert &lt;commit-hash&gt;

# Or reset to previous state
git reset --hard HEAD~1</code></pre>
<p><strong>Time</strong>: <2 minutes</p>
<p><strong>Risk</strong>: Low (if no conflicts)</p>
<p><strong>Use When</strong>: Phase 7-9, after feature flag removed</p>

<h3>Database Rollback (Schema Changes)</h3>
<pre><code># Restore from backup (if schema changed)
cp data/definities.db.backup data/definities.db

# Or run migration rollback script
python src/database/migrate_database.py --rollback</code></pre>
<p><strong>Time</strong>: <1 minute</p>
<p><strong>Risk</strong>: Medium (data loss if no backup)</p>
<p><strong>Use When</strong>: Phase 0, schema changes cause issues</p>

<p>---</p>

<h2>Sign-Off</h2>

<p><strong>Prepared By</strong>: Code Simplifier (Claude)</p>
<p><strong>Date</strong>: 2025-10-29</p>
<p><strong>Review Status</strong>: PENDING</p>
<p><strong>Approved By</strong>: _(Solo developer - self-approve after review)_</p>

<p><strong>Next Steps</strong>:</p>
<ol>
<li>Review this simplified plan</li>
<li>Compare with original 5-phase plan</li>
<li>Decide which approach to use</li>
<li>Create feature branch: `feature/DEF-54-simplified`</li>
<li>Start with Phase 0 (Schema Validation)</li>
</ol>

<p>---</p>

<p><strong>END OF SIMPLIFIED REFACTOR PLAN</strong></p>

  </div>
</body>
</html>