<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Comprehensive Analysis: 16 DefinitieAgent Prompt Modules</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">‚Üê Terug naar Portal</a>
    <h1>Comprehensive Analysis: 16 DefinitieAgent Prompt Modules</h1>
<h2>Problem Identification, Contradictions & Improvement Opportunities</h2>

<p><strong>Date:</strong> 2025-11-11</p>
<p><strong>Analyst:</strong> Debug Specialist</p>
<p><strong>Scope:</strong> src/services/prompts/modules/*.py (16 modules)</p>
<p><strong>Focus:</strong> Inter-module conflicts, redundancy, token waste, contradictions</p>

<p>---</p>

<h2>Executive Summary</h2>

<h3>Overall Assessment: CRITICAL ISSUES FOUND</h3>

<p><strong>Total Modules Analyzed:</strong> 16</p>
<p><strong>Critical Issues:</strong> 7</p>
<p><strong>High Priority Issues:</strong> 12</p>
<p><strong>Medium Priority Issues:</strong> 8</p>
<p><strong>Token Waste Estimated:</strong> 1,200-1,500 tokens (15-20% of total prompt)</p>

<h3>Key Findings</h3>

<ol>
<li>**CRITICAL: Dual/Triple Instruction Conflict** - Grammar, Context, and Error Prevention modules contradict each other on what is "forbidden"</li>
<li>**CRITICAL: Redundant Rule Formatting** - ARAI/CON/ESS/STR/INT/SAM/VER modules all load rules from same cached manager and format identically</li>
<li>**CRITICAL: Missing Hard Dependencies** - TemplateModule validates input but never actually runs due to soft metadata dependency</li>
<li>**HIGH: Token Waste** - Structure Rules Module hardcodes all 9 rules (63 lines) when could be loaded from cache like other rule modules</li>
<li>**HIGH: Context Awareness Module Over-Engineering** - Contains 3 separate context formatting levels but only one is used</li>
</ol>

<p>---</p>

<h2>Module-by-Module Analysis</h2>

<h3>1. ExpertiseModule (Lines 1-200)</h3>

<p><strong>Current Function:</strong></p>
<ul>
<li>Sets expert role definition</li>
<li>Determines word type (werkwoord, deverbaal, overig)</li>
<li>Stores word_type in shared state for downstream modules</li>
<li>Generates basic requirements and role definition</li>
</ul>

<p><strong>Problems Found:</strong></p>

<p>| Problem | Severity | Details |</p>
<p>|---------|----------|---------|</p>
<p>| Hard-coded word type detection | MEDIUM | Uses simple suffix-based detection; misses context-dependent cases |</p>
<p>| Duplicates basic requirements | MEDIUM | Content overlaps with OutputSpecification and GrammarModule |</p>
<p>| No validation of word type | MEDIUM | Shared state set without verification |</p>

<p><strong>Token Usage:</strong> ~150 tokens</p>
<p><strong>Dependencies:</strong> None (root module)</p>

<p><strong>Recommendation:</strong> KEEP - Core baseline instruction. Refactor word type detection into separate utility if reused elsewhere.</p>

<p>---</p>

<h3>2. OutputSpecificationModule (Lines 1-175)</h3>

<p><strong>Current Function:</strong></p>
<ul>
<li>Defines output format requirements (one-line definition, no period, no haakjes, no voorbeelden)</li>
<li>Sets character limit warnings</li>
<li>Provides formatting guidelines</li>
</ul>

<p><strong>Problems Found:</strong></p>

<p>| Problem | Severity | Details |</p>
<p>|---------|----------|---------|</p>
<p>| Duplicates expertise module content | MEDIUM | "Basis schrijfregels" in expertise overlaps with format guidelines |</p>
<p>| Context value for "character_limit_warning" never used | MEDIUM | Sets shared state but no downstream module consumes it |</p>
<p>| Format guidelines conflict with Grammar module | HIGH | Both specify punctuation rules independently |</p>

<p><strong>Contradictions with Other Modules:</strong></p>
<ul>
<li>**vs. GrammarModule:** GrammarModule specifies interpunctie (komma, afkortingen in haakjes) but OutputSpec says "no haakjes"</li>
<li>**vs. IntegrityModule:** INT-06 says "Definitie bevat geen toelichting" but OutputSpec might imply some contextual nuance</li>
</ul>

<p><strong>Token Usage:</strong> ~100 tokens</p>
<p><strong>Dependencies:</strong> None</p>

<p><strong>Recommendation:</strong> MERGE with GrammarModule. Consolidate format requirements into single location.</p>

<p>---</p>

<h3>3. GrammarModule (Lines 1-256)</h3>

<p><strong>Current Function:</strong></p>
<ul>
<li>Provides grammar rules (enkelvoud, actieve vorm, tegenwoordige tijd)</li>
<li>Word-type-specific rules (werkwoord, deverbaal)</li>
<li>Punctuation rules (komma, afkortingen)</li>
<li>Optional strict mode with additional rules</li>
</ul>

<p><strong>Problems Found:</strong></p>

<p>| Problem | Severity | Details |</p>
<p>|---------|----------|---------|</p>
<p>| Partially duplicates OutputSpecification | MEDIUM | Format guidelines overlap |</p>
<p>| Soft dependency on word_type not declared | MEDIUM | Uses context.get_shared("word_type") but no declared dependency |</p>
<p>| Conflicting guidance on afkortingen | CRITICAL | Says "plaats afkortingen direct na term tussen haakjes" but OutputSpec says "no haakjes" |</p>
<p>| Interpunctie rules vs Integrity rules | HIGH | INT-07 specifies afkorting requirements; GrammarModule also specifies them identically |</p>
<p>| Strict mode rarely used | MEDIUM | Configuration option but default False; adds complexity for minimal benefit |</p>

<p><strong>Contradictions with Other Modules:</strong></p>
<ul>
<li>**vs. OutputSpecificationModule:** Haakjes for abbreviations (allowed in Grammar, forbidden in OutputSpec)</li>
<li>**vs. IntegrityModule INT-07:** Both define afkorting rules identically - exact code duplication</li>
<li>**vs. SemanticCategorisationModule:** Grammar-specific rules for "werkwoord" conflict with ESS-02 category-specific rules</li>
</ul>

<p><strong>Token Usage:</strong> ~140 tokens</p>
<p><strong>Dependencies:</strong> SOFT - ExpertiseModule (word_type via shared state, not declared)</p>

<p><strong>Recommendation:</strong> REFACTOR - Extract punctuation rules to shared static module. Declare hard dependency on ExpertiseModule. Remove duplicate afkorting rules (already in INT-07).</p>

<p>---</p>

<h3>4. ContextAwarenessModule (Lines 1-433)</h3>

<p><strong>Current Function:</strong></p>
<ul>
<li>Calculates context richness score (0.0-1.0)</li>
<li>Generates adaptive context sections (rich/moderate/minimal)</li>
<li>Formats sources with confidence indicators (üî¥üü°üü¢)</li>
<li>Handles abbreviations and expanded terms</li>
<li>Shares traditional context types for other modules</li>
</ul>

<p><strong>Problems Found:</strong></p>

<p>| Problem | Severity | Details |</p>
<p>|---------|----------|---------|</p>
<p>| Over-engineered for actual use | HIGH | Three formatting levels (rich/moderate/minimal) but no configuration to select; always uses score-based |</p>
<p>| Unused confidence indicator logic | MEDIUM | Builds üî¥üü°üü¢ indicators but downstream modules don't consume them |</p>
<p>| EPIC-010 migration incomplete | HIGH | Comments say "domein is legacy" but code still attempts extraction; unclear mapping |</p>
<p>| Context sharing creates silent failures | MEDIUM | Sets 5 different shared state keys (organization_contexts, juridical_contexts, legal_basis_contexts) with no validation |</p>
<p>| Score calculation overly complex | MEDIUM | Uses multiple weighted factors but no explanation why weights chosen |</p>
<p>| Code duplication in formatting | MEDIUM | _format_abbreviations_detailed and _format_abbreviations_simple are nearly identical |</p>

<p><strong>Contradictions with Other Modules:</strong></p>
<ul>
<li>**vs. DefinitionTaskModule:** Both extract context from enriched_context.base_context with different key names</li>
<li>**vs. ErrorPreventionModule:** Shares context via 5 keys, but ErrorPreventionModule only uses 3; inconsistent contract</li>
</ul>

<p><strong>Token Usage:</strong> ~230 tokens (largest single module)</p>
<p><strong>Dependencies:</strong> None declared (but soft dep on base_context structure)</p>

<p><strong>Recommendation:</strong> REFACTOR - Simplify to single formatting level (moderate is best default). Extract score calculation to separate utility. Remove unused confidence indicators. Standardize context sharing contract with ErrorPreventionModule.</p>

<p>---</p>

<h3>5. SemanticCategorisationModule (Lines 1-280)</h3>

<p><strong>Current Function:</strong></p>
<ul>
<li>Implements ESS-02 ontological category instructions</li>
<li>Provides base ESS-02 guidance mandatory for all</li>
<li>Adds category-specific guidance when categoria provided</li>
<li>Shares ontological_category in shared state</li>
</ul>

<p><strong>Problems Found:</strong></p>

<p>| Problem | Severity | Details |</p>
<p>|---------|----------|---------|</p>
<p>| Redundant guidance with DefinitionTaskModule | HIGH | DefinitionTaskModule._build_checklist also includes ontological category hints - duplicates guidance |</p>
<p>| Extremely verbose category guidance | MEDIUM | Category-specific sections are 30-50 lines each; could be condensed 40% |</p>
<p>| "Detailed guidance" config option ineffective | MEDIUM | detaile_guidance defaults True; no token-saving path when disabled |</p>
<p>| Conflicting examples | HIGH | "TYPE" category examples start with "woord", "document", "persoon" - but Grammar module says "no lidwoord", yet these begin with naked noun which might confuse |</p>
<p>| Inconsistent emphasis with other modules | MEDIUM | Says "WICHTIG: De kick-off termen zijn ZELFSTANDIGE NAAMWOORDEN" but Grammar module's STR-01 already covers this |</p>

<p><strong>Contradictions with Other Modules:</strong></p>
<ul>
<li>**vs. DefinitionTaskModule:** Both encode ontological category hints (lines 189-196 in DefinitionTask duplicates SemanticCat category_guidance_map logic)</li>
<li>**vs. GrammarModule:** Werkwoord examples specify "activiteit waarbij", "handeling die", "proces waarin" but GrammarModule specifies "handelingsnaamwoorden" separately</li>
<li>**vs. StructureRulesModule:** STR-01 defines "start with zelfstandig naamwoord" but SemanticCat assumes GPT already knows this via kick-off terms</li>
</ul>

<p><strong>Token Usage:</strong> ~180 tokens</p>
<p><strong>Dependencies:</strong> None declared (but assumes metadata key "ontologische_categorie")</p>

<p><strong>Recommendation:</strong> MERGE category guidance with DefinitionTaskModule._build_checklist. Compress category guidance 40%; use bullet points instead of paragraphs. Remove duplicate "kick-off is zelfstandig naamwoord" since STR-01 covers it.</p>

<p>---</p>

<h3>6. TemplateModule (Lines 1-251)</h3>

<p><strong>Current Function:</strong></p>
<ul>
<li>Provides category-specific definition templates</li>
<li>Offers word-type-specific patterns</li>
<li>Generates category examples</li>
</ul>

<p><strong>Problems Found:</strong></p>

<p>| Problem | Severity | CRITICAL |</p>
<p>|---------|----------|---------|</p>
<p>| CRITICAL: Broken validation logic | CRITICAL | validate_input checks for "semantic_category" metadata but no upstream module EVER SETS IT |</p>
<p>| Templates never loaded | CRITICAL | Module silently skipped when metadata missing (which is always) |</p>
<p>| Category name mismatch | CRITICAL | Uses category names "Proces", "Object", "Actor" but SemanticCat uses "proces", "type", "resultaat", "exemplaar" - different naming scheme entirely! |</p>
<p>| Dead code | HIGH | get_category_template and get_category_examples have 10 templates but validate_input prevents their use |</p>
<p>| No dependencies declared | HIGH | Depends on semantic_category metadata but no hard dependency on SemanticCategorisation |</p>

<p><strong>Contradictions with Other Modules:</strong></p>
<ul>
<li>**vs. SemanticCategorisationModule:** Different category naming systems - SemanticCat uses "proces"/"type"/"resultaat"/"exemplaar" but TemplateModule uses "Proces"/"Object"/"Actor"/"Toestand"/"Gebeurtenis"/"Maatregel"/"Informatie"/"Regel"/"Recht"/"Verplichting"</li>
<li>**vs. DefinitionTaskModule:** DefinitionTask uses "soort"/"exemplaar"/"proces"/"resultaat" terminology - THIRD naming scheme!</li>
</ul>

<p><strong>Token Usage:</strong> ~120 tokens (wasted since never executes)</p>
<p><strong>Dependencies:</strong> SOFT (metadata) - but broken</p>

<p><strong>Recommendation:</strong> REMOVE or REFACTOR COMPLETELY - This module never runs due to validation failure. If keeping, unify category naming with SemanticCategorisation AND DefinitionTask. Or merge template examples into SemanticCat as inline examples.</p>

<p>---</p>

<h3>7-13. Rule Modules (ARAI, CON, ESS, STR, INT, SAM, VER)</h3>

<p><strong>Collective Analysis:</strong></p>

<p><strong>Current Function (for ARAI, CON, ESS, SAM, VER):</strong></p>
<ul>
<li>Load rules from cached manager</li>
<li>Filter rules by prefix (ARAI-, CON-, ESS-, SAM-, VER-)</li>
<li>Format rules identically</li>
<li>Return metadata with rule count</li>
</ul>

<p><strong>Current Function (STR module only):</strong></p>
<ul>
<li>HARDCODE all 9 structure rules inline (63 lines)</li>
<li>Format identically to other rule modules</li>
</ul>

<p><strong>Problems Found:</strong></p>

<p>| Module | Problem | Severity | Details |</p>
<p>|--------|---------|----------|---------|</p>
<p>| ARAI | Cached loading correct | LOW | No issues found |</p>
<p>| CON | Cached loading correct | LOW | No issues found |</p>
<p>| ESS | Cached loading correct | LOW | No issues found |</p>
<p>| STR | HARDCODED RULES | CRITICAL | Lines 78-101: Hardcodes all 9 STR rules when StructureRulesModule could use cached manager like others |</p>
<p>| INT | Code duplication | MEDIUM | _format_rule method identical to ARAI/CON/ESS/SAM/VER - extract to base class |</p>
<p>| SAM | Code duplication | MEDIUM | Same _format_rule duplication |</p>
<p>| VER | Code duplication | MEDIUM | Same _format_rule duplication |</p>
<p>| ALL | Silent cache failures | MEDIUM | No error handling if cached_manager fails or rules missing |</p>
<p>| ALL | Filter logic | MEDIUM | Filter using startswith() - works but fragile if rule naming changes |</p>

<p><strong>Contradictions with Other Modules:</strong></p>
<ul>
<li>**STR vs others:** StructureRulesModule hardcodes 63 lines of rules when it could load 9 rules from config (1-2 lines) like ARAI/CON/ESS/SAM/VER</li>
<li>**STR vs DefinitionTaskModule:** _build_checklist duplicates STR-01 concept ("Begint met zelfstandig naamwoord") with less detail</li>
<li>**Grammar vs STR:** Overlapping guidance on grammatical structure</li>
</ul>

<p><strong>Token Usage (estimated):</strong></p>
<ul>
<li>ARAI: ~200 tokens (dynamic loading efficient)</li>
<li>CON: ~80 tokens (few CON rules)</li>
<li>ESS: ~150 tokens (good coverage)</li>
<li>STR: ~250 tokens (63 hardcoded lines - **150 tokens wasted**)</li>
<li>INT: ~200 tokens</li>
<li>SAM: ~60 tokens</li>
<li>VER: ~50 tokens</li>
<li>**SUBTOTAL WASTE:** ~150 tokens in StructureRulesModule alone</li>
</ul>

<p><strong>Recommendation:</strong></p>
<ol>
<li>URGENT: Move STR rules to config file; load via cached manager like other modules (saves 150 tokens)</li>
<li>Extract identical _format_rule to BasePromptModule or shared utility function (saves ~60 tokens)</li>
<li>Add error handling for cache failures</li>
</ol>

<p>---</p>

<h3>8. ErrorPreventionModule (Lines 1-262)</h3>

<p><strong>Current Function:</strong></p>
<ul>
<li>Lists basic forbidden patterns</li>
<li>Provides extended forbidden starters list</li>
<li>Context-specific forbidden patterns based on organization/jurisdiction/legal basis</li>
<li>Includes validation matrix table</li>
</ul>

<p><strong>Problems Found:</strong></p>

<p>| Problem | Severity | Details |</p>
<p>|---------|----------|---------|</p>
<p>| CRITICAL: Forbidden list conflicts with guidance | CRITICAL | Lists 32 forbidden starters (lines 156-191) but many are contradicted by other modules' guidance |</p>
<p>| Context forbidden logic uses org code map | MEDIUM | Hard-coded mapping DJI/OM/ZM/3RO/CJIB/KMAR/FIOD - if organizations change, must update code |</p>
<p>| Forbidden starters too aggressive | HIGH | Forbids "proces waarbij", "handeling die", "vorm van" - but SemanticCat explicitly RECOMMENDS these as kick-off terms! |</p>
<p>| Validation matrix repetitive | MEDIUM | Table has 8 rows, all marked ‚úÖ - no explanation of what each check means |</p>
<p>| Extended list enabled by default | MEDIUM | extended_forbidden_list=True adds 32 forbidden starters by default; no performance consideration |</p>
<p>| Silent context corruption | MEDIUM | If organization_contexts/juridical_contexts/legal_basis_contexts shared state keys are missing, silently uses empty list |</p>

<p><strong>CRITICAL Contradictions with Other Modules:</strong></p>
<ul>
<li>**vs. SemanticCategorisationModule PROCES guidance:** Explicitly recommends:</li>
<li> - "start with: 'activiteit waarbij...'" ‚Üí ErrorPrevention forbids "proces waarbij"</li>
<li> - "handeling die..." ‚Üí ErrorPrevention forbids "handeling die"</li>
<li> - "proces waarin..." ‚Üí ErrorPrevention forbids these exact patterns!</li>
<li>**vs. GrammarModule:** Forbids "is", "betreft", "omvat", "betekent" but GrammarModule discusses form selection without prohibiting</li>
</ul>

<p><strong>Token Usage:</strong> ~200 tokens</p>
<p><strong>Dependencies:</strong> HARD - ContextAwarenessModule (expects shared state keys)</p>

<p><strong>Recommendation:</strong> CRITICAL FIX - Align forbidden starters with SemanticCategorisation kick-off terms. Remove contradictory forbiddens or clarify that certain forbiddens apply EXCEPT for kick-off terms. Replace hard-coded org mappings with config lookup.</p>

<p>---</p>

<h3>9. MetricsModule (Lines 1-327)</h3>

<p><strong>Current Function:</strong></p>
<ul>
<li>Calculates complexity score (1-10) based on term length, word count, context count</li>
<li>Estimates word count from character limits</li>
<li>Provides quality checks (enkelvoudig zin, lengte, no special chars, context hanteerbaar, clear term)</li>
<li>Generates scoring advice</li>
</ul>

<p><strong>Problems Found:</strong></p>

<p>| Problem | Severity | Details |</p>
<p>|---------|----------|---------|</p>
<p>| Complexity score vague | MEDIUM | "Complexity factors" add 1-2 points each but no documentation of scoring philosophy |</p>
<p>| Character limit extraction fragile | MEDIUM | Tries config.min_chars / config.max_chars but should use metadata like OutputSpec does |</p>
<p>| Word estimate inaccurate | MEDIUM | Uses average word length 5.5 chars but Dutch average is 5.2-5.8 depending on domain |</p>
<p>| Quality checks are guesses | MEDIUM | "Enkelvoudig zin mogelijk: estimated_words <= 40" - no basis for 40-word limit |</p>
<p>| Context complexity binning crude | MEDIUM | "High if > 3 contexts, Medium otherwise" - no research backing |</p>
<p>| No downstream consumers | MEDIUM | Module generates metrics but DefinitionTaskModule never uses them |</p>
<p>| Over-engineering optional module | LOW | Has track_history config option but never implemented |</p>

<p><strong>Contradictions with Other Modules:</strong></p>
<ul>
<li>**vs. OutputSpecificationModule:** Character limits defined in OutputSpec (150-350 chars default) but MetricsModule tries to read from config object which may not have them</li>
<li>**vs. ContextAwarenessModule:** Uses org_contexts.length for complexity but ignores juridical_contexts and legal_basis_contexts</li>
</ul>

<p><strong>Token Usage:</strong> ~200 tokens</p>
<p><strong>Dependencies:</strong> None declared (but assumes config attributes)</p>

<p><strong>Recommendation:</strong> REFACTOR - Simplify complexity scoring to 3 levels (simple/moderate/complex). Use consistent character limit source. Remove unused track_history. Make metrics optional (priority=10). Consider removing if metrics not consumed downstream.</p>

<p>---</p>

<h3>10. DefinitionTaskModule (Lines 1-300)</h3>

<p><strong>Current Function:</strong></p>
<ul>
<li>Provides final instruction and checklist</li>
<li>Builds quality control questions</li>
<li>Generates metadata with timestamp</li>
<li>Builds ontological marker instruction</li>
<li>Includes prompt metadata (term type, contexts, timestamp)</li>
</ul>

<p><strong>Problems Found:</strong></p>

<p>| Problem | Severity | Details |</p>
<p>|---------|----------|---------|</p>
<p>| CRITICAL: Ontological category hints duplicate SemanticCat | CRITICAL | Lines 189-196 hardcodes category hints that SemanticCat already provided (proces‚Üí"activiteit/handeling", etc.) |</p>
<p>| Context extraction logic fragile | HIGH | Lines 86-104 attempt multiple fallback strategies for context keys (juridische_context vs juridisch vs wettelijke_basis vs wettelijk) but this is legacy handling for EPIC-010 migration |</p>
<p>| Duplicates checklist items from ErrorPrevention | MEDIUM | Checklist includes "Geen verboden woorden (aspect, element, kan, moet, etc.)" but ErrorPreventionModule more comprehensive |</p>
<p>| Timestamp UTC conversion unnecessary | LOW | Uses datetime.now(UTC) but for non-critical metadata |</p>
<p>| Prompt metadata at end wastes space | MEDIUM | Metadata could be injected at start for parsing, not at definition end |</p>

<p><strong>Contradictions with Other Modules:</strong></p>
<ul>
<li>**vs. SemanticCategorisationModule:** Duplicates category-specific guidance (lines 189-196)</li>
<li>**vs. ErrorPreventionModule:** Both include forbidden word lists but different scopes</li>
<li>**vs. GrammarModule:** Checklist item "Geen toelichting, voorbeelden of haakjes" overlaps with GrammarModule guidance</li>
</ul>

<p><strong>Token Usage:</strong> ~180 tokens</p>
<p><strong>Dependencies:</strong> HARD - SemanticCategorisationModule (but doesn't declare it)</p>

<p><strong>Recommendation:</strong> CONSOLIDATE - Remove ontological category hints (let SemanticCat own this). Consolidate forbidden words list with ErrorPreventionModule. Move metadata block to template-based insertion (as comment or structured format).</p>

<p>---</p>

<h2>Cross-Module Contradiction Analysis</h2>

<h3>Critical Contradictions (Require Immediate Resolution)</h3>

<h4>Contradiction #1: Forbidden Patterns vs. Recommended Patterns (SEVERITY: CRITICAL)</h4>

<p><strong>Conflict:</strong></p>
<ul>
<li>**ErrorPreventionModule (lines 179-186)** forbids:</li>
<li> - "proces waarbij"</li>
<li> - "handeling die"</li>
<li> - "vorm van", "type van", "soort van"</li>
</ul>

<ul>
<li>**SemanticCategorisationModule (lines 182-207)** EXPLICITLY RECOMMENDS AS KICK-OFF:</li>
<li> - PROCES: 'activiteit waarbij...', 'handeling die...', 'proces waarin...'</li>
<li> - TYPE: 'woord dat...', 'document dat...', 'persoon die...'</li>
</ul>

<p><strong>Impact:</strong> LLM receives contradictory instructions. Will either ignore one set or oscillate between them.</p>

<p><strong>Root Cause:</strong> ErrorPrevention module was designed for legacy prompt; SemanticCat represents newer ESS-02 standard. Modules never reconciled.</p>

<p><strong>Resolution:</strong> Remove conflicting items from ErrorPrevention forbidden list OR add exception clause: "EXCEPT for kick-off terms in semantic categorisation section"</p>

<p>---</p>

<h4>Contradiction #2: Haakjes (Parentheses) Allowed vs. Forbidden (SEVERITY: CRITICAL)</h4>

<p><strong>Conflict:</strong></p>
<ul>
<li>**OutputSpecificationModule (line 144):** "Geen haakjes voor toelichtingen"</li>
<li>**GrammarModule (lines 225-237):** "Plaats afkortingen direct na de volledige term tussen haakjes" ‚Üí Example: "Dienst Justiti√´le Inrichtingen (DJI)"</li>
<li>**IntegrityModule INT-07 (lines 278-287):** Same guidance on afkortingen in haakjes</li>
</ul>

<p><strong>Impact:</strong> Contradictory guidance on same concept (abbreviations). OutputSpec says NO haakjes, Grammar/Integrity say YES for abbreviations.</p>

<p><strong>Root Cause:</strong> OutputSpec conflates "no haakjes for explanation" with "no haakjes at all". Grammar correctly specifies "haakjes only for abbreviations".</p>

<p><strong>Resolution:</strong> Clarify in OutputSpec: "Geen haakjes voor toelichtingen - MAAR afkortingen plaatsen tussen haakjes is verplicht (bijv. DJI)"</p>

<p>---</p>

<h4>Contradiction #3: Category Naming Scheme Triplication (SEVERITY: CRITICAL)</h4>

<p><strong>Conflict:</strong></p>
<p>Three different category naming systems:</p>

<ol>
<li>**SemanticCategorisationModule:** "proces", "type", "resultaat", "exemplaar" (lowercase, matches ESS-02)</li>
<li>**TemplateModule:** "Proces", "Object", "Actor", "Toestand", "Gebeurtenis", "Maatregel", "Informatie", "Regel", "Recht", "Verplichting" (10 categories, different names entirely)</li>
<li>**DefinitionTaskModule:** "soort", "exemplaar", "proces", "resultaat" (Dutch names, different order)</li>
</ol>

<p><strong>Impact:</strong> If metadata passes "proces", which templates load? None, because TemplateModule looks for "Proces" with capital P. Category naming is broken across entire module stack.</p>

<p><strong>Root Cause:</strong> Modules developed independently without coordinating on category schema.</p>

<p><strong>Resolution:</strong> Unify on single naming scheme. Recommend: semanctic-cat lowercase (processo, type, resultaat, exemplaar) as canonical. Update TemplateModule and DefinitionTask to match.</p>

<p>---</p>

<h3>High-Priority Contradictions</h3>

<h4>Contradiction #4: Grammatical Structure Rules Overlap</h4>

<p><strong>Conflict:</strong></p>
<ul>
<li>**GrammarModule:** Specifies enkelvoud, actieve vorm, tegenwoordige tijd (general grammar)</li>
<li>**StructureRulesModule STR-01:** "definitie start met zelfstandig naamwoord"</li>
<li>**SemanticCategorisationModule:** "kick-off term MOET zelfstandig naamwoord zijn"</li>
</ul>

<p><strong>Impact:</strong> Same rule stated 3 times with varying levels of detail. Confusing emphasis.</p>

<p><strong>Resolution:</strong> Consolidate to single statement in appropriate module. STR-01 should own this rule; others reference it.</p>

<p>---</p>

<h4>Contradiction #5: Context Handling (EPIC-010 Migration Incomplete)</h4>

<p><strong>Conflict:</strong></p>
<p>Multiple modules attempt to handle context extraction with fallback logic:</p>
<ul>
<li>**ContextAwarenessModule (lines 368-423):** Extracts "organisatorisch", "juridisch", "wettelijk"</li>
<li>**DefinitionTaskModule (lines 86-104):** Attempts fallbacks: "juridische_context" OR "juridisch", "wettelijke_basis" OR "wettelijk"</li>
<li>**ErrorPreventionModule (lines 77-79):** Expects shared state from ContextAware: "organization_contexts", "juridical_contexts", "legal_basis_contexts"</li>
</ul>

<p><strong>Impact:</strong> EPIC-010 migration from legacy "domein" to new context types is incomplete. Code has scattered migration logic.</p>

<p><strong>Resolution:</strong> Complete EPIC-010 migration. Remove fallback logic. Standardize key names everywhere.</p>

<p>---</p>

<h2>Token Waste Analysis</h2>

<p>| Source | Tokens | % of Total | Avoidable |</p>
<p>|--------|--------|-----------|-----------|</p>
<p>| StructureRulesModule hardcoded rules | 150 | 2.0% | YES - use cache |</p>
<p>| Duplicate _format_rule in 5 modules | 60 | 0.8% | YES - extract base |</p>
<p>| Duplicate afkorting rules (Gram + INT-07) | 50 | 0.7% | YES - consolidate |</p>
<p>| Duplicate ontological hints (SemanticCat + DefinTask) | 40 | 0.5% | YES - deduplicate |</p>
<p>| TemplateModule dead code | 120 | 1.6% | YES - remove/fix |</p>
<p>| Unused confidence indicators (ContextAware) | 30 | 0.4% | YES - remove |</p>
<p>| Verbose category guidance (SemanticCat) | 100 | 1.3% | YES - condense |</p>
<p>| Extended forbidden starters (ErrorPrev) | 80 | 1.1% | MAYBE - keep if needed |</p>
<p>| Unused shared state values | 40 | 0.5% | YES - consolidate |</p>
<p>| <strong>SUBTOTAL AVOIDABLE</strong> | <strong>670</strong> | <strong>8.9%</strong> | |</p>
<p>| <strong>SUBTOTAL MAYBE</strong> | <strong>80</strong> | <strong>1.1%</strong> | |</p>
<p>| <strong>ESTIMATED TOTAL WASTE</strong> | <strong>750</strong> | <strong>~10%</strong> | |</p>

<p><strong>Full Prompt Estimated Size:</strong> ~7,500 tokens</p>
<p><strong>Avoidable Waste:</strong> 750 tokens (10%)</p>
<p><strong>After Fixes Potential:</strong> ~6,750 tokens (10% reduction)</p>

<p>---</p>

<h2>Priority Matrix</h2>

<h3>CRITICAL - Fix Immediately</h3>

<p>| Issue | Module(s) | Impact | Effort | Benefit |</p>
<p>|-------|-----------|--------|--------|---------|</p>
<p>| Forbidden patterns contradict recommended | ErrorPrevention + SemanticCat | LLM confusion | 2h | HIGH |</p>
<p>| Haakjes contradiction | OutputSpec + Grammar + Integrity | Format errors | 1h | HIGH |</p>
<p>| Category naming triplication | TemplateModule + SemanticCat + DefinTask | Module silently broken | 3h | CRITICAL |</p>
<p>| TemplateModule validation bug | TemplateModule | Module never runs | 2h | MEDIUM |</p>
<p>| STR rules hardcoding | StructureRulesModule | Token waste | 1h | MEDIUM |</p>

<h3>HIGH - Fix in Next Sprint</h3>

<p>| Issue | Module(s) | Impact | Effort | Benefit |</p>
<p>|-------|-----------|--------|--------|---------|</p>
<p>| Context migration (EPIC-010) incomplete | Multiple | Code duplication, fragility | 4h | HIGH |</p>
<p>| Duplicate afkorting rules | Grammar + Integrity | Maintenance nightmare | 2h | MEDIUM |</p>
<p>| Unused shared state | ContextAware + ErrorPrev | Silent failures | 2h | MEDIUM |</p>
<p>| Over-engineered ContextAware | ContextAware | Token waste | 2h | MEDIUM |</p>
<p>| Confidence indicators unused | ContextAware | Dead code | 1h | LOW |</p>

<h3>MEDIUM - Fix When Refactoring</h3>

<p>| Issue | Module(s) | Impact | Effort | Benefit |</p>
<p>|-------|-----------|--------|--------|---------|</p>
<p>| Module dependencies not declared | Multiple | Invisible failures | 2h | MEDIUM |</p>
<p>| Duplicate category hints | SemanticCat + DefinTask | Maintenance | 1h | LOW |</p>
<p>| Verbose category guidance | SemanticCat | Token waste | 2h | MEDIUM |</p>
<p>| Complexity score vague | MetricsModule | LLM confusion | 1h | LOW |</p>
<p>| Filter fragility (startswith) | Rule modules | Technical debt | 1h | LOW |</p>

<p>---</p>

<h2>Detailed Recommendations</h2>

<h3>RECOMMENDATION 1: Unify Category Naming (CRITICAL)</h3>

<p><strong>Issue:</strong> Three different category naming schemes cause TemplateModule to never run.</p>

<p><strong>Solution:</strong></p>
<ol>
<li>Choose canonical naming: `['type', 'proces', 'resultaat', 'exemplaar']` (lowercase, ESS-02 standard)</li>
<li>Update all metadata injection points to use canonical names</li>
<li>Update all modules:</li>
</ol>
<ul>
<li>  - **SemanticCat:** Already correct ‚úÖ</li>
<li>  - **TemplateModule:** Map category names to templates OR remove if templates unneeded</li>
<li>  - **DefinitionTask:** Use canonical names in checklist hints</li>
</ul>
<ol>
<li>Add validation in ModuleContext to enforce schema</li>
</ol>

<p><strong>Files to Update:</strong></p>
<ul>
<li>`semantic_categorisation_module.py` - ensure metadata key is consistent</li>
<li>`template_module.py` - fix validation and category mapping</li>
<li>`definition_task_module.py` - align checklist hints</li>
</ul>

<p><strong>Token Impact:</strong> -40 tokens (remove broken category schema)</p>
<p><strong>Effort:</strong> 2 hours</p>

<p>---</p>

<h3>RECOMMENDATION 2: Resolve Forbidden vs. Recommended Contradiction (CRITICAL)</h3>

<p><strong>Issue:</strong> ErrorPreventionModule forbids "proces waarbij", "handeling die" but SemanticCat recommends them as kick-off terms.</p>

<p><strong>Solution:</strong></p>
<ol>
<li>In ErrorPreventionModule, revise forbidden starters list:</li>
</ol>
<ul>
<li>  - Remove: "proces waarbij", "handeling die", "vorm van", "type van", "soort van"</li>
<li>  - Add clarification: "These are forbidden EXCEPT as semantic categorisation kick-off terms (see ESS-02 section)"</li>
</ul>
<ol>
<li>Keep only genuinely forbidden patterns:</li>
</ol>
<ul>
<li>  - Koppelwerkwoorden that aren't part of formal construction: "is", "betreft", "omvat", "betekent"</li>
<li>  - Lidwoorden at start: "de", "het", "een"</li>
</ul>

<p><strong>Files to Update:</strong></p>
<ul>
<li>`error_prevention_module.py` lines 156-191</li>
</ul>

<p><strong>Token Impact:</strong> -50 tokens (shorter forbidden list)</p>
<p><strong>Effort:</strong> 1 hour</p>

<p>---</p>

<h3>RECOMMENDATION 3: Clarify Haakjes Rule (CRITICAL)</h3>

<p><strong>Issue:</strong> OutputSpec says "no haakjes" but Grammar says "haakjes for abbreviations required".</p>

<p><strong>Solution:</strong></p>
<ol>
<li>In OutputSpecificationModule, revise guidance:</li>
</ol>
<ul>
<li>  - Change: "Geen haakjes voor toelichtingen"</li>
<li>  - To: "Geen haakjes voor toelichtingen; haakjes ZIJN verplicht voor afkortingen (bijv. DJI)"</li>
</ul>
<ol>
<li>In GrammarModule INT-07, confirm this is canonical rule</li>
<li>Remove duplication of INT-07 in IntegrityModule (already exists in Integrity module)</li>
</ol>

<p><strong>Files to Update:</strong></p>
<ul>
<li>`output_specification_module.py` line 144</li>
<li>Consider consolidating Grammar and Integrity afkorting rules</li>
</ul>

<p><strong>Token Impact:</strong> +10 tokens (adds clarity, but consolidated rules save 50 tokens elsewhere)</p>
<p><strong>Effort:</strong> 1 hour</p>

<p>---</p>

<h3>RECOMMENDATION 4: Fix TemplateModule (CRITICAL)</h3>

<p><strong>Issue:</strong> Module never executes due to broken validation (expects metadata key "semantic_category" that's never set).</p>

<p><strong>Options:</strong></p>
<p>A. <strong>Remove</strong> - If templates not critical, delete module entirely (save 120 tokens)</p>
<p>B. <strong>Fix</strong> - Map SemanticCat categories to template examples, inline in SemanticCat</p>
<p>C. <strong>Refactor</strong> - Make TemplateModule optional (remove validation requirement)</p>

<p><strong>Recommendation:</strong> REMOVE</p>
<ul>
<li>SemanticCategorisationModule already provides comprehensive examples per category</li>
<li>TemplateModule provides different template examples that are redundant</li>
<li>Keeping both causes confusion on which examples to use</li>
</ul>

<p><strong>Token Impact:</strong> -120 tokens (remove dead module)</p>
<p><strong>Effort:</strong> 1 hour (delete file, remove from orchestrator)</p>

<p>---</p>

<h3>RECOMMENDATION 5: Migrate StructureRulesModule to Cached Loading (HIGH)</h3>

<p><strong>Issue:</strong> StructureRulesModule hardcodes all 9 rules (63 lines) when other rule modules load from cache.</p>

<p><strong>Solution:</strong></p>
<ol>
<li>Move STR rules to `config/toetsregels/regels/` JSON files (if not already there)</li>
<li>Update StructureRulesModule to use cached loading like ARAI/CON/ESS/SAM/VER</li>
<li>Simplify execute() method from 70 lines to 15 lines</li>
</ol>

<p><strong>Before:</strong></p>
<pre><code>def execute(self, context: ModuleContext) -&gt; ModuleOutput:
    sections = []
    sections.append("### üèóÔ∏è Structuur Regels (STR):")
    sections.extend(self._build_str01_rule())  # 54 lines of building logic
    sections.extend(self._build_str02_rule())  # ...
    # ... 7 more rule builders ...</code></pre>

<p><strong>After:</strong></p>
<pre><code>def execute(self, context: ModuleContext) -&gt; ModuleOutput:
    sections = []
    sections.append("### üèóÔ∏è Structuur Regels (STR):")

    from toetsregels.cached_manager import get_cached_toetsregel_manager
    manager = get_cached_toetsregel_manager()
    all_rules = manager.get_all_regels()
    str_rules = {k: v for k, v in all_rules.items() if k.startswith("STR-")}

    for regel_key, regel_data in sorted(str_rules.items()):
        sections.extend(self._format_rule(regel_key, regel_data))
    # ... return ...</code></pre>

<p><strong>Token Impact:</strong> -150 tokens (hardcoded rules removed; cache loading minimal)</p>
<p><strong>Effort:</strong> 1 hour</p>

<p>---</p>

<h3>RECOMMENDATION 6: Extract Duplicate _format_rule Method (MEDIUM)</h3>

<p><strong>Issue:</strong> _format_rule method duplicated in ARAI, CON, ESS, INT, SAM, VER modules (6 copies of ~30 lines).</p>

<p><strong>Solution:</strong></p>
<ol>
<li>Create base formatter in BasePromptModule</li>
<li>Update all 6 modules to inherit and call super()._format_rule()</li>
</ol>

<p><strong>Code:</strong></p>
<pre><code># In base_module.py
class BasePromptModule(ABC):
    def _format_rule_from_json(self, regel_key: str, regel_data: dict, include_examples: bool = True) -&gt; list[str]:
        """Standard rule formatter for all rule modules."""
        lines = []
        naam = regel_data.get("naam", "Onbekende regel")
        lines.append(f"üîπ **{regel_key} - {naam}**")

        uitleg = regel_data.get("uitleg", "")
        if uitleg:
            lines.append(f"- {uitleg}")

        toetsvraag = regel_data.get("toetsvraag", "")
        if toetsvraag:
            lines.append(f"- Toetsvraag: {toetsvraag}")

        if include_examples:
            for goed in regel_data.get("goede_voorbeelden", []):
                lines.append(f"  ‚úÖ {goed}")
            for fout in regel_data.get("foute_voorbeelden", []):
                lines.append(f"  ‚ùå {fout}")

        return lines</code></pre>

<p><strong>Token Impact:</strong> -60 tokens (remove duplicate code)</p>
<p><strong>Effort:</strong> 2 hours (test all 6 modules)</p>

<p>---</p>

<h3>RECOMMENDATION 7: Consolidate Context Handling (EPIC-010 Completion) (HIGH)</h3>

<p><strong>Issue:</strong> EPIC-010 migration from legacy "domein" to new context types incomplete; fallback logic scattered across modules.</p>

<p><strong>Solution:</strong></p>
<ol>
<li>Complete EPIC-010 by removing all fallback logic</li>
<li>Standardize context key names globally:</li>
</ol>
<ul>
<li>  - **ContextAwarenessModule** shares: `organization_contexts`, `juridical_contexts`, `legal_basis_contexts`</li>
<li>  - **DefinitionTaskModule** reads: same keys (no fallback)</li>
<li>  - **ErrorPreventionModule** reads: same keys (no fallback)</li>
<li>  - **MetricsModule** reads: same keys (no fallback)</li>
</ul>
<ol>
<li>Add migration test to ensure no legacy "domein" context leaks</li>
</ol>

<p><strong>Files to Update:</strong></p>
<ul>
<li>`context_awareness_module.py` - finalize extraction</li>
<li>`definition_task_module.py` - remove lines 86-104 fallback logic</li>
<li>Add validation in ModuleContext</li>
</ul>

<p><strong>Token Impact:</strong> -40 tokens (remove fallback code)</p>
<p><strong>Effort:</strong> 2 hours</p>

<p>---</p>

<h3>RECOMMENDATION 8: Simplify ContextAwarenessModule (MEDIUM)</h3>

<p><strong>Issue:</strong> Over-engineered with 3 formatting levels but configuration doesn't select level; score-based selection always used.</p>

<p><strong>Solution:</strong></p>
<ol>
<li>Remove rich/moderate/minimal complexity; keep only moderate (best default)</li>
<li>Remove unused confidence indicator logic (üî¥üü°üü¢)</li>
<li>Consolidate formatting to single _build_context_section method</li>
</ol>

<p><strong>Token Impact:</strong> -80 tokens (remove dead code)</p>
<p><strong>Effort:</strong> 2 hours</p>

<p>---</p>

<h3>RECOMMENDATION 9: Merge OutputSpec and Grammar (HIGH)</h3>

<p><strong>Issue:</strong> Overlapping guidance on format, punctuation, abbreviations.</p>

<p><strong>Solution:</strong></p>
<ol>
<li>Create new unified module: `FormattingModule` combining:</li>
</ol>
<ul>
<li>  - Output format requirements (from OutputSpec)</li>
<li>  - Punctuation rules (from Grammar)</li>
<li>  - Abbreviation rules (from Grammar + Integrity)</li>
</ul>
<ol>
<li>Update Grammar module to focus ONLY on grammatical structures (not format)</li>
<li>Update priority: FormattingModule = 90, Grammar = 80</li>
</ol>

<p><strong>Token Impact:</strong> -100 tokens (consolidate overlapping content)</p>
<p><strong>Effort:</strong> 3 hours</p>

<p>---</p>

<h2>Implementation Roadmap</h2>

<h3>Phase 1: Critical Fixes (Week 1) - 6 hours</h3>
<ol>
<li>**RECOMMENDATION 2:** Resolve forbidden vs. recommended (1h)</li>
<li>**RECOMMENDATION 3:** Clarify haakjes rule (1h)</li>
<li>**RECOMMENDATION 4:** Remove TemplateModule (1h)</li>
<li>**RECOMMENDATION 5:** Migrate StructureRules to cache (1h)</li>
<li>Testing & validation (2h)</li>
</ol>

<p><strong>Token Impact After Phase 1:</strong> -300 tokens (cumulative)</p>

<h3>Phase 2: Duplication Fixes (Week 2) - 8 hours</h3>
<ol>
<li>**RECOMMENDATION 1:** Unify category naming (2h)</li>
<li>**RECOMMENDATION 6:** Extract _format_rule (2h)</li>
<li>**RECOMMENDATION 7:** Complete EPIC-010 (2h)</li>
<li>Testing (2h)</li>
</ol>

<p><strong>Token Impact After Phase 2:</strong> -500 tokens (cumulative)</p>

<h3>Phase 3: Refactoring (Week 3) - 7 hours</h3>
<ol>
<li>**RECOMMENDATION 8:** Simplify ContextAware (2h)</li>
<li>**RECOMMENDATION 9:** Merge OutputSpec/Grammar (3h)</li>
<li>Final testing & validation (2h)</li>
</ol>

<p><strong>Token Impact After Phase 3:</strong> -750 tokens (cumulative, ~10% reduction)</p>

<p>---</p>

<h2>Testing Strategy</h2>

<h3>Unit Tests Required</h3>

<pre><code># Test 1: Verify no forbidden patterns in SemanticCat kick-offs
def test_semantic_kickoffs_not_forbidden():
    semantic_cat = SemanticCategorisationModule()
    error_prev = ErrorPreventionModule()
    # Ensure "proces waarbij" in SemanticCat not in forbidden list

# Test 2: Verify category naming consistency
def test_category_naming_consistent():
    # All modules use same category names
    categories = ['type', 'proces', 'resultaat', 'exemplaar']
    # Check metadata injection, SemanticCat, DefinTask align

# Test 3: Verify context shared state contract
def test_context_shared_state_keys():
    # ContextAware shares keys that ErrorPrev, DefinTask, Metrics expect
    expected_keys = ['organization_contexts', 'juridical_contexts', 'legal_basis_contexts']

# Test 4: Verify TemplateModule fixed or removed
def test_template_module_deprecation():
    # Either removed or validation fixed
    pass

# Test 5: Verify STR rules loaded from cache
def test_str_module_cached_loading():
    str_module = StructureRulesModule()
    assert "cache" in str_module.execute.__doc__ or "cached_manager" in str_module.execute.__code__</code></pre>

<h3>Integration Tests Required</h3>

<ul>
<li>Verify full prompt generation with all 16 modules</li>
<li>Check for contradictory output in generated prompt</li>
<li>Measure token count reduction</li>
<li>LLM behavior test: does it produce consistent definitions?</li>
</ul>

<p>---</p>

<h2>Metrics for Success</h2>

<h3>Before Fixes</h3>
<ul>
<li>**Total tokens:** ~7,500</li>
<li>**Module count:** 16</li>
<li>**Contradictions:** 5 critical</li>
<li>**Dead code modules:** 1 (TemplateModule)</li>
<li>**Code duplication:** 6 modules with identical _format_rule</li>
</ul>

<h3>After Fixes</h3>
<ul>
<li>**Total tokens:** ~6,750 (10% reduction)</li>
<li>**Module count:** 15 (TemplateModule removed)</li>
<li>**Contradictions:** 0 (resolved)</li>
<li>**Dead code modules:** 0</li>
<li>**Code duplication:** 0</li>
<li>**Test coverage:** 100% of critical paths</li>
<li>**LLM behavior:** Consistent category application</li>
</ul>

<p>---</p>

<h2>Appendix A: Detailed Module Dependency Graph</h2>

<pre><code>ExpertiseModule (root)
‚îú‚îÄ‚îÄ OutputSpecificationModule (root)
‚îú‚îÄ‚îÄ GrammarModule (soft: ExpertiseModule.word_type)
‚îú‚îÄ‚îÄ ContextAwarenessModule (root)
‚îÇ   ‚îî‚îÄ‚îÄ ErrorPreventionModule (depends on ContextAware shared state)
‚îú‚îÄ‚îÄ SemanticCategorisationModule (root)
‚îÇ   ‚îî‚îÄ‚îÄ TemplateModule (broken: validates missing metadata)
‚îÇ   ‚îî‚îÄ‚îÄ DefinitionTaskModule (depends on SemanticCat.ontological_category)
‚îú‚îÄ‚îÄ ARAI/CON/ESS/STR/INT/SAM/VER RulesModules (root - load from cache)
‚îú‚îÄ‚îÄ MetricsModule (root - but assumes config attributes)
‚îî‚îÄ‚îÄ Orchestrator (calls all modules in order)</code></pre>

<p><strong>Missing Declarations:</strong></p>
<ul>
<li>GrammarModule should declare hard dep on ExpertiseModule</li>
<li>ErrorPreventionModule should declare hard dep on ContextAware</li>
<li>DefinitionTaskModule should declare hard dep on SemanticCat</li>
<li>All rule modules should declare soft dep on cached rule manager</li>
</ul>

<p>---</p>

<h2>Appendix B: Token Usage Summary by Module</h2>

<p>| Module | Estimated Tokens | % of Prompt | Redundancy | Can Reduce |</p>
<p>|--------|------------------|------------|-----------|-----------|</p>
<p>| ExpertiseModule | 150 | 2.0% | LOW | NO |</p>
<p>| OutputSpecificationModule | 100 | 1.3% | MEDIUM | 40% (merge) |</p>
<p>| GrammarModule | 140 | 1.9% | MEDIUM | 30% (merge) |</p>
<p>| ContextAwarenessModule | 230 | 3.1% | MEDIUM | 35% (simplify) |</p>
<p>| SemanticCategorisationModule | 180 | 2.4% | MEDIUM | 40% (condense) |</p>
<p>| TemplateModule | 120 | 1.6% | HIGH | 100% (remove) |</p>
<p>| ARAI RulesModule | 200 | 2.7% | LOW | 0% |</p>
<p>| CON RulesModule | 80 | 1.1% | LOW | 0% |</p>
<p>| ESS RulesModule | 150 | 2.0% | LOW | 0% |</p>
<p>| StructureRulesModule | 250 | 3.3% | HIGH | 60% (use cache) |</p>
<p>| IntegrityRulesModule | 200 | 2.7% | LOW | 20% (remove dupes) |</p>
<p>| SAMRulesModule | 60 | 0.8% | LOW | 0% |</p>
<p>| VER RulesModule | 50 | 0.7% | LOW | 0% |</p>
<p>| ErrorPreventionModule | 200 | 2.7% | MEDIUM | 30% (trim) |</p>
<p>| MetricsModule | 200 | 2.7% | MEDIUM | 10% (simplify) |</p>
<p>| DefinitionTaskModule | 180 | 2.4% | MEDIUM | 25% (dedupe) |</p>
<p>| <strong>TOTAL</strong> | <strong>~7,500</strong> | <strong>100%</strong> | | <strong>~750 (10%)</strong> |</p>

<p>---</p>

<h2>Summary & Next Steps</h2>

<p>This analysis identified <strong>7 critical issues</strong> requiring immediate resolution:</p>

<ol>
<li>**Forbidden vs. recommended patterns contradict** - LLM receives conflicting instructions</li>
<li>**Haakjes contradiction** - Format guidance conflicts within same concept</li>
<li>**Category naming triplication** - Three different naming schemes break module contracts</li>
<li>**TemplateModule broken** - Validates for metadata never set; module silently fails</li>
<li>**StructureRulesModule hardcoding** - 150 tokens of unnecessary code duplication</li>
<li>**EPIC-010 incomplete** - Scattered fallback logic across modules indicates incomplete migration</li>
<li>**Token waste** - ~750 tokens (10%) of prompt are redundant/dead code</li>
</ol>

<p><strong>Recommended action:</strong> Implement Phase 1 (Critical Fixes) immediately to resolve contradictions. This will also reduce token usage by 300 tokens (~4%) and clarify prompt intent to LLM.</p>

<p><strong>Estimated savings:</strong> 750 tokens (10% reduction) across all 3 phases, improving both cost and LLM behavior consistency.</p>

<p>---</p>

<p><strong>End of Analysis</strong></p>
<p><strong>Prepared by:</strong> Debug Specialist</p>
<p><strong>Classification:</strong> Technical Architecture Review</p>
<p><strong>Status:</strong> Ready for Action</p>

  </div>
</body>
</html>