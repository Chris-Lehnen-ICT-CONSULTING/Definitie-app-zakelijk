<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ” Branch Protection Setup Guide</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">â† Terug naar Portal</a>
    <h1>ğŸ” Branch Protection Setup Guide</h1>

<p><strong>Date:</strong> 2025-10-19  </p>
<p><strong>Purpose:</strong> Step-by-step guide to configure branch protection for <code>main</code> branch  </p>
<p><strong>Time Required:</strong> ~30 minutes  </p>
<p><strong>Recommended:</strong> Do this immediately after auto-labeling setup</p>

<p>---</p>

<h2>ğŸ¯ Why Branch Protection?</h2>

<p>Branch protection prevents:</p>
<ul>
<li>âŒ Direct pushes to main without review</li>
<li>âŒ Merging PRs with failing CI checks</li>
<li>âŒ Force pushes that rewrite history</li>
<li>âŒ Accidental branch deletion</li>
<li>âŒ Merging without required approvals</li>
</ul>

<p><strong>Result:</strong> Higher code quality, better collaboration, fewer bugs in production</p>

<p>---</p>

<h2>ğŸ“‹ Prerequisites</h2>

<p>Before starting, ensure:</p>
<ul>
<li>âœ… You have admin access to the repository</li>
<li>âœ… CI workflows are configured (they are!)</li>
<li>âœ… You know which checks must pass (see below)</li>
</ul>

<p>---</p>

<h2>ğŸš€ Step-by-Step Configuration</h2>

<h3>Step 1: Navigate to Settings</h3>

<ol>
<li>Go to: https://github.com/ChrisLehnen/Definitie-app</li>
<li>Click **Settings** tab (top navigation)</li>
<li>Click **Branches** (left sidebar under "Code and automation")</li>
</ol>

<h3>Step 2: Add Branch Protection Rule</h3>

<ol>
<li>Click **"Add branch protection rule"** button</li>
<li>In **"Branch name pattern"** field, enter: `main`</li>
</ol>

<h3>Step 3: Configure Protection Settings</h3>

<h4>ğŸ”’ Basic Protection (REQUIRED)</h4>

<p>Check these boxes:</p>

<ul>
<li>âœ… **Require a pull request before merging**</li>
<li> - âœ… **Require approvals**: Set to `1`</li>
<li> - âœ… **Dismiss stale pull request approvals when new commits are pushed**</li>
<li> - âœ… **Require review from Code Owners** (optional, if you have CODEOWNERS file)</li>
</ul>

<ul>
<li>âœ… **Require status checks to pass before merging**</li>
<li> - âœ… **Require branches to be up to date before merging**</li>
<li> - Click **"Add more"** and search for these checks:</li>
</ul>

<h4>âœ… Required Status Checks (MUST PASS)</h4>

<p>Add these exact check names (search for them):</p>

<p><strong>Security Checks (CRITICAL):</strong></p>
<pre><code>Secret Scan (gitleaks)
Dependency Audit (pip-audit)</code></pre>

<p><strong>CI Checks (CRITICAL):</strong></p>
<pre><code>CI / Run Grep Gate (enforced for services)
CI / Run smoke test with coverage</code></pre>

<p><strong>Quality Gates (CRITICAL):</strong></p>
<pre><code>Quality Gates
No root-level DB files</code></pre>

<p><strong>Optional but Recommended (Can add later):</strong></p>
<pre><code>Tests / test (3.11)  [Add when Phase 2 complete]
Contract Tests       [Add when fixed]</code></pre>

<h4>ğŸ” Additional Protection (STRONGLY RECOMMENDED)</h4>

<ul>
<li>âœ… **Require conversation resolution before merging**</li>
<li> - Forces all review comments to be resolved</li>
</ul>

<ul>
<li>âœ… **Require signed commits** (if you use GPG signing)</li>
<li> - Only if you have GPG configured</li>
</ul>

<ul>
<li>âœ… **Include administrators**</li>
<li> - âš ï¸ IMPORTANT: Check this to apply rules to admins too</li>
<li> - Prevents accidental bypassing of protection</li>
</ul>

<ul>
<li>âœ… **Restrict who can push to matching branches**</li>
<li> - Leave empty or add specific users if needed</li>
</ul>

<h4>ğŸš« Lock Settings (CRITICAL)</h4>

<ul>
<li>âœ… **Allow force pushes**: **UNCHECKED** (NO!)</li>
<li>âœ… **Allow deletions**: **UNCHECKED** (NO!)</li>
</ul>

<h3>Step 4: Save Changes</h3>

<ol>
<li>Scroll to bottom</li>
<li>Click **"Create"** or **"Save changes"**</li>
<li>You'll see a success message</li>
</ol>

<p>---</p>

<h2>âœ… Verification Checklist</h2>

<p>After configuration, verify:</p>

<h3>Test 1: Try Direct Push (Should FAIL)</h3>
<pre><code># This should now be blocked:
git checkout main
echo "test" &gt;&gt; test.txt
git add test.txt
git commit -m "test"
git push origin main
# Expected: ! [remote rejected] main -&gt; main (protected branch hook declined)</code></pre>

<h3>Test 2: Create Test PR</h3>
<pre><code># This should work:
git checkout -b test-branch-protection
echo "# Test Branch Protection" &gt;&gt; TEST_PR.md
git add TEST_PR.md
git commit -m "test: verify branch protection works"
git push origin test-branch-protection

# Then create PR via GitHub UI and verify:
# - Can create PR âœ…
# - Cannot merge until checks pass âŒ
# - Need 1 approval âŒ</code></pre>

<h3>Test 3: Check Status Checks</h3>
<ol>
<li>Go to your test PR</li>
<li>Scroll to bottom - you should see:</li>
</ol>
<ul>
<li>  - â³ "Waiting for status checks to pass"</li>
<li>  - List of required checks (Security, CI, Quality Gates)</li>
<li>  - ğŸ”´ "Review required" (need 1 approval)</li>
</ul>

<h3>Test 4: Cleanup</h3>
<pre><code># After verifying, cleanup:
git checkout main
git branch -D test-branch-protection
# Delete the PR from GitHub UI</code></pre>

<p>---</p>

<h2>ğŸ“Š Expected Behavior After Setup</h2>

<h3>âœ… What Will Work</h3>
<ul>
<li>Creating feature branches</li>
<li>Opening pull requests</li>
<li>Auto-labeling on PRs (via labeler workflow)</li>
<li>CI checks running automatically</li>
<li>PR size labels appearing</li>
<li>Viewing all changes before merge</li>
</ul>

<h3>âŒ What Will Be Blocked</h3>
<ul>
<li>Direct pushes to `main`</li>
<li>Merging without approval</li>
<li>Merging with failing CI checks</li>
<li>Force pushing to `main`</li>
<li>Deleting `main` branch</li>
<li>Merging with unresolved comments</li>
</ul>

<p>---</p>

<h2>ğŸ”§ Troubleshooting</h2>

<h3>Problem: "Status check not found"</h3>

<p><strong>Cause:</strong> Check name doesn't match exactly</p>

<p><strong>Solution:</strong> </p>
<ol>
<li>Open a recent PR or workflow run</li>
<li>Copy the exact check name from GitHub Actions</li>
<li>Add that exact name to required checks</li>
</ol>

<h3>Problem: "Cannot push even with PR"</h3>

<p><strong>Cause:</strong> You're trying to push to <code>main</code> directly</p>

<p><strong>Solution:</strong></p>
<pre><code># Always use feature branches:
git checkout -b feature/my-change
# Make changes
git push origin feature/my-change
# Then create PR from GitHub UI</code></pre>

<h3>Problem: "Too many required checks"</h3>

<p><strong>Cause:</strong> Some checks are failing/flaky</p>

<p><strong>Solution:</strong></p>
<ol>
<li>Check CI_FAILURES_ANALYSIS.md for pre-existing issues</li>
<li>Remove pre-existing failing checks from required list (temporary)</li>
<li>Add them back after fixing in Phase 2-4</li>
</ol>

<h3>Problem: "Admin override not working"</h3>

<p><strong>Cause:</strong> "Include administrators" is checked</p>

<p><strong>Solution:</strong></p>
<ul>
<li>This is INTENTIONAL! It's a best practice</li>
<li>If you really need to override (emergency):</li>
</ul>
<ol>
<li>Temporarily disable protection</li>
<li>Make change</li>
<li>Re-enable protection immediately</li>
<li>Document why in commit message</li>
</ol>

<p>---</p>

<h2>ğŸ“š Additional Resources</h2>

<p><strong>GitHub Documentation:</strong></p>
<ul>
<li>[About protected branches](https://docs.github.com/en/repositories/configuring-branches-and-merges-in-your-repository/managing-protected-branches/about-protected-branches)</li>
<li>[Managing a branch protection rule](https://docs.github.com/en/repositories/configuring-branches-and-merges-in-your-repository/managing-protected-branches/managing-a-branch-protection-rule)</li>
</ul>

<p><strong>Project Documentation:</strong></p>
<ul>
<li>[GITHUB_BEST_PRACTICES.md](../analyses/GITHUB_BEST_PRACTICES.md)</li>
<li>[CI_FAILURES_ANALYSIS.md](../analyses/CI_FAILURES_ANALYSIS.md)</li>
<li>[CLAUDE.md - CI/CD Section](../../CLAUDE.md#cicd-pipeline--github-workflow-management)</li>
</ul>

<p>---</p>

<h2>ğŸ¯ Quick Configuration (TL;DR)</h2>

<p>If you just want the essentials:</p>

<p><strong>Settings â†’ Branches â†’ Add rule for <code>main</code>:</strong></p>

<pre><code>Protections:
  âœ… Require PR with 1 approval
  âœ… Dismiss stale reviews
  âœ… Require status checks:
     - Secret Scan (gitleaks)
     - Dependency Audit (pip-audit)
     - CI / Run Grep Gate
     - CI / Run smoke test
     - Quality Gates
     - No root-level DB files
  âœ… Require up-to-date branches
  âœ… Require conversation resolution
  âœ… Include administrators
  âŒ Allow force pushes: NO
  âŒ Allow deletions: NO</code></pre>

<p><strong>Time:</strong> ~5 minutes if you follow this exactly</p>

<p>---</p>

<h2>ğŸš¨ Emergency Override (Last Resort)</h2>

<p>If you MUST bypass protection (emergency only):</p>

<h3>Via GitHub UI:</h3>
<ol>
<li>Settings â†’ Branches â†’ Edit rule</li>
<li>Temporarily uncheck "Include administrators"</li>
<li>Make emergency change</li>
<li>**IMMEDIATELY** re-enable protection</li>
<li>Document in commit: `fix: emergency fix for [issue] - bypassed protection`</li>
</ol>

<h3>Via git:</h3>
<pre><code># DON'T DO THIS unless absolutely necessary
# And ONLY if you disabled "Include administrators"
git push --force origin main  # DANGEROUS!</code></pre>

<p><strong>âš ï¸ WARNING:</strong> Document every bypass in:</p>
<ul>
<li>Commit message</li>
<li>PR description (if you create one after)</li>
<li>Team chat/documentation</li>
</ul>

<p>---</p>

<h2>âœ… Success Criteria</h2>

<p>You've successfully configured branch protection when:</p>

<ol>
<li>âœ… Direct push to main is rejected</li>
<li>âœ… PR requires 1 approval before merge</li>
<li>âœ… Required CI checks must pass</li>
<li>âœ… Stale reviews are dismissed on new commits</li>
<li>âœ… Force push is blocked</li>
<li>âœ… Branch deletion is blocked</li>
<li>âœ… Administrators are included in rules</li>
</ol>

<p><strong>Verification:</strong> Create and try to merge a test PR without approval â†’ Should be blocked âœ…</p>

<p>---</p>

<h2>ğŸ“ Post-Setup Checklist</h2>

<p>After configuration:</p>

<ul>
<li>[ ] Test direct push (should fail)</li>
<li>[ ] Test PR creation (should work)</li>
<li>[ ] Test merge without approval (should fail)</li>
<li>[ ] Test merge without passing checks (should fail)</li>
<li>[ ] Document configuration in team docs</li>
<li>[ ] Notify team about new workflow</li>
<li>[ ] Update onboarding docs with new process</li>
<li>[ ] Add to CLAUDE.md reference (already done âœ…)</li>
</ul>

<p>---</p>

<p><strong>Last Updated:</strong> 2025-10-19  </p>
<p><strong>Next Review:</strong> After Phase 2 CI fixes complete</p>


  </div>
</body>
</html>