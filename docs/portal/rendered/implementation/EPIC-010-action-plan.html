<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EPIC-010 Implementatieplan - Context Flow & Orchestration Fixes</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">‚Üê Terug naar Portal</a>
    <h1>EPIC-010 Implementatieplan - Context Flow & Orchestration Fixes</h1>

<h2>Overzicht</h2>
<p>Dit document bevat het gedetailleerde actieplan voor het oplossen van de functioneel relevante issues in EPIC-010.</p>

<p><strong>Datum</strong>: 2025-01-10</p>
<p><strong>Status</strong>: READY FOR IMPLEMENTATION</p>
<p><strong>Geschatte doorlooptijd</strong>: 2-3 dagen</p>

<h2>Prioriteit 1: Voorbeelden UI Bug Fix üî¥ KRITIEK</h2>

<h3>Probleem</h3>
<p>Voorbeelden worden gegenereerd maar alleen prompts zijn zichtbaar in UI, niet de content.</p>

<h3>Root Cause Analyse Stappen</h3>

<h4>Stap 1: Debug Logging Implementatie (30 min)</h4>
<p>Voeg tijdelijke debug logging toe op 4 kritieke punten:</p>

<pre><code># 1. src/services/orchestrators/definition_orchestrator_v2.py:439
# Na voorbeelden generatie, voor metadata assignment
logger.info(
    "V2: voorbeelden generated for %s: keys=%s sizes=%s",
    sanitized_request.begrip,
    list(voorbeelden.keys()) if isinstance(voorbeelden, dict) else type(voorbeelden),
    {k: (len(v) if isinstance(v, list) else len(v) if isinstance(v, str) else type(v).__name__)
     for k, v in (voorbeelden or {}).items()}
)

# 2. src/services/service_factory.py:260
# In to_ui_response() na metadata.get("voorbeelden")
logger.debug(
    "Adapter: metadata.voorbeelden present=%s keys=%s",
    bool(metadata.get("voorbeelden")),
    list((metadata.get("voorbeelden") or {}).keys()) if isinstance(metadata.get("voorbeelden"), dict) else type(metadata.get("voorbeelden"))
)

# 3. src/ui/components/definition_generator_tab.py:940
# Voor _render_voorbeelden_section() aanroep
voorbeelden = agent_result.get("voorbeelden", {})
logger.debug(
    "UI: voorbeelden present=%s keys=%s sizes=%s",
    bool(voorbeelden),
    list((voorbeelden or {}).keys()) if isinstance(voorbeelden, dict) else type(voorbeelden),
    {k: (len(v) if isinstance(v, list) else len(v) if isinstance(v, str) else type(v).__name__)
     for k, v in (voorbeelden or {}).items()}
)

# 4. src/ui/tabbed_interface.py (bij session state opslag)
logger.debug(
    "UI-store: voorbeelden keys=%s sizes=%s",
    list((agent_result.get("voorbeelden") or {}).keys()) if isinstance(agent_result.get("voorbeelden"), dict) else type(agent_result.get("voorbeelden")),
    {k: (len(v) if isinstance(v, list) else len(v) if isinstance(v, str) else type(v).__name__)
     for k, v in (agent_result.get("voorbeelden") or {}).items()}
)</code></pre>

<h4>Stap 2: Test Scenario (15 min)</h4>
<ol>
<li>Start app met: `OPENAI_API_KEY="$OPENAI_API_KEY_PROD" PYTHONPATH=. streamlit run src/main.py --logger.level=debug`</li>
<li>Genereer definitie voor "verdachte"</li>
<li>Analyseer logs in volgorde: V2 ‚Üí Adapter ‚Üí UI-store ‚Üí UI-render</li>
<li>Identificeer waar voorbeelden leeg worden</li>
</ol>

<h4>Stap 3: Fix Implementatie (1-2 uur)</h4>
<p>Gebaseerd op logging resultaten, mogelijke fixes:</p>
<ul>
<li>Als leeg in V2: Check unified_voorbeelden generator</li>
<li>Als leeg in Adapter: Check metadata doorvoer</li>
<li>Als leeg in UI-store: Check agent_result constructie</li>
<li>Als leeg in UI-render: Check conditionele rendering logica</li>
</ul>

<h3>Verificatie</h3>
<ul>
<li>[ ] Alle 6 voorbeeldtypes zichtbaar (voorbeeldzinnen, praktijk, tegen, synoniemen, antoniemen, toelichting)</li>
<li>[ ] Correcte aantallen (5 voor synoniemen/antoniemen, 3 voor anderen, 1 voor toelichting)</li>
<li>[ ] Prompts EN content beide zichtbaar</li>
</ul>

<p>---</p>

<h2>Prioriteit 2: Cache Strategy Fix üü° BELANGRIJK</h2>

<h3>Probleem</h3>
<p>Cache key mist <code>example_type</code> waardoor verschillende types dezelfde cache entry gebruiken.</p>

<h3>Implementatie</h3>

<h4>Stap 1: Update Cache Key Generation (30 min)</h4>
<p><strong>File</strong>: <code>src/utils/cache.py</code></p>

<pre><code># Regel 79-88 vervangen door:
def _generate_cache_key(self, *args, **kwargs) -&gt; str:
    """Generate cache key from function arguments including example_type."""
    # Extract example_type if present in args or kwargs
    example_type = None
    if args and hasattr(args[0], 'example_type'):
        example_type = args[0].example_type.value if hasattr(args[0].example_type, 'value') else str(args[0].example_type)
    elif 'example_type' in kwargs:
        example_type = kwargs['example_type']

    # Build key components
    key_parts = {
        "args": args,
        "kwargs": sorted(kwargs.items()),
        "example_type": example_type  # Explicitly include
    }

    content = json.dumps(key_parts, sort_keys=True, default=str)
    return hashlib.md5(content.encode()).hexdigest()</code></pre>

<h4>Stap 2: Implementeer TTL per Type (20 min)</h4>
<p><strong>File</strong>: <code>src/voorbeelden/unified_voorbeelden.py</code></p>

<p>Voeg toe na regel 45:</p>
<pre><code># Cache TTL configuratie per example type
CACHE_TTL_BY_TYPE = {
    ExampleType.SYNONIEMEN: 7200,      # 2 uur - verandert zelden
    ExampleType.ANTONIEMEN: 7200,      # 2 uur - verandert zelden
    ExampleType.VOORBEELDZINNEN: 3600, # 1 uur - kan vari√´ren
    ExampleType.PRAKTIJKVOORBEELDEN: 1800, # 30 min - context-afhankelijk
    ExampleType.TEGENVOORBEELDEN: 1800,    # 30 min - context-afhankelijk
    ExampleType.TOELICHTING: 900           # 15 min - zeer context-specifiek
}</code></pre>

<h4>Stap 3: Re-enable Caching (10 min)</h4>
<p>Verwijder de cache disable in unified_voorbeelden.py en gebruik TTL:</p>
<pre><code>@cached(ttl=lambda req: CACHE_TTL_BY_TYPE.get(req.example_type, 3600))
def _generate_cached(self, request: ExampleRequest) -&gt; list[str]:
    """Cached generation with type-specific TTL."""
    # Existing implementation</code></pre>

<h3>Verificatie</h3>
<ul>
<li>[ ] Test met zelfde begrip, verschillende example_types</li>
<li>[ ] Verify verschillende cache keys worden gegenereerd</li>
<li>[ ] Check dat synoniemen/antoniemen altijd 5 items returnen</li>
<li>[ ] Verify cache hits in logs</li>
</ul>

<p>---</p>

<h2>Prioriteit 3: Context Harmonisatie Fix üü¢ MINOR</h2>

<h3>Probleem</h3>
<p>Kleine inconsistentie in UI validatie context mapping.</p>

<h3>Implementatie (5 min)</h3>

<p><strong>File</strong>: <code>src/ui/tabbed_interface.py</code></p>
<p><strong>Regel</strong>: 921</p>

<pre><code># VOOR (regel 921):
"wettelijk": context_data.get("wettelijke_basis", []),

# NA:
"wettelijk": wet_context,  # EPIC-010: Consistente variabele gebruik</code></pre>

<h3>Verificatie</h3>
<ul>
<li>[ ] Validatie gebruikt dezelfde context als generatie</li>
<li>[ ] Geen functionele wijziging in gedrag</li>
<li>[ ] Context consistent door hele flow</li>
</ul>

<p>---</p>

<h2>Prioriteit 4: Legacy Routes Documentatie üü¢ DOCUMENTATIE</h2>

<h3>Voor US-043 (Legacy routes removal)</h3>

<h4>Stap 1: Markeer Legacy in Code (10 min)</h4>

<p><strong>File</strong>: <code>src/integration/definitie_checker.py</code></p>
<p>Voeg comment toe boven regels 205 en 255:</p>
<pre><code># TODO: US-043 - Legacy DefinitieAgent pad, gebruik generate_with_integrated_service() voor V2
agent_result = self.agent.generate_definition(...)</code></pre>

<p><strong>File</strong>: <code>src/ui/components/orchestration_tab.py</code></p>
<p>Voeg comment toe boven regel 48:</p>
<pre><code># TODO: US-043 - Legacy DefinitieAgent gebruik, migreer naar V2 orchestrator
self.agent = self.DefinitieAgent(max_iterations=1)</code></pre>

<h4>Stap 2: Documenteer V2 Alternatief (15 min)</h4>

<p>Maak notitie in code:</p>
<pre><code># V2 ALTERNATIEF:
# from services.service_factory import get_definition_service
# service = get_definition_service()
# result = service.generate_definition(...)</code></pre>

<p>---</p>

<h2>Test Protocol</h2>

<h3>Smoke Test (5 min)</h3>
<ol>
<li>Genereer definitie voor "verdachte"</li>
<li>Check alle voorbeelden zichtbaar</li>
<li>Check synoniemen = 5 items</li>
<li>Valideer context wordt gebruikt</li>
</ol>

<h3>Regression Test (10 min)</h3>
<ol>
<li>Test "Anders..." optie met custom context</li>
<li>Test meerdere begrippen achter elkaar</li>
<li>Check cache werkt (tweede keer sneller)</li>
<li>Verify geen errors in logs</li>
</ol>

<h3>Performance Test (5 min)</h3>
<ol>
<li>Meet generatie tijd eerste keer</li>
<li>Meet generatie tijd met cache (moet <100ms zijn)</li>
<li>Check memory usage stabiel</li>
</ol>

<p>---</p>

<h2>Rollout Plan</h2>

<h3>Dag 1</h3>
<ul>
<li>[ ] Implementeer debug logging (30 min)</li>
<li>[ ] Run test scenario's (15 min)</li>
<li>[ ] Identificeer root cause voorbeelden bug</li>
<li>[ ] Implementeer fix voor voorbeelden (1-2 uur)</li>
<li>[ ] Test voorbeelden fix</li>
</ul>

<h3>Dag 2</h3>
<ul>
<li>[ ] Implementeer cache key fix (30 min)</li>
<li>[ ] Implementeer TTL per type (20 min)</li>
<li>[ ] Re-enable caching (10 min)</li>
<li>[ ] Test cache functionaliteit</li>
<li>[ ] Fix context harmonisatie (5 min)</li>
</ul>

<h3>Dag 3</h3>
<ul>
<li>[ ] Documenteer legacy routes (25 min)</li>
<li>[ ] Run volledig test protocol</li>
<li>[ ] Update documentatie</li>
<li>[ ] Commit changes met duidelijke messages</li>
</ul>

<p>---</p>

<h2>Success Criteria</h2>

<ul>
<li>‚úÖ Alle voorbeelden types zichtbaar in UI</li>
<li>‚úÖ Cache werkt correct met verschillende example types</li>
<li>‚úÖ Context consistent door hele flow</li>
<li>‚úÖ Legacy routes gedocumenteerd voor US-043</li>
<li>‚úÖ Geen regressies in bestaande functionaliteit</li>
<li>‚úÖ Performance gelijk of beter</li>
</ul>

<p>---</p>

<h2>Risks & Mitigations</h2>

<p>| Risk | Impact | Mitigation |</p>
<p>|------|--------|------------|</p>
<p>| Voorbeelden fix breekt andere UI | HIGH | Uitgebreide testing, feature flag indien nodig |</p>
<p>| Cache fix veroorzaakt inconsistenties | MEDIUM | Gradual rollout, monitor cache hit rate |</p>
<p>| Context fix breekt validatie | LOW | Minimale change, goed getest |</p>

<p>---</p>

<h2>Notes</h2>

<ul>
<li>Debug logging kan verwijderd worden na fix</li>
<li>Cache monitoring blijft aan voor observability</li>
<li>Legacy routes worden in EPIC-012 volledig gerefactored</li>
<li>Overweeg feature flag voor cache re-enabling</li>
</ul>

  </div>
</body>
</html>