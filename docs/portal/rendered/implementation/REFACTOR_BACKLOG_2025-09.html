<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üîß Refactor Backlog - Sprint 37 Preparation</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">‚Üê Terug naar Portal</a>
    <h1>üîß Refactor Backlog - Sprint 37 Preparation</h1>
<p><strong>Generated:</strong> 2025-09-16</p>
<p><strong>Priority:</strong> HIGH</p>
<p><strong>Target:</strong> Sprint 37 (voor legacy deprecation deadline)</p>

<h2>üéØ Quick Wins (Day 1)</h2>
<p>| Task | Effort | Impact | Files |</p>
<p>|------|--------|--------|-------|</p>
<p>| Unify ValidationResult types | 2h | HIGH | <code>src/validation/types.py</code> (new), 3 validator files |</p>
<p>| Fix Workflow adapter | 1h | MEDIUM | <code>src/services/definition_workflow_service.py:update_status()</code> |</p>
<p>| Replace sync wrapper calls | 2h | HIGH | 3 files met <code>generate_definition_sync</code> |</p>
<p>| Cache ServiceContainer | 30m | HIGH | <code>@st.cache_resource</code> in UI components |</p>

<h2>üìã Priority Patches (Day 2-3)</h2>

<h3>Patch 1: ValidationResult Consolidation</h3>
<pre><code># NEW: src/validation/types.py
@dataclass
class ValidationResult:
    is_valid: bool
    score: float = 0.0
    violations: list[ValidationViolation] = field(default_factory=list)
    errors: list[str] = field(default_factory=list)
    warnings: list[str] = field(default_factory=list)

# Update imports in:
# - src/validation/input_validator.py
# - src/validation/definitie_validator.py
# - src/validation/dutch_text_validator.py</code></pre>

<h3>Patch 2: Async Bridge Update</h3>
<pre><code># UPDATE: src/ui/components/definition_generator_tab.py
# REMOVE: service_result = generate_definition_sync(...)
# ADD:
from ui.helpers.async_bridge import run_async
service_result = run_async(
    service_adapter.generate_definition(begrip, context_dict),
    timeout=120
)</code></pre>

<h3>Patch 3: Draft Management Implementation</h3>
<pre><code># UPDATE: src/services/definition_repository.py
def get_or_create_draft(self, begrip: str, context: dict) -&gt; int:
    """Garandeer √©√©n draft per combinatie."""
    with self._transaction() as conn:
        try:
            cursor = conn.execute(
                "INSERT INTO definities (begrip, organisatorische_context, "
                "juridische_context, categorie, status) VALUES (?, ?, ?, ?, ?)",
                (begrip, context.get("organisatorische_context"),
                 context.get("juridische_context", ""),
                 context.get("categorie", "proces"), "draft")
            )
            return cursor.lastrowid
        except sqlite3.IntegrityError:
            # Draft exists, fetch it
            ...</code></pre>

<h2>üöÄ Deployment Checklist</h2>

<h3>Pre-Sprint 37</h3>
<ul>
<li>[ ] Run `bash scripts/check-legacy-patterns.sh` - moet 0 warnings geven</li>
<li>[ ] ValidationResult types geconsolideerd</li>
<li>[ ] Alle `generate_definition_sync` calls vervangen</li>
<li>[ ] ServiceContainer caching actief</li>
<li>[ ] Draft management werkend (US-064)</li>
</ul>

<h3>Testing Voordat Live</h3>
<pre><code># Quick validation
pytest tests/services/test_service_factory.py -v
pytest tests/ui/test_async_bridge.py -v
pytest tests/validation/ -k "ValidationResult" -v

# Legacy pattern check
bash scripts/check-legacy-patterns.sh

# Performance check
python scripts/validation/validation-status-updater.py</code></pre>

<h2>üìä Impact Analysis</h2>

<p>| Component | Voor | Na | Verbetering |</p>
<p>|-----------|------|-----|-------------|</p>
<p>| Service Init | 6x per session | 1x cached | 83% reductie |</p>
<p>| Validation Types | 3 verschillende | 1 unified | 100% consistent |</p>
<p>| Async Handling | Mixed sync/async | Pure async bridge | Clean architecture |</p>
<p>| Draft Management | Session state | Database-driven | Stateless |</p>
<p>| CI Gates | 1 warning | 0 warnings | Sprint 37 ready |</p>

<h2>üîç Verificatie Commands</h2>

<pre><code># Check geen legacy patterns
rg "generation_result" src/ui --type py
rg "\.best_iteration" src --type py
rg "asyncio\.run" src/services --type py
rg "import streamlit" src/services --type py

# Check nieuwe patterns
rg "from ui.helpers.async_bridge import run_async" src/ui --type py
rg "ValidationResult" src/validation/types.py

# Database schema check
sqlite3 data/definities.db ".schema definities" | grep UNIQUE</code></pre>

<h2>‚ö†Ô∏è Rollback Plan</h2>

<p>Als iets misgaat:</p>
<ol>
<li>Git stash changes: `git stash`</li>
<li>Restore ServiceFactory sync wrappers (tijdelijk)</li>
<li>Re-enable legacy ValidationResult imports</li>
<li>Report issues in backlog voor volgende sprint</li>
</ol>

<h2>üìù Notes</h2>

<ul>
<li>**BELANGRIJK:** Geen nieuwe backwards compatibility toevoegen</li>
<li>Focus op refactor, niet op nieuwe features</li>
<li>Test coverage moet minimaal gelijk blijven</li>
<li>Alle changes via feature branch, niet direct op main</li>
</ul>

<p>---</p>
<p><em>Sprint 37 Deadline Compliance - Zero Legacy Patterns Required</em></p>
  </div>
</body>
</html>