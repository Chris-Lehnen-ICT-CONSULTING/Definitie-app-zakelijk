<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Implementatieplan: Synoniemen/Antoniemen & Context Flow Fixes</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">← Terug naar Portal</a>
    <h1>Implementatieplan: Synoniemen/Antoniemen & Context Flow Fixes</h1>

<h2>Overzicht</h2>
<p>Dit document beschrijft het plan voor het oplossen van drie samenhangende problemen:</p>
<ol>
<li>Cache strategie voor voorbeelden (synoniemen/antoniemen)</li>
<li>Context flow issues uit EPIC-010</li>
<li>Verificatie dat ChatGPT consistent 5 items teruggeeft</li>
</ol>

<h2>✅ UPDATE: Synoniemen/Antoniemen Werken!</h2>
<p><strong>Status:</strong> De vereenvoudigde prompts genereren nu correct 5 synoniemen en 5 antoniemen.</p>

<p><strong>Werkende oplossingen:</strong></p>
<ul>
<li>Vereenvoudigde prompts zonder overbodige context</li>
<li>UI kan zowel lijsten als strings verwerken</li>
<li>Parser krijgt correct example_type mee</li>
<li>Cache tijdelijk uitgeschakeld</li>
</ul>

<p><strong>Belangrijke bevinding:</strong> Context komt WEL degelijk in de prompts terecht (zie docs/backlog prompts).</p>
<p>EPIC-010 context flow probleem lijkt dus niet te bestaan of al opgelost te zijn.</p>

<h2>1. Betere Cache Strategie Implementeren</h2>

<h3>Probleem</h3>
<p>De huidige cache gebruikt alleen functie argumenten als key, maar mist het <code>example_type</code>.</p>
<p>Dit zorgt ervoor dat verschillende types (synoniemen vs antoniemen) dezelfde cache entry gebruiken.</p>

<h3>Oplossing</h3>

<h4>Stap 1: Update Cache Key Generation</h4>
<p><strong>Locatie:</strong> <code>src/utils/cache.py</code></p>
<pre><code>def _generate_cache_key(self, func_name: str, request: ExampleRequest) -&gt; str:
    """Generate unique cache key including example type."""
    key_parts = [
        func_name,
        request.begrip,
        request.example_type.value,  # BELANGRIJK: Include type
        str(request.max_examples),
        request.generation_mode.value
    ]
    return hashlib.md5("_".join(key_parts).encode()).hexdigest()</code></pre>

<h4>Stap 2: Implement TTL per Example Type</h4>
<p><strong>Locatie:</strong> <code>src/voorbeelden/unified_voorbeelden.py</code></p>
<pre><code>CACHE_TTL_BY_TYPE = {
    ExampleType.SYNONIEMEN: 7200,      # 2 uur - verandert zelden
    ExampleType.ANTONIEMEN: 7200,      # 2 uur - verandert zelden
    ExampleType.VOORBEELDZINNEN: 3600, # 1 uur - kan variëren
    ExampleType.PRAKTIJKVOORBEELDEN: 1800, # 30 min - context-afhankelijk
    ExampleType.TEGENVOORBEELDEN: 1800,    # 30 min - context-afhankelijk
    ExampleType.TOELICHTING: 900           # 15 min - zeer context-specifiek
}</code></pre>

<h4>Stap 3: Re-enable Caching met Fix</h4>
<pre><code>@cached(ttl=lambda req: CACHE_TTL_BY_TYPE.get(req.example_type, 3600))
def _generate_cached(self, request: ExampleRequest) -&gt; list[str]:
    """Cached generation with type-specific TTL."""
    cache_key = self._generate_cache_key("voorbeelden", request)
    # Rest of implementation</code></pre>

<h3>Verificatie</h3>
<ul>
<li>Unit test met zelfde begrip, verschillende types</li>
<li>Check dat cache keys verschillend zijn</li>
<li>Verify TTL per type werkt correct</li>
</ul>

<h2>2. Context Flow Issues uit EPIC-010</h2>

<h3>Analyse van het Probleem</h3>
<p>Volgens EPIC-010 worden context velden (juridische_context, wettelijke_basis, organisatorische_context)</p>
<p>wel verzameld in de UI maar NIET doorgegeven aan de AI prompts.</p>

<h3>User Stories te Implementeren</h3>

<h4>US-041: Fix Context Field Mapping to Prompts (KRITIEK)</h4>
<p><strong>Probleem:</strong> Context verdwijnt tussen UI en prompt generatie</p>

<p><strong>Fix Locaties:</strong></p>
<ol>
<li>`src/services/prompts/prompt_service_v2.py` (lines 158-176)</li>
</ol>
<ul>
<li>  - Update `_convert_request_to_context()` method</li>
<li>  - Map UI fields naar prompt context</li>
</ul>

<ol>
<li>`src/ui/tabbed_interface.py`</li>
</ol>
<ul>
<li>  - Verify context wordt correct doorgegeven in GenerationRequest</li>
</ul>

<ol>
<li>`src/services/definition_generator_context.py`</li>
</ol>
<ul>
<li>  - Ensure context fields zijn aanwezig in dataclass</li>
</ul>

<p><strong>Implementatie:</strong></p>
<pre><code>def _convert_request_to_context(self, request: GenerationRequest) -&gt; dict:
    """Convert request to context dict WITH all context fields."""
    return {
        'begrip': request.begrip,
        'organisatie': request.organisatie,
        # NIEUW: Map alle context velden
        'organisatorische_context': request.organisatorische_context or [],
        'juridische_context': request.juridische_context or [],
        'wettelijke_basis': request.wettelijke_basis or [],
    }</code></pre>

<h4>US-042: Fix "Anders..." Custom Context Option (KRITIEK)</h4>
<p><strong>Probleem:</strong> Custom context entry crashes met "default value not part of options"</p>

<p><strong>Fix Locatie:</strong> <code>src/ui/components/context_selector.py</code> (lines 137-183)</p>

<p><strong>Implementatie:</strong></p>
<pre><code>def handle_custom_context(selected_values: list, custom_text: str) -&gt; list:
    """Handle 'Anders...' option properly."""
    if "Anders..." in selected_values and custom_text:
        # Remove 'Anders...' from list
        selected_values = [v for v in selected_values if v != "Anders..."]
        # Add custom text
        selected_values.append(custom_text)
    return selected_values</code></pre>

<h4>US-043: Remove Legacy Context Routes (HOOG)</h4>
<p><strong>Legacy routes te verwijderen:</strong></p>
<ol>
<li>Direct `context` field (string) - DEPRECATED</li>
<li>`domein` field separate from context - DEPRECATED</li>
<li>V1 orchestrator context passing - REMOVED</li>
<li>Session state context storage - REFACTOR</li>
</ol>

<p><strong>Implementatie:</strong></p>
<ul>
<li>Identificeer alle legacy paths</li>
<li>Create migration functions</li>
<li>Update alle references</li>
<li>Remove deprecated code</li>
</ul>

<h3>Data Flow Fix</h3>
<p><strong>Huidige flow (BROKEN):</strong></p>
<pre><code>UI → Session State → [LOST] → GenerationRequest → PromptService → Empty Prompt</code></pre>

<p><strong>Target flow (FIXED):</strong></p>
<pre><code>UI → Validated Context Lists → GenerationRequest → PromptService → Complete Prompt</code></pre>

<h2>3. Test Plan voor 5 Items Verificatie</h2>

<h3>Automated Test Suite</h3>
<p><strong>Locatie:</strong> <code>tests/test_voorbeelden_generation.py</code></p>

<pre><code>@pytest.mark.parametrize("begrip,expected_count", [
    ("verdachte", 5),
    ("rechter", 5),
    ("strafbaar feit", 5),
])
def test_synoniemen_always_returns_5(begrip, expected_count):
    """Verify synoniemen generation always returns exactly 5 items."""
    result = genereer_synoniemen(begrip, "", {})
    assert len(result) == expected_count
    assert all(isinstance(item, str) for item in result)
    assert all(len(item) &gt; 1 for item in result)</code></pre>

<h3>Manual Test Protocol</h3>
<ol>
<li>**Test verschillende begrippen:**</li>
</ol>
<ul>
<li>  - Simpele termen: "verdachte", "rechter"</li>
<li>  - Complexe termen: "strafbaar feit", "voorlopige hechtenis"</li>
<li>  - Rare termen: "hoger beroep", "cassatie"</li>
</ul>

<ol>
<li>**Test met/zonder context:**</li>
</ol>
<ul>
<li>  - Zonder context: alleen begrip</li>
<li>  - Met organisatorische context</li>
<li>  - Met juridische context</li>
<li>  - Met alle context types</li>
</ul>

<ol>
<li>**Test caching:**</li>
</ol>
<ul>
<li>  - Eerste request: check 5 items</li>
<li>  - Tweede request (cached): verify nog steeds 5 items</li>
<li>  - Clear cache, test opnieuw</li>
</ul>

<h3>Monitoring & Logging</h3>
<pre><code># Add monitoring in _parse_response
if is_synonym_or_antonym:
    logger.info(f"Parsing {example_type}: Raw response has {len(lines)} lines")
    logger.info(f"After filtering: {len(examples)} items")
    if len(examples) != 5:
        logger.warning(f"Expected 5 {example_type} but got {len(examples)}")</code></pre>

<h2>Implementatie Volgorde</h2>

<h3>Fase 1: Quick Wins (1-2 uur)</h3>
<ol>
<li>✅ Re-enable caching met betere key generation</li>
<li>✅ Add debug logging voor monitoring</li>
<li>✅ Create basic test suite</li>
</ol>

<h3>Fase 2: Context Flow (3-4 uur)</h3>
<ol>
<li>⏳ Fix US-041: Context field mapping</li>
<li>⏳ Fix US-042: "Anders..." option</li>
<li>⏳ Add context validation</li>
</ol>

<h3>Fase 3: Clean-up (2-3 uur)</h3>
<ol>
<li>⏳ Remove legacy routes (US-043)</li>
<li>⏳ Consolidate context handling</li>
<li>⏳ Update documentation</li>
</ol>

<h3>Fase 4: Verificatie (1 uur)</h3>
<ol>
<li>⏳ Run full test suite</li>
<li>⏳ Manual testing protocol</li>
<li>⏳ Performance check</li>
</ol>

<h2>Success Criteria</h2>

<h3>Technisch</h3>
<ul>
<li>[ ] Cache keys bevatten example_type</li>
<li>[ ] Context fields verschijnen in prompts</li>
<li>[ ] "Anders..." optie werkt zonder crashes</li>
<li>[ ] Altijd exact 5 synoniemen/antoniemen</li>
</ul>

<h3>Business</h3>
<ul>
<li>[ ] Definities bevatten juridische context</li>
<li>[ ] Gebruikers kunnen custom context invoeren</li>
<li>[ ] Performance blijft onder 5 seconden</li>
<li>[ ] Zero context-gerelateerde errors in logs</li>
</ul>

<h2>Risico's & Mitigatie</h2>

<h3>Risico 1: Breaking Changes</h3>
<p><strong>Mitigatie:</strong> Gebruik feature flags voor geleidelijke rollout</p>

<h3>Risico 2: Performance Impact</h3>
<p><strong>Mitigatie:</strong> Monitor response times, optimaliseer cache TTL</p>

<h3>Risico 3: ChatGPT Inconsistentie</h3>
<p><strong>Mitigatie:</strong> Retry logic met fallback naar minder items</p>

<h2>Dependencies</h2>
<ul>
<li>EPIC-010 implementation</li>
<li>CFR-BUG-003 moet eerst opgelost zijn (GenerationResult import)</li>
<li>Test framework moet operationeel zijn</li>
</ul>

<h2>Geschatte Tijdsinvestering</h2>
<ul>
<li>**Totaal:** 7-10 uur</li>
<li>**Cache Fix:** 1-2 uur</li>
<li>**Context Flow:** 3-4 uur</li>
<li>**Testing:** 2-3 uur</li>
<li>**Documentation:** 1 uur</li>
</ul>

  </div>
</body>
</html>