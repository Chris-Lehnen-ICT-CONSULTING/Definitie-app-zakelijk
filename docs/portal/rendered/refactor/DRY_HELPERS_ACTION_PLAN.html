<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DRY Helpers Simplification Action Plan</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">← Terug naar Portal</a>
    <h1>DRY Helpers Simplification Action Plan</h1>

<h2>Executive Summary</h2>

<p>The Definitie-app has a well-designed <code>dry_helpers.py</code> module that is <strong>NOT BEING USED</strong> despite addressing exactly the duplicate patterns found throughout the codebase. This plan outlines practical steps to leverage these existing helpers for immediate code reduction.</p>

<h2>Current State Analysis</h2>

<h3>Available DRY Helpers (Already Implemented!)</h3>

<ol>
<li>**Dictionary Operations** (addresses 1630+ .get() calls)</li>
</ol>
<ul>
<li>  - `safe_dict_get()` - Safe dictionary access with type checking</li>
<li>  - `get_nested_dict_value()` - Nested dictionary traversal</li>
<li>  - `ensure_dict()`, `ensure_list()`, `ensure_string()` - Type coercion</li>
</ul>

<ol>
<li>**Session State Management** (100+ occurrences in UI)</li>
</ol>
<ul>
<li>  - `get_session_value()` - Replace `st.session_state.get()`</li>
<li>  - `set_session_value()` - Consistent state setting</li>
<li>  - `ensure_session_value()` - Initialize with factory</li>
</ul>

<ol>
<li>**Service Container Access** (50+ occurrences)</li>
</ol>
<ul>
<li>  - `get_service_container()` - With validation</li>
<li>  - `safe_get_service_container()` - With fallback</li>
</ul>

<ol>
<li>**Error Handling** (20+ files with try-except patterns)</li>
</ol>
<ul>
<li>  - `safe_execute()` - Function execution with error handling</li>
<li>  - `error_handler()` - Decorator for consistent error handling</li>
<li>  - `show_error_in_ui()` - UI error display with logging</li>
</ul>

<ol>
<li>**Validation Processing** (45+ validation rules)</li>
</ol>
<ul>
<li>  - `process_validation_result()` - Extract score and violations</li>
<li>  - `is_validation_acceptable()` - Check acceptance status</li>
</ul>

<h2>Priority 1: Quick Wins (Highest Impact, Easiest Implementation)</h2>

<h3>1.1 Replace Dictionary .get() Calls</h3>
<p><strong>Files:</strong> 203 files with 1630 occurrences</p>
<p><strong>Pattern to Replace:</strong></p>
<pre><code># BEFORE (service_factory.py lines 166-172)
violations.append({
    "rule_id": v.get("rule_id", v.get("code", "unknown")),
    "severity": self._normalize_severity(v.get("severity")),
    "description": v.get("description", v.get("message", "")),
    "suggestion": v.get("suggestion"),
})

# AFTER
from utils.dry_helpers import safe_dict_get
violations.append({
    "rule_id": safe_dict_get(v, "rule_id", safe_dict_get(v, "code", "unknown")),
    "severity": self._normalize_severity(safe_dict_get(v, "severity")),
    "description": safe_dict_get(v, "description", safe_dict_get(v, "message", "")),
    "suggestion": safe_dict_get(v, "suggestion"),
})</code></pre>

<p><strong>Top Files to Update First:</strong></p>
<ol>
<li>`/src/services/service_factory.py` (29 occurrences)</li>
<li>`/src/ui/components/orchestration_tab.py` (46 occurrences)</li>
<li>`/src/services/validation/modular_validation_service.py` (18 occurrences)</li>
<li>`/src/services/definition_edit_service.py` (25 occurrences)</li>
</ol>

<h3>1.2 Streamlit Session State Access</h3>
<p><strong>Files:</strong> All UI components</p>
<p><strong>Pattern to Replace:</strong></p>
<pre><code># BEFORE (ui/helpers/ui_helpers.py line 74)
container = st.session_state.get("service_container")

# AFTER
from utils.dry_helpers import get_session_value
container = get_session_value("service_container")</code></pre>

<p><strong>Top Files:</strong></p>
<ol>
<li>`/src/ui/session_state.py` (30+ occurrences)</li>
<li>`/src/ui/tabbed_interface.py` (28 occurrences)</li>
<li>`/src/ui/components/quality_control_tab.py` (23 occurrences)</li>
</ol>

<h3>1.3 Service Container Access</h3>
<p><strong>Pattern to Replace:</strong></p>
<pre><code># BEFORE (multiple files)
container = st.session_state.get('service_container')
if not container:
    st.error("Service container not initialized")
    return

# AFTER
from utils.dry_helpers import safe_get_service_container
container = safe_get_service_container()
if not container:
    return</code></pre>

<h2>Priority 2: Error Handling Consolidation</h2>

<h3>2.1 Try-Except Patterns</h3>
<p><strong>Files:</strong> 20+ files with repeated error handling</p>
<p><strong>Pattern to Replace:</strong></p>
<pre><code># BEFORE (service_factory.py lines 433-440)
try:
    validator_service = getattr(self.container, "validator", None)
    if callable(validator_service):
        val = validator_service()
        if hasattr(val, "get_stats"):
            stats["validator"] = val.get_stats()
except Exception:
    pass

# AFTER
from utils.dry_helpers import safe_execute
stats["validator"] = safe_execute(
    lambda: self.container.validator().get_stats() if hasattr(self.container, 'validator') else None,
    default=None
)</code></pre>

<h3>2.2 Logger Initialization</h3>
<p><strong>Pattern to Replace:</strong></p>
<pre><code># BEFORE (every file)
logger = logging.getLogger(__name__)

# AFTER
from utils.dry_helpers import get_logger
logger = get_logger(__name__)</code></pre>

<h2>Priority 3: Validation Result Processing</h2>

<h3>3.1 Validation Normalization</h3>
<p><strong>Current:</strong> Complex extraction logic in service_factory.py (lines 210-244)</p>
<p><strong>Replace with:</strong></p>
<pre><code>from utils.dry_helpers import process_validation_result, is_validation_acceptable

# Simplified normalization
score, violations = process_validation_result(result)
is_acceptable = is_validation_acceptable(result, threshold=0.5)</code></pre>

<h2>Implementation Strategy</h2>

<h3>Phase 1: Import and Test (Week 1)</h3>
<ol>
<li>Add imports to top 5 highest-usage files</li>
<li>Replace 10-20 instances per file</li>
<li>Run existing tests to verify behavior preservation</li>
<li>Document any edge cases found</li>
</ol>

<h3>Phase 2: Systematic Rollout (Week 2)</h3>
<ol>
<li>Update remaining files by category:</li>
</ol>
<ul>
<li>  - UI components (ui/components/*.py)</li>
<li>  - Services (services/*.py)</li>
<li>  - Validation rules (toetsregels/*.py)</li>
</ul>
<ol>
<li>Run full test suite after each category</li>
</ol>

<h3>Phase 3: Remove Dead Code (Week 3)</h3>
<ol>
<li>Identify helper functions that duplicate dry_helpers.py</li>
<li>Replace all calls to duplicate helpers</li>
<li>Delete duplicate helper functions</li>
<li>Update imports</li>
</ol>

<h2>Expected Impact</h2>

<h3>Code Reduction</h3>
<ul>
<li>**Dictionary operations:** ~500 lines removed (3 lines → 1 line)</li>
<li>**Error handling:** ~200 lines removed (6 lines → 1 line)</li>
<li>**Session state:** ~150 lines removed (2-4 lines → 1 line)</li>
<li>**Total estimated reduction:** 850+ lines (~10% of codebase)</li>
</ul>

<h3>Quality Improvements</h3>
<ul>
<li>Consistent error handling across all modules</li>
<li>Type safety for dictionary operations</li>
<li>Centralized logging configuration</li>
<li>Reduced cognitive load from repeated patterns</li>
</ul>

<h3>Performance</h3>
<ul>
<li>Potential for caching optimizations in central helpers</li>
<li>Reduced function call overhead from consolidated logic</li>
<li>Better memory usage from shared utility instances</li>
</ul>

<h2>Migration Checklist</h2>

<h3>Per-File Migration Steps</h3>
<ol>
<li>[ ] Add import: `from utils.dry_helpers import ...`</li>
<li>[ ] Identify patterns:</li>
</ol>
<ul>
<li>  - [ ] `.get()` calls</li>
<li>  - [ ] `st.session_state.get()`</li>
<li>  - [ ] `try/except Exception`</li>
<li>  - [ ] `if not isinstance()`</li>
</ul>
<ol>
<li>[ ] Replace with appropriate helper</li>
<li>[ ] Run file-specific tests</li>
<li>[ ] Commit with message: "refactor: Apply DRY helpers to [filename]"</li>
</ol>

<h3>Testing Requirements</h3>
<ul>
<li>[ ] All existing unit tests pass</li>
<li>[ ] Integration tests pass</li>
<li>[ ] Smoke tests pass</li>
<li>[ ] Manual UI testing for modified components</li>
</ul>

<h2>Risk Mitigation</h2>

<h3>Low Risk Changes (Do First)</h3>
<ul>
<li>Logger initialization (no behavior change)</li>
<li>Simple .get() replacements</li>
<li>Type checking helpers</li>
</ul>

<h3>Medium Risk Changes</h3>
<ul>
<li>Session state management (UI interaction)</li>
<li>Service container access</li>
<li>Error handler decorators</li>
</ul>

<h3>High Risk Changes (Do Last)</h3>
<ul>
<li>Complex nested dictionary operations</li>
<li>Validation result processing</li>
<li>Async error handling</li>
</ul>

<h2>Success Metrics</h2>

<ol>
<li>**Code Coverage:** Maintain or improve current coverage</li>
<li>**Performance:** No regression in response times</li>
<li>**Maintainability:** Reduced cyclomatic complexity</li>
<li>**Bug Rate:** No increase in bug reports</li>
<li>**Developer Velocity:** Faster implementation of new features</li>
</ol>

<h2>Next Steps</h2>

<ol>
<li>**Immediate:** Start with service_factory.py as proof of concept</li>
<li>**This Week:** Update top 10 files with most duplications</li>
<li>**Next Sprint:** Complete migration of all UI components</li>
<li>**Future:** Consider additional helpers for newly identified patterns</li>
</ol>

<h2>Appendix: Helper Function Mapping</h2>

<p>| Current Pattern | DRY Helper | Occurrences |</p>
<p>|-----------------|------------|-------------|</p>
<p>| <code>dict.get(key, default)</code> | <code>safe_dict_get()</code> | 1630 |</p>
<p>| <code>st.session_state.get()</code> | <code>get_session_value()</code> | 100+ |</p>
<p>| <code>try...except Exception</code> | <code>safe_execute()</code> or <code>@error_handler</code> | 50+ |</p>
<p>| <code>if not isinstance()</code> | <code>validate_type()</code> | 40+ |</p>
<p>| <code>result.get('score', 0.0)</code> | <code>process_validation_result()</code> | 30+ |</p>
<p>| <code>logging.getLogger(__name__)</code> | <code>get_logger()</code> | 200+ |</p>

<h2>Conclusion</h2>

<p>The dry_helpers.py module is a <strong>ready-to-use solution</strong> that addresses the exact duplication patterns identified. Implementation requires no new code, only systematic replacement of existing patterns with helper function calls. This is a pure refactoring exercise with high impact and low risk.</p>
  </div>
</body>
</html>