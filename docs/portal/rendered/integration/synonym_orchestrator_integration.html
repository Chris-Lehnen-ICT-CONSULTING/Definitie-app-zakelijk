<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SynonymOrchestrator Integration Guide</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">← Terug naar Portal</a>
    <h1>SynonymOrchestrator Integration Guide</h1>

<p><strong>Status:</strong> PHASE 2.1 Complete - Ready for ServiceContainer Integration</p>
<p><strong>Date:</strong> 2025-10-09</p>
<p><strong>Architecture:</strong> Synonym Orchestrator Architecture v3.1</p>

<p>---</p>

<h2>Overview</h2>

<p>Deze guide beschrijft hoe SynonymOrchestrator geïntegreerd wordt in de ServiceContainer</p>
<p>en hoe de cache invalidation callbacks geconfigureerd worden.</p>

<h2>Components Created</h2>

<h3>1. GPT4SynonymSuggester (Placeholder)</h3>

<p><strong>Location:</strong> <code>src/services/gpt4_synonym_suggester.py</code></p>

<p><strong>Status:</strong> Placeholder implementation (returns empty list)</p>

<pre><code>from services.gpt4_synonym_suggester import GPT4SynonymSuggester

suggester = GPT4SynonymSuggester()
suggestions = await suggester.suggest_synonyms("voorlopige hechtenis")
# Returns: [] (placeholder)</code></pre>

<p><strong>Future Work:</strong> Implement GPT-4 API integration in later phase</p>

<h3>2. SynonymOrchestrator (Complete)</h3>

<p><strong>Location:</strong> <code>src/services/synonym_orchestrator.py</code></p>

<p><strong>Features:</strong></p>
<ul>
<li>✅ TTL cache met thread-safe locking</li>
<li>✅ Governance policy enforcement (STRICT vs PRAGMATIC)</li>
<li>✅ GPT-4 enrichment flow (with placeholder)</li>
<li>✅ Cache invalidation callbacks</li>
<li>✅ Comprehensive error handling</li>
<li>✅ Metrics tracking (hit rate, stats)</li>
</ul>

<p><strong>Lines of Code:</strong> ~450 lines</p>

<p>---</p>

<h2>ServiceContainer Integration</h2>

<h3>Step 1: Add Imports</h3>

<p>Add to <code>src/services/container.py</code>:</p>

<pre><code>from services.synonym_orchestrator import SynonymOrchestrator
from services.gpt4_synonym_suggester import GPT4SynonymSuggester
from repositories.synonym_registry import get_synonym_registry</code></pre>

<h3>Step 2: Initialize Services</h3>

<p>Add method to ServiceContainer class:</p>

<pre><code>def _init_synonym_services(self):
    """Initialize synonym-related services."""
    # Get registry instance
    registry = get_synonym_registry(self.db_path)

    # Create GPT-4 suggester
    gpt4_suggester = GPT4SynonymSuggester()

    # Create orchestrator
    self.synonym_orchestrator = SynonymOrchestrator(registry, gpt4_suggester)

    # Register cache invalidation callback
    registry.register_invalidation_callback(
        self.synonym_orchestrator.invalidate_cache
    )

    logger.info("Synonym orchestrator initialized with cache invalidation callback")</code></pre>

<h3>Step 3: Call During Container Init</h3>

<p>Add to <code>ServiceContainer.__init__()</code>:</p>

<pre><code>def __init__(self, db_path: str = "data/definities.db", ...):
    # ... existing init code ...

    # Initialize synonym services
    self._init_synonym_services()

    # ... rest of init ...</code></pre>

<h3>Step 4: Add Getter Method</h3>

<p>Add property to ServiceContainer:</p>

<pre><code>@property
def synonym_orchestrator(self) -&gt; SynonymOrchestrator:
    """Get synonym orchestrator instance."""
    return self._synonym_orchestrator

@synonym_orchestrator.setter
def synonym_orchestrator(self, value: SynonymOrchestrator):
    """Set synonym orchestrator instance."""
    self._synonym_orchestrator = value</code></pre>

<p>---</p>

<h2>Cache Invalidation Flow</h2>

<h3>Callback Registration</h3>

<pre><code>┌─────────────────────────────────────────────────┐
│         ServiceContainer.__init__()             │
└─────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────┐
│     registry.register_invalidation_callback(    │
│       orchestrator.invalidate_cache             │
│     )                                            │
└─────────────────────────────────────────────────┘</code></pre>

<h3>Invalidation Trigger</h3>

<pre><code>User edits synonym → registry.add_group_member()
                    ↓
                registry._trigger_invalidation(term)
                    ↓
                orchestrator.invalidate_cache(term)
                    ↓
                Cache entry deleted
                    ↓
                Next query = cache MISS → fresh data</code></pre>

<p>---</p>

<h2>Usage Examples</h2>

<h3>Basic Query</h3>

<pre><code>from services.container import ServiceContainer

container = ServiceContainer()
orchestrator = container.synonym_orchestrator

# Query synonyms
synonyms = orchestrator.get_synonyms_for_lookup(
    term="voorlopige hechtenis",
    max_results=5,
    min_weight=0.7
)

print(f"Found {len(synonyms)} synonyms")
for syn in synonyms:
    print(f"  - {syn.term} (weight: {syn.weight}, status: {syn.status})")</code></pre>

<h3>Enrichment Flow</h3>

<pre><code>import asyncio

# Ensure minimum synonyms (with GPT-4 enrichment if needed)
synonyms, ai_pending_count = await orchestrator.ensure_synonyms(
    term="voorlopige hechtenis",
    min_count=5,
    context={
        'definitie': "Een vrijheidsbenemende maatregel...",
        'tokens': ["strafrecht", "strafvordering"],
        'domain': 'strafrecht'
    }
)

print(f"Found {len(synonyms)} synonyms")
print(f"Added {ai_pending_count} AI suggestions (pending review)")</code></pre>

<h3>Cache Metrics</h3>

<pre><code># Get cache stats
stats = orchestrator.get_cache_stats()
print(f"Cache hit rate: {stats['hit_rate']:.1%}")
print(f"Cache size: {stats['size']}/{stats['max_size']}")
print(f"Hits: {stats['hits']}, Misses: {stats['misses']}")

# Health check
health = orchestrator.get_health_check()
print(f"Status: {health['status']}")
if health.get('warnings'):
    print(f"Warnings: {health['warnings']}")</code></pre>

<p>---</p>

<h2>Configuration</h2>

<h3>Config File Location</h3>

<p><code>config/synonym_config.yaml</code></p>

<h3>Example Configuration</h3>

<pre><code>synonym_configuration:
  # Governance policy
  policy: strict  # strict | pragmatic

  # Enrichment settings
  min_synonyms: 5
  gpt4_timeout: 30
  gpt4_max_retries: 3

  # Cache settings
  cache_ttl: 3600  # 1 hour
  cache_max_size: 1000

  # Weight thresholds
  min_weight: 0.7
  preferred_threshold: 0.95</code></pre>

<h3>Environment Variable Override</h3>

<pre><code>export SYNONYM_CONFIG_PATH=/path/to/custom/config.yaml</code></pre>

<p>---</p>

<h2>Testing</h2>

<h3>Manual Testing Script</h3>

<p>See: <code>scripts/test_synonym_orchestrator_manual.py</code></p>

<p>Run:</p>
<pre><code>python scripts/test_synonym_orchestrator_manual.py</code></pre>

<h3>Unit Tests (Future)</h3>

<p>Will be added in PHASE 1.5:</p>
<ul>
<li>`tests/services/test_synonym_orchestrator.py`</li>
<li>`tests/services/test_gpt4_synonym_suggester.py`</li>
</ul>

<p>---</p>

<h2>Monitoring</h2>

<h3>Logging</h3>

<p>Two loggers are used:</p>

<ol>
<li>**Standard logger** (`synonym_orchestrator`):</li>
</ol>
<ul>
<li>  - Cache hits/misses</li>
<li>  - Query operations</li>
<li>  - Errors</li>
</ul>

<ol>
<li>**Enrichment logger** (`synonym_enrichment`):</li>
</ol>
<ul>
<li>  - GPT-4 enrichment start/complete</li>
<li>  - Duration tracking</li>
<li>  - Timeout/failure events</li>
</ul>

<h3>Log Format</h3>

<pre><code>2025-10-09 14:32:15 - INFO - Cache HIT for 'voorlopige hechtenis' (returned 5 results)
2025-10-09 14:32:16 - INFO - Found 5 synonyms for 'voorlopige hechtenis' (statuses: ['active'], min_weight: 0.7)
2025-10-09 14:32:45 - INFO - Starting GPT-4 enrichment for 'term' (only 2 found, need 5)
2025-10-09 14:32:53 - INFO - Enrichment complete for 'term': 3 suggestions added, duration: 8.2s</code></pre>

<h3>Metrics to Monitor</h3>

<p>| Metric | Target | Alert |</p>
<p>|--------|--------|-------|</p>
<p>| Cache hit rate | > 80% | < 60% |</p>
<p>| GPT-4 success rate | > 95% | < 90% |</p>
<p>| Avg enrichment time | < 10s | > 20s |</p>
<p>| Cache size | < 1000 | > 950 |</p>

<p>---</p>

<h2>Troubleshooting</h2>

<h3>Issue: Low Cache Hit Rate</h3>

<p><strong>Symptoms:</strong> <code>cache_hit_rate < 0.5</code></p>

<p><strong>Solutions:</strong></p>
<ol>
<li>Check TTL: `cache_ttl_seconds` te laag?</li>
<li>Check invalidation: Te veel manual edits?</li>
<li>Increase cache size: `cache_max_size` verhogen</li>
</ol>

<h3>Issue: GPT-4 Timeout</h3>

<p><strong>Symptoms:</strong> <code>asyncio.TimeoutError</code> in enrichment_logger</p>

<p><strong>Solutions:</strong></p>
<ol>
<li>Increase timeout: `gpt4_timeout_seconds` verhogen (max 300s)</li>
<li>Check GPT-4 API status</li>
<li>Review network latency</li>
</ol>

<h3>Issue: Cache Memory Growth</h3>

<p><strong>Symptoms:</strong> Cache size blijft groeien</p>

<p><strong>Solutions:</strong></p>
<ol>
<li>Check eviction: LRU logic werkend?</li>
<li>Lower max_size: `cache_max_size` verlagen</li>
<li>Lower TTL: `cache_ttl_seconds` verlagen</li>
</ol>

<p>---</p>

<h2>Next Steps</h2>

<h3>PHASE 2.2: Façade Layer</h3>

<p>Create <code>JuridischeSynoniemService</code> wrapper:</p>
<ul>
<li>`src/services/web_lookup/synonym_service.py`</li>
<li>Backward compatible API</li>
<li>Delegate to orchestrator</li>
</ul>

<h3>PHASE 2.3: Definition Generation Integration</h3>

<p>Update <code>DefinitionGenerationOrchestrator</code>:</p>
<ul>
<li>Call `ensure_synonyms()` before web lookup</li>
<li>Pass enriched synonyms to web lookup service</li>
<li>Display AI pending count in UI</li>
</ul>

<h3>PHASE 2.4: Unit Tests</h3>

<p>Create test suite:</p>
<ul>
<li>`tests/services/test_synonym_orchestrator.py`</li>
<li>Mock registry and GPT-4</li>
<li>Test cache logic, TTL, invalidation</li>
<li>Test governance policy enforcement</li>
</ul>

<p>---</p>

<h2>Architecture Compliance</h2>

<h3>Checklist</h3>

<ul>
<li>[x] TTL cache implemented with expiration check</li>
<li>[x] Thread-safe cache operations (RLock)</li>
<li>[x] Governance policy enforcement (STRICT vs PRAGMATIC)</li>
<li>[x] Cache metrics (hit rate, stats)</li>
<li>[x] GPT-4 enrichment flow (placeholder)</li>
<li>[x] Cache invalidation callback</li>
<li>[x] Error handling comprehensive</li>
<li>[x] Type hints on all methods</li>
<li>[x] Logging throughout</li>
<li>[x] Uses SynonymConfiguration</li>
<li>[x] Uses SynonymRegistry correctly</li>
<li>[x] Health check endpoint</li>
<li>[x] Follows CLAUDE.md standards</li>
</ul>

<p><strong>Status:</strong> ✅ <strong>PHASE 2.1 COMPLETE</strong></p>

<p>---</p>

<p><em>Generated: 2025-10-09</em></p>
<p><em>Architecture: Synonym Orchestrator v3.1</em></p>
<p><em>Implementation: PHASE 2.1 - Business Logic Layer</em></p>

  </div>
</body>
</html>