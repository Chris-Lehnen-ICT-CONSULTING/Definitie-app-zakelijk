<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üìã Overdracht Document - Story 2.4 ValidationOrchestratorV2 Integration</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">‚Üê Terug naar Portal</a>
    <h1>üìã Overdracht Document - Story 2.4 ValidationOrchestratorV2 Integration</h1>

<h2>üéØ Current Status</h2>

<h3>‚úÖ Completed Today (02-09-2025)</h3>

<h4>Documentation Cleanup (PRs #15, #16)</h4>
<ul>
<li>**PR #15**: Canonicalization + content corrections (MERGED)</li>
<li>**PR #16**: Doc-lint hooks + architecture consolidation (MERGED)</li>
<li>Pre-commit hooks now active for doc quality</li>
</ul>

<h4>Story 2.4 Initial Patch (PR #17)</h4>
<ul>
<li>**PR #17**: DEV_MODE guard for V2 validation (OPEN)</li>
<li>Branch: `feat/story-2.4-validation-v2-integration`</li>
<li>Safe, non-breaking change behind environment flag</li>
<li>Smoke tests included</li>
</ul>

<h2>üöÄ Next Steps - Story 2.4 Completion</h2>

<h3>Phase 1: Core Integration (Prioriteit: HOOG)</h3>
<p><strong>Estimated: 2-3 dagen</strong></p>

<h4>1.1 DefinitionOrchestratorV2 Integration</h4>
<pre><code># File: src/services/definition/definition_orchestrator_v2.py
# TODO: Replace direct validation calls with ValidationOrchestratorInterface
# - Remove validation logic from orchestrator
# - Inject ValidationOrchestratorV2 via constructor
# - Update all validation method calls</code></pre>

<h4>1.2 Service Container Wiring</h4>
<pre><code># File: src/services/container.py
# TODO: Wire ValidationOrchestratorV2 into container
# - Register ValidationOrchestratorV2 as singleton
# - Update orchestrator factory to inject validation service
# - Ensure proper async context management</code></pre>

<h4>1.3 Migration van UI Validation Calls</h4>
<p><strong>Files to update:</strong></p>
<ul>
<li>`src/ui/components/definition_tab.py` - validatie tijdens generatie</li>
<li>`src/ui/components/export_tab.py` - pre-export validatie</li>
<li>`src/ui/components/review_tab.py` - review validatie flows</li>
<li>`src/api/endpoints/validation.py` - API endpoint routing</li>
</ul>

<h3>Phase 2: Legacy Cleanup (Prioriteit: GEMIDDELD)</h3>
<p><strong>Estimated: 1 dag</strong></p>

<h4>2.1 Remove V1 Adapter Code</h4>
<pre><code># Files to remove/clean:
- src/services/validation/v1_adapter.py (remove)
- src/services/validation/definition_validator.py (deprecate)
- Legacy imports in service container</code></pre>

<h4>2.2 Update Tests</h4>
<pre><code># Test files requiring updates:
- tests/services/validation/test_orchestrator_v2.py
- tests/integration/test_validation_flow.py
- Remove dual-path test coverage</code></pre>

<h3>Phase 3: Validation & Rollout (Prioriteit: HOOG)</h3>
<p><strong>Estimated: 1 dag</strong></p>

<h4>3.1 Comprehensive Testen</h4>
<pre><code># Run full test suite
pytest tests/services/validation/ -v

# Prestaties benchmarks
python scripts/benchmark_validation.py

# Smoke tests (already created)
./run_smoke_tests.sh</code></pre>

<h4>3.2 Gradual Rollout Strategy</h4>
<ol>
<li>**Development**: DEV_MODE=true testing</li>
<li>**Staging**: Remove DEV_MODE guard, test fully on V2</li>
<li>**Production**: Deploy with monitoring</li>
</ol>

<h2>üìä Technical Decisions to Make</h2>

<h3>1. Async Pattern Choice</h3>
<pre><code># Option A: Full async chain
async def validate_definition(self, request):
    result = await self.validation_orchestrator.validate(request)

# Option B: Sync wrapper for compatibility
def validate_definition_sync(self, request):
    return asyncio.run(self.validate_async(request))</code></pre>
<p><strong>Recommendation</strong>: Option A - full async chain</p>

<h3>2. Error Handling Strategy</h3>
<pre><code># Centralized error mapping needed for:
- ValidationError ‚Üí UI-friendly messages
- Timeout handling (async operations)
- Partial validation failures</code></pre>

<h3>3. Configuration Management</h3>
<pre><code># config/validation_v2.yaml structure:
validation:
  mode: "v2"  # or "legacy"
  timeout: 30
  parallel: true
  max_workers: 4</code></pre>

<h2>üîß Quick Commands</h2>

<h3>Test V2 Validation Locally</h3>
<pre><code># Enable V2 mode
export DEV_MODE=true

# Run app
streamlit run src/main.py

# Test via API
curl -X POST localhost:8501/api/validate \
  -H "Content-Type: application/json" \
  -d '{"text": "Een test is een methode", "category": "proces"}'</code></pre>

<h3>Run Integration Tests</h3>
<pre><code># Specific V2 tests
pytest tests/services/validation/test_orchestrator_v2.py -v

# Full validation suite
pytest tests/ -k validation -v</code></pre>

<h2>‚ö†Ô∏è Risk Areas & Mitigations</h2>

<h3>Risk 1: Prestaties Regression</h3>
<ul>
<li>**Mitigation**: Benchmark before/after, keep DEV_MODE guard until verified</li>
<li>**Monitoring**: Add timing logs for validation calls</li>
</ul>

<h3>Risk 2: Async Context Issues</h3>
<ul>
<li>**Mitigation**: Proper event loop management in UI components</li>
<li>**Testen**: Concurrent request testing</li>
</ul>

<h3>Risk 3: Missing Validation Rules</h3>
<ul>
<li>**Mitigation**: Compare V1 vs V2 rule coverage</li>
<li>**Validation**: Golden test suite with known inputs/outputs</li>
</ul>

<h2>üìù Definition of Done</h2>

<h3>Story 2.4 Complete Wanneer:</h3>
<ul>
<li>[ ] All validation calls use ValidationOrchestratorV2</li>
<li>[ ] Zero references to V1 adapter in production code</li>
<li>[ ] All tests pass (unit, integration, smoke)</li>
<li>[ ] Prestaties metrics equal or better than V1</li>
<li>[ ] Documentation updated (architecture diagrams, API docs)</li>
<li>[ ] DEV_MODE guard removed after successful testing</li>
</ul>

<h2>üí° Tips for Next Developer</h2>

<ol>
<li>**Start Small**: Test one UI component at a time</li>
<li>**Use Debugging**: Set `VALIDATION_DEBUG=true` for verbose logs</li>
<li>**Check Async**: Watch for event loop issues in Streamlit</li>
<li>**Monitor Memory**: V2 may have different memory profile</li>
<li>**Keep PR Small**: Break Phase 1 into multiple PRs if needed</li>
</ol>

<h2>üìû Contact & Resources</h2>

<h3>Key Files</h3>
<ul>
<li>Story definition: `docs/backlog/stories/epic-2-story-2.4-integration-migration.md`</li>
<li>V2 Implementatie: `src/services/validation/orchestrator_v2.py`</li>
<li>Container: `src/services/container.py`</li>
<li>Smoke tests: `tests/smoke/test_validation_v2_smoke.py`</li>
</ul>

<h3>Related PRs</h3>
<ul>
<li>PR #17: Initial DEV_MODE patch</li>
<li>PR #14: Story 2.1 ValidationInterface implementation</li>
<li>PR #13: ValidationOrchestratorV2 documentation</li>
</ul>

<h3>Commands Created</h3>
<ul>
<li>`./run_smoke_tests.sh` - Quick V2 validation test</li>
<li>`export DEV_MODE=true` - Enable V2 validation</li>
</ul>

<p>---</p>

<p><em>Generated: 02-09-2025</em></p>
<p><em>Story Eigenaar: Senior Developer</em></p>
<p><em>Status: In Progress - Initial patch complete</em></p>

  </div>
</body>
</html>