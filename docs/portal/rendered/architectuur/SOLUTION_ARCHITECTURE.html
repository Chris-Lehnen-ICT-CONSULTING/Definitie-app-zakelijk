<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DefinitieAgent Solution Architecture</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">â† Terug naar Portal</a>
    <p>---</p>
<p>aangemaakt: '08-09-2025'</p>
<p>applies_to: definitie-app@current</p>
<p>bijgewerkt: '08-09-2025'</p>
<p>canonical: true</p>
<p>last_verified: 04-09-2025</p>
<p>owner: architecture</p>
<p>prioriteit: medium</p>
<p>status: active</p>
<p>---</p>



<h1>DefinitieAgent Solution Architecture</h1>

<h2>Wijzigingshistorie</h2>

<ul>
<li>28-08-2025: Modularisatie-update (delta op bestaande SA)</li>
<li> - Toegevoegd: modulaire grenzen en afhankelijkheidâ€‘regels (adapters â†’ services â†’ domain; infrastructure implementeert interfaces).</li>
<li> - Toegevoegd: stabiele contracten voor AI en prompts (AIProviderInterface, PromptBuilderInterface).</li>
<li> - Aangescherpt: Orchestratorâ€‘first; UI gebruikt uitsluitend services via factory/container (geen directe DB/SDKâ€‘imports).</li>
<li> - Toegevoegd: feature flags voor gefaseerde uitfasering (FEATURE_ORCHESTRATOR_ONLY, FEATURE_MODERN_LOOKUP, FEATURE_DISABLE_LEGACY_AFTER).</li>
<li> - Gedeprecieerd: UnifiedDefinitionGenerator en legacy Web Lookupâ€‘paden; vervanging via Orchestrator en ModernWebLookupService.</li>
<li> - Toegevoegd: NFRâ€™s voor security/observability (structured logging, metrics, costâ€‘tracking, authN/Z, encryptieâ€‘atâ€‘rest).</li>
<li> - Herijking: microservices blijft langetermijn; korteâ€‘middellange termijn is â€œmodular monolithâ€ + APIâ€‘first backend.</li>
</ul>

<h2>Executive Summary</h2>

<h3>Solution Overview</h3>
<blockquote>DefinitieAgent draait grotendeels op V2â€‘architectuur met gecentraliseerde AIâ€‘configuratie, modulaire validatieservices en clean afhankelijkheidsinjectie. Het systeem gebruikt ConfigManager voor componentâ€‘specifieke AIâ€‘instellingen. Enkele compatibiliteitsâ€‘stubs en fallbackâ€‘mechanismen bestaan nog (uitfasering gepland), conform de transitie naar een modulaire monoliet als tussenstap.</blockquote>

<h3>Technical Scope</h3>
<ul>
<li>**System**: DefinitieAgent v2.0 - Government Definition Platform</li>
<li>**Components**: 12 microservices (many pre-built), 3 databases, 8+ external integrations</li>
<li>**Architecture**: Event-driven microservices with API Gateway</li>
<li>**Prestaties**: From 8-12s to <2s response time</li>
<li>**Scale**: From single-user to 100+ concurrent users</li>
</ul>

<blockquote>Herijking 28-08-2025: Eerstvolgende stap is een modulaire monoliet met APIâ€‘first backend. De microservicesâ€‘doelarchitectuur blijft richtinggevend voor de langere termijn na stabilisatie van interfaces en NFRâ€™s.</blockquote>

<h3>Key Design Decisions</h3>
<ol>
<li>**Quality-First Migration**: Achieve 90% quality in monolith before splitting</li>
<li>**GVI Pattern**: Generation-Validation-Integration for quality assurance</li>
<li>**Session State Elimination**: Services independent of UI state for clean architecture</li>
<li>**Reuse Existing Components**: 65% of code unused but microservice-ready</li>
<li>**Event-Driven Architecture**: Loose coupling for scalability</li>
<li>**Strangler Fig Pattern**: Gradual migration from monolith</li>
</ol>

<h3>Reference to Enterprise Architecture</h3>
<ul>
<li>**Enterprise Architecture (EA)**: zie [ENTERPRISE_ARCHITECTURE.md](./ENTERPRISE_ARCHITECTURE.md)</li>
</ul>

<p>---</p>

<h2>1. System Architecture</h2>

<h3>1.1 Component Architecture</h3>

<h4>Current State (AS-IS) - Monolithic Structure</h4>
<pre><code>graph TB
    subgraph "Streamlit Monolith"
        UI[Streamlit UI]
        BL[Business Logic]
        DB[(SQLite)]
    end

    subgraph "External Services"
        OAI[OpenAI API]
        RWB[RijksWoordenboek]
    end

    UI --&gt; BL
    BL --&gt; DB
    BL --&gt; OAI
    BL --&gt; RWB</code></pre>

<p><strong>Issues Identified:</strong></p>
<ul>
<li>Single-user limitation (SQLite locks)</li>
<li>8-12 second response times</li>
<li>Memory leaks (3.2GB usage)</li>
<li>No authentication/authorization</li>
<li>65% unused code (119/182 files)</li>
</ul>

<h4>Target State (TO-BE) - Microservices Architecture</h4>
<pre><code>graph TB
    subgraph "API Gateway"
        GW[Kong Gateway]
    end

    subgraph "Core Services"
        DS[Definition Service]
        VS[Validation Service]
        ES[Enrichment Service]
        CS[Context Service]
    end

    subgraph "Support Services"
        AS[Auth Service]
        NS[Notification Service]
        MS[Monitoring Service]
    end

    subgraph "Data Layer"
        PG[(PostgreSQL)]
        RD[(Redis Cache)]
        S3[(Object Storage)]
    end

    GW --&gt; DS
    GW --&gt; VS
    DS --&gt; VS
    DS --&gt; ES
    DS --&gt; CS
    DS --&gt; PG
    DS --&gt; RD
    VS --&gt; NS
    ES --&gt; S3</code></pre>

<blockquote>Herijking 28-08-2025: Onderstaande microservicesâ€‘doelarchitectuur blijft richtinggevend, maar de kortâ€‘middellange termijn focus ligt op modulair snijden binnen de bestaande codebase. Zie sectie â€œModulaire Opzet en Legacyâ€‘Uitfasering (2025â€‘08â€‘28)â€ voor de concrete delta.</blockquote>

<h4>Discovered Microservice-Ready Components</h4>
<pre><code># Already built but unused (from analyze_unused_files.py)
Beveiliging Pipeline:
  - auth_middleware.py: Complete OAuth implementation
  - rbac_service.py: Role-based access control
  - api_key_manager.py: API key management

Validation Framework:
  - 78 validation rules in src/rules/
  - validation_orchestrator.py: Rule engine
  - quality_scorer.py: Scoring system

Async Infrastructure:
  - async_api.py: FastAPI endpoints ready
  - event_publisher.py: Event bus integration
  - message_queue.py: RabbitMQ connector

Configuration Management:
  - config_service.py: Centralized config
  - feature_flags.py: A/B testing ready
  - environment_manager.py: Multi-env support</code></pre>

<h3>1.2 Service Specifications</h3>

<p>| Service | Technology | Purpose | Status | Reuse % |</p>
<p>|---------|------------|---------|---------|----------|</p>
<p>| Definition Service | FastAPI + GVI | Core generation with quality | Refactor | 70% |</p>
<p>| Validation Service | FastAPI + Rules | Multi-layer validation | Exists | 90% |</p>
<p>| Enrichment Service | FastAPI + Async | External data integration | Exists | 85% |</p>
<p>| Context Service | FastAPI + ML | Smart context detection | Enhance | 60% |</p>
<p>| Auth Service | FastAPI + OAuth | Authentication/Authorization | Exists | 95% |</p>
<p>| API Gateway | Kong | Routing, rate limiting | New | 0% |</p>

<h3>1.3 Domain Model</h3>

<pre><code># Core Domain Model (from existing code)
class Definition:
    id: UUID
    term: str
    text: str
    context: Context
    quality_score: float
    validation_results: List[ValidationResult]
    sources: List[Source]
    metadata: Dict[str, Any]
    version: int
    created_at: datetime
    created_by: User

class ValidationResult:
    rule_id: str
    score: float
    feedback: str
    severity: Severity
    suggestions: List[str]

class Context:
    domain: str
    organization: str
    target_audience: str
    formality_level: str
    examples: List[str]</code></pre>

<h3>1.4 Detailed Component Architecture</h3>

<h4>1.4.1 High-Level Component Afhankelijkheden</h4>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          main.py                                 â”‚
â”‚                     (Entry Point)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    tabbed_interface.py                          â”‚
â”‚              (UI Controller &amp; Orchestrator)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚          â”‚          â”‚          â”‚          â”‚
       â–¼          â–¼          â–¼          â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Generator â”‚ â”‚ History  â”‚ â”‚ Export   â”‚ â”‚ Review   â”‚ â”‚Web Lookupâ”‚
â”‚   Tab    â”‚ â”‚   Tab    â”‚ â”‚   Tab    â”‚ â”‚   Tab    â”‚ â”‚   Tab    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚            â”‚            â”‚            â”‚            â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    Services     â”‚
                    â”‚  (6 Services)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Repository    â”‚
                    â”‚    (SQLite)     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>

<h4>1.4.2 Service Layer Communication Pattern</h4>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Service Communication Flow                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  UI Layer          Service Layer           Infrastructure      â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Tab UI  â”‚â”€â”€â”€â”€â”€â–¶â”‚DefinitieGen â”‚â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  OpenAI API  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   Service    â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                          â”‚                                     â”‚
â”‚                          â–¼                                     â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚                   â”‚  Validator  â”‚â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Toetsregels  â”‚   â”‚
â”‚                   â”‚   Service   â”‚        â”‚   Engine     â”‚   â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                          â”‚                                     â”‚
â”‚                          â–¼                                     â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚                   â”‚ Repository  â”‚â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   SQLite DB  â”‚   â”‚
â”‚                   â”‚  Service    â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>

<h4>1.4.3 Data Flow Sequence</h4>
<pre><code>User Request â†’ UI Tab â†’ Service Layer â†’ External API/DB â†’ Response
     â”‚              â”‚           â”‚              â”‚             â”‚
     â–¼              â–¼           â–¼              â–¼             â–¼
[Input Form]   [Validate]  [Process]    [Store/Fetch]   [Display]
                    â”‚           â”‚              â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            Error Handling</code></pre>

<h4>1.4.4 TO-BE Microservices Communication Pattern</h4>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API Gateway (Kong/AWS)                        â”‚
â”‚                 Authentication | Routing | Rate Limiting         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚          â”‚          â”‚          â”‚          â”‚
           â–¼          â–¼          â–¼          â–¼          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Auth    â”‚ â”‚Definitionâ”‚ â”‚Validationâ”‚ â”‚Enrichmentâ”‚ â”‚ Export   â”‚
    â”‚ Service  â”‚ â”‚ Service  â”‚ â”‚ Service  â”‚ â”‚ Service  â”‚ â”‚ Service  â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚            â”‚            â”‚            â”‚            â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                             â”‚
             â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
             â”‚Message Queueâ”‚              â”‚  Event Bus  â”‚
             â”‚(RabbitMQ)   â”‚              â”‚   (Kafka)   â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                             â”‚
             â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”´â”€â”€â”€â”€â”€â”€â”
             â”‚                                 â”‚        â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”‚
      â”‚ PostgreSQL  â”‚                  â”‚    Redis    â”‚ â”‚
      â”‚  (Primary)  â”‚                  â”‚   (Cache)   â”‚ â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                                                       â”‚
                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                                              â”‚ Monitoring Stackâ”‚
                                              â”‚(Prometheus/ELK) â”‚
                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>

<h4>1.4.5 Event-Driven Architecture Flow</h4>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Event-Driven Communication                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  User Action    Event Published    Services React    Results   â”‚
â”‚      â”‚                â”‚                  â”‚              â”‚      â”‚
â”‚      â–¼                â–¼                  â–¼              â–¼      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚New Def. â”‚â”€â”€â”€â–¶â”‚DEF_CREATED  â”‚â”€â”€â”€â–¶â”‚ Validation  â”‚â”€â”€â–¶â”‚Update  â”‚â”‚
â”‚ â”‚Request  â”‚    â”‚   Event     â”‚    â”‚  Service    â”‚  â”‚  UI    â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                       â”‚                  â”‚                     â”‚
â”‚                       â–¼                  â–¼                     â”‚
â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚                â”‚  Event Log  â”‚    â”‚ Enrichment  â”‚            â”‚
â”‚                â”‚  (Kafka)    â”‚    â”‚  Service    â”‚            â”‚
â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>

<h4>1.4.6 Service Mesh Architecture (Istio)</h4>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Service Mesh (Istio)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Service   â”‚         â”‚   Service   â”‚      â”‚   Service   â”‚ â”‚
â”‚  â”‚     Pod     â”‚         â”‚     Pod     â”‚      â”‚     Pod     â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚         â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚      â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚ â”‚ App     â”‚ â”‚â—€â”€â”€â”€â”€â”€â”€â–¶â”‚ â”‚ App     â”‚ â”‚â—€â”€â”€â”€â”€â–¶â”‚ â”‚ App     â”‚ â”‚ â”‚
â”‚  â”‚ â”‚Containerâ”‚ â”‚         â”‚ â”‚Containerâ”‚ â”‚      â”‚ â”‚Containerâ”‚ â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚         â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚      â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚         â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚      â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚ â”‚ Envoy   â”‚ â”‚         â”‚ â”‚ Envoy   â”‚ â”‚      â”‚ â”‚ Envoy   â”‚ â”‚ â”‚
â”‚  â”‚ â”‚ Proxy   â”‚ â”‚         â”‚ â”‚ Proxy   â”‚ â”‚      â”‚ â”‚ Proxy   â”‚ â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚         â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚      â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                        â”‚                      â”‚       â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                 â”‚                               â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚                         â”‚ Control Plane  â”‚                     â”‚
â”‚                         â”‚    (Istiod)    â”‚                     â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>

<h4>1.4.7 Domain-Driven Design Bounded Contexts</h4>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Bounded Context Map                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  Definition       â”‚         â”‚   Validation      â”‚          â”‚
â”‚  â”‚    Context        â”‚â—€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚     Context       â”‚          â”‚
â”‚  â”‚                   â”‚ Shared  â”‚                   â”‚          â”‚
â”‚  â”‚ - Begrip          â”‚ Kernel  â”‚ - Rules Engine    â”‚          â”‚
â”‚  â”‚ - Definitie       â”‚         â”‚ - Score Calc      â”‚          â”‚
â”‚  â”‚ - Metadata        â”‚         â”‚ - Violations      â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚           â”‚                              â”‚                      â”‚
â”‚           â”‚                              â”‚                      â”‚
â”‚           â–¼                              â–¼                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   Enrichment      â”‚         â”‚     Export        â”‚          â”‚
â”‚  â”‚    Context        â”‚         â”‚     Context       â”‚          â”‚
â”‚  â”‚                   â”‚         â”‚                   â”‚          â”‚
â”‚  â”‚ - Synonyms        â”‚         â”‚ - Formatters      â”‚          â”‚
â”‚  â”‚ - Examples        â”‚         â”‚ - Templates       â”‚          â”‚
â”‚  â”‚ - Context         â”‚         â”‚ - Delivery        â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>

<h3>1.5 Clean Architecture Services Implementatie âœ… VOLTOOID</h3>

<h4>Session State Elimination Strategy</h4>
<p><strong>Status</strong>: <strong>IMPLEMENTED</strong> (25-08-2025)</p>
<p><strong>Architecture Pattern</strong>: Data Aggregation + Service Facade + Adapter Pattern</p>

<h4>1.5.1 Problem Analysis</h4>
<ul>
<li>**Symptom**: Business services directly importing `SessionStateManager`</li>
<li>**Impact**: Services coupled to UI state, difficult testing, architecture violations</li>
<li>**Root Cause**: No clear separation between UI data collection and business logic</li>
</ul>

<h4>1.5.2 Solution Pattern</h4>
<pre><code># Clean Architecture Layers (Implemented)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 UI Layer                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚SessionState â”‚â†’ â”‚UIComponentsAdapter (Bridge)    â”‚ â”‚
â”‚ â”‚Manager      â”‚  â”‚- Collects UI data              â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚- Calls clean services          â”‚ â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Facade Layer                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚DefinitionUIService (UI Facade)                  â”‚ â”‚
â”‚ â”‚- export_definition(ui_data)                     â”‚ â”‚
â”‚ â”‚- prepare_for_review(notes)                      â”‚ â”‚
â”‚ â”‚- get_export_formats()                           â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Business Services Layer                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚DataAggregationSvc   â”‚ â”‚ExportService            â”‚ â”‚
â”‚ â”‚- aggregate_data()   â”‚ â”‚- export_to_format()     â”‚ â”‚
â”‚ â”‚- NO UI afhankelijkheden â”‚ â”‚- Multiple formats       â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Repository Layer                       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚DefinitieRepository                               â”‚ â”‚
â”‚ â”‚- get_definitie(id)                              â”‚ â”‚
â”‚ â”‚- Pure data access                               â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>

<h4>1.5.3 Implemented Components</h4>
<pre><code># 1. Data Aggregation Service (NO UI afhankelijkheden)
class DataAggregationService:
    def aggregate_definitie_for_export(
        self,
        definitie_id: int = None,
        definitie_record: DefinitieRecord = None,
        additional_data: dict = None  # From UI, but passed as parameter
    ) -&gt; DefinitieExportData:
        # Aggregates data from repository + additional UI data
        # NO SessionStateManager imports

# 2. Export Service (Business logic only)
class ExportService:
    def export_definitie(
        self,
        definitie_id: int,
        additional_data: dict,  # UI data as parameter
        format: ExportFormat
    ) -&gt; str:
        # Pure business logic, supports TXT/JSON/CSV
        # NO UI afhankelijkheden

# 3. UI Facade Service (UI-friendly interface)
class DefinitionUIService:
    def export_definition(
        self,
        definitie_id: int,
        ui_data: dict,  # Collected from UI
        format: str
    ) -&gt; dict:
        # Returns UI-friendly result format
        # Handles errors, success messages

# 4. UI Adapter (Bridge to legacy)
class UIComponentsAdapter:
    def export_definition(self, format: str) -&gt; bool:
        # Collects data from SessionStateManager (temporary)
        ui_data = self._collect_ui_data_for_export()
        # Calls clean services
        result = self.service.export_definition(ui_data=ui_data)
        # Handles UI display</code></pre>

<h4>1.5.4 Integration with Service Container</h4>
<pre><code>class ServiceContainer:
    def data_aggregation_service(self):
        # Dependency injection, no UI afhankelijkheden

    def export_service(self):
        # Uses data_aggregation_service + repository

    def definition_ui_service(self):
        # Facade combining all services for UI

    def service_adapter(self):  # Enhanced existing adapter
        # Legacy compatibility + new export methods</code></pre>

<h4>1.5.5 Migration Strategy</h4>
<p><strong>Phase 1</strong>: Create clean services âœ… <strong>VOLTOOID</strong></p>
<p><strong>Phase 2</strong>: Add to service container âœ… <strong>VOLTOOID</strong></p>
<p><strong>Phase 3</strong>: Create UI adapters âœ… <strong>VOLTOOID</strong></p>
<p><strong>Phase 4</strong>: UI components migration (gradual, backward compatible)</p>

<h4>1.5.6 Success Metrics âœ… ACHIEVED</h4>
<ul>
<li>âœ… **0** SessionStateManager imports in business services</li>
<li>âœ… **100%** services testable without UI mocks (8/8 integration tests pass)</li>
<li>âœ… **Backward compatibility** maintained via adapters</li>
<li>âœ… **3 export formats** supported (TXT/JSON/CSV)</li>
</ul>

<h4>1.5.7 Testen Strategy</h4>
<pre><code># Services can be tested with pure data
def test_data_aggregation_without_session_state():
    service = DataAggregationService(mock_repository)
    result = service.aggregate_definitie_for_export(
        definitie_id=1,
        additional_data={"expert_review": "Good"}  # Pure dict
    )
    assert result.expert_review == "Good"

# Architecture boundaries enforced
def test_no_ui_dependencies():
    import inspect
    from services import data_aggregation_service
    source = inspect.getsource(data_aggregation_service)
    assert "SessionStateManager" not in source</code></pre>

<p>---</p>

<h2>2. PER-007/CFR Context Flow Refactoring - Single Source of Truth</h2>

<h3>2.1 Critical Context Flow Architecture</h3>

<p>This section implements the consolidated PER-007 and CFR fixes for context flow management, establishing <code>DefinitionGeneratorContext</code> as the canonical Single Source of Truth for all context data flow.</p>

<h4>2.1.1 Unified Stateless Architecture</h4>

<pre><code>graph LR
    subgraph "Stateless Single Path Architecture"
        UI[UI Components] --&gt;|1. Parameters| FAC[UI Facade]
        FAC --&gt;|2. Data Object| REQ[GenerationRequest]
        REQ --&gt;|3. Transform| DGC[DefinitionGeneratorContext]
        DGC --&gt;|4. Enrich| EC[EnrichedContext]
        EC --&gt;|5. Build| PROMPT[Modular Prompts]
        PROMPT --&gt;|6. Generate| AI[AI Service]
    end

    subgraph "Data Services (No State)"
        DAS[DataAggregationService]
        REP[(Repository)]
        DAS --&gt; REP
    end

    FAC -.-&gt;|Get Previous| DAS
    DGC --&gt;|Store| DAS

    style DGC fill:#4CAF50,stroke:#2E7D32,stroke-width:3px
    style EC fill:#4CAF50,stroke:#2E7D32,stroke-width:3px
    style DAS fill:#2196F3,stroke:#1976D2,stroke-width:2px</code></pre>

<h4>2.1.2 Core Data Structures - THE Single Source of Truth</h4>

<pre><code>@dataclass
class DefinitionGeneratorContext:
    """Single Source of Truth for context data - NO UI afhankelijkheden.

    KRITIEK: This is the ONLY structure allowed to carry context data
    through the system. UI preview strings are FORBIDDEN as data sources.
    """
    organisatorisch: List[str]  # e.g., ["OM", "DJI", "Rechtspraak"]
    juridisch: List[str]        # e.g., ["Strafrecht", "Bestuursrecht"]
    wettelijk: List[str]        # e.g., ["Sv", "Sr", "Awb"]
    custom_entries: Dict[str, List[str]]  # User-defined entries
    metadata: Dict[str, Any]    # Processing metadata

    def validate(self) -&gt; ValidationResult:
        """Ensure all three context fields are properly populated."""
        warnings = []
        if not self.organisatorisch:
            warnings.append("Organisatorische context ontbreekt")
        if not self.juridisch:
            warnings.append("Juridische context ontbreekt")
        if not self.wettelijk:
            warnings.append("Wettelijke basis ontbreekt")
        return ValidationResult(
            is_valid=len(warnings) == 0,
            warnings=warnings
        )

@dataclass
class EnrichedContext:
    """Enriched context after aggregation and validation."""
    base_context: DefinitionGeneratorContext
    previous_definitions: List[str]
    domain_knowledge: Dict[str, Any]
    validation_warnings: List[str]
    astra_suggestions: List[str]
    processing_metadata: Dict[str, Any]

    def to_prompt_context(self) -&gt; Dict[str, Any]:
        """Convert to prompt-ready format."""
        return {
            'organisatorisch': self.base_context.organisatorisch,
            'juridisch': self.base_context.juridisch,
            'wettelijk': self.base_context.wettelijk,
            'previous': self.previous_definitions[:5],
            'warnings': self.validation_warnings
        }</code></pre>

<h4>2.1.3 DataAggregationService Implementatie</h4>

<pre><code>class DataAggregationService:
    """Centralizes data collection WITHOUT session state.

    MERGE POLICY:
    1. UI values have priority over DB values
    2. Order-preserving deduplication (first occurrence wins)
    3. Canonicalization of known entities (OM, DJI, etc.)
    4. Max 10 items per context type
    5. Max 120 chars per item

    FALLBACK STRATEGY:
    - DB unavailable: Use empty context, log warning
    - Empty history: Return default empty ContextData
    - Cache TTL: 5 minutes for performance
    """

    def __init__(self,
                 repository: DefinitionRepository,
                 cache_service: Optional[CacheService] = None):
        self.repository = repository
        self.cache = cache_service
        self.merge_policy = MergePolicy()

    def aggregate_for_generation(
        self,
        request: GenerationRequest,
        previous_context: Optional[ContextData] = None
    ) -&gt; EnrichedContext:
        """Aggregate all context data into EnrichedContext.

        CONTRACT:
        - Input: GenerationRequest from UI
        - Output: EnrichedContext for prompt building
        - No side effects, pure transformation
        """
        # Create base context from request
        base_context = DefinitionGeneratorContext(
            organisatorisch=request.organisatorisch_context or [],
            juridisch=request.juridisch_context or [],
            wettelijk=request.wettelijke_basis or [],
            custom_entries=request.custom_entries or {},
            metadata={'source': 'user_input', 'timestamp': datetime.now()}
        )

        # Merge with previous context if available
        if previous_context:
            base_context = self.merge_policy.merge(base_context, previous_context)

        # Validate context completeness
        validation_result = base_context.validate()

        # Enrich with domain knowledge
        enriched = EnrichedContext(
            base_context=base_context,
            previous_definitions=self._get_recent_definitions(request.term),
            domain_knowledge=self._get_domain_knowledge(base_context),
            validation_warnings=validation_result.warnings,
            astra_suggestions=self._get_astra_suggestions(base_context),
            processing_metadata={
                'enrichment_timestamp': datetime.now(),
                'validation_status': validation_result.is_valid
            }
        )

        return enriched</code></pre>

<h4>2.1.4 PromptServiceV2 - Context Consumer Only</h4>

<pre><code>class PromptServiceV2:
    """Prompt builder that ONLY consumes EnrichedContext.
    NO context building or conversion allowed.

    KRITIEK RULES:
    1. NEVER parse UI preview strings
    2. NEVER convert GenerationRequest directly
    3. ALWAYS use EnrichedContext as input
    4. NO emojis in prompt generation
    """

    def __init__(self, context_formatter: ContextFormatter):
        self.formatter = context_formatter
        # NO data service, NO context builder!

    def build_generation_prompt(
        self,
        enriched_context: EnrichedContext,
        template: str = "default"
    ) -&gt; str:
        """Build prompt from EnrichedContext ONLY.

        CONTRACT:
        - Input: EnrichedContext (never GenerationRequest)
        - Output: Formatted prompt string
        - NO context conversion or mapping
        """
        # Format context for prompt (no emojis, with limits)
        context_section = self.formatter.format(
            enriched_context,
            style='prompt',
            options={
                'max_items': 10,
                'max_length': 120,
                'escape_special': True,
                'include_warnings': False,
                'no_emojis': True  # KRITIEK: No UI emojis in prompts
            }
        )

        # Build prompt from template with ALL THREE context fields
        prompt_parts = [
            f"Organisatorische context: {', '.join(enriched_context.base_context.organisatorisch)}",
            f"Juridische context: {', '.join(enriched_context.base_context.juridisch)}",
            f"Wettelijke basis: {', '.join(enriched_context.base_context.wettelijk)}",
            "",
            self._apply_template(template, context_section)
        ]

        return "\n".join(prompt_parts)</code></pre>

<h4>2.1.5 "Anders..." UI Solution WITHOUT Session State</h4>

<pre><code>class StatelessContextSelector:
    """Context selector WITHOUT session state afhankelijkheden."""

    def render_multiselect_with_custom(
        self,
        field_name: str,
        options: List[str],
        label: str,
        current_values: List[str] = None
    ) -&gt; List[str]:
        """Render multiselect with "Anders..." option WITHOUT session state.

        Returns the complete list of selected values including custom entries.
        NO parsing of UI preview strings allowed.
        """
        if current_values is None:
            current_values = []

        # Separate custom entries from standard options
        custom_entries = [v for v in current_values if v not in options]
        standard_selections = [v for v in current_values if v in options]

        # Display options include custom entries and "Anders..." trigger
        display_options = options + custom_entries
        if "Anders..." not in display_options:
            display_options.append("Anders...")

        # Render multiselect with current values
        selected = st.multiselect(
            label=label,
            options=display_options,
            default=standard_selections + custom_entries
        )

        # Handle "Anders..." selection
        if "Anders..." in selected:
            custom_input = st.text_input(
                f"Voer custom {field_name} in:",
                key=f"custom_{field_name}_input"
            )
            if custom_input and st.button(f"Voeg toe", key=f"add_{field_name}"):
                selected.remove("Anders...")
                selected.append(custom_input.strip())

        # Return clean list without "Anders..." marker
        return [s for s in selected if s != "Anders..."]</code></pre>

<h4>2.1.6 Forbidden Patterns and Linting Rules</h4>

<pre><code># FORBIDDEN patterns (enforced via linting):
# ruff.toml
[tool.ruff.lint.flake8-tidy-imports]
banned-modules = [
    "services.context_manager",  # Deprecated
    "services.prompt_context",   # Deprecated
    "generation.context_builder", # Deprecated
    "utils.session_state_manager", # ELIMINATED
    "streamlit.session_state:services.*"  # Banned in services
]

# Additional CI checks
[tool.custom.guards]
forbidden_patterns = [
    {pattern = "ğŸ“‹|âš–ï¸|ğŸ“œ", files = "src/services/**/*.py", message = "UI emojis in services"},
    {pattern = "parse.*preview.*string", files = "src/**/*.py", message = "Parsing UI preview strings"},
    {pattern = "split.*\\|", files = "src/services/**/*.py", message = "Splitting UI formatted strings"}
]</code></pre>

<p>---</p>

<h2>3. Technical Design</h2>

<h3>3.1 Technology Stack</h3>

<h4>Core Technologies</h4>
<p>| Layer | Current (AS-IS) | Target (TO-BE) | Migration Effort |</p>
<p>|-------|----------------|----------------|------------------|</p>
<p>| Frontend | Streamlit 1.28 | React 18 + TypeScript | High |</p>
<p>| Backend | Python 3.11 Monolith | FastAPI 0.104 Microservices | Medium |</p>
<p>| Database | SQLite | PostgreSQL 15 + Redis 7 | Medium |</p>
<p>| AI/ML | OpenAI GPT-4 | OpenAI + Local Models | Low |</p>
<p>| Container | None | Docker + Kubernetes | High |</p>
<p>| Monitoring | Basic logging | Prometheus + Grafana | Medium |</p>

<h4>Development Standards</h4>
<ul>
<li>**Language**: Python 3.11+ with type hints</li>
<li>**Framework**: FastAPI for all services</li>
<li>**API Spec**: OpenAPI 3.0</li>
<li>**Testen**: Pytest with 80% coverage</li>
<li>**Code Style**: Black + Ruff</li>
<li>**Documentation**: Sphinx + Markdown</li>
</ul>

<h2>NFR Updates (Beveiliging & Observability) â€“ 28-08-2025</h2>
<ul>
<li>Beveiliging: OAuth2/JWT + RBAC (adapters), inputâ€‘sanitization, rate limiting, secrets management, encryptie at rest (SQLCipher/PostgreSQL TDE), TLS everywhere.</li>
<li>Observability: Structured JSON logging (request_id, user_id, latency_ms, tokens_used), Prometheus metrics (cache hitâ€‘ratio, GPT tokens, validation failures), tracing (OpenTelemetry) met 10â€“20% sampling.</li>
<li>Prestaties: Nonâ€‘GPT p95 < 250ms; GPT acties met duidelijke feedback/timeout (30s); retries met jitter; queue waar nodig.</li>
<li>Testbaarheid: Contracttests voor interfaces; golden tests voor prompts; mocks voor AI/lookup providers.</li>
<li>Kosten: Dagelijkse AIâ€‘kostenrapportage; alerts bij overschrijding.</li>
</ul>

<p>---</p>

<h2>Modulaire Opzet en Legacyâ€‘Uitfasering (Update 28-08-2025)</h2>

<h3>Moduleâ€‘grenzen en afhankelijkheidâ€‘regels</h3>
<ul>
<li>Lagen: adapters â†’ services â†’ domain; infrastructure implementeert serviceâ€‘interfaces.</li>
<li>Regels:</li>
<li> - Adapters (UI/API/CLI) gebruiken uitsluitend services/factory; geen directe DB/SDK (OpenAI/SQLite) imports.</li>
<li> - Services kennen alleen domain en services.interfaces (contracten) en spreken providers/repositories via interfaces.</li>
<li> - Infrastructure (DB/AI/cache/storage) implementeert de interfaces; geen afhankelijkheid terug naar adapters.</li>
<li> - Config/feature flags uitsluitend via de config module.</li>
</ul>

<h3>Stabiele contracten (nieuw/expliciet)</h3>
<ul>
<li>AIProviderInterface: uniforme chat/completion interface (OpenAI/Azure/lokaal) â†’ pluggable backends zonder codewijziging in services/UI.</li>
<li>PromptBuilderInterface: scheidt promptopbouw (templates/regels) van orchestrator/services; vergemakkelijkt testen (golden snapshots) en varianten.</li>
<li>Bestaand: DefinitionGenerator, Validator, Repository, Cleaning, WebLookup, Orchestrator blijven leidend als interfaces.</li>
</ul>

<h3>Orchestratorâ€‘first aansturing</h3>
<ul>
<li>Alle generaties via DefinitionOrchestrator (generate â†’ validate â†’ enrich â†’ store).</li>
<li>UIâ€‘tabs roepen geen generator/validator of repository direct aan; uitsluitend services/orchestrator.</li>
</ul>

<h3>Feature flags en shims</h3>
<ul>
<li>FEATURE_ORCHESTRATOR_ONLY: dwingt orchestratorâ€‘pad af voor alle generaties.</li>
<li>FEATURE_MODERN_LOOKUP: forceer ModernWebLookupService in alle paden (UI + services).</li>
<li>FEATURE_DISABLE_LEGACY_AFTER: datum voor waarschuwing/telemetrie richting legacy paden.</li>
<li>Shims behouden backward compatibility en loggen deprecationâ€‘waarschuwingen.</li>
</ul>

<h3>Legacy deprecations</h3>
<ul>
<li>UnifiedDefinitionGenerator (monoliet) â†’ vervangen door Orchestrator + losse services.</li>
<li>Legacy Web Lookup modules â†’ vervangen door ModernWebLookupService + LookupRequest.</li>
<li>UI â†’ DB/SDK imports â†’ vervangen door serviceâ€‘aanroepen; repository blijft in infrastructure.</li>
</ul>

<h3>Teststrategie (modulair)</h3>
<ul>
<li>Contracttests per interface (generator, validator, repository, AIâ€‘provider, prompts).</li>
<li>Golden master voor prompts (inputâ†’prompt snapshots).</li>
<li>Integratietests over het orchestratorâ€‘pad met gemockte providers.</li>
<li>Lintâ€‘regels die UIâ†’infra of UIâ†’SDK imports blokkeren.</li>
</ul>

<h3>Acceptatiecriteria (DoD)</h3>
<ul>
<li>UI importeert enkel services/* en domain/*; 0 directe imports naar OpenAI/DB.</li>
<li>rg toont 0 legacy imports (UnifiedDefinitionGenerator, legacy Web Lookup) in actieve paden.</li>
<li>Alle servicecalls via interfaces/factory/container; contracttests groen; promptâ€‘goldens stabiel.</li>
<li>Feature flags â€œmodernâ€‘onlyâ€ aan zonder regressies (smoke per tab).</li>
</ul>

<p>---</p>


<h3>SMART Acceptatiecriteria</h3>

<ul>
<li>**Specifiek:** [Exact gedrag dat moet worden gerealiseerd]</li>
<li>**Meetbaar:**</li>
<li> - Response tijd: < 200ms voor UI acties</li>
<li> - Processing tijd: < 5 seconden voor generatie</li>
<li> - Success rate: > 95% voor validaties</li>
<li>**Acceptabel:** Haalbaar binnen huidige architectuur</li>
<li>**Relevant:** Direct gerelateerd aan gebruikersbehoefte</li>
<li>**Tijdgebonden:** Gerealiseerd binnen huidige sprint</li>
</ul>


<h2>Knowledge Preservation Plan (Nieuw â€“ 28-08-2025)</h2>

<ul>
<li>Inventarisatie: volledige lijst van legacy functies, regels, prompts en gebruikshotspots (rapport per module).</li>
<li>Mappingtabel: legacy â†’ nieuwe modules (1:1 of 1:n), inclusief uitzonderingen en rationale.</li>
<li>Golden datasets: inputâ†’output snapshots van kritieke casussen en randgevallen (regressiecontrole).</li>
<li>Shims + telemetrie: dualâ€‘run/ shadowâ€‘mode van legacy paden met diffâ€‘rapportage en drempelwaarden.</li>
<li>Catalogi: Rule Catalog (regel, rationale, voorbeelden, beslisnotities) en Prompt Catalog (variant, constraints, token budget, voorbeelden).</li>
<li>Lineage/metadata: voeg `legacy_origin`, `ruleset_version`, `prompt_version`, bronverwijzingen toe aan definities.</li>
<li>ADRâ€™s: leg ontwerpkeuzes en context vast (alternatieven, consequenties) per wijziging.</li>
</ul>

<p>Acceptatiecriteria (kennisbehoud)</p>
<ul>
<li>100% van legacy regels en prompts gemapt en gedocumenteerd.</li>
<li>â‰¥ 90% match op golden set (of expliciet verbeterd) met verklaarde verschillen.</li>
<li>Catalogi en ADRâ€™s gepubliceerd en versieâ€‘beheerd.</li>
<li>Telemetrie toont 0 onbekende legacyâ€‘aanroepen bij uitfasering.</li>
</ul>

<p>---</p>

<h2>Appendix A: Reference Interfaces (nietâ€‘bindend)</h2>

<p>Doel: illustratieve contracten OM modularisatie te sturen; implementatie volgt na governanceâ€‘go/noâ€‘go. Dit documenteert intentie zonder code te wijzigen.</p>

<ul>
<li>AIProviderInterface: uniforme chat/completion API (OpenAI/Azure/lokaal)</li>
<li> - `chat(messages: list[Message], model: str, temperature: float, max_tokens: int) -> (content: str, tokens_used: int)`</li>
</ul>

<ul>
<li>PromptBuilderInterface: scheidt promptopbouw van services/orchestrator</li>
<li> - `build_prompt(begrip: str, context: Any) -> str`</li>
</ul>

<p>Opmerking: deze referenties dienen als richtlijn voor toekomstige implementaties; de huidige code blijft ongewijzigd totdat een expliciet migratieâ€‘besluit is genomen.</p>

<h3>2.2 Frontend Evolution Strategy</h3>

<h4>Phased UI Migration Approach</h4>
<p>Instead of a big-bang rewrite, we adopt a gradual migration strategy:</p>

<h5>Phase 1: Enhanced Streamlit (Month 1-3)</h5>
<pre><code>Goals:
  - Add API layer to existing Streamlit
  - Implement component library
  - Improve performance with caching

Implementatie:
  - Streamlit Components for complex UI
  - REST API endpoints for data
  - Session state optimization
  - Progressive enhancement</code></pre>

<h5>Phase 2: Hybrid Approach (Month 4-8)</h5>
<pre><code>Goals:
  - React micro-frontends within Streamlit
  - Shared state management
  - Gradual feature migration

Implementatie:
  - React components via IFrame/Web Components
  - Redux state bridge
  - API-first architecture
  - Feature flags for A/B testing</code></pre>

<h5>Phase 3: Full SPA Migration (Month 9-12)</h5>
<pre><code>Goals:
  - Complete React/Next.js application
  - Streamlit deprecated
  - Full API separation

Tech Stack:
  - Next.js 14 with App Router
  - TypeScript + Zod validation
  - TanStack Query for data fetching
  - Tailwind CSS + shadcn/ui
  - Playwright for E2E testing</code></pre>

<h4>Component Migration Prioriteit</h4>
<pre><code>// High Prioriteit (Core Features)
1. DefinitionGenerator     // Week 1-2
2. ValidationResults       // Week 3-4
3. HistoryView            // Week 5-6

// Medium Prioriteit (Enhanced UX)
4. ExportInterface        // Week 7-8
5. SearchInterface        // Week 9-10
6. ContextSelector        // Week 11-12

// Low Prioriteit (Nice to Have)
7. MonitoringDashboard    // Week 13-14
8. AdminInterface         // Week 15-16</code></pre>

<h3>2.3 API Design</h3>

<h4>RESTful API Structure</h4>
<pre><code>API Gateway Routes:
  /api/v1/definitions:
    GET: List definitions with filtering
    POST: Create new definition

  /api/v1/definitions/{id}:
    GET: Get specific definition
    PUT: Update definition
    DELETE: Archive definition

  /api/v1/definitions/{id}/validate:
    POST: Trigger validation
    GET: Get validation results

  /api/v1/definitions/{id}/enrich:
    POST: Enrich with sources

  /api/v1/search:
    GET: Full-text search

  /api/v1/contexts:
    GET: Available contexts
    POST: Create custom context</code></pre>

<h4>FastAPI Implementatie (Existing)</h4>
<pre><code># From src/api/async_api.py (currently unused)
@app.post("/api/v1/definitions", response_model=DefinitionResponse)
async def create_definition(
    request: DefinitionRequest,
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    # GVI Pattern Implementatie
    definition = await generation_service.generate(request)
    validation_result = await validation_service.validate(definition)

    if validation_result.score &lt; 0.7:
        definition = await integration_service.improve(definition, validation_result)

    await db.save(definition)
    await event_bus.publish(DefinitionCreatedEvent(definition))

    return DefinitionResponse.from_orm(definition)</code></pre>

<h3>2.3 Data Architecture</h3>

<h4>Database Schema (PostgreSQL)</h4>
<pre><code>-- Core tables
CREATE TABLE definitions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    term VARCHAR(255) NOT NULL,
    text TEXT NOT NULL,
    context_id UUID REFERENCES contexts(id),
    quality_score DECIMAL(3,2),
    status VARCHAR(50) DEFAULT 'draft',
    version INTEGER DEFAULT 1,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    created_by UUID REFERENCES users(id),
    updated_at TIMESTAMPTZ DEFAULT NOW(),

    -- Indexes for performance
    INDEX idx_term_search (term gin_trgm_ops),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at DESC)
);

-- Validation results
CREATE TABLE validation_results (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    definition_id UUID REFERENCES definitions(id),
    rule_id VARCHAR(100),
    score DECIMAL(3,2),
    feedback JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Event sourcing
CREATE TABLE events (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    aggregate_id UUID NOT NULL,
    event_type VARCHAR(100) NOT NULL,
    event_data JSONB NOT NULL,
    occurred_at TIMESTAMPTZ DEFAULT NOW(),

    INDEX idx_aggregate (aggregate_id),
    INDEX idx_event_type (event_type)
);</code></pre>

<h4>Caching Strategy</h4>
<pre><code># Multi-layer caching implementation
class CacheManager:
    def __init__(self):
        self.redis = Redis(
            host=REDIS_HOST,
            decode_responses=True,
            max_connections=50
        )
        self.local_cache = TTLCache(maxsize=1000, ttl=300)

    async def get_or_compute(self, key: str, compute_fn, ttl: int = 3600):
        # L1: Local memory cache
        if key in self.local_cache:
            return self.local_cache[key]

        # L2: Redis cache
        cached = await self.redis.get(key)
        if cached:
            value = json.loads(cached)
            self.local_cache[key] = value
            return value

        # L3: Compute and cache
        value = await compute_fn()
        await self.redis.setex(key, ttl, json.dumps(value))
        self.local_cache[key] = value
        return value</code></pre>

<p>---</p>

<h2>3. Prestaties Engineering & AI Optimization</h2>

<h3>3.1 AI Cost Optimization Strategy</h3>

<h4>Intelligent Model Selection</h4>
<pre><code>class AIModelSelector:
    """Select optimal model based on complexity and budget"""

    MODELS = {
        'simple': {'model': 'gpt-3.5-turbo', 'cost_per_1k': 0.002},
        'standard': {'model': 'gpt-4', 'cost_per_1k': 0.03},
        'complex': {'model': 'gpt-4-turbo', 'cost_per_1k': 0.01},
        'emergency': {'model': 'gpt-3.5-turbo-16k', 'cost_per_1k': 0.003}
    }

    def select_model(self, complexity_score: float, budget_remaining: float) -&gt; str:
        if budget_remaining &lt; 10:  # Emergency mode
            return self.MODELS['emergency']['model']

        if complexity_score &lt; 0.3:
            return self.MODELS['simple']['model']
        elif complexity_score &lt; 0.7:
            return self.MODELS['standard']['model']
        else:
            return self.MODELS['complex']['model']</code></pre>

<h4>Semantic Caching with Embeddings</h4>
<pre><code>class SemanticCache:
    """Cache based on semantic similarity, not exact match"""

    def __init__(self):
        self.embeddings = {}
        self.cache = {}
        self.similarity_threshold = 0.95

    async def get_or_generate(self, prompt: str, generate_fn):
        # Generate embedding for prompt
        prompt_embedding = await self.get_embedding(prompt)

        # Find similar cached prompts
        for cached_prompt, cached_embedding in self.embeddings.items():
            similarity = cosine_similarity(prompt_embedding, cached_embedding)
            if similarity &gt; self.similarity_threshold:
                logger.info(f"Cache hit with similarity {similarity}")
                return self.cache[cached_prompt]

        # Cache miss - generate and store
        result = await generate_fn(prompt)
        self.embeddings[prompt] = prompt_embedding
        self.cache[prompt] = result
        return result</code></pre>

<h4>Prompt Engineering Framework</h4>
<pre><code>class PromptTemplate:
    """Versioned, A/B testable prompt templates"""

    def __init__(self, template_id: str, version: str):
        self.template_id = template_id
        self.version = version
        self.metrics = PromptMetrics()

    def render(self, **context) -&gt; str:
        template = self.load_template()
        rendered = template.format(**context)

        # Track token usage
        token_count = self.count_tokens(rendered)
        self.metrics.record_usage(token_count)

        # Optimize if needed
        if token_count &gt; 10000:
            rendered = self.compress_prompt(rendered)

        return rendered

    def compress_prompt(self, prompt: str) -&gt; str:
        """Compress prompt while maintaining quality"""
        # Remove redundant examples
        # Compress context
        # Use references instead of full text
        return compressed_prompt</code></pre>

<h3>3.2 Prestaties Optimization Strategies</h3>

<h4>Response Time Optimization</h4>
<pre><code>Target Metrics:
  - P50: &lt; 2 seconds
  - P95: &lt; 5 seconds
  - P99: &lt; 8 seconds

Optimization Techniques:
  1. Streaming Responses:
     - Stream AI responses token by token
     - Progressive UI updates
     - Perceived performance improvement

  2. Parallel Processing:
     - Concurrent validation rules
     - Parallel enrichment sources
     - Async I/O everywhere

  3. Smart Prefetching:
     - Predict next user actions
     - Preload common contexts
     - Warm cache for popular terms</code></pre>

<h4>Resource Optimization</h4>
<pre><code># Connection pooling
async_engine = create_async_engine(
    DATABASE_URL,
    pool_size=20,
    max_overflow=40,
    pool_pre_ping=True,
    pool_recycle=3600
)

# Request batching
class BatchProcessor:
    def __init__(self, batch_size=10, wait_time=0.1):
        self.batch_size = batch_size
        self.wait_time = wait_time
        self.queue = asyncio.Queue()

    async def process_batch(self):
        batch = []
        deadline = time.time() + self.wait_time

        while time.time() &lt; deadline and len(batch) &lt; self.batch_size:
            try:
                item = await asyncio.wait_for(
                    self.queue.get(),
                    timeout=deadline - time.time()
                )
                batch.append(item)
            except asyncio.TimeoutError:
                break

        if batch:
            await self._process_items(batch)</code></pre>

<p>---</p>

<h2>4. Integration Architecture</h2>

<h3>4.1 Service Communication</h3>

<h4>Event-Driven Architecture</h4>
<pre><code>Message Bus: RabbitMQ
  Exchanges:
    - definitions.topic: Definition lifecycle events
    - validations.topic: Validation events
    - notifications.topic: User notifications

  Event Types:
    - definition.created
    - definition.validated
    - definition.published
    - validation.completed
    - enrichment.completed</code></pre>

<h4>Service Mesh Pattern</h4>
<pre><code>sequenceDiagram
    participant C as Client
    participant G as API Gateway
    participant D as Definition Service
    participant V as Validation Service
    participant E as Event Bus
    participant N as Notification Service

    C-&gt;&gt;G: POST /definitions
    G-&gt;&gt;D: Create Definition
    D-&gt;&gt;E: PublishEvent(created)
    E-&gt;&gt;V: TriggerValidation
    E-&gt;&gt;N: NotifyUser
    V-&gt;&gt;E: PublishEvent(validated)
    E-&gt;&gt;D: UpdateStatus
    D-&gt;&gt;G: Response
    G-&gt;&gt;C: 201 Created</code></pre>

<h3>3.2 External Integrations</h3>

<p>| System | Purpose | Protocol | Auth | Circuit Breaker |</p>
<p>|--------|---------|----------|------|------------------|</p>
<p>| OpenAI GPT-4 | AI Generation | REST | API Key | 5 failures/min |</p>
<p>| RijksWoordenboek | Dutch definitions | REST | OAuth 2.0 | 3 failures/min |</p>
<p>| EUR-Lex | EU legislation | REST | API Key | 3 failures/min |</p>
<p>| Wetten.nl | Dutch laws | REST | Open | 5 failures/min |</p>
<p>| DeepL | Translation | REST | API Key | 3 failures/min |</p>
<p>| Elasticsearch | Search | REST | Basic Auth | 5 failures/min |</p>

<h4>Circuit Breaker Implementatie</h4>
<pre><code>from circuit_breaker import CircuitBreaker

class ExternalServiceClient:
    def __init__(self, name: str, base_url: str):
        self.name = name
        self.base_url = base_url
        self.breaker = CircuitBreaker(
            failure_threshold=5,
            recovery_timeout=60,
            expected_exception=RequestException
        )

    @breaker
    async def call_api(self, endpoint: str, **kwargs):
        async with httpx.AsyncClient() as client:
            response = await client.get(
                f"{self.base_url}/{endpoint}",
                timeout=30,
                **kwargs
            )
            response.raise_for_status()
            return response.json()</code></pre>

<p>---</p>

<h2>4. Beveiliging Implementatie</h2>

<h3>4.1 Authentication & Authorization</h3>

<h4>OAuth 2.0 Implementatie (Existing)</h4>
<pre><code># From src/security/auth_middleware.py (currently unused)
from fastapi import Beveiliging, HTTPException
from fastapi.security import OAuth2PasswordBearer
from jose import JWTError, jwt

oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/auth/token")

class AuthMiddleware:
    def __init__(self):
        self.secret_key = config.SECRET_KEY
        self.algorithm = "HS256"
        self.token_expire = 30  # minutes

    async def get_current_user(
        self,
        token: str = Beveiliging(oauth2_scheme)
    ) -&gt; User:
        try:
            payload = jwt.decode(
                token,
                self.secret_key,
                algorithms=[self.algorithm]
            )
            user_id = payload.get("sub")
            if not user_id:
                raise HTTPException(401, "Invalid token")

            user = await self.get_user(user_id)
            if not user:
                raise HTTPException(401, "User not found")

            return user
        except JWTError:
            raise HTTPException(401, "Invalid token")</code></pre>

<h4>RBAC Configuration</h4>
<pre><code>Roles:
  admin:
    permissions:
      - definitions.*
      - users.*
      - system.*

  validator:
    permissions:
      - definitions.read
      - definitions.validate
      - definitions.comment

  author:
    permissions:
      - definitions.read
      - definitions.create
      - definitions.update.own

  viewer:
    permissions:
      - definitions.read
      - definitions.search

Department-based Access:
  - Users can only access their department's definitions
  - Cross-department sharing requires explicit permission
  - Admins have organization-wide access</code></pre>

<h3>4.2 Beveiliging Controls</h3>

<h4>API Beveiliging</h4>
<pre><code># Rate limiting implementation
from slowapi import Limiter
from slowapi.util import get_remote_address

limiter = Limiter(key_func=get_remote_address)

@app.post("/api/v1/definitions")
@limiter.limit("10/minute")
async def create_definition(request: DefinitionRequest):
    # Existing logic
    pass

# Input validation
from pydantic import BaseModel, validator
import bleach

class DefinitionRequest(BaseModel):
    term: str
    context: str

    @validator('term', 'context')
    def sanitize_input(cls, v):
        # Remove HTML/scripts
        v = bleach.clean(v, tags=[], strip=True)
        # Limit length
        if len(v) &gt; 1000:
            raise ValueError("Input too long")
        return v</code></pre>

<h4>Encryption Standards</h4>
<p>| Data Type | At Rest | In Transit | Key Management |</p>
<p>|-----------|---------|------------|----------------|</p>
<p>| User Credentials | Argon2 | TLS 1.3 | HSM |</p>
<p>| API Keys | AES-256-GCM | TLS 1.3 | Azure Key Vault |</p>
<p>| Definitions | AES-256-GCM | TLS 1.3 | Managed Keys |</p>
<p>| Audit Logs | AES-256-GCM | TLS 1.3 | Immutable |</p>

<h3>4.3 Beveiliging Pipeline (Pre-built)</h3>

<pre><code># From unused security components
class SecurityPipeline:
    def __init__(self):
        self.validators = [
            InputSanitizer(),
            SQLInjectionPreventer(),
            XSSProtector(),
            CSRFValidator()
        ]

    async def validate_request(self, request: Request) -&gt; bool:
        for validator in self.validators:
            if not await validator.validate(request):
                raise SecurityException(f"Failed {validator.name}")
        return True</code></pre>

<p>---</p>

<h2>5. Prestaties Engineering</h2>

<h3>5.1 Prestaties Vereisten</h3>

<p>| Operation | Current | Target | Strategy |</p>
<p>|-----------|---------|---------|----------|</p>
<p>| Definition Generation | 8-12s | <2s | Caching + Optimization |</p>
<p>| Validation | 3-5s | <500ms | Parallel processing |</p>
<p>| Search | 2-3s | <100ms | Elasticsearch |</p>
<p>| Page Load | 5-7s | <1s | CDN + Lazy loading |</p>

<h3>5.2 Prestaties Optimizations</h3>

<h4>GVI Pattern Optimization</h4>
<pre><code># Optimized generation with caching
class OptimizedDefinitionService:
    def __init__(self):
        self.cache = CacheManager()
        self.openai = OpenAIClient()

    async def generate_definition(self, request: DefinitionRequest):
        # Check cache for similar definitions
        cache_key = f"def:{request.term}:{request.context}"
        cached = await self.cache.get(cache_key)
        if cached:
            return cached

        # Parallel generation with multiple prompts
        tasks = [
            self.openai.generate(self._create_prompt(request, style))
            for style in ['formal', 'simple', 'technical']
        ]
        results = await asyncio.gather(*tasks)

        # Select best result
        best_definition = await self._select_best(results, request)

        # Cache for future
        await self.cache.set(cache_key, best_definition, ttl=3600)

        return best_definition</code></pre>

<h4>Database Optimizations</h4>
<pre><code>-- Optimized indexes
CREATE INDEX CONCURRENTLY idx_definitions_search
ON definitions USING gin(to_tsvector('dutch', term || ' ' || text));

CREATE INDEX CONCURRENTLY idx_definitions_lookup
ON definitions(term, context_id, status)
WHERE status = 'published';

-- Materialized view for stats
CREATE MATERIALIZED VIEW definition_stats AS
SELECT
    DATE(created_at) as date,
    COUNT(*) as total_definitions,
    AVG(quality_score) as avg_quality,
    COUNT(DISTINCT created_by) as unique_authors
FROM definitions
GROUP BY DATE(created_at)
WITH DATA;

-- Refresh strategy
CREATE INDEX ON definition_stats(date);
REFRESH MATERIALIZED VIEW CONCURRENTLY definition_stats;</code></pre>

<h3>5.3 Caching Architecture</h3>

<pre><code>Cache Layers:
  Browser:
    - Static assets: 1 year
    - API responses: 5 minutes

  CDN (CloudFlare):
    - Images: 1 month
    - JavaScript/CSS: 1 week
    - API responses: 1 hour

  Application (Redis):
    - Session data: 30 minutes
    - Definition cache: 1 hour
    - Search results: 15 minutes
    - User preferences: 24 hours

  Database:
    - Query cache: 5 minutes
    - Prepared statements: Session</code></pre>

<p>---</p>

<h2>6. Uitrol & Operations</h2>

<h3>6.1 Container Strategy</h3>

<h4>Docker Configuration</h4>
<pre><code># Base image for all services
FROM python:3.11-slim AS base

# Install system afhankelijkheden
RUN apt-get update &amp;&amp; apt-get install -y \
    gcc \
    g++ \
    curl \
    &amp;&amp; rm -rf /var/lib/apt/lists/*

# Python afhankelijkheden
FROM base AS afhankelijkheden
COPY vereistes.txt .
RUN pip install --no-cache-dir -r vereistes.txt

# Application
FROM afhankelijkheden AS app
WORKDIR /app
COPY src/ ./src/
COPY config/ ./config/

# Run as non-root
RUN useradd -m appuser
USER appuser

CMD ["uvicorn", "src.main:app", "--host", "0.0.0.0", "--port", "8000"]</code></pre>

<h4>Kubernetes Uitrol</h4>
<pre><code>apiVersion: apps/v1
kind: Uitrol
metadata:
  name: definition-service
  namespace: definitieagent
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: definition-service
  template:
    metadata:
      labels:
        app: definition-service
    spec:
      containers:
      - name: definition-service
        image: definitieagent.azurecr.io/definition-service:v2.0.0
        ports:
        - containerPort: 8000
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: db-credentials
              key: url
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8000
          initialDelaySeconds: 5
          periodSeconds: 5</code></pre>

<h3>6.2 CI/CD Pipeline</h3>

<h4>GitHub Actions Werkstroom</h4>
<pre><code>name: Build and Deploy

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install afhankelijkheden
      run: |
        pip install -r vereistes.txt
        pip install -r vereistes-dev.txt

    - name: Run tests
      run: |
        pytest --cov=src --cov-report=xml

    - name: Run security scan
      run: |
        bandit -r src/
        safety check

    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  build:
    needs: test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
    - name: Build and push Docker image
      env:
        REGISTRY: definitieagent.azurecr.io
      run: |
        docker build -t $REGISTRY/definition-service:$GITHUB_SHA .
        docker push $REGISTRY/definition-service:$GITHUB_SHA

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - name: Deploy to AKS
      run: |
        kubectl set image deployment/definition-service \
          definition-service=$REGISTRY/definition-service:$GITHUB_SHA \
          -n definitieagent</code></pre>

<h3>6.3 Monitoring & Observability</h3>

<h4>Metrics Collection</h4>
<pre><code># Prometheus metrics
from prometheus_client import Counter, Histogram, Gauge

# Business metrics
definitions_created = Counter(
    'definitions_created_total',
    'Total definitions created',
    ['status', 'context']
)

validation_score = Histogram(
    'validation_score',
    'Definition validation scores',
    buckets=[0.1, 0.3, 0.5, 0.7, 0.9, 0.95, 0.99]
)

active_users = Gauge(
    'active_users',
    'Currently active users'
)

# Prestaties metrics
request_duration = Histogram(
    'http_request_duration_seconds',
    'HTTP request latency',
    ['method', 'endpoint', 'status']
)</code></pre>

<h4>Logging Configuration</h4>
<pre><code>import structlog

# Structured logging setup
structlog.configure(
    processors=[
        structlog.stdlib.filter_by_level,
        structlog.stdlib.add_logger_name,
        structlog.stdlib.add_log_level,
        structlog.processors.TimeStamper(fmt="iso"),
        structlog.processors.StackInfoRenderer(),
        structlog.processors.format_exc_info,
        structlog.processors.dict_tracebacks,
        structlog.processors.JSONRenderer()
    ],
    context_class=dict,
    logger_factory=structlog.stdlib.LoggerFactory(),
)

logger = structlog.get_logger()

# Usage
logger.info(
    "definition_created",
    definition_id=definition.id,
    term=definition.term,
    quality_score=definition.quality_score,
    duration_ms=elapsed_time
)</code></pre>

<h4>Monitoring Stack</h4>
<pre><code>Prometheus:
  scrape_interval: 15s
  evaluation_interval: 15s
  targets:
    - definition-service:8000/metrics
    - validation-service:8000/metrics
    - enrichment-service:8000/metrics

Grafana Dashboards:
  - Service Health: Response times, error rates
  - Business Metrics: Definitions/day, quality scores
  - Infrastructure: CPU, memory, disk usage
  - User Analytics: Active users, popular contexts

Alerts:
  - Error rate &gt; 5% for 5 minutes
  - Response time p95 &gt; 2s
  - Service down &gt; 1 minute
  - Disk usage &gt; 80%</code></pre>

<p>---</p>

<h2>7. Migration Strategy</h2>

<h3>7.1 Phased Migration Approach</h3>

<h4>Pragmatic Timeline Adjustment</h4>
<p>Based on realistic assessment, the migration timeline has been extended:</p>
<ul>
<li>**Original**: 16 weeks</li>
<li>**Revised**: Q1 2024 - Q3 2025</li>
<li>**Reason**: Quality-first approach, team capacity, risk mitigation</li>
</ul>

<h4>Phase 0: Foundation Stabilization (Week 1-4) - PRIORITY</h4>
<pre><code>Goals:
  - Fix critical issues before any architecture changes
  - Achieve 90% first-time-right quality
  - Stabilize current monolith

Pragmatic Choices:
  - Docker Compose instead of direct Kubernetes
  - Redis pub/sub instead of Kafka initially
  - Basic auth instead of complex RBAC
  - SQLite WAL mode before PostgreSQL migration</code></pre>

<h4>Phase 0: Quality First Implementatie - IN UITVOERING</h4>
<pre><code># GVI Implementatie fixes
class ImprovedDefinitionGenerator:
    def __init__(self):
        self.validator = ValidationOrchestrator()
        self.feedback_integrator = FeedbackIntegrator()

    async def generate_with_gvi(self, request: DefinitionRequest):
        # 1. Generate with implicit context
        prompt = self._build_context_aware_prompt(request)
        initial_definition = await self.openai.generate(prompt)

        # 2. Validate immediately
        validation = await self.validator.validate(initial_definition)

        # 3. If score &lt; 0.9, improve
        if validation.score &lt; 0.9:
            improved = await self.feedback_integrator.improve(
                initial_definition,
                validation.feedback
            )
            # Re-validate
            validation = await self.validator.validate(improved)
            return improved

        return initial_definition</code></pre>

<h4>Phase 1: Core Service Extraction (Week 3-6)</h4>
<pre><code>Extraction Order:
  1. Authentication Service:
     - Already 95% complete
     - Just needs deployment

  2. Validation Service:
     - 78 rules already geÃ¯mplementeerd
     - Extract from monolith

  3. Definition Service:
     - Implement GVI pattern
     - Use existing async_api.py

  4. API Gateway:
     - New component
     - Kong or similar</code></pre>

<h4>Phase 2: Full Microservices (Week 7-12)</h4>
<pre><code>gantt
    title Migration Timeline
    dateFormat  YYYY-MM-DD
    section Phase 0
    Quality Improvements :done, p0, 19-08-2024, 14d

    section Phase 1
    Extract Auth Service :p1a, after p0, 7d
    Extract Validation :p1b, after p1a, 14d
    Extract Definition :p1c, after p1b, 14d
    Setup API Gateway :p1d, after p1c, 7d

    section Phase 2
    Remaining Services :p2a, after p1d, 21d
    Data Migration :p2b, after p2a, 7d
    Cutover :p2c, after p2b, 3d</code></pre>

<h3>7.2 Strangler Fig Implementatie</h3>

<pre><code># Migration router to gradually move traffic
class MigrationRouter:
    def __init__(self):
        self.legacy_app = StreamlitApp()
        self.new_services = ServiceRegistry()
        self.feature_flags = FeatureFlags()

    async def route_request(self, path: str, request: Request):
        # Check if route is migrated
        if self.feature_flags.is_enabled(f"new_{path}"):
            service = self.new_services.get_service(path)
            return await service.handle(request)

        # Fallback to legacy
        return self.legacy_app.handle(request)

    def get_migration_status(self) -&gt; Dict[str, float]:
        return {
            "definitions": 0.7,  # 70% migrated
            "validation": 0.9,   # 90% migrated
            "auth": 1.0,         # 100% migrated
            "search": 0.0,       # Not started
        }</code></pre>

<h3>7.3 Data Migration Strategy</h3>

<pre><code># Zero-downtime migration
class DataMigrator:
    def __init__(self):
        self.sqlite_conn = sqlite3.connect('definitions.db')
        self.pg_conn = asyncpg.create_pool(DATABASE_URL)

    async def migrate_with_cdc(self):
        # 1. Initial bulk copy
        await self._bulk_copy_historical()

        # 2. Setup change data capture
        await self._setup_triggers()

        # 3. Continuous sync
        async for change in self._watch_changes():
            await self._sync_change(change)

        # 4. Verification
        discrepancies = await self._verify_data()
        if discrepancies:
            await self._reconcile(discrepancies)

    async def _bulk_copy_historical(self):
        """Copy all data older than 24 hours"""
        cursor = self.sqlite_conn.execute(
            "SELECT * FROM definitions WHERE created_at &lt; datetime('now', '-1 day')"
        )

        async with self.pg_conn.acquire() as conn:
            await conn.copy_records_to_table(
                'definitions',
                records=cursor.fetchall(),
                columns=['id', 'term', 'text', 'created_at']
            )</code></pre>

<h3>7.4 Rollback Strategy</h3>

<pre><code>Rollback Triggers:
  - Error rate &gt; 10% for 5 minutes
  - P95 latency &gt; 2x baseline
  - Data inconsistency detected
  - Manual trigger by ops

Rollback Steps:
  1. Route all traffic to legacy (&lt; 1 minute)
  2. Stop new service deployments
  3. Preserve new service data
  4. Investigate root cause
  5. Fix and retry migration

Data Rollback:
  - Keep SQLite as source of truth during migration
  - Bi-directional sync until cutover
  - Point-in-time recovery for PostgreSQL
  - Transaction logs for audit</code></pre>

<p>---</p>

<h2>8. Testen Strategy</h2>

<h3>8.1 Test Coverage Vereisten</h3>

<p>| Test Type | Current | Target | Tools |</p>
<p>|-----------|---------|--------|-------|</p>
<p>| Unit Tests | 11% | 80% | pytest, pytest-cov |</p>
<p>| Integration Tests | 5% | 70% | pytest, testcontainers |</p>
<p>| E2E Tests | 0% | Critical paths | Playwright |</p>
<p>| Prestaties Tests | 0% | All APIs | Locust |</p>
<p>| Beveiliging Tests | 0% | OWASP Top 10 | OWASP ZAP |</p>

<h3>8.2 Testen Implementatie</h3>

<pre><code># Unit test example
import pytest
from unittest.mock import Mock, patch

class TestDefinitionService:
    @pytest.fixture
    def service(self):
        return DefinitionService()

    @pytest.mark.asyncio
    async def test_gvi_pattern_improves_quality(self, service):
        # Arrange
        request = DefinitionRequest(
            term="test",
            context="testing"
        )

        with patch('openai.ChatCompletion.acreate') as mock_ai:
            # Initial poor quality
            mock_ai.side_effect = [
                Mock(choices=[Mock(message=Mock(content="Bad definition"))]),
                Mock(choices=[Mock(message=Mock(content="Good definition"))])
            ]

            # Act
            result = await service.generate_with_gvi(request)

            # Assert
            assert "Good definition" in result.text
            assert mock_ai.call_count == 2  # Initial + improvement

# Integration test example
@pytest.mark.integration
class TestDefinitionFlow:
    @pytest.mark.asyncio
    async def test_full_definition_lifecycle(self, test_app, test_db):
        # Create
        response = await test_app.post("/api/v1/definitions", json={
            "term": "Integration Test",
            "context": "Testen"
        })
        assert response.status_code == 201
        definition_id = response.json()["id"]

        # Validate
        response = await test_app.post(
            f"/api/v1/definitions/{definition_id}/validate"
        )
        assert response.status_code == 200
        assert response.json()["score"] &gt;= 0.7

        # Check events
        events = await test_db.fetch(
            "SELECT * FROM events WHERE aggregate_id = $1",
            definition_id
        )
        assert len(events) &gt;= 2
        assert any(e["event_type"] == "DefinitionCreated" for e in events)
        assert any(e["event_type"] == "DefinitionValidated" for e in events)</code></pre>

<h3>8.3 Prestaties Testen</h3>

<pre><code># Locust performance test
from locust import HttpUser, task, between
import random

class DefinitionUser(HttpUser):
    wait_time = between(1, 3)

    def on_start(self):
        # Login
        response = self.client.post("/auth/login", json={
            "username": "testuser",
            "password": "testpass"
        })
        self.token = response.json()["access_token"]
        self.client.headers = {"Authorization": f"Bearer {self.token}"}

    @task(3)
    def list_definitions(self):
        self.client.get("/api/v1/definitions?limit=20")

    @task(2)
    def search_definitions(self):
        terms = ["beleid", "regeling", "wet", "besluit"]
        self.client.get(f"/api/v1/search?q={random.choice(terms)}")

    @task(1)
    def create_definition(self):
        self.client.post("/api/v1/definitions", json={
            "term": f"Test Term {random.randint(1, 1000)}",
            "context": "Prestaties Test"
        })</code></pre>

<p>---</p>

<h2>9. Cost Optimization</h2>

<h3>9.1 Current vs Target Costs</h3>

<p>| Component | Current (Monthly) | Target (Monthly) | Savings |</p>
<p>|-----------|------------------|------------------|----------|</p>
<p>| OpenAI API | â‚¬3,000 | â‚¬900 | 70% |</p>
<p>| Infrastructure | â‚¬500 | â‚¬1,500 | -200% |</p>
<p>| Development | â‚¬15,000 | â‚¬5,000 | 67% |</p>
<p>| Operations | â‚¬2,000 | â‚¬500 | 75% |</p>
<p>| <strong>Total</strong> | <strong>â‚¬20,500</strong> | <strong>â‚¬7,900</strong> | <strong>61%</strong> |</p>

<h3>9.2 Optimization Strategies</h3>

<h4>API Cost Reduction</h4>
<pre><code># Intelligent caching for API calls
class CostOptimizedAIService:
    def __init__(self):
        self.cache = SemanticCache()  # Vector similarity search
        self.token_counter = TokenCounter()

    async def generate(self, prompt: str) -&gt; str:
        # 1. Check semantic cache
        similar = await self.cache.find_similar(prompt, threshold=0.95)
        if similar:
            return similar.result

        # 2. Optimize prompt length
        optimized_prompt = self.optimize_prompt(prompt)

        # 3. Use cheaper model for simple requests
        model = self.select_model(optimized_prompt)

        # 4. Generate and cache
        result = await self.openai.generate(optimized_prompt, model=model)
        await self.cache.store(prompt, result)

        # 5. Track costs
        tokens = self.token_counter.count(optimized_prompt + result)
        await self.track_cost(model, tokens)

        return result</code></pre>

<h4>Infrastructure Optimization</h4>
<pre><code>Auto-scaling Configuration:
  Definition Service:
    min_replicas: 1  # Scale down during off-hours
    max_replicas: 10
    scale_down_delay: 5m
    metrics:
      - cpu: 70%
      - memory: 80%
      - requests_per_second: 100

  Scheduled Scaling:
    business_hours:  # 08:00-18:00
      min_replicas: 3
    after_hours:
      min_replicas: 1
    weekends:
      min_replicas: 1

Resource Optimization:
  - Use spot instances for non-critical workloads
  - Reserve instances for predictable workloads
  - Implement request coalescing
  - Use edge caching for static content</code></pre>

<h3>9.3 ROI Analysis</h3>

<pre><code>Investment (One-time):
  Migration: â‚¬150,000
  Training: â‚¬20,000
  Buffer: â‚¬30,000
  Total: â‚¬200,000

Monthly Savings:
  Operational: â‚¬12,600
  Productivity: â‚¬25,000 (100 hours @ â‚¬250/hour)
  Quality: â‚¬10,000 (reduced rework)
  Total: â‚¬47,600/month

ROI Timeline:
  Break-even: 4.2 months
  Year 1 ROI: 186%
  3-year ROI: 714%</code></pre>

<p>---</p>

<h2>10. Architecture Decision Records</h2>

<h3>ADR-001: Quality-First Migration Strategy</h3>
<ul>
<li>**Status**: Accepted</li>
<li>**Context**: 65% of code is unused, but quality is only 60%</li>
<li>**Decision**: Fix quality to 90% before migrating to microservices</li>
<li>**Consequences**: Delayed migration but higher success probability</li>
</ul>

<h3>ADR-002: Reuse Existing Microservice Components</h3>
<ul>
<li>**Status**: Accepted</li>
<li>**Context**: Analysis shows many microservice components already built</li>
<li>**Decision**: Reuse existing code instead of rewriting</li>
<li>**Consequences**: Faster migration, some refactoring needed</li>
</ul>

<h3>ADR-003: Event-Driven Architecture</h3>
<ul>
<li>**Status**: Accepted</li>
<li>**Context**: Need loose coupling for independent scaling</li>
<li>**Decision**: Use event-driven patterns with RabbitMQ</li>
<li>**Consequences**: Eventual consistency, better fault tolerance</li>
</ul>

<h3>ADR-004: PostgreSQL over NoSQL</h3>
<ul>
<li>**Status**: Accepted</li>
<li>**Context**: Need ACID compliance for government data</li>
<li>**Decision**: PostgreSQL with JSONB for flexibility</li>
<li>**Consequences**: Proven reliability, good JSON support</li>
</ul>

<h3>ADR-005: GVI Pattern Implementatie</h3>
<ul>
<li>**Status**: Accepted</li>
<li>**Context**: Current quality issues with AI generation</li>
<li>**Decision**: Implement Generation-Validation-Integration pattern</li>
<li>**Consequences**: Higher quality output, slightly more complex</li>
</ul>

<p>---</p>

<h2>11. Operational Runbooks</h2>

<h3>11.1 Uitrol Checklist</h3>

<pre><code>#!/bin/bash
# deploy.sh - Production deployment script

set -euo pipefail

# Pre-deployment checks
echo "ğŸ” Running pre-deployment checks..."
kubectl get nodes -o wide
kubectl top nodes

# Backup current state
echo "ğŸ’¾ Creating backup..."
kubectl create configmap backup-$(date +%Y%m%d-%H%M%S) \
  --from-literal=manifest="$(kubectl get all -o yaml)"

# Deploy new version
echo "ğŸš€ Deploying version ${VERSION}..."
helm upgrade --install definitieagent ./charts/definitieagent \
  --namespace definitieagent \
  --values values-prod.yaml \
  --set image.tag=${VERSION} \
  --wait --timeout 10m

# Verify deployment
echo "âœ… Verifying deployment..."
kubectl rollout status deployment -n definitieagent

# Run smoke tests
echo "ğŸ§ª Running smoke tests..."
pytest tests/smoke/ -v

echo "âœ¨ Uitrol complete!"</code></pre>

<h3>11.2 Incident Response Playbook</h3>

<h4>Severity Levels & Response Times</h4>
<p>| Severity | Description | Response Time | Resolution Time |</p>
<p>|----------|-------------|---------------|-----------------|</p>
<p>| P1 | Service Down / Data Loss | < 5 minutes | < 1 hour |</p>
<p>| P2 | Major Feature Broken | < 15 minutes | < 4 hours |</p>
<p>| P3 | Minor Feature Issue | < 1 hour | < 24 hours |</p>
<p>| P4 | Cosmetic / Low Impact | < 24 hours | Best effort |</p>

<h4>P1 - Service Down Playbook</h4>
<pre><code>Detection:
  - Uptime monitoring alerts (PagerDuty)
  - Multiple user reports
  - Health check failures

Incident Commander Checklist:
  1. Acknowledge incident in PagerDuty
  2. Join incident Slack channel #incident-{timestamp}
  3. Assign roles: Technical Lead, Communicator, Scribe
  4. Start incident timeline document

Initial Response (&lt; 5 min):
  1. Check service health:
     kubectl get pods -n definitieagent
     kubectl describe pod &lt;failing-pod&gt;

  2. Check recent deployments:
     kubectl rollout history deployment/definition-service
     helm list -n definitieagent

  3. Gather error logs:
     kubectl logs -l app=definition-service --tail=500
     kubectl logs -l app=definition-service --previous

Mitigation Options:
  - Immediate Rollback:
    helm rollback definitieagent &lt;previous-revision&gt;

  - Emergency Scale:
    kubectl scale deployment/definition-service --replicas=10

  - Circuit Breaker:
    kubectl set env deployment/definition-service CIRCUIT_BREAKER_ENABLED=true

  - Failover Region:
    kubectl config use-context dr-cluster
    helm install definitieagent-dr ./charts/definitieagent

Post-Incident:
  - Blameless postmortem within 48 hours
  - Update runbooks with learnings
  - Create prevention tickets</code></pre>

<h4>P2 - Prestaties Degradation Playbook</h4>
<pre><code>Detection:
  - Response time &gt; 5s alerts
  - CPU/Memory &gt; 80% sustained
  - Error rate &gt; 5%

Response (&lt; 15 min):
  1. Prestaties Diagnostics:
     # Check resource usage
     kubectl top pods -n definitieagent
     kubectl top nodes

     # Query slow endpoints
     promql: histogram_quantile(0.95, http_request_duration_seconds)

     # Check database performance
     kubectl exec -it postgres-primary -- psql -c "SELECT * FROM pg_stat_activity"

  2. Identify Bottleneck:
     # Distributed tracing
     Open Jaeger UI â†’ Filter by service â†’ Sort by duration

     # APM metrics
     Open Grafana â†’ Prestaties Dashboard â†’ Identify spike

  3. Quick Mitigations:
     # Increase cache TTL
     kubectl set env deployment/definition-service CACHE_TTL=3600

     # Enable read replicas
     kubectl scale statefulset postgres-read --replicas=3

     # Rate limit non-critical
     kubectl apply -f rate-limit-aggressive.yaml</code></pre>

<h4>Communication Templates</h4>
<pre><code># Initial Customer Communication (P1)
We are currently experiencing issues with DefinitieAgent.
Our team is actively investigating and working on a resolution.
Updates will be provided every 30 minutes at status.definitieagent.nl

# Resolution Communication
DefinitieAgent service has been restored.
Incident duration: {duration}
Root cause: {brief description}
Full postmortem will be available within 48 hours.</code></pre>

<h3>11.3 Developer Experience</h3>

<h4>Local Development Setup</h4>
<pre><code>#!/bin/bash
# One-command local development setup

# Clone and setup
git clone https://github.com/definitieagent/definitieagent
cd definitieagent
./scripts/setup-dev.sh

# What setup-dev.sh does:
# 1. Check prerequisites (Python 3.11+, Docker, Node.js)
# 2. Create virtual environment
# 3. Install afhankelijkheden with poetry
# 4. Start local services with docker-compose
# 5. Run database migrations
# 6. Seed test data
# 7. Start development servers with hot reload

# Result: Full stack running locally in &lt; 5 minutes</code></pre>

<h4>Development Tools</h4>
<pre><code>VSCode Extensions:
  - Python (ms-python)
  - Pylance
  - Docker
  - Kubernetes
  - Thunder Client (API testing)
  - Error Lens
  - GitLens

Pre-commit Hooks:
  - Black formatting
  - Ruff linting
  - Type checking (mypy)
  - Test coverage check
  - Beveiliging scan (bandit)
  - Dockerfile linting

Feature Flags:
  - Provider: LaunchDarkly
  - SDK: Python + React
  - Environments: dev, staging, prod
  - Targeting: User, Organization, Percentage</code></pre>

<h4>Debugging & Profiling</h4>
<pre><code># Development middleware for detailed debugging
if settings.DEBUG:
    app.add_middleware(
        DebugMiddleware,
        sql_logging=True,
        profile_requests=True,
        trace_exceptions=True
    )

# Prestaties profiling decorator
from pyinstrument import Profiler

@profile_endpoint
async def slow_endpoint():
    # Automatically profiles and logs slow requests
    pass

# Distributed tracing for local dev
from opentelemetry import trace
tracer = trace.get_tracer(__name__)

@tracer.start_as_current_span("process_definition")
async def process_definition(definition: Definition):
    # Traces visible in local Jaeger UI
    pass</code></pre>

<h4>Development Workflows</h4>
<pre><code># Feature Development Flow
git checkout -b feature/DEF-123-new-validation
poetry install  # Auto-installs new afhankelijkheden
make test-watch  # Continuous test running
make lint-fix   # Auto-fix code issues

# API Development
make api-docs   # Generate OpenAPI docs
make api-test   # Run API tests with coverage
make api-mock   # Start mock server

# Database Changes
make db-migration "add_quality_score"
make db-upgrade
make db-seed

# Container Development
make docker-build-local  # Fast local builds
make docker-run         # Run with hot reload
make docker-test        # Test in container</code></pre>

<h4>Developer Documentation</h4>
<pre><code>ğŸ“š Documentation Structure:
docs/
â”œâ”€â”€ architecture/      # You are here
â”œâ”€â”€ api/              # OpenAPI specs
â”œâ”€â”€ development/      # Dev guides
â”‚   â”œâ”€â”€ setup.md
â”‚   â”œâ”€â”€ testing.md
â”‚   â”œâ”€â”€ debugging.md
â”‚   â””â”€â”€ deployment.md
â”œâ”€â”€ tutorials/        # Step-by-step guides
â””â”€â”€ decisions/        # ADRs

ğŸ”— Quick Links:
- API Playground: http://localhost:8000/docs
- Metrics: http://localhost:9090
- Tracing: http://localhost:16686
- Logs: http://localhost:3000</code></pre>

<p>---</p>

<h2>12. Feature Implementatie Status</h2>

<h3>12.1 Complete Feature Registry</h3>

<h4>Feature Overview by Episch Verhaal</h4>
<p><strong>Laatst Bijgewerkt</strong>: 20-08-2025</p>

<h5>Episch Verhaal 001: Basis Definitie Generatie (80% Complete)</h5>
<p>| Feature ID | Feature Name | Status | Technical Implementatie | Afhankelijkheden |</p>
<p>|------------|--------------|--------|-------------------------|--------------|</p>
<p>| DEF-001 | AI-gestuurde definitie generator | âœ… Complete | <code>UnifiedDefinitionGenerator</code> | OpenAI API |</p>
<p>| DEF-002 | Context-bewuste generatie | âœ… Complete | <code>HybridContextManager</code> | Context DB |</p>
<p>| DEF-003 | Definitie templates | âœ… Complete | <code>template_service.py</code> | Template engine |</p>
<p>| DEF-004 | Bulk generatie mogelijkheden | âŒ Not Started | - | Async processing |</p>
<p>| DEF-005 | Multi-taal ondersteuning | âœ… Complete | <code>language_service.py</code> | Translation API |</p>

<h5>Episch Verhaal 002: Kwaliteitstoetsing (75% Complete)</h5>
<p>| Feature ID | Feature Name | Status | Technical Implementatie | Afhankelijkheden |</p>
<p>|------------|--------------|--------|-------------------------|--------------|</p>
<p>| VAL-001 | Automatische validatie regels | âœ… Complete | <code>DefinitionValidator</code> (45 rules) | Rules engine |</p>
<p>| VAL-002 | Expert review workflow | ğŸ”„ In Progress | <code>expert_review_tab.py</code> | Review service |</p>
<p>| VAL-003 | Kwaliteitsscore berekening | âœ… Complete | <code>quality_scorer.py</code> | Scoring engine |</p>
<p>| VAL-004 | Feedback incorporatie systeem | âœ… Complete | <code>feedback_service.py</code> | State management |</p>

<h5>Episch Verhaal 003: User Interface (20% Complete) ğŸ”´</h5>
<p>| Feature ID | Feature Name | Status | Technical Implementatie | Afhankelijkheden |</p>
<p>|------------|--------------|--------|-------------------------|--------------|</p>
<p>| UI-001 | Definition Generator Tab | âœ… Complete | <code>definition_generator_tab.py</code> | Active |</p>
<p>| UI-002 | Expert Review Tab | ğŸ”„ In Progress | <code>expert_review_tab.py</code> | Partial |</p>
<p>| UI-003 | History Tab | âœ… Complete | <code>history_tab.py</code> | Active |</p>
<p>| UI-004 | Export Tab | ğŸ”„ In Progress | <code>export_tab.py</code> | Partial |</p>
<p>| UI-005 | Web Lookup Tab | âŒ Not Started | <code>web_lookup_tab.py</code> exists | Inactive |</p>
<p>| UI-006 | Quality Control Tab | âŒ Not Started | <code>quality_control_tab.py</code> exists | Inactive |</p>
<p>| UI-007 | External Sources Tab | âŒ Not Started | <code>external_sources_tab.py</code> exists | Inactive |</p>
<p>| UI-008 | Monitoring Tab | âŒ Not Started | <code>monitoring_tab.py</code> exists | Inactive |</p>
<p>| UI-009 | Orchestration Tab | âŒ Not Started | <code>orchestration_tab.py</code> exists | Inactive |</p>
<p>| UI-010 | Context Selector Tab | âŒ Not Started | <code>context_selector.py</code> exists | Inactive |</p>
<p>| UI-011 | Responsive design | âŒ Not Started | - | CSS framework |</p>
<p>| UI-012 | Dark mode support | âŒ Not Started | - | Theme service |</p>
<p>| UI-013 | Keyboard shortcuts | âŒ Not Started | - | Hotkey handler |</p>
<p>| UI-014 | Accessibility features | ğŸ”„ In Progress | Partial WCAG | Screen reader |</p>
<p>| UI-015 | Multi-language UI | âŒ Not Started | - | i18n framework |</p>

<h5>Episch Verhaal 004: Beveiliging & Authentication (0% Complete) ğŸ”´</h5>
<p>| Feature ID | Feature Name | Status | Technical Implementatie | Afhankelijkheden |</p>
<p>|------------|--------------|--------|-------------------------|--------------|</p>
<p>| SEC-001 | User authentication system | âŒ Not Started | <code>auth/</code> folder exists unused | OAuth provider |</p>
<p>| SEC-002 | Role-based access control | âŒ Not Started | RBAC models exist | Policy engine |</p>
<p>| SEC-003 | API key management | âŒ Not Started | Partial in config | Vault service |</p>
<p>| SEC-004 | Data encryption at rest | âŒ Not Started | - | Crypto library |</p>
<p>| SEC-005 | Audit logging | âŒ Not Started | Basic logging only | Log aggregator |</p>

<h5>Episch Verhaal 005: Prestaties (20% Complete)</h5>
<p>| Feature ID | Feature Name | Status | Technical Implementatie | Afhankelijkheden |</p>
<p>|------------|--------------|--------|-------------------------|--------------|</p>
<p>| PERF-001 | Response time optimization | âŒ Not Started | Current: 8-12s | Caching layer |</p>
<p>| PERF-002 | Database query optimization | ğŸ”„ In Progress | Some indexes added | Query analyzer |</p>
<p>| PERF-003 | Caching implementation | âŒ Not Started | <code>cache_manager.py</code> unused | Redis setup |</p>
<p>| PERF-004 | Load balancing | âŒ Not Started | - | LB configuration |</p>
<p>| PERF-005 | Prestaties monitoring | âœ… Complete | Basic metrics only | APM tool |</p>

<h5>Episch Verhaal 006: Export/Import (14% Complete)</h5>
<p>| Feature ID | Feature Name | Status | Technical Implementatie | Afhankelijkheden |</p>
<p>|------------|--------------|--------|-------------------------|--------------|</p>
<p>| EXP-001 | JSON export | âœ… Complete | <code>export_service.py</code> | JSON library |</p>
<p>| EXP-002 | Excel export | ğŸ”„ In Progress | Partial implementation | OpenPyXL |</p>
<p>| EXP-003 | PDF export | âŒ Not Started | - | PDF generator |</p>
<p>| EXP-004 | Word export | âŒ Not Started | - | DOCX library |</p>
<p>| EXP-005 | CSV export | âŒ Not Started | Basic stub | CSV library |</p>
<p>| EXP-006 | Bulk import | âŒ Not Started | - | Async processor |</p>
<p>| EXP-007 | API integration | âŒ Not Started | - | API gateway |</p>

<h5>Episch Verhaal 007: Web Lookup & Integration (0% Complete) ğŸ”´</h5>
<p>| Feature ID | Feature Name | Status | Technical Implementatie | Afhankelijkheden |</p>
<p>|------------|--------------|--------|-------------------------|--------------|</p>
<p>| WEB-001 | Web search integration | âŒ Not Started | <code>web_lookup_service.py</code> unused | Search API |</p>
<p>| WEB-002 | Wikipedia integration | âŒ Not Started | Code exists unused | Wiki API |</p>
<p>| WEB-003 | Dictionary API integration | âŒ Not Started | - | Dict API |</p>
<p>| WEB-004 | External source validation | âŒ Not Started | - | Validator |</p>
<p>| WEB-005 | Source attribution | âŒ Not Started | - | Citation engine |</p>

<h5>Episch Verhaal 008: Monitoring & Analytics (40% Complete)</h5>
<p>| Feature ID | Feature Name | Status | Technical Implementatie | Afhankelijkheden |</p>
<p>|------------|--------------|--------|-------------------------|--------------|</p>
<p>| MON-001 | Usage analytics | ğŸ”„ In Progress | Basic tracking | Analytics DB |</p>
<p>| MON-002 | Error tracking | âœ… Complete | Error handler active | Sentry |</p>
<p>| MON-003 | Prestaties metrics | âŒ Not Started | - | Prometheus |</p>
<p>| MON-004 | User behavior tracking | âœ… Complete | Session tracking | Analytics |</p>
<p>| MON-005 | System health dashboard | âŒ Not Started | - | Grafana |</p>

<h5>Episch Verhaal 009: Content Management (67% Complete)</h5>
<p>| Feature ID | Feature Name | Status | Technical Implementatie | Afhankelijkheden |</p>
<p>|------------|--------------|--------|-------------------------|--------------|</p>
<p>| CMS-001 | Versie control | âœ… Complete | <code>version_service.py</code> | Git integration |</p>
<p>| CMS-002 | Definition categorization | âœ… Complete | Category taxonomy | Tag service |</p>
<p>| CMS-003 | Tag management | ğŸ”„ In Progress | Basic tagging | Tag DB |</p>
<p>| CMS-004 | Search functionality | âœ… Complete | Full-text search | Search index |</p>
<p>| CMS-005 | Archive management | âŒ Not Started | - | Archive policy |</p>
<p>| CMS-006 | Duplicate detection | âœ… Complete | Similarity check | ML model |</p>

<h3>12.2 UI Tab Activation Status</h3>

<p>| Tab Name | File Location | Status | Activation Afhankelijkheden | Prioriteit |</p>
<p>|----------|---------------|--------|------------------------|----------|</p>
<p>| Definition Generator | <code>definition_generator_tab.py</code> | âœ… Active | None | - |</p>
<p>| History | <code>history_tab.py</code> | âœ… Active | Database connection | - |</p>
<p>| Export | <code>export_tab.py</code> | ğŸ”„ Partial | Export service completion | P1 |</p>
<p>| Expert Review | <code>expert_review_tab.py</code> | ğŸ”„ Partial | Review workflow | P1 |</p>
<p>| Web Lookup | <code>web_lookup_tab.py</code> | âŒ Inactive | Web service integration | P0 |</p>
<p>| Quality Control | <code>quality_control_tab.py</code> | âŒ Inactive | Validation orchestrator | P1 |</p>
<p>| External Sources | <code>external_sources_tab.py</code> | âŒ Inactive | Source connectors | P2 |</p>
<p>| Monitoring | <code>monitoring_tab.py</code> | âŒ Inactive | Metrics collection | P2 |</p>
<p>| Orchestration | <code>orchestration_tab.py</code> | âŒ Inactive | Werkstroom engine | P2 |</p>
<p>| Context Selector | <code>context_selector.py</code> | âŒ Inactive | Context service | P1 |</p>

<h3>12.3 Feature Afhankelijkheden Matrix</h3>

<h4>Critical Path Afhankelijkheden</h4>
<pre><code>Authentication (SEC-001) â”€â”€â”¬â”€â”€â–º Multi-user DB (PERF-004)
                          â””â”€â”€â–º API Gateway (EXP-007)
                                    â”‚
Web Lookup (WEB-001) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–º External Sources Tab
                                   â”‚
Prestaties (&lt;5s) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â–º User Adoption</code></pre>

<h4>Service Afhankelijkheden</h4>
<p>| Service | Required For | Current State | Blockers |</p>
<p>|---------|--------------|---------------|----------|</p>
<p>| Redis Cache | Prestaties | Not configured | Infrastructure |</p>
<p>| OAuth Provider | Authentication | Not integrated | Beveiliging approval |</p>
<p>| Message Queue | Async processing | Not setup | Architecture decision |</p>
<p>| API Gateway | External access | Not deployed | Authentication first |</p>

<p>---</p>

<h2>13. Technical Debt Analysis</h2>

<h3>13.1 Codebase Overview</h3>
<p><strong>Laatst Bijgewerkt</strong>: 20-08-2025</p>

<h4>File Distribution</h4>
<pre><code>Total Python Files: 304
â”œâ”€â”€ Active/Used: 154 (51%)
â”œâ”€â”€ Unused: 150+ (49%)
â””â”€â”€ Test Files: 23 (7.5%)

Code Quality:
â”œâ”€â”€ Total Errors: 799 (improved from 880+)
â”œâ”€â”€ Critical (F821): 0 (resolved)
â”œâ”€â”€ Import Issues: 234
â”œâ”€â”€ Undefined Names: 0
â””â”€â”€ Complexity Issues: 156</code></pre>

<h3>13.2 Unused Components Analysis</h3>

<h4>High-Value Unused Services (Ready for Activation)</h4>
<p>| Component | Files | Location | Purpose | Activation Effort |</p>
<p>|-----------|-------|----------|---------|-------------------|</p>
<p>| Validation Rules | 78 | <code>toetsregels/validators/</code> | 45 validation rules | 1 week |</p>
<p>| Beveiliging Gateway | 12 | <code>auth/</code> | Complete OAuth impl | 2 weeks |</p>
<p>| Cache Manager | 8 | <code>cache/</code> | Redis integration | 3 days |</p>
<p>| Web Lookup | 15 | <code>services/web_lookup/</code> | External search | 1 week |</p>
<p>| Async Engine | 10 | <code>async/</code> | Background jobs | 1 week |</p>

<h4>Legacy Code for Removal</h4>
<p>| Component | Files | Location | Reason | Risk |</p>
<p>|-----------|-------|----------|--------|------|</p>
<p>| Old Validators | 50+ | <code>toetsregels/old/</code> | Superseded | None |</p>
<p>| Example Code | 30+ | <code>voorbeelden/async_*.py</code> | Not production | None |</p>
<p>| Test Stubs | 20+ | Various <code>_test.py</code> | Never geÃ¯mplementeerd | None |</p>
<p>| POC Code | 25+ | <code>experiments/</code> | Proof of concepts | None |</p>

<h3>13.3 Architecture Cleanup Plan</h3>

<h4>Phase 1: Quick Wins (Week 1)</h4>
<pre><code># Remove obvious dead code
toetsregels/regels/*.py (50+ files)
voorbeelden/async_*.py (10+ files)
experiments/**/*.py (25+ files)

# Estimated reduction: 85 files (28%)</code></pre>

<h4>Phase 2: Consolidation (Week 2)</h4>
<pre><code># Merge duplicate services
services/definition_*.py â†’ UnifiedDefinitionGenerator
validators/*_validator.py â†’ ValidationOrchestrator
cache/*_cache.py â†’ CacheManager

# Estimated reduction: 25 files (8%)</code></pre>

<h4>Phase 3: Activation (Week 3-4)</h4>
<pre><code># Activate valuable unused code
auth/ â†’ Enable authentication
cache/ â†’ Enable Redis caching
web_lookup/ â†’ Enable web search
monitoring/ â†’ Enable metrics

# Result: +40% functionality, -20% code</code></pre>

<h3>13.4 Component Relationships - Current State</h3>

<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        main.py (Entry)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   tabbed_interface.py     â”‚
         â”‚    (UI Controller)        â”‚
         â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚             â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  3 Active   â”‚   â”‚   7 Inactive      â”‚
     â”‚    Tabs     â”‚   â”‚     Tabs          â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚   Service Layer       â”‚
     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
     â”‚  â”‚ Generator       â”‚ â”‚ â† Used (20%)
     â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
     â”‚  â”‚ Validator       â”‚ â”‚ â† Partial (45%)
     â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
     â”‚  â”‚ Repository      â”‚ â”‚ â† Used (80%)
     â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
     â”‚  â”‚ Export          â”‚ â”‚ â† Partial (14%)
     â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
     â”‚  â”‚ Cache (Unused)  â”‚ â”‚ â† Ready to activate
     â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
     â”‚  â”‚ Auth (Unused)   â”‚ â”‚ â† Ready to activate
     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>

<h3>13.5 Migration Path to Clean Architecture</h3>

<h4>From Monolith to Services</h4>
<pre><code>Current State          â†’    Intermediate      â†’    Target State
(Monolithic)                (Modular)              (Services)

tabbed_interface.py    â†’    UI Controller     â†’    React Frontend
UnifiedGenerator      â†’    Generator Service  â†’    Definition API
DefinitionValidator   â†’    Validator Service  â†’    Validation API
SQLite Repository     â†’    PostgreSQL Repo    â†’    Data Service
In-memory cache       â†’    Redis Cache        â†’    Cache Service
No auth               â†’    OAuth Module       â†’    Auth Service</code></pre>

<p>---</p>

<h2>14. References</h2>

<h3>Internal Documentation</h3>
<ul>
<li>**Enterprise Architecture**: â†’ [EA Document](./ENTERPRISE_ARCHITECTURE.md)</li>
<li>**API Documentation**: https://api.definitieagent.nl/docs</li>
<li>**Runbooks**: /docs/runbooks/</li>
<p><!-- ADR directory niet meer beschikbaar na consolidatie - ADRs zijn geÃ¯ntegreerd in de canonical architecture documenten --></p>
</ul>

<h3>External Resources</h3>
<ul>
<li>**FastAPI**: https://fastapi.tiangolo.com/</li>
<li>**Kubernetes**: https://kubernetes.io/docs/</li>
<li>**PostgreSQL**: https://www.postgresql.org/docs/15/</li>
<li>**RabbitMQ**: https://www.rabbitmq.com/documentation.html</li>
</ul>

<h3>Compliance & Standards</h3>
<ul>
<li>**NCSC Guidelines**: https://www.ncsc.nl/</li>
<li>**BIO**: https://www.bio-overheid.nl/</li>
<li>**WCAG 2.1**: https://www.w3.org/WAI/WCAG21/quickref/</li>
</ul>

<p>---</p>

<h2>Document Control</h2>

<ul>
<li>**Versie**: 2.0</li>
<li>**Status**: Updated for Quality-First Approach</li>
<li>**Eigenaar**: Solution Architecture Team</li>
<li>**Laatst Bijgewerkt**: 19-08-2024</li>
<li>**Next Review**: 19-09-2024</li>
<li>**Distribution**: Development Team, Architecture Board, DevOps Team</li>
</ul>

<p>---</p>

<h2>Cross-References to Enterprise Architecture</h2>

<p>This Solution Architecture implements the strategic vision and vereistes defined in the Enterprise Architecture:</p>

<ol>
<li>**Business Context** â†’ [EA Section 1: Business Architecture] - Strategic drivers and capabilities</li>
<li>**Compliance Vereisten** â†’ [EA Section 5: Beveiliging & Risk] - Beveiliging framework and compliance mandates</li>
<li>**Technology Standards** â†’ [EA Section 4.1: Technology Standards] - Approved technologies and principles</li>
<li>**Investment Justification** â†’ [EA Section 7.2: Investment Portfolio] - Business case and ROI targets</li>
<li>**Strategic Alignment** â†’ [EA Section 7.1: Strategic Roadmap] - Business transformation timeline</li>
</ol>

<p>This document focuses on the technical implementation while ensuring alignment with enterprise standards and strategic objectives.</p>

  </div>
</body>
</html>