<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Synonym Management Architecture Design</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">← Terug naar Portal</a>
    <h1>Synonym Management Architecture Design</h1>
<p><strong>DefinitieAgent Applicatie</strong></p>

<h2>Executive Summary</h2>

<p>Dit document presenteert een architectuurontwerp voor een geïntegreerd synonym management systeem in de DefinitieAgent applicatie. Het ontwerp integreert naadloos met bestaande services zonder de huidige definitie generatie flow te verstoren, terwijl het synoniemen vroeg in de flow beschikbaar maakt voor zowel web lookup als definitie generatie.</p>

<h2>1. Architecturaal Overzicht</h2>

<h3>1.1 Huidige Situatie</h3>

<pre><code>graph TD
    A[UI Request] --&gt; B[ServiceContainer]
    B --&gt; C[DefinitionOrchestratorV2]
    C --&gt; D[PromptService]
    C --&gt; E[WebLookupService]
    C --&gt; F[AIService]

    E --&gt; G[config/juridische_synoniemen.yaml]

    style G fill:#ffcccc,stroke:#ff0000,stroke-width:2px</code></pre>

<p><strong>Problemen:</strong></p>
<ul>
<li>Synoniemen hardcoded in YAML file</li>
<li>Geen dynamische synonym generatie</li>
<li>Database tabel `synonym_suggestions` bestaat maar wordt niet gebruikt</li>
<li>Web lookup gebruikt alleen statische synoniemen</li>
</ul>

<h3>1.2 Voorgestelde Architectuur</h3>

<pre><code>graph TD
    A[UI Request] --&gt; B[ServiceContainer]
    B --&gt; C[DefinitionOrchestratorV2]

    C --&gt; SM[SynonymManagementService]
    SM --&gt; DB[(synonym_suggestions DB)]
    SM --&gt; AI[AIService voor synoniemen]
    SM --&gt; CACHE[SynonymCache]

    C --&gt; D[PromptService]
    D --&gt; SM

    C --&gt; E[WebLookupService]
    E --&gt; SM

    C --&gt; F[AIService voor definitie]

    style SM fill:#ccffcc,stroke:#00aa00,stroke-width:3px
    style CACHE fill:#ffffcc,stroke:#ffaa00,stroke-width:2px</code></pre>

<h2>2. Component Design</h2>

<h3>2.1 SynonymManagementService</h3>

<p><strong>Locatie:</strong> <code>src/services/synonym_management_service.py</code></p>

<pre><code>class SynonymManagementService:
    """
    Centrale service voor synonym management.
    Integreert DB, AI generatie, en caching.
    """

    def __init__(
        self,
        repository: SynonymRepository,
        ai_service: AIServiceV2,
        cache_ttl: int = 3600
    ):
        self.repository = repository
        self.ai_service = ai_service
        self.cache = TTLCache(maxsize=1000, ttl=cache_ttl)

    async def get_synonyms_for_term(
        self,
        term: str,
        context: Optional[SynonymContext] = None,
        max_count: int = 5,
        include_generated: bool = True
    ) -&gt; SynonymResult:
        """
        Hoofdinterface voor synonym retrieval.
        Implementeert de vereiste flow logica.
        """</code></pre>

<h3>2.2 Database Schema Uitbreidingen</h3>

<p><strong>Bestaande tabel:</strong> <code>synonym_suggestions</code></p>

<p><strong>Nieuwe indexen voor performance:</strong></p>
<pre><code>-- Composite index voor snelle voorkeursterm lookup
CREATE INDEX idx_synonym_voorkeursterm
ON synonym_suggestions(hoofdterm, is_voorkeursterm, confidence DESC);

-- Index voor context-based filtering
CREATE INDEX idx_synonym_context
ON synonym_suggestions(hoofdterm, status, context_type);</code></pre>

<p><strong>Nieuwe kolom toevoegen:</strong></p>
<pre><code>ALTER TABLE synonym_suggestions
ADD COLUMN is_voorkeursterm BOOLEAN DEFAULT FALSE;

ALTER TABLE synonym_suggestions
ADD COLUMN context_type VARCHAR(50)
CHECK (context_type IN ('juridisch', 'organisatorisch', 'algemeen'));

ALTER TABLE synonym_suggestions
ADD COLUMN source VARCHAR(50) DEFAULT 'manual'
CHECK (source IN ('manual', 'ai_generated', 'imported', 'validated'));</code></pre>

<h2>3. Integration Points</h2>

<h3>3.1 Integratie in DefinitionOrchestratorV2</h3>

<p><strong>Locatie:</strong> Fase 2.3 (tussen Feedback Integration en Web Lookup)</p>

<pre><code># PHASE 2.3: Synonym Enrichment (NEW)
# =====================================
synonyms = None
synonym_status = "not_available"

if self.synonym_service:  # Injected via ServiceContainer
    try:
        synonym_context = SynonymContext(
            organisatorisch=sanitized_request.organisatorische_context,
            juridisch=sanitized_request.juridische_context,
            wettelijk=sanitized_request.wettelijke_basis
        )

        synonym_result = await self.synonym_service.get_synonyms_for_term(
            term=sanitized_request.begrip,
            context=synonym_context,
            max_count=5,
            include_generated=True
        )

        synonyms = synonym_result.synonyms
        synonym_status = "success"

        # Attach to context for downstream services
        context = context or {}
        context["synonyms"] = {
            "terms": synonyms,
            "voorkeursterm": synonym_result.voorkeursterm,
            "source": synonym_result.source
        }

    except Exception as e:
        logger.warning(f"Synonym enrichment failed: {e}")
        synonym_status = "error"</code></pre>

<h3>3.2 Integratie in ModernWebLookupService</h3>

<p><strong>Aanpassing in <code>_lookup_mediawiki</code> methode:</strong></p>

<pre><code># Gebruik synoniemen uit context voor uitgebreide search
synonym_context = context.get("synonyms", {}) if context else {}
synonym_terms = synonym_context.get("terms", [])

# Voeg synoniemen toe aan fallback lijst
if synonym_terms and not result:
    for synonym in synonym_terms[:3]:  # Top 3 synoniemen
        try:
            syn_result = await wikipedia_lookup(synonym)
            if syn_result and syn_result.success:
                result = syn_result
                break
        except Exception:
            continue</code></pre>

<h3>3.3 Integratie in PromptServiceV2</h3>

<pre><code># In build_generation_prompt method
synonyms = context.get("synonyms", {}) if context else {}
if synonyms and synonyms.get("terms"):
    prompt_parts.append(
        f"\n### Synoniemen:\n"
        f"Voorkeursterm: {synonyms.get('voorkeursterm', request.begrip)}\n"
        f"Gerelateerde termen: {', '.join(synonyms.get('terms', []))}\n"
    )</code></pre>

<h2>4. Data Flow</h2>

<h3>4.1 Primaire Flow (Cache Hit)</h3>

<pre><code>sequenceDiagram
    participant UI
    participant Orch as Orchestrator
    participant Syn as SynonymService
    participant Cache
    participant Prompt as PromptService
    participant Web as WebLookup

    UI-&gt;&gt;Orch: GenerationRequest
    Orch-&gt;&gt;Syn: get_synonyms_for_term()
    Syn-&gt;&gt;Cache: check cache
    Cache--&gt;&gt;Syn: synonyms (hit)
    Syn--&gt;&gt;Orch: SynonymResult

    par Parallel execution
        Orch-&gt;&gt;Web: lookup with synonyms
        Web--&gt;&gt;Orch: enriched results
    and
        Orch-&gt;&gt;Prompt: build with synonyms
        Prompt--&gt;&gt;Orch: enhanced prompt
    end</code></pre>

<h3>4.2 Secundaire Flow (Cache Miss, DB Hit)</h3>

<pre><code>sequenceDiagram
    participant Syn as SynonymService
    participant Cache
    participant DB as Database
    participant AI as AIService

    Note over Syn: Cache miss
    Syn-&gt;&gt;DB: query synonym_suggestions

    alt Sufficient synonyms in DB
        DB--&gt;&gt;Syn: 5+ synonyms
        Syn-&gt;&gt;Cache: store in cache
    else Insufficient synonyms
        DB--&gt;&gt;Syn: &lt; 5 synonyms
        Syn-&gt;&gt;AI: generate_synonyms()
        AI--&gt;&gt;Syn: new synonyms
        Syn-&gt;&gt;DB: save to DB
        Syn-&gt;&gt;Cache: store combined
    end</code></pre>

<h2>5. Caching Strategie</h2>

<h3>5.1 Multi-Level Caching</h3>

<pre><code>class SynonymCache:
    """
    Multi-level cache voor optimale performance.
    """

    def __init__(self):
        # L1: In-memory voor hot terms (TTL: 1 hour)
        self.l1_cache = TTLCache(maxsize=100, ttl=3600)

        # L2: Redis voor distributed cache (TTL: 24 hours)
        self.l2_cache = RedisCache(ttl=86400)

        # L3: Database (persistent)</code></pre>

<h3>5.2 Cache Invalidation</h3>

<ul>
<li>**Trigger points:**</li>
<li> - Nieuwe synonym approval/rejection</li>
<li> - Bulk import van synoniemen</li>
<li> - Voorkeursterm wijziging</li>
<li> - Context update</li>
</ul>

<h2>6. API Design voor AI Synonym Generation</h2>

<h3>6.1 Prompt Template</h3>

<pre><code>SYNONYM_GENERATION_PROMPT = """
Genereer 5 synoniemen voor het juridische begrip: {term}

Context:
- Organisatorisch: {org_context}
- Juridisch: {jur_context}
- Wettelijk: {wet_context}

Vereisten:
1. Synoniemen moeten juridisch correct zijn
2. Vermijd informele termen
3. Rangschik op relevantie (meest relevant eerst)
4. Geef per synoniem een confidence score (0.0-1.0)

Output format (JSON):
{{
  "synoniemen": [
    {{"term": "...", "confidence": 0.95, "rationale": "..."}},
    ...
  ]
}}
"""</code></pre>

<h3>6.2 Temperature Settings</h3>

<ul>
<li>**Synonym generation:** 0.3 (consistent, betrouwbare output)</li>
<li>**Fallback generation:** 0.5 (meer variatie bij retry)</li>
</ul>

<h2>7. Performance Optimalisaties</h2>

<h3>7.1 Async/Await Pattern</h3>

<pre><code>async def enrich_with_synonyms(self, terms: List[str]) -&gt; Dict[str, List[str]]:
    """
    Parallel synonym enrichment voor multiple terms.
    """
    tasks = [
        self.get_synonyms_for_term(term)
        for term in terms
    ]
    results = await asyncio.gather(*tasks, return_exceptions=True)

    return {
        term: result.synonyms if not isinstance(result, Exception) else []
        for term, result in zip(terms, results)
    }</code></pre>

<h3>7.2 Batch Processing</h3>

<pre><code>async def bulk_generate_synonyms(self, terms: List[str]) -&gt; None:
    """
    Batch generation voor efficiency.
    """
    # Process in chunks van 10
    for chunk in chunks(terms, 10):
        await self._process_synonym_chunk(chunk)</code></pre>

<h2>8. Error Handling & Fallbacks</h2>

<h3>8.1 Graceful Degradation</h3>

<pre><code>class SynonymFallbackChain:
    """
    Fallback chain voor robuustheid.
    """

    async def get_synonyms(self, term: str) -&gt; List[str]:
        strategies = [
            self._from_cache,
            self._from_database,
            self._from_ai_service,
            self._from_static_config,
            self._empty_list
        ]

        for strategy in strategies:
            try:
                result = await strategy(term)
                if result:
                    return result
            except Exception as e:
                logger.warning(f"Strategy {strategy.__name__} failed: {e}")
                continue

        return []</code></pre>

<h3>8.2 Circuit Breaker Pattern</h3>

<pre><code>class AIServiceCircuitBreaker:
    """
    Circuit breaker voor AI service calls.
    """

    def __init__(self, failure_threshold: int = 5, timeout: int = 60):
        self.failure_count = 0
        self.failure_threshold = failure_threshold
        self.timeout = timeout
        self.last_failure_time = None
        self.state = "CLOSED"  # CLOSED, OPEN, HALF_OPEN</code></pre>

<h2>9. Monitoring & Observability</h2>

<h3>9.1 Metrics</h3>

<pre><code>SYNONYM_METRICS = {
    "cache_hit_rate": Gauge("synonym_cache_hits_total"),
    "ai_generation_latency": Histogram("synonym_ai_generation_seconds"),
    "db_query_latency": Histogram("synonym_db_query_seconds"),
    "terms_without_synonyms": Counter("terms_without_synonyms_total"),
}</code></pre>

<h3>9.2 Logging</h3>

<pre><code># Structured logging voor analysis
logger.info(
    "Synonym enrichment completed",
    extra={
        "term": term,
        "source": source,
        "synonym_count": len(synonyms),
        "cache_hit": cache_hit,
        "latency_ms": latency,
        "context_type": context_type
    }
)</code></pre>

<h2>10. Migration Strategy</h2>

<h3>10.1 Phased Rollout</h3>

<p><strong>Fase 1: Infrastructure (Week 1)</strong></p>
<ul>
<li>Database schema updates</li>
<li>SynonymManagementService implementation</li>
<li>Unit tests</li>
</ul>

<p><strong>Fase 2: Integration (Week 2)</strong></p>
<ul>
<li>ServiceContainer integration</li>
<li>Orchestrator integration points</li>
<li>Integration tests</li>
</ul>

<p><strong>Fase 3: Migration (Week 3)</strong></p>
<ul>
<li>Import existing YAML synoniemen naar DB</li>
<li>Parallel run (beide systemen actief)</li>
<li>Performance monitoring</li>
</ul>

<p><strong>Fase 4: Cutover (Week 4)</strong></p>
<ul>
<li>Deactiveer YAML-based system</li>
<li>Full production rollout</li>
<li>Deprecate oude code</li>
</ul>

<h3>10.2 Rollback Plan</h3>

<pre><code># Feature flag voor safe rollback
SYNONYM_SERVICE_ENABLED = os.getenv("SYNONYM_SERVICE_ENABLED", "false") == "true"

if SYNONYM_SERVICE_ENABLED:
    synonyms = await self.synonym_service.get_synonyms()
else:
    synonyms = self._load_from_yaml()  # Legacy fallback</code></pre>

<h2>11. Security & Privacy</h2>

<h3>11.1 Data Sanitization</h3>

<pre><code>def sanitize_synonym_input(self, term: str) -&gt; str:
    """
    Sanitize input voor SQL injection preventie.
    """
    # Remove special characters
    sanitized = re.sub(r'[^\w\s-]', '', term)
    # Limit length
    return sanitized[:255]</code></pre>

<h3>11.2 Access Control</h3>

<pre><code>class SynonymAccessControl:
    """
    Role-based access voor synonym management.
    """

    PERMISSIONS = {
        "view": ["user", "admin"],
        "suggest": ["user", "admin"],
        "approve": ["admin"],
        "delete": ["admin"]
    }</code></pre>

<h2>12. Testing Strategy</h2>

<h3>12.1 Unit Tests</h3>

<pre><code># tests/services/test_synonym_management_service.py
class TestSynonymManagementService:
    async def test_get_synonyms_cache_hit(self):
        """Test cache hit scenario"""

    async def test_get_synonyms_db_fallback(self):
        """Test database fallback"""

    async def test_ai_generation_trigger(self):
        """Test AI generation when &lt; 5 synonyms"""

    async def test_voorkeursterm_priority(self):
        """Test voorkeursterm gets highest priority"""</code></pre>

<h3>12.2 Integration Tests</h3>

<pre><code># tests/integration/test_synonym_flow_e2e.py
class TestSynonymFlowE2E:
    async def test_full_generation_with_synonyms(self):
        """Test complete flow from request to definition"""

    async def test_web_lookup_with_synonyms(self):
        """Test web lookup uses generated synonyms"""</code></pre>

<h2>13. Configuration</h2>

<h3>13.1 Environment Variables</h3>

<pre><code># config/synonym_service.yaml
synonym_service:
  enabled: true
  cache:
    ttl_seconds: 3600
    max_size: 1000
  ai:
    model: "gpt-4"
    temperature: 0.3
    max_retries: 3
    timeout_seconds: 10
  database:
    batch_size: 100
    query_timeout: 5
  features:
    auto_generate: true
    use_voorkeursterm: true
    context_aware: true</code></pre>

<h2>14. Conclusie & Aanbevelingen</h2>

<h3>Voordelen van deze Architectuur</h3>

<ol>
<li>**Minimale Disruption:** Integreert naadloos zonder bestaande flows te breken</li>
<li>**Performance:** Multi-level caching voorkomt onnodige API calls</li>
<li>**Flexibiliteit:** Ondersteunt zowel statische als dynamische synoniemen</li>
<li>**Schaalbaarheid:** Async design met batch processing capabilities</li>
<li>**Robuustheid:** Fallback chains en circuit breakers</li>
</ol>

<h3>Aanbevolen Volgende Stappen</h3>

<ol>
<li>**Review & Goedkeuring:** Architectuur review met team</li>
<li>**Proof of Concept:** Implementeer SynonymManagementService core</li>
<li>**Performance Testing:** Benchmark cache hit rates en latency</li>
<li>**Gradual Migration:** Start met read-only mode, dan write capabilities</li>
<li>**Monitoring Setup:** Implementeer metrics en dashboards</li>
</ol>

<h3>Risico's & Mitigaties</h3>

<p>| Risico | Impact | Waarschijnlijkheid | Mitigatie |</p>
<p>|--------|--------|-------------------|-----------|</p>
<p>| AI Service Overload | Hoog | Middel | Circuit breaker, rate limiting |</p>
<p>| Cache Invalidation Issues | Middel | Laag | TTL-based expiry, manual refresh |</p>
<p>| Database Performance | Middel | Middel | Proper indexing, query optimization |</p>
<p>| Migration Failures | Hoog | Laag | Feature flags, rollback plan |</p>

<h2>Appendix A: Service Interface Definitions</h2>

<pre><code>from dataclasses import dataclass
from typing import List, Optional, Dict, Any
from enum import Enum

class SynonymSource(Enum):
    CACHE = "cache"
    DATABASE = "database"
    AI_GENERATED = "ai_generated"
    STATIC_CONFIG = "static_config"

@dataclass
class SynonymContext:
    organisatorisch: List[str]
    juridisch: List[str]
    wettelijk: List[str]

@dataclass
class Synonym:
    term: str
    confidence: float
    rationale: str
    source: SynonymSource
    is_voorkeursterm: bool = False

@dataclass
class SynonymResult:
    synonyms: List[str]
    voorkeursterm: Optional[str]
    source: SynonymSource
    metadata: Dict[str, Any]</code></pre>

<h2>Appendix B: Database Migration Script</h2>

<pre><code>-- Migration script voor synonym_suggestions uitbreiding
BEGIN TRANSACTION;

-- Add new columns
ALTER TABLE synonym_suggestions
ADD COLUMN is_voorkeursterm BOOLEAN DEFAULT FALSE;

ALTER TABLE synonym_suggestions
ADD COLUMN context_type VARCHAR(50);

ALTER TABLE synonym_suggestions
ADD COLUMN source VARCHAR(50) DEFAULT 'manual';

-- Update existing data
UPDATE synonym_suggestions
SET context_type = 'algemeen'
WHERE context_type IS NULL;

-- Add new indexes
CREATE INDEX idx_synonym_voorkeursterm
ON synonym_suggestions(hoofdterm, is_voorkeursterm, confidence DESC);

CREATE INDEX idx_synonym_context
ON synonym_suggestions(hoofdterm, status, context_type);

-- Add check constraints
ALTER TABLE synonym_suggestions
ADD CONSTRAINT check_context_type
CHECK (context_type IN ('juridisch', 'organisatorisch', 'algemeen'));

ALTER TABLE synonym_suggestions
ADD CONSTRAINT check_source
CHECK (source IN ('manual', 'ai_generated', 'imported', 'validated'));

COMMIT;</code></pre>

<p>---</p>

<p><em>Document Versie: 1.0</em></p>
<p><em>Datum: 2025-10-09</em></p>
<p><em>Auteur: Architecture Team</em></p>
<p><em>Status: DRAFT - For Review</em></p>
  </div>
</body>
</html>