<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>US-402: titel: Version Comparison and Diff Viewer</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">‚Üê Terug naar Portal</a>
    <p>---</p>
<p>id: US-402</p>
<p>epic: EPIC-021</p>
<p>titel: "US-402: titel: Version Comparison and Diff Viewer"</p>
<p>type: feature</p>
<p>status: proposed</p>
<p>prioriteit: HIGH</p>
<p>story_points: 5</p>
<p>sprint: backlog</p>
<p>aangemaakt: 2025-09-29</p>
<p>bijgewerkt: 2025-09-29</p>
<p>owner: product-owner</p>
<p>applies_to: definitie-app@current</p>
<p>canonical: false</p>
<p>last_verified: 2025-10-02</p>
<p>vereisten:</p>
<ul>
<li> - REQ-101</li>
<p>toegewezen_aan: development-team</p>
<p>---</p>
</ul>

<h1>US-402: Version Comparison and Diff Viewer</h1>

<p><strong>Epic:</strong> EPIC-021 - Definitie Geschiedenis & Audit Trail Management</p>

<h2>Gebruikersverhaal</h2>

<p><strong>Als een</strong> juridisch professional</p>
<p><strong>wil ik</strong> verschillende versies van definities kunnen vergelijken</p>
<p><strong>zodat</strong> ik kan zien wat er precies is veranderd tussen versies</p>

<h2>Acceptance Criteria</h2>

<h3>Functional Requirements</h3>

<ul>
<li>[ ] **Version Selection**</li>
<li> - Select two versions to compare</li>
<li> - Select multiple versions for timeline comparison</li>
<li> - Quick compare with previous version</li>
<li> - Compare across branches</li>
<li> - Compare with published version</li>
</ul>

<ul>
<li>[ ] **Diff Visualization**</li>
<li> - Side-by-side comparison view</li>
<li> - Inline diff view with highlights</li>
<li> - Unified diff view</li>
<li> - Word-level diff granularity</li>
<li> - Character-level diff for small changes</li>
</ul>

<ul>
<li>[ ] **Change Highlighting**</li>
<li> - Green for additions</li>
<li> - Red for deletions</li>
<li> - Yellow for modifications</li>
<li> - Gray for unchanged context</li>
<li> - Special marking for moved content</li>
</ul>

<ul>
<li>[ ] **Diff Types**</li>
<li> - Text content differences</li>
<li> - Metadata changes</li>
<li> - Validation result changes</li>
<li> - Example changes</li>
<li> - Source/reference changes</li>
</ul>

<ul>
<li>[ ] **Export Options**</li>
<li> - Export diff as PDF</li>
<li> - Export as HTML report</li>
<li> - Export as JSON diff</li>
<li> - Share diff via link</li>
<li> - Print-friendly view</li>
</ul>

<h3>UI Requirements</h3>

<ul>
<li>[ ] **Comparison Interface**</li>
<pre><code>  +------------------+------------------+
  | Version 1.0      | Version 2.0      |
  | 2024-01-15       | 2024-02-20       |
  +------------------+------------------+
  | Original text    | Modified text    |
  | with some        | with [+new+]     |
  | [-removed-]      | content added    |
  | content          | and changed      |
  +------------------+------------------+</code></pre>
</ul>

<ul>
<li>[ ] **Timeline View**</li>
<li> - Visual timeline of all versions</li>
<li> - Clickable points for each version</li>
<li> - Highlight major changes</li>
<li> - Show change metrics</li>
</ul>

<ul>
<li>[ ] **Filter Options**</li>
<li> - Show only changes</li>
<li> - Filter by field type</li>
<li> - Filter by change type</li>
<li> - Search within changes</li>
</ul>

<h3>Technical Requirements</h3>

<ul>
<li>[ ] **Diff Service**</li>
<pre><code>  class DiffService:
      def compare_versions(
          self,
          version_a: Version,
          version_b: Version,
          options: DiffOptions
      ) -&gt; DiffResult

      def generate_diff_html(
          self,
          diff_result: DiffResult,
          template: str = 'side_by_side'
      ) -&gt; str

      def calculate_change_metrics(
          self,
          diff_result: DiffResult
      ) -&gt; ChangeMetrics</code></pre>
</ul>

<ul>
<li>[ ] **API Endpoints**</li>
<li> - GET /api/versions/compare?v1={id}&v2={id}</li>
<li> - GET /api/definitions/{id}/diff/{v1}/{v2}</li>
<li> - POST /api/diff/export</li>
<li> - GET /api/diff/metrics</li>
</ul>

<h2>Implementation Details</h2>

<h3>Diff Algorithm Implementation</h3>

<pre><code>import difflib
from dataclasses import dataclass
from typing import List, Tuple, Optional
from enum import Enum

class ChangeType(Enum):
    ADDED = "added"
    DELETED = "deleted"
    MODIFIED = "modified"
    MOVED = "moved"
    UNCHANGED = "unchanged"

@dataclass
class DiffSegment:
    type: ChangeType
    content_a: Optional[str]
    content_b: Optional[str]
    line_numbers_a: Tuple[int, int]
    line_numbers_b: Tuple[int, int]
    similarity: float

class AdvancedDiffService:
    def __init__(self):
        self.word_differ = difflib.Differ()
        self.sequence_matcher = difflib.SequenceMatcher()

    def compare_definitions(
        self,
        version_a: dict,
        version_b: dict
    ) -&gt; dict:
        """Compare two definition versions"""

        diff_result = {
            'metadata': self._compare_metadata(version_a, version_b),
            'content': self._compare_content(version_a, version_b),
            'examples': self._compare_examples(
                version_a.get('voorbeelden', []),
                version_b.get('voorbeelden', [])
            ),
            'validation': self._compare_validation(
                version_a.get('validatie_resultaten'),
                version_b.get('validatie_resultaten')
            ),
            'metrics': self._calculate_metrics(version_a, version_b)
        }

        return diff_result

    def _compare_content(
        self,
        content_a: str,
        content_b: str
    ) -&gt; List[DiffSegment]:
        """Perform word-level diff on content"""

        # Split into words while preserving whitespace
        words_a = self._tokenize(content_a)
        words_b = self._tokenize(content_b)

        # Use sequence matcher for intelligent diff
        self.sequence_matcher.set_seqs(words_a, words_b)
        opcodes = self.sequence_matcher.get_opcodes()

        segments = []
        for tag, i1, i2, j1, j2 in opcodes:
            if tag == 'equal':
                segments.append(DiffSegment(
                    type=ChangeType.UNCHANGED,
                    content_a=' '.join(words_a[i1:i2]),
                    content_b=' '.join(words_b[j1:j2]),
                    line_numbers_a=(i1, i2),
                    line_numbers_b=(j1, j2),
                    similarity=1.0
                ))
            elif tag == 'delete':
                segments.append(DiffSegment(
                    type=ChangeType.DELETED,
                    content_a=' '.join(words_a[i1:i2]),
                    content_b=None,
                    line_numbers_a=(i1, i2),
                    line_numbers_b=(j1, j2),
                    similarity=0.0
                ))
            elif tag == 'insert':
                segments.append(DiffSegment(
                    type=ChangeType.ADDED,
                    content_a=None,
                    content_b=' '.join(words_b[j1:j2]),
                    line_numbers_a=(i1, i2),
                    line_numbers_b=(j1, j2),
                    similarity=0.0
                ))
            elif tag == 'replace':
                # Check if content was moved
                similarity = self._calculate_similarity(
                    ' '.join(words_a[i1:i2]),
                    ' '.join(words_b[j1:j2])
                )

                if similarity &gt; 0.8:
                    change_type = ChangeType.MODIFIED
                else:
                    change_type = ChangeType.MODIFIED

                segments.append(DiffSegment(
                    type=change_type,
                    content_a=' '.join(words_a[i1:i2]),
                    content_b=' '.join(words_b[j1:j2]),
                    line_numbers_a=(i1, i2),
                    line_numbers_b=(j1, j2),
                    similarity=similarity
                ))

        return segments

    def _tokenize(self, text: str) -&gt; List[str]:
        """Tokenize text preserving whitespace"""
        import re
        return re.findall(r'\S+|\s+', text)

    def _calculate_similarity(self, text_a: str, text_b: str) -&gt; float:
        """Calculate similarity between two text segments"""
        return difflib.SequenceMatcher(None, text_a, text_b).ratio()</code></pre>

<h3>UI Component</h3>

<pre><code>import streamlit as st
from typing import Optional

class VersionComparisonUI:
    def __init__(self, diff_service: AdvancedDiffService):
        self.diff_service = diff_service

    def render_comparison_view(
        self,
        definition_id: int,
        version_a_id: Optional[int] = None,
        version_b_id: Optional[int] = None
    ):
        """Render version comparison interface"""

        st.header("üìä Versie Vergelijking")

        # Version selector
        col1, col2 = st.columns(2)

        with col1:
            st.subheader("Versie A")
            versions = self._get_versions(definition_id)
            version_a = st.selectbox(
                "Selecteer eerste versie",
                versions,
                format_func=lambda v: f"v{v.number} - {v.date}"
            )

        with col2:
            st.subheader("Versie B")
            version_b = st.selectbox(
                "Selecteer tweede versie",
                versions,
                format_func=lambda v: f"v{v.number} - {v.date}"
            )

        # View mode selector
        view_mode = st.radio(
            "Weergave modus",
            ["Side-by-side", "Inline", "Unified"],
            horizontal=True
        )

        # Perform comparison
        if st.button("Vergelijk Versies", type="primary"):
            diff_result = self.diff_service.compare_definitions(
                version_a.content,
                version_b.content
            )

            # Render diff based on view mode
            if view_mode == "Side-by-side":
                self._render_side_by_side(diff_result)
            elif view_mode == "Inline":
                self._render_inline(diff_result)
            else:
                self._render_unified(diff_result)

            # Show metrics
            self._render_metrics(diff_result['metrics'])

    def _render_side_by_side(self, diff_result: dict):
        """Render side-by-side diff view"""
        col1, col2 = st.columns(2)

        with col1:
            st.markdown("### Origineel")
            for segment in diff_result['content']:
                if segment.type != ChangeType.ADDED:
                    self._render_segment(segment, 'left')

        with col2:
            st.markdown("### Nieuw")
            for segment in diff_result['content']:
                if segment.type != ChangeType.DELETED:
                    self._render_segment(segment, 'right')

    def _render_segment(self, segment: DiffSegment, side: str):
        """Render a diff segment with appropriate styling"""
        style_map = {
            ChangeType.ADDED: "background-color: #d4f5d4;",
            ChangeType.DELETED: "background-color: #f5d4d4;",
            ChangeType.MODIFIED: "background-color: #f5f5d4;",
            ChangeType.UNCHANGED: ""
        }

        style = style_map.get(segment.type, "")
        content = segment.content_a if side == 'left' else segment.content_b

        if content:
            st.markdown(
                f'&lt;p style="{style}"&gt;{content}&lt;/p&gt;',
                unsafe_allow_html=True
            )</code></pre>

<h2>Test Scenarios</h2>

<h3>Unit Tests</h3>

<pre><code>def test_basic_diff():
    """Test basic text diffing"""
    service = AdvancedDiffService()
    result = service.compare_content(
        "The quick brown fox",
        "The slow brown fox"
    )
    assert any(s.type == ChangeType.MODIFIED for s in result)

def test_complex_changes():
    """Test complex multi-field changes"""
    version_a = {
        'term': 'Contract',
        'definitie': 'Een overeenkomst',
        'voorbeelden': ['Voorbeeld 1']
    }
    version_b = {
        'term': 'Contract',
        'definitie': 'Een bindende overeenkomst',
        'voorbeelden': ['Voorbeeld 1', 'Voorbeeld 2']
    }
    result = service.compare_definitions(version_a, version_b)
    assert result['metrics']['total_changes'] &gt; 0</code></pre>

<h3>Integration Tests</h3>

<ul>
<li>Test UI rendering with real data</li>
<li>Test performance with large diffs</li>
<li>Test export functionality</li>
<li>Test diff caching</li>
<li>Test concurrent comparisons</li>
</ul>

<h2>Definition of Done</h2>

<ul>
<li>[ ] Diff service implemented</li>
<li>[ ] UI components created</li>
<li>[ ] All view modes functional</li>
<li>[ ] Export functionality working</li>
<li>[ ] Performance optimized</li>
<li>[ ] Unit tests passing (>90% coverage)</li>
<li>[ ] Integration tests passing</li>
<li>[ ] Documentation complete</li>
<li>[ ] Code review completed</li>
</ul>

<h2>Dependencies</h2>

<ul>
<li>Version Control Service (US-400)</li>
<li>Diff library (difflib or alternative)</li>
<li>PDF generation library</li>
<li>HTML template engine</li>
</ul>

<h2>Risks</h2>

<p>| Risk | Impact | Mitigation |</p>
<p>|------|--------|------------|</p>
<p>| Large diff performance | HIGH | Implement pagination, lazy loading |</p>
<p>| Complex merge scenarios | MEDIUM | Limit to 2-way comparison initially |</p>
<p>| UI complexity | MEDIUM | Start with simple view, iterate |</p>

<h2>Notes</h2>

<ul>
<li>Consider implementing 3-way merge view for future</li>
<li>Evaluate specialized diff libraries for better performance</li>
<li>Plan for syntax highlighting in code definitions</li>
<li>Consider implementing blame view showing who changed what</li>
</ul>
  </div>
</body>
</html>