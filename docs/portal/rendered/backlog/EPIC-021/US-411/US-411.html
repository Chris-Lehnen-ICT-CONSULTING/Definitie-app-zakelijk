<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>US-411: - **Performance First**: Lazy loading, virtual scrolling</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">‚Üê Terug naar Portal</a>
    <p>---</p>
<p>id: US-411</p>
<p>epic: EPIC-021</p>
<p>titel: "US-411: - <strong>Performance First</strong>: Lazy loading, virtual scrolling"</p>
<p>type: user-story</p>
<p>status: open</p>
<p>prioriteit: MEDIUM</p>
<p>story_points: 13</p>
<p>aangemaakt: 2025-09-29</p>
<p>bijgewerkt: 2025-09-29</p>
<p>owner: product-owner</p>
<p>applies_to: definitie-app@current</p>
<p>canonical: false</p>
<p>last_verified: 2025-10-02</p>
<p>stakeholders:</p>
<ul>
<li> - juridisch-professional</li>
<li> - compliance-officer</li>
<li> - ux-designer</li>
<li> - development-team</li>
<p>tags:</p>
<li> - history</li>
<li> - ui-modernization</li>
<li> - user-experience</li>
<li> - audit-trail</li>
<li> - timeline</li>
<p>business_value: HIGH</p>
<p>acceptance_criteria:</p>
<li> - Inline history visible in context</li>
<li> - Diff visualization for changes</li>
<li> - Timeline navigation</li>
<li> - Performance < 200ms render time</li>
<li> - Mobile responsive design</li>
<p>dependencies:</p>
<li> - US-412 (removal of old history tab)</li>
<li> - EPIC-004 (UI component system)</li>
<p>successors: []</p>
<p>---</p>
</ul>

<h1>US-411: Modern Inline History Implementation</h1>

<h2>User Story</h2>

<p><strong>As a</strong> Juridisch Professional</p>
<p><strong>I want to</strong> see definition history inline within the editing context</p>
<p><strong>So that</strong> I can understand changes without switching contexts and make informed decisions</p>

<h2>Vision & Rationale</h2>

<h3>Modern UX Approach</h3>

<p>Traditional history tabs require context switching, breaking the user's flow. Modern applications (GitHub, Google Docs, Notion) show history inline where it's most relevant. This approach provides:</p>

<ol>
<li>**Contextual Relevance**: History appears where you need it</li>
<li>**Reduced Cognitive Load**: No need to remember context when switching tabs</li>
<li>**Faster Workflows**: Quick access to history without navigation</li>
<li>**Better Decision Making**: See changes while editing</li>
</ol>

<h3>Design Principles</h3>

<ul>
<li>**Progressive Disclosure**: Show summary, expand for details</li>
<li>**Performance First**: Lazy loading, virtual scrolling</li>
<li>**Mobile Friendly**: Responsive design for all devices</li>
<li>**Accessibility**: WCAG 2.1 AA compliant</li>
</ul>

<h2>Functional Requirements</h2>

<h3>1. Inline History Components</h3>

<h4>1.1 History Timeline Widget</h4>

<pre><code>interface TimelineEntry {
  id: string;
  timestamp: Date;
  author: string;
  action: 'created' | 'updated' | 'validated' | 'approved';
  summary: string;
  changes?: FieldChange[];
}

interface FieldChange {
  field: string;
  oldValue: string;
  newValue: string;
  changeType: 'added' | 'removed' | 'modified';
}</code></pre>

<p><strong>Features:</strong></p>
<ul>
<li>Collapsible timeline in right sidebar</li>
<li>Color-coded by action type</li>
<li>Relative timestamps ("2 hours ago")</li>
<li>Avatar/initials for authors</li>
<li>Quick preview on hover</li>
<li>Click to expand full diff</li>
</ul>

<h4>1.2 Inline Diff Viewer</h4>

<p><strong>Features:</strong></p>
<ul>
<li>Side-by-side or unified diff view</li>
<li>Syntax highlighting for changes</li>
<li>Word-level diff for text changes</li>
<li>Collapse unchanged sections</li>
<li>Navigation between changes</li>
<li>Copy previous version</li>
</ul>

<h4>1.3 Version Comparison Tool</h4>

<p><strong>Features:</strong></p>
<ul>
<li>Select any two versions to compare</li>
<li>Visual diff with highlights</li>
<li>Export comparison as PDF</li>
<li>Share comparison link</li>
<li>Annotate differences</li>
</ul>

<h3>2. Integration Points</h3>

<h4>2.1 Edit Tab Integration</h4>

<pre><code># Sidebar with history
with st.sidebar:
    if st.button("Show History"):
        render_inline_history(definitie_id)

# Or inline expansion
with st.expander("Version History"):
    show_timeline(definitie_id)</code></pre>

<h4>2.2 Review Tab Integration</h4>

<pre><code># Show changes since last approval
if has_pending_changes(definitie_id):
    st.info("Changes since last approval:")
    show_diff(last_approved_version, current_version)</code></pre>

<h4>2.3 Generate Tab Context</h4>

<pre><code># Show history of similar definitions
similar_history = get_similar_definition_history(term)
if similar_history:
    with st.expander(f"History of similar terms ({len(similar_history)})"):
        render_history_insights(similar_history)</code></pre>

<h2>Technical Architecture</h2>

<h3>Service Layer Design</h3>

<pre><code>class GitHistoryService:
    """Modern history service inspired by Git"""

    def __init__(self, repository: DefinitionRepository):
        self.repo = repository
        self.cache = HistoryCache()

    def get_history(
        self,
        definitie_id: int,
        limit: int = 50,
        include_diffs: bool = False
    ) -&gt; List[HistoryEntry]:
        """Get paginated history with optional diffs"""
        pass

    def get_diff(
        self,
        from_version: int,
        to_version: int,
        format: Literal['unified', 'side_by_side', 'word']
    ) -&gt; DiffResult:
        """Generate diff between versions"""
        pass

    def get_blame(
        self,
        definitie_id: int,
        field: str
    ) -&gt; List[BlameEntry]:
        """Get line-by-line attribution"""
        pass

    def get_timeline(
        self,
        definitie_id: int,
        start_date: datetime,
        end_date: datetime
    ) -&gt; Timeline:
        """Get activity timeline"""
        pass</code></pre>

<h3>Component Architecture</h3>

<pre><code>// React/TypeScript components for Streamlit
interface HistoryComponents {
  Timeline: React.FC&lt;TimelineProps&gt;;
  DiffViewer: React.FC&lt;DiffProps&gt;;
  VersionSelector: React.FC&lt;VersionSelectorProps&gt;;
  HistoryPanel: React.FC&lt;HistoryPanelProps&gt;;
}

// Streamlit component wrapper
def inline_history_component(
    definitie_id: int,
    view_mode: str = 'timeline',
    height: int = 400
) -&gt; Any:
    return st.components.v1.declare_component(
        "inline_history",
        path="frontend/build"
    )(
        definitieId=definitie_id,
        viewMode=view_mode,
        height=height
    )</code></pre>

<h3>Performance Optimization</h3>

<pre><code>class HistoryCache:
    """LRU cache for history data"""

    def __init__(self, max_size: int = 100):
        self.cache = LRUCache(max_size)
        self.prefetch_queue = asyncio.Queue()

    async def get_or_fetch(
        self,
        key: str,
        fetcher: Callable
    ) -&gt; Any:
        """Get from cache or fetch with prefetching"""
        if key in self.cache:
            return self.cache[key]

        # Fetch and cache
        result = await fetcher()
        self.cache[key] = result

        # Prefetch related
        await self.prefetch_related(key)

        return result</code></pre>

<h3>Database Schema Extensions</h3>

<pre><code>-- Optimized history queries
CREATE INDEX idx_history_definitie_timestamp
ON definitie_geschiedenis(definitie_id, created_at DESC);

-- Materialized view for performance
CREATE MATERIALIZED VIEW history_summary AS
SELECT
    definitie_id,
    DATE(created_at) as date,
    COUNT(*) as changes_count,
    array_agg(DISTINCT changed_by) as contributors
FROM definitie_geschiedenis
GROUP BY definitie_id, DATE(created_at);

-- Full-text search on history
CREATE INDEX idx_history_fulltext
ON definitie_geschiedenis
USING gin(to_tsvector('dutch', old_value || ' ' || new_value));</code></pre>

<h2>UI/UX Design Specifications</h2>

<h3>Visual Design</h3>

<pre><code>/* Timeline styles */
.history-timeline {
  --timeline-line-color: #e1e4e8;
  --timeline-dot-size: 12px;
  --timeline-spacing: 24px;
}

.timeline-entry {
  position: relative;
  padding-left: var(--timeline-spacing);
  margin-bottom: 16px;
}

.timeline-entry::before {
  /* Vertical line */
  content: '';
  position: absolute;
  left: 6px;
  top: 0;
  bottom: -16px;
  width: 2px;
  background: var(--timeline-line-color);
}

.timeline-dot {
  position: absolute;
  left: 0;
  width: var(--timeline-dot-size);
  height: var(--timeline-dot-size);
  border-radius: 50%;
  background: white;
  border: 2px solid var(--color-primary);
}

/* Diff styles */
.diff-added {
  background-color: #d4f4dd;
  color: #22863a;
}

.diff-removed {
  background-color: #ffeef0;
  color: #d73a49;
}

.diff-modified {
  background-color: #fff5b1;
  color: #735c0f;
}</code></pre>

<h3>Interaction Patterns</h3>

<ol>
<li>**Hover States**: Preview on hover, full view on click</li>
<li>**Keyboard Navigation**: Arrow keys to navigate timeline</li>
<li>**Swipe Gestures**: Mobile swipe between versions</li>
<li>**Smooth Scrolling**: Animated transitions between versions</li>
<li>**Loading States**: Skeleton screens while fetching</li>
</ol>

<h2>Migration Strategy</h2>

<h3>Phase 1: Foundation (Week 1-2)</h3>
<ol>
<li>Implement GitHistoryService</li>
<li>Create basic Timeline component</li>
<li>Add to Edit tab as experiment</li>
</ol>

<h3>Phase 2: Enhancement (Week 3-4)</h3>
<ol>
<li>Add DiffViewer component</li>
<li>Implement caching layer</li>
<li>Add to Review tab</li>
</ol>

<h3>Phase 3: Polish (Week 5-6)</h3>
<ol>
<li>Performance optimization</li>
<li>Mobile responsiveness</li>
<li>Accessibility improvements</li>
</ol>

<h3>Phase 4: Launch (Week 7)</h3>
<ol>
<li>User testing</li>
<li>Documentation</li>
<li>Training materials</li>
</ol>

<h2>Performance Requirements</h2>

<h3>Metrics</h3>

<p>| Metric | Target | Critical |</p>
<p>|--------|--------|----------|</p>
<p>| Initial render | < 200ms | < 500ms |</p>
<p>| Timeline fetch | < 300ms | < 1s |</p>
<p>| Diff generation | < 500ms | < 2s |</p>
<p>| Memory usage | < 50MB | < 100MB |</p>
<p>| Cache hit rate | > 80% | > 60% |</p>

<h3>Optimization Strategies</h3>

<ol>
<li>**Virtual Scrolling**: Only render visible timeline entries</li>
<li>**Lazy Loading**: Load history on demand</li>
<li>**Prefetching**: Anticipate user actions</li>
<li>**Compression**: Compress large diffs</li>
<li>**CDN**: Static assets on CDN</li>
</ol>

<h2>Testing Strategy</h2>

<h3>Unit Tests</h3>

<pre><code>def test_history_service():
    """Test GitHistoryService"""
    service = GitHistoryService(mock_repo)

    # Test history retrieval
    history = service.get_history(1, limit=10)
    assert len(history) &lt;= 10

    # Test diff generation
    diff = service.get_diff(1, 2)
    assert diff.has_changes()

    # Test caching
    cached = service.get_history(1, limit=10)
    assert cached is history  # Same object</code></pre>

<h3>Integration Tests</h3>

<pre><code>def test_inline_history_component():
    """Test Streamlit component integration"""
    with mock_streamlit():
        component = inline_history_component(
            definitie_id=1,
            view_mode='timeline'
        )
        assert component.render()</code></pre>

<h3>E2E Tests</h3>

<pre><code>describe('History Timeline', () =&gt; {
  it('should show history entries', () =&gt; {
    cy.visit('/edit?id=1');
    cy.get('[data-testid="history-button"]').click();
    cy.get('.timeline-entry').should('have.length.greaterThan', 0);
  });

  it('should show diff on click', () =&gt; {
    cy.get('.timeline-entry').first().click();
    cy.get('.diff-viewer').should('be.visible');
  });
});</code></pre>

<h2>Acceptance Criteria</h2>

<ul>
<li>[ ] Timeline component renders in < 200ms</li>
<li>[ ] Diff viewer shows accurate changes</li>
<li>[ ] Mobile responsive design works on all devices</li>
<li>[ ] Keyboard navigation fully functional</li>
<li>[ ] Screen reader compatible</li>
<li>[ ] History loads without blocking UI</li>
<li>[ ] Cache reduces API calls by > 80%</li>
<li>[ ] Users can compare any two versions</li>
<li>[ ] Export functionality works</li>
<li>[ ] No performance regression in main app</li>
</ul>

<h2>Documentation Requirements</h2>

<h3>User Documentation</h3>

<ol>
<li>**User Guide**: How to use inline history</li>
<li>**Video Tutorial**: 3-minute overview</li>
<li>**FAQ**: Common questions</li>
<li>**Shortcuts Guide**: Keyboard shortcuts</li>
</ol>

<h3>Developer Documentation</h3>

<ol>
<li>**API Reference**: GitHistoryService methods</li>
<li>**Component Docs**: React component props</li>
<li>**Integration Guide**: How to add to new views</li>
<li>**Performance Guide**: Optimization tips</li>
</ol>

<h2>Risk Mitigation</h2>

<p>| Risk | Mitigation |</p>
<p>|------|------------|</p>
<p>| Performance impact | Implement aggressive caching, lazy loading |</p>
<p>| Complex UI | User testing, iterative design |</p>
<p>| Data volume | Pagination, archiving old history |</p>
<p>| Browser compatibility | Progressive enhancement |</p>
<p>| Mobile performance | Reduced feature set on mobile |</p>

<h2>Success Metrics</h2>

<ul>
<li>**User Engagement**: 80% of users use history feature</li>
<li>**Performance**: P95 latency < 500ms</li>
<li>**Satisfaction**: > 4.5/5 user rating</li>
<li>**Error Rate**: < 0.1% error rate</li>
<li>**Adoption**: 100% prefer over tab-based history</li>
</ul>

<h2>Future Enhancements</h2>

<ol>
<li>**AI-Powered Insights**: "This definition changed significantly"</li>
<li>**Collaborative Annotations**: Comments on changes</li>
<li>**Change Predictions**: ML-based change predictions</li>
<li>**Integration**: Connect with external version control</li>
<li>**Advanced Search**: Full-text search in history</li>
</ol>

<h2>Definition of Done</h2>

<ul>
<li>[ ] All components implemented and tested</li>
<li>[ ] Performance targets met</li>
<li>[ ] Accessibility audit passed</li>
<li>[ ] Mobile testing completed</li>
<li>[ ] Documentation complete</li>
<li>[ ] User training conducted</li>
<li>[ ] Feature flag enabled in production</li>
<li>[ ] Monitoring dashboards configured</li>
<li>[ ] Rollback plan tested</li>
</ul>

<h2>Notes</h2>

<ul>
<li>This represents a modern approach to history UX</li>
<li>Inspired by GitHub, Google Docs, and Notion</li>
<li>Requires frontend build pipeline for React components</li>
<li>Consider using Streamlit Components v2 when available</li>
<li>Evaluate performance impact continuously</li>
</ul>
  </div>
</body>
</html>