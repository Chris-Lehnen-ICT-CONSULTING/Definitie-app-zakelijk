<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>US-192 — V2 Validator: JSON‑regel Evaluatie + ESS‑02 + DB‑check CON‑01</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">← Terug naar Portal</a>
    <p>---</p>
<p>id: US-192</p>
<p>status: IN_PROGRESS</p>
<p>prioriteit: HOOG</p>
<p>owner: validation</p>
<p>canonical: true</p>
<p>sprint: next</p>
<p>story_points: 8</p>
<p>last_verified: 2025-09-18</p>
<p>epic: EPIC-002</p>
<p>---</p>

<h1>US-192 — V2 Validator: JSON‑regel Evaluatie + ESS‑02 + DB‑check CON‑01</h1>

<p>Context</p>
<p>De V2‑validator (ModularValidationService) gebruikt nu interne rules (VAL‑<em>, STR‑</em>, CON‑CIRC‑*) en evalueert de JSON‑toetsregels nog niet. Ook ontbreekt ESS‑02 in V2, en CON‑01 vraagt een DB‑kruischeck voor duplicate contextcombinaties.</p>

<p>Doel</p>
<p>Implementeer JSON‑toetsregel evaluatie in ModularValidationService, inclusief:</p>
<ul>
<li>ESS‑02 eenduidigheidslogica (marker‑override, 1‑hit/ambigu/no‑hit)</li>
<li>Additional patterns uit legacy interpreter (CON‑01, ESS‑01, INT‑01/03, STR‑01/02)</li>
<li>DB‑kruischeck voor CON‑01 (duplicate contextcombinatie → waarschuwing met bestaande definitie‑ID)</li>
<li>Severity/gewicht mapping conform JSON; deterministische violations</li>
</ul>

<p>Scope</p>
<ul>
<li>Modules: `src/services/validation/modular_validation_service.py`</li>
<li>Loader/manager: (her)gebruik `src/toetsregels/loader.py` en `src/toetsregels/manager.py`</li>
<li>Geen UI‑wijzigingen; validator levert metadata zodat UI bestaande definitie kan tonen bij duplicates.</li>
</ul>

<p>Niet in scope</p>
<ul>
<li>Prompt metadata propagatie (valt onder EPIC‑010/US‑179)</li>
<li>Regelherstructurering (valt onder US‑180)</li>
</ul>

<p>Implementatiestappen</p>
<p>1) Rules‑load & compile</p>
<ul>
<li>  - Laad alle JSON‑regels via ToetsregelManager en compileer regex per regel.</li>
<li>  - Map `prioriteit/aanbeveling` → weight/severity.</li>
<p>2) Evaluatie per regel</p>
<li>  - FORBIDDEN_PATTERN: match → violation</li>
<li>  - Required element/structure: roep helperchecks aan (zoals in legacy) → violation bij ontbreken</li>
<li>  - ESS‑02: implementeer marker‑override, 1‑hit/ambigu/none‑hit gedrag (zie migratieplan)</li>
<p>3) CON‑01 DB‑kruischeck</p>
<li>  - Normaliseer contextlijsten (casefold/trim/unique), serialize naar JSON</li>
<li>  - Query op (begrip, org_ctx, jur_ctx, optioneel categorie, status != archived)</li>
<li>  - Bij hit: voeg WARNING (code CON‑01‑DUP) met metadata {existing_definition_id, status}</li>
<p>4) Aggregatie & determinisme</p>
<li>  - Violations sorteren op code; consistent score‑aggregation</li>
<p>5) Tests</p>
<li>  - Unit: per kernregel (CON‑01, ESS‑01/02, INT‑01/03, STR‑01/02, VER‑01)</li>
<li>  - Integratie: orchestrator V2 validate_text/validate_definition; schema‑conform resultaat</li>
</ul>

<p>Acceptatiecriteria</p>
<ul>
<li>[ ] JSON‑regels worden geëvalueerd in V2 (zonder legacy validator aanroep)</li>
<li>[ ] ESS‑02: marker‑override en categorie‑eenduidigheid werken conform plan</li>
<li>[ ] CON‑01: faalt bij geen context; waarschuwt bij duplicate met bestaande definitie‑ID in metadata</li>
<li>[ ] Additional patterns (CON‑01, ESS‑01, INT‑01/03, STR‑01/02) toegepast</li>
<li>[ ] Violations deterministisch gesorteerd; severity/weight volgen JSON</li>
<li>[ ] Unit en integratietests groen</li>
</ul>

<h2>Voortgang</h2>
<ul>
<li>Gereed:</li>
<li> - JSON‑regel evaluatie actief in V2 voor meerdere regels (CON‑01/02, ESS‑01/02/03/04/05, INT‑01/03, STR‑01/02, VER‑01) met deterministische sortering.</li>
<li> - Positieve‑patroon interpretatie toegevoegd voor ESS‑03/04/05 (hits zijn bewijs van aanwezigheid; violation alleen bij ontbreken).</li>
<li> - CON‑01: duplicate‑context waarschuwing via repository‑check met `existing_definition_id` in metadata.</li>
<li> - Initiële golden tests groen: INT‑01, CON‑01; aanvullende goldens voor STR/INT/VER/ESS toegevoegd en groen.</li>
<li>Nog te doen:</li>
<li> - Uitbreiden goldens naar volledige dekking van ARAI/STR/SAM/VER clusters en randgevallen.</li>
<li> - Fine‑tunen severity/gewichten conform JSON (waar nodig) en documenteren.</li>
</ul>

<p>Constraints</p>
<ul>
<li>Respecteer CLAUDE.md (geen Streamlit/asyncio.run in services; geen backwards‑compat)</li>
<li>README gates (EPIC‑010) blijven groen</li>
<li>Canonical locaties voor docs; V2‑contract (TypedDict) blijft leidend</li>
</ul>

<p>Risico’s & mitigaties</p>
<ul>
<li>Regex vals‑positief: golden tests per regel; compile cache; limiet op matches</li>
<li>DB‑kruischeck performance: parametrized query + indexgebruik; alleen bij CON‑01 uitvoeren</li>
<li>Gedragsverandering: documenteer in CHANGELOG; dekken met tests</li>
</ul>

  </div>
</body>
</html>