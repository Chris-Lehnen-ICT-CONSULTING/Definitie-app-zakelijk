<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>US-214 — Implementeer Type Hints voor ValidationDetailsDict en gerelateerde types</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">← Terug naar Portal</a>
    <p>---</p>
<p>id: US-214</p>
<p>epic: EPIC-002</p>
<p>status: open</p>
<p>prioriteit: MEDIUM</p>
<p>story_points: 5</p>
<p>sprint: next</p>
<p>owner: backend</p>
<p>applies_to: definitie-app@current</p>
<p>canonical: false</p>
<p>last_verified: 2025-10-02</p>
<p>created_at: 2025-09-19</p>
<p>dependencies: [US-193]</p>
<p>---</p>

<h1>US-214 — Implementeer Type Hints voor ValidationDetailsDict en gerelateerde types</h1>

<h2>Doel</h2>
<p>Versterk type safety in de validation layer door complete type annotations toe te voegen, wat leidt tot minder runtime errors, betere IDE ondersteuning en duidelijkere code documentatie.</p>

<h2>Context</h2>
<p>Uit de US-193 multi-agent review (P3-12) blijkt dat validation data structures geen type hints hebben, wat leidt tot onvoorspelbaar gedrag en moeilijk te debuggen code. ValidationDetailsDict is de centrale datastructuur maar mist type definities.</p>

<h2>Scope</h2>

<h3>In scope</h3>
<ul>
<li>Creëer TypedDict definities voor alle validation structures</li>
<li>Implementeer type hints op alle validation service methods</li>
<li>Voeg runtime type validation helpers toe</li>
<li>Update alle validation consumers met typed interfaces</li>
<li>Configureer mypy voor stricte type checking</li>
</ul>

<h3>Niet in scope</h3>
<ul>
<li>Pydantic models (aparte US indien gewenst)</li>
<li>UI type definitions (frontend verantwoordelijkheid)</li>
<li>Legacy V1 validation code</li>
</ul>

<h2>Acceptance Criteria</h2>

<h3>Functioneel</h3>
<ul>
<li>[ ] TypedDict voor ValidationDetailsDict compleet gedefinieerd</li>
<li>[ ] Alle validation methods hebben return type annotations</li>
<li>[ ] IDE autocomplete werkt voor validation objects</li>
<li>[ ] Type errors worden compile-time gedetecteerd</li>
<li>[ ] Documentatie gegenereerd uit type hints</li>
</ul>

<h3>Technisch</h3>
<ul>
<li>[ ] `src/services/validation/types.py` bevat alle type definitions</li>
<li>[ ] Mypy draait zonder errors op validation modules</li>
<li>[ ] 100% van public methods heeft type hints</li>
<li>[ ] Runtime type guards voor externe data</li>
<li>[ ] Generic types voor flexibele responses</li>
</ul>

<h2>Implementatie</h2>

<h3>1. Core Type Definitions</h3>
<pre><code># src/services/validation/types.py
from typing import TypedDict, List, Dict, Optional, Literal, Any, Union
from typing_extensions import NotRequired, Required

class ViolationDict(TypedDict):
    """Represents a validation rule violation."""
    rule_id: Required[str]
    severity: Required[Literal["high", "medium", "low"]]
    description: Required[str]
    suggestion: NotRequired[str]
    metadata: NotRequired[Dict[str, Any]]
    line_number: NotRequired[int]
    category: NotRequired[str]

class ValidationDetailsDict(TypedDict):
    """Complete validation result structure."""
    overall_score: Required[float]  # 0.0 - 1.0
    is_acceptable: Required[bool]
    violations: Required[List[ViolationDict]]
    passed_rules: Required[List[str]]
    metadata: NotRequired[Dict[str, Any]]
    processing_time: NotRequired[float]
    correlation_id: NotRequired[str]
    rule_timings: NotRequired[Dict[str, float]]

class ValidationContext(TypedDict):
    """Context for validation operations."""
    begrip: Required[str]
    organisatorische_context: NotRequired[List[str]]
    juridische_context: NotRequired[List[str]]
    wettelijke_basis: NotRequired[List[str]]
    ontologische_categorie: NotRequired[str]
    correlation_id: NotRequired[str]</code></pre>

<h3>2. Service Method Signatures</h3>
<pre><code># src/services/validation/modular_validation_service.py
from typing import Protocol

class ValidationServiceProtocol(Protocol):
    """Protocol defining validation service interface."""

    async def validate_definition(
        self,
        begrip: str,
        text: str,
        context: ValidationContext | None = None,
        **kwargs: Any
    ) -&gt; ValidationDetailsDict:
        """Validate a definition with full type safety."""
        ...

    def get_rule_weights(self) -&gt; Dict[str, float]:
        """Get current rule weight configuration."""
        ...</code></pre>

<h3>3. Type Guards</h3>
<pre><code># src/services/validation/type_guards.py
from typing import TypeGuard

def is_validation_details(obj: Any) -&gt; TypeGuard[ValidationDetailsDict]:
    """Runtime check if object matches ValidationDetailsDict."""
    return (
        isinstance(obj, dict) and
        "overall_score" in obj and
        isinstance(obj["overall_score"], (int, float)) and
        "is_acceptable" in obj and
        isinstance(obj["is_acceptable"], bool) and
        "violations" in obj and
        isinstance(obj["violations"], list) and
        "passed_rules" in obj and
        isinstance(obj["passed_rules"], list)
    )

def ensure_validation_details(obj: Any) -&gt; ValidationDetailsDict:
    """Ensure object is valid ValidationDetailsDict or raise."""
    if not is_validation_details(obj):
        raise TypeError(f"Invalid validation details: {obj}")
    return obj</code></pre>

<h2>Migration Path</h2>

<h3>Phase 1: Type Definitions (Day 1-2)</h3>
<ul>
<li>Create all TypedDict definitions</li>
<li>Add to existing modules without breaking changes</li>
</ul>

<h3>Phase 2: Service Layer (Day 3-4)</h3>
<ul>
<li>Add type hints to all service methods</li>
<li>Update internal helper functions</li>
</ul>

<h3>Phase 3: Integration Points (Day 5)</h3>
<ul>
<li>Update orchestrator interfaces</li>
<li>Type service factory methods</li>
<li>Add guards at API boundaries</li>
</ul>

<h2>Test Strategie</h2>

<h3>Type Testing</h3>
<pre><code># tests/unit/test_validation_types.py
def test_validation_details_typing():
    """Test type definitions are correct."""
    details: ValidationDetailsDict = {
        "overall_score": 0.85,
        "is_acceptable": True,
        "violations": [],
        "passed_rules": ["RULE1", "RULE2"]
    }
    # This should type-check correctly
    assert details["overall_score"] &lt;= 1.0

def test_type_guard():
    """Test runtime type validation."""
    invalid = {"score": 0.5}  # Wrong structure
    assert not is_validation_details(invalid)

    valid = {
        "overall_score": 0.5,
        "is_acceptable": False,
        "violations": [],
        "passed_rules": []
    }
    assert is_validation_details(valid)</code></pre>

<h3>Mypy Configuration</h3>
<pre><code># pyproject.toml
[tool.mypy]
python_version = "3.11"
strict = true
warn_return_any = true
warn_unused_configs = true
disallow_untyped_defs = true
disallow_any_generics = true
check_untyped_defs = true
no_implicit_optional = true
warn_redundant_casts = true
warn_unused_ignores = true
warn_no_return = true</code></pre>

<h2>Impact Analysis</h2>

<h3>Positieve Impact</h3>
<ul>
<li>**Developer Experience**: Auto-complete en inline docs</li>
<li>**Bug Prevention**: Compile-time type checking</li>
<li>**Refactoring Safety**: Type-safe changes</li>
<li>**Documentation**: Self-documenting code</li>
<li>**Testing**: Clearer test interfaces</li>
</ul>

<h3>Risico's</h3>
<ul>
<li>Initial development overhead</li>
<li>Potential test updates needed</li>
<li>Learning curve voor team</li>
<li>Stricter coding requirements</li>
</ul>

<h2>Metrics</h2>

<h3>Success Metrics</h3>
<ul>
<li>Mypy coverage: 100% validation modules</li>
<li>Type errors detected pre-production: > 10</li>
<li>IDE satisfaction survey: > 80% positive</li>
<li>Bug reduction: -30% type-related bugs</li>
</ul>

<h2>Dependencies</h2>
<ul>
<li>Python 3.11+ voor moderne typing features</li>
<li>typing-extensions==4.8+</li>
<li>mypy==1.5+</li>
</ul>

<h2>Notities</h2>
<ul>
<li>Prioriteit P3 uit US-193 review</li>
<li>Coordinate met UI team voor consistente types</li>
<li>Consider gradual typing adoption</li>
<li>Document type conventions in CLAUDE.md</li>
</ul>

<h2>Links</h2>
<ul>
<li>[Python Typing Documentation](https://docs.python.org/3/library/typing.html)</li>
<li>[TypedDict PEP 589](https://www.python.org/dev/peps/pep-0589/)</li>
<li>[Mypy Documentation](http://mypy-lang.org/)</li>
<li>Parent: US-193</li>
</ul>
  </div>
</body>
</html>