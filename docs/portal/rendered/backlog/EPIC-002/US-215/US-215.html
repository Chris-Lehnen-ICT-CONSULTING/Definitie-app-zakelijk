<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>US-215 — Herstel Debug Informatie Verlies in Refactored Code</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">← Terug naar Portal</a>
    <p>---</p>
<p>id: US-215</p>
<p>status: TODO</p>
<p>prioriteit: MEDIUM</p>
<p>owner: backend</p>
<p>canonical: true</p>
<p>sprint: next</p>
<p>story_points: 3</p>
<p>created_at: 2025-09-19</p>
<p>dependencies: [US-193, US-213]</p>
<p>epic: EPIC-002</p>
<p>---</p>

<h1>US-215 — Herstel Debug Informatie Verlies in Refactored Code</h1>

<h2>Doel</h2>
<p>Herstel verloren gegane debug informatie en logging na refactoring, zodat ontwikkelaars effectief kunnen troubleshooten en de applicatie monitoren in productie.</p>

<h2>Context</h2>
<p>Uit de US-193 multi-agent review (P3-14) blijkt dat tijdens refactoring belangrijke debug informatie is verwijderd of verminderd. Dit maakt troubleshooting moeilijk en vermindert observability.</p>

<h2>Scope</h2>

<h3>In scope</h3>
<ul>
<li>Herstel alle verwijderde debug logging statements</li>
<li>Implementeer structured logging met context</li>
<li>Voeg correlation IDs toe voor request tracing</li>
<li>Creëer debug mode flags voor verbose output</li>
<li>Implementeer performance timing logs</li>
</ul>

<h3>Niet in scope</h3>
<ul>
<li>APM tooling integratie (aparte US)</li>
<li>Log aggregatie infrastructuur</li>
<li>Alerting en monitoring dashboards</li>
</ul>

<h2>Acceptance Criteria</h2>

<h3>Functioneel</h3>
<ul>
<li>[ ] Debug logs beschikbaar op alle kritieke punten</li>
<li>[ ] Correlation ID tracking door hele request flow</li>
<li>[ ] Performance metrics gelogd voor slow operations</li>
<li>[ ] Debug mode toggle via environment variable</li>
<li>[ ] Structured JSON logging voor machine parsing</li>
</ul>

<h3>Technisch</h3>
<ul>
<li>[ ] Logger configuratie in `src/utils/logging_config.py`</li>
<li>[ ] Debug decorators voor method tracing</li>
<li>[ ] Context managers voor operation timing</li>
<li>[ ] Log levels correct gebruikt (DEBUG/INFO/WARNING/ERROR)</li>
<li>[ ] Sensitive data gemaskeerd in logs</li>
</ul>

<h2>Implementatie</h2>

<h3>1. Enhanced Logging Configuration</h3>
<pre><code># src/utils/logging_config.py
import logging
import json
from typing import Any, Dict
from contextvars import ContextVar

correlation_id: ContextVar[str] = ContextVar('correlation_id', default='')

class StructuredFormatter(logging.Formatter):
    """JSON structured logging formatter."""

    def format(self, record: logging.LogRecord) -&gt; str:
        log_obj = {
            'timestamp': self.formatTime(record),
            'level': record.levelname,
            'logger': record.name,
            'message': record.getMessage(),
            'correlation_id': correlation_id.get(),
            'module': record.module,
            'function': record.funcName,
            'line': record.lineno,
        }

        # Add extra fields
        for key, value in record.__dict__.items():
            if key not in ['name', 'msg', 'args', 'created', 'filename',
                          'funcName', 'levelname', 'levelno', 'lineno',
                          'module', 'msecs', 'message', 'pathname', 'process',
                          'processName', 'relativeCreated', 'thread', 'threadName']:
                log_obj[key] = value

        return json.dumps(log_obj)

def setup_logging(debug: bool = False) -&gt; None:
    """Configure application-wide logging."""
    level = logging.DEBUG if debug else logging.INFO
    handler = logging.StreamHandler()
    handler.setFormatter(StructuredFormatter())

    logging.basicConfig(
        level=level,
        handlers=[handler]
    )</code></pre>

<h3>2. Debug Decorators</h3>
<pre><code># src/utils/debug_helpers.py
import functools
import logging
import time
from typing import Callable, Any

def debug_trace(logger: logging.Logger) -&gt; Callable:
    """Decorator to trace method execution."""
    def decorator(func: Callable) -&gt; Callable:
        @functools.wraps(func)
        def wrapper(*args, **kwargs) -&gt; Any:
            logger.debug(
                f"Entering {func.__name__}",
                extra={
                    'args': str(args)[:200],  # Truncate long args
                    'kwargs': str(kwargs)[:200]
                }
            )

            start = time.perf_counter()
            try:
                result = func(*args, **kwargs)
                elapsed = time.perf_counter() - start

                logger.debug(
                    f"Exiting {func.__name__}",
                    extra={
                        'elapsed_ms': elapsed * 1000,
                        'result_type': type(result).__name__
                    }
                )
                return result

            except Exception as e:
                elapsed = time.perf_counter() - start
                logger.error(
                    f"Error in {func.__name__}",
                    extra={
                        'elapsed_ms': elapsed * 1000,
                        'error': str(e),
                        'error_type': type(e).__name__
                    },
                    exc_info=True
                )
                raise

        return wrapper
    return decorator

class TimingContext:
    """Context manager for timing operations."""

    def __init__(self, operation: str, logger: logging.Logger):
        self.operation = operation
        self.logger = logger
        self.start = None

    def __enter__(self):
        self.start = time.perf_counter()
        self.logger.debug(f"Starting {self.operation}")
        return self

    def __exit__(self, exc_type, exc_val, exc_tb):
        elapsed = time.perf_counter() - self.start
        if exc_type:
            self.logger.error(
                f"Failed {self.operation}",
                extra={'elapsed_ms': elapsed * 1000, 'error': str(exc_val)}
            )
        else:
            self.logger.debug(
                f"Completed {self.operation}",
                extra={'elapsed_ms': elapsed * 1000}
            )</code></pre>

<h3>3. Enhanced Service Logging</h3>
<pre><code># Example: src/services/service_factory.py additions
logger = get_logger(__name__)

@debug_trace(logger)
def normalize_validation(self, result: Any) -&gt; dict:
    """Normalize validation with enhanced debugging."""
    with TimingContext("validation_normalization", logger):
        # Log input state
        logger.debug(
            "Normalizing validation result",
            extra={
                'input_type': type(result).__name__,
                'has_score': hasattr(result, 'score') if result else False,
                'correlation_id': correlation_id.get()
            }
        )

        # ... existing normalization logic ...

        # Log output state
        logger.debug(
            "Validation normalized",
            extra={
                'output_score': output.get('overall_score'),
                'violations_count': len(output.get('violations', [])),
                'passed_rules_count': len(output.get('passed_rules', []))
            }
        )

        return output</code></pre>

<h3>4. Debug Mode Configuration</h3>
<pre><code># src/config/debug_config.py
import os
from dataclasses import dataclass

@dataclass
class DebugConfig:
    """Debug configuration settings."""
    enabled: bool = os.getenv('DEBUG_MODE', '').lower() == 'true'
    log_level: str = os.getenv('LOG_LEVEL', 'INFO')
    trace_methods: bool = os.getenv('TRACE_METHODS', '').lower() == 'true'
    log_sql: bool = os.getenv('LOG_SQL', '').lower() == 'true'
    profile_performance: bool = os.getenv('PROFILE_PERF', '').lower() == 'true'
    mask_sensitive_data: bool = os.getenv('MASK_SENSITIVE', 'true').lower() == 'true'

    # Specific debug flags
    debug_validation: bool = os.getenv('DEBUG_VALIDATION', '').lower() == 'true'
    debug_generation: bool = os.getenv('DEBUG_GENERATION', '').lower() == 'true'
    debug_web_lookup: bool = os.getenv('DEBUG_WEB_LOOKUP', '').lower() == 'true'

debug_config = DebugConfig()</code></pre>

<h2>Recovery Points</h2>

<h3>Identificeer Verloren Debug Info</h3>
<ol>
<li>Git diff tussen pre/post refactoring commits</li>
<li>Zoek verwijderde logger.debug() statements</li>
<li>Identificeer verwijderde print() statements</li>
<li>Check voor verloren exception details</li>
</ol>

<h3>Herstel Prioriteit</h3>
<ol>
<li>**Critical**: Error handling en exception logging</li>
<li>**High**: Business logic decision points</li>
<li>**Medium**: Performance metrics en timings</li>
<li>**Low**: Verbose data structure logging</li>
</ol>

<h2>Test Plan</h2>

<h3>Debug Output Verification</h3>
<pre><code># tests/unit/test_debug_logging.py
def test_debug_logging_enabled():
    """Test debug logs are produced when enabled."""
    with override_env('DEBUG_MODE', 'true'):
        # ... perform operation ...
        # Assert debug logs contain expected information

def test_correlation_id_propagation():
    """Test correlation ID flows through system."""
    # Set correlation ID
    # Make requests
    # Verify all logs contain same correlation ID</code></pre>

<h2>Rollout Strategy</h2>

<ol>
<li>**Phase 1**: Add debug configuration (no behavior change)</li>
<li>**Phase 2**: Restore critical debug logs</li>
<li>**Phase 3**: Add new structured logging</li>
<li>**Phase 4**: Implement tracing decorators</li>
<li>**Phase 5**: Performance profiling additions</li>
</ol>

<h2>Metrics</h2>

<h3>Before</h3>
<ul>
<li>Debug log statements: ~50 (mostly removed)</li>
<li>Troubleshooting time: 2-4 hours average</li>
<li>Correlation tracking: None</li>
<li>Performance visibility: Limited</li>
</ul>

<h3>After</h3>
<ul>
<li>Debug log statements: 200+</li>
<li>Troubleshooting time: 30-60 minutes</li>
<li>Correlation tracking: 100% coverage</li>
<li>Performance visibility: All operations > 100ms</li>
</ul>

<h2>Dependencies</h2>
<ul>
<li>Python logging module</li>
<li>contextvars for correlation</li>
<li>Optional: structlog for enhanced structured logging</li>
</ul>

<h2>Notities</h2>
<ul>
<li>P3-14 uit US-193 multi-agent review</li>
<li>Coordinate met ops team voor log format</li>
<li>Consider ELK stack integration later</li>
<li>Update CLAUDE.md met debug conventions</li>
</ul>

<h2>Links</h2>
<ul>
<li>[Python Logging Best Practices](https://docs.python.org/3/howto/logging.html)</li>
<li>[Structured Logging](https://www.structlog.org/)</li>
<li>[OpenTelemetry Python](https://opentelemetry.io/docs/instrumentation/python/)</li>
<li>Parent: US-193</li>
</ul>
  </div>
</body>
</html>