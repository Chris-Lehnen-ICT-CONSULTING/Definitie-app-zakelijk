<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>US-219: titel: Duplicate‑check uitbreiden met synoniemen (context‑aware)</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">← Terug naar Portal</a>
    <p>---</p>
<p>id: US-219</p>
<p>epic: EPIC-002</p>
<p>titel: "US-219: titel: Duplicate‑check uitbreiden met synoniemen (context‑aware)"</p>
<p>status: proposed</p>
<p>prioriteit: HOOG</p>
<p>story_points: 5</p>
<p>sprint: backlog</p>
<p>aangemaakt: 2025-09-26</p>
<p>bijgewerkt: 2025-09-26</p>
<p>owner: development-team</p>
<p>applies_to: definitie-app@current</p>
<p>canonical: false</p>
<p>last_verified: 2025-10-02</p>
<p>vereisten:</p>
<ul>
<li> - REQ-040</li>
<li> - REQ-049</li>
<li> - REQ-052</li>
<p>---</p>
</ul>

<h1>US-219 — Duplicate‑check uitbreiden met synoniemen (context‑aware)</h1>

<p><strong>Als</strong> definitie‑auteur</p>
<p><strong>wil ik</strong> dat de duplicate‑check vóór definitie‑generatie óók synoniemen van het begrip herkent</p>
<p><strong>zodat</strong> invoer via een synoniem dezelfde harde duplicate‑gate triggert wanneer de context gelijk is.</p>

<h2>Context & Rationale</h2>
<ul>
<li>Huidige duplicate‑check (DB‑laag + DUP‑01 regel) matcht primair op `definities.begrip` in combinatie met context (organisatorisch, juridisch, wettelijk). Synoniemen in `definitie_voorbeelden` tellen niet mee, waardoor een invoer via een synoniem niet als duplicaat wordt gezien.</li>
<li>De UI (Generator/Bewerk/Expert Review) hergebruikt één pad voor duplicate‑check; uitbreiding op DB‑/service‑laag dekt alle tabs.</li>
<li>Voorkeursterm‑keuze (begrip of synoniem) mag geen invloed hebben op het kunnen herkennen van duplicaten: alle actieve synoniemen moeten meetellen.</li>
</ul>

<h2>Scope</h2>
<ul>
<li>Alleen Definitie Generatie flow (pre‑check). Bewerk en Expert Review blijven zonder duplicate‑gate.</li>
<li>Uitbreiden duplicate‑detectie in repository met exacte synoniem‑matches (case‑insensitive).</li>
<li>Optionele index voor performante case‑insensitive synoniem‑lookups.</li>
<li>DUP‑01 aanpassing van reason‑labels optioneel (follow‑up).</li>
</ul>

<h2>Acceptatiecriteria</h2>
<ul>
<li>AC1: Exact begrip + context (org, jur, wet) geeft harde duplicate‑gate (USE_EXISTING/UPDATE_EXISTING) — ongewijzigd.</li>
<li>AC2: Exact synoniem + context (case‑insensitive; actief synoniem) geeft dezelfde harde duplicate‑gate als AC1.</li>
<li>AC3: Orde‑onafhankelijkheid op wettelijke_basis blijft gelden in beide paden.</li>
<li>AC4: Voorkeursterm‑keuze (begrip of synoniem) heeft geen invloed op de gate; alle actieve synoniemen tellen mee.</li>
<li>AC5: Performance < 100 ms bij ~10k records (CI‑index op synoniemtekst aanwezig).</li>
</ul>

<h2>Implementatie (korte samenvatting)</h2>
<ul>
<li>Repository: `src/database/definitie_repository.py`</li>
<li> - `find_definitie(...)` uitgebreid met exact synoniem + context pad (JOIN op `definitie_voorbeelden`).</li>
<li> - `find_duplicates(...)` uitgebreid met exact synoniem + context pad, met reden "Exact match: synoniem + context".</li>
<li>Migratie/Index (SQLite): `src/database/schema.sql` en `src/database/migrate_database.py`</li>
<li> - Index: `idx_synonyms_text_ci` voor case‑insensitive synoniem‑lookups.</li>
<li> - Idempotent aangemaakt in migrator.</li>
<li>Niet in scope: fuzzy synoniem‑match en DUP‑01 reason‑labels (follow‑up mogelijk).</li>
</ul>

<h2>Testplan</h2>
<ul>
<li>Unit/integration tests:</li>
<li> - `tests/integration/test_duplicate_check_synonyms.py::test_exact_synonym_match_counts_as_duplicate`</li>
<li> - `tests/integration/test_duplicate_check_synonyms.py::test_synonym_match_with_different_context_is_not_duplicate`</li>
<li>Handmatig (UI):</li>
<p>  1) Maak definitie A: begrip=“Identiteitsmiddel”, synoniemen=[“Identiteitsbewijs”, “ID‑kaart”], org=OM, jur=Strafrecht, wet=[Art. 27 Sv].</p>
<p>  2) Start generator met begrip=“ID‑kaart” en identieke context → duplicate‑UI (Exact synoniem + context).</p>
<p>  3) Varieer context (bv. wet=[Art. 67 Sv]) → geen duplicate‑UI.</p>
<p>  4) (optioneel) Fuzzy via synoniem — niet in scope.</p>
</ul>

<h2>Niet‑functioneel</h2>
<ul>
<li>Idempotente migraties; geen dataverlies.</li>
<li>Case‑insensitive matching voor synoniemen (SQLite `COLLATE NOCASE`).</li>
<li>Geen netwerkafhankelijkheden.</li>
</ul>

<h2>Risico's en mitigatie</h2>
<ul>
<li>Extra index vergroot DB‑bestand — Alleen aanmaken als niet bestaat; evalueren bij >10k records.</li>
<li>False positives via fuzzy — Drempel 0.85 en redenrapportage zodat gebruiker kan beoordelen.</li>
</ul>

<h2>Traceability</h2>
<ul>
<li>Koppelt aan REQ‑040 (duplicate flow), REQ‑049 (UI beslispunten), REQ‑052 (database integriteit): zie Portal.</li>
</ul>

<h2>Open Besluiten</h2>
<ul>
<li>Fuzzy drempel eventueel configureerbaar maken via settings.</li>
</ul>

  </div>
</body>
</html>