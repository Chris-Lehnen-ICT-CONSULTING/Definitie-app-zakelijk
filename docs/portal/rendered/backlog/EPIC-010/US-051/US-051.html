<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fix CFR-BUG-014 Synoniemen/Antoniemen Generatie</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">← Terug naar Portal</a>
    <p>---</p>
<p>id: US-051</p>
<p>epic: EPIC-010</p>
<p>titel: Fix CFR-BUG-014 Synoniemen/Antoniemen Generatie</p>
<p>type: bug-fix</p>
<p>status: proposed</p>
<p>prioriteit: KRITIEK</p>
<p>story_points: 5</p>
<p>sprint: sprint-37</p>
<p>aangemaakt: 2025-09-10</p>
<p>bijgewerkt: 2025-09-10</p>
<p>owner: developer-implementer</p>
<p>applies_to: definitie-app@current</p>
<p>canonical: false</p>
<p>last_verified: 2025-09-10</p>
<p>vereisten:</p>
<ul>
<li> - REQ-020</li>
<li> - REQ-033</li>
<p>toegewezen_aan: development-team</p>
<p>Afhankelijkheden:</p>
<li> - US-041</li>
<li> - US-043</li>
<p>---</p>
</ul>

<h1>US-051: Fix CFR-BUG-014 Synoniemen/Antoniemen Generatie</h1>

<p><strong>Epic:</strong> EPIC-010 - Context Flow Refactoring</p>
<p><strong>Bug Report:</strong> CFR-BUG-014</p>

<h2>Gebruikersverhaal</h2>

<p><strong>Als een</strong> juridisch professional in de Nederlandse justitieketen</p>
<p><strong>wil ik</strong> dat synoniemen en antoniemen consistent het juiste aantal items genereren</p>
<p><strong>zodat</strong> ik betrouwbare en complete juridische definities kan maken met alle gerelateerde termen</p>

<h2>Probleembeschrijving</h2>

<p>Het systeem genereert inconsistent 2-3 synoniemen/antoniemen terwijl er 5 gevraagd worden. Daarnaast worden items met bullets ("• ") weergegeven wat niet consistent is met andere lijsten in de applicatie.</p>

<h3>Root Causes</h3>
<ol>
<li>**Prompts te simpel**: Geen definitie/context meegegeven aan AI</li>
<li>**Parser te rigid**: Verwacht alleen newline-separated, geen komma fallback</li>
<li>**Geen retry logic**: Bij te weinig items geen tweede poging</li>
<li>**UI inconsistentie**: Bullets voor synoniemen/antoniemen</li>
</ol>

<h2>Acceptatiecriteria</h2>

<h3>Functionele Criteria</h3>
<ul>
<li>[ ] Synoniemen prompts bevatten definitie + context</li>
<li>[ ] Antoniemen prompts bevatten definitie + context</li>
<li>[ ] Parser ondersteunt zowel newline als komma-gescheiden items</li>
<li>[ ] Retry logic: max 1 retry bij te weinig items</li>
<li>[ ] Op laatste poging: accepteer wat er is (voorkom infinite loops)</li>
<li>[ ] UI toont synoniemen/antoniemen ZONDER bullets</li>
<li>[ ] Andere voorbeeldtypes behouden bullets</li>
</ul>

<h3>Technische Criteria</h3>
<ul>
<li>[ ] `unified_voorbeelden.py` aangepast met verbeterde prompts</li>
<li>[ ] `_parse_response()` methode met komma-fallback</li>
<li>[ ] `_generate_with_retry()` methode met max 1 retry</li>
<li>[ ] UI rendering logic aangepast voor type-specifieke formatting</li>
<li>[ ] max_tokens consistent (2000) voor sync en async</li>
</ul>

<h3>Performance Criteria</h3>
<ul>
<li>[ ] Generatie tijd < 5 seconden per type</li>
<li>[ ] Retry voegt max 3 seconden toe</li>
<li>[ ] Minimaal 3 items gegenereerd (acceptabel minimum)</li>
<li>[ ] Ideaal 5 items gegenereerd (target)</li>
</ul>

<h2>Implementatie Details</h2>

<h3>1. Prompt Verbetering</h3>
<pre><code># In unified_voorbeelden.py
if request.example_type == ExampleType.SYNONIEMEN:
    return f"""Voor het begrip '{begrip}' met de volgende definitie:
{definitie}

Context: {context_text if context_text else 'Algemeen juridisch'}

Geef EXACT {request.max_examples} synoniemen of verwante termen.
BELANGRIJK:
- PRECIES {request.max_examples} items, niet meer en niet minder
- Één synoniem per regel
- GEEN nummering, bullets, streepjes of andere formatting
- Als er geen {request.max_examples} perfecte synoniemen zijn, gebruik verwante termen"""</code></pre>

<h3>2. Parser met Fallback</h3>
<pre><code>def _parse_response(self, text: str, example_type: ExampleType) -&gt; list[str]:
    """Enhanced parser met fallback voor verschillende formaten."""
    text = text.strip()

    # Primary: nieuwe regels
    lines = [line.strip() for line in text.split('\n') if line.strip()]

    # Clean prefixes
    cleaned = []
    for line in lines:
        line = re.sub(r'^\d+[\.\)]\s*', '', line)  # Remove numbers
        line = re.sub(r'^[-•*]\s*', '', line)      # Remove bullets
        if line:
            cleaned.append(line)

    # Fallback: komma-gescheiden
    if len(cleaned) &lt; 3 and ',' in text:
        items = [item.strip() for item in text.split(',')]
        if len(items) &gt; len(cleaned):
            cleaned = items

    return cleaned</code></pre>

<h3>3. Retry Logic</h3>
<pre><code>async def _generate_with_retry(self, request: ExampleRequest, max_retries: int = 1):
    """Generate met 1 retry bij incorrect aantal."""
    for attempt in range(max_retries + 1):
        result = await self._generate_async(request)

        if request.example_type in [ExampleType.SYNONIEMEN, ExampleType.ANTONIEMEN]:
            expected = request.max_examples

            if len(result) &gt; expected:
                return result[:expected]  # Trim excess

            if len(result) &gt;= expected or attempt == max_retries:
                if len(result) &lt; expected:
                    logger.warning(f"Accepting {len(result)}/{expected} items after {attempt+1} attempts")
                return result

            # Enhance prompt voor retry
            request.extra_instruction = f"Je gaf {len(result)} items, maar er zijn EXACT {expected} nodig."

    return result</code></pre>

<h3>4. UI Display Fix</h3>
<pre><code># In UI rendering
if example_type in ["synoniemen", "antoniemen"]:
    for item in examples:
        st.write(item)  # Zonder bullet
else:
    for item in examples:
        st.write(f"• {item}")  # Met bullet</code></pre>

<h2>Test Scenarios</h2>

<h3>Unit Tests</h3>
<ol>
<li>Test prompt generatie met definitie/context</li>
<li>Test parser met newline-separated input</li>
<li>Test parser met comma-separated fallback</li>
<li>Test retry logic bij te weinig items</li>
<li>Test trim logic bij te veel items</li>
<li>Test UI rendering zonder bullets</li>
</ol>

<h3>Integration Tests</h3>
<ol>
<li>End-to-end synoniemen generatie</li>
<li>End-to-end antoniemen generatie</li>
<li>Performance test met retry</li>
<li>Edge case: zeldzame termen met <5 synoniemen</li>
</ol>

<h2>Verificatie</h2>

<pre><code># Test synoniemen/antoniemen generatie
python -c "
from src.voorbeelden.unified_voorbeelden import UnifiedVoorbeeldenService
from src.voorbeelden.interfaces import ExampleRequest, ExampleType

service = UnifiedVoorbeeldenService()
for etype in [ExampleType.SYNONIEMEN, ExampleType.ANTONIEMEN]:
    req = ExampleRequest(
        begrip='contract',
        definitie='Een juridische overeenkomst tussen partijen',
        context_dict={'organisatie': 'Rechtbank'},
        example_type=etype,
        max_examples=5
    )
    result = service.generate(req)
    print(f'{etype}: {len(result.examples)} items - {result.examples}')
    assert len(result.examples) &gt;= 3, f'Minimum 3 items vereist, kreeg {len(result.examples)}'
"</code></pre>

<h2>Definition of Done</h2>

<ul>
<li>[ ] Code complete met alle acceptatiecriteria</li>
<li>[ ] Unit tests geschreven en groen</li>
<li>[ ] Integration tests groen</li>
<li>[ ] Verificatie script succesvol</li>
<li>[ ] Code review completed</li>
<li>[ ] UI test: synoniemen/antoniemen zonder bullets</li>
<li>[ ] Performance binnen targets</li>
<li>[ ] Documentatie bijgewerkt</li>
</ul>

<h2>Risico's</h2>

<p>| Risico | Impact | Mitigatie |</p>
<p>|--------|--------|-----------|</p>
<p>| AI geeft consistent <5 items | Medium | Accepteer minimum 3, log warning |</p>
<p>| Retry vertraagt UX | Low | Max 1 retry, timeout 3s |</p>
<p>| Parser mist edge cases | Low | Uitgebreide unit tests |</p>

<h2>Notes</h2>

<ul>
<li>Deze fix is KRITIEK voor Sprint 37</li>
<li>Directe refactor aanpak: geen backwards compatibility nodig</li>
<li>Test vooral met zeldzame juridische termen</li>
</ul>

  </div>
</body>
</html>