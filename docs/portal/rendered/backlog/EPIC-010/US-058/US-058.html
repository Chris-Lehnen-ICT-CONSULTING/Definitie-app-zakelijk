<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>US-058: titel: Implement Comprehensive Audit Trail for Context Operations</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">← Terug naar Portal</a>
    <p>---</p>
<p>id: US-058</p>
<p>epic: EPIC-010</p>
<p>titel: "US-058: titel: Implement Comprehensive Audit Trail for Context Operations"</p>
<p>type: feature</p>
<p>status: open</p>
<p>priority: critical</p>
<p>story_points: 8</p>
<p>sprint: sprint-36</p>
<p>created: 2025-09-09</p>
<p>updated: 2025-09-09</p>
<p>owner: developer-implementer</p>
<p>applies_to: definitie-app@v1.1</p>
<p>canonical: false</p>
<p>last_verified: 2025-09-09</p>
<p>dependencies: [US-056]</p>
<p>assigned_to: security-team</p>
<p>---</p>

<h1>US-058: Implement Comprehensive Audit Trail for Context Operations</h1>

<h2>Gebruikersverhaal</h2>
<p><strong>Als een</strong> compliance officer</p>
<p><strong>wil ik</strong> een volledig audit trail voor alle context operaties</p>
<p><strong>zodat</strong> ik kan aantonen dat het systeem voldoet aan ASTRA/NORA/AVG vereisten en forensisch onderzoek mogelijk is</p>

<h2>Context</h2>
<p>Het huidige systeem heeft geen audit trail voor context operaties, wat een kritieke ASTRA/NORA compliance overtreding is. Voor justice sector systemen is volledige traceerbaarheid een wettelijke vereiste met 7 jaar bewaartermijn.</p>

<h2>Acceptatiecriteria</h2>

<h3>SMART Acceptatiecriteria</h3>

<ul>
<li>**Specifiek:** Elk context operatie wordt gelogd met volledige metadata</li>
<li>**Meetbaar:**</li>
<li> - 100% van context operaties geaudit</li>
<li> - 0 audit gaps in compliance rapport</li>
<li> - Query response < 500ms voor audit trails</li>
<li>**Acceptabel:** Voldoet aan justice sector audit requirements</li>
<li>**Relevant:** Elimineert €20M AVG compliance risico</li>
<li>**Tijdgebonden:** Implementatie binnen 3 dagen</li>
</ul>

<h3>Criterion 1: Audit Event Capture</h3>
<p><strong>Gegeven</strong> een gebruiker voert een context operatie uit</p>
<p><strong>Wanneer</strong> de operatie plaatsvindt</p>
<p><strong>Dan</strong> wordt een audit event gecreëerd met:</p>
<ul>
<li>Unique event ID (UUID)</li>
<li>Timestamp (ISO 8601 met timezone)</li>
<li>User identifier (gehashed voor privacy)</li>
<li>Organization identifier</li>
<li>Operation type (CREATE, UPDATE, DELETE, VIEW)</li>
<li>Previous value (volledig)</li>
<li>New value (volledig)</li>
<li>IP address (geanonimiseerd)</li>
<li>Session ID</li>
<li>Correlation ID (voor gekoppelde events)</li>
</ul>

<h3>Criterion 2: Immutable Storage</h3>
<p><strong>Gegeven</strong> een audit event is gecreëerd</p>
<p><strong>Wanneer</strong> het opgeslagen wordt</p>
<p><strong>Dan</strong> wordt het opgeslagen in een immutable audit log</p>
<p><strong>En</strong> kan het niet gewijzigd worden</p>
<p><strong>En</strong> kan het niet verwijderd worden (alleen via retention policy)</p>
<p><strong>En</strong> wordt een cryptografische hash gecreëerd voor integriteit</p>

<h3>Criterion 3: Query Capabilities</h3>
<p><strong>Gegeven</strong> een auditor wil audit trails onderzoeken</p>
<p><strong>Wanneer</strong> zij een query uitvoeren</p>
<p><strong>Dan</strong> kunnen ze zoeken op:</p>
<ul>
<li>Tijdsperiode</li>
<li>Gebruiker</li>
<li>Organisatie</li>
<li>Operation type</li>
<li>Context type</li>
<li>Correlation ID</li>
<p><strong>En</strong> krijgen ze resultaten binnen 500ms</p>
<p><strong>En</strong> kunnen ze exporteren naar CSV/JSON</p>
</ul>

<h3>Criterion 4: Compliance Reporting</h3>
<p><strong>Gegeven</strong> een compliance audit wordt uitgevoerd</p>
<p><strong>Wanneer</strong> rapporten gegenereerd worden</p>
<p><strong>Dan</strong> bevatten deze:</p>
<ul>
<li>Volledigheid metrics (coverage percentage)</li>
<li>Anomalie detectie (unusual patterns)</li>
<li>User activity summaries</li>
<li>Context usage statistics</li>
<li>Data lineage voor specifieke waarden</li>
<p><strong>En</strong> voldoen aan ASTRA/NORA/AVG format requirements</p>
</ul>

<h3>Criterion 5: Privacy Protection</h3>
<p><strong>Gegeven</strong> audit logs bevatten mogelijk gevoelige informatie</p>
<p><strong>Wanneer</strong> data opgeslagen wordt</p>
<p><strong>Dan</strong> wordt:</p>
<ul>
<li>PII data gehashed of gepseudonimiseerd</li>
<li>IP adressen geanonimiseerd (laatste octet)</li>
<li>Geen wachtwoorden of auth tokens gelogd</li>
<li>Encryption at rest toegepast</li>
<li>Access control geïmplementeerd</li>
</ul>

<h2>Technische Notities</h2>

<h3>Audit Service Implementation</h3>
<pre><code>from dataclasses import dataclass
from datetime import datetime
from typing import Optional, Dict, Any
import hashlib
import json

@dataclass
class AuditEvent:
    """Immutable audit event"""
    event_id: str
    timestamp: datetime
    user_id_hash: str
    organization: str
    operation: str
    entity_type: str
    entity_id: str
    previous_value: Optional[Dict[str, Any]]
    new_value: Optional[Dict[str, Any]]
    ip_address_anon: str
    session_id: str
    correlation_id: str
    metadata: Dict[str, Any]

    def calculate_hash(self) -&gt; str:
        """Calculate cryptographic hash for integrity"""
        content = json.dumps({
            'event_id': self.event_id,
            'timestamp': self.timestamp.isoformat(),
            'operation': self.operation,
            'previous': self.previous_value,
            'new': self.new_value
        }, sort_keys=True)
        return hashlib.sha256(content.encode()).hexdigest()

class AuditService:
    """Centralized audit service for ASTRA compliance"""

    def audit_context_operation(
        self,
        operation: str,
        context_type: str,
        previous_value: Optional[Any],
        new_value: Optional[Any],
        user: str,
        metadata: Dict[str, Any] = None
    ) -&gt; str:
        """Audit a context operation"""
        event = AuditEvent(
            event_id=str(uuid4()),
            timestamp=datetime.now(timezone.utc),
            user_id_hash=self._hash_user_id(user),
            organization=self._get_user_organization(user),
            operation=operation,
            entity_type=f"context.{context_type}",
            entity_id=context_type,
            previous_value=previous_value,
            new_value=new_value,
            ip_address_anon=self._anonymize_ip(request.remote_addr),
            session_id=self._get_session_id(),
            correlation_id=self._get_correlation_id(),
            metadata=metadata or {}
        )

        # Store immutably
        self._store_audit_event(event)

        # Real-time compliance check
        self._check_compliance_rules(event)

        return event.event_id</code></pre>

<h3>Database Schema</h3>
<pre><code>-- Immutable audit log table
CREATE TABLE audit_log (
    event_id UUID PRIMARY KEY,
    timestamp TIMESTAMPTZ NOT NULL,
    user_id_hash VARCHAR(64) NOT NULL,
    organization VARCHAR(100) NOT NULL,
    operation VARCHAR(20) NOT NULL,
    entity_type VARCHAR(100) NOT NULL,
    entity_id VARCHAR(200),
    previous_value JSONB,
    new_value JSONB,
    ip_address_anon VARCHAR(45),
    session_id VARCHAR(100),
    correlation_id UUID,
    metadata JSONB,
    integrity_hash VARCHAR(64) NOT NULL,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- Indexes for query performance
CREATE INDEX idx_audit_timestamp ON audit_log(timestamp DESC);
CREATE INDEX idx_audit_user ON audit_log(user_id_hash, timestamp DESC);
CREATE INDEX idx_audit_org ON audit_log(organization, timestamp DESC);
CREATE INDEX idx_audit_operation ON audit_log(operation, timestamp DESC);
CREATE INDEX idx_audit_correlation ON audit_log(correlation_id);

-- Prevent updates and deletes (immutability)
CREATE TRIGGER enforce_audit_immutability
BEFORE UPDATE OR DELETE ON audit_log
FOR EACH ROW EXECUTE FUNCTION raise_exception('Audit logs are immutable');

-- Partitioning for performance (monthly)
CREATE TABLE audit_log_2025_09 PARTITION OF audit_log
FOR VALUES FROM ('2025-09-01') TO ('2025-10-01');</code></pre>

<h3>Integration Points</h3>
<pre><code># In ContextManager
class ContextManager:
    def set_context(self, context_data, source, actor):
        previous = self.get_context()

        # Audit before change
        self.audit_service.audit_context_operation(
            operation="UPDATE",
            context_type="full_context",
            previous_value=previous.to_dict() if previous else None,
            new_value=context_data,
            user=actor,
            metadata={"source": source.value}
        )

        # Perform operation
        self._context = ContextData.from_dict(context_data)</code></pre>

<h2>Domain Requirements</h2>

<h3>ASTRA Requirements</h3>
<ul>
<li>**Traceability:** Complete audit trail van bron tot gebruik</li>
<li>**Non-repudiation:** Cryptografische integriteit waarborging</li>
<li>**Accountability:** Alle acties herleidbaar naar gebruiker</li>
<li>**Transparency:** Audit logs beschikbaar voor compliance</li>
</ul>

<h3>NORA Standards</h3>
<ul>
<li>**Logging standaard:** NEN-ISO/IEC 27002:2017</li>
<li>**Timestamp format:** ISO 8601 met timezone</li>
<li>**Retention:** Minimaal 7 jaar voor justice sector</li>
<li>**Export formats:** Open standaarden (CSV, JSON, XML)</li>
</ul>

<h3>Justice Sector Specifics</h3>
<ul>
<li>**Bewaartermijn:** 7 jaar voor strafrechtelijke context</li>
<li>**Integriteit:** Hashchain voor forensisch bewijs</li>
<li>**Toegang:** Role-based met 4-ogen principe voor gevoelige data</li>
<li>**Rapportage:** Maandelijkse compliance rapporten</li>
</ul>

<h2>Test Coverage Requirements</h2>

<h3>Unit Tests</h3>
<pre><code>def test_audit_event_creation():
    """Verify audit events contain all required fields"""

def test_immutability():
    """Verify audit logs cannot be modified"""

def test_hash_integrity():
    """Verify cryptographic hash calculation"""

def test_privacy_protection():
    """Verify PII is properly anonymized"""</code></pre>

<h3>Integration Tests</h3>
<pre><code>def test_context_operations_audited():
    """Verify all context operations create audit events"""

def test_audit_query_performance():
    """Verify query response times &lt; 500ms"""

def test_compliance_report_generation():
    """Verify reports meet compliance requirements"""</code></pre>

<h3>Compliance Tests</h3>
<pre><code>def test_astra_compliance():
    """Verify ASTRA traceability requirements"""

def test_nora_compliance():
    """Verify NORA logging standards"""

def test_avg_compliance():
    """Verify GDPR privacy requirements"""</code></pre>

<h2>Definition of Done</h2>

<ul>
<li>[ ] Audit service geïmplementeerd</li>
<li>[ ] Alle context operaties creëren audit events</li>
<li>[ ] Immutable storage geconfigureerd</li>
<li>[ ] Database schema en triggers geïmplementeerd</li>
<li>[ ] Query interface gebouwd</li>
<li>[ ] Compliance rapportage functionaliteit</li>
<li>[ ] Privacy bescherming geïmplementeerd</li>
<li>[ ] Integriteit hashing werkend</li>
<li>[ ] Unit tests >95% coverage</li>
<li>[ ] Integration tests passed</li>
<li>[ ] Performance benchmarks gehaald</li>
<li>[ ] Security review completed</li>
<li>[ ] Compliance review goedgekeurd</li>
<li>[ ] Documentatie compleet</li>
<li>[ ] Monitoring alerts configured</li>
</ul>

<h2>Afhankelijkheden</h2>
<ul>
<li>**US-056:** Unified state management moet geïmplementeerd zijn</li>
<li>Database moet audit log tables ondersteunen</li>
<li>Time synchronization (NTP) moet geconfigureerd zijn</li>
<li>Backup strategie voor 7 jaar retention</li>
</ul>

<h2>Risico's en Mitigaties</h2>

<p>| Risico | Kans | Impact | Mitigatie |</p>
<p>|--------|------|--------|-----------|</p>
<p>| Performance impact | Medium | Medium | Async logging + partitioning |</p>
<p>| Storage growth | Hoog | Medium | Partitioning + archival strategy |</p>
<p>| Privacy violations | Laag | Kritiek | Anonymization + encryption |</p>
<p>| Data loss | Laag | Kritiek | Replication + backup |</p>

<h2>Notities</h2>
<ul>
<li>Consider event streaming (Kafka) voor high-volume scenarios</li>
<li>Implement audit log analysis dashboard voor security team</li>
<li>Plan voor quarterly audit reviews</li>
<li>Coordinate met legal voor retention policy details</li>
</ul>

<p>---</p>

<p><strong>Story Status:</strong> Ready for Development</p>
<p><strong>Estimated Effort:</strong> 8 story points</p>
<p><strong>Business Value:</strong> Eliminates €20M compliance risk, enables forensic investigation</p>

  </div>
</body>
</html>