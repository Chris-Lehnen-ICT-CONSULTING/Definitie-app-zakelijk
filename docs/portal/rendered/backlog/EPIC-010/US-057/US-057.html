<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fix "Anders..." Custom Context Option Functionality</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">← Terug naar Portal</a>
    <p>---</p>
<p>id: US-057</p>
<p>epic: EPIC-010</p>
<p>titel: Fix "Anders..." Custom Context Option Functionality</p>
<p>type: bug</p>
<p>status: open</p>
<p>priority: critical</p>
<p>story_points: 8</p>
<p>sprint: sprint-36</p>
<p>created: 2025-09-09</p>
<p>updated: 2025-09-09</p>
<p>owner: developer-implementer</p>
<p>applies_to: definitie-app@v1.1</p>
<p>canonical: false</p>
<p>last_verified: 2025-09-09</p>
<p>dependencies: [US-056]</p>
<p>assigned_to: development-team</p>
<p>---</p>

<h1>US-057: Fix "Anders..." Custom Context Option Functionality</h1>

<h2>Gebruikersverhaal</h2>
<p><strong>Als een</strong> OM officier van justitie</p>
<p><strong>wil ik</strong> custom context waarden kunnen invoeren via de "Anders..." optie</p>
<p><strong>zodat</strong> ik domein-specifieke context kan toevoegen die niet in de voorgedefinieerde lijst staat</p>

<h2>Context</h2>
<p>De "Anders..." optie crasht momenteel met de foutmelding "The default value 'test' is not part of the options". Dit verhindert justice professionals om organisatie-specifieke context toe te voegen die essentieel is voor juridisch correcte definities.</p>

<h2>Acceptatiecriteria</h2>

<h3>SMART Acceptatiecriteria</h3>

<ul>
<li>**Specifiek:** "Anders..." optie werkt zonder crashes voor alle drie context velden</li>
<li>**Meetbaar:**</li>
<li> - 100% success rate voor custom input</li>
<li> - 0 crashes bij selecteren "Anders..."</li>
<li> - Response tijd < 200ms voor custom value toevoeging</li>
<li>**Acceptabel:** Intuïtieve UX voor justice professionals</li>
<li>**Relevant:** Kritiek voor domein-specifieke definities</li>
<li>**Tijdgebonden:** Opgelost binnen 3 dagen</li>
</ul>

<h3>Criterion 1: Custom Input Interface</h3>
<p><strong>Gegeven</strong> een gebruiker selecteert "Anders..." in een context veld</p>
<p><strong>Wanneer</strong> de selectie gemaakt is</p>
<p><strong>Dan</strong> verschijnt er een tekstveld voor custom input</p>
<p><strong>En</strong> het tekstveld accepteert maximaal 200 karakters</p>
<p><strong>En</strong> er is een duidelijke placeholder tekst</p>

<h3>Criterion 2: Value Validation & Sanitization</h3>
<p><strong>Gegeven</strong> een gebruiker voert custom tekst in</p>
<p><strong>Wanneer</strong> de gebruiker de waarde submit</p>
<p><strong>Dan</strong> wordt de input gevalideerd tegen:</p>
<ul>
<li>SQL injection patterns</li>
<li>XSS attack vectors</li>
<li>Minimum lengte (3 karakters)</li>
<li>Maximum lengte (200 karakters)</li>
<li>Verboden karakters</li>
<p><strong>En</strong> wordt de input gesanitized voordat opslag</p>
</ul>

<h3>Criterion 3: Integration with Context Selection</h3>
<p><strong>Gegeven</strong> een gebruiker heeft een custom waarde ingevoerd</p>
<p><strong>Wanneer</strong> de waarde gevalideerd is</p>
<p><strong>Dan</strong> wordt de waarde toegevoegd aan de geselecteerde context lijst</p>
<p><strong>En</strong> verschijnt de waarde in de multiselect widget</p>
<p><strong>En</strong> blijft de waarde behouden tijdens sessie</p>

<h3>Criterion 4: Persistence & Reusability</h3>
<p><strong>Gegeven</strong> een gebruiker heeft eerder custom waarden ingevoerd</p>
<p><strong>Wanneer</strong> de gebruiker later terugkeert</p>
<p><strong>Dan</strong> zijn de custom waarden beschikbaar voor hergebruik</p>
<p><strong>En</strong> worden ze aangeboden als suggesties</p>
<p><strong>En</strong> kunnen ze geselecteerd worden zonder opnieuw in te voeren</p>

<h3>Criterion 5: Error Handling</h3>
<p><strong>Gegeven</strong> er treedt een validatie fout op</p>
<p><strong>Wanneer</strong> de gebruiker ongeldige input probeert</p>
<p><strong>Dan</strong> wordt een duidelijke Nederlandse foutmelding getoond</p>
<p><strong>En</strong> blijft de applicatie stabiel</p>
<p><strong>En</strong> kan de gebruiker de input corrigeren</p>

<h2>Technische Notities</h2>

<h3>Implementation Approach</h3>
<pre><code>class CustomContextHandler:
    """Handles custom context input via Anders... option"""

    def render_custom_input(self, context_type: str) -&gt; Optional[str]:
        """Render custom input field when Anders... is selected"""
        if "Anders..." in st.session_state.get(f"{context_type}_selected", []):
            custom_value = st.text_input(
                f"Voer aangepaste {context_type} in:",
                max_chars=200,
                key=f"custom_{context_type}_input",
                placeholder="Bijv: 'FIOD - Witwassen' of 'Rechtbank Amsterdam - Strafkamer'"
            )

            if custom_value:
                validated = self.validate_and_sanitize(custom_value)
                if validated:
                    self.add_to_context(context_type, validated)
                    return validated
        return None

    def validate_and_sanitize(self, value: str) -&gt; Optional[str]:
        """Validate and sanitize custom input"""
        # Remove dangerous characters
        sanitized = self.sanitizer.sanitize(
            value,
            level=SanitizationLevel.STRICT
        )

        # Validate against rules
        if len(sanitized) &lt; 3:
            st.error("Waarde moet minimaal 3 karakters bevatten")
            return None

        # Check for injection patterns
        if self.detector.has_injection_risk(sanitized):
            st.error("Ongeldige karakters gedetecteerd")
            return None

        return sanitized</code></pre>

<h3>Widget State Management Fix</h3>
<pre><code>def fix_multiselect_state(options: List[str], defaults: List[str]) -&gt; List[str]:
    """Ensure defaults are subset of options to prevent crashes"""
    # Filter defaults to only include values that exist in options
    valid_defaults = [d for d in defaults if d in options]

    # Add custom values to options if they exist in defaults
    custom_values = [d for d in defaults if d not in options and d != "Anders..."]
    if custom_values:
        options = options[:-1] + custom_values + ["Anders..."]
        valid_defaults.extend(custom_values)

    return options, valid_defaults</code></pre>

<h3>Database Schema for Custom Values</h3>
<pre><code>CREATE TABLE custom_context_values (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    context_type VARCHAR(50) NOT NULL,
    value VARCHAR(200) NOT NULL,
    normalized_value VARCHAR(200) NOT NULL,
    created_by VARCHAR(100) NOT NULL,
    organization VARCHAR(100) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    usage_count INTEGER DEFAULT 0,
    last_used TIMESTAMP,
    status VARCHAR(20) DEFAULT 'active',
    CHECK (context_type IN ('organisatorisch', 'juridisch', 'wettelijk'))
);

CREATE INDEX idx_custom_context_org ON custom_context_values(organization, context_type);
CREATE INDEX idx_custom_context_usage ON custom_context_values(usage_count DESC);</code></pre>

<h2>Domain Requirements</h2>

<h3>Justice Domain Validation Rules</h3>
<ul>
<li>Custom organisatie namen moeten valide justice organisaties zijn of daaraan gerelateerd</li>
<li>Juridische context moet Nederlandse rechtsterminologie gebruiken</li>
<li>Wettelijke basis moet verwijzen naar bestaande of concept wetgeving</li>
<li>Geen persoonsnamen of BSN nummers in custom waarden</li>
</ul>

<h3>Compliance Requirements</h3>
<ul>
<li>**AVG/GDPR:** Geen PII in custom context waarden</li>
<li>**ASTRA:** Audit trail voor alle custom waarde creaties</li>
<li>**NORA:** Gebruik open standaarden voor data opslag</li>
<li>**BIR:** Input validatie volgens OWASP guidelines</li>
</ul>

<h2>Test Coverage Requirements</h2>

<h3>Unit Tests</h3>
<pre><code>def test_anders_option_renders_input_field():
    """Verify input field appears when Anders... selected"""

def test_custom_value_validation():
    """Test all validation rules"""

def test_sql_injection_prevention():
    """Verify SQL injection attempts are blocked"""

def test_xss_prevention():
    """Verify XSS attempts are sanitized"""

def test_custom_value_persistence():
    """Verify custom values are saved correctly"""</code></pre>

<h3>Integration Tests</h3>
<pre><code>def test_custom_context_in_generation():
    """Verify custom context reaches GPT-4 prompt"""

def test_custom_context_in_export():
    """Verify custom context appears in exports"""

def test_multiselect_with_custom_values():
    """Verify widget doesn't crash with custom values"""</code></pre>

<h3>User Acceptance Tests</h3>
<ol>
<li>OM gebruiker voegt "Landelijk Parket - Cybercrime" toe</li>
<li>DJI gebruiker voegt "PI Vught - TBS Kliniek" toe</li>
<li>Rechtbank gebruiker voegt "Rechtbank Noord-Holland - Familie" toe</li>
<li>Custom waarden verschijnen in gegenereerde definities</li>
<li>Custom waarden zijn herbruikbaar in volgende sessies</li>
</ol>

<h2>Definition of Done</h2>

<ul>
<li>[ ] "Anders..." optie werkt zonder crashes</li>
<li>[ ] Custom input field verschijnt correct</li>
<li>[ ] Validatie regels geïmplementeerd</li>
<li>[ ] Sanitization voorkomt security issues</li>
<li>[ ] Custom waarden worden opgeslagen in database</li>
<li>[ ] Custom waarden zijn herbruikbaar</li>
<li>[ ] Audit trail logs alle custom value creaties</li>
<li>[ ] Unit tests >95% coverage</li>
<li>[ ] Integration tests passed</li>
<li>[ ] Security review completed</li>
<li>[ ] UX review door gebruiker goedgekeurd</li>
<li>[ ] Performance benchmarks gehaald</li>
<li>[ ] Documentatie bijgewerkt</li>
<li>[ ] Rollback plan aanwezig</li>
</ul>

<h2>Afhankelijkheden</h2>
<ul>
<li>**US-056:** Legacy state management moet eerst verwijderd zijn</li>
<li>Database schema moet geüpdatet zijn</li>
<li>Sanitization service moet beschikbaar zijn</li>
<li>Audit service moet operationeel zijn</li>
</ul>

<h2>Risico's en Mitigaties</h2>

<p>| Risico | Kans | Impact | Mitigatie |</p>
<p>|--------|------|--------|-----------|</p>
<p>| Security vulnerabilities | Medium | Kritiek | OWASP validation + security review |</p>
<p>| Performance impact | Laag | Medium | Caching + optimization |</p>
<p>| UX verwarring | Medium | Medium | Clear instructions + tooltips |</p>
<p>| Data quality issues | Medium | Laag | Validation + review process |</p>

<h2>Notities</h2>
<ul>
<li>Focus op gebruiksvriendelijkheid voor justice professionals</li>
<li>Consider auto-complete/suggestions uit historical data</li>
<li>Mogelijk future enhancement: AI-suggested custom values</li>
<li>Coordinate met UX team voor optimale interface</li>
</ul>

<p>---</p>

<p><strong>Story Status:</strong> Ready for Development</p>
<p><strong>Estimated Effort:</strong> 8 story points</p>
<p><strong>Business Value:</strong> Enables domain-specific context critical for legal definitions</p>

  </div>
</body>
</html>