<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>US-175 — Ontologische categorie doorgeven aan promptmodules en categorie-specifieke instructies toepassen</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">← Terug naar Portal</a>
    <p>---</p>
<p>id: US-175</p>
<p>status: TE_DOEN</p>
<p>prioriteit: HOOG</p>
<p>owner: engineering</p>
<p>canonical: true</p>
<p>sprint: next</p>
<p>story_points: 5</p>
<p>last_verified: 16-09-2025</p>
<p>---</p>

<h1>US-175 — Ontologische categorie doorgeven aan promptmodules en categorie-specifieke instructies toepassen</h1>

<p>Doel: Wanneer een gebruiker een begrip + context invult, wordt eerst de ontologische categorie intern bepaald (zonder extra AI‑call), en die categorie wordt vervolgens expliciet gebruikt om de prompt richting het model categorie‑specifiek te maken.</p>

<p>Reikwijdte</p>
<ul>
<li>V2‑flow via `PromptServiceV2` + `HybridContextManager` + modulaire promptmodules.</li>
<li>Geen extra ChatGPT‑call voor categoriebepaling (blijft intern: OntologischeAnalyzer/regels).</li>
</ul>

<p>Probleem</p>
<ul>
<li>In de huidige V2‑flow komt `ontologische_categorie` niet (altijd) terecht in de module‑context; daardoor:</li>
<li> - `SemanticCategorisationModule` voegt geen categorie‑specifieke instructies toe (alleen generieke ESS‑02 tekst).</li>
<li> - `TemplateModule` valt uit met “Geen semantische categorie beschikbaar” (verwacht sleutel `semantic_category`).</li>
</ul>

<p>Oplossing (functioneel)</p>
<ul>
<li>Propagatie:</li>
<li> - Zet na `build_enriched_context(...)` in `PromptServiceV2` expliciet:</li>
<li>   - `enriched_context.metadata['ontologische_categorie'] = request.ontologische_categorie`</li>
<li>   - `enriched_context.metadata['semantic_category'] = <waarde>` (mapping als nodig, zie onder).</li>
<li>Module‑compat:</li>
<li> - `SemanticCategorisationModule` gebruikt `ontologische_categorie` (ESS: type/proces/resultaat/exemplaar) voor concrete instructies.</li>
<li> - `TemplateModule` verwacht `semantic_category` (domeincategorieën: Proces, Object, Actor, …). Opties:</li>
<p>    1) Mapping ESS → domeincategorie (bijv. proces→“Proces”, type→“Object”/“Informatie” afhankelijk van context, resultaat→“Maatregel”/“Toestand”, exemplaar→“Object”).</p>
<p>    2) Of TemplateModule tolerant maken: fallback op <code>ontologische_categorie</code> als <code>semantic_category</code> ontbreekt en minimale templates bieden per ESS.</p>
</ul>

<p>Acceptatiecriteria</p>
<ul>
<li>AC1: Bij een request met `ontologische_categorie=proces` bevat de gegenereerde prompt de PROCES‑specifieke instructies uit `SemanticCategorisationModule`.</li>
<li>AC2: De waarschuwing “Geen semantische categorie beschikbaar voor templates” komt niet meer voor in de logs bij requests mét categorie.</li>
<li>AC3: `TemplateModule` levert categorie‑afhankelijke templates wanneer een (afgeleide) `semantic_category` beschikbaar is.</li>
<li>AC4: Er wordt géén extra AI‑call gedaan voor categoriebepaling.</li>
<li>AC5: Bestaande integratietesten voor promptopbouw blijven groen; voeg een gerichte test toe die de aanwezigheid van categorie‑specifieke instructies controleert.</li>
</ul>

<p>Niet‑functioneel</p>
<ul>
<li>Geen merkbare performance‑regressie in promptopbouw (< 50ms extra in batch).</li>
<li>Logging blijft informatief, zonder ruisende warnings.</li>
</ul>

<p>Uitwerking (technisch – voorstel)</p>
<ol>
<li>`PromptServiceV2.build_generation_prompt`: na `enriched_context = await context_manager.build_enriched_context(request)`:</li>
</ol>
<ul>
<li>  - `enriched_context.metadata['ontologische_categorie'] = request.ontologische_categorie`</li>
<li>  - `enriched_context.metadata['semantic_category'] = mapping(request.ontologische_categorie)` (optioneel, zie 2).</li>
</ul>
<ol>
<li>Mapping (indien gekozen): definieer eenvoudige mapping ESS→domein (kan later verdiept worden):</li>
</ol>
<ul>
<li>  - proces → "Proces"</li>
<li>  - type → "Object" (of "Informatie" afhankelijk van context; begin met "Object")</li>
<li>  - resultaat → "Maatregel" of "Toestand" (kies één consistente startwaarde, bv. "Maatregel")</li>
<li>  - exemplaar → "Object"</li>
</ul>
<ol>
<li>(Alternatief) `TemplateModule.validate_input`: fallback op `ontologische_categorie` wanneer `semantic_category` ontbreekt, en minimale templates aanbieden per ESS.</li>
<li>Tests:</li>
</ol>
<ul>
<li>  - Nieuwe test die `PromptServiceV2` aanroept met `ontologische_categorie=proces` en controleert dat de prompt PROCES‑instructies bevat.</li>
<li>  - Test dat `TemplateModule` niet meer uitvalt en output levert zodra `semantic_category` aanwezig is.</li>
</ul>

<p>Risico’s & randgevallen</p>
<ul>
<li>Mapping ESS→domeincategorie is interpretatief; kan in latere stories verfijnd worden.</li>
<li>Backwards compat: bestaande code die `semantic_category` verwacht blijft werken.</li>
</ul>

<p>Definition of Done</p>
<ul>
<li>Code + tests gemerged.</li>
<li>Geen template‑categorie warnings meer in integratieruns.</li>
<li>Korte ontwikkelaarsnotitie in README/CHANGELOG over propagatie en (tijdelijke) mapping.</li>
</ul>


  </div>
</body>
</html>