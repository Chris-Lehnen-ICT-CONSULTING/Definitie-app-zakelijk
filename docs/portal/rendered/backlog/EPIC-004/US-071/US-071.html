<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Database schema aligneren met code en richtlijnen (reconciliatie)</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">← Terug naar Portal</a>
    <p>---</p>
<p>id: US-071</p>
<p>titel: Database schema aligneren met code en richtlijnen (reconciliatie)</p>
<p>epic: EPIC-004</p>
<p>status: Open</p>
<p>prioriteit: HIGH</p>
<p>story_points: 5</p>
<p>sprint: backlog</p>
<p>owner: architecture</p>
<p>applies_to: definitie-app@current</p>
<p>canonical: true</p>
<p>last_verified: 2025-09-12</p>
<p>---</p>

<h1>US-071: Database schema aligneren met code en richtlijnen (reconciliatie)</h1>

<h2>Gebruikersverhaal</h2>
<p>Als architect wil ik dat het databaseschema volledig in lijn is met het actuele gedrag van de applicatie en de projectrichtlijnen, zodat opslag, migraties en audittrail betrouwbaar zijn en toekomstige features (zoals de Edit Interface) geen schema-frictie veroorzaken.</p>

<h2>Context</h2>
<ul>
<li>In [US-153](../US-153/US-153.md) is de kolom `wettelijke_basis` toegevoegd aan `definities` en gemigreerd.</li>
<li>In [US-154](../US-154/US-154.md) is normalisatie naar een aparte tabel uitgewerkt (ontwerp) voor rijkere query’s.</li>
<li>In de huidige code zijn er verschillen tussen wat geüpdatet mag worden (whitelist) en wat het schema ondersteunt; ook is het fallback-schema (noodpad) minder compleet dan `schema.sql`.</li>
</ul>

<p>Document- en bronverwijzingen (controle):</p>
<ul>
<li>Schema: `src/database/schema.sql` (bestaat)</li>
<li>Migratie: `src/database/migrate_database.py` (bestaat)</li>
<li>DB-repository (CRUD/whitelist): `src/database/definitie_repository.py` (bestaat)</li>
<li>Services-repository mapping: `src/services/definition_repository.py` (bestaat)</li>
</ul>

<h2>Scope</h2>
<p>In scope</p>
<ul>
<li>Whitelist-consolidatie in DB-repository: enkel schema-kolommen toestaan en noodzakelijke velden toevoegen (o.a. context, validatie, approval, export tracking, wettelijke_basis).</li>
<li>Fallback-schema aligneren met `schema.sql` (zelfde kolommen incl. `previous_version_id`, `validation_date`, `validation_issues`, `source_reference`, `imported_from`, `updated_by`, `approved_*`, `export_*`, `wettelijke_basis`).</li>
<li>Workflow-traceability velden (optioneel) voorbereiden in schema-ontwerp: `archived_by`, `archived_at`, `archive_reason`, `restored_by`, `restored_at` — of als alternatief: expliciete keuze om dit alleen via history vast te leggen. Keuze vastleggen in deze US.</li>
<li>Triggers uitbreiden waar zinvol (context_snapshot bevat al status/context/wettelijke_basis; optie om `updated_by` mee te nemen).</li>
<li>Index-review (behouden/bijsturen) op status, categorie, context en (optioneel) approval/updated_at voor rapportages.</li>
</ul>

<p>Out of scope</p>
<ul>
<li>Implementatie van US-154 (aparte tabel) — apart opgenomen.</li>
<li>UI-wijzigingen (vallen onder [US-064](../US-064/US-064.md)).</li>
</ul>

<h2>Analyse (gap-overzicht)</h2>
<p>1) Whitelist in <code>update_definitie()</code> bevat verouderde/niet-bestaande velden en mist schema-kolommen.</p>
<p>2) Fallback CREATE TABLE (alleen gebruikt als <code>schema.sql</code> ontbreekt) is incompleet t.o.v. <code>schema.sql</code>.</p>
<p>3) Workflow traceability bij archiveren/restoren wordt nu alleen via <code>definitie_geschiedenis</code> gelogd; expliciet schema-ondersteuning ontbreekt (bewuste keuze nodig).</p>
<p>4) JSON-kolom <code>wettelijke_basis</code> bestaat (US-069); consistentie met toekomstige normalisatie (US-070) borgen (transitieplan).</p>

<h2>Ontwerpbeslissingen (definitief)</h2>
<ul>
<li>Whitelist: aligneren met schema; alleen bestaande kolommen toestaan. Toevoegen: `organisatorische_context`, `juridische_context`, `wettelijke_basis`, `validation_score`, `validation_date`, `validation_issues`, `approved_by`, `approved_at`, `approval_notes`, `last_exported_at`, `export_destinations`, `source_type`, `source_reference`, `imported_from`, `updated_by`.</li>
<li>Fallback-schema: volledig gelijk trekken met `schema.sql`, incl. `wettelijke_basis` en alle genoemde kolommen; voorkomt runtime-drift op nieuwe omgevingen.</li>
<li>Workflow-traceability: GEKOZEN OPTIE A — extra kolommen in `definities` toevoegen voor expliciete query’s:</li>
<li> - `archived_by VARCHAR(255)`, `archived_at TIMESTAMP`, `archive_reason TEXT`</li>
<li> - `restored_by VARCHAR(255)`, `restored_at TIMESTAMP`</li>
<li>Triggers: context_snapshot uitbreiden met `updated_by` (optioneel) voor betere audit.</li>
</ul>

<h2>Migraties (concept)</h2>
<p>1) Whitelist-consolidatie vergt geen DDL, maar codewijziging; wel testen.</p>
<p>2) Fallback-schema DDL aanpassen (geen impact op bestaande DB’s; alleen op fresh installs zonder <code>schema.sql</code>).</p>
<p>3) Workflow-traceability (gekozen optie A — exacte DDL):</p>
<ul>
<li>  - `ALTER TABLE definities ADD COLUMN archived_by VARCHAR(255);`</li>
<li>  - `ALTER TABLE definities ADD COLUMN archived_at TIMESTAMP;`</li>
<li>  - `ALTER TABLE definities ADD COLUMN archive_reason TEXT;`</li>
<li>  - `ALTER TABLE definities ADD COLUMN restored_by VARCHAR(255);`</li>
<li>  - `ALTER TABLE definities ADD COLUMN restored_at TIMESTAMP;`</li>
<li>  - (Optioneel) index op `archived_at`:</li>
<li>    - `CREATE INDEX IF NOT EXISTS idx_definities_archived_at ON definities(archived_at);`</li>
<p>4) Trigger-update (optioneel): <code>log_definitie_changes</code> → context_snapshot uitbreiden met <code>updated_by</code>.</p>
</ul>

<h2>Acceptatiecriteria</h2>
<ul>
<li>[ ] Whitelist in DB-repository bevat uitsluitend schema-kolommen en alle benodigde velden (zie ontwerpbeslissingen).</li>
<li>[ ] Fallback-schema is inhoudelijk gelijk aan `schema.sql` (inclusief `wettelijke_basis`).</li>
<li>[ ] Workflow-traceability: extra kolommen (`archived_*`, `restored_*`) bestaan en zijn opgenomen in fallback-schema.</li>
<li>[ ] Triggers vastgelegd en (indien gekozen) uitgebreid met `updated_by` in snapshot.</li>
<li>[ ] Documentatie gelinkt en klopt (schema, migratie, repository, services-repository).</li>
</ul>

<h2>Teststrategie (concept)</h2>
<ul>
<li>Eenheidstests: update-definitie met alle toegestane velden (geen silent drops), fout op niet-bestaande kolommen.</li>
<li>Integratie: fresh install met fallback-schema → CRUD/validatie werken; install met `schema.sql` idem.</li>
<li>Migratie (indien A): kolommen toegevoegd; schrijven/lezing van archief-/restore-informatie werkt en wordt gereflecteerd in history.</li>
</ul>

<h2>Referenties (gecontroleerd)</h2>
<ul>
<li>`src/database/schema.sql` — actueel</li>
<li>`src/database/migrate_database.py` — actueel</li>
<li>`src/database/definitie_repository.py` — actueel, bevat whitelist en CRUD</li>
<li>`src/services/definition_repository.py` — actueel, mapping metadata↔DB</li>
<li>Gerelateerd: [US‑064](../US-064/US-064.md), [US‑153](../US-153/US-153.md), [US‑154](../US-154/US-154.md), [EPIC‑004](../EPIC-004.md)</li>
</ul>

  </div>
</body>
</html>