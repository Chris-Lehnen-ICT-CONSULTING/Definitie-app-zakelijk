<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>US-064: Definition Edit Interface - Implementatieplan (Claude Versie)</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">‚Üê Terug naar Portal</a>
    <h1>US-064: Definition Edit Interface - Implementatieplan (Claude Versie)</h1>

<p><strong>Status:</strong> Ready for Implementation  </p>
<p><strong>Geschatte tijd:</strong> 4-6 uur (uitgebreid met stateless architectuur)  </p>
<p><strong>Epic:</strong> EPIC-004 - User Interface  </p>
<p><strong>Aangemaakt:</strong> 2025-09-12  </p>
<p><strong>Bijgewerkt:</strong> 2025-09-12 (verbeterd met Codex inzichten)  </p>

<h2>üìã Overzicht</h2>

<p>Stateless edit interface voor AI-gegenereerde definities met database-driven draft management, optimistic locking, kwaliteitspoorten en volledige audit trail.</p>

<h2>üèóÔ∏è Architectuur Principes</h2>

<h3>‚úÖ WEL Doen (Refactoring Richtlijnen)</h3>
<ul>
<li>**Stateless services** - Geen Streamlit dependencies in services/orchestrators</li>
<li>**Database als single source of truth** - Draft records in DB, niet in session state</li>
<li>**Optimistic locking** - Voorkom concurrent edit conflicten</li>
<li>**Explicit validation** - "Valideer" knop met cooldown (min. 2 seconden)</li>
<li>**Audit trail** - Alle wijzigingen via DB triggers gelogd</li>
<li>**Type hints** - Overal waar mogelijk</li>
<li>**Async interfaces** - Voor orchestrator methoden</li>
</ul>

<h3>‚ùå NIET Doen (Verboden Patronen)</h3>
<ul>
<li>Geen session state voor data opslag</li>
<li>Geen real-time validatie bij elke keystroke</li>
<li>Geen Streamlit imports in service layer</li>
<li>Geen backwards compatibility code</li>
<li>Geen "domein" veld (deprecated)</li>
<li>Geen bare except blocks</li>
<li>Geen asyncio.run in services</li>
</ul>

<h2>üìê Draft Invariant</h2>

<h3>Belangrijke Regel</h3>
<p><strong>E√©n actieve draft per combinatie (begrip + context + categorie + status)</strong></p>

<pre><code>-- Enforced via UNIQUE constraint
UNIQUE(begrip, organisatorische_context, juridische_context, categorie, status)</code></pre>

<h2>üîÑ Workflow met Kwaliteitspoorten</h2>

<pre><code>graph LR
    A[AI Genereert] --&gt; B[Toon Resultaat]
    B --&gt; C{Actie}
    C --&gt;|Bewerk| D[Get/Create Draft in DB]
    D --&gt; E[Edit Form]
    E --&gt; F[Valideer met Cooldown]
    F --&gt; G{Kwaliteitspoort}
    G --&gt;|Pass| H[Save Draft]
    G --&gt;|Fail| I[Toon Feedback]
    H --&gt; J[Publish naar Review]</code></pre>

<h2>üéØ Kwaliteitspoorten Specificatie</h2>

<h3>Score Mapping</h3>
<p>| Veld | Bron | Threshold | Gate Action |</p>
<p>|------|------|-----------|-------------|</p>
<p>| overall_score | <code>validation_result["overall_score"]</code> | ‚â• 0.80 | Block indien lager |</p>
<p>| juridisch_score | <code>validation_result["detailed_scores"].get("juridisch", 0)</code> | ‚â• 0.75 | Waarschuwing indien lager |</p>
<p>| structuur_score | <code>validation_result["detailed_scores"].get("structuur", 0)</code> | ‚â• 0.75 | Waarschuwing indien lager |</p>
<p>| error_violations | <code>len([i for i in validation_result["violations"] if i.get("severity") == "error"])</code> | = 0 | Block indien > 0 |</p>

<h3>Gate Reasons</h3>
<pre><code>gate_reasons = {
    "SCORE_TOO_LOW": "Overall score onder 80%",
    "ERRORS_PRESENT": "Validatie fouten (severity=error) aanwezig",
    "JURIDISCH_LOW": "Juridisch score onder 75%",
    "STRUCTUUR_LOW": "Structuur score onder 75%"
}</code></pre>

<h2>üìù Implementatie Details</h2>

<h3>Fase 1: Database Draft Management</h3>

<h4>1.1 Repository Uitbreidingen</h4>

<p><strong>Bestand:</strong> <code>src/services/definition_repository.py</code>  </p>
<p><strong>Nieuwe methoden:</strong></p>

<pre><code>def get_or_create_draft(self, begrip: str, context: dict) -&gt; int:
    """
    Haal bestaande draft op of maak nieuwe.
    Garandeert √©√©n draft per combinatie.
    """
    # Transactie voor atomaire get-or-create
    # Normaliseer lege juridische context naar ""
    jur_ctx = context.get("juridische_context") or ""
    
    with self._transaction() as conn:
        # Probeer INSERT, bij UNIQUE conflict -&gt; SELECT
        try:
            cursor = conn.execute(
                "INSERT INTO definities (begrip, organisatorische_context, "
                "juridische_context, categorie, status) VALUES (?, ?, ?, ?, ?)",
                (begrip, context.get("organisatorische_context"), 
                 jur_ctx, context.get("categorie", "proces"), "draft")
            )
            return cursor.lastrowid
        except sqlite3.IntegrityError:
            # Draft bestaat al, haal op
            cursor = conn.execute(
                "SELECT id FROM definities WHERE begrip=? AND "
                "organisatorische_context=? AND juridische_context=? "
                "AND categorie=? AND status='draft'",
                (begrip, context.get("organisatorische_context"),
                 jur_ctx, context.get("categorie", "proces"))
            )
            row = cursor.fetchone()
            if row:
                return row[0]

def update_voorbeelden_delta(self, definition_id: int, delta: dict) -&gt; bool:
    """
    Update alleen gewijzigde voorbeelden (geen mass-update).
    """
    current = self.get_voorbeelden(definition_id)
    
    for vb_type, new_content in delta.items():
        if new_content != current.get(vb_type):
            self._update_single_voorbeeld(definition_id, vb_type, new_content)
    
    return True</code></pre>

<p>Notities:</p>
<ul>
<li>Optimistic locking in de repository implementeren als `UPDATE ... WHERE id=? AND updated_at=?` en `rowcount==1` controleren; bij conflict kan optioneel de serverversie worden teruggegeven voor merge‚ÄëUX.</li>
<li>Voorbeelden‚Äëdelta: werk in √©√©n transactie en gebruik uitsluitend DB‚Äëtypen `('sentence','practical','counter','synonyms','antonyms','explanation')` met sleutel `(definitie_id, voorbeeld_type, voorbeeld_volgorde)`.</li>
</ul>

<h3>Fase 2: Stateless UI Implementation</h3>

<h4>2.1 Edit Mode met Draft ID</h4>

<p><strong>Bestand:</strong> <code>src/ui/components/definition_generator_tab.py</code>  </p>
<p><strong>Update edit trigger:</strong></p>

<pre><code>def _edit_existing_definition(self, definitie: DefinitieRecord):
    """Start edit door draft in database te maken."""
    try:
        repo = st.session_state.service_container.repository()
        
        # Maak draft in database (idempotent)
        draft_id = repo.get_or_create_draft(
            begrip=definitie.begrip,
            context={
                "organisatorische_context": definitie.organisatorische_context,
                "juridische_context": definitie.juridische_context,
                "categorie": definitie.categorie
            }
        )
        
        # Navigeer naar edit met draft_id in URL (met fallback)
        try:
            st.query_params["mode"] = "edit"
            st.query_params["draft_id"] = str(draft_id)
        except AttributeError:
            st.experimental_set_query_params(mode="edit", draft_id=str(draft_id))
        st.rerun()
    except Exception as e:
        st.error(f"Kon draft niet openen: {e!s}")

    # Actie knoppen
    col1, col2, col3 = st.columns(3)
    with col2:
        if st.button("‚úÖ Accepteer &amp; Sla Op", key="save_generated"):
            self._save_ai_definition(definitie)  # Direct opslaan zonder wijzigingen
    with col3:
        if st.button("üîÑ Genereer Opnieuw", key="regenerate"):
            self._handle_definition_generation()  # Nieuwe generatie starten</code></pre>

<h4>2.2 Render met Query Parameters</h4>

<p><strong>Update render functie:</strong></p>

<pre><code>def render(self):
    """Render de generator tab."""
    # Check voor edit mode via query params (stateless) met fallback
    try:
        params = st.query_params
    except AttributeError:
        params = st.experimental_get_query_params()

    mode = params.get("mode")
    draft_id = params.get("draft_id")

    # Als Streamlit een list teruggeeft bij experimental_get_query_params, pak eerste waarde
    if isinstance(mode, list):
        mode = mode[0] if mode else None
    if isinstance(draft_id, list):
        draft_id = draft_id[0] if draft_id else None

    if mode == "edit" and draft_id:
        self._render_edit_form(int(draft_id))
        return

    # Normale generator interface
    self._render_generator_interface()</code></pre>

<h3>Fase 3: Edit Form met Database Draft</h3>

<h4>3.1 Implementeer Edit Form met Validatie</h4>

<p><strong>Bestand:</strong> <code>src/ui/components/definition_generator_tab.py</code>  </p>
<p><strong>Nieuwe functie met caching en validatie:</strong></p>

<pre><code>def _load_draft(self, draft_id: int, cache_buster: str = None) -&gt; DefinitieRecord:
    """Laad draft uit database.
    
    Args:
        draft_id: ID van draft
        cache_buster: Optional timestamp voor cache invalidatie
    """
    repo = st.session_state.service_container.repository()
    return repo.get(draft_id)

def _render_edit_form(self, draft_id: int):
    """Render edit form met draft uit database."""
    
    # Laad draft met cache_buster voor invalidatie
    cache_buster = st.session_state.get("draft_cache_buster")
    draft = self._load_draft(draft_id, cache_buster)
    if not draft:
        st.error("Draft niet gevonden")
        if st.button("‚Ü©Ô∏è Terug"):
            st.query_params.clear()
            st.rerun()
        return
    
    st.markdown(f"### ‚úèÔ∏è Bewerk: {draft.begrip}")
    
    # Toon originele versie indien beschikbaar
    if draft.previous_version_id:
        with st.expander("ü§ñ Originele AI-versie", expanded=False):
            original = st.session_state.service_container.repository().get(
                draft.previous_version_id
            )
            if original:
                st.info(original.definitie)
    
    # Edit form met form key voor batch submit
    with st.form(f"edit_form_{draft_id}"):
        # Definitie tekst
        edited_text = st.text_area(
            "Definitie",
            value=draft.definitie,
            height=200,
            help="Bewerk de definitie tekst"
        )
    
    # Toon wat er veranderd is
    if edited_text != draft.definitie:
        st.caption("‚úèÔ∏è Je hebt wijzigingen aangebracht")
    
        # Context velden
        col1, col2 = st.columns(2)
        with col1:
            edited_org = st.selectbox(
                "Organisatorische Context",
                ["OM", "DJI", "Justid", "CJIB", "Rechtspraak"],
                index=["OM", "DJI", "Justid", "CJIB", "Rechtspraak"].index(
                    draft.organisatorische_context or "OM"
                )
            )
        
        with col2:
            edited_jur = st.text_input(
                "Juridische Context",
                value=draft.juridische_context or ""
            )
        
        # Wettelijke basis (nieuw veld)
        wettelijke_basis_text = st.text_area(
            "Wettelijke Basis",
            value=draft.wettelijke_basis or "",
            height=100,
            help="Voeg wettelijke referenties toe (√©√©n per regel)"
        )
    
        # Categorie
        edited_cat = st.selectbox(
            "Categorie",
            ["proces", "type", "resultaat", "exemplaar"],
            index=["proces", "type", "resultaat", "exemplaar"].index(
                draft.categorie or "proces"
            )
        )
    
        # Submit buttons in form
        col1, col2, col3 = st.columns([1, 1, 3])
        with col1:
            save_btn = st.form_submit_button("üíæ Opslaan", type="primary")
        with col2:
            cancel_btn = st.form_submit_button("‚ùå Annuleren")
        
        # Handle form submission
        if save_btn:
            self._save_draft_with_lock(
                draft_id=draft_id,
                updates={
                    "definitie": edited_text,
                    "organisatorische_context": edited_org,
                    "juridische_context": edited_jur,
                    "wettelijke_basis": wettelijke_basis_text,
                    "categorie": edited_cat
                },
                last_updated=draft.updated_at
            )
        
        if cancel_btn:
            try:
                st.query_params.clear()
            except AttributeError:
                st.experimental_set_query_params()
            st.rerun()
    
    
    # Validatie knop (buiten form voor onafhankelijke actie)
    if st.button("üîç Valideer Definitie"):
        self._validate_draft_with_cooldown(draft_id, edited_text, edited_cat, edited_org, edited_jur)
    
    # Toon validatie resultaten indien aanwezig
    if "validation_result" in st.session_state:
        self._render_validation_results(st.session_state.validation_result)</code></pre>

<h3>Fase 4: Save met Optimistic Locking</h3>

<h4>4.1 Save met Concurrent Edit Protection</h4>

<p><strong>Bestand:</strong> <code>src/ui/components/definition_generator_tab.py</code>  </p>
<p><strong>Nieuwe functie:</strong> Voeg toe na <code>_render_edit_form()</code></p>

<pre><code>def _save_draft_with_lock(self, draft_id: int, updates: dict, last_updated: datetime):
    """Save draft met concurrent edit protection."""
    try:
        repo = st.session_state.service_container.repository()
        
        # Optimistic lock check gebeurt in repository
        success = repo.update_with_lock_check(
            definition_id=draft_id,
            updates=updates,
            last_updated=last_updated
        )
        
        if success:
            st.success("‚úÖ Wijzigingen opgeslagen!")
            # Forceer herlaad met cache_buster
            st.session_state.draft_cache_buster = datetime.now().isoformat()
            # Optioneel: navigeer terug
            if st.button("‚úì Klaar met bewerken"):
                st.query_params.clear()
                st.rerun()
        else:
            st.error("""
                ‚ö†Ô∏è **Concurrent Edit Gedetecteerd**
                
                De definitie is gewijzigd door een andere gebruiker.
                Herlaad de pagina om de laatste versie te zien.
            """)
            if st.button("üîÑ Herlaad"):
                st.session_state.draft_cache_buster = datetime.now().isoformat()
                st.rerun()
                
    except Exception as e:
        logger.error(f"Save failed: {e}")
        st.error(f"Opslaan mislukt: {str(e)}")</code></pre>

<p>Notities:</p>
<ul>
<li>`update_with_lock_check` in de repository moet het lock afdwingen via `updated_at` en bij conflict `False` retourneren (en idealiter een `server_version` voor merge‚ÄëUI in een uitgebreid contract).</li>
</ul>

<h4>4.2 Validatie met Cooldown</h4>

<pre><code>def _validate_draft_with_cooldown(self, draft_id: int, text: str, cat: str, org: str, jur: str):
    """Valideer met cooldown van minimaal 2 seconden."""
    import time
    
    # Check cooldown
    last_validation = st.session_state.get("last_validation_time", 0)
    current_time = time.time()
    COOLDOWN_SECONDS = 2.0
    
    if current_time - last_validation &lt; COOLDOWN_SECONDS:
        remaining = COOLDOWN_SECONDS - (current_time - last_validation)
        st.warning(f"‚è±Ô∏è Wacht nog {remaining:.1f} seconden...")
        return
    
    # Valideer met busy indicator
    with st.spinner("üîç Validatie wordt uitgevoerd..."):
        orchestrator = st.session_state.service_container.orchestrator()
        from ui.helpers.async_bridge import run_async
        
        result = run_async(
            orchestrator.validate_text(
                begrip=st.session_state.get("current_term", ""),
                text=text,
                ontologische_categorie=cat,
                context={"organisatie": org, "juridisch": jur}
            )
        )
        
        st.session_state.validation_result = result
        st.session_state.last_validation_time = current_time</code></pre>

<h3>Fase 5: Privacy & Schema Alignment</h3>

<h4>5.1 Conditional Prompt Storage (Privacy)</h4>

<pre><code># In settings/config
STORE_PROMPTS_IN_DB = os.getenv("STORE_PROMPTS", "false").lower() == "true"

def save_with_privacy_check(self, definition: Definition, metadata: dict):
    """Sla op met privacy check voor prompts."""
    
    if STORE_PROMPTS_IN_DB and "prompt_template" in metadata:
        # Development mode - sla prompt op
        definition.metadata["prompt_template"] = metadata["prompt_template"]
    else:
        # Production - geen PII/prompts
        definition.metadata["prompt_stored"] = False
    
    return self.save(definition)</code></pre>

<p>Opmerking: stem dit af op de bestaande configuratie/feature‚Äëflag infrastructuur; voeg geen nieuwe production‚Äëflags toe zonder consensus. In development kan een env‚Äëflag volstaan, in productie bij voorkeur centrale config gebruiken.</p>

<h4>5.2 Schema.sql als Primary Source</h4>

<pre><code>def initialize_database():
    """Initialize via schema.sql (primary path)."""
    if not os.path.exists("data/definities.db"):
        # Primary: use schema.sql
        with open("src/database/schema.sql") as f:
            execute_sql(f.read())
    else:
        # Existing: run migrations
        run_migrations()

# Fallback alleen voor noodgevallen
def emergency_fallback():
    logger.warning("FALLBACK: should use schema.sql")</code></pre>

<h2>üß™ Test Strategie</h2>

<h3>Unit Tests</h3>
<pre><code># Draft invariant tests
def test_one_draft_per_combination():
    """Garandeer √©√©n draft per begrip+context+categorie."""

def test_delta_updates_only_changed():
    """Voorbeelden delta update alleen gewijzigde items."""

def test_validation_cooldown_enforced():
    """Validatie cooldown van 2 seconden wordt afgedwongen."""

def test_privacy_flag_prompt_storage():
    """Prompts alleen opgeslagen met expliciete flag."""</code></pre>

<h3>Integration Tests</h3>
<pre><code>def test_edit_flow_with_gates():
    """Test complete flow met kwaliteitspoorten."""
    # 1. Generate AI definition
    # 2. Create draft
    # 3. Edit
    # 4. Validate (check cooldown)
    # 5. Hit quality gate
    # 6. Fix issues
    # 7. Pass gate
    # 8. Publish</code></pre>

<h2>üìä Success Criteria</h2>

<ul>
<li>[x] Draft invariant: √©√©n actieve draft per combinatie</li>
<li>[x] Validatie cooldown: minimaal 2 seconden</li>
<li>[x] Kwaliteitspoorten: overall ‚â• 0.80; detailed_scores (juridisch/structuur) ‚â• 0.75; errors=0</li>
<li>[x] Privacy: prompt opslag alleen met flag</li>
<li>[x] Delta updates: alleen gewijzigde voorbeelden</li>
<li>[x] Concurrency: optimistic locking met merge UI</li>
<li>[x] Schema: primair via schema.sql, fallback gelogd</li>
<li>[x] Stateless: geen UI deps in services</li>
<li>[x] Audit: alle wijzigingen via triggers</li>
</ul>

<h2>‚ö° Implementatie Prioriteiten</h2>

<h3>P1 - Backend Foundation</h3>
<ol>
<li>Repository whitelist fix (alle velden)</li>
<li>`get_or_create_draft` implementatie</li>
<li>Delta update voor voorbeelden</li>
<li>Unit tests voor invarianten</li>
</ol>

<h3>P2 - Orchestrator & UI</h3>
<ol>
<li>Orchestrator V2 `update_definition`</li>
<li>Edit interface component</li>
<li>Validatie met cooldown</li>
<li>Integration tests</li>
</ol>

<h3>P3 - Polish & Gates</h3>
<ol>
<li>Kwaliteitspoorten implementatie</li>
<li>Concurrency merge UI</li>
<li>Privacy flag voor prompts</li>
<li>Performance optimalisaties</li>
</ol>

<h2>üöÄ Quick Start</h2>

<pre><code># 1. Open het bestand
code src/ui/components/definition_generator_tab.py

# 2. Voeg de nieuwe functies toe volgens dit plan

# 3. Test de implementatie
streamlit run src/main.py

# 4. Verifieer database updates
sqlite3 data/definities.db "SELECT * FROM definities ORDER BY updated_at DESC LIMIT 5;"</code></pre>

<h2>üîí Security & Privacy Notes</h2>

<ul>
<li>**Geen PII in logs** - Strip persoonlijke data</li>
<li>**Prompt opslag** - Alleen met expliciete flag (development)</li>
<li>**Wettelijke basis** - Opgeslagen als JSON array</li>
<li>**Audit trail** - Via DB triggers, niet in applicatie</li>
</ul>

<h2>üìù Undo/Redo Scope</h2>

<p><strong>MVP Scope:</strong> "Undo" = revert naar vorige versie (nieuw draft uit <code>previous_version_id</code>)</p>
<p><strong>Future:</strong> Full undo/redo stack met command pattern</p>

<h2>üîó Gerelateerde Documenten</h2>

<ul>
<li>[US-064.md](./US-064.md) - User Story</li>
<li>[US-153.md](../US-153/US-153.md) - Wettelijke basis</li>
<li>[US-154.md](../US-154/US-154.md) - DB normalisatie  </li>
<li>[US-110.md](../../EPIC-004/US-110/US-110.md) - Prompt opslag</li>
<li>[EPIC-004.md](../EPIC-004.md) - Parent Epic</li>
<li>[DATABASE_GUIDELINES.md](../../../guidelines/DATABASE_GUIDELINES.md) - DB richtlijnen</li>
<li>[CLAUDE.md](/CLAUDE.md) - Development richtlijnen</li>
</ul>

<h3>Fase 6: Workflow & Statuswijzigingen</h3>

<p>Gebruik <code>DefinitionWorkflowService</code> voor statusovergangen (bijv. DRAFT‚ÜíREVIEW):</p>
<ul>
<li>Koppel de workflowservice aan de repository en laat statusupdates verlopen via een services‚Äëadapter `update_status(...)` die intern `database.definitie_repository.change_status(...)` aanroept; of roep `change_status(...)` direct aan in de workflowservice.</li>
<li>Uniformeer foutcodes in `WorkflowResult` (bijv. `INVALID_TRANSITION`, `CONFLICT`, `NOT_FOUND`).</li>
<li>UI‚Äëactie ‚ÄúPubliceer (review)‚Äù roept de workflowservice aan; toon duidelijke feedback bij afgewezen transities.</li>
</ul>

  </div>
</body>
</html>