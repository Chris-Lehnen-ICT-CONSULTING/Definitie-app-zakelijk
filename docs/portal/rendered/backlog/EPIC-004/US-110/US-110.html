<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Persistente bronverantwoording (web sources) en generatie‑metadata voor definities</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">← Terug naar Portal</a>
    <p>---</p>
<p>id: US-110</p>
<p>epic: EPIC-004</p>
<p>titel: Persistente bronverantwoording (web sources) en generatie‑metadata voor definities</p>
<p>status: proposed</p>
<p>prioriteit: HIGH</p>
<p>story_points: 5</p>
<p>sprint: backlog</p>
<p>owner: architecture</p>
<p>applies_to: definitie-app@current</p>
<p>canonical: false</p>
<p>last_verified: 2025-09-12</p>
<p>---</p>

<h1>US-110: Persistente bronverantwoording (web sources) en generatie‑metadata voor definities</h1>

<h2>Gebruikersverhaal</h2>
<p>Als gebruiker wil ik dat bij iedere definitie de gebruikte bronnen (provenance) en de belangrijke generatie‑instellingen/artefacten (zoals prompt en model) duurzaam worden opgeslagen, zodat herleidbaarheid, auditing en reproduceerbaarheid gewaarborgd zijn.</p>

<h2>Context</h2>
<ul>
<li>UI toont “sources in preview” (Epic 3), maar structurele opslag in de DB ontbreekt nog.</li>
<li>Prompt debug sectie gebruikt `prompt_template` uit metadata; dat wordt niet persistent vastgelegd.</li>
<li>Gerelateerd: [US‑064 (Edit Interface)](../US-064/US-064.md), [US‑153 (wettelijke_basis kolom)](../US-153/US-153.md), [US‑154 (normalisatie wettelijke basis)](../US-154/US-154.md), [US‑071 (schema‑reconciliatie)](../US-071/US-071.md), en EPIC‑004.</li>
</ul>

<h2>Scope</h2>
<p>In scope</p>
<ul>
<li>DDL voor twee tabellen: `definitie_bronnen` (provenance) en `definitie_generatie` (generatie‑metadata).</li>
<li>Migratie (aanmaken tabellen + indexen); geen backfill vereist (huidige data bevat deze velden niet persistent).</li>
<li>Repo‑contract (signatures, dataclasses) voor CRUD en delta‑updates (geen implementatie in deze US).</li>
</ul>

<p>Out of scope</p>
<ul>
<li>UI‑aanpassingen en services‑implementatie (vallen onder US‑064 en services stories).</li>
<li>Externe bronnormalisatie (zoals masterdata voor webbronnen) — later mogelijk.</li>
</ul>

<h2>Ontwerp</h2>

<h3>DDL – Bronverantwoording (provenance)</h3>
<pre><code>CREATE TABLE IF NOT EXISTS definitie_bronnen (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    definitie_id INTEGER NOT NULL REFERENCES definities(id) ON DELETE CASCADE,

    name VARCHAR(255) NOT NULL,       -- WebSource.name
    url VARCHAR(500),                 -- WebSource.url
    confidence REAL DEFAULT 0.0,      -- WebSource.confidence
    is_juridical BOOLEAN DEFAULT FALSE, -- WebSource.is_juridical
    api_type VARCHAR(50),             -- "mediawiki", "sru", "scraping", etc.

    aangemaakt_op TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    bijgewerkt_op TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    UNIQUE(definitie_id, name, url)
);

CREATE INDEX IF NOT EXISTS idx_bronnen_definitie_id ON definitie_bronnen(definitie_id);

CREATE TRIGGER IF NOT EXISTS trg_bronnen_update
AFTER UPDATE ON definitie_bronnen
FOR EACH ROW WHEN NEW.bijgewerkt_op = OLD.bijgewerkt_op
BEGIN
    UPDATE definitie_bronnen SET bijgewerkt_op = CURRENT_TIMESTAMP WHERE id = NEW.id;
END;</code></pre>

<h3>DDL – Generatie‑metadata</h3>
<pre><code>CREATE TABLE IF NOT EXISTS definitie_generatie (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    generation_id VARCHAR(64),      -- UUID/trace id
    definitie_id INTEGER NOT NULL REFERENCES definities(id) ON DELETE CASCADE,

    model VARCHAR(100),             -- bijv. gpt-4o-mini-2024-07-18
    temperature REAL,               -- bijv. 0.0..1.0
    prompt_template TEXT,           -- effectieve prompt
    prompt_tokens INTEGER,          -- optioneel
    completion_tokens INTEGER,      -- optioneel
    total_tokens INTEGER,           -- optioneel
    duration_seconds REAL,          -- end-to-end duur
    orchestrator_version VARCHAR(20),
    created_by VARCHAR(255),

    aangemaakt_op TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_generatie_definitie_id ON definitie_generatie(definitie_id);
CREATE INDEX IF NOT EXISTS idx_generatie_generation_id ON definitie_generatie(generation_id);</code></pre>

<h2>Repository‑contract (concept)</h2>
<p>Dataclasses (voorbeeld):</p>
<pre><code>@dataclass
class BronRecord:
    id: int | None
    definitie_id: int
    name: str
    url: str | None = None
    confidence: float = 0.0
    is_juridical: bool = False
    api_type: str | None = None

@dataclass
class GeneratieRecord:
    id: int | None
    generation_id: str | None
    definitie_id: int
    model: str | None
    temperature: float | None
    prompt_template: str | None
    prompt_tokens: int | None
    completion_tokens: int | None
    total_tokens: int | None
    duration_seconds: float | None
    orchestrator_version: str | None
    created_by: str | None</code></pre>

<p>Methodes (signatures):</p>
<ul>
<li>Bronnen: `list_bronnen(definitie_id) -> list[BronRecord]`, `upsert_bronnen(definitie_id, nieuwe: list[BronRecord]) -> dict`</li>
<li>Generatie: `add_generatie(record: GeneratieRecord) -> int`, `list_generaties(definitie_id) -> list[GeneratieRecord]`</li>
</ul>

<h2>Migratie</h2>
<ul>
<li>Stap 1: DDL uitvoeren (tabellen + indexen + triggers).</li>
<li>Stap 2: (Optioneel) backfill wanneer data in logs/exports aanwezig is — niet vereist in deze US.</li>
</ul>

<h2>Acceptatiecriteria</h2>
<ul>
<li>[ ] Tabellen `definitie_bronnen` en `definitie_generatie` bestaan met bijbehorende indexen en triggers.</li>
<li>[ ] Repo‑contract gedefinieerd voor bronverantwoording en generatie‑metadata.</li>
<li>[ ] Links in dit document werken (US‑064, US‑069, US‑070, US‑071, EPIC‑004).</li>
</ul>

<h2>Teststrategie (concept)</h2>
<ul>
<li>DDL smoke: creatie op lege DB; herhaaldelijke creatie is idempotent.</li>
<li>CRUD rondes: (na implementerende US) insert/update/list/delete op bronnen en generaties; UNIQUE‑schendingen correct.</li>
<li>Integratie: UI/services kunnen bronnen/generaties schrijven en later weergeven.</li>
</ul>

<h2>Risico’s en mitigatie</h2>
<ul>
<li>Duplicaten van bronnen: UNIQUE(definitie_id, name, url) voorkomt triviale duplicaties; delta‑update API nodig.</li>
<li>Privacy/PII: prompt_template en modelparameters kunnen gevoelige context bevatten — opslag alleen op vertrouwde omgevingen; toonbaarheid via UI achter flag/rol.</li>
<li>Token/duratievelden optioneel, afhankelijk van AI‑provider logging.</li>
</ul>

<h2>Referenties</h2>
<ul>
<li>Schema: `src/database/schema.sql` (hoofdschema voor definities)</li>
<li>Gerelateerd: [US‑064](../US-064/US-064.md), [US‑153](../US-153/US-153.md), [US‑154](../US-154/US-154.md), [US‑071](../US-071/US-071.md), [EPIC‑004](../EPIC-004.md)</li>
</ul>

  </div>
</body>
</html>