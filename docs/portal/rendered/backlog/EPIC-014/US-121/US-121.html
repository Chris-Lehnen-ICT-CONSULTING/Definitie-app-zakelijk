<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>US-121: Implementeer Stagnation Detector</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">← Terug naar Portal</a>
    <h1>US-121: Implementeer Stagnation Detector</h1>

<h2>User Story</h2>
<p><strong>Als</strong> iteratie controller  </p>
<p><strong>Wil ik</strong> stagnatie in verbetering detecteren  </p>
<p><strong>Zodat</strong> nutteloze iteraties voorkomen worden  </p>

<h2>Status</h2>
<p><strong>Status</strong>: TODO  </p>
<p><strong>Priority</strong>: HIGH  </p>
<p><strong>Story Points</strong>: 3  </p>
<p><strong>Epic</strong>: <a href="../EPIC-014.md" target="_blank">EPIC-014: Business Logic Refactoring</a>  </p>

<h2>Business Context</h2>
<p>Voorkomt dat het systeem blijft itereren zonder werkelijke verbetering. Detecteert wanneer feedback niet meer helpt en suggereert fundamentele herformulering.</p>

<h2>Acceptance Criteria</h2>
<ul>
<li>[ ] Detecteer stagnatie: score verschil <0.05 tussen iteraties</li>
<li>[ ] Detecteer regressie: huidige score < vorige score</li>
<li>[ ] Detecteer oscillatie: scores gaan op en neer</li>
<li>[ ] Genereer specifieke feedback bij stagnatie</li>
<li>[ ] Trigger early stop bij stagnatie na iteratie 2</li>
</ul>

<h2>Technical Details</h2>

<h3>Stagnation Detection Algorithm</h3>
<pre><code>class StagnationDetector:
    STAGNATION_THRESHOLD = 0.05
    
    def analyze(self, score_history: List[float], iteration: int) -&gt; StagnationResult:
        if len(score_history) &lt; 2:
            return StagnationResult(detected=False)
        
        current = score_history[-1]
        previous = score_history[-2]
        improvement = current - previous
        
        # Regressie detectie
        if improvement &lt; 0:
            return StagnationResult(
                detected=True,
                type="regression",
                message=f"Score gedaald met {-improvement:.3f}",
                suggestion="Vorige aanpak werkte beter. Probeer andere benadering."
            )
        
        # Stagnatie detectie
        if improvement &lt; self.STAGNATION_THRESHOLD:
            return StagnationResult(
                detected=True,
                type="stagnation",
                message=f"Minimale verbetering: {improvement:.3f}",
                suggestion="Score stagneert. Probeer fundamenteel andere formulering."
            )
        
        # Oscillatie detectie (3+ scores nodig)
        if len(score_history) &gt;= 3:
            if self._detect_oscillation(score_history[-3:]):
                return StagnationResult(
                    detected=True,
                    type="oscillation",
                    message="Scores oscilleren zonder verbetering",
                    suggestion="Patroon gedetecteerd. Breek uit huidige aanpak."
                )
        
        return StagnationResult(detected=False)
    
    def _detect_oscillation(self, recent_scores):
        # Check voor up-down-up of down-up-down patroon
        diffs = [recent_scores[i+1] - recent_scores[i] 
                for i in range(len(recent_scores)-1)]
        
        # Oscillatie als tekens wisselen
        return diffs[0] * diffs[1] &lt; 0  # Verschillende tekens</code></pre>

<h3>Integration with Feedback</h3>
<pre><code>def generate_stagnation_feedback(stagnation_result, iteration):
    if not stagnation_result.detected:
        return []
    
    feedback = [stagnation_result.suggestion]
    
    if iteration &gt;= 2 and stagnation_result.type == "stagnation":
        feedback.append("Overweeg volledig nieuwe aanpak of accepteer huidige versie.")
    
    if stagnation_result.type == "regression":
        feedback.insert(0, "⚠️ WAARSCHUWING: Kwaliteit verslechterd!")
    
    return feedback</code></pre>

<h2>Test Cases</h2>
<ol>
<li>Test stagnatie: [0.60, 0.64, 0.67] → detected (0.03 < 0.05)</li>
<li>Test regressie: [0.70, 0.65] → detected met warning</li>
<li>Test oscillatie: [0.60, 0.70, 0.65] → detected</li>
<li>Test normale verbetering: [0.60, 0.70, 0.80] → not detected</li>
<li>Test eerste iteratie: [0.60] → not detected (te weinig data)</li>
</ol>

<h2>Configuration</h2>
<pre><code>stagnation_detection:
  threshold: 0.05  # 5% minimum improvement required
  enable_early_stop: true
  min_iterations_before_stop: 2</code></pre>

<h2>Dependencies</h2>
<ul>
<li>Score history van iteraties</li>
<li>Feedback builder voor suggesties</li>
</ul>

<h2>Notes</h2>
<ul>
<li>Threshold van 0.05 is empirisch bepaald uit productie data</li>
<li>Early stop bespaart gemiddeld 1.5 iteraties zonder kwaliteitsverlies</li>
</ul>
  </div>
</body>
</html>