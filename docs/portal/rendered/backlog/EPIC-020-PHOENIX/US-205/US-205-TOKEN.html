<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Token Optimization & Caching Implementation</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">← Terug naar Portal</a>
    <p>---</p>
<p>id: US-205-TOKEN</p>
<p>epic: EPIC-020-PHOENIX</p>
<p>titel: Token Optimization & Caching Implementation</p>
<p>status: open</p>
<p>prioriteit: P2</p>
<p>story_points: 5</p>
<p>aangemaakt: 2025-09-30</p>
<p>bijgewerkt: 2025-09-30</p>
<p>owner: tbd</p>
<p>applies_to: definitie-app@current</p>
<p>canonical: false</p>
<p>last_verified: 2025-09-30</p>
<p>---</p>

<h1>US-205: Token Optimization & Caching Implementation</h1>

<p><strong>Note</strong>: Er is een nummering conflict. Dit document beschrijft de ECHTE US-205 volgens EPIC-020.</p>
<p>Het bestaande US-205.md gaat over God Class refactoring en hoort bij US-207.</p>

<p>---</p>
<p>id: US-205</p>
<p>epic_id: EPIC-020-PHOENIX</p>
<p>title: Token Optimization & Caching Implementation</p>
<p>status: READY</p>
<p>priority: HIGH</p>
<p>story_points: 8</p>
<p>assignee: team</p>
<p>created_date: 2025-01-18</p>
<p>updated_date: 2025-01-18</p>
<p>labels: [phoenix, performance, optimization, tokens, cost-reduction]</p>
<p>dependencies:</p>
<ul>
<li> - US-203 (Token analysis - COMPLETED)</li>
<p>---</p>
</ul>

<h2>User Story</h2>
<p><strong>Als</strong> product owner</p>
<p><strong>Wil ik</strong> de geanalyseerde token optimalisaties geïmplementeerd hebben</p>
<p><strong>Zodat</strong> we van 7.250 naar <3.000 tokens per prompt gaan en 60% kosten besparen</p>

<h2>Context</h2>
<p>US-203 heeft aangetoond dat 61% token reductie haalbaar is door:</p>
<ul>
<li>Module consolidatie (17→7 modules): -2.000 tokens</li>
<li>Context-aware loading: -1.200 tokens</li>
<li>Validatieregel deduplicatie: -1.000 tokens</li>
<li>Smart example selection: -800 tokens</li>
</ul>

<h2>Acceptance Criteria</h2>

<h3>Must Have</h3>
<ul>
<li>[ ] Token count ≤3.000 voor alle definitie types</li>
<li>[ ] Module consolidatie geïmplementeerd (17→7)</li>
<li>[ ] Context-aware module loading werkend</li>
<li>[ ] Geen kwaliteitsverlies in definities (>95% validation pass rate)</li>
</ul>

<h3>Should Have</h3>
<ul>
<li>[ ] Dynamic example selection</li>
<li>[ ] Prompt template caching</li>
<li>[ ] Token usage monitoring dashboard</li>
</ul>

<h2>Technical Implementation</h2>

<h3>Phase 1: Module Consolidatie (2 dagen)</h3>
<p>Consolideer 17 modules naar 7:</p>

<pre><code># NEW: src/services/prompts/modules/consolidated/

core_validation_module.py      # ARAI + ESS + SAM + VER
structure_quality_module.py    # STR + INT + grammar
context_processing_module.py   # context_awareness + CON + semantic
output_format_module.py        # output_spec + template
task_expertise_module.py       # definition_task + expertise
quality_control_module.py      # error_prevention + metrics
base_module.py                 # unchanged</code></pre>

<h3>Phase 2: Context-Aware Loading (1 dag)</h3>
<pre><code>class ModuleSelector:
    def select_modules(self, begrip_type: str) -&gt; List[Module]:
        """Load alleen relevante modules per begrip type."""

        if begrip_type == "proces":
            return [
                self.core_validation,
                self.context_processing,
                self.task_expertise
            ]  # Skip structure_quality, output_format

        elif begrip_type == "object":
            return [
                self.core_validation,
                self.structure_quality,
                self.output_format
            ]  # Skip process-specific modules</code></pre>

<h3>Phase 3: Rule Deduplication (1 dag)</h3>
<pre><code>class RuleDeduplicator:
    def deduplicate(self, rules: List[Rule]) -&gt; List[Rule]:
        """Remove overlapping validation rules."""

        # Merge similar rules
        merged = self.merge_similar(rules)

        # Remove redundant examples
        cleaned = self.remove_duplicate_examples(merged)

        return cleaned[:15]  # Max 15 most important rules</code></pre>

<h3>Phase 4: Smart Example Selection (1 dag)</h3>
<pre><code>class ExampleSelector:
    def select_relevant(self, term: str, max_count: int = 3) -&gt; List[str]:
        """Select only most relevant examples."""

        # Use semantic similarity
        examples = self.rank_by_similarity(term, self.all_examples)

        # Return top N
        return examples[:max_count]</code></pre>

<h2>Test Strategy</h2>

<h3>Quality Tests</h3>
<pre><code>def test_definition_quality_maintained():
    """Ensure optimized prompts maintain quality."""

    for test_term in TEST_TERMS:
        old_result = generate_with_old_prompt(test_term)
        new_result = generate_with_optimized_prompt(test_term)

        assert similarity(old_result, new_result) &gt; 0.95
        assert validation_score(new_result) &gt;= validation_score(old_result)</code></pre>

<h3>Performance Tests</h3>
<pre><code>def test_token_reduction():
    """Verify token count stays under 3000."""

    for test_case in TEST_CASES:
        prompt = build_optimized_prompt(test_case)
        tokens = count_tokens(prompt)

        assert tokens &lt;= 3000</code></pre>

<h2>Rollout Plan</h2>

<h3>Week 2 Schedule</h3>
<ul>
<li>**Maandag**: Module consolidatie development</li>
<li>**Dinsdag**: Module consolidatie testing & integration</li>
<li>**Woensdag**: Context-aware loading implementation</li>
<li>**Donderdag**: Rule deduplication & example selection</li>
<li>**Vrijdag**: A/B testing & quality validation</li>
</ul>

<h2>Success Metrics</h2>
<ul>
<li>Token usage: 7.250 → ≤3.000 (-59%)</li>
<li>API costs: €0.15 → €0.06 per generatie (-60%)</li>
<li>Response time: 5s → <3s (-40%)</li>
<li>Quality score: ≥4.5/5 maintained</li>
</ul>

<h2>Risks & Mitigations</h2>
<p>| Risk | Impact | Mitigation |</p>
<p>|------|---------|-----------|</p>
<p>| Quality degradation | HIGH | A/B testing, gradual rollout |</p>
<p>| Module conflicts | MEDIUM | Comprehensive integration tests |</p>
<p>| Performance issues | LOW | Caching, lazy loading |</p>

<h2>Notes</h2>
<ul>
<li>Dit is de IMPLEMENTATIE van het onderzoek uit US-203</li>
<li>Focus op quick wins eerst (module consolidatie)</li>
<li>Quality monitoring is kritiek tijdens rollout</li>
</ul>
  </div>
</body>
</html>