<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fix ServiceContainer Caching to Prevent 6x Re-initialization</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">← Terug naar Portal</a>
    <p>---</p>
<p>id: US-201</p>
<p>epic: EPIC-020</p>
<p>title: "Fix ServiceContainer Caching to Prevent 6x Re-initialization"</p>
<p>status: OPEN</p>
<p>priority: CRITICAL</p>
<p>story_points: 3</p>
<p>tags: [performance, caching, streamlit, initialization]</p>
<p>created: 2025-01-18</p>
<p>updated: 2025-01-18</p>
<p>---</p>

<h1>US-201: Fix ServiceContainer Caching to Prevent 6x Re-initialization</h1>

<h2>User Story</h2>
<p><strong>Als</strong> ontwikkelaar</p>
<p><strong>Wil ik</strong> dat de ServiceContainer slechts eenmaal wordt geïnitialiseerd per sessie</p>
<p><strong>Zodat</strong> de applicatie niet 6x alle services opnieuw initialiseert bij elke Streamlit rerun</p>

<h2>Probleem</h2>
<p>Huidige situatie: ServiceContainer wordt 6x opnieuw geïnitialiseerd bij elke Streamlit rerun, wat leidt tot:</p>
<ul>
<li>**6x hogere startup tijd** (6 seconden vs 1 seconde)</li>
<li>**Onnodige resource allocatie**</li>
<li>**Potentiële race conditions**</li>
<li>**Verlies van service state tussen reruns**</li>
</ul>

<h2>Acceptance Criteria</h2>

<h3>Must Have</h3>
<ul>
<li>[ ] ServiceContainer wordt **exact 1x** geïnitialiseerd per sessie</li>
<li>[ ] Services behouden hun state tussen Streamlit reruns</li>
<li>[ ] Geen duplicate initialisaties detecteerbaar in logs</li>
<li>[ ] Startup tijd gereduceerd van ~6s naar <1s</li>
</ul>

<h3>Should Have</h3>
<ul>
<li>[ ] Lazy loading van services (alleen initialiseren wanneer nodig)</li>
<li>[ ] Clear cache mechanisme voor development/debugging</li>
<li>[ ] Monitoring/logging van cache hits vs misses</li>
</ul>

<h3>Performance Targets</h3>
<ul>
<li>**Current**: ~6 seconden initialisatie tijd</li>
<li>**Target**: <1 seconde initialisatie tijd</li>
<li>**Cache hit ratio**: >95% na eerste initialisatie</li>
</ul>

<h2>Technical Implementation</h2>

<h3>Approach 1: @st.cache_resource (Recommended)</h3>
<pre><code># src/services/container.py
@st.cache_resource
def get_service_container() -&gt; ServiceContainer:
    """Singleton ServiceContainer with proper caching."""
    return ServiceContainer()

# In main.py / UI components
def get_container():
    if 'service_container' not in st.session_state:
        st.session_state.service_container = get_service_container()
    return st.session_state.service_container</code></pre>

<h3>Approach 2: Session State Pattern</h3>
<pre><code># src/utils/container_manager.py
class ContainerManager:
    @staticmethod
    def get_or_create():
        if 'service_container' not in st.session_state:
            with st.spinner("Initializing services..."):
                st.session_state.service_container = ServiceContainer()
                st.session_state.init_timestamp = time.time()
        return st.session_state.service_container</code></pre>

<h3>Key Files to Modify</h3>
<ol>
<li>`src/services/container.py` - Add caching decorator</li>
<li>`src/main.py` - Update initialization pattern</li>
<li>`src/ui/tabs/*.py` - Use cached container reference</li>
<li>`src/utils/session_manager.py` - Centralize session state management</li>
</ol>

<h2>Test Scenarios</h2>

<h3>Unit Tests</h3>
<pre><code>def test_singleton_pattern():
    """Container should return same instance."""
    container1 = get_service_container()
    container2 = get_service_container()
    assert container1 is container2

def test_service_persistence():
    """Services should maintain state between calls."""
    container = get_service_container()
    service1 = container.get_service('validation')
    service2 = container.get_service('validation')
    assert service1 is service2</code></pre>

<h3>Integration Tests</h3>
<ul>
<li>Measure initialization time with profiler</li>
<li>Verify no duplicate log entries for service creation</li>
<li>Test cache behavior across simulated reruns</li>
</ul>

<h3>Manual Testing</h3>
<ol>
<li>Start application and monitor console logs</li>
<li>Trigger Streamlit rerun (change input, click button)</li>
<li>Verify no re-initialization messages</li>
<li>Check performance metrics in browser DevTools</li>
</ol>

<h2>Definition of Done</h2>

<ul>
<li>[ ] Code implementation complete with caching mechanism</li>
<li>[ ] Unit tests pass (100% coverage on caching logic)</li>
<li>[ ] Integration tests confirm single initialization</li>
<li>[ ] Performance benchmark shows >80% reduction in startup time</li>
<li>[ ] No regression in existing functionality</li>
<li>[ ] Code review completed</li>
<li>[ ] Documentation updated (architecture diagrams if needed)</li>
<li>[ ] Monitoring/logging implemented for cache behavior</li>
</ul>

<h2>Dependencies</h2>
<ul>
<li>None - This is a foundational fix</li>
</ul>

<h2>Risks & Mitigations</h2>
<p>| Risk | Impact | Mitigation |</p>
<p>|------|---------|------------|</p>
<p>| Cache invalidation issues | HIGH | Implement clear cache mechanism for dev mode |</p>
<p>| Memory leaks from cached services | MEDIUM | Add memory monitoring, implement cleanup |</p>
<p>| State corruption between users | LOW | Streamlit handles user isolation |</p>

<h2>Notes</h2>
<ul>
<li>This is the **highest priority** performance fix</li>
<li>Blocks all other optimization work</li>
<li>Expected to reduce overall response time by 40-50%</li>
<li>Consider implementing cache warming strategy</li>
</ul>

<h2>Progress Tracking</h2>
<ul>
<li>[ ] Implementation started</li>
<li>[ ] Tests written</li>
<li>[ ] Code review requested</li>
<li>[ ] Merged to main</li>
<li>[ ] Performance validated in production</li>
</ul>
  </div>
</body>
</html>