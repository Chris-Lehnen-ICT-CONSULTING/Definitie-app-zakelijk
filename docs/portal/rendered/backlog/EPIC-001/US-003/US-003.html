<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Eliminate Legacy V1 Orchestrator en Migrate to V2 Service Architecture</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">← Terug naar Portal</a>
    <p>---</p>
<p>Afhankelijkheden:</p>
<ul>
<li>US-001</li>
<li>US-002</li>
<p>aangemaakt: 03-01-2025</p>
<p>bijgewerkt: 05-09-2025</p>
<p>epic: EPIC-001</p>
<p>id: US-003</p>
<p>prioriteit: KRITIEK</p>
<p>sprint: Voltooid</p>
<p>status: GEREED</p>
<p>story_points: 13</p>
<p>titel: Eliminate Legacy V1 Orchestrator en Migrate to V2 Service Architecture</p>
<p>toegewezen_aan: development-team</p>
<p>vereisten:</p>
<li>REQ-018</li>
<li>REQ-020</li>
<li>REQ-059</li>
<li>REQ-078</li>
<p>---</p>
</ul>



<h1>US-003: Eliminate Legacy V1 Orchestrator en Migrate to V2 Service Architecture</h1>

<h2>Gebruikersverhaal</h2>
<p><strong>As a</strong> system architect responsible for DefinitieAgent maintainability</p>
<p><strong>wil ik</strong> to eliminate the legacy V1 orchestrator en complete migration to V2 service architecture</p>
<p><strong>zodat</strong> we reduce code complexity by 40%, eliminate 6x service initialization bug, En improve Prestaties by 30%</p>

<h2>Problem Statement</h2>

<p><strong>Current Situation:</strong></p>
<ul>
<li>V1 en V2 orchestrators running in parallel (code duplication)</li>
<li>Services initialized 6x per session due to V1 legacy hooks</li>
<li>15,000 lines of deprecated V1 code still in codebase</li>
<li>Memory usage 2x hoger due to duplicate service instances</li>
<li>Complex branching logic to support both Versies</li>
<li>V1 hardcoded configurations blocking environment flexibility</li>
</ul>

<p><strong>Desired Outcome:</strong></p>
<ul>
<li>Single V2 orchestrator with clean architecture</li>
<li>Services initialized once per session (singleton pattern)</li>
<li>Remove all V1 code (15,000 lines reduction)</li>
<li>Memory usage reduced by 50%</li>
<li>Simplified codebase with single execution path</li>
<li>Full environment-based configuration support</li>
</ul>

<h2>Acceptatiecriteria</h2>


<h3>SMART Acceptatiecriteria</h3>

<ul>
<li>**Specifiek:** Migreer volledig van V1 naar V2 orchestrator met singleton pattern</li>
<li>**Meetbaar:**</li>
<li> - Code reductie: 15.000 regels V1 code verwijderd</li>
<li> - Service init: 1x i.p.v. 6x per sessie</li>
<li> - Memory gebruik: < 250MB (50% reductie)</li>
<li> - Startup tijd: < 2 seconden (was 12s)</li>
<li> - Test coverage: > 80% behouden</li>
<li> - 0 V1 references in codebase</li>
<li>**Acceptabel:** Gefaseerde migratie met rollback optie</li>
<li>**Relevant:** Elimineert technische schuld en verbetert performance</li>
<li>**Tijdgebonden:** Voltooid in Sprint 3 (2 weken)</li>
</ul>


<h3>Criterion 1: Complete V1 Code Removal</h3>
<p><strong>gegeven</strong> the codebase contains V1 orchestrator files</p>
<p><strong>wanneer</strong> migration is complete</p>
<p><strong>dan</strong>:</p>
<ul>
<li>All files matching `*_v1.py` are deleted</li>
<li>No imports from `legacy` package remain</li>
<li>No references to `DefinitionOrchestrator` (V1 class)</li>
<li>Code coverage remains > 80%</li>
</ul>

<h3>Criterion 2: V2 Service Architecture Active</h3>
<p><strong>gegeven</strong> the application starts</p>
<p><strong>wanneer</strong> checking service initialization</p>
<p><strong>dan</strong>:</p>
<ul>
<li>`ValidationOrchestratorV2` is the only orchestrator</li>
<li>Services initialized exactly once (verified in logs)</li>
<li>All afhankelijkheid injection via `ServiceContainer`</li>
<li>No hardcoded service instantiation</li>
</ul>

<h3>Criterion 3: Prestaties Improvements Achieved</h3>
<p><strong>gegeven</strong> V2 architecture is fully active</p>
<p><strong>wanneer</strong> measuring system Prestaties</p>
<p><strong>dan</strong>:</p>
<ul>
<li>Service initialization time < 2 seconds (was 12 seconds)</li>
<li>Memory usage < 250MB per session (was 500MB)</li>
<li>Definition generation time < 3 seconds (was 5 seconds)</li>
<li>No memory leaks after 1000 operations</li>
</ul>

<h3>Criterion 4: Feature Parity Maintained</h3>
<p><strong>gegeven</strong> all V1 features are migrated</p>
<p><strong>wanneer</strong> running regression test suite</p>
<p><strong>dan</strong>:</p>
<ul>
<li>All 45 validatieregels still working</li>
<li>All UI tabs functional</li>
<li>Database operations intact</li>
<li>Export/import features operational</li>
<li>Zero functional regression</li>
</ul>

<h2>Technical Implementatie</h2>

<h3>Implementatie Approach</h3>

<ol>
<li>**Step 1**: Map V1 to V2 service Afhankelijkheden</li>
<pre><code>   # V1 -&gt; V2 Mapping
   DefinitionOrchestrator -&gt; ValidationOrchestratorV2
   AIService -&gt; AIServiceV2
   PromptService -&gt; PromptServiceV2
   ValidationService -&gt; ModularValidationService</code></pre>
</ol>

<ol>
<li>**Step 2**: UpDatum ServiceContainer in `src/services/container.py`</li>
</ol>
<ul>
<li>  - Remove V1 service registrations</li>
<li>  - Ensure singleton pattern with `@st.cache_resource`</li>
<li>  - Add lazy loading for Prestaties</li>
</ul>

<ol>
<li>**Step 3**: Refactor entry points</li>
</ol>
<ul>
<li>  - UpDatum `src/main.py` to use V2 only</li>
<li>  - Remove feature flags for V1/V2 selection</li>
<li>  - Clean up session state management</li>
</ul>

<ol>
<li>**Step 4**: Delete V1 files en upDatum imports</li>
<pre><code>   # Files to delete
   src/services/definition_orchestrator.py
   src/services/ai_service.py  # (V1)
   src/services/prompt_service.py  # (V1)
   src/services/validation_service.py  # (V1)
   src/legacy/*</code></pre>
</ol>

<ol>
<li>**Step 5**: UpDatum all UI components</li>
</ol>
<ul>
<li>  - Refactor `src/ui/tabs/*.py` to use V2 services</li>
<li>  - Remove V1 compatibility code</li>
<li>  - UpDatum state management</li>
</ul>

<h3>Code Locations</h3>
<ul>
<li>Files to modify:</li>
<li> - `src/main.py` (entry point)</li>
<li> - `src/services/container.py` (DI container)</li>
<li> - `src/ui/tabs/*.py` (all UI tabs)</li>
<li> - `src/services/__init__.py` (exports)</li>
<li>Files to delete:</li>
<li> - `src/services/*_v1.py`</li>
<li> - `src/legacy/`</li>
<li> - `src/compat/`</li>
<li>New patterns:</li>
<li> - Singleton: `@st.cache_resource` on ServiceContainer</li>
<li> - Lazy loading: Services aangemaakt on first use</li>
<li> - Dependency injection: All services from container</li>
</ul>

<h3>Technical Decisions</h3>
<ul>
<li>Use singleton pattern to prevent re-initialization</li>
<li>Implement lazy loading to improve startup time</li>
<li>Add service health checks for monitoring</li>
<li>Use interfaces for all service contracts</li>
<li>Implement circuit breaker pattern for resilience</li>
</ul>

<h2>Domain & compliance</h2>

<h3>Domeinregels</h3>
<ul>
<li>**ASTRA vereiste**: Service-oriented architecture with loose coupling</li>
<li>**NORA principle**: Eliminate technical debt systematically</li>
<li>**justitieketen impact**: Zero disruption to OM/DJI/Rechtspraak workflags</li>
<li>**Continuity**: Maintain backward compatibility for data formats</li>
</ul>

<h3>beveiliging & Privacy</h3>
<ul>
<li>**beveiliging**: Remove deprecated auDanticatie methods from V1</li>
<li>**Privacy**: Ensure V2 maintains same privacy controls</li>
<li>**Audit**: Log migration completion en service Versies</li>
<li>**Rollback**: Keep V1 backup for 30 days post-migration</li>
</ul>



<h2>Afhankelijkheden</h2>

<ul>
<li>EPIC-001</li>
</ul>
<h2>Test Scenario's</h2>

<h3>Unit Tests</h3>

<ol>
<li>**Test**: `test_v2_orchestrator_singleton()`</li>
</ol>
<ul>
<li>  - Setup: Initialize ServiceContainer multiple times</li>
<li>  - Expected: Same instance returned</li>
<li>  - Assert: `id(container1) == id(container2)`</li>
<li>  - File: `tests/services/test_container.py`</li>
</ul>

<ol>
<li>**Test**: `test_no_v1_imports()`</li>
</ol>
<ul>
<li>  - Action: Scan all Python files for V1 imports</li>
<li>  - Expected: Zero V1 references found</li>
<li>  - Assert: `"_v1" not in imports`, `"legacy" not in imports`</li>
</ul>

<ol>
<li>**Test**: `test_service_initialization_count()`</li>
</ol>
<ul>
<li>  - Setup: Clear logs, start application, generate definition</li>
<li>  - Count: Service init messages in logs</li>
<li>  - Assert: Each service initialized exactly once</li>
</ul>

<h3>Integration Tests</h3>

<ol>
<li>**Test**: `test_full_flag_with_v2()`</li>
</ol>
<ul>
<li>  - Actions: Generate -> ValiDatum -> Export -> Import</li>
<li>  - maatregel: Success rate, Prestaties</li>
<li>  - Assert: All operations successful, time < V1 baseline</li>
</ul>

<ol>
<li>**Test**: `test_memory_usage_after_migration()`</li>
</ol>
<ul>
<li>  - Setup: Generate 100 definitions sequentially</li>
<li>  - maatregel: Memory before/after</li>
<li>  - Assert: `memory_after - memory_before < 50MB`</li>
</ul>

<h3>Prestaties Tests</h3>

<ol>
<li>**Test**: `test_startup_Prestaties()`</li>
</ol>
<ul>
<li>  - maatregel: Time from start to ready</li>
<li>  - Assert: `startup_time < 2 seconds`</li>
</ul>

<ol>
<li>**Test**: `test_concurrent_operations()`</li>
</ol>
<ul>
<li>  - Setup: 50 concurrent definition requests</li>
<li>  - Assert: No service re-initialization, all complete < 10s</li>
</ul>

<h2>Definitie van Gereed</h2>

<ul>
<li>[x] V1 to V2 service mapping documented</li>
<li>[x] ServiceContainer bijgewerkt with singleton pattern</li>
<li>[x] All V1 files deleted from codebase</li>
<li>[x] All imports bijgewerkt to V2 services</li>
<li>[x] UI components refactored for V2</li>
<li>[x] Unit tests bijgewerkt en passing (82% coverage)</li>
<li>[x] Integration tests confirm feature parity</li>
<li>[x] Prestaties benchmarks met (35% improvement)</li>
<li>[x] Memory usage reduced by 55%</li>
<li>[x] Zero V1 references in codebase</li>
<li>[x] Code review by senior architects</li>
<li>[x] Gradual rollout with monitoring</li>
<li>[x] Documentation bijgewerkt</li>
<li>[x] Rollback plan tested</li>
</ul>

<h2>Risks & Mitigation</h2>

<ol>
<li>**Risk**: Hidden V1 Afhankelijkheden cause runtime errors</li>
</ol>
<ul>
<li>  - Probability: GEMIDDELD</li>
<li>  - Impact: HOOG</li>
<li>  - Mitigation: Comprehensive integration testing, gradual rollout</li>
</ul>

<ol>
<li>**Risk**: Prestaties regression in edge cases</li>
</ol>
<ul>
<li>  - Probability: LAAG</li>
<li>  - Impact: GEMIDDELD</li>
<li>  - Mitigation: Prestaties monitoring, quick rollback capability</li>
</ul>

<ol>
<li>**Risk**: Data format incompatibility</li>
</ol>
<ul>
<li>  - Probability: LAAG</li>
<li>  - Impact: HOOG</li>
<li>  - Mitigation: Data migration scripts, compatibility layer</li>
</ul>

<h2>Notes & References</h2>

<h3>Migration Timeline</h3>
<ul>
<li>Planning: 10-01-2025</li>
<li>V1 analysis: 12-01-2025</li>
<li>V2 Implementatie: 15-01-2025</li>
<li>Testen phase: 18-01-2025</li>
<li>Gradual rollout: 20-01-2025</li>
<li>V1 removal: 25-01-2025</li>
<li>Production stable: 01-02-2025</li>
</ul>

<h3>Metrics Achieved</h3>
<ul>
<li>Code reduction: 15,000 lines removed ✅</li>
<li>Service init: 1x instead of 6x ✅</li>
<li>Memory usage: 55% reduction ✅</li>
<li>Prestaties: 35% faster ✅</li>
<li>testdekking: 82% maintained ✅</li>
</ul>

<h3>Gerelateerde Documentatie</h3>
<ul>
<li>Migration plan: `docs/migration/v1-to-v2.md`</li>
<li>Architecture: `docs/architectuur/SOLUTION_ARCHITECTURE.md`</li>
<li>Service docs: `docs/services/orchestrator_v2.md`</li>
</ul>

<p>---</p>

<p><em>This story is part of EPIC-001: Basis Definitie Generatie</em></p>

  </div>
</body>
</html>