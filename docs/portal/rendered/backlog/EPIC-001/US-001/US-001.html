<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>US-001: GPT-4 Definitiegeneratie - AI-gestuurde juridische definitiecreatie met 95% nauwkeurigheid en <5s responstijd</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">← Terug naar Portal</a>
    <p>---</p>
<p>id: US-001</p>
<p>epic: EPIC-001</p>
<p>titel: "US-001: GPT-4 Definitiegeneratie - AI-gestuurde juridische definitiecreatie met 95% nauwkeurigheid en <5s responstijd"</p>
<p>status: completed</p>
<p>prioriteit: KRITIEK</p>
<p>story_points: 8</p>
<p>sprint: Voltooid</p>
<p>aangemaakt: 01-01-2025</p>
<p>bijgewerkt: 05-09-2025</p>
<p>owner: development-team</p>
<p>applies_to: definitie-app@current</p>
<p>canonical: false</p>
<p>last_verified: 2025-10-02</p>
<p>vereisten:</p>
<ul>
<li> - REQ-018</li>
<li> - REQ-038</li>
<li> - REQ-078</li>
<li> - REQ-079</li>
<p>Afhankelijkheden: []</p>
<p>toegewezen_aan: development-team</p>
<p>---</p>
</ul>



<h1>US-001: Implementeer Core GPT-4 Definitiegeneratie met 95% Succesratio</h1>

<h2>Gebruikersverhaal</h2>

<p><strong>Als</strong> juridisch professional werkzaam bij OM, DJI, of Rechtspraak</p>
<p><strong>wil ik</strong> Nederlandse juridische definities genereren met GPT-4 met context-bewuste prompting</p>
<p><strong>zodat</strong> ik juridisch accurate definities 10x sneller kan creëren dan handmatig schrijven (5 seconden vs 50 minuten)</p>

<h2>Probleemstelling</h2>

<p><strong>Huidige Situatie:</strong></p>
<ul>
<li>Handmatig definities schrijven kost 30-50 minuten per term</li>
<li>40% van handgeschreven definities faalt bij juridische review</li>
<li>Geen standaardisatie tussen verschillende juridische afdelingen</li>
<li>Juridische professionals besteden 25% van hun tijd aan definitietaken</li>
<li>Kennissilo's tussen OM, DJI, en Rechtspraak afdelingen</li>
</ul>

<p><strong>Gewenste Uitkomst:</strong></p>
<ul>
<li>Genereer definities in < 5 seconden (600x verbetering)</li>
<li>Bereik 95% first-pass nauwkeurigheid voor juridische review</li>
<li>Gestandaardiseerd formaat voor alle justitieorganisaties</li>
<li>Bespaar 20% van juridische professional tijd voor hogere waarde werk</li>
<li>Kennisdeling via AI-aangedreven contextintegratie</li>
</ul>

<h2>Acceptatiecriteria</h2>


<h3>SMART Acceptatiecriteria</h3>

<ul>
<li>**Specifiek:** GPT-4 integratie voor juridische definitiegeneratie met context-bewuste prompting</li>
<li>**Meetbaar:**</li>
<li> - Response tijd: < 200ms voor UI acties</li>
<li> - Processing tijd: < 5 seconden voor generatie</li>
<li> - Success rate: > 95% voor validaties</li>
<li> - Token gebruik: < 3000 per definitie</li>
<li> - Geheugengebruik: < 500MB per request</li>
<li>**Acceptabel:** Haalbaar binnen huidige OpenAI API limieten en budget</li>
<li>**Relevant:** Direct gerelateerd aan tijdsbesparing juridische professionals</li>
<li>**Tijdgebonden:** Voltooid in Sprint 1 (2 weken)</li>
</ul>


<h3>Criterium 1: Functionele Definitiegeneratie</h3>
<p><strong>Gegeven</strong> een juridische term "vonnis" met context "strafrecht"</p>
<p><strong>Wanneer</strong> de gebruiker klikt op "Genereer Definitie"</p>
<p><strong>Dan</strong> produceert het systeem een definitie van 100-300 woorden met:</p>
<ul>
<li>Heldere termuitleg in het Nederlands</li>
<li>Juridische contextspecificatie</li>
<li>Onderscheid van gerelateerde termen (bijv. "arrest", "beschikking")</li>
<li>Minimaal één praktisch voorbeeld</li>
</ul>

<h3>Criterium 2: Prestatievereisten</h3>
<p><strong>Gegeven</strong> 100 gelijktijdige definitieverzoeken</p>
<p><strong>Wanneer</strong> het systeem deze verzoeken verwerkt</p>
<p><strong>Dan</strong>:</p>
<ul>
<li>Gemiddelde responstijd < 3 seconden</li>
<li>95e percentiel < 5 seconden</li>
<li>Nul timeout fouten</li>
<li>Geheugengebruik < 500MB per verzoek</li>
</ul>

<h3>Criterium 3: Juridische Taalnauwkeurigheid</h3>
<p><strong>Gegeven</strong> een gegenereerde definitie voor een strafrechtelijke term</p>
<p><strong>Wanneer</strong> geëvalueerd door juridische experts</p>
<p><strong>Dan</strong>:</p>
<ul>
<li>Gebruikt correcte Nederlandse juridische terminologie (95% nauwkeurigheid)</li>
<li>Verwijst naar relevante wetsartikelen waar van toepassing</li>
<li>Behoudt consistentie met bestaande juridische definities in database</li>
<li>Slaagt voor alle ARAI validatieregels (formele correctheid)</li>
</ul>

<h3>Criterium 4: Foutafhandeling</h3>
<p><strong>Gegeven</strong> verschillende faalscenario's</p>
<p><strong>Wanneer</strong> fouten optreden</p>
<p><strong>Dan</strong>:</p>
<ul>
<li>OpenAI API timeout: Probeer 3x opnieuw met exponentiële backoff</li>
<li>Rate limit overschreden: Plaats verzoek in wachtrij en toon geschatte wachttijd</li>
<li>Ongeldige invoer: Toon specifieke validatiefout in het Nederlands</li>
<li>API key ongeldig: Waarschuw beheerder, toon onderhoudsmelding</li>
</ul>

<h2>Technische Implementatie</h2>

<h3>Implementatiebenadering</h3>
<ol>
<li>**Stap 1**: Creëer `UnifiedDefinitionGenerator` klasse in `src/services/definition_generator.py`</li>
<li>**Stap 2**: Integreer met OpenAI API via `AIServiceV2`</li>
<li>**Stap 3**: Implementeer context-bewuste prompt building</li>
<li>**Stap 4**: Voeg caching en rate limiting toe</li>
<li>**Stap 5**: Test met 100+ juridische termen</li>
</ol>

<h2>Traceability Matrix</h2>

<h3>Vereisten Mapping</h3>
<p>| Requirement | Implementatie | Test | Status |</p>
<p>|------------|---------------|------|--------|</p>
<p>| REQ-018: GPT-4 integratie | UnifiedDefinitionGenerator | test_definition_generator.py | ✅ |</p>
<p>| REQ-038: Context prompting | PromptServiceV2 | test_prompt_service.py | ✅ |</p>
<p>| REQ-078: Response < 5s | Prestaties optimalisatie | test_performance.py | ✅ |</p>
<p>| REQ-079: 95% nauwkeurigheid | ValidationOrchestratorV2 | test_validation.py | ✅ |</p>

<h2>ASTRA/NORA Compliance</h2>

<h3>ASTRA Compliance</h3>
<ul>
<li>✅ **Service-oriented**: Gebruikt ServiceContainer pattern</li>
<li>✅ **Configureerbaar**: Alle settings via environment variables</li>
<li>✅ **Schaalbaar**: Stateless service design</li>
</ul>

<h3>NORA Compliance</h3>
<ul>
<li>✅ **NP04 - Standaarden**: OpenAI API, JSON formats</li>
<li>✅ **NP09 - Betrouwbaar**: Error handling, retry logic</li>
<li>✅ **NP10 - Ontkoppeld**: Loose coupling via dependency injection</li>
<li>  - Implement `generate()` method with prompt building</li>
<li>  - Add retry logic with exponential backoff</li>
<li>  - Implement response parsing en validatie</li>
</ul>

<ol>
<li>**Step 2**: Integrate `AIServiceV2` in `src/services/ai_service_v2.py`</li>
</ol>
<ul>
<li>  - Configure OpenAI client with API key from environment</li>
<li>  - Implement `generate_completion()` with timeout hEnling</li>
<li>  - Add token counting en cost tracking</li>
</ul>

<ol>
<li>**Step 3**: Wire services in `src/services/container.py`</li>
</ol>
<ul>
<li>  - Register `UnifiedDefinitionGenerator` as singleton</li>
<li>  - Inject `AIServiceV2` afhankelijkheid</li>
<li>  - Configure with `ConfigManager`</li>
</ul>

<ol>
<li>**Step 4**: Create Streamlit UI in `src/ui/tabs/generator_tab.py`</li>
</ol>
<ul>
<li>  - Add input fields for term en context</li>
<li>  - Implement "Genereer Definitie" Maarton</li>
<li>  - Display results with formatting</li>
</ul>

<h3>Code Locations</h3>
<ul>
<li>Primary files:</li>
<li> - `src/services/definition_generator.py` (main logic)</li>
<li> - `src/services/ai_service_v2.py` (OpenAI integration)</li>
<li> - `src/services/container.py` (afhankelijkheid injection)</li>
<li> - `src/ui/tabs/generator_tab.py` (user interface)</li>
<li>Key functions:</li>
<li> - `UnifiedDefinitionGenerator.generate(term, context, domain)`</li>
<li> - `AIServiceV2.generate_completion(prompt, temperature=0.3)`</li>
<li> - `PromptServiceV2.build_prompt(term, context, examples)`</li>
<li>Config files:</li>
<li> - `config/ai_config.yaml` (model settings)</li>
<li> - `.env` (API keys)</li>
</ul>

<h3>Technical Decisions</h3>
<ul>
<li>Pattern: Service-oriented architecture with afhankelijkheid injection</li>
<li>Model: GPT-4-0125-preview (best Dutch language support)</li>
<li>Temperature: 0.3 (balance between creativity en consistency)</li>
<li>Token limit: 1000 output tokens (sufficient for definitions)</li>
<li>Retry strategy: 3 attempts with 2, 4, 8 second delays</li>
<li>Caching: LRU cache for repeated terms (15-minute TTL)</li>
</ul>

<h2>Domain & compliance</h2>

<h3>Domeinregels</h3>
<ul>
<li>**ASTRA vereiste**: Service components must be loosely coupled via interfaces</li>
<li>**NORA principle**: Externalize configuration (no hardcoded API keys)</li>
<li>**justitieketen integration**:</li>
<li> - OM: strafrecht terminology must align with Openbaar Ministerie (OM) stEnards</li>
<li> - DJI: detentie-related terms must reflect rehabilitation focus</li>
<li> - Rechtspraak: rechtbank terminology must be procedurally accurate</li>
<li> - Justid: All definitions must be linkable via unique identifiers</li>
</ul>

<h3>beveiliging & Privacy</h3>
<ul>
<li>**beveiliging**: API keys stored in environment variables, never in code</li>
<li>**Privacy**: No PII in prompts or definitions (AVG/AVG compliance)</li>
<li>**Audit**: Every generation logged with timestamp, user, term, En result</li>
<li>**Access**: Role-based access control for definition generation</li>
</ul>



<h2>Afhankelijkheden</h2>

<ul>
<li>EPIC-001</li>
</ul>
<h2>Test Scenario's</h2>

<h3>Unit Tests</h3>

<ol>
<li>**Test**: `test_generate_definition_with_valid_input()`</li>
</ol>
<ul>
<li>  - Input: `{"term": "vonnis", "context": "strafrecht", "domain": "OM"}`</li>
<li>  - Expected: Definition object with text 100-300 words</li>
<li>  - Assert: `len(result.text) > 100`, `"straf" in result.text.LAAGer()`</li>
<li>  - File: `tests/services/test_definition_generator.py`</li>
</ul>

<ol>
<li>**Test**: `test_hEnle_openai_timeout()`</li>
</ol>
<ul>
<li>  - Setup: Mock OpenAI to timeout after 2 seconds</li>
<li>  - Action: Call generate() with 5-second timeout</li>
<li>  - Expected: Retry 3 times, dan return graceful error</li>
<li>  - Assert: `retry_count == 3`, `error.type == "timeout"`</li>
</ul>

<ol>
<li>**Test**: `test_prompt_template_substitution()`</li>
</ol>
<ul>
<li>  - Input: Template with `{term}`, `{context}` placeholders</li>
<li>  - Action: Build prompt with actual values</li>
<li>  - Expected: All placeholders replaced correctly</li>
<li>  - Assert: `"{term}" not in prompt`, `"vonnis" in prompt`</li>
</ul>

<h3>Integration Tests</h3>

<ol>
<li>**Test**: `test_end_to_end_generation_flag()`</li>
</ol>
<ul>
<li>  - Setup: Initialize ServiceContainer with real services</li>
<li>  - Action: Generate definition for "voorwaardelijke veroordeling"</li>
<li>  - maatregel: Total time, API calls, token usage</li>
<li>  - Assert: `time < 5s`, `tokens < 2000`, `validation_score > 0.95`</li>
</ul>

<ol>
<li>**Test**: `test_concurrent_generation_load()`</li>
</ol>
<ul>
<li>  - Setup: 10 concurrent requests for different terms</li>
<li>  - Action: Process all simultaneously</li>
<li>  - Assert: All complete < 10s, no race conditions, correct results</li>
</ul>

<h3>Prestaties Tests</h3>

<ol>
<li>**Test**: `test_response_time_under_load()`</li>
</ol>
<ul>
<li>  - Setup: 100 requests over 60 seconds</li>
<li>  - maatregel: Response times, success rate</li>
<li>  - Assert: `p50 < 2s`, `p95 < 5s`, `p99 < 8s`, `success_rate > 99%`</li>
</ul>

<ol>
<li>**Test**: `test_memory_usage_stability()`</li>
</ol>
<ul>
<li>  - Setup: Generate 1000 definitions sequentially</li>
<li>  - maatregel: Memory before/after, peak usage</li>
<li>  - Assert: `memory_leak < 10MB`, `peak < 1GB`</li>
</ul>

<h2>Definitie van Gereed</h2>

<ul>
<li>[x] Code geïmplementeerd folLAAGing ASTRA service patterns</li>
<li>[x] Unit tests written with > 90% coverage</li>
<li>[x] Integration tests passing with real OpenAI API</li>
<li>[x] Prestaties benchmarks met (p95 < 5s)</li>
<li>[x] beveiliging review Voltooid (no API key leaks)</li>
<li>[x] Documentation bijgewerkt (code comments + user guide)</li>
<li>[x] Code review Goedgekeurd by 2 senior developers</li>
<li>[x] Acceptatiecriteria validatied by legal expert</li>
<li>[x] Deployed to test environment for UAT</li>
<li>[x] productie deployment with feature flag</li>
<li>[x] Monitoring dashboard shows 95% success rate</li>
<li>[x] No KRITIEK SonarQube issues</li>
</ul>

<h2>Risks & Mitigation</h2>

<ol>
<li>**Risk**: OpenAI API outage blocks all definition generation</li>
</ol>
<ul>
<li>  - Probability: LAAG (99.9% uptime SLA)</li>
<li>  - Impact: KRITIEK</li>
<li>  - Mitigation: Implement fallback to GPT-3.5, cache recent definitions</li>
</ul>

<ol>
<li>**Risk**: Generated definitions fail legal accuracy vereisten</li>
</ol>
<ul>
<li>  - Probability: GEMIDDELD</li>
<li>  - Impact: HOOG</li>
<li>  - Mitigation: Human-in-the-loop validatie, continuous prompt refinement</li>
</ul>

<ol>
<li>**Risk**: API costs exceed budget at scale</li>
</ol>
<ul>
<li>  - Probability: GEMIDDELD</li>
<li>  - Impact: GEMIDDELD</li>
<li>  - Mitigation: Token optimization, result caching, usage quotas per department</li>
</ul>

<ol>
<li>**Risk**: Response times degrade under heavy load</li>
</ol>
<ul>
<li>  - Probability: LAAG</li>
<li>  - Impact: GEMIDDELD</li>
<li>  - Mitigation: Request queuing, horizontal scaling, CDN for cached results</li>
</ul>

<h2>Notes & References</h2>

<h3>Implementatie Timeline</h3>
<ul>
<li>Design Voltooid: 10-01-2025</li>
<li>Development started: 15-01-2025</li>
<li>First successful generation: 20-01-2025</li>
<li>Integration testing: 25-01-2025</li>
<li>UAT Voltooid: 30-01-2025</li>
<li>productie deployment: 01-02-2025</li>
<li>Prestaties optimization: 04-09-2025 (reduced tokens by 40%)</li>
</ul>

<h3>Metrics Achieved</h3>
<ul>
<li>Average generation time: 2.3 seconds (target: < 5s) ✅</li>
<li>Legal accuracy rate: 96.5% (target: 95%) ✅</li>
<li>User satisfaction: 4.7/5 (target: 4.0) ✅</li>
<li>API cost per definition: €0.03 (target: < €0.05) ✅</li>
<li>System availability: 99.95% (target: 99.9%) ✅</li>
</ul>

<h3>Gerelateerde Documentatie</h3>
<ul>
<li>Design document: `docs/design/gpt4-integration.md`</li>
<li>API documentation: `docs/api/definition-generator.md`</li>
<li>User guide: `docs/user/generating-definitions.md`</li>
<li>Architecture: `docs/architectuur/SOLUTION_ARCHITECTURE.md`</li>
</ul>

<h3>Customer Feedback</h3>
<ul>
<li>"10x faster than our manual process" - OM Amsterdam</li>
<li>"Finally consistent definitions across departments" - DJI</li>
<li>"Game-changer for legal research" - Rechtspraak Utrecht</li>
</ul>

<p>---</p>

<p><em>This story is part of EPIC-001: Basis Definitie Generatie</em></p>

  </div>
</body>
</html>