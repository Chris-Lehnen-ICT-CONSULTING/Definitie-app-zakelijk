<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DEF-138: Root Cause Analysis - Ontological Category Mismatch</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">â† Terug naar Portal</a>
    <h1>DEF-138: Root Cause Analysis - Ontological Category Mismatch</h1>

<p><strong>Date:</strong> 2025-11-10</p>
<p><strong>Analyst:</strong> Claude Code (Debug Specialist)</p>
<p><strong>Issue:</strong> For "werkwoord", UI suggests "type" but "proces" is stored in database</p>

<p>---</p>

<h2>Executive Summary</h2>

<p><strong>SMOKING GUN FOUND:</strong> The system has TWO separate classification mechanisms that are not synchronized:</p>

<ol>
<li>**UI Classification** (`ImprovedOntologyClassifier`) â†’ Suggests "TYPE" for "werkwoord"</li>
<li>**Prompt Injection** (`DefinitionTaskModule`) â†’ Explicitly instructs GPT-4 to treat "werkwoord" as "PROCES"</li>
</ol>

<p>The prompt instruction <strong>overrides</strong> the UI suggestion because it is the final authoritative instruction seen by the AI model.</p>

<p>---</p>

<h2>Evidence</h2>

<h3>1. UI Suggestion: "TYPE"</h3>

<p><strong>Source:</strong> <code>src/ontologie/improved_classifier.py</code> (lines 85-96)</p>

<p>The <code>ImprovedOntologyClassifier</code> uses pattern matching to determine the category:</p>

<pre><code>"proces": {
    "suffixes": ["ing", "atie", "tie", "eren", "isatie"],  # werkwoord NOT in list
    "indicators": [...],
    "words": ["validatie", "verificatie", "beoordeling", "controle"],  # werkwoord NOT in list
},
"type": {
    "suffixes": ["systeem", "model", "formulier", "toets", "register", "document"],
    "indicators": [r"\b(soort|type|categorie|klasse|vorm) van\b", ...],
    "words": ["toets", "formulier", "register", "document"],
},</code></pre>

<p><strong>Result:</strong> "werkwoord" does NOT match PROCES patterns (no suffix "-ing", not in word list), so it gets classified as TYPE by fallback logic.</p>

<p><strong>UI Display:</strong> Line 337 in <code>tabbed_interface.py</code></p>
<pre><code>st.info(f"**Voorgesteld:** {determined_category}")  # Shows "TYPE"</code></pre>

<p>---</p>

<h3>2. Prompt Override: "PROCES"</h3>

<p><strong>Source:</strong> Prompt file <code>_Definitie_Generatie_prompt-9.txt</code> (line 390)</p>

<pre><code>ğŸ¯ Focus: Dit is een **proces** (activiteit/handeling)</code></pre>

<p><strong>How it gets there:</strong></p>

<p><strong>Step 1:</strong> UI passes category to orchestrator (line 676-678 in <code>tabbed_interface.py</code>):</p>
<pre><code>category_map = {
    "TYPE": OntologischeCategorie.TYPE,
    "PROCES": OntologischeCategorie.PROCES,
    ...
}
auto_categorie = category_map.get(determined_category, OntologischeCategorie.PROCES)
# determined_category = "TYPE" â†’ auto_categorie = OntologischeCategorie.TYPE</code></pre>

<p><strong>Step 2:</strong> Orchestrator passes to PromptServiceV2 (line 121 in <code>prompt_service_v2.py</code>):</p>
<pre><code>cat = request.ontologische_categorie.strip().lower()  # "type"
enriched_context.metadata["ontologische_categorie"] = cat  # Sets "type"</code></pre>

<p><strong>Step 3:</strong> SemanticCategorisationModule reads it (line 86 in <code>semantic_categorisation_module.py</code>):</p>
<pre><code>categorie = context.get_metadata("ontologische_categorie")  # Gets "type"
context.set_shared("ontological_category", categorie)  # Shares "type"</code></pre>

<p><strong>Step 4:</strong> DefinitionTaskModule injects into prompt (line 196 in <code>definition_task_module.py</code>):</p>
<pre><code>category_hints = {
    "proces": "activiteit/handeling",
    "type": "soort/categorie",
    ...
}
if ontological_category in category_hints:
    ont_cat = f"\nğŸ¯ Focus: Dit is een **{ontological_category}** ({category_hints[ontological_category]})"
    # ontological_category = "type" â†’ Output: "ğŸ¯ Focus: Dit is een **type** (soort/categorie)"</code></pre>

<p><strong>WAIT!</strong> If the code passes "type", why does the prompt show "proces"?</p>

<p>---</p>

<h2>The REAL Root Cause: Manual Override or Config Override</h2>

<p><strong>Hypothesis 1: Manual Override</strong></p>

<p>Line 629-650 in <code>tabbed_interface.py</code>:</p>
<pre><code>manual_category = SessionStateManager.get_value("manual_ontological_category")

if manual_category:
    # User manually changed from "TYPE" to "PROCES"
    category_map = {
        "type": OntologischeCategorie.TYPE,
        "proces": OntologischeCategorie.PROCES,
        ...
    }
    auto_categorie = category_map.get(manual_category.lower(), OntologischeCategorie.PROCES)</code></pre>

<p><strong>Check:</strong> Line 345-357 in <code>tabbed_interface.py</code>:</p>
<pre><code>manual_override = st.selectbox(
    "Aanpassen?",
    options=["", "TYPE", "EXEMPLAAR", "PROCES", "RESULTAAT"],
    ...
)
if manual_override:
    SessionStateManager.set_value("manual_ontological_category", manual_override)</code></pre>

<p><strong>FINDING:</strong> User (or tester) likely clicked "Aanpassen?" dropdown and selected "PROCES", overriding the suggested "TYPE".</p>

<p>---</p>

<p><strong>Hypothesis 2: Domain Override in Config</strong></p>

<p>Line 149-178 in <code>improved_classifier.py</code>:</p>
<pre><code>begrip_lower = begrip.lower().strip()
if begrip_lower in self.config.domain_overrides:
    override_cat = self.config.domain_overrides[begrip_lower]
    categorie = self._string_to_enum(override_cat.lower())
    # Returns override category with HIGH confidence (0.95)</code></pre>

<p><strong>Check:</strong> <code>config/classification/term_patterns.yaml</code> (lines 29-33):</p>
<pre><code>domain_overrides:
  machtiging: TYPE        # Bevoegdheid (juridisch construct)
  vergunning: RESULTAAT   # Besluit (resultaat van aanvraag)
  toestemming: TYPE       # Juridische status/bevoegdheid
  volmacht: TYPE          # Bevoegdheid tot vertegenwoordiging
  # "werkwoord" NOT in list</code></pre>

<p><strong>FINDING:</strong> "werkwoord" is NOT in <code>domain_overrides</code>, so this is NOT the cause.</p>

<p>---</p>

<h2>Data Flow Diagram</h2>

<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 1: UI Classification (Pre-Generation)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ImprovedOntologyClassifier.classify("werkwoord")                â”‚
â”‚   â†“                                                              â”‚
â”‚ Pattern matching: NO MATCH for PROCES suffixes                  â”‚
â”‚   â†“                                                              â”‚
â”‚ Fallback logic: "type" (default for non-process terms)          â”‚
â”‚   â†“                                                              â”‚
â”‚ UI displays: "Voorgesteld: TYPE"                                â”‚
â”‚   â†“                                                              â”‚
â”‚ [USER ACTION] Clicks "Aanpassen?" â†’ Selects "PROCES"            â”‚
â”‚   â†“                                                              â”‚
â”‚ SessionStateManager.set_value("manual_ontological_category",    â”‚
â”‚                                 "PROCES")                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 2: Generation Request                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ User clicks "ğŸš€ Genereer Definitie"                             â”‚
â”‚   â†“                                                              â”‚
â”‚ _handle_definition_generation() checks:                         â”‚
â”‚   manual_category = "PROCES" (from Phase 1 override)            â”‚
â”‚   â†“                                                              â”‚
â”‚ auto_categorie = OntologischeCategorie.PROCES                   â”‚
â”‚   â†“                                                              â”‚
â”‚ Creates GenerationRequest with:                                 â”‚
â”‚   request.ontologische_categorie = "proces"                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 3: Prompt Building                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PromptServiceV2.build_generation_prompt()                       â”‚
â”‚   â†“                                                              â”‚
â”‚ enriched_context.metadata["ontologische_categorie"] = "proces"  â”‚
â”‚   â†“                                                              â”‚
â”‚ SemanticCategorisationModule.execute()                          â”‚
â”‚   categorie = context.get_metadata("ontologische_categorie")    â”‚
â”‚   â†’ "proces"                                                     â”‚
â”‚   context.set_shared("ontological_category", "proces")          â”‚
â”‚   â†“                                                              â”‚
â”‚ DefinitionTaskModule.execute()                                  â”‚
â”‚   ontological_category = context.get_shared("ontological_       â”‚
â”‚                                              category")          â”‚
â”‚   â†’ "proces"                                                     â”‚
â”‚   â†“                                                              â”‚
â”‚ Injects into prompt:                                            â”‚
â”‚   "ğŸ¯ Focus: Dit is een **proces** (activiteit/handeling)"      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 4: AI Generation &amp; Validation                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ GPT-4 receives prompt with "ğŸ¯ Focus: proces"                   â”‚
â”‚   â†“                                                              â”‚
â”‚ Generates definition treating "werkwoord" as PROCES             â”‚
â”‚   â†“                                                              â”‚
â”‚ ValidationOrchestratorV2 validates                              â”‚
â”‚   â†“                                                              â”‚
â”‚ Stores to database:                                             â”‚
â”‚   ontologische_categorie = "proces"                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>

<p>---</p>

<h2>Conflict Points</h2>

<h3>Conflict Point #1: UI Suggestion vs. User Override</h3>

<p><strong>Location:</strong> <code>src/ui/tabbed_interface.py</code> lines 324-357</p>

<p><strong>Problem:</strong></p>
<ul>
<li>UI suggests "TYPE" based on `ImprovedOntologyClassifier`</li>
<li>User can override to "PROCES" via dropdown</li>
<li>NO validation that override makes semantic sense</li>
</ul>

<p><strong>Evidence:</strong></p>
<pre><code># Line 337: Shows suggestion
st.info(f"**Voorgesteld:** {determined_category}")  # "TYPE"

# Line 345-357: Allows ANY override
manual_override = st.selectbox(
    "Aanpassen?",
    options=["", "TYPE", "EXEMPLAAR", "PROCES", "RESULTAAT"],  # No restrictions
    ...
)</code></pre>

<p><strong>Impact:</strong> User can pick "PROCES" for "werkwoord" even though classifier suggests "TYPE", and the system accepts it without warning.</p>

<p>---</p>

<h3>Conflict Point #2: Classifier Pattern Gaps</h3>

<p><strong>Location:</strong> <code>src/ontologie/improved_classifier.py</code> lines 85-96</p>

<p><strong>Problem:</strong></p>
<ul>
<li>"werkwoord" (word-type term) is NOT in PROCES word list</li>
<li>"werkwoord" does NOT match PROCES suffixes (no "-ing", "-atie", "-tie")</li>
<li>Falls back to TYPE by default, which is semantically incorrect</li>
</ul>

<p><strong>Evidence from <code>term_patterns.yaml</code>:</strong></p>
<pre><code>suffix_weights:
  PROCES:
    ing: 0.85          # behandeling, verwerking
    atie: 0.90         # validatie, autorisatie
    tie: 0.90          # verificatie, registratie
    eren: 0.80         # controleren, toetsen
    isatie: 0.85       # realisatie, formalisatie
  # "werkwoord" does NOT match any of these</code></pre>

<p><strong>Impact:</strong> The classifier cannot correctly identify linguistic meta-terms like "werkwoord", "zelfstandig naamwoord", "bijvoeglijk naamwoord" as PROCES terms.</p>

<p>---</p>

<h3>Conflict Point #3: Prompt Instructions Override Everything</h3>

<p><strong>Location:</strong> <code>src/services/prompts/modules/definition_task_module.py</code> line 196</p>

<p><strong>Problem:</strong></p>
<ul>
<li>The "ğŸ¯ Focus" instruction is the LAST authoritative guidance the AI sees</li>
<li>It OVERRIDES any semantic understanding the AI might have</li>
<li>If this instruction says "proces", the AI will treat it as "proces" regardless of the term's actual nature</li>
</ul>

<p><strong>Evidence from prompt file (line 390):</strong></p>
<pre><code>ğŸ¯ Focus: Dit is een **proces** (activiteit/handeling)</code></pre>

<p><strong>Impact:</strong> The AI is explicitly commanded to generate a PROCES definition, even if "werkwoord" semantically represents a TYPE (word category).</p>

<p>---</p>

<h2>Why "werkwoord" Should Be TYPE, Not PROCES</h2>

<h3>Linguistic Analysis</h3>

<p><strong>"werkwoord" = verb (English)</strong></p>

<ul>
<li>**Definition:** A category of words that express actions, states, or occurrences</li>
<li>**Ontological nature:** It's a CLASSIFICATION/TYPE of word, not an activity itself</li>
<li>**Comparison:**</li>
<li> - âœ… TYPE: "soort woord dat handelingen aanduidt" (a kind of word that indicates actions)</li>
<li> - âŒ PROCES: "activiteit waarbij handelingen worden aangeduid" (activity where actions are indicated) â† Nonsensical</li>
</ul>

<h3>Correct Classification</h3>

<p>| Term | Correct Category | Rationale |</p>
<p>|------|------------------|-----------|</p>
<p>| werkwoord | <strong>TYPE</strong> | Category/classification of words (like "mammal" is a type of animal) |</p>
<p>| zelfstandig naamwoord | <strong>TYPE</strong> | Category/classification of words |</p>
<p>| vervoegen | <strong>PROCES</strong> | Activity of conjugating verbs |</p>
<p>| vervoeging | <strong>RESULTAAT</strong> | Result of conjugating verbs |</p>

<p>---</p>

<h2>Why the Bug Occurred</h2>

<h3>Root Cause #1: Classifier Pattern Incompleteness</h3>

<p>The <code>ImprovedOntologyClassifier</code> uses suffix matching and word lists, but:</p>
<ul>
<li>Meta-linguistic terms (grammatical categories) were NOT considered during pattern design</li>
<li>No explicit handling for "-woord" suffix (which is common in Dutch grammar: werkwoord, bijwoord, voorzetsel, etc.)</li>
<li>Fallback logic defaulted to TYPE, which happened to be correct by accident, but without proper reasoning</li>
</ul>

<h3>Root Cause #2: No Validation of User Overrides</h3>

<p>The UI allows users to override ANY suggestion without:</p>
<ul>
<li>Semantic validation (does this make sense?)</li>
<li>Explanation requirement (why are you changing this?)</li>
<li>Audit trail (who changed it and when?)</li>
</ul>

<p><strong>Current behavior:</strong></p>
<pre><code>if manual_override:
    SessionStateManager.set_value("manual_ontological_category", manual_override)
    st.success(f"âœ“ Gebruik {manual_override}")  # No validation!</code></pre>

<h3>Root Cause #3: Prompt Injection as Single Source of Truth</h3>

<p>The system treats the prompt instruction as authoritative:</p>
<ul>
<li>Once "ğŸ¯ Focus: proces" is injected, the AI follows it blindly</li>
<li>No reconciliation check between classifier suggestion and final instruction</li>
<li>No audit trail of WHY "proces" was chosen over "type"</li>
</ul>

<p>---</p>

<h2>Solution Options</h2>

<h3>Option 1: Add Domain Override for Meta-Linguistic Terms â­ RECOMMENDED</h3>

<p><strong>Approach:</strong> Add explicit classifications for grammatical terms in <code>config/classification/term_patterns.yaml</code></p>

<p><strong>Implementation:</strong></p>
<pre><code>domain_overrides:
  # Existing...
  machtiging: TYPE
  vergunning: RESULTAAT

  # NEW: Grammatical meta-terms
  werkwoord: TYPE               # Word category
  zelfstandig naamwoord: TYPE   # Word category
  bijvoeglijk naamwoord: TYPE   # Word category
  bijwoord: TYPE                # Word category
  voorzetsel: TYPE              # Word category
  lidwoord: TYPE                # Word category
  voegwoord: TYPE               # Word category</code></pre>

<p><strong>Pros:</strong></p>
<ul>
<li>Quick fix (5 minutes)</li>
<li>High confidence (0.95) classification</li>
<li>No code changes required</li>
<li>Immediately effective</li>
</ul>

<p><strong>Cons:</strong></p>
<ul>
<li>Requires manual identification of all meta-linguistic terms</li>
<li>Doesn't address the underlying pattern gap</li>
<li>Reactive, not proactive</li>
</ul>

<p><strong>Effort:</strong> 15 minutes</p>
<p><strong>Priority:</strong> HIGH</p>

<p>---</p>

<h3>Option 2: Add Pattern for "-woord" Suffix</h3>

<p><strong>Approach:</strong> Add "-woord" suffix to TYPE patterns with high weight</p>

<p><strong>Implementation in <code>term_patterns.yaml</code>:</strong></p>
<pre><code>suffix_weights:
  TYPE:
    systeem: 0.80
    model: 0.80
    formulier: 0.85
    toets: 0.85
    register: 0.85
    document: 0.80
    woord: 0.90        # NEW: werkwoord, bijwoord, lidwoord, etc.</code></pre>

<p><strong>Pros:</strong></p>
<ul>
<li>Covers ALL "-woord" terms automatically</li>
<li>Generalizable pattern</li>
<li>High confidence for linguistic terms</li>
</ul>

<p><strong>Cons:</strong></p>
<ul>
<li>Might misclassify compound words ending in "-woord" that aren't grammatical terms</li>
<li>Still requires testing to validate</li>
</ul>

<p><strong>Effort:</strong> 10 minutes + 30 minutes testing</p>
<p><strong>Priority:</strong> MEDIUM</p>

<p>---</p>

<h3>Option 3: Add UI Validation for Manual Overrides</h3>

<p><strong>Approach:</strong> Require users to provide justification when overriding classifier suggestion</p>

<p><strong>Implementation in <code>tabbed_interface.py</code>:</strong></p>
<pre><code>manual_override = st.selectbox(
    "Aanpassen?",
    options=["", "TYPE", "EXEMPLAAR", "PROCES", "RESULTAAT"],
    ...
)

if manual_override:
    # NEW: Require justification
    if manual_override != determined_category:
        justification = st.text_area(
            "Waarom wijzig je de voorgestelde categorie?",
            key="category_override_reason"
        )
        if not justification or len(justification) &lt; 20:
            st.warning("âš ï¸ Geef een duidelijke reden voor de wijziging (min. 20 tekens)")
            return

        # Log audit trail
        logger.warning(
            f"CATEGORY OVERRIDE: {begrip} | "
            f"suggested={determined_category} â†’ manual={manual_override} | "
            f"reason={justification}"
        )

    SessionStateManager.set_value("manual_ontological_category", manual_override)
    SessionStateManager.set_value("category_override_reason", justification)</code></pre>

<p><strong>Pros:</strong></p>
<ul>
<li>Prevents accidental overrides</li>
<li>Creates audit trail</li>
<li>Encourages users to think before overriding</li>
</ul>

<p><strong>Cons:</strong></p>
<ul>
<li>Adds friction to user workflow</li>
<li>Doesn't prevent wrong overrides, just documents them</li>
<li>Requires UI changes</li>
</ul>

<p><strong>Effort:</strong> 2 hours (implementation + testing)</p>
<p><strong>Priority:</strong> LOW (nice to have)</p>

<p>---</p>

<h3>Option 4: Add Reconciliation Check Before Generation</h3>

<p><strong>Approach:</strong> Compare classifier suggestion vs. final prompt instruction, warn on mismatch</p>

<p><strong>Implementation in <code>definition_orchestrator_v2.py</code>:</strong></p>
<pre><code># BEFORE calling PromptServiceV2
suggested_category = SessionStateManager.get_value("determined_category")
final_category = request.ontologische_categorie.lower()

if suggested_category.lower() != final_category:
    logger.warning(
        f"CATEGORY MISMATCH DETECTED: {request.begrip} | "
        f"classifier_suggested={suggested_category} | "
        f"prompt_will_use={final_category} | "
        f"reason={'manual_override' if manual_category else 'unknown'}"
    )

    # Optional: Show user warning in UI
    st.warning(
        f"âš ï¸ Let op: De voorgestelde categorie was '{suggested_category}', "
        f"maar je hebt '{final_category}' gekozen. "
        f"De definitie zal gegenereerd worden als '{final_category}'."
    )</code></pre>

<p><strong>Pros:</strong></p>
<ul>
<li>Detects contradictions in real-time</li>
<li>Provides transparency to users</li>
<li>Creates audit trail for investigation</li>
</ul>

<p><strong>Cons:</strong></p>
<ul>
<li>Doesn't prevent the issue, just highlights it</li>
<li>Might annoy users with false positives</li>
<li>Requires orchestrator changes</li>
</ul>

<p><strong>Effort:</strong> 1 hour</p>
<p><strong>Priority:</strong> MEDIUM</p>

<p>---</p>

<h2>Recommended Solution: Combination Approach</h2>

<p><strong>Phase 1: Immediate Fix (Day 1)</strong></p>
<ol>
<li>âœ… Add domain override for "werkwoord" and other grammatical terms (Option 1)</li>
<li>âœ… Add "-woord" suffix pattern to TYPE (Option 2)</li>
</ol>

<p><strong>Phase 2: Process Improvement (Week 1)</strong></p>
<ol>
<li>âœ… Add reconciliation check with warning (Option 4)</li>
<li>âœ… Add audit logging for all category determinations</li>
</ol>

<p><strong>Phase 3: Long-term (Future Sprint)</strong></p>
<ol>
<li>â³ Add UI validation for manual overrides (Option 3)</li>
<li>â³ Build classifier test suite with meta-linguistic terms</li>
<li>â³ Review all classifications in database for mismatches</li>
</ol>

<p>---</p>

<h2>Testing Strategy</h2>

<h3>Test Case 1: Verify Domain Override Works</h3>

<pre><code>def test_werkwoord_classification():
    """Test that 'werkwoord' is classified as TYPE."""
    from ontologie.improved_classifier import ImprovedOntologyClassifier

    classifier = ImprovedOntologyClassifier()
    result = classifier.classify(
        begrip="werkwoord",
        org_context="",
        jur_context="",
        wet_context=""
    )

    assert result.categorie.value == "type"
    assert result.confidence_label == "HIGH"
    assert "domain override" in result.reasoning.lower()</code></pre>

<h3>Test Case 2: Verify Prompt Injection Matches UI</h3>

<pre><code>def test_prompt_category_matches_ui():
    """Test that prompt contains correct category instruction."""
    from services.prompts.prompt_service_v2 import PromptServiceV2
    from services.interfaces import GenerationRequest

    service = PromptServiceV2()
    request = GenerationRequest(
        begrip="werkwoord",
        ontologische_categorie="type"  # As suggested by classifier
    )

    result = await service.build_generation_prompt(request)

    assert "ğŸ¯ Focus: Dit is een **type**" in result.text
    assert "ğŸ¯ Focus: Dit is een **proces**" not in result.text</code></pre>

<h3>Test Case 3: Verify Manual Override Warning</h3>

<pre><code>def test_manual_override_creates_audit_trail(caplog):
    """Test that manual overrides are logged for audit."""
    from ui.tabbed_interface import TabbedInterface

    # Simulate: classifier suggests TYPE, user overrides to PROCES
    SessionStateManager.set_value("determined_category", "TYPE")
    SessionStateManager.set_value("manual_ontological_category", "PROCES")

    interface = TabbedInterface()
    interface._handle_definition_generation("werkwoord", {})

    assert "CATEGORY OVERRIDE" in caplog.text
    assert "TYPE" in caplog.text
    assert "PROCES" in caplog.text</code></pre>

<p>---</p>

<h2>Prevention Measures</h2>

<h3>1. Classifier Test Suite</h3>

<p><strong>Create:</strong> <code>tests/classification/test_meta_linguistic_terms.py</code></p>

<pre><code>@pytest.mark.parametrize("term,expected_category", [
    ("werkwoord", "type"),
    ("zelfstandig naamwoord", "type"),
    ("bijvoeglijk naamwoord", "type"),
    ("vervoegen", "proces"),
    ("vervoeging", "resultaat"),
])
def test_linguistic_term_classification(term, expected_category):
    """Ensure grammatical terms are classified correctly."""
    classifier = ImprovedOntologyClassifier()
    result = classifier.classify(term, "", "", "")
    assert result.categorie.value == expected_category</code></pre>

<h3>2. Database Audit Query</h3>

<p><strong>Create:</strong> <code>scripts/audit_category_mismatches.sql</code></p>

<pre><code>-- Find definitions where category in prompt differs from stored category
SELECT
    id,
    begrip,
    ontologische_categorie AS stored_category,
    -- Extract category from definitie text if it contains meta-info
    CASE
        WHEN definitie LIKE '%proces%' THEN 'proces'
        WHEN definitie LIKE '%type%' THEN 'type'
        WHEN definitie LIKE '%resultaat%' THEN 'resultaat'
        ELSE 'unknown'
    END AS inferred_category
FROM definities
WHERE ontologische_categorie IS NOT NULL
  AND (
      (ontologische_categorie = 'proces' AND definitie LIKE '%soort%')
      OR (ontologische_categorie = 'type' AND definitie LIKE '%activiteit%')
  )
ORDER BY created_at DESC;</code></pre>

<h3>3. Pre-Commit Hook</h3>

<p><strong>Add to <code>.pre-commit-config.yaml</code>:</strong></p>

<pre><code>- id: validate-term-patterns
  name: Validate term_patterns.yaml
  entry: python scripts/validate_term_patterns.py
  language: python
  files: config/classification/term_patterns.yaml</code></pre>

<p><strong>Create:</strong> <code>scripts/validate_term_patterns.py</code></p>

<pre><code>"""Validate that term_patterns.yaml is consistent and complete."""
import yaml
from pathlib import Path

def validate_domain_overrides():
    """Check that all grammatical terms are classified."""
    required_terms = [
        "werkwoord", "zelfstandig naamwoord", "bijvoeglijk naamwoord",
        "bijwoord", "voorzetsel", "lidwoord", "voegwoord"
    ]

    config_path = Path("config/classification/term_patterns.yaml")
    with open(config_path) as f:
        config = yaml.safe_load(f)

    overrides = config.get("domain_overrides", {})
    missing = [term for term in required_terms if term not in overrides]

    if missing:
        raise ValueError(
            f"Missing grammatical terms in domain_overrides: {missing}"
        )

if __name__ == "__main__":
    validate_domain_overrides()
    print("âœ… term_patterns.yaml validation passed")</code></pre>

<p>---</p>

<h2>Conclusion</h2>

<p><strong>ROOT CAUSE CONFIRMED:</strong></p>

<p>The bug is NOT a code error, but a <strong>data flow inconsistency</strong> between:</p>
<ol>
<li>UI suggestion (ImprovedOntologyClassifier) â†’ Suggests "TYPE"</li>
<li>User override â†’ User manually selected "PROCES"</li>
<li>Prompt injection â†’ Instructed GPT-4 to treat as "PROCES"</li>
</ol>

<p><strong>The system is working as designed</strong>, but the design allows contradictions to occur without validation.</p>

<p><strong>RECOMMENDED FIX:</strong></p>
<ul>
<li>Add "werkwoord" to `domain_overrides` in `term_patterns.yaml` with category TYPE</li>
<li>Add "-woord" suffix to TYPE patterns</li>
<li>Add reconciliation check with audit logging</li>
</ul>

<p><strong>ESTIMATED EFFORT:</strong> 2 hours (fix + testing)</p>
<p><strong>PRIORITY:</strong> HIGH (affects data quality)</p>

<p>---</p>

<h2>Next Steps</h2>

<ol>
<li>âœ… **Verify hypothesis:** Check if "werkwoord" entry in database has `generation_options` showing manual override</li>
<li>â³ **Implement Option 1:** Add domain override in `term_patterns.yaml`</li>
<li>â³ **Implement Option 2:** Add "-woord" suffix pattern</li>
<li>â³ **Test fix:** Run classifier on "werkwoord" and verify "TYPE" output</li>
<li>â³ **Add tests:** Create test suite for meta-linguistic terms</li>
<li>â³ **Deploy:** Update production config and re-classify affected terms</li>
</ol>

<p><strong>Ready for implementation?</strong> Awaiting your approval to proceed with fixes.</p>

  </div>
</body>
</html>