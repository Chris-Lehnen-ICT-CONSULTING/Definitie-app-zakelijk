<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DEF-138: Category Mismatch Debugging Playbook</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">‚Üê Terug naar Portal</a>
    <h1>DEF-138: Category Mismatch Debugging Playbook</h1>

<p><strong>Purpose:</strong> Quick reference for investigating ontological category discrepancies</p>

<p>---</p>

<h2>Symptom: "UI shows X, database has Y"</h2>

<h3>Quick Diagnostic Steps</h3>

<ol>
<li>**Check the prompt file** (user-provided or extracted from logs)</li>
<pre><code>   grep "üéØ Focus" prompt_file.txt
   # Look for: "üéØ Focus: Dit is een **[category]**"</code></pre>
</ol>

<ol>
<li>**Check the classifier output**</li>
<pre><code>   from ontologie.improved_classifier import ImprovedOntologyClassifier
   classifier = ImprovedOntologyClassifier()
   result = classifier.classify("term", "", "", "")
   print(f"Suggested: {result.categorie.value}")
   print(f"Confidence: {result.confidence_label}")</code></pre>
</ol>

<ol>
<li>**Check for manual override in session**</li>
<pre><code>   # In UI logs, search for:
   grep "manual_ontological_category" logs/streamlit.log
   grep "CATEGORY OVERRIDE" logs/app.log</code></pre>
</ol>

<ol>
<li>**Check database entry**</li>
<pre><code>   SELECT begrip, ontologische_categorie, created_by, created_at
   FROM definities
   WHERE begrip = 'term'
   ORDER BY created_at DESC
   LIMIT 1;</code></pre>
</ol>

<p>---</p>

<h2>Root Cause Checklist</h2>

<h3>‚úÖ Was there a manual override?</h3>

<p><strong>Check:</strong> Session state logs for <code>manual_ontological_category</code></p>

<p><strong>File:</strong> <code>src/ui/tabbed_interface.py</code> line 629-650</p>

<p><strong>Evidence:</strong></p>
<pre><code>manual_category = SessionStateManager.get_value("manual_ontological_category")
if manual_category:
    # User manually changed category</code></pre>

<p><strong>Fix:</strong> Add validation to require justification for overrides</p>

<p>---</p>

<h3>‚úÖ Does the term match PROCES patterns?</h3>

<p><strong>Check:</strong> Classifier pattern matching logic</p>

<p><strong>File:</strong> <code>src/ontologie/improved_classifier.py</code> line 220-251</p>

<p><strong>Patterns:</strong></p>
<ul>
<li>Suffixes: `-ing`, `-atie`, `-tie`, `-eren`, `-isatie`</li>
<li>Words: `validatie`, `verificatie`, `beoordeling`, `controle`</li>
</ul>

<p><strong>Fix:</strong> Add missing patterns to <code>config/classification/term_patterns.yaml</code></p>

<p>---</p>

<h3>‚úÖ Is there a domain override?</h3>

<p><strong>Check:</strong> <code>config/classification/term_patterns.yaml</code> line 29-33</p>

<p><strong>Evidence:</strong></p>
<pre><code>domain_overrides:
  term: CATEGORY  # Explicit classification</code></pre>

<p><strong>Fix:</strong> Add term to <code>domain_overrides</code> if it's ambiguous</p>

<p>---</p>

<h3>‚úÖ Is the prompt instruction correct?</h3>

<p><strong>Check:</strong> Prompt file or logs for "üéØ Focus" line</p>

<p><strong>File:</strong> <code>src/services/prompts/modules/definition_task_module.py</code> line 196</p>

<p><strong>Evidence:</strong></p>
<pre><code>ont_cat = f"\nüéØ Focus: Dit is een **{ontological_category}** ..."</code></pre>

<p><strong>Fix:</strong> Ensure <code>ontological_category</code> matches classifier output</p>

<p>---</p>

<h3>‚úÖ Is the AI following instructions?</h3>

<p><strong>Check:</strong> Generated definition text for category clues</p>

<p><strong>Clues:</strong></p>
<ul>
<li>PROCES: "activiteit waarbij...", "handeling die...", "proces waarin..."</li>
<li>TYPE: "soort...", "categorie van...", "type... dat..."</li>
<li>RESULTAAT: "resultaat van...", "uitkomst van...", "product dat..."</li>
</ul>

<p><strong>Fix:</strong> If AI deviates, check ESS-02 guidance in <code>semantic_categorisation_module.py</code></p>

<p>---</p>

<h2>Common Causes (Priority Order)</h2>

<h3>1. User Manual Override (60% of cases)</h3>

<p><strong>Symptom:</strong> Classifier says TYPE, database has PROCES, user clicked dropdown</p>

<p><strong>Evidence:</strong></p>
<pre><code>grep "manual_category_override" logs/app.log
# Look for: "Gebruik handmatige categorie override: PROCES"</code></pre>

<p><strong>Solution:</strong></p>
<ul>
<li>Add justification requirement for overrides</li>
<li>Log all overrides with username and timestamp</li>
<li>Add UI warning: "You're overriding the AI suggestion, are you sure?"</li>
</ul>

<p>---</p>

<h3>2. Missing Classifier Patterns (30% of cases)</h3>

<p><strong>Symptom:</strong> Term doesn't match any patterns, falls back to default</p>

<p><strong>Evidence:</strong></p>
<pre><code># Term ends with unknown suffix
# Term not in any word list
# Context provides no clues
# Falls back to PROCES (most common category)</code></pre>

<p><strong>Solution:</strong></p>
<ul>
<li>Add term to `domain_overrides` in `term_patterns.yaml`</li>
<li>Add suffix pattern with appropriate weight</li>
<li>Add context indicators to pattern matching</li>
</ul>

<p>---</p>

<h3>3. Ambiguous Terms (10% of cases)</h3>

<p><strong>Symptom:</strong> Multiple categories are equally valid (scores within 0.15)</p>

<p><strong>Evidence:</strong></p>
<pre><code>result.confidence_label == "LOW"  # &lt; 0.45 confidence
result.all_scores  # Multiple scores close together</code></pre>

<p><strong>Solution:</strong></p>
<ul>
<li>Use priority cascade (EXEMPLAAR > TYPE > RESULTAAT > PROCES)</li>
<li>Add domain override for disambiguation</li>
<li>Require manual review for LOW confidence classifications</li>
</ul>

<p>---</p>

<h2>Investigation Template</h2>

<p>Use this template when investigating a mismatch:</p>

<pre><code>## Category Mismatch Report

**Term:** [werkwoord]
**UI Suggested:** [TYPE]
**Database Stored:** [PROCES]
**Reporter:** [User name]
**Date:** [2025-11-10]

### Step 1: Classifier Output</code></pre>
<p>python -c "</p>
<p>from ontologie.improved_classifier import ImprovedOntologyClassifier</p>
<p>classifier = ImprovedOntologyClassifier()</p>
<p>result = classifier.classify('[term]', '', '', '')</p>
<p>print(f'Category: {result.categorie.value}')</p>
<p>print(f'Confidence: {result.confidence_label}')</p>
<p>print(f'Reasoning: {result.reasoning}')</p>
<p>"</p>
<pre><code>
**Result:**
- Category: [TYPE]
- Confidence: [MEDIUM]
- Reasoning: [Falls back to default, no patterns match]

### Step 2: Prompt Inspection</code></pre>
<p>grep "üéØ Focus" prompt_file.txt</p>
<pre><code>
**Result:**</code></pre>
<p>üéØ Focus: Dit is een <strong>proces</strong> (activiteit/handeling)</p>
<pre><code>
**Mismatch detected:** Classifier says TYPE, prompt says PROCES

### Step 3: Session State Check</code></pre>
<p>grep "manual_ontological_category" logs/streamlit.log</p>
<pre><code>
**Result:**</code></pre>
<p>2025-11-10 14:23:15 | manual_ontological_category = "PROCES"</p>
<pre><code>
**Root Cause:** User manually overrode TYPE ‚Üí PROCES

### Step 4: Proposed Fix
- [ ] Add "term" to `domain_overrides` as TYPE
- [ ] Add pattern to prevent future misclassification
- [ ] Update database entry if needed
- [ ] Test with new configuration

### Step 5: Prevention
- [ ] Add override validation
- [ ] Create test case for this term
- [ ] Document in classifier patterns</code></pre>

<p>---</p>

<h2>Quick Fixes Reference</h2>

<h3>Fix 1: Add Domain Override</h3>

<p><strong>File:</strong> <code>config/classification/term_patterns.yaml</code></p>

<pre><code>domain_overrides:
  term: TYPE  # or PROCES, RESULTAAT, EXEMPLAAR</code></pre>

<p><strong>Test:</strong></p>
<pre><code>python -c "
from ontologie.improved_classifier import ImprovedOntologyClassifier
from services.classification.term_config import reset_config_cache
reset_config_cache()  # Force reload
classifier = ImprovedOntologyClassifier()
result = classifier.classify('term', '', '', '')
assert result.categorie.value == 'type'
assert result.confidence_label == 'HIGH'
print('‚úÖ Override works')
"</code></pre>

<p>---</p>

<h3>Fix 2: Add Suffix Pattern</h3>

<p><strong>File:</strong> <code>config/classification/term_patterns.yaml</code></p>

<pre><code>suffix_weights:
  TYPE:  # or PROCES, RESULTAAT
    suffix: 0.90  # weight 0.0-1.0</code></pre>

<p><strong>Test:</strong></p>
<pre><code># Test all terms ending with suffix
python scripts/test_suffix_pattern.py --suffix "woord" --expected TYPE</code></pre>

<p>---</p>

<h3>Fix 3: Add Context Indicator</h3>

<p><strong>File:</strong> <code>src/ontologie/improved_classifier.py</code> (requires code change)</p>

<pre><code># In _generate_scores(), add new indicator
if re.search(r"\b(new_indicator_pattern)\b", combined_context):
    scores["type"] += 0.2</code></pre>

<p><strong>Test:</strong></p>
<pre><code>pytest tests/classification/test_context_indicators.py -k new_indicator</code></pre>

<p>---</p>

<h2>Audit Queries</h2>

<h3>Find All Mismatches</h3>

<pre><code>-- Find entries where category doesn't match semantic hints in definition
SELECT
    id,
    begrip,
    ontologische_categorie AS stored,
    CASE
        WHEN definitie LIKE '%soort %' OR definitie LIKE '%categorie %' THEN 'type'
        WHEN definitie LIKE '%activiteit %' OR definitie LIKE '%handeling %' THEN 'proces'
        WHEN definitie LIKE '%resultaat %' OR definitie LIKE '%uitkomst %' THEN 'resultaat'
        ELSE 'unclear'
    END AS inferred,
    created_by,
    created_at
FROM definities
WHERE ontologische_categorie IS NOT NULL
  AND ontologische_categorie != CASE
        WHEN definitie LIKE '%soort %' THEN 'type'
        WHEN definitie LIKE '%activiteit %' THEN 'proces'
        WHEN definitie LIKE '%resultaat %' THEN 'resultaat'
        ELSE ontologische_categorie
    END
ORDER BY created_at DESC;</code></pre>

<h3>Find Manual Overrides (if logged)</h3>

<pre><code>grep "CATEGORY OVERRIDE" logs/app.log | \
  awk -F'|' '{print $2, $3, $4}' | \
  sort | uniq -c | sort -rn
# Shows: count | term | suggested‚Üímanual | reason</code></pre>

<p>---</p>

<h2>Related Files</h2>

<p><strong>Classification Logic:</strong></p>
<ul>
<li>`src/ontologie/improved_classifier.py` - Main classifier</li>
<li>`config/classification/term_patterns.yaml` - Pattern configuration</li>
<li>`src/services/classification/term_config.py` - Config loader</li>
</ul>

<p><strong>Prompt Building:</strong></p>
<ul>
<li>`src/services/prompts/prompt_service_v2.py` - Prompt orchestration</li>
<li>`src/services/prompts/modules/semantic_categorisation_module.py` - ESS-02 guidance</li>
<li>`src/services/prompts/modules/definition_task_module.py` - "üéØ Focus" injection</li>
</ul>

<p><strong>UI Flow:</strong></p>
<ul>
<li>`src/ui/tabbed_interface.py` - Category selection UI</li>
<li>`src/ui/session_state.py` - Session state management</li>
</ul>

<p><strong>Database:</strong></p>
<ul>
<li>`src/repositories/definition_repository.py` - Storage logic</li>
<li>`data/definities.db` - SQLite database</li>
</ul>

<p>---</p>

<h2>Prevention Checklist</h2>

<ul>
<li>[ ] All grammatical terms have `domain_overrides`</li>
<li>[ ] All common suffixes have pattern weights</li>
<li>[ ] Manual overrides require justification</li>
<li>[ ] Audit logs track all category decisions</li>
<li>[ ] Test suite covers ambiguous terms</li>
<li>[ ] Pre-commit hook validates patterns</li>
<li>[ ] Documentation includes edge cases</li>
</ul>

<p>---</p>

<p><strong>Last Updated:</strong> 2025-11-10</p>
<p><strong>Maintainer:</strong> Debug Specialist Team</p>
<p><strong>Version:</strong> 1.0</p>

  </div>
</body>
</html>