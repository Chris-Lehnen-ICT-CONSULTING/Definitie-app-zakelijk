<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DEF-138: Investigation Summary - Category Mismatch Bug</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">â† Terug naar Portal</a>
    <h1>DEF-138: Investigation Summary - Category Mismatch Bug</h1>

<p><strong>Date:</strong> 2025-11-10</p>
<p><strong>Status:</strong> âœ… Root Cause Identified</p>
<p><strong>Severity:</strong> HIGH (Data Quality Impact)</p>

<p>---</p>

<h2>Quick Summary</h2>

<p><strong>Problem:</strong></p>
<ul>
<li>UI suggests "TYPE" for "werkwoord"</li>
<li>Database stores "PROCES" for "werkwoord"</li>
<li>User expects "TYPE" (grammatical category), gets "PROCES" (activity)</li>
</ul>

<p><strong>Root Cause:</strong></p>
<ul>
<li>User manually overrode classifier suggestion from TYPE â†’ PROCES</li>
<li>System accepted override without validation</li>
<li>Prompt instructed GPT-4 with "ğŸ¯ Focus: Dit is een **proces**"</li>
<li>AI followed prompt instruction, stored "PROCES"</li>
</ul>

<p><strong>Solution:</strong></p>
<ul>
<li>Add "werkwoord" to domain_overrides as TYPE</li>
<li>Add "-woord" suffix pattern for TYPE category</li>
<li>Add validation/warning for manual overrides</li>
</ul>

<p>---</p>

<h2>Evidence Trail</h2>

<h3>1. The Classifier Says "TYPE" âœ…</h3>

<p><strong>File:</strong> <code>src/ontologie/improved_classifier.py</code></p>
<p><strong>Lines:</strong> 85-96</p>

<pre><code>"proces": {
    "suffixes": ["ing", "atie", "tie", "eren", "isatie"],
    # "werkwoord" does NOT match these patterns
}</code></pre>

<p><strong>Result:</strong> Falls back to TYPE (correct by accident)</p>

<p>---</p>

<h3>2. The User Overrides to "PROCES" âš ï¸</h3>

<p><strong>File:</strong> <code>src/ui/tabbed_interface.py</code></p>
<p><strong>Lines:</strong> 345-357</p>

<pre><code>manual_override = st.selectbox(
    "Aanpassen?",
    options=["", "TYPE", "EXEMPLAAR", "PROCES", "RESULTAAT"],
)
if manual_override:
    SessionStateManager.set_value("manual_ontological_category", manual_override)
    # NO VALIDATION - accepts any value</code></pre>

<p><strong>Result:</strong> User picks "PROCES", system stores it</p>

<p>---</p>

<h3>3. The Prompt Enforces "PROCES" ğŸ¯</h3>

<p><strong>File:</strong> <code>src/services/prompts/modules/definition_task_module.py</code></p>
<p><strong>Line:</strong> 196</p>

<pre><code>ont_cat = f"\nğŸ¯ Focus: Dit is een **{ontological_category}** ({category_hints[ontological_category]})"
# ontological_category = "proces" (from user override)
# Output: "ğŸ¯ Focus: Dit is een **proces** (activiteit/handeling)"</code></pre>

<p><strong>File:</strong> <code>_Definitie_Generatie_prompt-9.txt</code></p>
<p><strong>Line:</strong> 390</p>

<pre><code>ğŸ¯ Focus: Dit is een **proces** (activiteit/handeling)</code></pre>

<p><strong>Result:</strong> GPT-4 treats "werkwoord" as PROCES, generates definition accordingly</p>

<p>---</p>

<h3>4. The Database Stores "PROCES" ğŸ’¾</h3>

<p><strong>File:</strong> <code>src/services/orchestrators/definition_orchestrator_v2.py</code></p>
<p><strong>Line:</strong> 789</p>

<pre><code>temp_definition = Definition(
    begrip=sanitized_request.begrip,
    ontologische_categorie=sanitized_request.ontologische_categorie,  # "proces"
)</code></pre>

<p><strong>Result:</strong> Database entry has <code>ontologische_categorie = "proces"</code></p>

<p>---</p>

<h2>The Data Flow (Simplified)</h2>

<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. CLASSIFIER                                â”‚
â”‚    ImprovedOntologyClassifier                â”‚
â”‚    â†’ "TYPE" (no PROCES patterns match)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. UI DISPLAY                                â”‚
â”‚    st.info("Voorgesteld: TYPE")              â”‚
â”‚    st.selectbox("Aanpassen?", ...)           â”‚
â”‚    â†’ User selects "PROCES" âš ï¸                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. SESSION STATE                             â”‚
â”‚    manual_ontological_category = "PROCES"    â”‚
â”‚    (NO VALIDATION)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. GENERATION REQUEST                        â”‚
â”‚    request.ontologische_categorie = "proces" â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. PROMPT INJECTION                          â”‚
â”‚    "ğŸ¯ Focus: Dit is een **proces**"         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. GPT-4 GENERATION                          â”‚
â”‚    Follows prompt â†’ generates PROCES def     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. DATABASE STORAGE                          â”‚
â”‚    categorie = "proces" âœ“ (as instructed)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>

<p>---</p>

<h2>Why "werkwoord" Should Be TYPE</h2>

<p><strong>Linguistic Analysis:</strong></p>

<p>| Aspect | TYPE (Correct) | PROCES (Wrong) |</p>
<p>|--------|----------------|----------------|</p>
<p>| <strong>Definition</strong> | Category of words (like "mammal" is a type of animal) | Activity of using words (nonsensical) |</p>
<p>| <strong>Example phrase</strong> | "Werkwoord is een soort woord dat..." | "Werkwoord is een activiteit waarbij..." âŒ |</p>
<p>| <strong>Parallel</strong> | "Car is a type of vehicle" âœ… | "Car is an activity of..." âŒ |</p>
<p>| <strong>Ontology</strong> | Classification/taxonomy | Process/action |</p>

<p><strong>Correct Classifications:</strong></p>

<p>| Term | Category | Rationale |</p>
<p>|------|----------|-----------|</p>
<p>| werkwoord | TYPE | Word category (classification) |</p>
<p>| vervoegen | PROCES | Activity of conjugating verbs |</p>
<p>| vervoeging | RESULTAAT | Result of conjugation |</p>

<p>---</p>

<h2>The Fix (Simple)</h2>

<h3>Step 1: Add Domain Override</h3>

<p><strong>File:</strong> <code>config/classification/term_patterns.yaml</code></p>
<p><strong>Add after line 33:</strong></p>

<pre><code>domain_overrides:
  machtiging: TYPE
  vergunning: RESULTAAT
  # ... existing entries

  # NEW: Grammatical meta-terms
  werkwoord: TYPE
  zelfstandig naamwoord: TYPE
  bijvoeglijk naamwoord: TYPE
  bijwoord: TYPE
  voorzetsel: TYPE
  lidwoord: TYPE
  voegwoord: TYPE</code></pre>

<h3>Step 2: Add Suffix Pattern</h3>

<p><strong>File:</strong> <code>config/classification/term_patterns.yaml</code></p>
<p><strong>Add to TYPE suffix_weights (after line 69):</strong></p>

<pre><code>suffix_weights:
  TYPE:
    systeem: 0.80
    model: 0.80
    # ... existing entries
    woord: 0.90        # NEW: werkwoord, bijwoord, etc.</code></pre>

<h3>Step 3: Test</h3>

<pre><code># Run classifier on "werkwoord"
python -c "
from ontologie.improved_classifier import ImprovedOntologyClassifier
classifier = ImprovedOntologyClassifier()
result = classifier.classify('werkwoord', '', '', '')
print(f'Category: {result.categorie.value}')
print(f'Confidence: {result.confidence_label}')
print(f'Reasoning: {result.reasoning}')
"

# Expected output:
# Category: type
# Confidence: HIGH
# Reasoning: Classificatie: TYPE (score: 1.00) | Confidence: 0.95 ğŸŸ¢ (HIGH) | domain override</code></pre>

<p>---</p>

<h2>Implementation Checklist</h2>

<ul>
<li>[ ] Add "werkwoord" and other grammatical terms to `domain_overrides`</li>
<li>[ ] Add "woord" suffix to TYPE patterns with weight 0.90</li>
<li>[ ] Test classifier on "werkwoord" (expect TYPE, HIGH confidence)</li>
<li>[ ] Create test suite for meta-linguistic terms</li>
<li>[ ] Add audit logging for manual category overrides</li>
<li>[ ] Add UI warning when user overrides classifier suggestion</li>
<li>[ ] Re-classify existing "werkwoord" entries in database (if any)</li>
<li>[ ] Document pattern in `docs/analyses/` for future reference</li>
</ul>

<p>---</p>

<h2>Files Modified</h2>

<ol>
<li>`config/classification/term_patterns.yaml` (domain_overrides + suffix_weights)</li>
<li>`tests/classification/test_meta_linguistic_terms.py` (new test file)</li>
<li>`src/ui/tabbed_interface.py` (optional: add override validation)</li>
<li>`scripts/audit_category_mismatches.py` (optional: audit script)</li>
</ol>

<p>---</p>

<h2>Key Learnings</h2>

<ol>
<li>**Manual overrides need validation** - Don't accept user input blindly</li>
<li>**Classifier patterns have gaps** - Meta-linguistic terms weren't considered</li>
<li>**Prompt instructions are authoritative** - Whatever is in "ğŸ¯ Focus" wins</li>
<li>**Audit trails are critical** - Need to track WHO changed WHAT and WHY</li>
<li>**Data quality requires consistency checks** - Reconcile classifier vs. final instruction</li>
</ol>

<p>---</p>

<h2>Related Documents</h2>

<ul>
<li>**Full Analysis:** `ROOT_CAUSE_ANALYSIS.md` (comprehensive 200+ line investigation)</li>
<li>**Test Plan:** `DEF-138-test-plan.md` (testing strategy)</li>
<li>**Config Changes:** `term_patterns.yaml` (implementation)</li>
<li>**Unique Index Removal:** `DEF-138-UNIQUE-INDEX-REMOVAL-ANALYSIS.md` (related but separate issue)</li>
</ul>

<p>---</p>

<p><strong>Status:</strong> âœ… Ready for implementation</p>
<p><strong>Effort:</strong> 2 hours (config changes + tests + validation)</p>
<p><strong>Impact:</strong> HIGH (prevents future misclassifications)</p>
<p><strong>Risk:</strong> LOW (config-only change, no code modifications)</p>

<p>---</p>

<p><strong>Next Step:</strong> Get approval to update <code>term_patterns.yaml</code> and implement fix.</p>

  </div>
</body>
</html>