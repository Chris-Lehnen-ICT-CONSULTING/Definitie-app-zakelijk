<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>US-454: titel: Create Generation Orchestrator Tests (Phase 0)</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">← Terug naar Portal</a>
    <p>---</p>
<p>id: US-454</p>
<p>epic: EPIC-026</p>
<p>titel: "US-454: titel: Create Generation Orchestrator Tests (Phase 0)"</p>
<p>owner: test-engineer</p>
<p>prioriteit: P0</p>
<p>status: pending</p>
<p>estimate: 2 weeks</p>
<p>sprint: Phase 0 Week 2-3</p>
<p>created: 2025-10-03</p>
<p>blocked_by: US-640</p>
<p>---</p>

<h1>US-454: Create Generation Orchestrator Tests (Phase 0)</h1>

<p><strong>Epic:</strong> EPIC-026 - God Object Refactoring</p>
<p><strong>Owner:</strong> Test Engineer</p>
<p><strong>Priority:</strong> P0 (CRITICAL)</p>
<p><strong>Estimate:</strong> 2 weeks (10 days)</p>
<p><strong>Sprint:</strong> Phase 0 Week 2-3</p>

<p>---</p>

<h2>User Story</h2>

<p><strong>As a</strong> test engineer</p>
<p><strong>I want to</strong> create 368 tests for generation orchestrator workflows</p>
<p><strong>So that</strong> we can safely extract the 380 LOC god method without breaking core functionality</p>

<p>---</p>

<h2>Context</h2>

<p><strong>The Target: 380 LOC God Method</strong></p>

<p>Location: <code>src/ui/tabbed_interface.py::_handle_definition_generation()</code> (lines 821-1201)</p>

<p><strong>Complexity:</strong></p>
<ul>
<li>10-step workflow (context validation → category → duplicate → generation → state mutations)</li>
<li>5+ services coordinated (Definition, Regeneration, Document, Category, Checker)</li>
<li>15+ state mutations (`st.session_state`)</li>
<li>6 early exit paths</li>
<li>8 try/except blocks</li>
<li>Async operations mixed with sync</li>
</ul>

<p><strong>This is THE CORE of the application</strong> - if this breaks, app is unusable.</p>

<p>---</p>

<h2>Test Coverage Breakdown</h2>

<p><strong>Total: 368 tests</strong></p>

<h3>Category A: Generation Orchestrator (150 tests)</h3>
<ul>
<li>10-step workflow × 5 scenarios = **50 tests**</li>
<li>State mutations (15 mutations × 3 states) = **45 tests**</li>
<li>Error paths (8 exceptions × 3 scenarios) = **24 tests**</li>
<li>Edge cases = **31 tests**</li>
</ul>

<h3>Category B: Category Determination (100 tests)</h3>
<ul>
<li>6-step protocol tests = **30 tests**</li>
<li>Quick analyzer fallback = **20 tests**</li>
<li>Pattern matching (4 categories × 5 patterns) = **20 tests**</li>
<li>Scoring algorithm = **15 tests**</li>
<li>Reasoning generation = **15 tests**</li>
</ul>

<h3>Category C: Document Context (118 tests)</h3>
<ul>
<li>Document upload & processing = **40 tests**</li>
<li>Snippet extraction (280 char window) = **30 tests**</li>
<li>Context aggregation = **28 tests**</li>
<li>Edge cases (empty docs, large docs) = **20 tests**</li>
</ul>

<p>---</p>

<h2>Acceptance Criteria</h2>

<h3>AC1: Generation Orchestrator Coverage (150 tests)</h3>

<p><strong>10-Step Workflow Tests:</strong></p>
<ul>
<li>[ ] Step 1: Context validation (org/jur/wet minimum 1)</li>
<li>[ ] Step 2: Category determination (async call)</li>
<li>[ ] Step 3: Duplicate check (3 outcomes: none, found, multiple)</li>
<li>[ ] Step 4: Document context retrieval</li>
<li>[ ] Step 5: Snippet extraction (max 2 docs, 280 char window)</li>
<li>[ ] Step 6: Regeneration context handling</li>
<li>[ ] Step 7: Definition service call (async via run_async)</li>
<li>[ ] Step 8: Result storage (15+ state mutations)</li>
<li>[ ] Step 9: Edit tab preparation</li>
<li>[ ] Step 10: Success notification</li>
</ul>

<p><strong>Scenarios per step:</strong></p>
<ul>
<li>Happy path (all steps succeed)</li>
<li>Context validation fails (missing org/jur/wet)</li>
<li>Category determination times out</li>
<li>Duplicate found (user chooses: cancel, continue, edit existing)</li>
<li>Document processing fails</li>
</ul>

<p>---</p>

<h3>AC2: Category Determination Coverage (100 tests)</h3>

<p><strong>6-Step Protocol:</strong></p>
<ul>
<li>[ ] Full ontological analysis (primary method)</li>
<li>[ ] Quick analyzer fallback (secondary)</li>
<li>[ ] Legacy pattern matching (tertiary)</li>
<li>[ ] Default category (all fallbacks fail)</li>
</ul>

<p><strong>Pattern Tests (4 categories):</strong></p>
<ul>
<li>[ ] "Proces": suffixes (atie, eren, ing) + keywords (verificatie, etc.)</li>
<li>[ ] "Type": keywords (bewijs, document, middel, etc.)</li>
<li>[ ] "Resultaat": keywords (besluit, uitslag, rapport, etc.)</li>
<li>[ ] "Exemplaar": keywords (specifiek, individueel, etc.)</li>
</ul>

<p><strong>Scoring Algorithm:</strong></p>
<ul>
<li>[ ] Pattern count weighting (more patterns = higher score)</li>
<li>[ ] Confidence thresholds (high: >0.8, medium: 0.5-0.8, low: <0.5)</li>
<li>[ ] Tie-breaking logic (equal scores)</li>
</ul>

<p>---</p>

<h3>AC3: Document Context Coverage (118 tests)</h3>

<p><strong>Upload & Processing:</strong></p>
<ul>
<li>[ ] Single PDF upload</li>
<li>[ ] Multiple PDF uploads (max 5)</li>
<li>[ ] Large PDF (>10 pages)</li>
<li>[ ] Corrupt PDF (error handling)</li>
<li>[ ] Empty PDF</li>
<li>[ ] Non-PDF file (reject)</li>
</ul>

<p><strong>Snippet Extraction:</strong></p>
<ul>
<li>[ ] Begriff occurs 1x in document</li>
<li>[ ] Begriff occurs 5x in document (take first 2)</li>
<li>[ ] Begriff occurs 0x (no snippets)</li>
<li>[ ] 280 character window (140 chars before + after begriff)</li>
<li>[ ] Begriff at start of document (<140 chars before)</li>
<li>[ ] Begriff at end of document (<140 chars after)</li>
</ul>

<p><strong>Context Aggregation:</strong></p>
<ul>
<li>[ ] 1 document, 1 snippet</li>
<li>[ ] 2 documents, 2 snippets each (4 total)</li>
<li>[ ] 5 documents, 1 snippet each (5 total)</li>
<li>[ ] Deduplicate identical snippets</li>
</ul>

<p>---</p>

<h3>AC4: Integration Tests (30 scenarios)</h3>

<p><strong>End-to-End Flows:</strong></p>
<ol>
<li>Generate definition (Toezicht, org=IGJ) - success</li>
<li>Generate definition (duplicate found) - show dialog</li>
<li>Generate definition (category change) - trigger regeneration</li>
<li>Generate definition (with 2 PDFs) - context included</li>
<li>Generate definition (validation fails) - show errors</li>
<p>6-30: Additional scenarios covering edge cases</p>
</ol>

<p>---</p>

<h3>AC5: Golden Master Baselines</h3>

<ul>
<li>[ ] Export 42 existing definitions (pre-refactor)</li>
<li>[ ] Create golden baseline for each definition</li>
<li>[ ] Test: regenerate all 42, compare outputs</li>
<li>[ ] Tolerance: 0% for business logic, <5% for LLM variance</li>
</ul>

<p>---</p>

<h2>Test Implementation Guide</h2>

<h3>Example Test: Happy Path</h3>

<pre><code>@pytest.mark.asyncio
async def test_generation_orchestrator_happy_path():
    """Full generation workflow succeeds"""
    # Arrange
    mock_ai = MockAIService(
        category_response="Toezicht",
        definition_response="Een vorm van toezicht waarbij..."
    )
    mock_db = MockDatabase()
    mock_docs = MockDocumentProcessor()

    state = MockSessionState({
        "begrip": "Toezicht",
        "org_context": ["IGJ"],
        "jur_context": [],
        "wet_context": []
    })

    orchestrator = GenerationOrchestrator(
        ai_service=mock_ai,
        db=mock_db,
        doc_processor=mock_docs
    )

    # Act
    result = await orchestrator.generate(state)

    # Assert
    assert result.success is True
    assert result.category == "Toezicht"
    assert result.definition.startswith("Een vorm van")
    assert state.get("generated_definition") is not None
    assert state.get("editing_definition_id") is not None
    assert mock_ai.call_count == 2  # Category + Definition</code></pre>

<p>---</p>

<h3>Example Test: Duplicate Found</h3>

<pre><code>def test_generation_orchestrator_duplicate_found():
    """Duplicate check returns existing definition"""
    # Arrange
    mock_db = MockDatabase(
        duplicate_result=[
            {"id": 123, "definitie": "Existing definition", "begrip": "Toezicht"}
        ]
    )

    state = MockSessionState({"begrip": "Toezicht", "org_context": ["IGJ"]})
    orchestrator = GenerationOrchestrator(db=mock_db)

    # Act
    result = orchestrator.generate(state)

    # Assert
    assert result.duplicate_found is True
    assert result.duplicate_id == 123
    assert state.get("show_duplicate_dialog") is True</code></pre>

<p>---</p>

<h3>Example Test: Category Determination</h3>

<pre><code>@pytest.mark.asyncio
async def test_category_determination_pattern_matching():
    """Pattern matching correctly identifies 'Proces' category"""
    # Arrange
    mock_ai = MockAIService(timeout=True)  # Force fallback to patterns
    category_service = OntologicalCategoryService(ai_service=mock_ai)

    # Act
    result = await category_service.determine_category(
        begrip="Verificatie",
        definition="Een proces waarbij..."
    )

    # Assert
    assert result.category == "Proces"
    assert result.method == "pattern_matching"  # Not 6-step (timed out)
    assert "atie" in result.matched_patterns  # Suffix match</code></pre>

<p>---</p>

<h2>Dependencies</h2>

<p><strong>Depends On:</strong></p>
<ul>
<li>US-640 (Test Infrastructure) - MUST be complete first</li>
</ul>

<p><strong>Blocks:</strong></p>
<ul>
<li>US-447 (Extract Generation Orchestrator) - cannot refactor without tests</li>
</ul>

<p>---</p>

<h2>Risks</h2>

<h3>Risk 1: 380 LOC God Method Too Complex to Test</h3>
<p><strong>Likelihood:</strong> MEDIUM</p>
<p><strong>Impact:</strong> HIGH (cannot achieve 85% coverage)</p>
<p><strong>Mitigation:</strong></p>
<ul>
<li>Start with characterization tests (record current behavior)</li>
<li>Break down into 10 steps, test each step independently</li>
<li>Use golden master for complex workflows</li>
</ul>

<h3>Risk 2: Async Tests Are Flaky</h3>
<p><strong>Likelihood:</strong> HIGH</p>
<p><strong>Impact:</strong> HIGH (Gate 1 requires <5% flakiness)</p>
<p><strong>Mitigation:</strong></p>
<ul>
<li>Use pytest-asyncio properly (no nested event loops)</li>
<li>Explicit waits, no time.sleep()</li>
<li>Retry logic for network-dependent tests</li>
</ul>

<h3>Risk 3: 368 Tests in 10 Days Is Aggressive</h3>
<p><strong>Likelihood:</strong> MEDIUM</p>
<p><strong>Impact:</strong> MEDIUM (timeline slip)</p>
<p><strong>Mitigation:</strong></p>
<ul>
<li>Prioritize: 150 orchestrator tests (critical) → 100 category → 118 document</li>
<li>Can defer document tests to Week 4 if needed</li>
<li>Minimum viable: 250 tests (70% coverage)</li>
</ul>

<p>---</p>

<h2>Success Metrics</h2>

<ul>
<li>[ ] 368 tests created (100% target)</li>
<li>[ ] 250+ tests minimum (70% target)</li>
<li>[ ] 85%+ coverage for generation orchestrator</li>
<li>[ ] <5% flaky tests</li>
<li>[ ] 30 integration scenarios passing</li>
<li>[ ] Golden baseline: 42 definitions exported</li>
</ul>

<p>---</p>

<h2>Timeline</h2>

<p><strong>Week 2 (5 days):</strong></p>
<ul>
<li>Day 6-7: 150 orchestrator tests (30 tests/day)</li>
<li>Day 8-9: 100 category tests (25 tests/day)</li>
<li>Day 10: 50 document tests + integration (PoC)</li>
</ul>

<p><strong>Week 3 (5 days):</strong></p>
<ul>
<li>Day 11-12: 68 remaining document tests</li>
<li>Day 13-14: 30 integration scenarios</li>
<li>Day 15: Golden baseline export + validation</li>
</ul>

<p><strong>Contingency:</strong> If behind schedule, Week 4 buffer available</p>

<p>---</p>

<h2>Rollback</h2>

<p><strong>Abort Trigger:</strong> If <250 tests by Day 13 → Extend to Week 4 or reduce scope</p>

<p>---</p>

<p><strong>Status:</strong> Pending (blocked by US-640)</p>
<p><strong>Next Action:</strong> Wait for US-640 completion, then start Week 2 Day 6</p>

  </div>
</body>
</html>