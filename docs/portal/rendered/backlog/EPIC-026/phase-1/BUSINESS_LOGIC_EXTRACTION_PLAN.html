<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Business Logic Extraction Plan - DefinitieAgent Rebuild Foundation</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">‚Üê Terug naar Portal</a>
    <p>---</p>
<p>id: EPIC-026-BUSINESS-LOGIC-EXTRACTION-PLAN</p>
<p>epic: EPIC-026</p>
<p>phase: 1</p>
<p>day: 2</p>
<p>created: 2025-10-02</p>
<p>owner: business-logic-specialist</p>
<p>status: complete</p>
<p>priority: critical</p>
<p>canonical: true</p>
<p>applies_to: definitie-app@epic-026</p>
<p>---</p>

<h1>Business Logic Extraction Plan - DefinitieAgent Rebuild Foundation</h1>

<p><strong>Mission:</strong> Extract ALL business logic before rebuild to ensure zero knowledge loss</p>

<p><strong>Created:</strong> 2025-10-02</p>
<p><strong>Owner:</strong> Business Logic Extraction Specialist</p>
<p><strong>Phase:</strong> EPIC-026 Phase 1 (Design)</p>
<p><strong>Complexity:</strong> VERY HIGH</p>
<p><strong>Duration:</strong> 2-3 weeks intensive extraction</p>

<p>---</p>

<h2>Executive Summary</h2>

<h3>Critical Statistics</h3>
<ul>
<li>**Total Codebase:** 83,319 LOC</li>
<li>**Validation Rules:** 46 files (dual JSON+Python format)</li>
<li>**Hidden Orchestrators:** ~1,113 LOC (definition_orchestrator_v2.py: 984 LOC, regeneration_service.py: 129 LOC)</li>
<li>**Hardcoded Business Logic:** 728 occurrences of patterns/rules across 99 files</li>
<li>**God Objects:**</li>
<li> - `definition_generator_tab.py`: 2,525 LOC, 60 methods</li>
<li> - `tabbed_interface.py`: 1,793 LOC, 39 methods</li>
<li> - `definitie_repository.py`: 1,815 LOC, 41 methods</li>
<li>**Test Data:** 42 definitions in production database</li>
<li>**Service Classes:** 256+ classes/functions across 82 service files</li>
</ul>

<h3>Extraction Challenge</h3>
<p><strong>This is NOT a simple refactor - it's an archaeological dig through 83K LOC to preserve business knowledge.</strong></p>

<p>The current system has:</p>
<ol>
<li>**Hardcoded patterns in 3+ locations** (ontological categorization)</li>
<li>**Dual-format validation rules** (JSON metadata + Python logic)</li>
<li>**Hidden orchestration workflows** (880+ LOC of generation/regeneration logic)</li>
<li>**UI-embedded business logic** (4,318 LOC across 2 god objects)</li>
<li>**Implicit state machines** (approval workflows, status transitions)</li>
<li>**Domain expertise** (46 Dutch legal validation rules with ASTRA compliance)</li>
</ol>

<p><strong>Risk:</strong> If we don't extract this correctly, we lose years of domain knowledge.</p>

<p>---</p>

<h2>1. INVENTORY - What Needs Extraction</h2>

<h3>1.1 Validation Rules (46 Rules) - CRITICAL</h3>

<p><strong>Location:</strong> <code>src/toetsregels/regels/<em>.py</code> + <code>src/toetsregels/regels/</em>.json</code></p>

<p><strong>Structure:</strong></p>
<pre><code># Example: ARAI-01 (No verb as core)
# JSON: Metadata (id, naam, uitleg, prioriteit, patronen, voorbeelden)
# Python: Validator class with validate() + get_generation_hints()</code></pre>

<p><strong>Categories:</strong></p>
<ul>
<li>**ARAI** (6 rules): Derived AI rules from ASTRA recommendations</li>
<li>**CON** (2 rules): Consistency rules (begrip occurrence, term usage)</li>
<li>**ESS** (5 rules): Essential structure rules (definition structure, genre checks)</li>
<li>**INT** (10 rules): Integrity rules (forbidden words, abbreviations, redundancy)</li>
<li>**SAM** (8 rules): Composition rules (sentence count, length, bullet points)</li>
<li>**STR** (9 rules): Structure rules (bullets, lists, formatting)</li>
<li>**VER** (3 rules): Verification rules (length adequacy, completeness)</li>
<li>**DUP** (1 rule): Duplicate detection</li>
</ul>

<p><strong>Business Logic per Rule:</strong></p>
<ol>
<li>**Validation Logic** (Python `validate()` method)</li>
</ol>
<ul>
<li>  - Regex patterns for detection</li>
<li>  - Threshold values (e.g., 50-500 chars, max 3 sentences)</li>
<li>  - Scoring algorithms (pass/fail/warning)</li>
<li>  - Error messages with emojis (‚úîÔ∏è/‚ùå/üü°)</li>
</ul>

<ol>
<li>**Generation Hints** (Python `get_generation_hints()` method)</li>
</ol>
<ul>
<li>  - AI prompt fragments</li>
<li>  - Good/bad examples</li>
<li>  - Constraints for GPT-4</li>
</ul>

<ol>
<li>**Metadata** (JSON configuration)</li>
</ol>
<ul>
<li>  - Priority (high/medium/low)</li>
<li>  - Applicability (all/optional)</li>
<li>  - ASTRA references</li>
<li>  - Thema categorization</li>
</ul>

<p><strong>Extraction Complexity:</strong> MEDIUM-HIGH</p>
<ul>
<li>46 files √ó 2 formats = 92 files to analyze</li>
<li>Dual-format consistency must be preserved</li>
<li>Business rules embedded in regex patterns</li>
<li>Domain expertise in Dutch legal language</li>
</ul>

<p><strong>Extraction Strategy:</strong></p>
<ol>
<li>**Document each rule** with:</li>
</ol>
<ul>
<li>  - Business purpose (what/why)</li>
<li>  - Implementation logic (how)</li>
<li>  - Threshold values and rationale</li>
<li>  - ASTRA linkage</li>
<li>  - Examples (good/bad)</li>
</ul>
<ol>
<li>**Extract patterns to config**:</li>
</ol>
<ul>
<li>  - Move hardcoded regex to declarative config</li>
<li>  - Extract thresholds to tunable parameters</li>
<li>  - Document scoring algorithms</li>
</ul>
<ol>
<li>**Create rule catalog** (CSV/JSON):</li>
</ol>
<ul>
<li>  - Rule ID | Category | Priority | Business Logic | Thresholds | Examples | ASTRA Link</li>
</ul>

<p>---</p>

<h3>1.2 Ontological Category Determination - CRITICAL HARDCODED LOGIC</h3>

<p><strong>Location:</strong> <code>src/ui/tabbed_interface.py</code> lines 272-419 (148 LOC)</p>

<p><strong>The Problem:</strong> Category determination logic duplicated in 3 methods with hardcoded patterns!</p>

<p><strong>Affected Methods:</strong></p>
<ol>
<li>`_determine_ontological_category()` (L272-332): Async 6-step protocol with 3 fallbacks</li>
<li>`_legacy_pattern_matching()` (L334-345): Hardcoded pattern lists</li>
<li>`_generate_category_reasoning()` (L347-418): Duplicate pattern definitions</li>
<li>`_get_category_scores()` (L420+): Score calculation with indicators</li>
</ol>

<p><strong>Hardcoded Patterns (DUPLICATED 3x!):</strong></p>
<pre><code>patterns = {
    "proces": ["atie", "eren", "ing", "verificatie", "authenticatie", "validatie",
               "controle", "check", "beoordeling", "analyse", "behandeling",
               "vaststelling", "bepaling", "registratie", "identificatie"],
    "type": ["bewijs", "document", "middel", "systeem", "methode", "tool",
             "instrument", "gegeven", "kenmerk", "eigenschap"],
    "resultaat": ["besluit", "uitslag", "rapport", "conclusie", "bevinding",
                  "resultaat", "uitkomst", "advies", "oordeel"],
    "exemplaar": ["specifiek", "individueel", "uniek", "persoon", "zaak",
                  "instantie", "geval", "situatie"]
}</code></pre>

<p><strong>Business Logic:</strong></p>
<ul>
<li>**6-step protocol**: Full ontological analysis (primary method)</li>
<li>**Quick analyzer**: Fallback pattern matching (secondary method)</li>
<li>**Legacy patterns**: Ultra-fallback (tertiary method)</li>
<li>**Scoring**: Pattern count-based weighting</li>
<li>**Reasoning generation**: Explanation of category choice</li>
</ul>

<p><strong>Extraction Complexity:</strong> VERY HIGH</p>
<ul>
<li>Logic spread across 4 methods</li>
<li>Patterns duplicated 3 times</li>
<li>Async/sync mixing</li>
<li>Fallback chain complexity</li>
<li>Domain knowledge in pattern selection</li>
</ul>

<p><strong>Extraction Strategy:</strong></p>
<ol>
<li>**Extract patterns to config file** (`config/ontological_patterns.yaml`):</li>
<pre><code>   categories:
     proces:
       suffixes: [atie, eren, ing]
       keywords: [verificatie, authenticatie, validatie, ...]
       weight: 1.0
     type:
       keywords: [bewijs, document, middel, systeem, ...]
       weight: 1.0</code></pre>
<li>**Document 6-step protocol**:</li>
</ol>
<ul>
<li>  - Step-by-step workflow diagram</li>
<li>  - Fallback decision tree</li>
<li>  - Scoring algorithm specification</li>
</ul>
<ol>
<li>**Create test suite**:</li>
</ol>
<ul>
<li>  - Test all 42 existing definitions</li>
<li>  - Edge cases for each category</li>
<li>  - Fallback path validation</li>
</ul>

<p>---</p>

<h3>1.3 Definition Generation Orchestration - GOD METHOD</h3>

<p><strong>Location:</strong> <code>src/ui/tabbed_interface.py::_handle_definition_generation()</code> (L821-1201, ~380 LOC!)</p>

<p><strong>The Problem:</strong> 380 LOC god method orchestrating the ENTIRE generation workflow!</p>

<p><strong>Orchestration Steps (10-step workflow):</strong></p>
<ol>
<li>**Context validation** (min 1 of org/jur/wet)</li>
<li>**Ontological category determination** (async call to _determine_ontological_category)</li>
<li>**Document context retrieval** (_get_document_context)</li>
<li>**Document snippets extraction** (_build_document_snippets: max 2, 280 char window)</li>
<li>**Regeneration context handling** (RegenerationService integration)</li>
<li>**Definition service call** (async via run_async)</li>
<li>**Result storage** (SessionStateManager mutations)</li>
<li>**Edit tab preparation** (editing_definition_id, edit_*_context)</li>
<li>**Regeneration cleanup** (clear regeneration state)</li>
<li>**Success notification** (UI feedback)</li>
</ol>

<p><strong>Hidden Business Rules:</strong></p>
<ul>
<li>Context requirement: minimum 1 of (org/jur/wet)</li>
<li>Document snippets: max 2 per document, 280 char window around begrip</li>
<li>Regeneration priority: use regeneration context if available</li>
<li>Edit tab state: auto-prepare for immediate editing</li>
<li>Debug mode: capture voorbeelden prompts if DEBUG_EXAMPLES=true</li>
</ul>

<p><strong>Cross-Service Dependencies:</strong></p>
<ul>
<li>`get_definition_service()` - core generation</li>
<li>`RegenerationService` - regeneration context</li>
<li>`get_document_processor()` - document handling</li>
<li>`SessionStateManager` - state mutations (15+ calls!)</li>
<li>`run_async()` - async bridge</li>
<li>`capture_voorbeelden_prompts()` - debug instrumentation</li>
</ul>

<p><strong>Extraction Complexity:</strong> CRITICAL</p>
<ul>
<li>380 LOC in single method (god method anti-pattern)</li>
<li>Orchestrates 5+ services</li>
<li>Complex async/sync coordination</li>
<li>Extensive state mutations</li>
<li>Multiple error paths</li>
<li>Debug instrumentation interleaved</li>
</ul>

<p><strong>Extraction Strategy:</strong></p>
<ol>
<li>**Document complete workflow**:</li>
</ol>
<ul>
<li>  - Sequence diagram (10 steps)</li>
<li>  - State machine diagram (error paths, rollback)</li>
<li>  - Service interaction diagram</li>
</ul>
<ol>
<li>**Extract business rules**:</li>
</ol>
<ul>
<li>  - Context validation rules ‚Üí config</li>
<li>  - Snippet extraction algorithm ‚Üí separate service</li>
<li>  - Regeneration priority logic ‚Üí explicit decision tree</li>
</ul>
<ol>
<li>**Create integration test**:</li>
</ol>
<ul>
<li>  - Test full workflow end-to-end</li>
<li>  - Mock all 5 services</li>
<li>  - Verify state mutations</li>
<li>  - Test error paths</li>
</ul>

<p>---</p>

<h3>1.4 Validation Orchestration - HIDDEN COMPLEXITY</h3>

<p><strong>Location:</strong> <code>src/services/orchestrators/validation_orchestrator_v2.py</code></p>

<p><strong>Purpose:</strong> Coordinates 46 validation rules with approval gate policy</p>

<p><strong>Key Business Logic:</strong></p>
<ul>
<li>**Rule execution order** (priority-based)</li>
<li>**Approval gate policy** (EPIC-016): mode/thresholds/required fields</li>
<li>**Score aggregation** (weighted average? min/max?)</li>
<li>**Violation severity** (high/medium/low mapping)</li>
<li>**Pass/fail thresholds** (per-rule and overall)</li>
</ul>

<p><strong>Extraction Complexity:</strong> MEDIUM</p>
<ul>
<li>Well-structured service</li>
<li>Needs documentation of orchestration algorithm</li>
<li>Approval gate policy must be extracted</li>
</ul>

<p><strong>Extraction Strategy:</strong></p>
<ol>
<li>Read full file</li>
<li>Document orchestration algorithm</li>
<li>Extract approval gate policy rules</li>
<li>Map rule execution order logic</li>
</ol>

<p>---</p>

<h3>1.5 Regeneration Workflows - STATE MACHINE</h3>

<p><strong>Location:</strong></p>
<ul>
<li>`src/ui/components/definition_generator_tab.py::_trigger_regeneration_with_category()` (L2008-2192, ~500 LOC)</li>
<li>`src/services/regeneration_service.py` (129 LOC)</li>
</ul>

<p><strong>Business Logic:</strong></p>
<ul>
<li>**Category change impact analysis**: Which fields change when category switches?</li>
<li>**Regeneration triggers**: When to regenerate vs. when to warn</li>
<li>**Context preservation**: Which context to keep, which to update</li>
<li>**State transitions**: Draft ‚Üí Regenerating ‚Üí Generated ‚Üí Established</li>
<li>**Comparison logic**: Old vs. new definition diff</li>
</ul>

<p><strong>Extraction Complexity:</strong> HIGH</p>
<ul>
<li>Implicit state machine</li>
<li>Complex UI/business logic mixing</li>
<li>Async regeneration execution</li>
<li>Error rollback handling</li>
</ul>

<p><strong>Extraction Strategy:</strong></p>
<ol>
<li>**Document state machine**:</li>
</ol>
<ul>
<li>  - States: Draft, Regenerating, Generated, Established, Failed</li>
<li>  - Transitions: triggers and conditions</li>
<li>  - Rollback paths</li>
</ul>
<ol>
<li>**Extract impact analysis rules**:</li>
</ol>
<ul>
<li>  - Category transition matrix (type‚Üîproces, etc.)</li>
<li>  - Field update logic per transition</li>
</ul>
<ol>
<li>**Create state machine diagram** (PlantUML/Mermaid)</li>
</ol>

<p>---</p>

<h3>1.6 Duplicate Detection - BUSINESS RULES</h3>

<p><strong>Location:</strong> <code>src/database/definitie_repository.py::find_duplicates()</code> (L192-305, ~113 LOC)</p>

<p><strong>Three-Stage Matching Algorithm:</strong></p>
<ol>
<li>**Exact match** (begrip + context):</li>
</ol>
<ul>
<li>  - Begrip exact match (case-insensitive)</li>
<li>  - Context match (org/jur/wet)</li>
<li>  - Wettelijke basis normalization (sorted, unique, stripped)</li>
</ul>

<ol>
<li>**Synonym match** (via voorbeelden join):</li>
</ol>
<ul>
<li>  - Join with definitie_voorbeelden table</li>
<li>  - Match on synonyms and alternative terms</li>
<li>  - Context-aware matching</li>
</ul>

<ol>
<li>**Fuzzy match** (LIKE + similarity threshold):</li>
</ol>
<ul>
<li>  - LIKE query with wildcards</li>
<li>  - Jaccard similarity calculation</li>
<li>  - **Threshold: 70%** (hardcoded business rule!)</li>
<li>  - Wettelijke basis comparison</li>
</ul>

<p><strong>Hidden Business Rules:</strong></p>
<ul>
<li>Similarity threshold: 70% Jaccard similarity</li>
<li>Wettelijke basis normalization: JSON sorted, unique, stripped</li>
<li>Synonym precedence: exact > synonym > fuzzy</li>
<li>Context weighting: how much do contexts influence match?</li>
</ul>

<p><strong>Extraction Complexity:</strong> HIGH</p>
<ul>
<li>Complex multi-stage algorithm</li>
<li>Hardcoded threshold (70%)</li>
<li>Normalization logic</li>
<li>SQL query optimization knowledge</li>
</ul>

<p><strong>Extraction Strategy:</strong></p>
<ol>
<li>**Document algorithm**:</li>
</ol>
<ul>
<li>  - Flowchart: 3-stage decision tree</li>
<li>  - Jaccard similarity formula</li>
<li>  - Normalization steps</li>
</ul>
<ol>
<li>**Extract thresholds**:</li>
</ol>
<ul>
<li>  - 70% similarity ‚Üí config parameter</li>
<li>  - Context weighting ‚Üí tunable</li>
</ul>
<ol>
<li>**Create test cases**:</li>
</ol>
<ul>
<li>  - Test against 42 existing definitions</li>
<li>  - Edge cases (near-duplicates, synonyms)</li>
<li>  - Performance benchmarks</li>
</ul>

<p>---</p>

<h3>1.7 Voorbeelden (Examples) Persistence - COMPLEX TRANSACTION</h3>

<p><strong>Location:</strong> <code>src/database/definitie_repository.py::save_voorbeelden()</code> (L254-464, ~210 LOC)</p>

<p><strong>Business Logic:</strong></p>
<ul>
<li>**Type normalization**: voorbeeldzinnen ‚Üí sentence, praktijkvoorbeelden ‚Üí practical</li>
<li>**Soft delete**: deactivate old examples (actief=0), insert new</li>
<li>**Voorkeursterm single source**: ONLY from definities.voorkeursterm column</li>
<li>**Upsert logic**: update if exists, insert if new</li>
<li>**Deduplication**: skip if no new examples (safety guard against wipe)</li>
<li>**Transaction boundaries**: explicit commit for multi-step operation</li>
</ul>

<p><strong>Normalization Mapping (HARDCODED):</strong></p>
<pre><code>type_mapping = {
    "voorbeeldzinnen": "sentence",
    "praktijkvoorbeelden": "practical",
    "tegenvoorbeelden": "counter",
    "synoniemen": "synonyms",
    "antoniemen": "antonyms"
}</code></pre>

<p><strong>Extraction Complexity:</strong> MEDIUM-HIGH</p>
<ul>
<li>Complex transaction logic</li>
<li>Type normalization mapping</li>
<li>Voorkeursterm business rule</li>
<li>Deduplication safety guard</li>
</ul>

<p><strong>Extraction Strategy:</strong></p>
<ol>
<li>**Document transaction flow**:</li>
</ol>
<ul>
<li>  - Step-by-step SQL operations</li>
<li>  - Rollback conditions</li>
<li>  - Safety guards</li>
</ul>
<ol>
<li>**Extract type mapping** ‚Üí config</li>
<li>**Document voorkeursterm policy**:</li>
</ol>
<ul>
<li>  - Single source of truth rule</li>
<li>  - Update propagation logic</li>
</ul>

<p>---</p>

<h3>1.8 UI Rendering Business Logic - MIXED CONCERNS</h3>

<p><strong>Location:</strong> <code>src/ui/components/definition_generator_tab.py</code> (2,525 LOC, 60 methods)</p>

<p><strong>Business Logic Embedded in UI:</strong></p>

<h4>Rule Reasoning Logic (L1771-1835, ~180 LOC)</h4>
<p><strong>Hardcoded pass explanations for specific rules:</strong></p>
<pre><code># ARAI-001: Lengte check (50-500 chars)
if 50 &lt;= char_count &lt;= 500:
    return "Definitie valt binnen acceptabele lengterange (50-500 karakters)"

# CON-001: Begrip occurrence check
if begrip.lower() in text.lower():
    return f"Begrip '{begrip}' komt voor in de definitie"

# ESS-002: Structure check
if ":" in text or "is" in text.lower():
    return "Definitie heeft herkenbare structuur"

# INT-001: Abbreviation check
if not re.search(r'\b[A-Z]{2,}\b', text):
    return "Geen afkortingen gedetecteerd"

# SAM-001: Sentence count check
if sentence_count &lt;= 3:
    return f"Definitie is beknopt ({sentence_count} zinnen)"

# STR-001: Bullet/numbering check
if not re.search(r'[\‚Ä¢\-\*]\s|^\d+[\.\)]\s', text):
    return "Geen opsommingstekens of nummering"

# VER-001: Length adequacy
if 100 &lt;= char_count &lt;= 300:
    return "Definitie heeft adequate lengte voor begrip"</code></pre>

<p><strong>The Problem:</strong> Business rules for 7 different validation rules DUPLICATED in UI!</p>

<h4>Confidence Scoring Display (L223-228)</h4>
<p><strong>Hardcoded thresholds:</strong></p>
<pre><code>if confidence &gt; 0.8:
    color = "green"  # High confidence
elif confidence &gt; 0.5:
    color = "orange"  # Medium confidence
else:
    color = "red"     # Low confidence</code></pre>

<h4>Validation Stats Calculation (L1551-1574)</h4>
<p><strong>Aggregation logic:</strong></p>
<ul>
<li>Count violations by severity (high/medium/low)</li>
<li>Calculate total score (average? weighted?)</li>
<li>Format summary message</li>
</ul>

<p><strong>Extraction Complexity:</strong> HIGH</p>
<ul>
<li>Business logic spread across 60 methods</li>
<li>Hardcoded thresholds in 20+ locations</li>
<li>Rule logic duplicated from validation layer</li>
<li>Mixed rendering + calculation logic</li>
</ul>

<p><strong>Extraction Strategy:</strong></p>
<ol>
<li>**Extract ALL hardcoded thresholds** ‚Üí config file</li>
<li>**Extract rule reasoning logic** ‚Üí separate service (should use validation rule metadata!)</li>
<li>**Document confidence scoring** ‚Üí business rules document</li>
<li>**Extract validation stats algorithm** ‚Üí presentation service</li>
</ol>

<p>---</p>

<h3>1.9 Workflow & Status Management - IMPLICIT STATE MACHINE</h3>

<p><strong>Location:</strong> Multiple files</p>
<ul>
<li>`src/services/workflow_service.py`</li>
<li>`src/database/definitie_repository.py::change_status()`</li>
<li>Approval gate policy (EPIC-016)</li>
</ul>

<p><strong>Status Enum:</strong></p>
<pre><code>class DefinitieStatus(Enum):
    DRAFT = "ontwerp"
    IN_REVIEW = "ter_review"
    ESTABLISHED = "vastgesteld"
    ARCHIVED = "gearchiveerd"
    DEPRECATED = "deprecated"</code></pre>

<p><strong>Business Rules:</strong></p>
<ul>
<li>**Draft ‚Üí In Review**: Requires validation score ‚â• threshold (approval gate)</li>
<li>**In Review ‚Üí Established**: Requires approver, approval notes</li>
<li>**Established ‚Üí Archived**: Version number increment</li>
<li>**Any ‚Üí Draft**: Rollback allowed?</li>
</ul>

<p><strong>Approval Gate Policy (EPIC-016):</strong></p>
<ul>
<li>Mode: strict/lenient/custom</li>
<li>Thresholds: per-mode validation score requirements</li>
<li>Required fields: which fields must be filled for approval</li>
</ul>

<p><strong>Extraction Complexity:</strong> MEDIUM</p>
<ul>
<li>Status transitions are explicit</li>
<li>Approval gate policy is configurable (already extracted to DB/config)</li>
<li>Need to document implicit transition rules</li>
</ul>

<p><strong>Extraction Strategy:</strong></p>
<ol>
<li>**Create state machine diagram**:</li>
</ol>
<ul>
<li>  - States: 5 status values</li>
<li>  - Transitions: arrows with conditions</li>
<li>  - Guard conditions: approval gate, validation score</li>
</ul>
<ol>
<li>**Document approval gate**:</li>
</ol>
<ul>
<li>  - Policy modes and thresholds</li>
<li>  - Required field validation</li>
<li>  - Audit trail requirements</li>
</ul>
<ol>
<li>**Extract transition rules** ‚Üí config</li>
</ol>

<p>---</p>

<h3>1.10 Prompt Building & AI Integration - COMPLEX ORCHESTRATION</h3>

<p><strong>Location:</strong></p>
<ul>
<li>`src/services/prompts/prompt_service_v2.py`</li>
<li>`src/services/prompts/modular_prompt_builder.py`</li>
<li>`src/services/prompts/modules/` (20+ module files)</li>
</ul>

<p><strong>Known Issues:</strong></p>
<ul>
<li>**7,250 tokens** with duplications (from architecture docs)</li>
<li>**Modular prompt building** with context-aware templates</li>
<li>**Rule hints injection** from 46 validation rules</li>
</ul>

<p><strong>Business Logic:</strong></p>
<ul>
<li>Which rules to include in prompt (priority-based?)</li>
<li>How to format context (org/jur/wet)</li>
<li>Document context integration</li>
<li>Examples formatting</li>
<li>Temperature selection (varies by component per ConfigManager)</li>
</ul>

<p><strong>Extraction Complexity:</strong> MEDIUM</p>
<ul>
<li>Already modular</li>
<li>Needs documentation of orchestration</li>
<li>Token optimization knowledge</li>
<li>Rule selection algorithm</li>
</ul>

<p><strong>Extraction Strategy:</strong></p>
<ol>
<li>Read `prompt_service_v2.py` and `modular_prompt_builder.py`</li>
<li>Document module selection logic</li>
<li>Extract prompt templates (already in modules)</li>
<li>Document token optimization techniques</li>
</ol>

<p>---</p>

<h2>2. EXTRACTION PRIORITY MATRIX</h2>

<h3>2.1 MUST Extract (Critical Path - Week 1)</h3>

<p><strong>Priority 1: Validation Rules (Day 1-3)</strong></p>
<ul>
<li>**Why:** 46 rules are the CORE of quality assurance</li>
<li>**Risk:** Lose years of Dutch legal domain expertise</li>
<li>**Effort:** 3 days (analyze 46√ó2=92 files)</li>
<li>**Deliverable:** Validation Rules Catalog (CSV/JSON) + documentation per rule</li>
</ul>

<p><strong>Priority 2: Ontological Category Logic (Day 4)</strong></p>
<ul>
<li>**Why:** Hardcoded in 3 locations, critical for categorization</li>
<li>**Risk:** Lose categorization knowledge, patterns inconsistent</li>
<li>**Effort:** 1 day (extract patterns, create config, test)</li>
<li>**Deliverable:** `config/ontological_patterns.yaml` + algorithm docs</li>
</ul>

<p><strong>Priority 3: Definition Generation Orchestration (Day 5)</strong></p>
<ul>
<li>**Why:** 380 LOC god method is the CORE workflow</li>
<li>**Risk:** Lose orchestration knowledge, workflow breaks</li>
<li>**Effort:** 1 day (document 10-step workflow)</li>
<li>**Deliverable:** Workflow sequence diagram + state machine</li>
</ul>

<p>---</p>

<h3>2.2 SHOULD Extract (Important - Week 2)</h3>

<p><strong>Priority 4: Duplicate Detection (Day 6-7)</strong></p>
<ul>
<li>**Why:** Complex 3-stage algorithm with hardcoded threshold</li>
<li>**Risk:** Lose matching logic, false positives/negatives</li>
<li>**Effort:** 2 days (document algorithm, extract threshold, test)</li>
<li>**Deliverable:** Algorithm flowchart + threshold config</li>
</ul>

<p><strong>Priority 5: Regeneration Workflows (Day 8-9)</strong></p>
<ul>
<li>**Why:** State machine for category changes</li>
<li>**Risk:** Lose regeneration logic, state transitions break</li>
<li>**Effort:** 2 days (document state machine, extract rules)</li>
<li>**Deliverable:** State machine diagram + transition rules</li>
</ul>

<p><strong>Priority 6: Voorbeelden Persistence (Day 10)</strong></p>
<ul>
<li>**Why:** Complex transaction with type normalization</li>
<li>**Risk:** Lose normalization mapping, voorkeursterm policy</li>
<li>**Effort:** 1 day (document transaction, extract mapping)</li>
<li>**Deliverable:** Transaction flow diagram + type mapping config</li>
</ul>

<p>---</p>

<h3>2.3 CAN Extract (Nice-to-Have - Week 3)</h3>

<p><strong>Priority 7: UI Hardcoded Logic (Day 11-12)</strong></p>
<ul>
<li>**Why:** Hardcoded thresholds and rule reasoning</li>
<li>**Risk:** Lose threshold values, duplicated logic</li>
<li>**Effort:** 2 days (extract all hardcoded values)</li>
<li>**Deliverable:** Thresholds config + hardcoded logic inventory</li>
</ul>

<p><strong>Priority 8: Workflow Status Management (Day 13)</strong></p>
<ul>
<li>**Why:** Status transitions and approval gate</li>
<li>**Risk:** Lose workflow rules (but already documented in EPIC-016)</li>
<li>**Effort:** 1 day (document state machine)</li>
<li>**Deliverable:** Workflow state machine diagram</li>
</ul>

<p><strong>Priority 9: Prompt Building (Day 14-15)</strong></p>
<ul>
<li>**Why:** Prompt orchestration and module selection</li>
<li>**Risk:** Low (already modular), but lose orchestration knowledge</li>
<li>**Effort:** 2 days (document module selection logic)</li>
<li>**Deliverable:** Prompt orchestration documentation</li>
</ul>

<p>---</p>

<h3>2.4 CAN SKIP (Can Rebuild)</h3>

<p><strong>Database Schema</strong> - Already in <code>src/database/schema.sql</code> ‚úÖ</p>
<p><strong>Service Interfaces</strong> - Already documented in <code>src/services/interfaces.py</code> ‚úÖ</p>
<p><strong>Test Data</strong> - 42 definitions exportable via JSON ‚úÖ</p>
<p><strong>Configuration Files</strong> - Already in <code>config/</code> directory ‚úÖ</p>
<p><strong>Unused Code</strong> - 65% unused (119/182 files) ‚Üí skip! ‚úÖ</p>

<p>---</p>

<h2>3. EXTRACTION TIMELINE (2-3 Weeks)</h2>

<h3>Week 1: CRITICAL PATH (Must-Have)</h3>
<pre><code>Day 1-2: Validation Rules Extraction
  - Analyze 46 rules (JSON + Python)
  - Document business logic per rule
  - Extract patterns, thresholds, examples
  - Create Validation Rules Catalog
  Deliverable: validation_rules_catalog.csv + docs/

Day 3: Validation Rules Testing
  - Test against 42 existing definitions
  - Verify all rules work correctly
  - Document edge cases
  Deliverable: validation_test_results.md

Day 4: Ontological Category Logic
  - Extract hardcoded patterns (3 locations)
  - Create config/ontological_patterns.yaml
  - Document 6-step protocol
  - Test against 42 definitions
  Deliverable: ontological_patterns.yaml + algorithm_docs.md

Day 5: Definition Generation Orchestration
  - Document 380 LOC god method
  - Create sequence diagram (10 steps)
  - Extract business rules
  - Create state machine diagram
  Deliverable: generation_orchestration_workflow.md + diagrams/</code></pre>

<p><strong>Week 1 Checkpoint:</strong></p>
<ul>
<li>‚úÖ 46 validation rules documented</li>
<li>‚úÖ Ontological patterns extracted to config</li>
<li>‚úÖ Generation workflow documented</li>
<li>**GO/NO-GO:** Can we rebuild validation + generation? If NO, spend Week 2 on deeper extraction.</li>
</ul>

<p>---</p>

<h3>Week 2: IMPORTANT LOGIC (Should-Have)</h3>
<pre><code>Day 6-7: Duplicate Detection
  - Document 3-stage matching algorithm
  - Extract 70% threshold to config
  - Create flowchart
  - Test against 42 definitions (find all duplicates)
  Deliverable: duplicate_detection_algorithm.md + threshold config

Day 8-9: Regeneration Workflows
  - Document state machine (Draft ‚Üí Regenerating ‚Üí Generated)
  - Extract category change impact analysis
  - Create transition rules
  - Test regeneration paths
  Deliverable: regeneration_state_machine.md + transition_rules.yaml

Day 10: Voorbeelden Persistence
  - Document transaction flow
  - Extract type normalization mapping
  - Document voorkeursterm single source policy
  - Test voorbeelden save/retrieve
  Deliverable: voorbeelden_transaction_flow.md + type_mapping.yaml</code></pre>

<p><strong>Week 2 Checkpoint:</strong></p>
<ul>
<li>‚úÖ Duplicate detection algorithm documented</li>
<li>‚úÖ Regeneration state machine extracted</li>
<li>‚úÖ Voorbeelden logic documented</li>
<li>**GO/NO-GO:** Is all critical business logic extracted? If YES, Week 3 is polish. If NO, extend extraction.</li>
</ul>

<p>---</p>

<h3>Week 3: POLISH & VALIDATION (Can-Have)</h3>
<pre><code>Day 11-12: UI Hardcoded Logic Extraction
  - Extract all hardcoded thresholds (confidence: 0.8/0.5, lengths: 50-500, etc.)
  - Extract rule reasoning logic (7 rules duplicated in UI)
  - Create thresholds.yaml config
  Deliverable: ui_hardcoded_logic_inventory.md + thresholds.yaml

Day 13: Workflow Status Management
  - Document status state machine (5 states)
  - Extract transition conditions
  - Document approval gate policy (already in EPIC-016)
  Deliverable: workflow_state_machine.md

Day 14-15: Prompt Building Documentation
  - Document prompt module selection
  - Extract prompt orchestration logic
  - Document token optimization techniques
  Deliverable: prompt_orchestration_docs.md

Day 16: FINAL VALIDATION
  - Run all 42 test definitions through extraction
  - Verify NO business logic lost
  - Create completeness checklist
  Deliverable: extraction_completeness_report.md</code></pre>

<p><strong>Week 3 Checkpoint:</strong></p>
<ul>
<li>‚úÖ ALL critical business logic extracted</li>
<li>‚úÖ 42 test definitions validate extraction</li>
<li>‚úÖ Documentation complete</li>
<li>**READY FOR REBUILD:** Proceed to EPIC-026 Phase 2 (Implementation)</li>
</ul>

<p>---</p>

<h2>4. DOCUMENTATION TEMPLATES</h2>

<h3>4.1 Validation Rule Documentation Template</h3>

<p><strong>File:</strong> <code>docs/business-logic/validation-rules/{RULE-ID}.md</code></p>

<pre><code># Validation Rule: {RULE-ID} - {Rule Name}

## Metadata
- **ID:** {RULE-ID}
- **Category:** ARAI|CON|ESS|INT|SAM|STR|VER|DUP
- **Priority:** high|medium|low
- **Status:** active|deprecated
- **ASTRA Link:** {URL}

## Business Purpose
**What:** {What does this rule check?}
**Why:** {Why is this important?}
**When:** {When is this rule applied?}

## Implementation Logic

### Validation Algorithm</code></pre>
<h1>Pseudocode or actual implementation</h1>
<p>def validate(definitie, begrip, context):</p>
<p>    # Step 1: ...</p>
<p>    # Step 2: ...</p>
<p>    # Return: (pass/fail, message, score)</p>
<pre><code>
### Thresholds
- **Threshold 1:** {value} - {rationale}
- **Threshold 2:** {value} - {rationale}

### Patterns
- **Pattern 1:** `{regex}` - detects {what}
- **Pattern 2:** `{regex}` - detects {what}

## Examples

### Good Examples
1. `{example 1}` - passes because {reason}
2. `{example 2}` - passes because {reason}

### Bad Examples
1. `{example 1}` - fails because {reason}
2. `{example 2}` - fails because {reason}

## Generation Hints
- Hint 1: {instruction for AI}
- Hint 2: {instruction for AI}

## Test Cases
- Test 1: {input} ‚Üí {expected output}
- Test 2: {input} ‚Üí {expected output}

## Dependencies
- Depends on rules: {RULE-ID1, RULE-ID2}
- Used by: {services/components}

## References
- ASTRA: {link}
- Related docs: {links}</code></pre>

<p>---</p>

<h3>4.2 Workflow Documentation Template</h3>

<p><strong>File:</strong> <code>docs/business-logic/workflows/{workflow-name}.md</code></p>

<pre><code># Workflow: {Workflow Name}

## Overview
**Purpose:** {What does this workflow accomplish?}
**Trigger:** {What starts this workflow?}
**Outcome:** {What is the end result?}

## Workflow Diagram</code></pre>
<p>sequenceDiagram</p>
<p>    participant User</p>
<p>    participant UI</p>
<p>    participant Service1</p>
<p>    participant Service2</p>
<p>    participant Database</p>

<p>    User->>UI: Action</p>
<p>    UI->>Service1: Request</p>
<p>    Service1->>Service2: Process</p>
<p>    Service2->>Database: Store</p>
<p>    Database-->>Service2: Confirm</p>
<p>    Service2-->>Service1: Result</p>
<p>    Service1-->>UI: Response</p>
<p>    UI-->>User: Display</p>
<pre><code>
## Steps

### Step 1: {Step Name}
**Action:** {What happens}
**Business Rule:** {Any rules applied}
**Error Handling:** {What if this fails?}

### Step 2: {Step Name}
**Action:** {What happens}
**Business Rule:** {Any rules applied}
**Error Handling:** {What if this fails?}

[Repeat for all steps...]

## State Machine</code></pre>
<p>stateDiagram-v2</p>
<p>    [*] --> State1</p>
<p>    State1 --> State2 : Condition</p>
<p>    State2 --> State3 : Condition</p>
<p>    State3 --> [*]</p>
<pre><code>
## Business Rules
1. **Rule 1:** {description} - {rationale}
2. **Rule 2:** {description} - {rationale}

## Service Dependencies
- Service 1: {purpose}
- Service 2: {purpose}

## Data Flow
**Input:** {what data comes in}
**Processing:** {what transformations occur}
**Output:** {what data goes out}

## Error Paths
- **Error 1:** {condition} ‚Üí {handling}
- **Error 2:** {condition} ‚Üí {handling}

## Performance Considerations
- **Expected Duration:** {time}
- **Bottlenecks:** {where}
- **Optimization:** {how}

## Test Scenarios
1. **Happy Path:** {description}
2. **Error Path 1:** {description}
3. **Edge Case 1:** {description}</code></pre>

<p>---</p>

<h3>4.3 Business Rules Catalog Template</h3>

<p><strong>File:</strong> <code>docs/business-logic/business_rules_catalog.csv</code></p>

<pre><code>Rule ID,Category,Type,Description,Location,Threshold,Rationale,Test Case,Status
BR-001,Validation,Length,Definition length check,ARAI-01,50-500 chars,Readability,42 definitions,Active
BR-002,Categorization,Pattern,Type pattern matching,tabbed_interface.py L355,"'document','bewijs'",Ontology,Test suite,Active
BR-003,Duplication,Similarity,Jaccard similarity threshold,definitie_repository.py L192,70%,Balance precision/recall,Duplicate tests,Active
[...]</code></pre>

<p>---</p>

<h3>4.4 Hardcoded Logic Inventory Template</h3>

<p><strong>File:</strong> <code>docs/business-logic/hardcoded_logic_inventory.md</code></p>

<pre><code># Hardcoded Logic Inventory

## Overview
**Total Locations:** {count}
**Priority:** Critical|High|Medium|Low
**Extraction Status:** {percentage complete}

## 1. Thresholds

### Confidence Scoring
- **Location:** `src/ui/components/definition_generator_tab.py` L223-228
- **Values:**
  - High confidence: &gt; 0.8 (green)
  - Medium confidence: 0.5-0.8 (orange)
  - Low confidence: &lt; 0.5 (red)
- **Rationale:** User experience - color-coded feedback
- **Extraction:** ‚Üí `config/ui_thresholds.yaml`

### Length Checks
- **Location:** Multiple (ARAI-01, VER-01, SAM-01)
- **Values:**
  - Min length: 50 chars
  - Max length: 500 chars
  - Optimal: 100-300 chars
- **Rationale:** Readability and completeness
- **Extraction:** ‚Üí `config/validation_thresholds.yaml`

[Repeat for all hardcoded logic...]

## 2. Pattern Definitions

### Ontological Patterns
- **Location:** `src/ui/tabbed_interface.py` L354-405 (DUPLICATED 3x!)
- **Patterns:** {list patterns}
- **Extraction:** ‚Üí `config/ontological_patterns.yaml`

[...]

## 3. Business Rule Duplications

### Rule Reasoning Logic
- **Location:** `src/ui/components/definition_generator_tab.py` L1771-1835
- **Duplicates:** 7 validation rules logic duplicated in UI
- **Impact:** Inconsistency risk, maintenance burden
- **Extraction:** ‚Üí Use validation rule metadata instead

[...]

## 4. Magic Numbers

### Database Timeouts
- **Location:** `src/database/definitie_repository.py` L72
- **Value:** 30.0 seconds
- **Rationale:** SQLite lock timeout
- **Extraction:** ‚Üí `config/database.yaml`

[...]</code></pre>

<p>---</p>

<h2>5. VALIDATION APPROACH - How to Verify Completeness</h2>

<h3>5.1 Test Data Strategy</h3>

<p><strong>Baseline:</strong> 42 existing definitions in <code>data/definities.db</code></p>

<p><strong>Export Baseline:</strong></p>
<pre><code># Export all 42 definitions to JSON
python -c "
from database.definitie_repository import get_definitie_repository
import json

repo = get_definitie_repository()
definitions = repo.search_definities(query='', limit=100)

baseline = {
    'export_date': '2025-10-02',
    'count': len(definitions),
    'definitions': [d.to_dict() for d in definitions]
}

with open('docs/business-logic/baseline_42_definitions.json', 'w') as f:
    json.dump(baseline, f, indent=2, ensure_ascii=False)
"</code></pre>

<p><strong>Use Cases:</strong></p>
<ol>
<li>**Validation Testing:** Run all 46 rules against 42 definitions ‚Üí baseline results</li>
<li>**Category Testing:** Verify ontological categorization for all 42</li>
<li>**Duplicate Testing:** Find all duplicate pairs in 42 definitions</li>
<li>**Regeneration Testing:** Regenerate all 42, compare outputs</li>
</ol>

<p>---</p>

<h3>5.2 Output Comparison Approach</h3>

<p><strong>Strategy:</strong> Extract logic ‚Üí Rebuild service ‚Üí Compare outputs</p>

<p><strong>Comparison Test:</strong></p>
<pre><code># Test framework
def test_extraction_completeness():
    # Load baseline
    baseline = load_baseline_42_definitions()

    # Run OLD system
    old_results = run_old_validation(baseline)

    # Run NEW rebuilt system (using extracted logic)
    new_results = run_new_validation(baseline)

    # Compare results
    for i, (old, new) in enumerate(zip(old_results, new_results)):
        assert old['score'] == new['score'], f"Definition {i}: score mismatch"
        assert old['violations'] == new['violations'], f"Definition {i}: violations mismatch"
        assert old['category'] == new['category'], f"Definition {i}: category mismatch"

    print("‚úÖ All 42 definitions: extraction complete, no logic lost")</code></pre>

<p><strong>Metrics:</strong></p>
<ul>
<li>**Score match rate:** % of definitions with identical validation score</li>
<li>**Violation match rate:** % of definitions with identical violations</li>
<li>**Category match rate:** % of definitions with identical ontological category</li>
<li>**Success:** 100% match rate across all 42 definitions</li>
</ul>

<p>---</p>

<h3>5.3 Edge Cases to Document</h3>

<p><strong>Category 1: Validation Edge Cases</strong></p>
<ol>
<li>**Boundary values**: Definitions at exactly 50 chars, 500 chars</li>
<li>**Regex edge cases**: Special characters, Unicode, emojis</li>
<li>**Multi-language**: Dutch with foreign terms, abbreviations</li>
<li>**Empty fields**: Missing context, empty voorbeelden</li>
</ol>

<p><strong>Category 2: Workflow Edge Cases</strong></p>
<ol>
<li>**Status transitions**: Rollback from Established to Draft (allowed?)</li>
<li>**Concurrent edits**: Two users editing same definition</li>
<li>**Regeneration loops**: Regenerate ‚Üí Regenerate ‚Üí Regenerate</li>
<li>**Approval gate**: Score exactly at threshold (pass or fail?)</li>
</ol>

<p><strong>Category 3: Data Edge Cases</strong></p>
<ol>
<li>**Duplicate detection**: 99.9% similar vs 70% threshold</li>
<li>**Context matching**: org=[A,B] vs org=[B,A] (order matters?)</li>
<li>**Voorkeursterm**: Null vs empty string vs missing</li>
<li>**Unicode handling**: Emoji in begrip, special chars</li>
</ol>

<p><strong>Documentation:</strong></p>
<ul>
<li>Create `docs/business-logic/edge_cases.md`</li>
<li>Test each edge case against OLD system</li>
<li>Document expected behavior</li>
<li>Verify NEW system matches</li>
</ul>

<p>---</p>

<h3>5.4 Extraction Completeness Checklist</h3>

<p><strong>Use this checklist at end of Week 3:</strong></p>

<h4>Validation Rules (46 rules)</h4>
<ul>
<li>[ ] All 46 rules documented with template</li>
<li>[ ] All patterns extracted to config</li>
<li>[ ] All thresholds documented with rationale</li>
<li>[ ] All examples (good/bad) captured</li>
<li>[ ] All ASTRA links preserved</li>
<li>[ ] Generation hints extracted</li>
<li>[ ] Test suite covers all 46 rules</li>
<li>[ ] Baseline: 42 definitions validation results match</li>
</ul>

<h4>Ontological Category Logic</h4>
<ul>
<li>[ ] 6-step protocol documented</li>
<li>[ ] Fallback chain documented (6-step ‚Üí quick ‚Üí legacy)</li>
<li>[ ] Patterns extracted to config (no duplication)</li>
<li>[ ] Scoring algorithm documented</li>
<li>[ ] Reasoning generation logic extracted</li>
<li>[ ] Test suite covers all 4 categories</li>
<li>[ ] Baseline: 42 definitions category match</li>
</ul>

<h4>Generation Orchestration</h4>
<ul>
<li>[ ] 10-step workflow sequence diagram created</li>
<li>[ ] All business rules extracted (context validation, snippet extraction, etc.)</li>
<li>[ ] Service interaction diagram created</li>
<li>[ ] State machine documented</li>
<li>[ ] Error paths documented</li>
<li>[ ] Integration test suite created</li>
<li>[ ] Baseline: 42 definitions regeneration match</li>
</ul>

<h4>Duplicate Detection</h4>
<ul>
<li>[ ] 3-stage algorithm flowchart created</li>
<li>[ ] Jaccard similarity formula documented</li>
<li>[ ] 70% threshold extracted to config</li>
<li>[ ] Normalization logic documented</li>
<li>[ ] Test suite covers exact/synonym/fuzzy matches</li>
<li>[ ] Baseline: All duplicate pairs found in 42 definitions</li>
</ul>

<h4>Regeneration Workflows</h4>
<ul>
<li>[ ] State machine diagram created</li>
<li>[ ] Category change impact analysis documented</li>
<li>[ ] Transition rules extracted</li>
<li>[ ] Context preservation logic documented</li>
<li>[ ] Rollback paths documented</li>
<li>[ ] Test suite covers all transitions</li>
<li>[ ] Baseline: Regeneration results match</li>
</ul>

<h4>Voorbeelden Persistence</h4>
<ul>
<li>[ ] Transaction flow diagram created</li>
<li>[ ] Type normalization mapping extracted</li>
<li>[ ] Voorkeursterm policy documented</li>
<li>[ ] Deduplication logic documented</li>
<li>[ ] Test suite covers save/retrieve/delete</li>
<li>[ ] Baseline: Voorbeelden data integrity verified</li>
</ul>

<h4>UI Hardcoded Logic</h4>
<ul>
<li>[ ] All thresholds extracted to config</li>
<li>[ ] All hardcoded patterns removed</li>
<li>[ ] All magic numbers documented</li>
<li>[ ] Duplicated logic identified and extracted</li>
<li>[ ] Config files created for all hardcoded values</li>
</ul>

<h4>Workflow Status Management</h4>
<ul>
<li>[ ] Status state machine diagram created</li>
<li>[ ] Transition conditions documented</li>
<li>[ ] Approval gate policy referenced (EPIC-016)</li>
<li>[ ] Audit trail requirements documented</li>
</ul>

<h4>Prompt Building</h4>
<ul>
<li>[ ] Prompt orchestration documented</li>
<li>[ ] Module selection logic documented</li>
<li>[ ] Token optimization techniques documented</li>
<li>[ ] Template extraction verified</li>
</ul>

<h4>Final Validation</h4>
<ul>
<li>[ ] All 42 baseline definitions exported</li>
<li>[ ] All business rules cataloged</li>
<li>[ ] All workflows documented</li>
<li>[ ] All hardcoded logic inventoried</li>
<li>[ ] Extraction completeness report created</li>
<li>[ ] **100% match rate** on all baseline tests</li>
</ul>

<p>---</p>

<h2>6. RISK MITIGATION</h2>

<h3>6.1 What Could Go Wrong?</h3>

<p><strong>Risk 1: Incomplete Extraction</strong></p>
<ul>
<li>**Symptom:** Rebuild fails because missing business rule</li>
<li>**Cause:** Logic hidden in unexpected location (e.g., UI helper function)</li>
<li>**Mitigation:**</li>
<li> - Grep for ALL hardcoded patterns: `HARDCODED|TODO|FIXME|pattern|threshold|magic`</li>
<li> - Cross-reference all 42 test definitions</li>
<li> - Code review by 2nd developer</li>
<li>**Contingency:** Week 4 buffer for deep-dive extraction</li>
</ul>

<p><strong>Risk 2: Business Logic Ambiguity</strong></p>
<ul>
<li>**Symptom:** Extracted logic doesn't specify exact behavior</li>
<li>**Cause:** Implicit assumptions, undocumented edge cases</li>
<li>**Mitigation:**</li>
<li> - Test EVERY edge case against OLD system</li>
<li> - Document "ask the business" questions</li>
<li> - Create decision log for ambiguous cases</li>
<li>**Contingency:** Stakeholder interviews to clarify business intent</li>
</ul>

<p><strong>Risk 3: Performance Knowledge Loss</strong></p>
<ul>
<li>**Symptom:** Rebuilt system is slower than original</li>
<li>**Cause:** Didn't extract optimization techniques (e.g., caching, indexing)</li>
<li>**Mitigation:**</li>
<li> - Profile OLD system performance</li>
<li> - Document all caching strategies</li>
<li> - Document database indexes and query optimization</li>
<li>**Contingency:** Performance tuning sprint after rebuild</li>
</ul>

<p><strong>Risk 4: Test Data Insufficiency</strong></p>
<ul>
<li>**Symptom:** 42 definitions don't cover all edge cases</li>
<li>**Cause:** Limited production data</li>
<li>**Mitigation:**</li>
<li> - Generate synthetic test cases for edge cases</li>
<li> - Use AI to create boundary-value definitions</li>
<li> - Document which edge cases are NOT covered by test data</li>
<li>**Contingency:** Create additional 50+ synthetic test definitions</li>
</ul>

<p><strong>Risk 5: Domain Knowledge Loss</strong></p>
<ul>
<li>**Symptom:** Dutch legal expertise not captured in docs</li>
<li>**Cause:** Tacit knowledge in original developer's head</li>
<li>**Mitigation:**</li>
<li> - Interview original developer (if available)</li>
<li> - Capture ALL ASTRA references</li>
<li> - Document legal reasoning behind each rule</li>
<li>**Contingency:** Hire Dutch legal consultant for review</li>
</ul>

<p><strong>Risk 6: Time Overrun</strong></p>
<ul>
<li>**Symptom:** Extraction takes > 3 weeks</li>
<li>**Cause:** Underestimated complexity</li>
<li>**Mitigation:**</li>
<li> - Daily progress tracking</li>
<li> - Week 1 checkpoint: if <50% done, escalate</li>
<li> - Prioritize MUST-extract items only</li>
<li>**Contingency:** Extend to 4-5 weeks, cut CAN-skip items</li>
</ul>

<p>---</p>

<h3>6.2 Quality Gates</h3>

<p><strong>Gate 1: End of Week 1</strong></p>
<ul>
<li>**Criteria:**</li>
<li> - ‚úÖ 46 validation rules documented</li>
<li> - ‚úÖ Ontological patterns extracted</li>
<li> - ‚úÖ Generation workflow documented</li>
<li>**Decision:** GO to Week 2 or EXTEND Week 1?</li>
</ul>

<p><strong>Gate 2: End of Week 2</strong></p>
<ul>
<li>**Criteria:**</li>
<li> - ‚úÖ Duplicate detection documented</li>
<li> - ‚úÖ Regeneration state machine created</li>
<li> - ‚úÖ Voorbeelden logic extracted</li>
<li>**Decision:** GO to Week 3 or EXTEND Week 2?</li>
</ul>

<p><strong>Gate 3: End of Week 3</strong></p>
<ul>
<li>**Criteria:**</li>
<li> - ‚úÖ All MUST + SHOULD items extracted</li>
<li> - ‚úÖ 42 baseline definitions pass validation</li>
<li> - ‚úÖ 100% match rate on outputs</li>
<li> - ‚úÖ Extraction completeness checklist 100%</li>
<li>**Decision:** READY for rebuild or EXTEND extraction?</li>
</ul>

<p>---</p>

<h3>6.3 Rollback Plan</h3>

<p><strong>If extraction fails or is incomplete:</strong></p>

<p><strong>Option A: Gradual Migration</strong></p>
<ul>
<li>Extract what we can</li>
<li>Keep OLD system running alongside NEW</li>
<li>Migrate piece-by-piece (validation first, then generation, etc.)</li>
<li>Dual-run both systems for 3 months</li>
</ul>

<p><strong>Option B: Hybrid Approach</strong></p>
<ul>
<li>Rebuild NEW services for clean parts (e.g., validation rules)</li>
<li>Wrap OLD services in adapters for complex parts (e.g., generation orchestration)</li>
<li>Strangler fig pattern - gradually replace old with new</li>
</ul>

<p><strong>Option C: Extend Extraction Timeline</strong></p>
<ul>
<li>If Week 3 gate fails, extend to 4-5 weeks</li>
<li>Add dedicated domain expert for consultation</li>
<li>Create more comprehensive test suite (100+ definitions)</li>
</ul>

<p>---</p>

<h2>7. DELIVERABLES - What We Produce</h2>

<h3>7.1 Documentation Deliverables</h3>

<p><strong>Directory Structure:</strong></p>
<pre><code>docs/business-logic/
‚îú‚îÄ‚îÄ README.md                              # Overview of all extracted logic
‚îú‚îÄ‚îÄ extraction_completeness_report.md      # Final validation report
‚îú‚îÄ‚îÄ baseline_42_definitions.json           # Test data export
‚îú‚îÄ‚îÄ edge_cases.md                          # All edge case documentation
‚îú‚îÄ‚îÄ business_rules_catalog.csv             # Master catalog of all rules
‚îú‚îÄ‚îÄ hardcoded_logic_inventory.md           # All hardcoded values
‚îÇ
‚îú‚îÄ‚îÄ validation-rules/                      # 46 rule documentation files
‚îÇ   ‚îú‚îÄ‚îÄ ARAI-01.md
‚îÇ   ‚îú‚îÄ‚îÄ ARAI-02.md
‚îÇ   ‚îú‚îÄ‚îÄ ...
‚îÇ   ‚îú‚îÄ‚îÄ VER-03.md
‚îÇ   ‚îî‚îÄ‚îÄ rules_summary.md
‚îÇ
‚îú‚îÄ‚îÄ workflows/                             # Workflow documentation
‚îÇ   ‚îú‚îÄ‚îÄ definition_generation.md
‚îÇ   ‚îú‚îÄ‚îÄ regeneration.md
‚îÇ   ‚îú‚îÄ‚îÄ duplicate_detection.md
‚îÇ   ‚îú‚îÄ‚îÄ approval_workflow.md
‚îÇ   ‚îî‚îÄ‚îÄ voorbeelden_persistence.md
‚îÇ
‚îú‚îÄ‚îÄ algorithms/                            # Algorithm specifications
‚îÇ   ‚îú‚îÄ‚îÄ ontological_categorization.md
‚îÇ   ‚îú‚îÄ‚îÄ duplicate_matching.md
‚îÇ   ‚îú‚îÄ‚îÄ validation_scoring.md
‚îÇ   ‚îî‚îÄ‚îÄ similarity_calculation.md
‚îÇ
‚îî‚îÄ‚îÄ diagrams/                              # Visual documentation
    ‚îú‚îÄ‚îÄ generation_sequence.mmd            # Mermaid diagrams
    ‚îú‚îÄ‚îÄ regeneration_state_machine.mmd
    ‚îú‚îÄ‚îÄ workflow_status_transitions.mmd
    ‚îú‚îÄ‚îÄ service_interactions.mmd
    ‚îî‚îÄ‚îÄ duplicate_detection_flow.mmd</code></pre>

<h3>7.2 Configuration Deliverables</h3>

<p><strong>New Config Files:</strong></p>
<pre><code>config/
‚îú‚îÄ‚îÄ ontological_patterns.yaml              # Extracted category patterns
‚îú‚îÄ‚îÄ validation_thresholds.yaml             # All validation thresholds
‚îú‚îÄ‚îÄ ui_thresholds.yaml                     # UI display thresholds
‚îú‚îÄ‚îÄ duplicate_detection.yaml               # Similarity thresholds
‚îú‚îÄ‚îÄ voorbeelden_type_mapping.yaml          # Type normalization
‚îú‚îÄ‚îÄ workflow_transitions.yaml              # Status transition rules
‚îî‚îÄ‚îÄ hardcoded_values.yaml                  # All extracted magic numbers</code></pre>

<h3>7.3 Test Suite Deliverables</h3>

<p><strong>Test Files:</strong></p>
<pre><code>tests/business-logic/
‚îú‚îÄ‚îÄ test_validation_rules_baseline.py      # 46 rules √ó 42 definitions
‚îú‚îÄ‚îÄ test_ontological_categorization.py     # Category matching baseline
‚îú‚îÄ‚îÄ test_duplicate_detection.py            # Duplicate pairs detection
‚îú‚îÄ‚îÄ test_generation_workflow.py            # End-to-end generation
‚îú‚îÄ‚îÄ test_regeneration_workflow.py          # Regeneration scenarios
‚îú‚îÄ‚îÄ test_voorbeelden_persistence.py        # Examples CRUD operations
‚îú‚îÄ‚îÄ test_edge_cases.py                     # All documented edge cases
‚îî‚îÄ‚îÄ test_extraction_completeness.py        # Final validation suite</code></pre>

<h3>7.4 Data Deliverables</h3>

<p><strong>Baseline Data:</strong></p>
<pre><code>data/baseline/
‚îú‚îÄ‚îÄ 42_definitions.json                    # Full export of 42 definitions
‚îú‚îÄ‚îÄ validation_results_baseline.json       # OLD system validation results
‚îú‚îÄ‚îÄ categorization_baseline.json           # OLD system category assignments
‚îú‚îÄ‚îÄ duplicate_pairs_baseline.json          # OLD system duplicate detection
‚îî‚îÄ‚îÄ regeneration_outputs_baseline.json     # OLD system regeneration results</code></pre>

<h3>7.5 Final Report</h3>

<p><strong>File:</strong> <code>docs/business-logic/EXTRACTION_COMPLETENESS_REPORT.md</code></p>

<p><strong>Contents:</strong></p>
<pre><code># Business Logic Extraction - Completeness Report

## Executive Summary
- **Extraction Duration:** {X weeks}
- **Business Rules Extracted:** {count}
- **Workflows Documented:** {count}
- **Algorithms Specified:** {count}
- **Test Coverage:** {percentage}
- **Baseline Match Rate:** {percentage}

## Extraction Statistics
### Validation Rules
- Total rules: 46
- Documented: 46 (100%)
- Patterns extracted: {count}
- Thresholds extracted: {count}
- Test coverage: {percentage}

[Repeat for all categories...]

## Validation Results
### Baseline Testing
- Total test definitions: 42
- Validation match rate: {percentage}
- Category match rate: {percentage}
- Duplicate detection match rate: {percentage}

### Edge Case Coverage
- Total edge cases identified: {count}
- Documented: {count}
- Tested: {count}
- Coverage: {percentage}

## Quality Metrics
- Documentation completeness: {percentage}
- Configuration extraction: {percentage}
- Test suite coverage: {percentage}
- Baseline match rate: {percentage}

## Risks &amp; Gaps
### Known Gaps
1. {Gap 1 description} - {mitigation}
2. {Gap 2 description} - {mitigation}

### Ambiguous Business Logic
1. {Ambiguity 1} - {decision made}
2. {Ambiguity 2} - {decision made}

### Assumptions Made
1. {Assumption 1} - {rationale}
2. {Assumption 2} - {rationale}

## Recommendations
1. {Recommendation 1}
2. {Recommendation 2}

## Sign-Off
- **Extraction Lead:** {name}
- **Reviewer:** {name}
- **Date:** {date}
- **Status:** READY FOR REBUILD ‚úÖ</code></pre>

<p>---</p>

<h2>8. SUCCESS CRITERIA</h2>

<h3>8.1 Extraction Success = READY FOR REBUILD</h3>

<p><strong>Minimum Acceptable Criteria (MAC):</strong></p>
<ol>
<li>‚úÖ **100% of MUST-extract items** documented (validation rules, categorization, generation orchestration)</li>
<li>‚úÖ **90%+ of SHOULD-extract items** documented (duplicate detection, regeneration, voorbeelden)</li>
<li>‚úÖ **42 baseline definitions** - 100% match rate on validation scores</li>
<li>‚úÖ **42 baseline definitions** - 100% match rate on ontological categories</li>
<li>‚úÖ **All workflows** documented with sequence diagrams</li>
<li>‚úÖ **All hardcoded thresholds** extracted to config</li>
<li>‚úÖ **All business rules** cataloged in CSV</li>
<li>‚úÖ **Test suite** created covering all extracted logic</li>
</ol>

<p><strong>Optimal Criteria (IDEAL):</strong></p>
<ol>
<li>‚úÖ **100% of MUST + SHOULD items** documented</li>
<li>‚úÖ **50%+ of CAN-extract items** documented</li>
<li>‚úÖ **100+ test definitions** (42 baseline + 58 synthetic)</li>
<li>‚úÖ **All edge cases** documented and tested</li>
<li>‚úÖ **Performance benchmarks** documented</li>
<li>‚úÖ **Domain expert review** completed</li>
<li>‚úÖ **Extraction completeness report** approved by stakeholders</li>
</ol>

<p>---</p>

<h3>8.2 Definition of DONE</h3>

<p><strong>Extraction Phase is DONE when:</strong></p>
<ol>
<li>All deliverables created (docs, configs, tests, baselines)</li>
<li>All quality gates passed (Week 1, Week 2, Week 3)</li>
<li>Extraction completeness checklist 100%</li>
<li>Baseline match rate ‚â• 95% (allow 5% for edge case differences)</li>
<li>Code review completed by 2nd developer</li>
<li>Stakeholder sign-off obtained</li>
<li>**Rebuild team confirms:** "We have enough information to rebuild"</li>
</ol>

<p>---</p>

<h2>9. NEXT STEPS AFTER EXTRACTION</h2>

<h3>Phase 2: Implementation (Week 4-8)</h3>
<p>Once extraction is complete, proceed to EPIC-026 Phase 2:</p>
<ol>
<li>**Week 4-5:** Rebuild validation service using extracted rules</li>
<li>**Week 6-7:** Rebuild generation orchestrator using workflow docs</li>
<li>**Week 8:** Integration testing with baseline 42 definitions</li>
</ol>

<h3>Handoff Checklist</h3>
<ul>
<li>[ ] All extraction deliverables reviewed</li>
<li>[ ] Baseline test suite passing</li>
<li>[ ] Configuration files validated</li>
<li>[ ] Documentation complete</li>
<li>[ ] Rebuild team trained on extracted logic</li>
<li>[ ] **GO decision:** Proceed to Phase 2 Implementation</li>
</ul>

<p>---</p>

<h2>10. CONCLUSION</h2>

<h3>Why This Plan is Critical</h3>

<p><strong>DefinitieAgent contains 83,319 LOC of business logic</strong> - much of it implicit, hardcoded, and undocumented. A naive rebuild will:</p>
<ul>
<li>‚ùå Lose validation rules (46 rules with domain expertise)</li>
<li>‚ùå Lose categorization logic (hardcoded patterns in 3 locations)</li>
<li>‚ùå Lose orchestration workflows (880+ LOC hidden in god methods)</li>
<li>‚ùå Lose business thresholds (70% similarity, 0.8 confidence, 50-500 chars, etc.)</li>
<li>‚ùå Lose domain knowledge (Dutch legal terminology, ASTRA compliance)</li>
</ul>

<p><strong>This extraction plan ensures:</strong></p>
<ul>
<li>‚úÖ Zero knowledge loss - all business logic preserved</li>
<li>‚úÖ Explicit documentation - no more implicit assumptions</li>
<li>‚úÖ Configurable system - hardcoded values ‚Üí config files</li>
<li>‚úÖ Testable rebuild - 42 baseline definitions validate correctness</li>
<li>‚úÖ Confidence to rebuild - rebuild team has complete blueprint</li>
</ul>

<h3>Final Message to Rebuild Team</h3>

<p><strong>Before you write a single line of new code:</strong></p>
<ol>
<li>Read ALL extracted documentation</li>
<li>Run ALL baseline tests against OLD system</li>
<li>Understand ALL business rules and workflows</li>
<li>Question ANY ambiguity - document decisions</li>
<li>**When in doubt, test against the 42 baseline definitions**</li>
</ol>

<p><strong>The extraction is your safety net - use it!</strong></p>

<p>---</p>

<p><strong>Extraction Plan Status:</strong> ‚úÖ COMPLETE</p>
<p><strong>Ready to Execute:</strong> YES</p>
<p><strong>Estimated Duration:</strong> 2-3 weeks</p>
<p><strong>Next Action:</strong> Begin Day 1 - Validation Rules Extraction</p>

<p>---</p>

<p><strong>Document Owner:</strong> Business Logic Extraction Specialist</p>
<p><strong>Last Updated:</strong> 2025-10-02</p>
<p><strong>Version:</strong> 1.0</p>
<p><strong>Phase:</strong> EPIC-026 Phase 1 (Design)</p>

  </div>
</body>
</html>