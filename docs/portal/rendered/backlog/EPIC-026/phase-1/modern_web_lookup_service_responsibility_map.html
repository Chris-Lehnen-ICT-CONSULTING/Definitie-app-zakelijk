<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Responsibility Map: modern_web_lookup_service.py</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">‚Üê Terug naar Portal</a>
    <p>---</p>
<p>id: EPIC-026-RESPONSIBILITY-MAP-MODERN-WEB-LOOKUP</p>
<p>epic: EPIC-026</p>
<p>phase: 1</p>
<p>day: 3</p>
<p>analyzed_file: src/services/modern_web_lookup_service.py</p>
<p>created: 2025-10-02</p>
<p>owner: code-architect</p>
<p>status: complete</p>
<p>---</p>

<h1>Responsibility Map: modern_web_lookup_service.py</h1>

<p><strong>Analysis Date:</strong> 2025-10-02</p>
<p><strong>File Path:</strong> <code>src/services/modern_web_lookup_service.py</code></p>
<p><strong>File Size:</strong> 1,019 LOC</p>
<p><strong>Methods Count:</strong> 19 methods (8 async)</p>
<p><strong>Complexity:</strong> <strong>HIGH</strong> (Async orchestration with multiple providers)</p>

<p>---</p>

<h2>Executive Summary</h2>

<h3>Key Findings</h3>

<ul>
<li>**Well-Structured Async Service:** Clean separation between providers</li>
<li>**5 Service Boundaries** ge√Ødentificeerd (Configuration, Orchestration, Providers, Utilities, Contract)</li>
<li>**Good Test Coverage:** Unit, integration, end-to-end, smoke tests</li>
<li>**6 Importers:** Moderate coupling</li>
<li>**Strangler Fig Pattern:** Geleidelijke vervanging van legacy code</li>
<li>**Provider Diversity:** Wikipedia, Wiktionary, SRU Overheid, Rechtspraak, Wetgeving</li>
</ul>

<h3>Refactoring Complexity: **MEDIUM** (6/10)</h3>

<p><strong>Factors supporting migration:</strong></p>
<ul>
<li>Clear async/await patterns</li>
<li>Provider abstraction via SourceConfig</li>
<li>Interface-based design (WebLookupServiceInterface)</li>
<li>Good test coverage</li>
<li>Strangler Fig migration pattern already in use</li>
</ul>

<p><strong>Factors increasing complexity:</strong></p>
<ul>
<li>8 async methods with concurrent execution</li>
<li>Multiple provider implementations (MediaWiki, SRU, REST, Scraping)</li>
<li>Legacy fallback logic</li>
<li>Complex ranking & deduplication</li>
<li>Context token classification heuristics</li>
</ul>

<p>---</p>

<h2>File Statistics</h2>

<h3>Code Metrics</h3>
<p>| Metric | Value | Threshold | Status |</p>
<p>|--------|-------|-----------|--------|</p>
<p>| <strong>Total LOC</strong> | 1,019 | <500 | ‚ùå Over (2x) |</p>
<p>| <strong>Methods</strong> | 19 | <20 | ‚úÖ Just under |</p>
<p>| <strong>Async Methods</strong> | 8 | N/A | ‚ÑπÔ∏è High async usage |</p>
<p>| <strong>Classes</strong> | 2 | N/A | ‚úÖ Good (SourceConfig + Service) |</p>
<p>| <strong>Importers</strong> | 6 | N/A | ‚ö†Ô∏è Moderate coupling |</p>
<p>| <strong>Test Files</strong> | 10+ | N/A | ‚úÖ Excellent coverage |</p>

<h3>Dependency Analysis</h3>

<p><strong>Direct Imports (10+):</strong></p>
<pre><code># External
import asyncio
import logging
from dataclasses import dataclass
from typing import Any
from hashlib import sha256

# Internal Services
from .interfaces import (
    JuridicalReference,
    LookupRequest,
    LookupResult,
    WebLookupServiceInterface,
    WebSource,
)

# Domain (optional with fallback)
from domain.autoriteit.betrouwbaarheid import BetrouwbaarheidsCalculator, BronType

# Service Internal
from .web_lookup.config_loader import load_web_lookup_config
from .web_lookup.ranking import rank_and_dedup, _canonical_url</code></pre>

<p><strong>Importers (6 files):</strong></p>
<pre><code>(Need to check actual importers via grep)</code></pre>

<p><strong>Test Coverage (Excellent):</strong></p>
<pre><code>tests/unit/test_modern_web_lookup_service_error_handling.py
tests/integration/test_modern_web_lookup_end_to_end.py
tests/ui/test_web_lookup_timeout_smoke.py
tests/ui/test_web_lookup_health_smoke.py
tests/ui/test_web_lookup_wetgeving_parked_smoke.py
tests/unit/web_lookup/ (directory)
+ more...</code></pre>

<p>---</p>

<h2>Method Inventory (19 Methods)</h2>

<h3>1. Initialization & Configuration (2 methods)</h3>
<pre><code>__init__()                                                         # L64   - Initialize service with sources
_setup_sources() -&gt; None                                           # L81   - Configure 6 lookup sources</code></pre>

<h3>2. Main Orchestration (1 async method)</h3>
<pre><code>async lookup(request: LookupRequest) -&gt; list[LookupResult]        # L241  - Main lookup orchestrator</code></pre>

<h3>3. Provider Routing (1 async method)</h3>
<pre><code>async _lookup_source(term, source_name, request)                  # L377  - Route to appropriate provider</code></pre>

<h3>4. Provider Implementations (5 async methods)</h3>
<pre><code>async _lookup_mediawiki(term, config, request)                    # L419  - MediaWiki API (Wikipedia, Wiktionary)
async _lookup_sru(term, config, request)                          # L597  - SRU protocol (Overheid, Wetgeving)
async _lookup_scraping(term, config, request)                     # L706  - Web scraping fallback
async _lookup_rest(term, config, request)                         # L715  - REST API (Rechtspraak)
async _legacy_fallback(term, source_name, request)                # L753  - Legacy implementation fallback</code></pre>

<h3>5. Source Determination (1 method)</h3>
<pre><code>_determine_sources(request: LookupRequest) -&gt; list[str]           # L338  - Determine which sources to query</code></pre>

<h3>6. Context Parsing (1 method)</h3>
<pre><code>_classify_context_tokens(context) -&gt; tuple[list, list, list]      # L177  - Parse org/jur/wet context tokens</code></pre>

<h3>7. Contract Conversion (2 methods)</h3>
<pre><code>_convert_legacy_result(legacy_result) -&gt; LookupResult             # L776  - Convert legacy to modern format
_to_contract_dict(result: LookupResult) -&gt; dict[str, Any]         # L843  - Convert to contract dict for ranking</code></pre>

<h3>8. Source Management (2 methods)</h3>
<pre><code>get_available_sources() -&gt; list[WebSource]                        # L801  - List available sources
validate_source(text: str) -&gt; WebSource                           # L815  - Validate source configuration</code></pre>

<h3>9. Provider Detection (2 methods)</h3>
<pre><code>_infer_provider_key(result: LookupResult) -&gt; str                  # L924  - Infer provider from result
_determine_source_type(text: str) -&gt; BronType                     # L938  - Determine BronType (wet/jur/etc)</code></pre>

<h3>10. Utility Methods (3 methods)</h3>
<pre><code>find_juridical_references(text: str) -&gt; list[JuridicalReference]  # L950  - Extract juridical references
detect_duplicates(results, threshold) -&gt; list[tuple]              # L969  - Detect duplicate results
_calculate_similarity(text1, text2) -&gt; float                      # L990  - Calculate text similarity</code></pre>

<h3>11. Configuration (2 methods)</h3>
<pre><code>enable_legacy_fallback(enabled: bool = True) -&gt; None              # L1004 - Toggle legacy fallback
get_source_status() -&gt; dict[str, dict[str, Any]]                  # L1009 - Get source status info
async lookup_single_source(term, source) -&gt; LookupResult | None   # L795  - Lookup single source (public API)</code></pre>

<p>---</p>

<h2>Responsibility Boundaries (5 Services)</h2>

<h3>1Ô∏è‚É£ **SOURCE CONFIGURATION Service** (~170 LOC)</h3>

<p><strong>Purpose:</strong> Manage source configuration and initialization</p>

<p><strong>Methods (2):</strong></p>
<ul>
<li>`__init__()` - Initialize service, load config</li>
<li>`_setup_sources()` - Configure 6 sources (Wikipedia, Wiktionary, Wetgeving, Overheid, Rechtspraak, Overheid Zoek)</li>
</ul>

<p><strong>Configuration Sources (6):</strong></p>
<pre><code>"wikipedia": SourceConfig(
    base_url="https://nl.wikipedia.org/api/rest_v1",
    api_type="mediawiki",
    confidence_weight=0.8,
    is_juridical=False
)

"wiktionary": SourceConfig(
    base_url="https://nl.wiktionary.org/w/api.php",
    api_type="mediawiki",
    confidence_weight=0.9
)

"wetgeving": SourceConfig(
    base_url="https://wetten.overheid.nl/SRU/Search",
    api_type="sru",
    confidence_weight=0.9,
    is_juridical=True
)

"overheid": SourceConfig(
    base_url="https://repository.overheid.nl",
    api_type="sru",
    confidence_weight=1.0,
    is_juridical=True
)

"rechtspraak": SourceConfig(
    base_url="https://data.rechtspraak.nl",
    api_type="rest",
    confidence_weight=0.95,
    is_juridical=True
)

"overheid_zoek": SourceConfig(
    base_url="https://zoekservice.overheid.nl",
    api_type="sru",
    confidence_weight=0.9,
    is_juridical=True
)</code></pre>

<p><strong>Dependencies:</strong></p>
<ul>
<li>`web_lookup.config_loader` - Load YAML config</li>
<li>`domain.autoriteit.betrouwbaarheid` - Optional domain module</li>
</ul>

<p><strong>Business Logic:</strong></p>
<ul>
<li>Config loading with fallback to defaults</li>
<li>Provider weight configuration (0.8-1.0 range)</li>
<li>Enabled/disabled toggling per source</li>
<li>Domain module availability check (DOMAIN_AVAILABLE flag)</li>
</ul>

<p><strong>Complexity:</strong> LOW-MEDIUM</p>
<ul>
<li>Straightforward configuration</li>
<li>Good fallback handling</li>
<li>Optional domain integration</li>
</ul>

<p>---</p>

<h3>2Ô∏è‚É£ **LOOKUP ORCHESTRATION Service** (~350 LOC)</h3>

<p><strong>Purpose:</strong> Orchestrate concurrent lookups across multiple providers</p>

<p><strong>Methods (4 async):</strong></p>
<ul>
<li>`async lookup(request)` - Main orchestrator</li>
<li>`async _lookup_source(term, source_name, request)` - Route to provider</li>
<li>`_determine_sources(request)` - Determine which sources to query</li>
<li>`async lookup_single_source(term, source)` - Single source lookup (public API)</li>
</ul>

<p><strong>Orchestration Flow:</strong></p>
<ol>
<li>Determine sources based on request (juridical filter, specific source, etc.)</li>
<li>Create async tasks for each enabled source</li>
<li>Execute concurrent lookups via `asyncio.gather()`</li>
<li>Filter successful results</li>
<li>Rank & deduplicate via `rank_and_dedup()`</li>
<li>Return final results</li>
</ol>

<p><strong>Dependencies:</strong></p>
<ul>
<li>`asyncio` - Concurrent execution</li>
<li>`web_lookup.ranking` - Ranking & deduplication</li>
<li>Provider methods (_lookup_mediawiki, _lookup_sru, etc.)</li>
</ul>

<p><strong>Business Logic:</strong></p>
<ul>
<li>Source selection based on:</li>
<li> - `request.sources` (specific sources requested)</li>
<li> - `request.only_juridical` (filter to juridical sources)</li>
<li> - All sources if no filter</li>
<li>Concurrent execution with exception handling</li>
<li>Ranking by confidence weights</li>
<li>Deduplication by canonical URL or content hash</li>
</ul>

<p><strong>Complexity:</strong> <strong>HIGH</strong></p>
<ul>
<li>Async orchestration complexity</li>
<li>Multiple execution paths</li>
<li>Error aggregation from concurrent tasks</li>
<li>Ranking & deduplication logic</li>
</ul>

<p>---</p>

<h3>3Ô∏è‚É£ **PROVIDER IMPLEMENTATIONS Service** (~400 LOC)</h3>

<p><strong>Purpose:</strong> Implement specific provider lookups (MediaWiki, SRU, REST, Scraping)</p>

<p><strong>Methods (5 async):</strong></p>
<ul>
<li>`async _lookup_mediawiki(term, config, request)` - Wikipedia, Wiktionary</li>
<li>`async _lookup_sru(term, config, request)` - Overheid, Wetgeving</li>
<li>`async _lookup_rest(term, config, request)` - Rechtspraak</li>
<li>`async _lookup_scraping(term, config, request)` - Web scraping</li>
<li>`async _legacy_fallback(term, source_name, request)` - Legacy wrapper</li>
</ul>

<p><strong>Provider Details:</strong></p>

<p><strong>MediaWiki (Wikipedia/Wiktionary):</strong></p>
<ul>
<li>REST API v1 for Wikipedia</li>
<li>MediaWiki API for Wiktionary</li>
<li>Extract summary/definition</li>
<li>Parse links, categories</li>
</ul>

<p><strong>SRU (Overheid/Wetgeving):</strong></p>
<ul>
<li>SRU protocol queries</li>
<li>XML parsing</li>
<li>Extract metadata, content</li>
<li>Juridical reference extraction</li>
</ul>

<p><strong>REST (Rechtspraak):</strong></p>
<ul>
<li>ECLI-based queries</li>
<li>JSON responses</li>
<li>Court decision metadata</li>
</ul>

<p><strong>Scraping (Fallback):</strong></p>
<ul>
<li>HTML scraping when API unavailable</li>
<li>BeautifulSoup/lxml parsing</li>
<li>Heuristic content extraction</li>
</ul>

<p><strong>Legacy Fallback:</strong></p>
<ul>
<li>Wrapper for old implementation</li>
<li>Conversion to modern format via `_convert_legacy_result()`</li>
<li>Only enabled when `_legacy_fallback_enabled = True`</li>
</ul>

<p><strong>Dependencies:</strong></p>
<ul>
<li>External APIs (Wikipedia, Overheid, etc.)</li>
<li>`web_lookup.providers.*` - Provider-specific logic (imported dynamically)</li>
<li>`_convert_legacy_result()` - Legacy conversion</li>
</ul>

<p><strong>Complexity:</strong> <strong>VERY HIGH</strong></p>
<ul>
<li>5 different API/protocol implementations</li>
<li>XML/JSON/HTML parsing</li>
<li>Error handling per provider</li>
<li>Legacy compatibility layer</li>
<li>Dynamic imports</li>
</ul>

<p>---</p>

<h3>4Ô∏è‚É£ **CONTEXT & CLASSIFICATION Service** (~150 LOC)</h3>

<p><strong>Purpose:</strong> Parse and classify context tokens, determine source types</p>

<p><strong>Methods (3):</strong></p>
<ul>
<li>`_classify_context_tokens(context)` - Parse org/jur/wet context</li>
<li>`_determine_source_type(text)` - Determine BronType</li>
<li>`find_juridical_references(text)` - Extract juridical refs</li>
</ul>

<p><strong>Context Token Classification:</strong></p>
<p>Classifies tokens into 3 categories:</p>
<ul>
<li>**Organisatorisch:** OM, ZM, DJI, JUSTID, KMAR, CJIB, Reclassering</li>
<li>**Juridisch:** recht, civiel, bestuursrecht, strafrecht</li>
<li>**Wettelijk:** wet, wetboek, AWB, Sv, Sr, Rv</li>
</ul>

<p><strong>Normalization & Deduplication:</strong></p>
<ul>
<li>Synonym mapping (e.g., "Sv" ‚Üí "Wetboek van Strafvordering")</li>
<li>Deduplication while preserving order</li>
<li>Case-insensitive matching</li>
</ul>

<p><strong>Source Type Determination:</strong></p>
<p>Maps text to <code>BronType</code>:</p>
<ul>
<li>WETGEVING</li>
<li>JURISPRUDENTIE</li>
<li>BELEID</li>
<li>LITERATUUR</li>
</ul>

<p><strong>Dependencies:</strong></p>
<ul>
<li>`domain.autoriteit.betrouwbaarheid.BronType` (optional)</li>
<li>Hardcoded org/jur/wet keyword lists</li>
</ul>

<p><strong>Business Logic:</strong></p>
<ul>
<li>Heuristic-based classification</li>
<li>Domain-specific abbreviations (OM, AWB, Sv, etc.)</li>
<li>Fallback to "organisatorisch" for unknown tokens</li>
</ul>

<p><strong>Complexity:</strong> MEDIUM</p>
<ul>
<li>Hardcoded heuristics (NOT data-driven)</li>
<li>Synonym mapping logic</li>
<li>Deduplication algorithm</li>
</ul>

<p><strong>‚ö†Ô∏è ISSUE:</strong> Hardcoded keyword lists - should be configurable</p>

<p>---</p>

<h3>5Ô∏è‚É£ **CONTRACT & UTILITY Service** (~200 LOC)</h3>

<p><strong>Purpose:</strong> Contract conversion, similarity detection, source management</p>

<p><strong>Methods (8):</strong></p>
<ul>
<li>`_convert_legacy_result(legacy)` - Convert legacy to modern</li>
<li>`_to_contract_dict(result)` - Convert to contract dict</li>
<li>`_infer_provider_key(result)` - Infer provider from result</li>
<li>`get_available_sources()` - List sources</li>
<li>`validate_source(text)` - Validate source</li>
<li>`detect_duplicates(results, threshold)` - Detect duplicates</li>
<li>`_calculate_similarity(text1, text2)` - Calculate similarity</li>
<li>`enable_legacy_fallback(enabled)` - Toggle legacy</li>
<li>`get_source_status()` - Get source status</li>
</ul>

<p><strong>Contract Conversion:</strong></p>
<ul>
<li>Legacy format ‚Üí Modern `LookupResult`</li>
<li>Modern `LookupResult` ‚Üí Contract dict (for ranking)</li>
<li>Snippet sanitization (max 500 chars)</li>
<li>URL canonicalization</li>
</ul>

<p><strong>Similarity Detection:</strong></p>
<ul>
<li>Text similarity calculation (simple ratio-based)</li>
<li>Duplicate detection with threshold (default 0.8)</li>
<li>Used for deduplication</li>
</ul>

<p><strong>Source Management:</strong></p>
<ul>
<li>List available sources with metadata</li>
<li>Validate source configuration</li>
<li>Get source status (enabled/disabled, weights)</li>
</ul>

<p><strong>Dependencies:</strong></p>
<ul>
<li>`web_lookup.ranking._canonical_url` - URL normalization</li>
<li>`hashlib.sha256` - Content hashing for dedup</li>
</ul>

<p><strong>Complexity:</strong> MEDIUM</p>
<ul>
<li>Multiple conversion formats</li>
<li>Sanitization logic</li>
<li>Similarity algorithm (simple but effective)</li>
</ul>

<p>---</p>

<h2>Cross-Cutting Concerns</h2>

<h3>1. Async/Await Patterns</h3>
<p><strong>Usage:</strong> 8 async methods</p>
<ul>
<li>Main orchestration (lookup)</li>
<li>Provider implementations (5 methods)</li>
<li>Single source lookup</li>
<li>Legacy fallback</li>
</ul>

<p><strong>Pattern:</strong> <code>asyncio.gather()</code> for concurrent execution</p>

<p><strong>Risk:</strong> Proper error handling needed for concurrent tasks</p>

<h3>2. Error Handling</h3>
<p><strong>Patterns:</strong></p>
<ul>
<li>Try/except in async tasks</li>
<li>Return exceptions via `asyncio.gather(return_exceptions=True)`</li>
<li>Filter exceptions from results</li>
<li>Log warnings for failed lookups</li>
</ul>

<p><strong>Risk:</strong> Some errors silently ignored</p>

<h3>3. Legacy Compatibility</h3>
<p><strong>Strangler Fig Pattern:</strong></p>
<ul>
<li>Modern implementations alongside legacy</li>
<li>`_legacy_fallback()` wrapper</li>
<li>Conversion via `_convert_legacy_result()`</li>
<li>Toggle via `enable_legacy_fallback()`</li>
</ul>

<p><strong>Status:</strong> Legacy disabled by default (<code>_legacy_fallback_enabled = False</code>)</p>

<h3>4. Configuration Management</h3>
<p><strong>Sources:</strong></p>
<ul>
<li>YAML config via `config_loader`</li>
<li>Fallback to hardcoded defaults</li>
<li>Provider weights configurable</li>
<li>Enabled/disabled per source</li>
</ul>

<p><strong>Risk:</strong> Config errors fall back to defaults (might hide issues)</p>

<h3>5. Provider Weights</h3>
<p><strong>Configured weights:</strong></p>
<ul>
<li>Wikipedia: 0.8</li>
<li>Wiktionary: 0.9</li>
<li>Wetgeving: 0.9</li>
<li>Overheid: 1.0</li>
<li>Rechtspraak: 0.95</li>
</ul>

<p><strong>Used for:</strong> Ranking results in <code>rank_and_dedup()</code></p>

<p>---</p>

<h2>Service Boundary Design (Proposed)</h2>

<h3>üéØ Target Architecture</h3>

<pre><code>modern_web_lookup_service.py (ORCHESTRATOR ONLY - ~200 LOC)
‚îú‚îÄ‚îÄ Source selection logic (~50 LOC)
‚îú‚îÄ‚îÄ Async orchestration (~100 LOC)
‚îî‚îÄ‚îÄ Result aggregation (~50 LOC)

NEW Services:
‚îú‚îÄ‚îÄ SourceConfigurationService (~170 LOC)
‚îÇ   ‚îú‚îÄ‚îÄ Load config
‚îÇ   ‚îú‚îÄ‚îÄ Setup sources
‚îÇ   ‚îî‚îÄ‚îÄ Manage weights
‚îÇ
‚îú‚îÄ‚îÄ ProviderRegistryService (~150 LOC)
‚îÇ   ‚îú‚îÄ‚îÄ Register providers
‚îÇ   ‚îú‚îÄ‚îÄ Route to provider
‚îÇ   ‚îî‚îÄ‚îÄ Manage lifecycle
‚îÇ
‚îú‚îÄ‚îÄ MediaWikiProviderService (~120 LOC)
‚îÇ   ‚îú‚îÄ‚îÄ Wikipedia lookup
‚îÇ   ‚îú‚îÄ‚îÄ Wiktionary lookup
‚îÇ   ‚îî‚îÄ‚îÄ Extract content
‚îÇ
‚îú‚îÄ‚îÄ SRUProviderService (~120 LOC)
‚îÇ   ‚îú‚îÄ‚îÄ Overheid lookup
‚îÇ   ‚îú‚îÄ‚îÄ Wetgeving lookup
‚îÇ   ‚îî‚îÄ‚îÄ XML parsing
‚îÇ
‚îú‚îÄ‚îÄ RESTProviderService (~100 LOC)
‚îÇ   ‚îú‚îÄ‚îÄ Rechtspraak lookup
‚îÇ   ‚îî‚îÄ‚îÄ JSON parsing
‚îÇ
‚îú‚îÄ‚îÄ ScrapingProviderService (~80 LOC)
‚îÇ   ‚îú‚îÄ‚îÄ HTML scraping
‚îÇ   ‚îî‚îÄ‚îÄ Content extraction
‚îÇ
‚îú‚îÄ‚îÄ ContextClassificationService (~150 LOC)
‚îÇ   ‚îú‚îÄ‚îÄ Token classification
‚îÇ   ‚îú‚îÄ‚îÄ Synonym mapping
‚îÇ   ‚îî‚îÄ‚îÄ Source type detection
‚îÇ   ‚îî‚îÄ‚îÄ NOTE: Extract keywords to config
‚îÇ
‚îú‚îÄ‚îÄ ResultRankingService (ALREADY EXISTS)
‚îÇ   ‚îî‚îÄ‚îÄ In web_lookup.ranking module
‚îÇ
‚îî‚îÄ‚îÄ ContractConversionService (~150 LOC)
    ‚îú‚îÄ‚îÄ Legacy conversion
    ‚îú‚îÄ‚îÄ Contract dict conversion
    ‚îî‚îÄ‚îÄ Similarity detection</code></pre>

<p>---</p>

<h2>Migration Complexity Assessment</h2>

<h3>Complexity Rating: **MEDIUM** (6/10)</h3>

<p><strong>Factors Supporting Migration:</strong></p>
<p>‚úÖ Already uses interface-based design (<code>WebLookupServiceInterface</code>)</p>
<p>‚úÖ Strangler Fig pattern in use (legacy fallback ready to remove)</p>
<p>‚úÖ Excellent test coverage (unit, integration, e2e, smoke)</p>
<p>‚úÖ Clear provider abstraction via <code>SourceConfig</code></p>
<p>‚úÖ Async patterns are consistent</p>
<p>‚úÖ Good separation: config, orchestration, providers, utils</p>

<p><strong>Factors Increasing Complexity:</strong></p>
<p>‚ùå 1,019 LOC in single file (2x threshold)</p>
<p>‚ùå 8 async methods with concurrent execution</p>
<p>‚ùå 5 different provider implementations (MediaWiki, SRU, REST, Scraping, Legacy)</p>
<p>‚ùå Hardcoded context classification (org/jur/wet keywords)</p>
<p>‚ùå Complex ranking & deduplication logic</p>
<p>‚ùå Dynamic imports for provider modules</p>
<p>‚ùå 6 importers (moderate coupling)</p>

<h3>Migration Risk Areas</h3>

<ol>
<li>**Async Orchestration**</li>
</ol>
<ul>
<li>  - `asyncio.gather()` with multiple providers</li>
<li>  - Risk: Breaking concurrent execution flow</li>
</ul>

<ol>
<li>**Provider Implementations**</li>
</ol>
<ul>
<li>  - 5 different API/protocol implementations</li>
<li>  - Risk: Each provider needs separate service</li>
</ul>

<ol>
<li>**Legacy Compatibility**</li>
</ol>
<ul>
<li>  - Strangler Fig pattern with fallback</li>
<li>  - Risk: Removing legacy too early</li>
</ul>

<ol>
<li>**Hardcoded Heuristics**</li>
</ol>
<ul>
<li>  - Context classification keywords</li>
<li>  - Risk: Moving to config breaks existing logic</li>
</ul>

<ol>
<li>**Ranking Integration**</li>
</ol>
<ul>
<li>  - Tight coupling to `web_lookup.ranking` module</li>
<li>  - Risk: Contract format changes</li>
</ul>

<p>---</p>

<h2>Recommended Extraction Order</h2>

<h3>Phase 1: CONFIGURATION (Week 1)</h3>
<ol>
<li>**SourceConfigurationService** (LOW, ~170 LOC)</li>
</ol>
<ul>
<li>  - Extract config loading</li>
<li>  - Source setup</li>
<li>  - Provider weights</li>
<li>  - **Benefit:** Centralize configuration</li>
</ul>

<h3>Phase 2: CONTEXT CLASSIFICATION (Week 1)</h3>
<ol>
<li>**ContextClassificationService** (MEDIUM, ~150 LOC)</li>
</ol>
<ul>
<li>  - Extract token classification</li>
<li>  - **IMPORTANT:** First move keywords to config</li>
<li>  - Then extract service logic</li>
<li>  - **Benefit:** Data-driven classification</li>
</ul>

<h3>Phase 3: PROVIDER EXTRACTION (Week 2-3)</h3>
<ol>
<li>**MediaWikiProviderService** (MEDIUM, ~120 LOC)</li>
</ol>
<ul>
<li>  - Wikipedia + Wiktionary</li>
<li>  - Clear API boundaries</li>
</ul>

<ol>
<li>**SRUProviderService** (MEDIUM, ~120 LOC)</li>
</ol>
<ul>
<li>  - Overheid + Wetgeving</li>
<li>  - XML parsing logic</li>
</ul>

<ol>
<li>**RESTProviderService** (LOW-MEDIUM, ~100 LOC)</li>
</ol>
<ul>
<li>  - Rechtspraak</li>
<li>  - JSON parsing</li>
</ul>

<ol>
<li>**ScrapingProviderService** (MEDIUM, ~80 LOC)</li>
</ol>
<ul>
<li>  - HTML scraping fallback</li>
<li>  - Less critical (can defer)</li>
</ul>

<h3>Phase 4: CONTRACT & UTILITIES (Week 3)</h3>
<ol>
<li>**ContractConversionService** (MEDIUM, ~150 LOC)</li>
</ol>
<ul>
<li>  - Legacy conversion</li>
<li>  - Contract dict conversion</li>
<li>  - Similarity detection</li>
</ul>

<h3>Phase 5: REGISTRY & ORCHESTRATION (Week 4)</h3>
<ol>
<li>**ProviderRegistryService** (MEDIUM-HIGH, ~150 LOC)</li>
</ol>
<ul>
<li>  - Register all providers</li>
<li>  - Route to appropriate provider</li>
<li>  - Manage provider lifecycle</li>
</ul>

<ol>
<li>**Reduce Orchestrator** (MEDIUM-HIGH, ~200 LOC)</li>
</ol>
<ul>
<li>  - Keep only orchestration logic</li>
<li>  - Delegate everything to services</li>
<li>  - Clean async/await flow</li>
</ul>

<p>---</p>

<h2>Testing Strategy</h2>

<h3>Current Coverage: **EXCELLENT**</h3>
<ul>
<li>Unit tests: error handling, individual providers</li>
<li>Integration tests: end-to-end lookup flows</li>
<li>Smoke tests: timeout, health, wetgeving</li>
<li>UI tests: tab integration</li>
</ul>

<h3>Migration Testing Strategy</h3>

<p><strong>Phase 1 (Before Extraction):</strong></p>
<ol>
<li>Document current behavior</li>
</ol>
<ul>
<li>  - All 6 sources working</li>
<li>  - Ranking & deduplication</li>
<li>  - Context classification</li>
<li>  - Legacy fallback (if enabled)</li>
</ul>

<p><strong>Phase 2 (During Extraction):</strong></p>
<ol>
<li>Service-specific tests</li>
</ol>
<ul>
<li>  - SourceConfiguration: 90%+ (config loading)</li>
<li>  - ContextClassification: 95%+ (heuristics)</li>
<li>  - Each provider: 90%+ (API integration)</li>
<li>  - ContractConversion: 85%+ (format conversion)</li>
</ul>

<p><strong>Phase 3 (After Extraction):</strong></p>
<ol>
<li>Integration tests</li>
</ol>
<ul>
<li>  - Full lookup flow still works</li>
<li>  - All 6 sources return results</li>
<li>  - Ranking produces same output</li>
<li>  - Performance not degraded</li>
</ul>

<p><strong>Phase 4 (Regression Prevention):</strong></p>
<ol>
<li>Add golden tests</li>
</ol>
<ul>
<li>  - Known term ‚Üí expected results</li>
<li>  - Provider weight changes ‚Üí expected ranking</li>
<li>  - Context tokens ‚Üí expected classification</li>
</ul>

<p>---</p>

<h2>Dependencies & Side Effects</h2>

<h3>External Dependencies</h3>
<ol>
<li>**External APIs (6):**</li>
</ol>
<ul>
<li>  - Wikipedia REST API</li>
<li>  - Wiktionary MediaWiki API</li>
<li>  - Wetten.overheid.nl SRU</li>
<li>  - Repository.overheid.nl SRU</li>
<li>  - Data.rechtspraak.nl REST</li>
<li>  - Zoekservice.overheid.nl SRU</li>
</ul>

<ol>
<li>**Service Layer:**</li>
</ol>
<ul>
<li>  - `web_lookup.config_loader` - YAML config</li>
<li>  - `web_lookup.ranking` - Ranking & dedup</li>
<li>  - `web_lookup.providers.*` - Provider modules (dynamic import)</li>
</ul>

<ol>
<li>**Domain (Optional):**</li>
</ol>
<ul>
<li>  - `domain.autoriteit.betrouwbaarheid` - BronType, Calculator</li>
<li>  - Fallback if unavailable (DOMAIN_AVAILABLE flag)</li>
</ul>

<h3>Side Effects</h3>

<p><strong>Network Calls:</strong></p>
<ul>
<li>6 concurrent API requests per lookup</li>
<li>Timeout: 30s per source</li>
<li>Max retries: 3 per source</li>
</ul>

<p><strong>Caching:</strong></p>
<ul>
<li>None implemented (each lookup is fresh)</li>
<li>**Opportunity:** Add caching layer</li>
</ul>

<p><strong>Debug State:</strong></p>
<ul>
<li>`_debug_attempts` list (per-call)</li>
<li>`_last_debug` dict</li>
<li>Used for troubleshooting</li>
</ul>

<p><strong>Legacy State:</strong></p>
<ul>
<li>`_legacy_fallback_enabled` flag (default False)</li>
<li>Can be toggled via `enable_legacy_fallback()`</li>
</ul>

<p>---</p>

<h2>Key Insights & Recommendations</h2>

<h3>üéØ Strengths</h3>

<ol>
<li>**Clean Async Design**</li>
</ol>
<ul>
<li>  - Consistent async/await patterns</li>
<li>  - Proper use of `asyncio.gather()` for concurrency</li>
<li>  - Error handling via return_exceptions</li>
</ul>

<ol>
<li>**Provider Abstraction**</li>
</ol>
<ul>
<li>  - `SourceConfig` dataclass for configuration</li>
<li>  - Clear routing logic via `_lookup_source()`</li>
<li>  - Extensible: easy to add new providers</li>
</ul>

<ol>
<li>**Strangler Fig Pattern**</li>
</ol>
<ul>
<li>  - Modern implementations alongside legacy</li>
<li>  - Ready to remove legacy when confident</li>
<li>  - Good migration strategy</li>
</ul>

<ol>
<li>**Excellent Test Coverage**</li>
</ol>
<ul>
<li>  - Unit, integration, e2e, smoke tests</li>
<li>  - Covers error cases</li>
<li>  - Performance testing (timeout)</li>
</ul>

<h3>‚ö†Ô∏è Areas for Improvement</h3>

<ol>
<li>**File Too Large**</li>
</ol>
<ul>
<li>  - 1,019 LOC (2x threshold)</li>
<li>  - Should split into provider services</li>
</ul>

<ol>
<li>**Hardcoded Heuristics**</li>
</ol>
<ul>
<li>  - Context classification keywords hardcoded</li>
<li>  - Should be in config/database</li>
<li>  - Not data-driven</li>
</ul>

<ol>
<li>**No Caching**</li>
</ol>
<ul>
<li>  - Every lookup hits external APIs</li>
<li>  - Opportunity for caching layer</li>
<li>  - Could reduce latency & API costs</li>
</ul>

<ol>
<li>**Dynamic Imports**</li>
</ol>
<ul>
<li>  - Provider modules imported on-demand</li>
<li>  - Harder to track dependencies</li>
<li>  - Consider explicit imports</li>
</ul>

<h3>üìã Immediate Actions</h3>

<p><strong>Before Refactoring:</strong></p>
<ol>
<li>‚úÖ Extract context keywords to config</li>
<li>‚úÖ Document all provider response formats</li>
<li>‚úÖ Add caching layer (optional but recommended)</li>
<li>‚úÖ Create provider interface contract</li>
</ol>

<p><strong>During Refactoring:</strong></p>
<ol>
<li>‚úÖ Extract providers one-by-one</li>
<li>‚úÖ Keep orchestration working throughout</li>
<li>‚úÖ Test each provider independently</li>
<li>‚úÖ Maintain async patterns</li>
</ol>

<p><strong>After Refactoring:</strong></p>
<ol>
<li>‚úÖ Remove legacy fallback code</li>
<li>‚úÖ Consolidate provider registration</li>
<li>‚úÖ Optimize concurrent execution</li>
<li>‚úÖ Add performance monitoring</li>
</ol>

<p>---</p>

<h2>Comparative Analysis</h2>

<h3>vs Other Files Analyzed</h3>

<p>| Metric | modern_web_lookup | definitie_repository | definition_generator_tab | tabbed_interface |</p>
<p>|--------|-------------------|----------------------|--------------------------|------------------|</p>
<p>| <strong>LOC</strong> | 1,019 | 1,815 | 2,525 | 1,793 |</p>
<p>| <strong>Methods</strong> | 19 | 41 | 60 | 39 |</p>
<p>| <strong>Services</strong> | 5 | 6 | 8 | 7 |</p>
<p>| <strong>Async Methods</strong> | 8 | 0 | 0 | 1 |</p>
<p>| <strong>Complexity</strong> | HIGH | MEDIUM | VERY HIGH | VERY HIGH |</p>
<p>| <strong>Test Coverage</strong> | EXCELLENT | EXCELLENT | POOR | ZERO |</p>

<p><strong>Observation:</strong> modern_web_lookup_service has:</p>
<ul>
<li>‚úÖ Smaller than UI files (good!)</li>
<li>‚úÖ Excellent test coverage (unlike UI files)</li>
<li>‚úÖ Clear service boundaries (better than UI)</li>
<li>‚ö†Ô∏è High async complexity (unique challenge)</li>
<li>‚ö†Ô∏è Still over LOC threshold (but not critically)</li>
</ul>

<p><strong>Pattern:</strong> Services layer has BETTER structure than UI layer</p>
<ul>
<li>Clearer responsibilities</li>
<li>Better tested</li>
<li>More modular design</li>
</ul>

<p>---</p>

<h2>Migration Checklist</h2>

<h3>Pre-Migration</h3>
<ul>
<li>[ ] Extract context keywords to config YAML</li>
<li>[ ] Document all provider response formats</li>
<li>[ ] Map current test coverage (already excellent)</li>
<li>[ ] Create provider interface contract</li>
<li>[ ] (Optional) Add caching layer</li>
</ul>

<h3>Service Extraction (4 weeks)</h3>
<ul>
<li>[ ] Week 1: SourceConfiguration + ContextClassification</li>
<li>[ ] Week 2: MediaWiki + SRU providers</li>
<li>[ ] Week 3: REST + Scraping + ContractConversion</li>
<li>[ ] Week 4: ProviderRegistry + Orchestrator reduction</li>
</ul>

<h3>Post-Migration</h3>
<ul>
<li>[ ] All tests pass (unit, integration, e2e, smoke)</li>
<li>[ ] Orchestrator reduced to <200 LOC</li>
<li>[ ] No legacy fallback code</li>
<li>[ ] Provider registration centralized</li>
<li>[ ] Performance metrics maintained/improved</li>
</ul>

<h3>Success Criteria</h3>
<ul>
<li>‚úÖ All 6 sources still working</li>
<li>‚úÖ Ranking produces same results</li>
<li>‚úÖ Performance not degraded</li>
<li>‚úÖ Test coverage maintained (>90%)</li>
<li>‚úÖ Orchestrator <200 LOC</li>
<li>‚úÖ Providers are separate, testable services</li>
</ul>

<p>---</p>

<h2>Appendix: Provider Details</h2>

<h3>Wikipedia Provider</h3>
<ul>
<li>**API:** REST API v1</li>
<li>**Endpoint:** `https://nl.wikipedia.org/api/rest_v1/page/summary/{term}`</li>
<li>**Response:** JSON with summary, extract, links</li>
<li>**Weight:** 0.8</li>
</ul>

<h3>Wiktionary Provider</h3>
<ul>
<li>**API:** MediaWiki API</li>
<li>**Endpoint:** `https://nl.wiktionary.org/w/api.php`</li>
<li>**Response:** JSON/XML with definition, etymology</li>
<li>**Weight:** 0.9</li>
</ul>

<h3>Wetgeving Provider</h3>
<ul>
<li>**API:** SRU (Search/Retrieve via URL)</li>
<li>**Endpoint:** `https://wetten.overheid.nl/SRU/Search`</li>
<li>**Response:** XML with legal texts</li>
<li>**Weight:** 0.9</li>
<li>**Juridical:** Yes</li>
</ul>

<h3>Overheid Provider</h3>
<ul>
<li>**API:** SRU</li>
<li>**Endpoint:** `https://repository.overheid.nl`</li>
<li>**Response:** XML with government documents</li>
<li>**Weight:** 1.0 (highest)</li>
<li>**Juridical:** Yes</li>
</ul>

<h3>Rechtspraak Provider</h3>
<ul>
<li>**API:** REST</li>
<li>**Endpoint:** `https://data.rechtspraak.nl`</li>
<li>**Response:** JSON with court decisions</li>
<li>**Weight:** 0.95</li>
<li>**Juridical:** Yes</li>
</ul>

<h3>Scraping Provider</h3>
<ul>
<li>**Type:** HTML scraping (fallback)</li>
<li>**Use:** When API unavailable</li>
<li>**Libraries:** BeautifulSoup/lxml</li>
<li>**Weight:** Configurable</li>
</ul>

<p>---</p>

<p><strong>Analysis Complete</strong></p>
<p><strong>Next Steps:</strong> Map validation_orchestrator_v2.py</p>

<p>---</p>

<p><strong>Analyst:</strong> BMad Master (executing Code Architect workflow)</p>
<p><strong>Date:</strong> 2025-10-02</p>
<p><strong>Phase:</strong> EPIC-026 Phase 1 (Design)</p>
<p><strong>Day:</strong> 3 of 5</p>

  </div>
</body>
</html>