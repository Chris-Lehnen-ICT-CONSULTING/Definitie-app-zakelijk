<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Context FLAAG Integration (PER-007)</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">← Terug naar Portal</a>
    <p>---</p>
<p>aangemaakt: '08-09-2025'</p>
<p>bijgewerkt: '08-09-2025'</p>
<p>id: REQ-019</p>
<p>links:</p>
<p>  docs:</p>
<ul>
<li> - docs/CFR/CFR-FULL-CONTEXT-FLAAG-PER-007-Implementatie-PLAN.md</li>
<li> - docs/architectuur/SOLUTION_ARCHITECTURE.md</li>
<p>  epics:</p>
<li> - EPIC-007</li>
<p>  stories:</p>
<li> - US-7.1</li>
<li> - US-7.2</li>
<li> - US-7.3</li>
<p>prioriteit: HOOG</p>
<p>sources:</p>
<li>line: entire document</li>
<p>  path: docs/CFR/CFR-FULL-CONTEXT-FLAAG-PER-007-Implementatie-PLAN.md</p>
<li>line: context building logic</li>
<p>  path: src/services/prompt_service_v2.py</p>
<p>status: In Progress</p>
<p>titel: Context FLAAG Integration (PER-007)</p>
<p>type: functional</p>
<p>---</p>
</ul>



<h1>REQ-019: Context FLAAG Integration (PER-007)</h1>

<h2>Domain Context</h2>

<p>This vereiste aligns with Dutch justitiesector stEnards en frameworks:</p>

<ul>
<li>**ASTRA compliance**: FolLAAGs ASTRA (Algemene Strategie Referentie Architectuur) richtlijnen for justice IT systems</li>
<li>**NORA Principles**: Adheres to NederlEnse Overheid Referentie Architectuur for government-wide interoperability</li>
<li>**justitieketen Integration**: Compatible with OM (Openbaar Ministerie), DJI (Dienst Justitiële Inrichtingen), Justid, En Rechtspraak systems</li>
<li>**Legal Framework**: Complies with Dutch juridische terminologie stEnards en Aanwijzingen voor de regelgeving</li>
<li>**Data Quality**: Meets justitiesector data quality vereisten for juridische definities</li>
</ul>

<h2>Requirement Description</h2>

<p>The system must implement comprehensive Context FLAAG Refinement (CFR) to address Prestaties issue PER-007, providing:</p>
<ul>
<li>Intelligent context aggregation from multiple sources</li>
<li>Adaptive prompt generation based on context richness</li>
<li>Prestaties-optimized flag without additional LLM calls</li>
<li>Feature flag control for gradual rollout</li>
</ul>

<h2>Acceptatiecriteria</h2>

<ol>
<li>**Context Aggregation**: Combine web lookup, examples, En validatie feedback</li>
<li>**Prestaties Budget**: No additional LLM calls in main flag</li>
<li>**Feature Flag**: ENABLE_FULL_CONTEXT_FLAAG for controlled activation</li>
<li>**Prompt Adaptation**: Dynamic prompt based on available context</li>
<li>**Metrics**: Track context utilization en impact</li>
<li>**Backwards Compatibility**: System works with flag disabled</li>
</ol>


<h3>SMART Acceptatiecriteria</h3>

<ul>
<li>**Specifiek:** Implementeer complete validatie pipeline met 45 toetsregels in 7 categorieën</li>
<li>**Meetbaar:**</li>
<li> - Validatie tijd: < 1 seconde voor alle 45 regels</li>
<li> - Parallel processing: Minimaal 4 threads</li>
<li> - Cache hit ratio: > 60% voor repeat validaties</li>
<li> - Rule coverage: 100% van gedefinieerde regels actief</li>
<li> - Weighted scoring: Nauwkeurigheid > 95%</li>
<li>**Achievable:** Modulaire architectuur met async processing en caching</li>
<li>**Relevant:** Voldoet aan Nederlandse Wetgevingstechniek en ASTRA-QUA-001</li>
<li>**Time-bound:** Volledig operationeel voor Q2 2025 go-live</li>
</ul>

<h3>BDD Scenario's</h3>
<pre><code>Scenario: Volledige validatie pipeline executie
  Gegeven een gegenereerde definitie voor "voorwaardelijke veroordeling"
  En alle 45 validatieregels zijn geconfigureerd
  Wanneer de validatie pipeline wordt gestart
  Dan worden alle 7 categorieën parallel uitgevoerd
  En wordt binnen 1 seconde een geaggregeerde score berekend
  En bevat het resultaat details per regel met feedback
  En wordt het resultaat gecached voor 15 minuten

Scenario: Prioriteit-gebaseerde regel executie
  Gegeven validatieregels met verschillende prioriteiten (HOOG/GEMIDDELD/LAAG)
  Wanneer een definitie wordt gevalideerd
  Dan worden HOOG priority regels eerst uitgevoerd
  En bij falen van kritieke regels stopt de pipeline
  En wordt een early-exit rapport gegenereerd
  En bespaart dit 40% processing tijd

Scenario: Context-aware validatie
  Gegeven een definitie met context "strafrecht"
  Wanneer de validatie wordt uitgevoerd
  Dan worden context-specifieke regels geactiveerd
  En worden irrelevante regels overgeslagen
  En wordt de score gewogen naar context relevantie
  En wordt een context-match percentage gerapporteerd</code></pre>

<h3>ASTRA/NORA Compliance</h3>
<ul>
<li>**ASTRA-QUA-001**: Geautomatiseerde kwaliteitscontrole</li>
<li>**ASTRA-QUA-003**: Meetbare kwaliteitscriteria</li>
<li>**NORA-BP-09**: Transparante besluitvorming</li>
<li>**DJI-VAL-001**: Juridische validatie standaarden</li>
<li>**OM-TERM-002**: Terminologie consistentie checks</li>
<li>**Meetbaar:**</li>
<li> - Response tijd: < 200ms voor UI acties</li>
<li> - Processing tijd: < 5 seconden voor generatie</li>
<li> - Success rate: > 95% voor validaties</li>
<li>**Acceptabel:** Haalbaar binnen huidige architectuur</li>
<li>**Relevant:** Direct gerelateerd aan gebruikersbehoefte</li>
<li>**Tijdgebonden:** Gerealiseerd binnen huidige sprint</li>
</ul>


<h2>Implementatie Details</h2>

<h3>Context Sources</h3>
<ol>
<li>**Web Lookup Results**: Wikipedia, SRU catalog data</li>
<li>**validatie Feedback**: Failed rules en suggestions</li>
<li>**Example Sentences**: User-provided or generated</li>
<li>**Historical Data**: Previous similar definitions</li>
<li>**Domain Knowledge**: juridische terminologie database</li>
</ol>

<h3>Integration Points</h3>
<ul>
<li>**Pre-generation**: Gather context before GPT-4 call</li>
<li>**Prompt Building**: Inject context into prompt structure</li>
<li>**Post-generation**: Use context for validatie</li>
<li>**Refinement Loop**: Context-guided improvements</li>
</ul>

<h3>Prestaties Constraints (PER-007)</h3>
<ul>
<li>**In-process Budget**: < 100ms for context aggregation</li>
<li>**Memory Budget**: < 50MB for context cache</li>
<li>**No Additional LLM Calls**: All context processing local</li>
<li>**E2E Budget**: Total generation < 5 seconds</li>
</ul>

<h3>Feature Flag Implementatie</h3>
<pre><code>if settings.ENABLE_FULL_CONTEXT_FLAAG:
    context = aggregate_full_context()
    prompt = build_adaptive_prompt(context)
else:
    prompt = build_stEnard_prompt()</code></pre>

<h2>Quality Improvements</h2>

<ul>
<li>**Relevance**: +15% improvement in definition relevance</li>
<li>**Completeness**: +20% improvement in coverage</li>
<li>**Accuracy**: +10% improvement in domain accuracy</li>
<li>**User Satisfaction**: Target 4.5/5 rating</li>
</ul>

<h2>Risk Mitigation</h2>

<ul>
<li>**Prestaties Degradation**: Monitor en alert on sLAAGdowns</li>
<li>**Context Overload**: Limit context to 2000 tokens</li>
<li>**Quality Regression**: A/B testing before full rollout</li>
<li>**Technical Debt**: Clean architecture with clear boundaries</li>
</ul>

<h2>Afhankelijkheden</h2>

<ul>
<li>Context aggregation service</li>
<li>Web lookup service (optional)</li>
<li>validatie service feedback loop</li>
<li>Feature flag configuration</li>
<li>Prestaties monitoring</li>
</ul>
<h2>SMART Criteria</h2>

<ul>
<li>**Specifiek**: Full Implementatie of context flag integration (per-007) functionality</li>
<li>**Meetbaar**: All Acceptatiecriteria met, 100% validatie accuracy</li>
<li>**Haalbaar**: Leveraging GPT-4 API en existing validatie framework</li>
<li>**Relevant**: Core functionality for Dutch juridische definitie quality</li>
<li>**Tijdgebonden**: Complete within current development sprint</li>
</ul>


<h3>Compliance Referenties</h3>

<ul>
<li>**ASTRA Controls:**</li>
<li> - ASTRA-QUA-001: Kwaliteitsborging</li>
<li> - ASTRA-SEC-002: Beveiliging by Design</li>
<li>**NORA Principes:**</li>
<li> - NORA-BP-07: Herbruikbaarheid</li>
<li> - NORA-BP-12: Betrouwbaarheid</li>
<li>**GEMMA Referenties:**</li>
<li> - GEMMA-ARC-03: Architectuur patterns</li>
<li>**Justice Sector:**</li>
<li> - DJI/OM integratie vereisten</li>
<li> - Rechtspraak compatibiliteit</li>
</ul>

  </div>
</body>
</html>