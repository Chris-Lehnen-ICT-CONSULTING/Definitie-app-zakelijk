<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Compat web lookup gebruikt nietâ€‘bestaand attribuut 'title</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">â† Terug naar Portal</a>
    <p>---</p>
<p>id: CFR-BUG-015</p>
<p>epic: EPIC-010</p>
<p>titel: Compat web lookup gebruikt nietâ€‘bestaand attribuut 'title</p>
<p>status: open</p>
<p>prioriteit: HOOG</p>
<p>aangemaakt: 2025-09-10</p>
<p>bijgewerkt: 2025-09-10</p>
<p>owner: development-team</p>
<p>applies_to: definitie-app@current</p>
<p>last_verified: 2025-10-02</p>
<p>component: services.definition_generator_context (compat web lookup)</p>
<p>severity: Medium-High</p>
<p>impact: Exceptions in contextverrijking; potentieel blokkeren van generatieflow</p>
<p>---</p>

<h1>CFR-BUG-015: Compat web lookup gebruikt nietâ€‘bestaand attribuut 'title'</h1>

<h2>ğŸ› Beschrijving</h2>
<p>De compatibele webâ€‘context wrapper in <code>DefinitionGeneratorContext</code> gebruikt <code>r.title</code> voor weergave van SRU/Wikipedia resultaten. Het <code>LookupResult</code>-contract bevat echter geen <code>title</code> attribuut; titel/meta-informatie staat in <code>result.metadata</code> (bij SRU onder <code>dc_title</code>) of ontbreekt. Dit veroorzaakt een <code>AttributeError</code> en kan de flow onderbreken tijdens contextverrijking.</p>

<p><strong>Locatie</strong></p>
<ul>
<li>Bestandslocatie: `src/services/definition_generator_context.py`</li>
<li>Functie: `_init_web_lookup()` â†’ `web_lookup_wrapper()` (list-comprehensie met `f"{r.title} ({r.source.name})"`)</li>
<li>Contractreferentie: `src/services/interfaces.py::LookupResult`</li>
</ul>

<h2>ğŸ” Reproduceren</h2>
<ol>
<li>Web lookup is automatisch actief wanneer de service beschikbaar is (geen feature flag meer nodig).</li>
<li>Activeer een pad dat `HybridContextManager._init_web_lookup()` gebruikt (bv. contextverrijking in V2â€‘flow met hybrid/web lookup).</li>
<li>Trigger generatie met een begrip dat web lookup start.</li>
<li>Observeer exception: `AttributeError: 'LookupResult' object has no attribute 'title'`.</li>
</ol>

<h2>ğŸ¯ Verwacht gedrag</h2>
<ul>
<li>Compat wrapper gebruikt een robuuste titelbron:</li>
<li> - SRU: `result.metadata['dc_title']` indien aanwezig</li>
<li> - Fallback: `result.source.name`</li>
<li>Geen exceptions in de compatlaag; contextverrijking loopt door (of levert lege string).</li>
</ul>

<h2>ğŸ§© Root Cause</h2>
<ul>
<li>`LookupResult` dataclass heeft geen `title`-attribuut. Titelinformatie zit in `metadata` of valt terug op de bronnaam. De compat wrapper refereert aan een nietâ€‘bestaand attribuut.</li>
</ul>

<h2>ğŸ› ï¸ Oplossing (Proposed Fix)</h2>
<ul>
<li>Pas de compat wrapper aan in `src/services/definition_generator_context.py`:</li>
<li> - Vervang `r.title` door `(r.metadata.get('dc_title') if isinstance(r.metadata, dict) else None) or r.source.name`.</li>
<li> - Beperk output tot max 3 resultaten; graceful fallback naar lege string wanneer geen resultaten.</li>
<li>(Optioneel) Markeer de compat wrapper als deprecated in V2â€‘only modus om misbruik te voorkomen.</li>
</ul>

<h2>âœ… Acceptatiecriteria</h2>
<ul>
<li>Geen `AttributeError` in compat webâ€‘context.</li>
<li>Bij SRUâ€‘resultaten wordt de titel uit `metadata['dc_title']` gebruikt; anders fallback naar bronnaam.</li>
<li>Generatieflow loopt door (ook als web lookup geen resultaten geeft of SRU niet beschikbaar is).</li>
</ul>

<h2>ğŸ“ Referenties</h2>
<ul>
<li>`src/services/definition_generator_context.py`</li>
<li>`src/services/interfaces.py` (klassen: `LookupResult`, `WebSource`)</li>
<li>`src/services/modern_web_lookup_service.py` (mapping SRU â†’ metadata `dc_title`)</li>
<li>`docs/backlog/EPIC-010/EPIC-010.md`</li>
</ul>

<h2>ğŸ§ª Testvoorstel</h2>
<ul>
<li>Unit: mock `LookupResult` met `metadata={'dc_title':'...'}; source.name='...'` â†’ wrapper string bevat `dc_title`.</li>
<li>Unit: mock zonder `dc_title` â†’ wrapper string bevat `source.name`.</li>
<li>Integratie: web lookup ingeschakeld in dev; geen exceptions in contextverrijking.</li>
</ul>

<h2>ğŸ”¬ Technische Analyse (aanvulling)</h2>

<h3>Symptoom</h3>
<ul>
<li>Exception tijdens contextverrijking met web lookup ingeschakeld: `AttributeError: 'LookupResult' object has no attribute 'title'`.</li>
</ul>

<h3>Directe oorzaak</h3>
<ul>
<li>In `HybridContextManager._init_web_lookup()` wordt een compatâ€‘wrapper gedefinieerd:</li>
<li> - Locatie: `src/services/definition_generator_context.py`</li>
<li> - Wrapper formatteert resultaten met `f"{r.title} ({r.source.name})"`, maar `LookupResult` kent geen attribuut `title`.</li>
</ul>

<h3>Contractâ€‘mismatch onderbouwing</h3>
<ul>
<li>`LookupResult` (zie `src/services/interfaces.py`) bevat o.a. `term`, `source`, `definition`, `context`, `examples`, `references`, `success`, `error_message`, `metadata` â€” geen `title` attribuut.</li>
<li>Bronspecifieke titelvelden worden in `metadata` geplaatst:</li>
<li> - SRU: `metadata['dc_title']` (aangemaakt in `src/services/web_lookup/sru_service.py` tijdens XMLâ€‘parsing)</li>
<li> - Wikipedia: `metadata['wikipedia_title']` (aangemaakt in `src/services/web_lookup/wikipedia_service.py` bij resultâ€‘bouw)</li>
</ul>

<h3>Waarom nu zichtbaar</h3>
<ul>
<li>In EPICâ€‘010 is de moderne web lookup service en compatâ€‘wrapper geÃ¯ntroduceerd/geÃ¼pdatet. De wrapper behield legacy formatting (`r.title`) terwijl het V2â€‘contract titles naar `metadata` heeft verplaatst. Door dynamische typing werd dit pas runtime zichtbaar.</li>
</ul>

<h3>Scope en impact (blast radius)</h3>
<ul>
<li>Treft alleen de compatâ€‘tekstoutput in `HybridContextManager` wanneer web lookup resultaten teruggeeft.</li>
<li>Verbreekt contextverrijking met een exception; downstream generatie kan stoppen.</li>
<li>Repoâ€‘scan bevestigt dat `.title` alleen hier op `r` (LookupResult) wordt gebruikt; geen andere call sites geraakt.</li>
</ul>

<h3>Concretisering fix</h3>
<ul>
<li>Displayâ€‘titel robuust afleiden uit metadata met fallbacks:</li>
<li> - Eerst `dc_title`</li>
<li> - Dan `wikipedia_title`</li>
<li> - Dan `r.source.name` (altijd aanwezig)</li>
<li>Indicatieve vervanging (alleen ter illustratie, geen code in deze bug):</li>
<pre><code>  titles = []
  for r in results[:3]:
      md = r.metadata or {}
      display_title = md.get('dc_title') or md.get('wikipedia_title') or r.source.name
      titles.append(f"{display_title} ({r.source.name})")
  return f"Web informatie voor {term}: " + "; ".join(titles)</code></pre>
</ul>

<h3>Niet doen (bewuste keuzes)</h3>
<ul>
<li>Geen `title` veld toevoegen aan `LookupResult` (zouden dubbele bronnen van waarheid creÃ«ren en afwijken van bestaand V2â€‘contract).</li>
</ul>

<h3>Validatie en observability</h3>
<ul>
<li>Na fix: geen `AttributeError`; wrapper levert lege string bij geen resultaten en behoudt max 3 items voor beknopte context.</li>
<li>Logging: huidige warning in `_get_web_context` blijft volstaan; extra logging niet noodzakelijk.</li>
</ul>

<h3>Testâ€‘aanvulling (detail)</h3>
<ul>
<li>Unit:</li>
<li> - Case A (SRU): `metadata={'dc_title': 'Wet open overheid'}` â†’ string bevat 'Wet open overheid'.</li>
<li> - Case B (Wikipedia): `metadata={'wikipedia_title': 'Openbaarheid'}` â†’ string bevat 'Openbaarheid'.</li>
<li> - Case C (Geen titel): `metadata={}` â†’ string gebruikt `r.source.name`.</li>
<li> - Case D (Lege resultaten): wrapper retourneert `""` zonder exception.</li>
<li>Integratie (optioneel): simulateer 2 resultaten (1 SRU, 1 Wikipedia) en verifieer concatenatie en volgorde.</li>
</ul>

<h3>Traceability</h3>
<ul>
<li>Epic: EPICâ€‘010 (Context Flow Refactoring)</li>
<li>Bug: CFRâ€‘BUGâ€‘015 (dit document)</li>
<li>User story: geen aparte US gekoppeld; kan desgewenst als kleine bugâ€‘fix onder EPICâ€‘010 worden doorgevoerd zonder nieuwe US.</li>
</ul>

<p>---</p>

  </div>
</body>
</html>