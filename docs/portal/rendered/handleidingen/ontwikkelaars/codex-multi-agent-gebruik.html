<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Codex Multi‑Agent Gebruik</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">← Terug naar Portal</a>
    <p>---</p>
<p>titel: Codex Multi‑Agent Gebruik</p>
<p>aangemaakt: 2025-09-10</p>
<p>status: active</p>
<p>doel: Parallelle probleemoplossing en code‑voorstellen met meerdere agents</p>
<p>canonical: true</p>
<p>owner: development</p>
<p>last_verified: 2025-09-11</p>
<p>applies_to: definitie-app@current</p>
<p>---</p>

<h1>Codex Multi‑Agent Gebruik</h1>

<p>Deze gids beschrijft hoe je meerdere “agents” (parallele Codex‑sessies/branches) dezelfde opdracht laat uitvoeren en daarna de beste oplossing selecteert en merge’t. Gericht op analyse, debuggen en code schrijven met dieper redeneren.</p>

<h2>Doel</h2>
<ul>
<li>Parallel ideeën uitwerken zonder elkaar te blokkeren</li>
<li>Snelste/robuste oplossing kiezen op basis van objectieve criteria (tests, perf, codekwaliteit)</li>
<li>Minimale contextswitch door kant‑en‑klare workflow/commando’s</li>
</ul>

<h2>Strategieën</h2>

<h3>1) Parallel met git worktrees (aanrader)</h3>
<p>Maak per “agent” een eigen checkout met eigen branch.</p>

<pre><code># Vanuit de hoofdrepo map
git worktree add ../Definitie-app-agent-a -b agent-a
git worktree add ../Definitie-app-agent-b -b agent-b
# Optioneel een derde
git worktree add ../Definitie-app-agent-c -b agent-c

# Open per worktree een eigen terminal/Codex sessie
cd ../Definitie-app-agent-a   # Agent A: minimal patch / quick win
cd ../Definitie-app-agent-b   # Agent B: robuust + tests
cd ../Definitie-app-agent-c   # Agent C: performance/architectuur</code></pre>

<p>Voordelen: volledige isolatie, parallel draaien van tests, heldere diffs. Nadelen: meer directories.</p>

<h3>Helper script (snelle start)</h3>
<p>Gebruik <code>scripts/multiagent.sh</code> om worktrees/branches te beheren en te vergelijken zonder handwerk:</p>

<pre><code># 2 agents aanmaken (agent-a, agent-b)
bash scripts/multiagent.sh init -n 2

# Status en review
bash scripts/multiagent.sh status
bash scripts/multiagent.sh review --quick-checks

# Opruimen
bash scripts/multiagent.sh teardown</code></pre>

<p>Slash‑commando’s (conventie in Codex‑chat):</p>
<ul>
<li>`/multi init` → `bash scripts/multiagent.sh init -n 2`</li>
<li>`/multi status` → `bash scripts/multiagent.sh status`</li>
<li>`/multi review` → `bash scripts/multiagent.sh review --quick-checks`</li>
<li>`/multi teardown` → `bash scripts/multiagent.sh teardown`</li>
</ul>

<p>Advies‑check (wanneer multi?):</p>
<ul>
<li>`bash scripts/multiagent.sh check` — geeft ‘Advice: YES/NO/MAYBE’ op basis van diff‑omvang en type (docs‑only, tiny, etc.).</li>
<li>`init --strict` — stopt bij advies ‘NO’; `init --force` om te forceren.</li>
</ul>

<h3>2) Sequentieel met patches</h3>
<p>Ieder voorstel als patchbestand opslaan en later vergelijken/apply’en.</p>

<pre><code># Agent A
# (wijzig code)
git diff &gt; patches/agent-a.patch
git reset --hard

# Agent B
# (wijzig code)
git diff &gt; patches/agent-b.patch

# Vergelijk/apply test
git apply --check patches/agent-a.patch &amp;&amp; git apply patches/agent-a.patch &amp;&amp; pytest -q
git reset --hard
git apply --check patches/agent-b.patch &amp;&amp; git apply patches/agent-b.patch &amp;&amp; pytest -q</code></pre>

<p>Voordelen: één workspace. Nadelen: meer handwerk.</p>

<h3>3) Debate/Critique patroon</h3>
<p>Agent A maakt voorstel, Agent B reviewt/critique, A verbetert → “arbiter” kiest beste variant. Combineer met worktrees.</p>

<h2>Evaluatiecriteria (winnaar kiezen)</h2>
<ul>
<li>Tests: alle relevante unit/integratie groen</li>
<li>EPIC‑010 conformiteit: V2‑contract (dict), geen legacy/sync, canonical keys, endpoint‑timeouts</li>
<li>Codechurn laag, complexiteit minimaal, duidelijke grenzen</li>
<li>Performance/stabiliteit: geen timeouts, geen dubbele init, nette shutdown</li>
</ul>

<p>Handige quick‑checks (EPIC‑010):</p>
<pre><code># Geen legacy patterns
rg -n "from src.models.generation_result import|best_iteration|asyncio\.run\(" src/ &amp;&amp; echo "LEGACY FOUND" || echo "OK"

# V2 UI contract keys aanwezig in UI code
rg -n "definitie_gecorrigeerd|validation_details|voorbeelden|metadata" src/ui/</code></pre>

<h2>Scoreboard (voorbeeld)</h2>
<p>Eenvoudige evaluatie per branch. Sla op als <code>scripts/agent_scoreboard.sh</code> of voer ad‑hoc uit.</p>

<pre><code>#!/usr/bin/env bash
set -euo pipefail
branches=(agent-a agent-b agent-c)
for b in "${branches[@]}"; do
  git checkout "$b" &gt;/dev/null 2&gt;&amp;1 || continue
  start=$(date +%s)
  pytest -q || status=$?
  dur=$(( $(date +%s) - start ))
  echo "BRANCH=$b DURATION=${dur}s STATUS=${status:-0}"
done</code></pre>

<h2>Codex Config (diepere redenering)</h2>
<p>Voor grondige analyse/debug/code:</p>

<pre><code># Model en diepte
codex config set model=o1
codex config set temperature=0.1
codex config set max_output_tokens=4096

# Plan/trace/debug
codex config set plan.enabled=true
codex config set plan.autoupdate=true
codex config set trace.enabled=true
codex config set debug.enabled=true

# Patching/validatie
codex config set patch.confirm=true
codex config set test.auto=true
codex config set patch.preview=true

# Alias (optioneel)
alias codex-deep='codex --trace --debug'</code></pre>

<h3>Slash Commands (toggles voor gedrag)</h3>
<p>Gebruik deze in je Codex‑sessie om agents voorspelbaar en zonder aannames te laten werken. Uitgebreid beschreven in <code>docs/guidelines/AGENTS.md</code>.</p>

<ul>
<li>`/strict on` — activeer strict mode: geen aannames; pauze voor akkoord bij patches, tests, netwerk en DB‑reset.</li>
<li>`/strict off` — deactiveer strict mode.</li>
<li>`/approve` / `/approve all` — akkoord op de volgende (of alle huidige) geblokkeerde stappen.</li>
<li>`/deny` — weiger de volgende stap; agent biedt alternatief of plant om.</li>
<li>`/plan on` / `/plan off` — planmodus verplicht/uit.</li>
<li>Scopes: `/strict on patch,test` om alleen bepaalde domeinen te gaten (`patch`, `test`, `network`, `db`, `all`).</li>
</ul>

<h2>No‑Assumptions / Strict Mode (Codex)</h2>

<p>Doel: werken zonder aannames door beslissingen expliciet te maken en akkoord te vragen op tussenstappen.</p>

<ul>
<li>Strict proces</li>
<li> - Start elk werk met `update_plan` + “open vragen/unknowns”; pauzeer tot goedkeuring.</li>
<li> - Approval gates: geen codepatch, tests, netwerk of DB‑reset zonder expliciete OK.</li>
<li> - Decision Log: leg beslissingen (geen aannames), motivatie en akkoordmoment vast.</li>
<li>Vereiste input (voorkomt aannames)</li>
<li> - Doel & scope, Definition of Done, acceptatiecriteria.</li>
<li> - API/contracten en wijzigingsruimte (wat wel/niet aanpassen).</li>
<li> - Randvoorwaarden: security, performance, UX/i18n/a11y, foutafhandeling.</li>
<li> - Voorbeelden/tegenvoorbeelden + testdata (happy/edge/error cases).</li>
<li> - Bron van waarheid en conflictbeleid bij inconsistenties.</li>
<li>Verificatie en bewijs</li>
<li> - Lever testopdracht/scenario’s; draai tests en toon resultaten (logs/diff/screenshot waar passend).</li>
<li> - Per planstap een kort verificatieblok: wat geverifieerd, hoe, en met welk bewijs.</li>
<li>Alternatieven en keuzes</li>
<li> - Geef per ontwerpbesluit 2–3 alternatieven met trade‑offs; vraag om keuze vóór implementatie.</li>
<li>Scope‑bescherming</li>
<li> - Stel wijzigingsgrenzen: enkel paden X/Y, maximaal N regels diff, geen hernoem/format buiten scope.</li>
<li> - Specificeer welke feature flags/env‑vars gebruikt mogen worden.</li>
<li>Templates (handig)</li>
<li> - Opdrachtbrief: doel, scope, DoD, constraints, risico’s, testcases, SSoT.</li>
<li> - Review‑gate: beslissingen ter goedkeuring, impact, rollback, testplan.</li>
<li>Direct toepasbaar in deze repo</li>
<li> - Zet “no‑assumptions” actief: de agent stopt bij unknowns en vraagt om akkoord.</li>
<li> - Start met een unknowns‑lijst en laat die expliciet goedkeuren vóór implementatie.</li>
</ul>

<p>Prompt‑preset (plak bovenaan je opdracht):</p>

<blockquote>Gebruik een stap‑voor‑stap plan (update_plan) en werk het na elke stap bij. Toon aannames, alternatieven en verificaties. Houd je aan V2‑contracten; geen legacy/sync. Voor code: eerst impactanalyse, dan minimale patch, daarna teststrategie en rollbackplan.</blockquote>

<h2>Workflow Template</h2>
<ol>
<li>Opdracht definiëren + criteria (DoD)</li>
<li>Branches/worktrees aanmaken</li>
<li>Codex configeren (diep redeneren)</li>
<li>Agents laten werken (A: minimal, B: robuust, C: perf)</li>
<li>Per branch: pytest, quick‑checks, eventueel perf‑meting</li>
<li>Scoreboard + keuze</li>
<li>Final merge naar `main` (no‑ff) en cleanup worktrees</li>
</ol>

<h2>Merge & Cleanup</h2>
<pre><code>git checkout main
git merge --no-ff agent-a -m "Merge agent-a: beste oplossing op criteria XYZ"
# Worktrees opruimen
git worktree remove ../Definitie-app-agent-a --force
git branch -D agent-a</code></pre>

<h2>Tips & Valkuilen</h2>
<ul>
<li>Timeouts harmoniseren via endpoint config i.p.v. hardcoded</li>
<li>Houd UI sync‑bridging beperkt tot `ui/helpers/async_bridge.py`</li>
<li>Idempotente registratie van modules (singleton via container)</li>
<li>Memoization op dure loads (bv. toetsregels), éénmalig per sessie</li>
</ul>

<h2>Voorbeeld: EPIC‑010 toepassing</h2>
<ul>
<li>Gates: blokkeer legacy imports/`best_iteration`/`asyncio.run` in services</li>
<li>V2‑dict‑only in UI (`definitie_gecorrigeerd`, `validation_details`, `voorbeelden`, `metadata`)</li>
<li>Endpoint‑timeouts via `config/rate_limit_config.py`</li>
<li>Parallel agents:</li>
<li> - A: fix snelle blockers (timeouts, obvious bugs)</li>
<li> - B: contractconsolidatie + tests</li>
<li> - C: performance (async voorbeelden, caching, idempotency)</li>
</ul>

<h2>Werkwijzen per type handeling</h2>

<h3>Code Review (parallelle agents)</h3>
<ul>
<li>Doel: snelle kwaliteitsbarrières, regressies voorkomen, risico’s zichtbaar maken.</li>
<li>Agent‑rollen:</li>
<li> - Agent A (Static): style/lint/typos/greps, quick test‑smoke</li>
<li> - Agent B (Correctness): unit/integratie, contract‑checks, edge‑cases</li>
<li> - Agent C (Arch/Sec): architectuurregels, dependency‑grenzen, security greps</li>
<li>Setup (worktrees): `agent-a`, `agent-b`, `agent-c`</li>
<li>Commando’s (voorbeeld):</li>
<li> - Greps: `rg -n "best_iteration|asyncio\.run\(|from src\.models\.generation_result" src/`</li>
<li> - Tests: `pytest -q && pytest tests/integration -q`</li>
<li> - Coverage (optioneel): `pytest --cov=src --cov-report=term-missing`</li>
<li>Checklist:</li>
<li> - [ ] V2‑contracten in UI/Services (dicts)</li>
<li> - [ ] Geen legacy/sync in services</li>
<li> - [ ] Endpoint‑timeouts consistent</li>
<li> - [ ] Log‑noise/Duplicate init afwezig</li>
<li>Criteria voor “goedgekeurd”:</li>
<li> - Tests groen, geen legacy greps, duidelijke changelog/PR‑beschrijving</li>
</ul>

<h3>Refactoring (parallelle agents)</h3>
<ul>
<li>Doel: complexiteit omlaag, legacy eruit, gedrag behouden (of bewust breken met migratie‑notities).</li>
<li>Agent‑rollen:</li>
<li> - Agent A (Minimal): kleinste set wijzigingen die legacy verwijdert + gates</li>
<li> - Agent B (Structure): services/container/singletons/idempotency</li>
<li> - Agent C (Perf): memoization/caching en init‑pad optimalisaties</li>
<li>Plan:</li>
<p>  1) Inventarisatie (greps + dependency overview)</p>
<p>  2) Minimal refactor (A), structurele cleanups (B), perf (C)</p>
<p>  3) Tests/greps/bench, review en merge</p>
<li>Commando’s:</li>
<li> - Inventarisatie: `rg -n "TODO|DEPRECATED|LEGACY|FIXME" src/`</li>
<li> - Legacy‑patronen: zie EPIC‑010 quick‑checks</li>
<li> - Bench (indicatief): meet init/generatie timings in logs</li>
<li>Criteria:</li>
<li> - [ ] Geen legacy entrypoints, één source of truth voor contracten</li>
<li> - [ ] Idempotente registratie, éénmalige loads</li>
<li> - [ ] Tests ongewijzigd (indien mogelijk) of logisch geüpdatet</li>
</ul>

<h3>Developing (feature/bugfix)</h3>
<ul>
<li>Doel: TDD/verbetering met verifieerbaar gedrag.</li>
<li>Agent‑rollen:</li>
<li> - Agent A (TDD Minimal): failures eerst, kleinste implementatie, snelle feedback</li>
<li> - Agent B (Integration/Telemetry): wiring + debug/metrics zichtbaar</li>
<li> - Agent C (Hardening): edge cases, error‑paths, timeouts en retries</li>
<li>Stappen:</li>
<p>  1) Schrijf/actualiseer tests (Unit + Integratie)</p>
<p>  2) Implementeer minimale oplossing (A)</p>
<p>  3) Integreer + logging/telemetry (B)</p>
<p>  4) Edge/hardening + timeouts/retries (C)</p>
<p>  5) Scoreboard & keuze</p>
<li>Commando’s:</li>
<li> - `pytest tests/unit/<spec>.py -q`</li>
<li> - `pytest tests/integration -q`</li>
<li>Criteria:</li>
<li> - [ ] Tests groen, debug‑zichtbaarheid, duidelijke DoD in PR</li>
</ul>

<h3>Analyse (bug/perf/arch)</h3>
<ul>
<li>Doel: reproduceerbaar, meetbaar, gefundeerde root‑cause en oplossingsopties.</li>
<li>Agent‑rollen:</li>
<li> - Agent A (Repro): minimal script + logging + toggles (flags/feature)</li>
<li> - Agent B (Trace/Perf): timers, timeouts, call‑graph, bottlenecks</li>
<li> - Agent C (Options): alternatieven, risico’s, impact, implementatieplan</li>
<li>Stappen:</li>
<p>  1) Minimal repro script (A) + toggles (bv. web lookup aan/uit)</p>
<p>  2) Trace tijden (B): timestamps rond kritieke fasen (AI, web lookup, validatie)</p>
<p>  3) Root‑cause + opties (C) → voorstel met DoD/risico’s/rollback</p>
<li>Commando’s (voorbeeld):</li>
<li> - `python debug_scripts/repro_<bug>.py`</li>
<li> - `export DEBUG_EXAMPLES=true` en logs inspecteren</li>
<li>Criteria:</li>
<li> - [ ] Repro duidelijk</li>
<li> - [ ] Root‑cause aannemelijk + alternatief vergeleken</li>
<li> - [ ] Aanbeveling met concrete stappen + verificatieplan</li>
</ul>

<h2>Aanvullende scripts (optioneel)</h2>
<ul>
<li>`scripts/agent_scoreboard.sh` — vergelijkt branches (duur/status)</li>
<li>`scripts/agent_quick_checks.sh` — draait EPIC‑010 greps en basis tests</li>
</ul>

  </div>
</body>
</html>