<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Handover — US‑160 Gate + Context Model V2 cutover</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">← Terug naar Portal</a>
    <p>---</p>
<p>canonical: true</p>
<p>status: active</p>
<p>owner: engineering</p>
<p>last_verified: 2025-09-13</p>
<p>applies_to: definitie-app@current</p>
<p>---</p>

<h1>Handover — US‑160 Gate + Context Model V2 cutover</h1>

<p>Doel: afronding van US‑160 (Gate bij Vaststellen) én uniformering van context (V2) naar drie gelijkwaardige lijsten: organisatorische_context, juridische_context, wettelijke_basis.</p>

<h2>Samenvatting</h2>
<ul>
<li>Context Model V2 geïmplementeerd (canoniek: drie lijsten overal; legacy `Definition.context` verwijderd).</li>
<li>Gate‑policy aangepast: “minimaal één context vereist” (i.p.v. org+jur verplicht).</li>
<li>UI (Bewerk/Expert/Generator) geharmoniseerd; “Anders…” werkt voor alle drie contexten.</li>
<li>Export/Repository/Orchestrator/Duplicate detection aangepast naar V2.</li>
<li>Documentatie geüpdatet; reset‑script toegevoegd.</li>
</ul>

<h2>Belangrijkste paden</h2>
<ul>
<li>Datamodel: `src/services/interfaces.py::Definition`</li>
<li>Repository mapping: `src/services/definition_repository.py`</li>
<li>DB‑schema: `src/database/schema.sql` (JSON arrays, default `[]`)</li>
<li>Gate‑policy: `config/approval_gate.yaml` (min_one_context_required)</li>
<li>Gate‑enforcement: `src/services/definition_workflow_service.py::_evaluate_gate`</li>
<li>UI tabs:</li>
<li> - Bewerk: `src/ui/components/definition_edit_tab.py` (3 multiselects + Anders…, min‑1 context)</li>
<li> - Expert: `src/ui/components/expert_review_tab.py` (geharmoniseerde weergave + 3 filters)</li>
<li> - Generator: `src/ui/components/definition_generator_tab.py` (geharmoniseerde weergave)</li>
<li>Orchestrator: `src/services/orchestrators/definition_orchestrator_v2.py` (V2 lijsten + UUID tolerant)</li>
<li>Prompt: `src/services/prompts/prompt_service_v2.py` (HybridContextManager)</li>
<li>Duplicate detection: `src/services/duplicate_detection_service.py` (exact op 3 lijsten, fuzzy tokenisatie/stemming)</li>
<li>Export: `src/services/data_aggregation_service.py`, `src/services/export_service.py`</li>
</ul>

<h2>Database reset (alle huidige data is testdata)</h2>
<ul>
<li>Script: `scripts/db/reset_context_model_v2.sh`</li>
<li>Voert uit: verwijderen `data/definities.db` + toepassen `src/database/schema.sql`.</li>
</ul>

<h2>Config & omgeving</h2>
<ul>
<li>OpenAI key via env: `OPENAI_API_KEY` (optioneel: `OPENAI_API_KEY_PROD`).</li>
<li>Gate‑policy overlay optioneel via env: `APPROVAL_GATE_CONFIG_OVERLAY`.</li>
</ul>

<h2>Testen (lokaal, met netwerk)</h2>
<p>1) Reset DB: <code>bash scripts/db/reset_context_model_v2.sh</code></p>
<p>2) Exporteer prod key: <code>export OPENAI_API_KEY="sk-..."</code></p>
<p>3) Draai suite: <code>pytest -q</code></p>

<p>Opmerking: in sandbox zonder netwerk falen netwerkafhankelijke tests; lokaal met key draaien.</p>

<h2>UI veranderingen</h2>
<ul>
<li>Bewerk‑tab</li>
<li> - Drie multiselects (Organisatorisch/Juridisch/Wettelijk) met “Anders…”.</li>
<li> - Opslaan vereist dat minimaal één contextlijst niet leeg is.</li>
<li>Expert‑tab</li>
<li> - Consistente contextweergave (org/jur/wet).</li>
<li> - Filters per contextsoort (multiselect, inclusieve overlap; AND tussen categorieën).</li>
<li>Generator‑tab</li>
<li> - Consistente contextweergave (org/jur/wet).</li>
</ul>

<h2>Gate‑policy & enforcement</h2>
<ul>
<li>`config/approval_gate.yaml`:</li>
<li> - `hard_requirements.min_one_context_required: true`</li>
<li> - `hard_min_score: 0.75`, `soft_min_score: 0.65`, `forbid_critical_issues: true`.</li>
<li>Service‑gate afdwinging vóór statuswijziging in `DefinitionWorkflowService.approve()`.</li>
</ul>

<h2>Export</h2>
<ul>
<li>JSON: context_dict bevat drie lijsten.</li>
<li>CSV: extra kolommen `organisatorische_context`, `juridische_context`, `wettelijke_basis` (stringrepresentatie).</li>
</ul>

<h2>Bekende aandachtspunten</h2>
<ul>
<li>Unieke constraint gebruikt JSON‑strings (ordegevoelig). In de praktijk zelden een probleem; normalisatie (gesorteerde serialisatie) kan later.</li>
<li>Enkele performance/benchmark tests hebben strikte timing‑assumpties; lokaal kunnen ze variëren.</li>
</ul>

<h2>Quick smoke (functioneel)</h2>
<ul>
<li>Maak definitie met alleen juridisch (bijv. “Strafrecht”) → opslaan OK, vaststellen mogelijk indien gate/score OK.</li>
<li>Maak definitie zonder context → opslaan blokkeert; gate blokkeert vaststellen met melding.</li>
<li>“Anders…” toevoegen bij alle drie contexten, opslaan, heropen: waarden zichtbaar.</li>
<li>Expert‑wachtrij: filter op Organisatorisch/Juridisch/Wettelijk; controleer dat filters contextgevoelig werken.</li>
</ul>

<h2>Wijzigingslog (kernbestanden)</h2>
<ul>
<li>Toegevoegd: `docs/architectuur/CONTEXT_MODEL_V2.md`, `docs/HANDOVER-US-160-CONTEXT-MODEL-V2.md`, `scripts/db/reset_context_model_v2.sh`</li>
<li>Aangepast: zie “Belangrijkste paden”.</li>
</ul>

<h2>Contact / Owner</h2>
<ul>
<li>Engineering — Context Model V2 / US‑160 implementatie</li>
</ul>


  </div>
</body>
</html>