<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Migratiestrategie: Synoniemen, Antoniemen & AI-Toelichting naar definitie_voorbeelden</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">← Terug naar Portal</a>
    <h1>Migratiestrategie: Synoniemen, Antoniemen & AI-Toelichting naar definitie_voorbeelden</h1>

<h2>Executive Summary</h2>

<p>Dit document beschrijft een complete strategie om synoniemen, antoniemen en AI-toelichting te migreren van de <code>definities</code> tabel naar de <code>definitie_voorbeelden</code> tabel. Deze migratie verbetert de datastructuur door gebruik te maken van de rijkere tracking mogelijkheden van de voorbeelden tabel.</p>

<h2>Huidige Situatie</h2>

<h3>Database Schema</h3>
<ul>
<li>**definities tabel**:</li>
<li> - `synoniemen TEXT` - JSON array van synoniemen</li>
<li> - `toelichting_proces TEXT` - Procesmatige toelichting (review/validatie notities)</li>
<li> - GEEN expliciete kolommen voor antoniemen of AI-toelichting</li>
</ul>

<ul>
<li>**definitie_voorbeelden tabel**:</li>
<li> - Ondersteunt al types: `'synonyms'`, `'antonyms'`, `'explanation'`</li>
<li> - Bevat rijke metadata: wie, wanneer, beoordeling, generation parameters</li>
<li> - Heeft actief/inactief status voor versioning</li>
</ul>

<h3>Dataflow Analyse</h3>

<ol>
<li>**Synoniemen**:</li>
</ol>
<ul>
<li>  - Worden opgeslagen als JSON array in `definities.synoniemen`</li>
<li>  - Worden gelezen via `Definition.synoniemen` property</li>
<li>  - Import service parsed CSV velden naar synoniemen lijst</li>
</ul>

<ol>
<li>**Antoniemen**:</li>
</ol>
<ul>
<li>  - NIET expliciet opgeslagen in definities tabel</li>
<li>  - WEL ondersteund in voorbeelden tabel met type='antonyms'</li>
<li>  - Worden gegenereerd door AI maar niet persistent opgeslagen</li>
</ul>

<ol>
<li>**AI-Toelichting**:</li>
</ol>
<ul>
<li>  - NIET expliciet in definities tabel (alleen proces toelichting)</li>
<li>  - WEL ondersteund in voorbeelden tabel met type='explanation'</li>
<li>  - Wordt gegenereerd maar niet opgeslagen</li>
</ul>

<h2>Voorgestelde Database Strategie</h2>

<h3>1. Opslagmodel: Één Record per Item</h3>

<p><strong>Rationale</strong>: Maximum flexibiliteit en consistentie met bestaande voorbeelden structuur.</p>

<pre><code>-- Elke synoniem als aparte rij
INSERT INTO definitie_voorbeelden (
    definitie_id, voorbeeld_type, voorbeeld_tekst, voorbeeld_volgorde, actief
) VALUES
    (123, 'synonyms', 'alternatieve term 1', 1, TRUE),
    (123, 'synonyms', 'alternatieve term 2', 2, TRUE),
    (123, 'synonyms', 'andere benaming', 3, TRUE);

-- Elke antoniem als aparte rij
INSERT INTO definitie_voorbeelden (
    definitie_id, voorbeeld_type, voorbeeld_tekst, voorbeeld_volgorde, actief
) VALUES
    (123, 'antonyms', 'tegengestelde term 1', 1, TRUE),
    (123, 'antonyms', 'tegengestelde term 2', 2, TRUE);

-- AI-toelichting als enkele rij (lange tekst)
INSERT INTO definitie_voorbeelden (
    definitie_id, voorbeeld_type, voorbeeld_tekst, voorbeeld_volgorde, actief
) VALUES
    (123, 'explanation', 'Uitgebreide AI-gegenereerde toelichting...', 1, TRUE);</code></pre>

<h3>2. Voordelen van Deze Aanpak</h3>

<ul>
<li>**Consistentie**: Zelfde structuur als andere voorbeelden types</li>
<li>**Flexibiliteit**: Elke synoniem/antoniem kan apart beoordeeld worden</li>
<li>**Versioning**: Actief/inactief status per item</li>
<li>**Metadata**: Generation info, beoordeling per item mogelijk</li>
<li>**Query Performance**: Makkelijk filteren op type + actief status</li>
</ul>

<h3>3. Database Migratie Script</h3>

<pre><code>-- Stap 1: Migreer bestaande synoniemen van definities naar voorbeelden
INSERT INTO definitie_voorbeelden (
    definitie_id,
    voorbeeld_type,
    voorbeeld_tekst,
    voorbeeld_volgorde,
    gegenereerd_door,
    actief,
    aangemaakt_op
)
SELECT
    d.id,
    'synonyms',
    json_each.value,
    json_each.key + 1,  -- volgorde gebaseerd op array positie
    'migration',
    TRUE,
    CURRENT_TIMESTAMP
FROM definities d,
     json_each(d.synoniemen)
WHERE d.synoniemen IS NOT NULL
  AND d.synoniemen != '[]'
  AND d.synoniemen != '';

-- Stap 2: Verwijder synoniemen kolom (na verificatie)
-- ALTER TABLE definities DROP COLUMN synoniemen;</code></pre>

<h2>Code Aanpassingen per Module</h2>

<h3>1. Definition Class (`src/services/interfaces.py`)</h3>

<pre><code>@dataclass
class Definition:
    """Definitie data object met alle metadata."""

    # Bestaande velden...
    id: int | None = None
    begrip: str = ""
    definitie: str = ""

    # DEPRECATED - wordt lazy loaded uit voorbeelden tabel
    # synoniemen: list[str] | None = None

    # Nieuwe properties voor lazy loading
    _synoniemen: list[str] | None = None
    _antoniemen: list[str] | None = None
    _ai_toelichting: str | None = None
    _voorbeelden_loaded: bool = False

    @property
    def synoniemen(self) -&gt; list[str]:
        """Lazy load synoniemen uit voorbeelden tabel."""
        if not self._voorbeelden_loaded and self.id:
            self._load_voorbeelden()
        return self._synoniemen or []

    @property
    def antoniemen(self) -&gt; list[str]:
        """Lazy load antoniemen uit voorbeelden tabel."""
        if not self._voorbeelden_loaded and self.id:
            self._load_voorbeelden()
        return self._antoniemen or []

    @property
    def ai_toelichting(self) -&gt; str:
        """Lazy load AI-toelichting uit voorbeelden tabel."""
        if not self._voorbeelden_loaded and self.id:
            self._load_voorbeelden()
        return self._ai_toelichting or ""

    def _load_voorbeelden(self):
        """Load voorbeelden data van repository (injected via metadata)."""
        if self.metadata and 'repository' in self.metadata:
            repo = self.metadata['repository']
            voorbeelden = repo.get_voorbeelden_by_type(self.id)
            self._synoniemen = voorbeelden.get('synonyms', [])
            self._antoniemen = voorbeelden.get('antonyms', [])
            explanations = voorbeelden.get('explanation', [])
            self._ai_toelichting = explanations[0] if explanations else ""
        self._voorbeelden_loaded = True</code></pre>

<h3>2. DefinitionRepository (`src/services/definition_repository.py`)</h3>

<pre><code>class DefinitionRepository:

    def save(self, definition: Definition) -&gt; int:
        """Sla definitie op inclusief synoniemen/antoniemen in voorbeelden."""

        # Sla hoofdrecord op (zonder synoniemen kolom)
        definition_id = self._save_main_record(definition)

        # Sla synoniemen/antoniemen/toelichting op in voorbeelden tabel
        if definition.synoniemen or definition.antoniemen or definition.ai_toelichting:
            voorbeelden_dict = {}

            if definition.synoniemen:
                voorbeelden_dict['synonyms'] = definition.synoniemen
            if definition.antoniemen:
                voorbeelden_dict['antonyms'] = definition.antoniemen
            if definition.ai_toelichting:
                voorbeelden_dict['explanation'] = [definition.ai_toelichting]

            self.legacy_repo.save_voorbeelden(
                definition_id,
                voorbeelden_dict,
                generation_model=definition.metadata.get('model'),
                gegenereerd_door=definition.metadata.get('created_by', 'system')
            )

        return definition_id

    def get(self, definition_id: int) -&gt; Definition | None:
        """Haal definitie op inclusief synoniemen/antoniemen."""

        # Haal hoofdrecord op
        definition = self._get_main_record(definition_id)
        if not definition:
            return None

        # Injecteer repository voor lazy loading
        if not definition.metadata:
            definition.metadata = {}
        definition.metadata['repository'] = self

        # Voorbeelden worden lazy loaded via properties
        return definition

    def search(self, **criteria) -&gt; list[Definition]:
        """Zoek definities met voorbeelden."""
        definitions = self._search_main_records(**criteria)

        # Injecteer repository voor lazy loading
        for definition in definitions:
            if not definition.metadata:
                definition.metadata = {}
            definition.metadata['repository'] = self

        return definitions</code></pre>

<h3>3. DefinitionImportService (`src/services/definition_import_service.py`)</h3>

<pre><code>def _payload_to_definition(self, payload: Dict[str, Any]) -&gt; Definition:
    """Converteer import payload naar Definition object."""

    # Bestaande velden...
    definition = Definition(
        begrip=payload.get('begrip', ''),
        definitie=payload.get('definitie', ''),
        # ... andere velden
    )

    # Parse synoniemen/antoniemen voor nieuwe structuur
    synoniemen_str = payload.get('Synoniemen', payload.get('synoniemen', ''))
    if synoniemen_str:
        definition._synoniemen = [s.strip() for s in synoniemen_str.split(',')]

    antoniemen_str = payload.get('Antoniemen', payload.get('antoniemen', ''))
    if antoniemen_str:
        definition._antoniemen = [a.strip() for a in antoniemen_str.split(',')]

    # AI toelichting (kan uit 'Toelichting' veld komen)
    toelichting = payload.get('Toelichting', '')
    if toelichting and not payload.get('Toelichting (optioneel)'):
        # Als alleen hoofdtoelichting, gebruik als AI-toelichting
        definition._ai_toelichting = toelichting
        definition._voorbeelden_loaded = True  # Prevent lazy loading

    return definition</code></pre>

<h3>4. UI Components Updates</h3>

<pre><code># In definition_edit_tab.py en expert_review_tab.py

def display_synoniemen(definition: Definition):
    """Toon synoniemen uit voorbeelden tabel."""
    # Properties doen automatisch lazy loading
    synoniemen = definition.synoniemen  # Haalt uit voorbeelden tabel

    if synoniemen:
        st.write("**Synoniemen:**")
        for syn in synoniemen:
            st.write(f"- {syn}")

    # Edit mogelijkheid
    new_synoniemen = st.text_area(
        "Synoniemen bewerken (komma-gescheiden)",
        value=", ".join(synoniemen)
    )

    if st.button("Synoniemen opslaan"):
        # Update via repository
        voorbeelden_dict = {'synonyms': [s.strip() for s in new_synoniemen.split(',')]}
        repository.save_voorbeelden(definition.id, voorbeelden_dict)</code></pre>

<h2>Backward Compatibility Plan</h2>

<h3>Fase 1: Dual-Write (2 weken)</h3>
<ol>
<li>**Schrijf naar beide locaties**: Nieuwe data naar zowel `synoniemen` kolom als `voorbeelden` tabel</li>
<li>**Lees met fallback**: Eerst uit `voorbeelden`, dan uit `synoniemen` kolom</li>
<li>**Monitor**: Log waar data vandaan komt voor analyse</li>
</ol>

<h3>Fase 2: Migratie (1 week)</h3>
<ol>
<li>**Run migratie script**: Verplaats alle bestaande synoniemen naar voorbeelden</li>
<li>**Verificatie**: Check dat alle data correct gemigreerd is</li>
<li>**Backup**: Maak backup van definities tabel voor rollback</li>
</ol>

<h3>Fase 3: Cutover (1 dag)</h3>
<ol>
<li>**Stop dual-write**: Schrijf alleen naar voorbeelden tabel</li>
<li>**Update reads**: Haal alles uit voorbeelden tabel</li>
<li>**Deprecate kolom**: Markeer synoniemen kolom als deprecated</li>
</ol>

<h3>Fase 4: Cleanup (na 1 maand)</h3>
<ol>
<li>**Verwijder kolom**: `ALTER TABLE definities DROP COLUMN synoniemen`</li>
<li>**Cleanup code**: Verwijder legacy code paths</li>
</ol>

<h2>Performance Overwegingen</h2>

<h3>Query Performance</h3>
<ul>
<li>**Index strategie**: Bestaande indexes op `definitie_voorbeelden` zijn voldoende</li>
<li>**Lazy loading**: Voorkom N+1 queries met batch loading waar nodig</li>
<li>**Caching**: Cache voorbeelden in Definition object na eerste load</li>
</ul>

<h3>Geschatte Impact</h3>
<ul>
<li>**Read performance**: Marginaal langzamer (extra join), maar met caching vergelijkbaar</li>
<li>**Write performance**: Iets langzamer (2 inserts ipv 1), maar acceptabel</li>
<li>**Storage**: Meer rows maar minder JSON parsing overhead</li>
</ul>

<h3>Optimalisaties</h3>
<pre><code># Batch load voorbeelden voor meerdere definities
def load_voorbeelden_batch(definitions: list[Definition]):
    """Efficient batch loading van voorbeelden."""
    ids = [d.id for d in definitions if d.id]

    # Single query voor alle voorbeelden
    all_voorbeelden = repository.get_voorbeelden_for_ids(ids)

    # Map naar definities
    for definition in definitions:
        if definition.id in all_voorbeelden:
            voorbeelden = all_voorbeelden[definition.id]
            definition._synoniemen = voorbeelden.get('synonyms', [])
            definition._antoniemen = voorbeelden.get('antonyms', [])
            definition._ai_toelichting = voorbeelden.get('explanation', [''])[0]
            definition._voorbeelden_loaded = True</code></pre>

<h2>Testing Strategie</h2>

<h3>Unit Tests</h3>
<pre><code>def test_synoniemen_migration():
    """Test dat synoniemen correct gemigreerd worden."""
    # Create definitie met synoniemen in oude structuur
    old_def = create_legacy_definition_with_synoniemen()

    # Run migratie
    migrate_synoniemen(old_def.id)

    # Verificeer in nieuwe structuur
    new_def = repository.get(old_def.id)
    assert new_def.synoniemen == old_def.synoniemen</code></pre>

<h3>Integration Tests</h3>
<ul>
<li>Test import flow met synoniemen/antoniemen</li>
<li>Test export met nieuwe structuur</li>
<li>Test UI weergave en editing</li>
</ul>

<h3>Performance Tests</h3>
<ul>
<li>Benchmark read/write performance voor/na migratie</li>
<li>Load test met 1000+ definities</li>
<li>Memory profiling voor lazy loading</li>
</ul>

<h2>Risico's en Mitigaties</h2>

<p>| Risico | Impact | Kans | Mitigatie |</p>
<p>|--------|--------|------|-----------|</p>
<p>| Data verlies tijdens migratie | Hoog | Laag | Backup + rollback plan |</p>
<p>| Performance degradatie | Medium | Medium | Caching + batch loading |</p>
<p>| Backward compatibility issues | Medium | Laag | Dual-write periode |</p>
<p>| UI bugs door lazy loading | Laag | Medium | Uitgebreide testing |</p>

<h2>Implementatie Timeline</h2>

<h3>Week 1</h3>
<ul>
<li>[ ] Database migratie script ontwikkelen</li>
<li>[ ] Definition class aanpassen met lazy loading</li>
<li>[ ] Repository layer updaten</li>
</ul>

<h3>Week 2</h3>
<ul>
<li>[ ] Import service aanpassen</li>
<li>[ ] UI components updaten</li>
<li>[ ] Unit tests schrijven</li>
</ul>

<h3>Week 3</h3>
<ul>
<li>[ ] Dual-write implementeren</li>
<li>[ ] Integration tests</li>
<li>[ ] Performance testing</li>
</ul>

<h3>Week 4</h3>
<ul>
<li>[ ] Productie migratie</li>
<li>[ ] Monitoring</li>
<li>[ ] Documentatie updaten</li>
</ul>

<h2>Conclusie</h2>

<p>Deze migratiestrategie biedt een robuuste en schone oplossing die:</p>
<ol>
<li>**Hergebruikt** bestaande infrastructuur maximaal</li>
<li>**Verbetert** data consistency en tracking mogelijkheden</li>
<li>**Behoudt** backward compatibility tijdens transitie</li>
<li>**Minimaliseert** performance impact</li>
<li>**Vereenvoudigt** toekomstig onderhoud</li>
</ol>

<p>De gefaseerde aanpak zorgt voor een veilige migratie met rollback mogelijkheden op elk punt.</p>
  </div>
</body>
</html>