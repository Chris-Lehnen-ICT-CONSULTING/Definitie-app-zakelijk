<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Export Architecture Problem - Visual Diagram</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">← Terug naar Portal</a>
    <h1>Export Architecture Problem - Visual Diagram</h1>

<h2>Current State: Bifurcated Export Paths</h2>

<pre><code>┌─────────────────────────────────────────────────────────────────────┐
│                    DefinitieRecord (31 fields)                      │
│  Database: data/definities.db - schema.sql defines 31 fields       │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                    ┌──────────────┴──────────────┐
                    │                             │
         ┌──────────▼─────────┐        ┌─────────▼──────────┐
         │  PATH 1: BULK      │        │ PATH 2: SINGLE     │
         │  Import/Export Tab │        │ Generator Tab      │
         └──────────┬─────────┘        └─────────┬──────────┘
                    │                             │
         ┌──────────▼─────────┐        ┌─────────▼──────────────────┐
         │  FormatExporter    │        │  UIComponentsAdapter       │
         │  (UI Component)    │        │  (Service Bridge)          │
         └──────────┬─────────┘        └─────────┬──────────────────┘
                    │                             │
         ┌──────────▼─────────┐        ┌─────────▼──────────────────┐
         │ CUSTOM EXPORT      │        │  ExportService             │
         │ IMPLEMENTATION     │        │  (Service Layer)           │
         └──────────┬─────────┘        └─────────┬──────────────────┘
                    │                             │
         ┌──────────▼─────────┐        ┌─────────▼──────────────────┐
         │  • _to_dataframe() │        │  DataAggregationService    │
         │  • _generate_txt() │        │  + export_txt.py           │
         └──────────┬─────────┘        └─────────┬──────────────────┘
                    │                             │
         ┌──────────▼─────────┐        ┌─────────▼──────────────────┐
         │   8 FIELDS ❌      │        │   15+ FIELDS ✅            │
         │                    │        │                            │
         │ • begrip           │        │ • begrip                   │
         │ • definitie        │        │ • definitie                │
         │ • categorie        │        │ • categorie                │
         │ • org_context      │        │ • org_context              │
         │ • status           │        │ • juridische_context ✅    │
         │ • validation_score │        │ • wettelijke_basis ✅      │
         │ • created_at       │        │ • voorkeursterm ✅         │
         │ • updated_at       │        │ • ufo_categorie ✅         │
         │                    │        │ • validation_issues ✅     │
         │ MISSING 23 FIELDS! │        │ • approved_by/at ✅        │
         │ 74% DATA LOSS      │        │ • voorbeelden ✅           │
         │                    │        │ • synoniemen ✅            │
         │                    │        │ • + many more...           │
         └────────────────────┘        └────────────────────────────┘
              CSV/Excel/JSON                 TXT/JSON/CSV
            (Bulk Operations)              (Single Definition)</code></pre>

<h2>Problem Summary</h2>

<h3>Architectural Issue: Duplicate Export Implementations</h3>

<pre><code>ISSUE: Two separate codepaths, no code reuse

FormatExporter                   ExportService
     │                                │
     ├─ Minimal field set             ├─ Comprehensive field set
     ├─ Reimplements TXT export       ├─ Reuses export_txt.py
     ├─ Custom DataFrame logic        ├─ Uses DataAggregationService
     └─ No service layer              └─ Clean architecture</code></pre>

<h3>User Impact: "Export is beperkt"</h3>

<pre><code>USER EXPECTATION:                  ACTUAL RESULT:
┌────────────────┐                ┌────────────────┐
│ Export ALL     │                │ Export SOME    │
│ definition     │      ❌        │ definition     │
│ data from      │   ───────▶     │ data from      │
│ database       │                │ database       │
│                │                │                │
│ 31 fields      │                │ 8 fields       │
│ 100% coverage  │                │ 26% coverage   │
└────────────────┘                └────────────────┘
        │                                │
        │                                │
        ▼                                ▼
  "I need legal context         "Export doesn't have
   and approval data             juridische_context!?"
   in my export"                 - User complaint</code></pre>

<h2>Proposed Solution: Unified Export Architecture</h2>

<pre><code>┌─────────────────────────────────────────────────────────────────────┐
│                    DefinitieRecord (31 fields)                      │
│         + NEW: to_export_dict() method (28 user-facing)             │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                    ┌──────────────┴──────────────┐
                    │                             │
         ┌──────────▼─────────┐        ┌─────────▼──────────┐
         │  PATH 1: BULK      │        │ PATH 2: SINGLE     │
         │  Import/Export Tab │        │ Generator Tab      │
         └──────────┬─────────┘        └─────────┬──────────┘
                    │                             │
         ┌──────────▼─────────┐        ┌─────────▼──────────┐
         │  FormatExporter    │        │ UIComponentsAdapter│
         │  REFACTORED ✅     │        │  (unchanged)       │
         └──────────┬─────────┘        └─────────┬──────────┘
                    │                             │
                    └──────────────┬──────────────┘
                                   │
                         ┌─────────▼──────────────────┐
                         │   ExportService            │
                         │   ENHANCED ✅              │
                         │                            │
                         │ + export_definitions_bulk()│
                         └─────────┬──────────────────┘
                                   │
                         ┌─────────▼──────────────────┐
                         │ DataAggregationService     │
                         │ + export_txt.py            │
                         │ + DefinitieRecord methods  │
                         └─────────┬──────────────────┘
                                   │
                         ┌─────────▼──────────────────┐
                         │   28 FIELDS ✅             │
                         │   (All user-facing data)   │
                         │                            │
                         │ Excludes only internal:    │
                         │ • last_exported_at         │
                         │ • export_destinations      │
                         │ • (deprecated fields)      │
                         └────────────────────────────┘
                            TXT/CSV/Excel/JSON
                           (All Export Paths)</code></pre>

<h2>Key Changes</h2>

<h3>1. Single Export Authority</h3>
<pre><code>BEFORE:                          AFTER:
FormatExporter ─┐                FormatExporter ─┐
                ├─ export logic                  │
ExportService ──┘                                ├─▶ ExportService
                                                 │   (SINGLE source)
UIAdapter ──────▶ ExportService  UIAdapter ─────┘</code></pre>

<h3>2. Field Coverage Validation</h3>
<pre><code>NEW: Automated Test
┌────────────────────────────────┐
│ test_export_field_coverage()   │
│                                │
│ record_fields = 31             │
│ internal_fields = 3            │
│ expected_export = 28           │
│                                │
│ actual_export = count_fields() │
│                                │
│ assert actual == expected ✅   │
└────────────────────────────────┘</code></pre>

<h3>3. Backward Compatibility</h3>
<pre><code>DefinitieRecord.to_export_dict(mode='full')    → 28 fields
DefinitieRecord.to_export_dict(mode='legacy')  → 8 fields (if needed)
DefinitieRecord.to_export_dict(mode='minimal') → 5 fields (core only)</code></pre>

<h2>Migration Impact</h2>

<h3>Before vs After Comparison</h3>

<pre><code>EXPORT FILE SIZE:                DATA COVERAGE:

Before: ~5KB per definition      Before: 26% (8/31 fields)
After:  ~15KB per definition     After:  90% (28/31 fields)

Growth: ~3x                      Improvement: +246%
Impact: Acceptable               User Value: HIGH</code></pre>

<h3>Stakeholder Impact</h3>

<pre><code>┌────────────────┐  ┌────────────────┐  ┌────────────────┐
│ Legal Team     │  │ Data Analysts  │  │ Auditors       │
├────────────────┤  ├────────────────┤  ├────────────────┤
│ ✅ Gets legal  │  │ ✅ Full data   │  │ ✅ Approval    │
│    context     │  │    for analysis│  │    trail       │
│ ✅ Wettelijke  │  │ ✅ Source info │  │ ✅ Version     │
│    basis       │  │ ✅ Validation  │  │    history     │
└────────────────┘  └────────────────┘  └────────────────┘</code></pre>

<h2>Conclusion</h2>

<p><strong>Problem:</strong> Architectural bifurcation leading to 74% data loss</p>
<p><strong>Solution:</strong> Unify through service layer with comprehensive field mapping</p>
<p><strong>Effort:</strong> 7.5 hours</p>
<p><strong>Risk:</strong> LOW (with rollback plan)</p>
<p><strong>Value:</strong> HIGH (resolves user complaint, improves data quality)</p>

  </div>
</body>
</html>