<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Handover Document: Epic-010 Context Flow Analysis & Harmonisatie</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">â† Terug naar Portal</a>
    <h1>Handover Document: Epic-010 Context Flow Analysis & Harmonisatie</h1>

<h2>ğŸ“… Datum: 2025-09-09 (Update: 2025-09-10)</h2>
<h2>ğŸ‘¤ Analyst: Claude Code</h2>
<h2>ğŸ¯ Doel: Context flow harmonisatie en legacy domein veld verwijdering</h2>

<h2>ğŸ“Š Status Epic-010: Context Flow Refactoring (2025-09-10)</h2>

<h3>User Stories Status</h3>
<ul>
<li>**US-041**: Fix Context Field Mapping to Prompts - **âœ… GEREED**</li>
<li>**US-042**: Fix "Anders..." Custom Context Option - **âœ… GEREED**</li>
<li>**US-043**: Remove Legacy Context Routes - **ğŸŸ¡ OPEN**</li>
<li>**US-048**: Context Type Validation - **ğŸŸ¡ OPEN**</li>
<li>**US-049**: Context Traceability for ASTRA - **ğŸŸ¡ OPEN**</li>
<li>**US-050**: End-to-End Context Tests - **ğŸŸ¡ OPEN**</li>
</ul>

<h2>ğŸ” Analyse Resultaten</h2>

<h3>Context Flow Tracing</h3>

<h4>1. UI Context Collectie âœ…</h4>
<p><strong>Locatie:</strong> <code>src/ui/tabbed_interface.py:638</code></p>
<pre><code>from ui.components.enhanced_context_manager_selector import render_context_selector
return render_context_selector()</code></pre>
<p><strong>Output:</strong></p>
<pre><code>{
    "organisatorische_context": [...],
    "juridische_context": [...],
    "wettelijke_basis": [...]
}</code></pre>

<h4>2. Service Layer Ontvangst âš ï¸ INCONSISTENTIE GEVONDEN</h4>
<p><strong>Locatie:</strong> <code>src/ui/tabbed_interface.py:799-805</code></p>
<pre><code>service_result = self.definition_service.generate_definition_sync(
    begrip=begrip,
    context_dict={
        "organisatorisch": org_context,      # Gebruikt variabele
        "juridisch": jur_context,            # Gebruikt variabele
        "wettelijk": context_data.get("wettelijke_basis", [])  # Direct uit context_data!
    },
    organisatie=primary_org,
    categorie=auto_categorie,
)</code></pre>

<p><strong>âš ï¸ PROBLEEM:</strong> Inconsistente data handling:</p>
<ul>
<li>`org_context` en `jur_context` komen uit variabelen (mogelijk bewerkt)</li>
<li>`wettelijke_basis` komt direct uit `context_data` (onbewerkt)</li>
</ul>

<h4>3. Request Aanmaak âœ…</h4>
<p><strong>Locatie:</strong> <code>src/services/service_factory.py:337-339</code></p>
<pre><code>request = GenerationRequest(
    organisatorische_context=org_list,
    juridische_context=context_dict.get("juridisch", []),
    wettelijke_basis=context_dict.get("wettelijk", []),
)</code></pre>

<h4>4. Context Enrichment âœ…</h4>
<p><strong>Locatie:</strong> <code>src/services/definition_generator_context.py:258-260</code></p>
<pre><code>extend_unique(getattr(request, "organisatorische_context", None), context["organisatorisch"])
extend_unique(getattr(request, "juridische_context", None), context["juridisch"])
extend_unique(getattr(request, "wettelijke_basis", None), context["wettelijk"])</code></pre>

<h4>5. Prompt Building âœ…</h4>
<p><strong>Locatie:</strong> <code>src/services/prompts/modules/definition_task_module.py:285-297</code></p>
<pre><code>lines.append(f"- Organisatorische context: {', '.join(org_contexts)}")
lines.append(f"- Juridische context: {', '.join(jur_contexts)}")
lines.append(f"- Wettelijke basis: {', '.join(wet_basis)}")</code></pre>

<h2>ğŸ› Gevonden Issues</h2>

<h3>1. Inconsistente Context Verwerking</h3>
<p><strong>Severiteit:</strong> MEDIUM</p>
<p><strong>Locatie:</strong> <code>src/ui/tabbed_interface.py:801-805</code></p>

<p>De wettelijke basis wordt anders behandeld dan andere context velden:</p>
<ul>
<li>`organisatorisch` en `juridisch` gebruiken voorbewerkte variabelen</li>
<li>`wettelijk` haalt direct uit raw `context_data`</li>
</ul>

<p>Dit kan leiden tot:</p>
<ul>
<li>Missende transformaties voor wettelijke basis</li>
<li>"Anders..." optie werkt mogelijk niet voor wettelijke basis</li>
<li>Inconsistente data sanitization</li>
</ul>

<h3>2. Mogelijke Data Loss Points</h3>
<p><strong>Severiteit:</strong> LOW</p>

<p>Onderzoek waar <code>org_context</code> en <code>jur_context</code> vandaan komen:</p>
<ul>
<li>Worden deze getransformeerd?</li>
<li>Is er filtering toegepast?</li>
<li>Waarom geen `wet_context` variabele?</li>
</ul>

<h2>âœ… Wat Werkt</h2>

<ol>
<li>**Context wordt WEL doorgegeven** van UI naar prompts</li>
<li>**"Anders..." optie** werkt nu zonder crashes (vandaag gefixt)</li>
<li>**Wetboek van Strafvordering** opties zijn hersteld (huidig/toekomstig)</li>
<li>**Alle drie context types** komen in de finale prompt</li>
</ol>

<h2>ğŸ”§ Aanbevolen Fixes</h2>

<h3>Prioriteit 1: Consistente Context Handling</h3>
<pre><code># HUIDIGE CODE (inconsistent)
context_dict={
    "organisatorisch": org_context,
    "juridisch": jur_context,
    "wettelijk": context_data.get("wettelijke_basis", [])
}

# VOORGESTELDE FIX
wet_context = context_data.get("wettelijke_basis", [])
# Pas dezelfde transformaties toe als op org_context en jur_context
context_dict={
    "organisatorisch": org_context,
    "juridisch": jur_context,
    "wettelijk": wet_context
}</code></pre>

<h3>Prioriteit 2: Onderzoek Context Transformaties</h3>
<ol>
<li>Trace waar `org_context` en `jur_context` worden aangemaakt</li>
<li>Identificeer welke transformaties worden toegepast</li>
<li>Pas dezelfde transformaties toe op `wettelijke_basis`</li>
</ol>

<h2>ğŸ“‹ Openstaande Taken Epic-010</h2>

<h3>Moet Nog Gebeuren:</h3>
<ol>
<li>**US-043**: Legacy context routes verwijderen</li>
<li>**US-048**: Type validatie implementeren</li>
<li>**US-049**: ASTRA compliance audit trail</li>
<li>**US-050**: End-to-end tests schrijven</li>
</ol>

<h3>Al Opgelost:</h3>
<ul>
<li>âœ… Context wordt doorgegeven (US-041 deels)</li>
<li>âœ… "Anders..." optie werkt (US-042)</li>
<li>âœ… Wetboek opties hersteld</li>
</ul>

<h2>ğŸ¯ Conclusie</h2>

<p>US-041 is afgerond: mapping is aanwezig in PromptServiceV2 en V2â€‘contracten; UIâ€‘keys zijn geverifieerd. Inconsistente verwerking van wettelijke basis is verholpen in de huidige UIâ€‘flow.</p>

<p>De context flow werkt technisch, maar heeft verbetering nodig in:</p>
<ol>
<li>Consistente data handling</li>
<li>Legacy route cleanup</li>
<li>Proper testing</li>
<li>ASTRA compliance</li>
</ol>

<p>---</p>

<h2>ğŸ§­ Actieplan afronding EPICâ€‘010</h2>

<h3>Uitgevoerde Wijzigingen</h3>

<h4>1. **Legacy `domein` veld volledig verwijderd**</h4>
<ul>
<li>âœ… `src/services/interfaces.py` - domein veld verwijderd uit GenerationRequest en Definition</li>
<li>âœ… `src/services/prompts/prompt_service_v2.py` - domein mapping verwijderd</li>
<li>âœ… `src/services/definition_generator_context.py` - domein context verwijderd</li>
<li>âœ… `src/services/service_factory.py` - domein_text variabele volledig verwijderd</li>
<li>âœ… `src/services/definition_orchestrator.py` - domein referenties verwijderd</li>
<li>âœ… `src/services/orchestrators/definition_orchestrator_v2.py` - domein verwijderd</li>
<li>âœ… `src/orchestration/definitie_agent.py` - domein mapping verwijderd</li>
</ul>

<h4>2. **Context Harmonisatie in UI**</h4>
<ul>
<li>âœ… `src/ui/tabbed_interface.py`:</li>
<pre><code>  # Consistente variabelen voor alle 3 types
  org_context = context_data.get("organisatorische_context", [])
  jur_context = context_data.get("juridische_context", [])
  wet_context = context_data.get("wettelijke_basis", [])  # NIEUW</code></pre>
</ul>

<h4>3. **Context Sharing Modules Updated**</h4>
<ul>
<li>âœ… `src/services/prompts/modules/context_awareness_module.py`:</li>
<li> - Verwijderd: `domain_contexts` sharing</li>
<li> - Toegevoegd: `juridical_contexts` en `legal_basis_contexts` sharing</li>
<li> - Nu worden alle 3 actieve context types gedeeld</li>
</ul>

<ul>
<li>âœ… `src/services/prompts/modules/error_prevention_module.py`:</li>
<li> - Updated om juridical_contexts en legal_basis_contexts te gebruiken</li>
<li> - Domain context verboden vervangen door juridisch/wettelijk</li>
</ul>

<h4>4. **Verificatie**</h4>
<ul>
<li>âœ… Geen `domein_text` referenties meer in codebase</li>
<li>âœ… Alle 3 context types worden consistent behandeld</li>
<li>âœ… Geen direct gebruik van `context_data` meer, alleen variabelen</li>
</ul>

<h3>Impact Analyse</h3>
<ul>
<li>**Breaking Changes**: Ja - `domein` veld is niet meer beschikbaar</li>
<li>**Backward Compatibility**: Behouden via juridische_context mapping</li>
<li>**Performance**: Neutraal - geen impact op performance</li>
<li>**Testing Required**: Unit tests voor context flow</li>
</ul>

<h3>Nieuwe Context Flow</h3>
<pre><code>UI Input â†’ 3 Context Types â†’ Consistente Variabelen â†’ Service Layer
   â†“              â†“                    â†“                     â†“
org_context  jur_context      wet_context           Alle modules</code></pre>

<p>1) USâ€‘043: Legacy context routes verwijderen (zie EPICâ€‘010 epic voor uitgewerkt plan)</p>
<p>2) USâ€‘048: Type validatie afdwingen (alle context velden lijst van strings)</p>
<p>3) USâ€‘049: ASTRA traceability uitbreiden (audit trail van context in metadata/logs)</p>
<p>4) USâ€‘050: E2E context tests uitbreiden en stabiliseren</p>

<p>Status: EPICâ€‘010 is deels afgerond (USâ€‘041/042 gereed); resterende stories staan open.</p>

  </div>
</body>
</html>