<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Juridische Synoniemen & Query Optimization</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">← Terug naar Portal</a>
    <h1>Juridische Synoniemen & Query Optimization</h1>

<p><strong>Status</strong>: ✅ Geïmplementeerd (Oct 2025)</p>
<p><strong>Doel</strong>: Verhoog web lookup coverage van 80% → 90% via juridische synoniemen en context-aware ranking</p>

<p>---</p>

<h2>Overzicht</h2>

<p>Deze feature voegt drie nieuwe capabilities toe aan de web lookup stack:</p>

<ol>
<li>**Juridische Synoniemen Database** - 60+ juridische begrippen met synoniemen</li>
<li>**Synonym Expansion** - Automatische query diversificatie voor Wikipedia + SRU</li>
<li>**Juridische Ranking Boost** - Context-aware prioritering van juridische content</li>
</ol>

<p><strong>Impact</strong>: Verwachte coverage verhoging van 80% naar 90% voor juridische begrippen.</p>

<p>---</p>

<h2>Architecture</h2>

<pre><code>┌─────────────────────────────────────────────────────────────┐
│                  ModernWebLookupService                      │
│                     (Orchestrator)                           │
└───────────────┬─────────────────────────────────┬───────────┘
                │                                 │
        ┌───────▼────────┐              ┌────────▼──────────┐
        │ WikipediaService│              │   SRUService      │
        │                │              │                   │
        │ + Synonym      │              │ + Synonym Query 0 │
        │   Fallback     │              │   Expansion       │
        └───────┬────────┘              └────────┬──────────┘
                │                                │
                └────────┬───────────────────────┘
                         │
                ┌────────▼─────────────────┐
                │ JuridischeSynoniemlService│
                │                           │
                │ + Bidirectionele lookup   │
                │ + Query expansion         │
                └────────┬──────────────────┘
                         │
                ┌────────▼──────────────────┐
                │ juridische_synoniemen.yaml│
                │                           │
                │ 60+ begrippen + synoniemen│
                └───────────────────────────┘

                ┌───────────────────────────┐
                │  JuridischRanker          │
                │                           │
                │ + Keyword boost           │
                │ + Artikel-ref boost       │
                │ + Context matching        │
                └───────────────────────────┘</code></pre>

<p>---</p>

<h2>Component 1: Juridische Synoniemen Database</h2>

<p><strong>File</strong>: <code>/config/juridische_synoniemen.yaml</code></p>

<h3>Structuur</h3>

<pre><code># Hoofdterm (met underscores)
onherroepelijk:
  - kracht van gewijsde
  - rechtskracht
  - in kracht van gewijsde
  - definitieve uitspraak

voorlopige_hechtenis:
  - voorarrest
  - bewaring
  - inverzekeringstelling</code></pre>

<h3>Categorieën</h3>

<ul>
<li>**Strafrecht (Sv/Sr)**: verdachte, dagvaarding, schuldig, strafbaar feit, etc.</li>
<li>**Bestuursrecht (Awb)**: beschikking, bezwaar, beroep, belanghebbende</li>
<li>**Burgerlijk recht (BW/Rv)**: overeenkomst, wanprestatie, schadevergoeding</li>
<li>**Procesrecht**: hoger beroep, cassatie, vonnis, getuige</li>
<li>**Algemene begrippen**: rechtspersoon, verjaring, redelijkheid, opzet</li>
</ul>

<p><strong>Totaal</strong>: 60+ hoofdtermen met 200+ synoniemen</p>

<h3>Synoniemen toevoegen</h3>

<ol>
<li>Edit `config/juridische_synoniemen.yaml`</li>
<li>Voeg hoofdterm toe met underscores (`_`) voor spaties</li>
<li>Voeg synoniemen toe als YAML lijst</li>
<li>Service laadt automatisch bij herstart</li>
</ol>

<p><strong>Voorbeeld</strong>:</p>

<pre><code>nieuwe_term:
  - synoniem1
  - synoniem2
  - synoniem3</code></pre>

<p>---</p>

<h2>Component 2: JuridischeSynoniemlService</h2>

<p><strong>File</strong>: <code>/src/services/web_lookup/synonym_service.py</code></p>

<h3>Features</h3>

<h4>Bidirectionele Lookup</h4>

<pre><code>service = get_synonym_service()

# Forward: hoofdterm → synoniemen
service.get_synoniemen("onherroepelijk")
# → ["kracht van gewijsde", "rechtskracht", ...]

# Reverse: synoniem → andere synoniemen + hoofdterm
service.get_synoniemen("kracht van gewijsde")
# → ["onherroepelijk", "rechtskracht", "in kracht van gewijsde", ...]</code></pre>

<h4>Query Expansion</h4>

<pre><code># Expand term met max N synoniemen voor query diversificatie
expanded = service.expand_query_terms("voorlopige hechtenis", max_synonyms=3)
# → ["voorlopige hechtenis", "voorarrest", "bewaring", "inverzekeringstelling"]</code></pre>

<h4>Check Synoniemen</h4>

<pre><code># Check of term synoniemen heeft
if service.has_synoniemen("verdachte"):
    # Gebruik synonym expansion</code></pre>

<h4>Text Analysis</h4>

<pre><code># Vind alle juridische termen in tekst
text = "De verdachte kreeg een onherroepelijke veroordeling"
matches = service.find_matching_synoniemen(text)
# → {
#     'verdachte': ['beklaagde', 'beschuldigde', ...],
#     'onherroepelijke': ['kracht van gewijsde', ...]
# }</code></pre>

<h3>Singleton Pattern</h3>

<pre><code>from .synonym_service import get_synonym_service

# Singleton instance (hergebruikt across calls)
service = get_synonym_service()

# Custom config path (creates new instance)
service = get_synonym_service(config_path="/custom/path/synoniemen.yaml")</code></pre>

<p>---</p>

<h2>Component 3: Wikipedia Synonym Fallback</h2>

<p><strong>File</strong>: <code>/src/services/web_lookup/wikipedia_service.py</code></p>

<h3>Workflow</h3>

<pre><code>1. Primaire search: "voorlopige hechtenis"
   ↓ (geen resultaten)

2. Synonym fallback enabled?
   ↓ YES

3. Expand query: ["voorarrest", "bewaring", "inverzekeringstelling"]
   ↓

4. Try synonym 1: "voorarrest"
   ↓ (SUCCESS!)

5. Return result</code></pre>

<h3>Code</h3>

<pre><code># Enable synonym fallback (default: True)
async with WikipediaService(enable_synonyms=True) as wiki:
    result = await wiki.lookup("voorlopige hechtenis")
    # Probeert automatisch synoniemen als primaire search faalt

# Disable synonym fallback
async with WikipediaService(enable_synonyms=False) as wiki:
    result = await wiki.lookup("voorlopige hechtenis")
    # Alleen primaire search, geen fallback</code></pre>

<h3>Logging</h3>

<pre><code>INFO: Wikipedia lookup voor term: voorlopige hechtenis
INFO: Primaire Wikipedia search gefaald, probeer synoniemen voor: voorlopige hechtenis
DEBUG: Wikipedia synonym fallback: probeer 'voorarrest'
INFO: Wikipedia match gevonden via synoniem: 'voorarrest' voor 'voorlopige hechtenis'</code></pre>

<p>---</p>

<h2>Component 4: SRU Synonym Query Expansion</h2>

<p><strong>File</strong>: <code>/src/services/web_lookup/sru_service.py</code></p>

<h3>Query 0: Juridische Synoniemen (NIEUW)</h3>

<p><strong>Positie</strong>: Eerste query (voor bestaande Query 1-6 cascade)</p>

<p><strong>Wanneer</strong>: Alleen als <code>has_synoniemen(term) == True</code></p>

<p><strong>Query structuur</strong>:</p>

<pre><code>(cql.serverChoice any "voorlopige hechtenis") OR
(cql.serverChoice any "voorarrest") OR
(cql.serverChoice any "bewaring") OR
(cql.serverChoice any "inverzekeringstelling")</code></pre>

<h3>Query Cascade (Updated)</h3>

<ol>
<li>**Query 0**: Juridische synoniemen expansion (NIEUW)</li>
<li>**Query 1**: DC-velden (title/subject/description)</li>
<li>**Query 2**: serverChoice all</li>
<li>**Query 3**: Hyphen variant</li>
<li>**Query 4**: serverChoice any</li>
<li>**Query 5**: Prefix wildcard</li>
<li>**Query 6**: Partial words</li>
</ol>

<h3>Circuit Breaker</h3>

<ul>
<li>**Threshold**: 4 lege resultaten (configurable per provider)</li>
<li>**Gedrag**: Stop cascade na N consecutive empty results</li>
<li>**Query 0 telt mee** voor circuit breaker</li>
</ul>

<h3>Code</h3>

<pre><code># Enable synonym expansion (default: True)
async with SRUService(enable_synonyms=True) as sru:
    results = await sru.search("voorlopige hechtenis", endpoint="overheid")
    # Probeert eerst synonym query (Query 0) als term synoniemen heeft

# Disable synonym expansion
async with SRUService(enable_synonyms=False) as sru:
    results = await sru.search("voorlopige hechtenis", endpoint="overheid")
    # Skip Query 0, start meteen bij Query 1</code></pre>

<h3>Logging</h3>

<pre><code>INFO: Query 0: Juridische synoniemen expansion voor 'voorlopige hechtenis'
DEBUG: Synoniemen query: (cql.serverChoice any "voorlopige hechtenis") OR (cql.serverChoice any "voorarrest") OR ...
INFO: Synoniemen query SUCCESS: 3 resultaten voor 'voorlopige hechtenis'</code></pre>

<p>---</p>

<h2>Component 5: Juridische Ranking Boost</h2>

<p><strong>File</strong>: <code>/src/services/web_lookup/juridisch_ranker.py</code></p>

<h3>Boost Factoren</h3>

<p>| Factor | Boost | Beschrijving |</p>
<p>|--------|-------|--------------|</p>
<p>| Juridische bron (rechtspraak.nl, overheid.nl) | <strong>1.2x</strong> | URL domain check |</p>
<p>| <code>source.is_juridical = True</code> | <strong>1.15x</strong> | Metadata flag |</p>
<p>| Juridisch keyword (per keyword) | <strong>1.1x</strong> | Max 1.3x (3 keywords) |</p>
<p>| Artikel-referentie (Art. X) | <strong>1.15x</strong> | Regex match |</p>
<p>| Lid-referentie | <strong>1.05x</strong> | Regex match |</p>
<p>| Context token match | <strong>1.1x</strong> | Per context match |</p>

<p><strong>Combinatie</strong>: Factoren worden vermenigvuldigd (max ~1.8x boost mogelijk)</p>

<h3>Juridische Keywords</h3>

<pre><code>JURIDISCHE_KEYWORDS = {
    # Algemeen: wetboek, artikel, recht, rechter, vonnis, ...
    # Strafrecht: verdachte, beklaagde, veroordeling, ...
    # Burgerlijk: overeenkomst, schadevergoeding, ...
    # Bestuursrecht: beschikking, bezwaar, beroep, ...
    # Procesrecht: procedure, hoger beroep, cassatie, ...
    # Wetten: sr, sv, rv, bw, awb
}</code></pre>

<h3>Artikel/Lid Detection</h3>

<p><strong>Artikel patterns</strong>:</p>
<ul>
<li>`Artikel 123`</li>
<li>`Art. 12a`</li>
<li>`artikel 5`</li>
</ul>

<p><strong>Lid patterns</strong>:</p>
<ul>
<li>`lid 2`</li>
<li>`tweede lid`</li>
<li>`eerste lid`</li>
</ul>

<h3>Usage</h3>

<pre><code>from .juridisch_ranker import boost_juridische_resultaten

# Boost results met juridische ranking
boosted = boost_juridische_resultaten(
    results,
    context=["Sv", "strafrecht"]  # Optionele context voor extra boost
)

# Results zijn nu gesorteerd op gebooste confidence</code></pre>

<h3>Context Matching</h3>

<p>Als context tokens worden meegegeven, krijgen results extra boost:</p>

<pre><code># Context: ["Sv", "strafrecht"]
# Definitie: "... het Wetboek van Strafvordering (Sv) bepaalt ..."
# → Extra 1.1x boost voor "Sv" match
# → Extra 1.1x boost voor "strafrecht" (impliciete match)
# → Totaal context boost: 1.21x</code></pre>

<p>---</p>

<h2>Component 6: ModernWebLookupService Integration</h2>

<p><strong>File</strong>: <code>/src/services/modern_web_lookup_service.py</code></p>

<h3>Ranking Pipeline</h3>

<pre><code>1. Concurrent lookups (Wikipedia, SRU, Wiktionary, etc.)
   ↓
2. rank_and_dedup() - Provider weight ranking
   ↓
3. context_filter.filter_results() - Context relevance
   ↓
4. boost_juridische_resultaten() - Juridische boost ← NIEUW
   ↓
5. Limiteer tot max_results
   ↓
6. Return final_results</code></pre>

<h3>Context Token Classification</h3>

<pre><code># Context: "OM | Sv | strafrecht"
org, jur, wet = self._classify_context_tokens(context)

# org = ["OM"]           → Organisatorisch
# jur = ["strafrecht"]   → Juridisch
# wet = ["Sv"]           → Wettelijk (gemapped naar "Wetboek van Strafvordering")

# Combined voor juridische ranking
context_tokens = jur + wet  # ["strafrecht", "Wetboek van Strafvordering", "Sv"]</code></pre>

<p>---</p>

<h2>Configuration</h2>

<p><strong>File</strong>: <code>/config/web_lookup_defaults.yaml</code></p>

<pre><code>web_lookup:
  # Juridische synoniemen (NIEUW)
  synonyms:
    enabled: true
    config_path: "config/juridische_synoniemen.yaml"
    max_synonyms_per_query: 3

    # Juridische ranking boost factoren
    juridical_boost:
      juridische_bron: 1.2
      keyword_per_match: 1.1
      artikel_referentie: 1.15
      lid_referentie: 1.05
      context_match: 1.1

  providers:
    wikipedia:
      enabled: true
      weight: 0.7

    sru_overheid:
      enabled: true
      weight: 1.0  # Hoogste voor juridische content</code></pre>

<h3>Environment Variables</h3>

<pre><code># Disable synoniemen (voor debugging)
DISABLE_WEB_LOOKUP_SYNONYMS=1

# Custom synoniemen config
SYNONYM_CONFIG_PATH=/custom/path/synoniemen.yaml</code></pre>

<p>---</p>

<h2>Testing</h2>

<h3>Unit Tests</h3>

<pre><code># Test synonym service
pytest tests/web_lookup/test_synonym_service.py

# Test juridische ranker
pytest tests/web_lookup/test_juridisch_ranker.py

# Test Wikipedia synonym fallback
pytest tests/web_lookup/test_wikipedia_synonyms.py

# Test SRU synonym expansion
pytest tests/web_lookup/test_sru_synonyms.py</code></pre>

<h3>Integration Tests</h3>

<pre><code># Test volledige lookup pipeline
pytest tests/web_lookup/test_synonym_integration.py</code></pre>

<h3>Manual Testing</h3>

<pre><code>import asyncio
from src.services.modern_web_lookup_service import ModernWebLookupService
from src.services.interfaces import LookupRequest

async def test_synonym_lookup():
    service = ModernWebLookupService()

    # Test juridische term met synoniemen
    request = LookupRequest(
        term="voorlopige hechtenis",
        context="Sv | strafrecht",
        max_results=5
    )

    results = await service.lookup(request)

    for r in results:
        print(f"Source: {r.source.name} (confidence: {r.source.confidence:.2f})")
        print(f"Definition: {r.definition[:100]}...")
        print("---")

asyncio.run(test_synonym_lookup())</code></pre>

<p>---</p>

<h2>Performance Impact</h2>

<h3>Expected Improvements</h3>

<p>| Metric | Before | After | Improvement |</p>
<p>|--------|--------|-------|-------------|</p>
<p>| <strong>Coverage</strong> | 80% | 90% | +10% |</p>
<p>| <strong>Juridische begrippen recall</strong> | 75% | 88% | +13% |</p>
<p>| <strong>Wikipedia fallback success</strong> | 15% | 35% | +20% |</p>
<p>| <strong>SRU synonym hits</strong> | N/A | 25% | NEW |</p>

<h3>Query Overhead</h3>

<ul>
<li>**Wikipedia**: +0-3 extra queries (alleen bij primaire search failure)</li>
<li>**SRU**: +1 query (Query 0, alleen voor termen met synoniemen)</li>
<li>**Latency**: +50-200ms (alleen bij fallback activation)</li>
</ul>

<h3>Circuit Breaker Protection</h3>

<ul>
<li>Max 4 consecutive empty results (configurable)</li>
<li>Voorkomt excessive querying bij termen zonder resultaten</li>
</ul>

<p>---</p>

<h2>Debugging</h2>

<h3>Logging</h3>

<p><strong>Enable debug logging</strong>:</p>

<pre><code>import logging
logging.getLogger("src.services.web_lookup").setLevel(logging.DEBUG)</code></pre>

<p><strong>Key log messages</strong>:</p>

<pre><code># Wikipedia synonym fallback
INFO: Primaire Wikipedia search gefaald, probeer synoniemen voor: [term]
DEBUG: Wikipedia synonym fallback: probeer '[synonym]'
INFO: Wikipedia match gevonden via synoniem: '[synonym]' voor '[term]'

# SRU synonym expansion
INFO: Query 0: Juridische synoniemen expansion voor '[term]'
DEBUG: Synoniemen query: (cql.serverChoice any "...") OR ...
INFO: Synoniemen query SUCCESS: N resultaten voor '[term]'

# Juridische ranking
INFO: Juridische ranking boost applied to N results
DEBUG: Boosted '[term]' from 0.85 to 0.95 (boost: 1.12x)</code></pre>

<h3>Synonym Service Stats</h3>

<pre><code>from src.services.web_lookup.synonym_service import get_synonym_service

service = get_synonym_service()
stats = service.get_stats()

print(stats)
# {
#   'hoofdtermen': 60,
#   'totaal_synoniemen': 220,
#   'unieke_synoniemen': 220,
#   'gemiddeld_per_term': 3.67
# }</code></pre>

<p>---</p>

<h2>Troubleshooting</h2>

<h3>Issue: Geen synoniemen gevonden</h3>

<p><strong>Check</strong>:</p>
<ol>
<li>`config/juridische_synoniemen.yaml` bestaat?</li>
<li>Term staat in YAML met underscores? (`voorlopige_hechtenis`)</li>
<li>YAML valid? Run `python -c "import yaml; yaml.safe_load(open('config/juridische_synoniemen.yaml'))"`</li>
</ol>

<h3>Issue: Synoniemen niet gebruikt</h3>

<p><strong>Check</strong>:</p>
<ol>
<li>`enable_synonyms=True` in WikipediaService/SRUService?</li>
<li>Logging enabled? Check `INFO: synoniemen fallback` messages</li>
<li>Circuit breaker triggered early? Check circuit breaker logs</li>
</ol>

<h3>Issue: Slechte ranking</h3>

<p><strong>Check</strong>:</p>
<ol>
<li>Juridische ranking enabled in ModernWebLookupService?</li>
<li>Context tokens correct geclassificeerd? (Check `_classify_context_tokens`)</li>
<li>Juridische keywords up-to-date in `juridisch_ranker.py`?</li>
</ol>

<p>---</p>

<h2>Future Improvements</h2>

<ol>
<li>**ML-based Synonym Expansion**</li>
</ol>
<ul>
<li>  - Train embeddings op juridische corpus</li>
<li>  - Dynamische synoniemen generatie</li>
</ul>

<ol>
<li>**User Feedback Loop**</li>
</ol>
<ul>
<li>  - Track welke synoniemen leiden tot goede matches</li>
<li>  - Auto-tune synonym rankings</li>
</ul>

<ol>
<li>**Domain-Specific Tuning**</li>
</ol>
<ul>
<li>  - Separate synoniemen sets voor strafrecht, bestuursrecht, civiel</li>
<li>  - Context-aware synonym selection</li>
</ul>

<ol>
<li>**Synonym Confidence Scoring**</li>
</ol>
<ul>
<li>  - Niet alle synoniemen zijn even relevant</li>
<li>  - Weighted synonym expansion</li>
</ul>

<p>---</p>

<h2>References</h2>

<ul>
<li>**Synoniemen database**: `/config/juridische_synoniemen.yaml`</li>
<li>**Service code**: `/src/services/web_lookup/synonym_service.py`</li>
<li>**Ranker code**: `/src/services/web_lookup/juridisch_ranker.py`</li>
<li>**Wikipedia integration**: `/src/services/web_lookup/wikipedia_service.py`</li>
<li>**SRU integration**: `/src/services/web_lookup/sru_service.py`</li>
<li>**Orchestrator**: `/src/services/modern_web_lookup_service.py`</li>
<li>**Config**: `/config/web_lookup_defaults.yaml`</li>
</ul>

<p>---</p>

<p><strong>Last Updated</strong>: Oct 2025</p>
<p><strong>Maintainer</strong>: DefinitieAgent Team</p>

  </div>
</body>
</html>