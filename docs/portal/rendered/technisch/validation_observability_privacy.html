<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Validation Observability & Privacy Guide</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">← Terug naar Portal</a>
    <h1>Validation Observability & Privacy Guide</h1>

<p><strong>Status</strong>: ACTIEF</p>
<p><strong>Versie</strong>: 1.0.0</p>
<p><strong>Laatst Bijgewerkt</strong>: 29-08-2025</p>
<p><strong>Compliance</strong>: AVG/GDPR Compliant</p>

<h2>Overzicht</h2>

<p>Deze guide beschrijft observability practices voor ValidationOrchestratorV2 met focus op privacy, monitoring, en compliance. Alle logging en metrics zijn ontworpen met privacy-by-design principes.</p>

<h2>Metric Naming Convention</h2>

<h3>Standaard Metrics</h3>
<pre><code>validation.request.count          # Aantal validation requests
validation.request.duration       # Request duration in ms
validation.request.error          # Error count per error type
validation.score.distribution     # Score distributie histogram
validation.cache.hit_ratio        # Cache hit percentage
validation.batch.size             # Batch grootte distributie</code></pre>

<h3>Naming Pattern</h3>
<pre><code>&lt;service&gt;.&lt;component&gt;.&lt;metric&gt;</code></pre>

<p>Voorbeeld:</p>
<pre><code>validation.orchestrator.latency_p95
validation.validator.timeout_count
validation.cache.memory_usage_mb</code></pre>

<h2>Logging Strategy</h2>

<h3>Log Levels & Content</h3>

<h4>DEBUG (Development Only)</h4>
<pre><code>logger.debug(
    "Validation started",
    extra={
        "correlation_id": "550e8400-e29b-41d4-a716-446655440000",
        "method": "validate_definition",
        "flags": {"feature_x": True}
    }
)
# NOOIT in productie, kan gevoelige data bevatten</code></pre>

<h4>INFO (Operational)</h4>
<pre><code>logger.info(
    "Validation completed",
    extra={
        "correlation_id": "550e8400-e29b-41d4-a716-446655440000",
        "duration_ms": 234,
        "score_bucket": "high",  # Niet exact score
        "cache_hit": True
    }
)</code></pre>

<h4>WARNING (Degraded Prestaties)</h4>
<pre><code>logger.warning(
    "Validation slow",
    extra={
        "correlation_id": "550e8400-e29b-41d4-a716-446655440000",
        "duration_ms": 5234,
        "threshold_ms": 2000
    }
)</code></pre>

<h4>ERROR (Failures)</h4>
<pre><code>logger.error(
    "Validation failed",
    extra={
        "correlation_id": "550e8400-e29b-41d4-a716-446655440000",
        "error_code": "VAL-SVC-001",
        "error_category": "service_unavailable"
        # GEEN user input of definitie content!
    }
)</code></pre>

<h2>Privacy & PII Protection</h2>

<h3>Data Classification</h3>
<p>| Data Type | Classification | Logging | Metrics | Retention |</p>
<p>|-----------|---------------|---------|---------|-----------|</p>
<p>| Definitie content | CONFIDENTIAL | ❌ Never | ❌ Never | - |</p>
<p>| User identifiers | PERSONAL | ❌ Never | ❌ Never | - |</p>
<p>| Correlation IDs | INTERNAL | ✅ Yes | ✅ Yes | 30 days |</p>
<p>| Scores (exact) | SENSITIVE | ❌ No | ✅ Aggregated | 90 days |</p>
<p>| Error messages | INTERNAL | ✅ Sanitized | ✅ Count only | 30 days |</p>
<p>| Prestaties data | OPERATIONAL | ✅ Yes | ✅ Yes | 90 days |</p>

<h3>PII Masking Rules</h3>

<pre><code>def sanitize_for_logging(data: dict) -&gt; dict:
    """Remove/mask PII before logging."""
    SENSITIVE_KEYS = {
        'definition', 'content', 'text',
        'user_id', 'email', 'name'
    }

    sanitized = {}
    for key, value in data.items():
        if key.lower() in SENSITIVE_KEYS:
            sanitized[key] = "[REDACTED]"
        elif isinstance(value, str) and len(value) &gt; 100:
            sanitized[key] = f"[STRING_{len(value)}_CHARS]"
        else:
            sanitized[key] = value

    return sanitized</code></pre>

<h3>Aggregation Before Storage</h3>
<pre><code># WRONG - Logs exact score
logger.info(f"Score: {score}")

# CORRECT - Logs score bucket
score_bucket = "high" if score &gt; 0.8 else "medium" if score &gt; 0.5 else "low"
logger.info(f"Score bucket: {score_bucket}")</code></pre>

<h2>Retention Policies</h2>

<h3>Per Environment</h3>

<p>| Environment | Logs | Metrics | Traces | Backup |</p>
<p>|-------------|------|---------|--------|---------|</p>
<p>| Development | 7 days | 7 days | 3 days | None |</p>
<p>| Test | 14 days | 30 days | 7 days | None |</p>
<p>| Staging | 30 days | 90 days | 14 days | 7 days |</p>
<p>| Production | 30 days | 90 days | 30 days | 90 days |</p>

<h3>Automated Cleanup</h3>
<pre><code># cronjob for log rotation
0 2 * * * /usr/bin/find /var/log/validation -name "*.log" -mtime +30 -delete
0 3 * * * /usr/bin/find /var/metrics/validation -name "*.db" -mtime +90 -delete</code></pre>

<h2>Distributed Tracing</h2>

<h3>Correlation ID Flow</h3>
<pre><code>class ValidationContext:
    def __init__(self, correlation_id: str = None):
        self.correlation_id = correlation_id or str(uuid.uuid4())
        self.start_time = time.time()
        self.spans = []

    def create_span(self, operation: str):
        return Span(
            correlation_id=self.correlation_id,
            operation=operation,
            start_time=time.time()
        )</code></pre>

<h3>Trace Headers</h3>
<pre><code>TRACE_HEADERS = {
    "X-Correlation-ID": "uuid",
    "X-Request-ID": "uuid",
    "X-Trace-Parent": "trace-id",
    "X-Trace-State": "vendor-specific"
}</code></pre>

<h2>Dashboard Definitions</h2>

<h3>Validation Prestaties Dashboard</h3>
<pre><code>panels:
  - title: "Request Rate"
    query: "rate(validation.request.count[5m])"

  - title: "Latency P95"
    query: "histogram_quantile(0.95, validation.request.duration)"

  - title: "Error Rate"
    query: "rate(validation.request.error[5m]) / rate(validation.request.count[5m])"

  - title: "Score Distribution"
    query: "validation.score.distribution"
    type: "heatmap"</code></pre>

<h3>Alert Definitions</h3>
<pre><code>alerts:
  - name: "HighErrorRate"
    expr: "rate(validation.request.error[5m]) &gt; 0.05"
    severity: "warning"

  - name: "SlowValidation"
    expr: "validation.request.duration &gt; 2000"
    severity: "warning"

  - name: "ServiceDown"
    expr: "up{job='validation'} == 0"
    severity: "critical"</code></pre>

<h2>Monitoring Implementatie</h2>

<h3>Metrics Collection</h3>
<pre><code>from prometheus_client import Counter, Histogram, Gauge

# Define metrics
validation_counter = Counter(
    'validation_request_total',
    'Total validation requests',
    ['method', 'status']
)

validation_duration = Histogram(
    'validation_duration_seconds',
    'Validation duration',
    ['method'],
    buckets=[0.1, 0.5, 1.0, 2.0, 5.0]
)

cache_hit_ratio = Gauge(
    'validation_cache_hit_ratio',
    'Cache hit ratio'
)

# Use in code
@validation_duration.time()
async def validate_definition(self, definition: str):
    validation_counter.labels(method='definition', status='started').inc()
    # ... validation logic ...</code></pre>

<h3>Health Checks</h3>
<pre><code>async def health_check():
    """Health check endpoint voor monitoring."""
    checks = {
        "status": "healthy",
        "timestamp": datetime.now().isoformat(),
        "checks": {
            "database": await check_database(),
            "cache": await check_cache(),
            "validator": await check_validator_service()
        }
    }

    # Determine overall health
    if all(check["status"] == "healthy" for check in checks["checks"].values()):
        return JSONResponse(checks, status_code=200)
    else:
        checks["status"] = "degraded"
        return JSONResponse(checks, status_code=503)</code></pre>

<h2>Beveiliging Considerations</h2>

<h3>Log Injection Prevention</h3>
<pre><code>def safe_log_value(value: str) -&gt; str:
    """Prevent log injection attacks."""
    # Remove newlines and control characters
    safe = value.replace('\n', '\\n').replace('\r', '\\r')
    # Limit length
    if len(safe) &gt; 200:
        safe = safe[:200] + '...'
    return safe</code></pre>

<h3>Metric Cardinality Control</h3>
<pre><code># WRONG - Unbounded cardinality
metrics.labels(user_id=user_id, definition_id=def_id)

# CORRECT - Bounded cardinality
metrics.labels(
    user_type="internal" if is_internal else "external",
    score_bucket=get_score_bucket(score)
)</code></pre>

<h2>Compliance Checklist</h2>

<h3>AVG/GDPR Compliance</h3>
<ul>
<li>[ ] Geen PII in logs of metrics</li>
<li>[ ] Data minimalisatie toegepast</li>
<li>[ ] Retention policies gedocumenteerd</li>
<li>[ ] Right to erasure implementatie mogelijk</li>
<li>[ ] Privacy impact assessment uitgevoerd</li>
</ul>

<h3>Beveiliging Compliance</h3>
<ul>
<li>[ ] Logs encrypted at rest</li>
<li>[ ] Metrics encrypted in transit</li>
<li>[ ] Access control op dashboards</li>
<li>[ ] Audit logging voor dashboard access</li>
<li>[ ] Regular security reviews</li>
</ul>

<h2>Operational Procedures</h2>

<h3>Incident Response</h3>
<ol>
<li>Check correlation ID in error logs</li>
<li>Trace request flow via distributed tracing</li>
<li>Check metrics for anomalies</li>
<li>Review health check status</li>
<li>Check upstream/downstream services</li>
</ol>

<h3>Prestaties Troubleshooting</h3>
<ol>
<li>Check P95 latency trends</li>
<li>Review cache hit ratios</li>
<li>Check batch size distributions</li>
<li>Review error rates per endpoint</li>
<li>Check resource utilization</li>
</ol>

<h2>Tools & Endpoints</h2>

<h3>Monitoring Endpoints</h3>
<pre><code>GET /health          # Health check
GET /metrics         # Prometheus metrics
GET /ready          # Readiness probe
GET /live           # Liveness probe</code></pre>

<h3>Debugging Endpoints (Dev Only)</h3>
<pre><code>GET /debug/config    # Current configuration
GET /debug/flags     # Feature flag status
POST /debug/trace    # Enable trace logging</code></pre>

<p>---</p>

<p><em>Voor vragen over observability of privacy, contact het Beveiliging Team of Platform Team.</em></p>

  </div>
</body>
</html>