<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Technical Analysis: Agent Workflow Architecture</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">← Terug naar Portal</a>
    <p>---</p>
<p>canonical: true</p>
<p>status: active</p>
<p>owner: architecture</p>
<p>last_verified: 2025-09-08</p>
<p>applies_to: claude-agents@v2</p>
<p>---</p>

<h1>Technical Analysis: Agent Workflow Architecture</h1>

<h2>Executive Summary</h2>

<p>This document provides a comprehensive technical analysis of the Claude agent workflow system, its architecture patterns, test structures, and integration points with the DefinitieAgent application.</p>

<h2>1. Agent Architecture Overview</h2>

<h3>1.1 System Structure</h3>

<pre><code>~/.claude/agents/
├── README.md                    # Configuration overview
├── workflows/                   # Workflow definitions
│   ├── workflows.yaml          # Central workflow configuration
│   ├── prompt-refinement-loop.yaml
│   └── prompt-refinement-example.md
└── [agent-name].md             # 11 specialized agent prompts</code></pre>

<h3>1.2 Agent Categories</h3>

<h4>Orchestrators (1)</h4>
<ul>
<li>**workflow-router**: Intelligent workflow selection based on task characteristics</li>
</ul>

<h4>Core Development Team (4)</h4>
<ul>
<li>**business-analyst-justice**: Requirements analysis and user story creation</li>
<li>**justice-architecture-designer**: EA/SA/TA documentation generation</li>
<li>**developer-implementer**: Code implementation and development</li>
<li>**quality-assurance-tester**: Testing and quality assurance</li>
</ul>

<h4>Quality & Optimization (3)</h4>
<ul>
<li>**code-reviewer-comprehensive**: Code review and analysis</li>
<li>**refactor-specialist**: Code improvement and optimization</li>
<li>**doc-standards-guardian**: Documentation compliance verification</li>
</ul>

<h4>Support (3)</h4>
<ul>
<li>**prompt-engineer**: Prompt optimization and refinement</li>
<li>**devops-pipeline-orchestrator**: CI/CD and deployment management</li>
</ul>

<h2>2. Workflow Patterns</h2>

<h3>2.1 Workflow Types and Characteristics</h3>

<p>| Workflow | Duration | Complexity | Primary Use Case | Phases |</p>
<p>|----------|----------|------------|------------------|---------|</p>
<p>| ANALYSIS | 20-30m | Low | Research without changes | INVESTIGATE → DOCUMENT |</p>
<p>| REVIEW_CYCLE | 30-60m | Medium | Code review only | REVIEW → SUGGEST |</p>
<p>| DOCUMENTATION | 15-30m | Low | Documentation updates | UPDATE → VERIFY |</p>
<p>| DEBUG | 30-90m | Medium | Bug investigation and fixes | REPRODUCE → DIAGNOSE → FIX → VERIFY |</p>
<p>| MAINTENANCE | 15-45m | Low | Config and dependency updates | ASSESS → UPDATE → VALIDATE |</p>
<p>| HOTFIX | 30-60m | High | Critical production fixes | TRIAGE → FIX → REVIEW → DEPLOY |</p>
<p>| REFACTOR_ONLY | 20-60m | Medium | Code improvements | PLAN → APPLY → VERIFY |</p>
<p>| SPIKE | 1-4h | High | Technical research | RESEARCH → PROTOTYPE → DOCUMENT |</p>
<p>| FULL_TDD | 2-4h | High | Complete feature development | 8-phase TDD cycle |</p>

<h3>2.2 Workflow Selection Algorithm</h3>

<pre><code>routing:
  rules:
    # Intent-based routing
    - intent: ["review", "check", "validate"]
      workflow: review_cycle

    # File-based routing
    - files: ["*.md", "*.txt"]
      only: true
      workflow: documentation

    # Risk-based routing
    - risk: "critical"
      urgency: "high"
      workflow: hotfix

    # Default fallback
    - default: true
      workflow: full_tdd</code></pre>

<h3>2.3 Gate System</h3>

<p>Each workflow phase has gates that must be satisfied:</p>
<ul>
<li>**Mandatory gates**: Must be completed before phase transition</li>
<li>**Optional gates**: Can be skipped with justification</li>
<li>**Light gates**: Simplified validation for quick workflows</li>
</ul>

<p>Example from DEBUG workflow:</p>
<pre><code>phases:
  - name: "REPRODUCE"
    gates:
      - issue_reproduced
      - steps_documented
  - name: "DIAGNOSE"
    gates:
      - root_cause_found
      - analysis_complete</code></pre>

<h2>3. Agent Prompt Patterns</h2>

<h3>3.1 Standard Agent Structure</h3>

<pre><code>---
name: [agent-name]
description: [comprehensive description with examples]
model: inherit
color: [visual identifier]
---

[Agent role definition and expertise]

## Core Responsibilities
[Numbered list of primary duties]

## Working Methodology
[Step-by-step approach]

## Output Format
[Expected deliverables]

## Quality Standards
[Verification criteria]</code></pre>

<h3>3.2 Key Agent Patterns</h3>

<h4>Pattern 1: Role-Based Expertise</h4>
<p>Each agent has a clearly defined role with specific domain expertise:</p>
<ul>
<li>Justice sector knowledge for `justice-architecture-designer`</li>
<li>Testing expertise for `quality-assurance-tester`</li>
<li>Optimization skills for `refactor-specialist`</li>
</ul>

<h4>Pattern 2: Input/Output Contracts</h4>
<p>Agents define explicit contracts for inter-agent communication:</p>
<ul>
<li>Input requirements (format, validation)</li>
<li>Output specifications (structure, metadata)</li>
<li>Handoff protocols between agents</li>
</ul>

<h4>Pattern 3: Hallucination Prevention</h4>
<p>Built-in constraints to prevent fabrication:</p>
<ul>
<li>"ALLEEN op basis van" patterns in Dutch agents</li>
<li>Source verification requirements</li>
<li>Explicit boundary definitions</li>
</ul>

<h2>4. Test Integration Patterns</h2>

<h3>4.1 Current Test Coverage</h3>

<p>The codebase shows limited direct testing of agent workflows:</p>
<ul>
<li>No dedicated workflow test files found</li>
<li>Agent patterns referenced only in `test_story_31_sources_metadata.py`</li>
<li>Workflow service tests focus on status transitions, not agent orchestration</li>
</ul>

<h3>4.2 Recommended Test Patterns</h3>

<h4>Unit Tests for Workflow Selection</h4>
<pre><code>class TestWorkflowRouter:
    def test_intent_based_routing(self):
        """Test that intents map to correct workflows."""
        router = WorkflowRouter()
        assert router.select("review this code") == "review_cycle"
        assert router.select("fix bug #123") == "debug"
        assert router.select("urgent production issue") == "hotfix"

    def test_file_based_routing(self):
        """Test file pattern matching."""
        router = WorkflowRouter()
        assert router.select("update README.md") == "documentation"
        assert router.select("modify config.yaml") == "maintenance"</code></pre>

<h4>Integration Tests for Agent Handoffs</h4>
<pre><code>class TestAgentHandoffs:
    @pytest.mark.asyncio
    async def test_analyst_to_architect_handoff(self):
        """Test seamless handoff from business analyst to architect."""
        # Create user story with business analyst
        story_output = await invoke_agent("business-analyst-justice", task)

        # Transform via prompt engineer
        transformed = await invoke_agent("prompt-engineer", {
            "source": story_output,
            "target": "justice-architecture-designer"
        })

        # Pass to architect
        architecture = await invoke_agent("justice-architecture-designer", transformed)

        # Verify contract compliance
        assert validate_handoff_contract(story_output, architecture)</code></pre>

<h4>Workflow Gate Tests</h4>
<pre><code>class TestWorkflowGates:
    def test_debug_workflow_gates(self):
        """Test that all gates in DEBUG workflow are validated."""
        workflow = WorkflowDefinition("debug")

        # Test REPRODUCE phase gates
        phase = workflow.phases["REPRODUCE"]
        assert phase.validate_gate("issue_reproduced", evidence)
        assert phase.validate_gate("steps_documented", docs)

        # Test phase transition
        assert workflow.can_transition("REPRODUCE", "DIAGNOSE")</code></pre>

<h2>5. Integration with DefinitieAgent</h2>

<h3>5.1 Service Architecture Alignment</h3>

<p>The agent workflow system could integrate with existing services:</p>

<pre><code># In service_factory.py
class WorkflowOrchestrator:
    def __init__(self, container: ServiceContainer):
        self.container = container
        self.router = WorkflowRouter()
        self.agents = AgentRegistry()

    async def execute_task(self, task: str, context: dict):
        # Route to appropriate workflow
        workflow = self.router.select(task)

        # Execute workflow phases
        for phase in workflow.phases:
            agents = phase.get_agents()
            results = await self.run_agents(agents, context)

            # Validate gates
            if not phase.validate_gates(results):
                raise WorkflowGateError(phase)

            context.update(results)

        return context</code></pre>

<h3>5.2 Potential Integration Points</h3>

<ol>
<li>**Validation Orchestrator**: Could use REVIEW_CYCLE workflow</li>
<li>**Web Lookup Service**: Could use SPIKE workflow for research</li>
<li>**Definition Generator**: Could use FULL_TDD workflow</li>
<li>**Documentation**: Could use DOCUMENTATION workflow</li>
</ol>

<h2>6. Performance Considerations</h2>

<h3>6.1 Workflow Metrics</h3>

<p>Target performance metrics from workflows.yaml:</p>
<pre><code>metrics:
  efficiency:
    simple_tasks: "&lt; 30 minutes"
    workflow_match_rate: "&gt; 90%"
    override_frequency: "&lt; 10%"
  quality:
    test_coverage: "&gt; 80%"
    regression_rate: "&lt; 2%"</code></pre>

<h3>6.2 Optimization Opportunities</h3>

<ol>
<li>**Parallel Agent Execution**: Some phases allow parallel execution</li>
<li>**Light Gates**: Simplified validation for low-risk tasks</li>
<li>**Workflow Caching**: Reuse workflow results for similar tasks</li>
<li>**Smart Routing**: Learn from override patterns to improve selection</li>
</ol>

<h2>7. Critical Observations</h2>

<h3>7.1 Strengths</h3>

<ol>
<li>**Right-sized Processes**: Different workflows for different task complexities</li>
<li>**Clear Agent Responsibilities**: Well-defined roles and boundaries</li>
<li>**Gate-based Quality Control**: Explicit validation at each phase</li>
<li>**Flexible Routing**: Multiple criteria for workflow selection</li>
</ol>

<h3>7.2 Gaps and Opportunities</h3>

<ol>
<li>**Test Coverage**: No dedicated tests for workflow execution</li>
<li>**Integration**: Not integrated with existing service architecture</li>
<li>**Monitoring**: No metrics collection for workflow performance</li>
<li>**Documentation**: Limited examples of actual workflow execution</li>
</ol>

<h3>7.3 Implementation Recommendations</h3>

<ol>
<li>**Create Workflow Test Suite**:</li>
</ol>
<ul>
<li>  - Unit tests for routing logic</li>
<li>  - Integration tests for agent handoffs</li>
<li>  - End-to-end tests for complete workflows</li>
</ul>

<ol>
<li>**Build Integration Layer**:</li>
</ol>
<ul>
<li>  - WorkflowOrchestrator service</li>
<li>  - Agent adapters for existing services</li>
<li>  - Metrics collection and reporting</li>
</ul>

<ol>
<li>**Enhance Documentation**:</li>
</ol>
<ul>
<li>  - Workflow execution examples</li>
<li>  - Agent handoff patterns</li>
<li>  - Integration guides</li>
</ul>

<h2>8. Workflow-Router Protocol</h2>

<h3>8.1 Two-Stage Optimization Process</h3>

<p>The workflow-router uses a mandatory two-stage process:</p>

<ol>
<li>**Stage 1: Prompt Engineering**</li>
</ol>
<ul>
<li>  - All prompts MUST first go through prompt-engineer</li>
<li>  - Optimizes for clarity, specificity, and actionability</li>
<li>  - User gets Accept/Modify/Cancel options</li>
</ul>

<ol>
<li>**Stage 2: Workflow Routing**</li>
</ol>
<ul>
<li>  - Only processes prompts marked with `OPTIMIZED_PROMPT_MARKER`</li>
<li>  - Selects optimal workflow based on optimized prompt</li>
<li>  - Initiates workflow execution</li>
</ul>

<h3>8.2 Critical Routing Constraint</h3>

<p>The workflow-router is explicitly a ROUTING-ONLY system:</p>
<ul>
<li>MUST NOT execute or implement tasks</li>
<li>MUST NOT analyze content directly</li>
<li>MUST ONLY select and pass to appropriate workflow</li>
<li>Job ends at workflow selection</li>
</ul>

<h2>9. Agent Usage Analysis</h2>

<h3>9.1 Active Agent Usage in Workflows</h3>

<p>| Agent | Usage Count | Workflows |</p>
<p>|-------|-------------|-----------|</p>
<p>| <code>developer-implementer</code> | 10x | debug, maintenance, hotfix, refactor_only, spike, full_tdd |</p>
<p>| <code>quality-assurance-tester</code> | 7x | documentation, debug, maintenance, refactor_only, full_tdd |</p>
<p>| <code>refactor-specialist</code> | 4x | review_cycle, maintenance, refactor_only, full_tdd |</p>
<p>| <code>code-reviewer-comprehensive</code> | 4x | analysis, review_cycle, hotfix, full_tdd |</p>
<p>| <code>doc-standards-guardian</code> | 3x | analysis, documentation, spike |</p>
<p>| <code>business-analyst-justice</code> | 3x | analysis, hotfix, full_tdd |</p>
<p>| <code>justice-architecture-designer</code> | 2x | spike, full_tdd |</p>
<p>| <code>devops-pipeline-orchestrator</code> | 2x | hotfix, full_tdd |</p>

<h3>9.2 Unused Agents</h3>

<p>Two agents exist but are not used in workflow definitions:</p>
<ol>
<li>**prompt-engineer**: Critical for prompt optimization protocol</li>
<li>**workflow-router**: Meta-orchestrator for workflow selection</li>
</ol>

<p>These are special-purpose agents used outside the standard workflow patterns.</p>

<h2>10. Conclusion</h2>

<p>The agent workflow architecture represents a sophisticated approach to task automation with:</p>
<ul>
<li>Clear separation of concerns through specialized agents</li>
<li>Flexible workflow selection based on task characteristics</li>
<li>Quality gates ensuring consistent outcomes</li>
<li>Optimization for both speed and quality</li>
</ul>

<p>The system is well-designed but would benefit from:</p>
<ul>
<li>Comprehensive test coverage</li>
<li>Deep integration with existing services</li>
<li>Performance monitoring and optimization</li>
<li>Extended documentation with real-world examples</li>
</ul>

<h2>Appendix A: Agent Registry</h2>

<p>| Agent | Primary Function | Key Patterns |</p>
<p>|-------|-----------------|--------------|</p>
<p>| workflow-router | Task routing | Intent/file/risk-based selection |</p>
<p>| prompt-engineer | Prompt optimization | Normalization, hallucination prevention |</p>
<p>| business-analyst-justice | Requirements | User stories, BDD scenarios |</p>
<p>| justice-architecture-designer | Architecture | EA/SA/TA documentation |</p>
<p>| developer-implementer | Implementation | Code generation, type hints |</p>
<p>| quality-assurance-tester | Testing | Coverage, regression prevention |</p>
<p>| code-reviewer-comprehensive | Review | Static analysis, best practices |</p>
<p>| refactor-specialist | Optimization | Code cleanup, performance |</p>
<p>| doc-standards-guardian | Documentation | Compliance, consistency |</p>
<p>| devops-pipeline-orchestrator | Deployment | CI/CD, rollback plans |</p>

<h2>Appendix B: Workflow Phase Patterns</h2>

<p>Common phase patterns across workflows:</p>
<ol>
<li>**Investigation Phase**: INVESTIGATE, RESEARCH, REPRODUCE</li>
<li>**Planning Phase**: PLAN, DESIGN, TRIAGE</li>
<li>**Implementation Phase**: FIX, APPLY, UPDATE, DEV-GREEN</li>
<li>**Validation Phase**: VERIFY, TEST-CONFIRM, VALIDATE</li>
<li>**Documentation Phase**: DOCUMENT, REPORT</li>
</ol>

<h2>Appendix C: Test Strategy Recommendations</h2>

<h3>Unit Test Coverage</h3>
<ul>
<li>Workflow selection logic (90% coverage)</li>
<li>Gate validation rules (100% coverage)</li>
<li>Agent input/output contracts (85% coverage)</li>
</ul>

<h3>Integration Test Coverage</h3>
<ul>
<li>Agent handoffs (80% coverage)</li>
<li>Workflow phase transitions (90% coverage)</li>
<li>Error recovery mechanisms (75% coverage)</li>
</ul>

<h3>End-to-End Test Coverage</h3>
<ul>
<li>Complete workflow execution (70% coverage)</li>
<li>Multi-agent collaboration (60% coverage)</li>
<li>Performance benchmarks (baseline established)</li>
</ul>

<p>---</p>
<p><em>Generated by: SPIKE Workflow</em></p>
<p><em>Version: 2.0</em></p>
<p><em>Last Updated: 2025-09-08</em></p>

  </div>
</body>
</html>