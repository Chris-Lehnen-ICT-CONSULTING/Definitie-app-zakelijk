<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Database Backup & Recovery Guide</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">‚Üê Terug naar Portal</a>
    <h1>Database Backup & Recovery Guide</h1>

<h2>üî¥ Probleem: Data Loss bij Branch Switches</h2>

<p><strong>Wat gebeurde:</strong></p>
<ul>
<li>Database (`data/definities.db`) stond in `.gitignore` maar werd **toch getracked** door git</li>
<li>Bij branch switches overschreef git de lokale database met oudere versies</li>
<li>Resulteerde in verlies van 14-16 definities (IDs 74-75, 80-91)</li>
</ul>

<p><strong>Root cause:</strong></p>
<ul>
<li>Database was ooit toegevoegd aan git (`git add data/definities.db`)</li>
<li>`.gitignore` voorkomt alleen nieuwe files, geen reeds getracked files</li>
<li>`git rm --cached` was nodig om tracking te stoppen</li>
</ul>

<h2>‚úÖ Oplossingen Ge√Ømplementeerd</h2>

<h3>1. Stop Git Tracking (2025-10-30)</h3>

<p><strong>Commit:</strong> <code>5c761e94</code> - "fix: stop tracking data/definities.db"</p>

<pre><code># Database is nu NIET meer getracked
git rm --cached data/definities.db

# Blijft wel in .gitignore (regels 131, 133)</code></pre>

<p><strong>Effect:</strong></p>
<ul>
<li>‚úÖ Geen automatische overwrites meer bij branch switches</li>
<li>‚úÖ Database veranderingen blijven lokaal</li>
<li>‚úÖ Elke developer heeft eigen database</li>
</ul>

<h3>2. Data Recovery via TXT Exports</h3>

<p><strong>Script:</strong> <code>scripts/import_from_txt_exports.py</code></p>

<p><strong>Hersteld:</strong> 11 van 14 definities</p>
<ul>
<li>IDs 80-88 (9 definities) uit `exports/definities_export_20251029_130927.txt`</li>
<li>IDs 90-91 (2 definities) uit `exports/definities_export_20251030_*.txt`</li>
<li>**Verloren:** IDs 74-75, 89 (permanent verloren)</li>
</ul>

<p><strong>Gebruik:</strong></p>
<pre><code># Import automatisch
python3 scripts/import_from_txt_exports.py

# Script zoekt automatisch naar:
# - definities_export_20251029_130927.txt (IDs 80-88)
# - definities_export_20251030_100359.txt (ID 90)
# - definities_export_20251030_101334.txt (ID 91)</code></pre>

<h3>3. Auto-Backup Systeem</h3>

<p><strong>Scripts:</strong></p>
<ul>
<li>`scripts/auto_backup_database.sh` - Backup script</li>
<li>`scripts/setup_auto_backup.sh` - Installatie via launchd</li>
</ul>

<p><strong>Features:</strong></p>
<ul>
<li>‚úÖ Elk uur automatische backup</li>
<li>‚úÖ Integrity check voor + na backup</li>
<li>‚úÖ Behoudt laatste 24 backups (1 dag history)</li>
<li>‚úÖ Symlink naar `latest.db` voor quick recovery</li>
<li>‚úÖ Automatische cleanup oude backups</li>
</ul>

<p><strong>Installatie:</strong></p>
<pre><code># Setup auto-backups (eenmalig)
bash scripts/setup_auto_backup.sh

# Status checken
launchctl list | grep backup

# Logs bekijken
tail -f logs/backup.log</code></pre>

<p><strong>Manual backup:</strong></p>
<pre><code># Maak nu een backup
bash scripts/auto_backup_database.sh</code></pre>

<p><strong>Backup locaties:</strong></p>
<pre><code>data/backups/auto/          # Hourly auto-backups (laatste 24)
data/backups/DEF-54/        # Feature-specifieke backups
data/backups/               # Overige backups</code></pre>

<h2>üö® Data Recovery Procedures</h2>

<h3>Scenario 1: Recent Data Loss (< 1 uur)</h3>

<pre><code># Laatste auto-backup herstellen
cp data/backups/auto/latest.db data/definities.db

# Verify
sqlite3 data/definities.db "PRAGMA integrity_check;"
sqlite3 data/definities.db "SELECT COUNT(*) FROM definities;"</code></pre>

<h3>Scenario 2: Data Loss met TXT Exports</h3>

<pre><code># Zoek relevante exports
ls -lht exports/*.txt | head -20

# Import via script
python3 scripts/import_from_txt_exports.py

# Script vraagt om confirmatie en toont preview</code></pre>

<h3>Scenario 3: Specifieke Feature Backup</h3>

<pre><code># Lijst backups
ls -lht data/backups/*/

# Restore specifieke backup
cp data/backups/DEF-54/definities_pre_refactor.db data/definities.db

# Verify
sqlite3 data/definities.db "PRAGMA integrity_check;"</code></pre>

<h3>Scenario 4: Time Machine (macOS)</h3>

<pre><code># 1. Open Time Machine
# 2. Navigate naar: /Users/chrislehnen/Projecten/Definitie-app/data/
# 3. Zoek definities.db op gewenste tijdstip
# 4. Restore</code></pre>

<h2>üìã Preventieve Maatregelen Checklist</h2>

<h3>Voor Developers</h3>

<ul>
<li>[ ] **Nooit** `git add data/definities.db` runnen</li>
<li>[ ] Bij nieuwe feature: maak backup in `data/backups/FEATURE-NAME/`</li>
<li>[ ] Voor major refactors: manual backup + BACKUP_INFO.txt</li>
<li>[ ] Gebruik UI export functie regelmatig (TXT/Excel)</li>
</ul>

<h3>Voor Feature Work</h3>

<pre><code># V√ì√ìR feature branch werk:
mkdir -p data/backups/EPIC-XXX
cp data/definities.db data/backups/EPIC-XXX/definities_pre_EPIC.db

# Metadata toevoegen
cat &gt; data/backups/EPIC-XXX/BACKUP_INFO.txt &lt;&lt;EOF
Feature: EPIC-XXX
Date: $(date +"%Y-%m-%d %H:%M:%S")
Definities: $(sqlite3 data/definities.db "SELECT COUNT(*) FROM definities;")
Purpose: Pre-feature backup
EOF</code></pre>

<h3>Database Hygiene</h3>

<pre><code># Weekly check
sqlite3 data/definities.db "PRAGMA integrity_check;"

# Vacuum (compacteren)
sqlite3 data/definities.db "VACUUM;"

# Analyze (query optimization)
sqlite3 data/definities.db "ANALYZE;"</code></pre>

<h2>üîç Troubleshooting</h2>

<h3>Auto-backup draait niet</h3>

<pre><code># Check launchd status
launchctl list | grep backup

# Reload service
launchctl unload ~/Library/LaunchAgents/com.definitieagent.backup.plist
launchctl load ~/Library/LaunchAgents/com.definitieagent.backup.plist

# Check logs
tail -n 50 logs/backup.log
tail -n 50 logs/backup.error.log</code></pre>

<h3>Backup corrupt</h3>

<pre><code># Verify backup
sqlite3 data/backups/auto/definities_backup_YYYYMMDD_HHMMSS.db "PRAGMA integrity_check;"

# Try older backup
ls -lt data/backups/auto/ | head -10</code></pre>

<h3>Import script fails</h3>

<pre><code># Check export file format
head -50 exports/definities_export_YYYYMMDD_HHMMSS.txt

# Verify IDs in export
grep "^ID: " exports/definities_export_YYYYMMDD_HHMMSS.txt | sort -u

# Run with debug
python3 -v scripts/import_from_txt_exports.py</code></pre>

<h2>üìä Monitoring & Metrics</h2>

<h3>Backup Status Dashboard</h3>

<pre><code># Aantal backups
echo "Auto backups: $(ls -1 data/backups/auto/*.db 2&gt;/dev/null | wc -l)"

# Laatste backup tijd
ls -lt data/backups/auto/ | head -2

# Disk usage
du -sh data/backups/

# Database size trend
ls -lh data/definities.db data/backups/auto/definities_backup_*.db | tail -5</code></pre>

<h3>Alerts</h3>

<p><strong>Setup email alerts (optioneel):</strong></p>

<pre><code># Toevoegen aan auto_backup_database.sh
# Als backup faalt, stuur email
if ! sqlite3 "$BACKUP_PATH" "PRAGMA integrity_check;" | grep -q "ok"; then
    echo "Backup failed!" | mail -s "DefinitieAgent Backup FAILED" your@email.com
fi</code></pre>

<h2>üéØ Best Practices</h2>

<ol>
<li>**Gebruik UI export functie**</li>
</ol>
<ul>
<li>  - Wekelijks volledige export (TXT + Excel)</li>
<li>  - Voor belangrijke definities: individuele exports</li>
</ul>

<ol>
<li>**Feature branches**</li>
</ol>
<ul>
<li>  - Altijd backup maken voor major changes</li>
<li>  - Include BACKUP_INFO.txt met metadata</li>
</ul>

<ol>
<li>**Git hygiene**</li>
</ol>
<ul>
<li>  - NOOIT database committen</li>
<li>  - Check `git status` voor `data/definities.db`</li>
</ul>

<ol>
<li>**Recovery testing**</li>
</ol>
<ul>
<li>  - Test recovery procedure 1x per maand</li>
<li>  - Verify backups zijn valid</li>
</ul>

<ol>
<li>**Documentation**</li>
</ol>
<ul>
<li>  - Update deze guide bij nieuwe procedures</li>
<li>  - Document custom backup strategies per EPIC</li>
</ul>

<h2>üìö Related Documents</h2>

<ul>
<li>`docs/analyses/BUG_HUNT_ANALYSIS_2025-10-30.md` - Root cause analysis</li>
<li>`scripts/import_from_txt_exports.py` - Import script source</li>
<li>`scripts/auto_backup_database.sh` - Backup script source</li>
<li>`CLAUDE.md` - Project guidelines (database section)</li>
</ul>

<h2>üîó Links</h2>

<ul>
<li>[SQLite PRAGMA commands](https://www.sqlite.org/pragma.html)</li>
<li>[macOS launchd](https://www.launchd.info/)</li>
<li>[Git ignore patterns](https://git-scm.com/docs/gitignore)</li>
</ul>

<p>---</p>

<p><strong>Last updated:</strong> 2025-10-30</p>
<p><strong>Maintainer:</strong> DevOps / Data Recovery Team</p>

  </div>
</body>
</html>