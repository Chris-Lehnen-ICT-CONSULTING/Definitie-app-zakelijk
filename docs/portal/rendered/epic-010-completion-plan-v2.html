<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EPIC-010 Direct Refactor Plan v2 - Sprint 37</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">‚Üê Terug naar Portal</a>
    <p>---</p>
<p>titel: EPIC-010 Direct Refactor Plan v2 - Sprint 37</p>
<p>aangemaakt: 2025-09-10</p>
<p>status: Planning - REVIEWED</p>
<p>prioriteit: KRITIEK</p>
<p>approach: DIRECT REFACTOR - GEEN BACKWARDS COMPATIBILITY</p>
<p>---</p>

<h1>üöÄ EPIC-010 Direct Refactor Plan v2 - Sprint 37</h1>

<h2>Executive Summary</h2>

<p>Dit document bevat het <strong>aangepaste</strong> 5-daagse direct refactor plan op basis van review feedback. Belangrijkste wijzigingen:</p>
<ul>
<li>UI migratie + wrapper removal op **dezelfde dag** om breaking UI te voorkomen</li>
<li>Gebruik bestaande `rate_limit_config.py` voor timeouts (geen nieuwe timeouts.yaml)</li>
<li>Async cleanup in orchestrator (geen sync bridging in services)</li>
<li>CI-gates tegen legacy patterns</li>
</ul>

<h2>‚ö° Direct Refactor Strategie</h2>

<h3>Core Principes</h3>
<ul>
<li>**Single-user app**: Errors tijdens refactor zijn OK</li>
<li>**Direct refactor**: Alles in √©√©n keer aanpassen</li>
<li>**Fix wat breekt**: Geen workarounds, gewoon oplossen</li>
<li>**Clean architecture**: Business logica behouden, tech debt elimineren</li>
</ul>

<h2>üìÖ 5-Daags Actieplan (AANGEPAST)</h2>

<h3>Dag 1: UI Migratie + Wrapper Removal + Bug Fix</h3>

<p><strong>KRITIEK: UI migratie en wrapper removal SAMEN om gebroken UI te voorkomen</strong></p>

<h4>Ochtend: CFR-BUG-014 Fix (2 uur)</h4>

<p><strong>Bestanden:</strong> <code>src/voorbeelden/unified_voorbeelden.py</code></p>

<p><strong>1. Verbeter prompts voor synoniemen/antoniemen:</strong></p>
<pre><code>if request.example_type == ExampleType.SYNONIEMEN:
    return f"""Voor het begrip '{begrip}' met de volgende definitie:
{definitie}

Context: {context_text if context_text else 'Algemeen juridisch'}

Geef EXACT {request.max_examples} synoniemen of verwante termen.
BELANGRIJK:
- PRECIES {request.max_examples} items, niet meer en niet minder
- √â√©n synoniem per regel
- GEEN nummering, bullets, streepjes of andere formatting
- Als er geen {request.max_examples} perfecte synoniemen zijn, gebruik verwante termen"""</code></pre>

<p><strong>2. Enforce + retry logic:</strong></p>
<pre><code>async def _generate_with_retry(self, request: ExampleRequest, max_retries: int = 1):
    """Generate met 1 retry bij incorrect aantal."""
    for attempt in range(max_retries + 1):
        result = await self._generate_async(request)

        if request.example_type in [ExampleType.SYNONIEMEN, ExampleType.ANTONIEMEN]:
            expected = request.max_examples

            # Trim excess
            if len(result) &gt; expected:
                return result[:expected]

            # Accept on last attempt (avoid infinite loops)
            if len(result) &gt;= expected or attempt == max_retries:
                if len(result) &lt; expected:
                    logger.warning(f"Accepting {len(result)}/{expected} items after {attempt+1} attempts")
                return result

            # Retry with enhanced prompt
            request.extra_instruction = f"Je gaf {len(result)} items, maar er zijn EXACT {expected} nodig."

    return result</code></pre>

<p><strong>3. UI display fix:</strong></p>
<pre><code># In UI rendering, verwijder bullets voor synoniemen/antoniemen
if example_type in ["synoniemen", "antoniemen"]:
    # Geen "‚Ä¢ " prefix, gewoon de items
    for item in examples:
        st.write(item)  # Zonder bullet
else:
    # Andere types kunnen bullets hebben
    for item in examples:
        st.write(f"‚Ä¢ {item}")</code></pre>

<h4>Middag: UI Migratie + Service Cleanup (4 uur)</h4>

<p><strong>SAMEN uitvoeren om breaking UI te voorkomen:</strong></p>

<p><strong>Stap 1: Update alle UI imports (30 min):</strong></p>
<pre><code># Identificeer alle aanpassingen nodig
rg -l "generate_definition_sync|search_web_sources" src/ui/ --glob "!async_bridge.py"</code></pre>

<p><strong>Voor elk bestand:</strong></p>
<pre><code># Van:
from services.service_factory import get_definition_service
result = factory.generate_definition_sync(begrip, context, **kwargs)

# Naar:
from services.service_factory import get_definition_service
from ui.helpers.async_bridge import generate_definition_sync
result = generate_definition_sync(factory, begrip, context, **kwargs)</code></pre>

<p><strong>Stap 2: Direct verwijder deprecated methods (30 min):</strong></p>
<pre><code># In service_factory.py - VERWIJDER:
# - generate_definition_sync() op regel 404-444
# - search_web_sources() op regel 447-472</code></pre>

<p><strong>Stap 3: Test & fix runtime errors (3 uur):</strong></p>
<pre><code># Start app en fix errors real-time
OPENAI_API_KEY="$OPENAI_API_KEY_PROD" streamlit run src/main.py</code></pre>

<h3>Dag 2: Async Cleanup in Services</h3>

<h4>Ochtend: Orchestrator Async Fix (3 uur)</h4>

<p><strong>Probleem:</strong> Orchestrator V2 gebruikt sync <code>genereer_alle_voorbeelden()</code> binnen async flow</p>

<p><strong>Fix in <code>definition_orchestrator_v2.py</code>:</strong></p>
<pre><code># Van:
voorbeelden = self.voorbeelden_service.genereer_alle_voorbeelden(
    begrip, definitie, context_dict
)

# Naar:
voorbeelden = await self.voorbeelden_service.genereer_alle_voorbeelden_async(
    begrip, definitie, context_dict
)</code></pre>

<p><strong>Verwijder <code>_run_async_safe</code> uit services:</strong></p>
<pre><code># Vind alle sync bridging in services
rg "_run_async_safe|asyncio\.run" src/services/ --glob "!async_bridge.py"

# Voor elke match: refactor naar proper async</code></pre>

<h4>Middag: Timeout Integratie met rate_limit_config (3 uur)</h4>

<p><strong>Gebruik bestaande <code>src/config/rate_limit_config.py</code>:</strong></p>

<p><strong>Update async_bridge.py:</strong></p>
<pre><code>from config.rate_limit_config import get_endpoint_timeout

def generate_definition_sync(service_factory, begrip: str, context_dict: dict, **kwargs):
    """Gebruik endpoint-specifieke timeout uit rate_limit_config."""
    timeout = get_endpoint_timeout('definition_generation')  # Was: hardcoded 30
    return run_async(
        service_factory.generate_definition(begrip, context_dict, **kwargs),
        timeout=timeout
    )

def search_web_sources_sync(service_factory, term: str, sources: list | None = None):
    """Gebruik endpoint-specifieke timeout uit rate_limit_config."""
    timeout = get_endpoint_timeout('web_search')  # Was: hardcoded 15
    # ... rest of implementation</code></pre>

<p><strong>Voeg missing endpoints toe aan rate_limit_config.py:</strong></p>
<pre><code>ENDPOINT_CONFIGS["web_search"] = EndpointConfig(
    tokens_per_second=2.0,
    bucket_capacity=10,
    burst_capacity=5,
    target_response_time=3.0,
    timeout=15.0,
)</code></pre>

<h3>Dag 3: CI-Gates & Legacy Pattern Cleanup</h3>

<h4>Ochtend: Implementeer CI-Gates (2 uur)</h4>

<p><strong>Maak <code>.github/workflows/epic-010-gates.yml</code>:</strong></p>
<pre><code>name: EPIC-010 Legacy Pattern Gates

on: [push, pull_request]

jobs:
  check-legacy-patterns:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Check voor legacy imports
        run: |
          # Blokkeer oude patterns
          ! grep -r "from src.models.generation_result import" src/ || exit 1
          ! grep -r "\.overall_score" src/ || exit 1
          ! grep -r "request\.context[^_]" src/ || exit 1  # context als string
          ! grep -r "domein" src/ --include="*.py" || exit 1

      - name: Check voor async anti-patterns in services
        run: |
          # asyncio.run alleen toegestaan in async_bridge
          ! grep -r "asyncio\.run" src/services/ || exit 1
          ! grep -r "run_coroutine_threadsafe" src/services/ || exit 1

      - name: Check voor directe sync wrapper calls
        run: |
          # Geen directe calls buiten async_bridge
          FILES=$(grep -r "generate_definition_sync\|search_web_sources" src/ui/ --include="*.py" | grep -v async_bridge | grep -v "from.*async_bridge")
          if [ -n "$FILES" ]; then
            echo "Found direct sync wrapper calls:"
            echo "$FILES"
            exit 1
          fi</code></pre>

<h4>Middag: Elimineer Gevonden Legacy Patterns (4 uur)</h4>

<pre><code># Systematisch verwijder legacy patterns
rg "generation_result|overall_score|best_iteration" src/
rg "request\.context[^_]" src/  # context als string ipv dict
rg "domein" src/ --type py

# Fix elke gevonden instance</code></pre>

<h3>Dag 4: Test Suite Reparatie</h3>

<h4>Hele Dag: Fix Tests & Mocks</h4>

<pre><code># 1. Capture alle failures
pytest tests/ -v &gt; test_failures.txt 2&gt;&amp;1

# 2. Common fixes:
#    - Mock async_bridge ipv service_factory sync methods
#    - Update imports voor verwijderde modules
#    - Fix async test patterns

# 3. Focus op kritieke modules
pytest tests/services/test_service_factory.py  # Update voor removed methods
pytest tests/services/test_orchestrator_v2.py  # Fix async voorbeelden calls
pytest tests/ui/  # Update voor async_bridge usage

# 4. Run tot alles groen is
while ! pytest tests/ -q; do
    echo "Fixing next test..."
done</code></pre>

<h3>Dag 5: Verificatie & Documentatie</h3>

<h4>Ochtend: Final Verificatie (3 uur)</h4>

<p><strong>Verificatie checklist:</strong></p>
<pre><code># 1. UI callsites check
echo "=== Checking UI uses async_bridge ==="
! rg "factory\.generate_definition_sync" src/ui/
! rg "factory\.search_web_sources" src/ui/

# 2. Services async check
echo "=== Checking services are properly async ==="
! rg "asyncio\.run|_run_async_safe" src/services/

# 3. Synoniemen/antoniemen check
echo "=== Testing examples generation ==="
python -c "
from src.voorbeelden.unified_voorbeelden import UnifiedVoorbeeldenService
from src.voorbeelden.interfaces import ExampleRequest, ExampleType
service = UnifiedVoorbeeldenService()
for etype in [ExampleType.SYNONIEMEN, ExampleType.ANTONIEMEN]:
    req = ExampleRequest(
        begrip='contract',
        definitie='Een overeenkomst',
        context_dict={},
        example_type=etype,
        max_examples=5
    )
    result = service.generate(req)
    print(f'{etype}: {len(result.examples)} items')
    assert len(result.examples) &gt;= 3  # Minimum acceptable
"

# 4. Orchestrator async check
echo "=== Checking orchestrator uses async voorbeelden ==="
rg "genereer_alle_voorbeelden_async" src/services/orchestrators/

# 5. Full app test
OPENAI_API_KEY="$OPENAI_API_KEY_PROD" streamlit run src/main.py</code></pre>

<h4>Middag: Documentatie Update (3 uur)</h4>

<p><strong>Update bestanden:</strong></p>
<ol>
<li>`docs/backlog/EPIC-010/EPIC-010.md` ‚Üí Status: 100%</li>
<li>`CHANGELOG.md` ‚Üí Document breaking changes</li>
<li>Verwijder obsolete docs:</li>
</ol>
<ul>
<li>  - `docs/handover-epic-010-completion.md`</li>
<li>  - `docs/epic-010-completion-plan.md` (vervangen door v2)</li>
</ul>

<h2>‚úÖ Definition of Done</h2>

<h3>Dag 1 Checklist:</h3>
<ul>
<li>[ ] CFR-BUG-014: synoniemen/antoniemen zonder bullets, retry logic</li>
<li>[ ] UI gebruikt async_bridge voor alle calls</li>
<li>[ ] Deprecated methods verwijderd uit ServiceFactory</li>
<li>[ ] App draait zonder errors</li>
</ul>

<h3>Dag 2 Checklist:</h3>
<ul>
<li>[ ] Orchestrator gebruikt `genereer_alle_voorbeelden_async`</li>
<li>[ ] Geen `_run_async_safe` in services</li>
<li>[ ] Timeouts via `get_endpoint_timeout` uit rate_limit_config</li>
</ul>

<h3>Dag 3 Checklist:</h3>
<ul>
<li>[ ] CI-gates actief tegen legacy patterns</li>
<li>[ ] Geen generation_result, overall_score, domein references</li>
<li>[ ] Geen asyncio.run in services</li>
</ul>

<h3>Dag 4 Checklist:</h3>
<ul>
<li>[ ] Alle tests groen</li>
<li>[ ] Mocks updated voor async_bridge</li>
</ul>

<h3>Dag 5 Checklist:</h3>
<ul>
<li>[ ] Verificatie script succesvol</li>
<li>[ ] EPIC-010: 100% COMPLETE</li>
<li>[ ] Documentatie bijgewerkt</li>
</ul>

<h2>üéØ Key Metrics</h2>

<p>| Metric | Target | Verificatie |</p>
<p>|--------|--------|-------------|</p>
<p>| Synoniemen/Antoniemen | ‚â•3 items, geen bullets | Test script |</p>
<p>| UI Stability | 0 crashes | Manual test |</p>
<p>| Async Compliance | 0 sync bridges in services | grep check |</p>
<p>| Legacy Patterns | 0 occurrences | CI gates |</p>
<p>| Test Coverage | ‚â• baseline | pytest coverage |</p>

<h2>üí™ Voordelen Direct Refactor v2</h2>

<ol>
<li>**Geen gebroken UI**: Migratie + removal samen</li>
<li>**Hergebruik bestaande config**: rate_limit_config.py</li>
<li>**Clean async**: Services volledig async</li>
<li>**CI protection**: Gates tegen regressie</li>
<li>**5 dagen totaal**: Effici√´nt en gefocust</li>
</ol>

<h2>üö® Risk Mitigatie</h2>

<p>| Risico | Mitigatie |</p>
<p>|--------|-----------|</p>
<p>| UI breekt | Dag 1: migratie + removal samen |</p>
<p>| Te weinig synoniemen | 1 retry, accepteer <N op laatste poging |</p>
<p>| Dubbele timeouts | Gebruik alleen rate_limit_config |</p>
<p>| Legacy pattern regressie | CI-gates blokkeren bad patterns |</p>

<h2>üìù Final Notes</h2>

<p>Dit v2 plan integreert alle review feedback:</p>
<ul>
<li>UI migratie gebeurt SAMEN met wrapper removal (Dag 1)</li>
<li>Orchestrator gebruikt async voorbeelden (Dag 2)</li>
<li>Timeouts via bestaande rate_limit_config (geen nieuwe yaml)</li>
<li>CI-gates beschermen tegen regressie (Dag 3)</li>
<li>Synoniemen/antoniemen: retry + geen bullets in UI</li>
</ul>

<p><strong>Remember</strong>: Direct refactor = fix wat breekt, geen workarounds!</p>

  </div>
</body>
</html>