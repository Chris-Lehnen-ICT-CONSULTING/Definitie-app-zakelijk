<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Synonym Pages Review - Executive Summary</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">‚Üê Terug naar Portal</a>
    <h1>Synonym Pages Review - Executive Summary</h1>

<p><strong>Date:</strong> 2025-10-10</p>
<p><strong>Files Reviewed:</strong> <code>src/pages/synonym_admin.py</code> (460 lines), <code>src/pages/synonym_metrics.py</code> (78 lines)</p>
<p><strong>Status:</strong> ‚ö†Ô∏è <strong>DO NOT DEPLOY - Critical Bugs Found</strong></p>

<h2>Critical Bugs (Must Fix)</h2>

<h3>üî¥ Bug #1: Non-Existent API Call</h3>
<p><strong>Location:</strong> <code>synonym_admin.py:299</code></p>

<pre><code>all_groups = registry.get_all_groups()  # ‚ùå METHOD DOES NOT EXIST</code></pre>

<p><strong>Impact:</strong> Page will crash with <code>AttributeError</code> on first load.</p>

<p><strong>Fix:</strong> Add to <code>SynonymRegistry</code>:</p>
<pre><code>def get_all_groups(self, limit: int | None = None) -&gt; list[SynonymGroup]:
    """Get all synonym groups."""
    with self._get_connection() as conn:
        query = "SELECT * FROM synonym_groups ORDER BY updated_at DESC"
        if limit:
            query += f" LIMIT {limit}"
        cursor = conn.execute(query)
        return [self._row_to_group(row) for row in cursor.fetchall()]</code></pre>

<p>---</p>

<h3>üî¥ Bug #2: N+1 Query Problem</h3>
<p><strong>Location:</strong> <code>synonym_admin.py:299-312</code></p>

<pre><code>for group in all_groups:  # 100 groups = 100 queries!
    members = registry.get_group_members(group_id=group.id, ...)</code></pre>

<p><strong>Impact:</strong> Severe performance degradation (100+ DB queries per page load).</p>

<p><strong>Fix:</strong> Add to <code>SynonymRegistry</code>:</p>
<pre><code>def get_all_members_filtered(
    self,
    statuses: list[str] | None = None,
    min_weight: float = 0.0,
    term_search: str | None = None,
    limit: int | None = None,
    offset: int = 0
) -&gt; list[SynonymGroupMember]:
    """Get all members across groups with filters (single query)."""
    with self._get_connection() as conn:
        query = "SELECT * FROM synonym_group_members WHERE weight &gt;= ?"
        params = [min_weight]

        if statuses:
            placeholders = ", ".join("?" for _ in statuses)
            query += f" AND status IN ({placeholders})"
            params.extend(statuses)

        if term_search:
            query += " AND term LIKE ?"
            params.append(f"%{term_search}%")

        query += " ORDER BY weight DESC, is_preferred DESC"

        if limit:
            query += " LIMIT ? OFFSET ?"
            params.extend([limit, offset])

        cursor = conn.execute(query, params)
        return [self._row_to_member(row) for row in cursor.fetchall()]</code></pre>

<p>---</p>

<h3>üî¥ Bug #3: Wrong Statistics Keys</h3>
<p><strong>Location:</strong> <code>synonym_metrics_tab.py:195, 209, 213, 254</code></p>

<pre><code># ‚ùå Wrong keys (will return 0 for all counts)
pending_count = stats.get('by_status', {}).get('ai_pending', 0)
source_stats = stats.get('by_source', {})

# ‚úÖ Correct keys
pending_count = stats.get('members_by_status', {}).get('ai_pending', 0)
source_stats = stats.get('members_by_source', {})</code></pre>

<p><strong>Impact:</strong> Metrics dashboard shows incorrect data (all zeros).</p>

<p>---</p>

<h3>üî¥ Bug #4: Wrong Parameter Type</h3>
<p><strong>Location:</strong> <code>synonym_admin.py:309</code></p>

<pre><code>order_by=['weight DESC']  # ‚ùå Expects str | None, receives list[str]</code></pre>

<p><strong>Fix:</strong></p>
<pre><code>order_by='weight DESC'  # ‚úÖ Single string</code></pre>

<p>---</p>

<h2>High Priority Issues</h2>

<h3>üü° Missing Async Error Handling</h3>
<p><strong>Location:</strong> <code>synonym_admin.py:193-199</code></p>

<pre><code># ‚ùå No error handling for timeouts
synonyms, ai_pending_count = asyncio.run(
    orchestrator.ensure_synonyms(...)
)</code></pre>

<p><strong>Fix:</strong></p>
<pre><code>try:
    synonyms, ai_pending_count = asyncio.run(...)
except asyncio.TimeoutError:
    st.error("‚ùå GPT-4 timeout na 30 seconden")
except Exception as e:
    st.error(f"‚ùå Fout: {e}")
    logger.error(f"Generation error: {e}", exc_info=True)</code></pre>

<p>---</p>

<h3>üü° No Database Schema Validation</h3>
<p><strong>Impact:</strong> Pages crash if <code>synonym_groups</code> tables don't exist.</p>

<p><strong>Fix:</strong> Add to both pages before rendering:</p>
<pre><code>try:
    stats = registry.get_statistics()
except sqlite3.OperationalError:
    st.error(
        "‚ùå Synonym tables not found. "
        "Run migration: `python scripts/migrate_synonym_tables.py`"
    )
    st.stop()</code></pre>

<p>---</p>

<h2>What Works Well ‚úÖ</h2>

<ol>
<li>**Architecture conformance** - Correct use of v3.1 orchestrator/registry pattern</li>
<li>**Streamlit patterns** - Good use of `@st.cache_resource`, session state</li>
<li>**UX design** - Progressive disclosure, confirmations for destructive actions</li>
<li>**SQL safety** - No injection vulnerabilities, parameterized queries</li>
<li>**Component structure** - Metrics page delegates well to reusable tab component</li>
</ol>

<p>---</p>

<h2>Fix Effort Estimate</h2>

<p>| Priority | Tasks | Time |</p>
<p>|----------|-------|------|</p>
<p>| Critical | Add registry methods, fix queries, fix stats keys | 2-3 hours |</p>
<p>| High | Error handling, schema validation | 1-2 hours |</p>
<p>| Testing | Unit + integration tests | 1-2 hours |</p>
<p>| <strong>Total</strong> | | <strong>4-7 hours</strong> |</p>

<p>---</p>

<h2>Recommendation</h2>

<p><strong>DO NOT DEPLOY</strong> current version to production.</p>

<p><strong>Action Plan:</strong></p>
<ol>
<li>Fix critical bugs (#1-4) - **Required for basic functionality**</li>
<li>Add error handling and validation - **Required for stability**</li>
<li>Test thoroughly with realistic data - **Required for confidence**</li>
<li>Deploy to staging for user acceptance testing</li>
</ol>

<p><strong>Post-fix assessment:</strong> With bugs resolved, these pages provide excellent synonym management capabilities and integrate cleanly with existing architecture.</p>

<p>---</p>

<h2>Quick Reference: Files to Edit</h2>

<pre><code># 1. Add missing methods
src/repositories/synonym_registry.py
  - Add: get_all_groups()
  - Add: get_all_members_filtered()
  - Add: count_members_filtered()

# 2. Fix admin page
src/pages/synonym_admin.py
  - Lines 299-312: Replace with get_all_members_filtered()
  - Lines 193-227: Add try/except for async calls
  - Add: Schema validation at top

# 3. Fix metrics tab
src/ui/tabs/synonym_metrics_tab.py
  - Lines 195, 209, 213, 254: Fix statistics keys

# 4. Add tests
tests/repositories/test_synonym_registry_queries.py (new)
tests/integration/test_synonym_admin_workflow.py (new)</code></pre>

<p>---</p>

<p><strong>Detailed analysis:</strong> See <code>docs/reviews/synonym-pages-technical-review.md</code></p>

  </div>
</body>
</html>