<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Code Review Rapport</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">← Terug naar Portal</a>
    <p>---</p>
<p>titel: Code Review Rapport</p>
<p>generated: 2025-09-16</p>
<p>status: draft</p>
<p>owner: development</p>
<p>applies_to: definitie-app@current</p>
<p>---</p>

<h1>Code Review — Refactorstatus naar Moderne Architectuur (V2)</h1>

<p>Doel: actuele status van de refactor (legacy → V2) met concrete bevindingen, risico’s en aanbevelingen. Dit rapport is gebaseerd op quick‑checks, een smoke test baseline en gerichte repo‑scans.</p>

<h2>Samenvatting</h2>
<ul>
<li>Smoke tests: OK (3 passed). Volledige `pytest -q` time‑out in CLI; lokaal draaien aanbevolen voor volledige dekking.</li>
<li>V2 aanwezig: `DefinitionOrchestratorV2` en `ValidationOrchestratorV2` worden gebruikt (container + UI wiring).</li>
<li>Endpoint‑timeouts en rate limiting centraal geregeld: `src/config/rate_limit_config.py`; UI gebruikt `get_endpoint_timeout()`.</li>
<li>Belangrijkste blockers richting “volledig modern”: wijdverbreide `asyncio.run(...)` buiten de UI‑bridge, enkele legacy markers/compat‑paden, en UI‑code die nog V1‑patroon `best_iteration` aanraakt.</li>
</ul>

<h2>Quick‑Checks (objectieve signalen)</h2>

<p>1) Legacy patronen in <code>src/</code></p>
<ul>
<li>`asyncio.run(`: 21 hits (o.a. in validators, voorbeelden, utils, security, UI helpers/components)</li>
<li> - Voorbeelden:  </li>
<li>   - `src/validation/sanitizer.py:684`  </li>
<li>   - `src/utils/resilience.py:729`  </li>
<li>   - `src/ui/helpers/async_bridge.py:52,53`  </li>
<li>   - `src/ui/tabbed_interface.py:796`  </li>
<li>   - `src/ui/components/monitoring_tab.py:695`</li>
<li>`best_iteration`: 6 hits (bv. `src/ui/components/orchestration_tab.py` — V1‑achtig aggregatiepatroon)</li>
<li>V1 result import: 0 hits voor `from src.models.generation_result import` (goed teken)</li>
</ul>

<p>2) V2‑UI contract keys (indicaties in UI)</p>
<ul>
<li>Aanwezig: `definitie_gecorrigeerd` (27), `validation_details` (6), `metadata` (100), `voorbeelden` (120) in `src/ui/`.</li>
<li>Interpretatie: V2‑shape is breed aanwezig in de UI; controleer consistent gebruik (geen mix met V1‑sleutels).</li>
</ul>

<p>3) Endpoints/rate limits/timeouts</p>
<ul>
<li>Centraal beheerd in `src/config/rate_limit_config.py`; UI‑bridge haalt timeouts op via `get_endpoint_timeout()`.</li>
<li>Aanbeveling: vervang ad‑hoc timeouts (bv. in `unified_voorbeelden.py`) door centrale lookups waar passend.</li>
</ul>

<p>4) Legacy/DEPRECATED markers (28 hits)</p>
<ul>
<li>Compatibiliteitspaden aanwezig (bv. `definition_orchestrator_v2.py` heeft LEGACY‑compat secties; diverse `DEPRECATED` verwijzingen in services).</li>
</ul>

<h2>Correctness & Tests</h2>
<ul>
<li>Smoke: `tests/smoke/test_validation_v2_smoke.py` — 3/3 groen.  </li>
<li>Volledige suite: time‑out in CLI. Aanbevolen lokaal: `pytest -q && pytest tests/integration -q` met hogere timeout.</li>
</ul>

<h2>Bevindingen per thema</h2>

<ul>
<li>Async/Bridging</li>
<li> - Bevinding: `asyncio.run` komt voor in niet‑UI‑paden (validators/utils). Richtlijn: uitsluitend in `ui/helpers/async_bridge.py` gebruiken, elders async all‑the‑way of via bridge aanroepen.</li>
<li> - Risico: deadlocks/event‑loop conflicten; moeilijk testbare paden; inconsistent timeouts.</li>
</ul>

<ul>
<li>UI Orchestration</li>
<li> - Bevinding: `best_iteration` selectie in `orchestration_tab.py` wijst op V1‑achtig aggregatiepad. V2 verwacht duidelijk contract (dict‑shape) i.p.v. losse iteratieselectie in UI.</li>
<li> - Aanpak: laat services de juiste eindshape leveren; UI alleen presenteren en opslaan.</li>
</ul>

<ul>
<li>Config/Timeouts/Rate limiting</li>
<li> - Sterk punt: centrale `rate_limit_config.py` met endpoint‑timeouts en rate‑limiting.</li>
<li> - Verbetering: gebruik centrale timeouts breder (reduceer hardcoded `timeout=10.0` e.d. in `unified_voorbeelden.py`).</li>
</ul>

<ul>
<li>Legacy Compatibiliteit</li>
<li> - Bevinding: `LEGACY` en `DEPRECATED` markers aanwezig in services en feature flags (LEGACY tabs/agents nog ge‑feature‑flagd).</li>
<li> - Aanpak: plan gecontroleerde verwijdering (zie Backlog) nadat UI/flows volledig V2 zijn.</li>
</ul>

<h2>Aanbevolen Aanpak (kort)</h2>
<p>1) Async‑schoonmaak: verwijder <code>asyncio.run</code> buiten <code>ui/helpers/async_bridge.py</code>; migreer validators/utils naar pure async of roep via bridge aan in UI‑laag.</p>
<p>2) UI‑aggregatie moderniseren: elimineer <code>best_iteration</code>‑logica uit UI; verplaats selectie naar service/orchestrator en lever V2‑dict.</p>
<p>3) Timeouts harmoniseren: gebruik <code>get_endpoint_timeout()</code> in paden met AI/web lookups en voorbeelden‑generaties; vermijd duplicaat/hardcoded timeouts.</p>
<p>4) Legacy feature flags: zet DEPRECATED flags naar off en verwijder codepaden gefaseerd (na testdekking).</p>
<p>5) Testuitvoerbaarheid: splits trage integratiepaden of voeg markers toe; zorg dat <code>pytest -q</code> binnen CI‑timeout draait.</p>

<h2>Quick‑Win Patches (minimal diff)</h2>
<ul>
<li>Verplaats ad‑hoc `asyncio.run(...)` test‑aanroepen in modules (bv. `test_*` hulpfuncties) naar echte testbestanden onder `tests/` of guard ze onder `if __name__ == "__main__":`.</li>
<li>Introduceer helper(s) die centrale timeouts ophalen en vervang hardcoded waarden in `unified_voorbeelden.py`.</li>
<li>In `orchestration_tab.py`: vervang `best_iteration`/losse field‑mapping door gebruik van een door services geleverde V2‑dict.</li>
</ul>

<h2>Backlog (geprioriteerd)</h2>
<p>1) Verwijder <code>asyncio.run</code> buiten UI‑bridge (validators/utils) — risico: event‑loop conflicten; winst: stabiliteit/testbaarheid.</p>
<p>2) Harmoniseer timeouts via <code>rate_limit_config</code> (vooral voorbeelden‑paden) — winst: minder timeouts, voorspelbaar gedrag.</p>
<p>3) UI orchestration V2‑conform maken (weg met <code>best_iteration</code>) — winst: duidelijke verantwoordelijkheid, minder UI‑logica.</p>
<p>4) Opruimen DEPRECATED/LEGACY paden + flags — winst: eenvoud, minder onderhoud.</p>
<p>5) Test performance: verdeel suites/scope zodat volledige tests binnen CI‑budget passen; voeg integratielabels toe.</p>

<h2>Acceptatiecriteria (DoD)</h2>
<ul>
<li>Geen `asyncio.run` in services/validators/utils; alleen via `ui/helpers/async_bridge.py`.</li>
<li>UI werkt uitsluitend met V2‑dict contract (inclusief `definitie_gecorrigeerd`, `validation_details`, `voorbeelden`, `metadata`).</li>
<li>Endpoints/AI/web‑lookups gebruiken centrale timeouts/rate limits.</li>
<li>Smoke + unit/integratie groen binnen overeengekomen timeout.</li>
<li>Legacy/DEPRECATED codepaden verwijderd of feature‑flagged off, met migratienotities.</li>
</ul>

<h2>Evidence (bijlage)</h2>
<ul>
<li>Grep samenvatting: `asyncio.run` (21), `best_iteration` (6), V2‑UI keys aanwezig, V1 result import (0).  </li>
<li>Smoke test: 3 passed, 0 failed.</li>
</ul>


  </div>
</body>
</html>