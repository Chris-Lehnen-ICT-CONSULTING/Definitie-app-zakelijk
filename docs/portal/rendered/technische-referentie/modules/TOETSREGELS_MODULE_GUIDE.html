<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Toetsregels Module Guide</title>
  <link rel="stylesheet" href="../portal.css" />
  <style>
    .doc { max-width: 900px; margin: 16px auto 48px auto; padding: 0 16px; }
    .doc h1,.doc h2,.doc h3,.doc h4{ color:#223 }
    .doc p{ line-height:1.6; color:#222 }
    .doc a{ color:#1d4ed8; text-decoration: underline; }
    .doc pre{ background:#0b1020; color:#e6edf3; padding:12px; overflow:auto; border-radius:8px }
    .doc code{ background:#f0f2f5; padding:2px 6px; border-radius:4px }
    .back{ display:inline-block; margin:12px 0; padding:6px 10px; border:1px solid #ccd; border-radius:6px; text-decoration:none; color:#223; background:#f8f9fb }
  </style>
</head>
<body>
  <div class="doc">
    <a class="back" href="../../index.html">← Terug naar Portal</a>
    <h1>Toetsregels Module Guide</h1>

<h2>Overzicht</h2>

<p>Elke toetsregel in DefinitieAgent bestaat uit twee delen:</p>
<ol>
<li>**JSON configuratie** - Metadata, patronen en voorbeelden</li>
<li>**Python module** - Specifieke validatie logica (optioneel)</li>
</ol>

<h2>Structuur</h2>

<p>V2 gebruikt primair JSON‑regels via de ToetsregelManager. Python validators zijn optioneel en leven in een aparte map.</p>

<pre><code>src/toetsregels/
├── regels/
│   ├── ESS-03.json          # JSON configuratie (canoniek voor V2)
│   ├── CON-01.json          # Alleen JSON (fallback pattern‑based)
│   └── ...
└── validators/
    ├── ESS_03.py            # Python validator (underscores)
    ├── CON_01.py            # Python validator (underscores)
    └── ...</code></pre>

<p>Let op naamgeving:</p>
<ul>
<li>JSON: koppeltekens (bijv. `ESS-03.json`).</li>
<li>Python: underscores (bijv. `ESS_03.py`) in de map `validators/`.</li>
</ul>

<h2>Nieuwe Toetsregel Maken</h2>

<h3>Automatisch met Script</h3>

<pre><code>cd src/toetsregels
python create_regel_module.py TEST-01 "Test regel naam" "Uitleg van de regel"</code></pre>

<p>Dit maakt:</p>
<ul>
<li>`regels/TEST-01.json` - Basis configuratie</li>
<li>`regels/TEST_01.py` - Python module template</li>
</ul>

<h3>JSON Configuratie</h3>

<pre><code>{
  "id": "TEST-01",
  "naam": "Korte beschrijving van de regel",
  "uitleg": "Wat deze regel controleert",
  "toelichting": "Uitgebreide uitleg en context",
  "toetsvraag": "Vraag die met ja/nee beantwoord kan worden",
  "herkenbaar_patronen": [
    "\\bpatroon1\\b",
    "\\bpatroon2\\b"
  ],
  "goede_voorbeelden": [
    "Voorbeeld van goede definitie",
    "Nog een goed voorbeeld"
  ],
  "foute_voorbeelden": [
    "Voorbeeld van foute definitie"
  ],
  "prioriteit": "hoog|midden|laag",
  "aanbeveling": "verplicht|aanbevolen|optioneel",
  "geldigheid": "algemeen|specifiek domein",
  "status": "concept|definitief",
  "type": "essentie|structuur|content|integriteit",
  "thema": "thema van de regel",
  "brondocument": "ASTRA|eigen",
  "relatie": []
}</code></pre>

<h3>Python Module (optioneel)</h3>

<p>De Python validator geeft je volledige controle over de validatie logica en wordt door UI‑detailvalidatie gebruikt. V2‑service kan deze ook via een adapter benutten.</p>

<pre><code>class TEST01Validator:
    def __init__(self, config: Dict):
        """Initialiseer met JSON config."""
        self.config = config

    def validate(self, definitie: str, begrip: str,
                context: Optional[Dict] = None) -&gt; Tuple[bool, str, float]:
        """
        Valideer de definitie.

        Returns:
            - bool: Success (True/False)
            - str: Melding voor gebruiker
            - float: Score (0.0 - 1.0)
        """
        # Complexe validatie logica hier
        if self._check_complex_rule(definitie):
            return True, f"✔️ {self.id}: Regel voldaan", 1.0
        else:
            return False, f"❌ {self.id}: {self.uitleg}", 0.0

    def get_generation_hints(self) -&gt; List[str]:
        """Geef hints voor AI generatie."""
        return ["Hint 1", "Hint 2"]</code></pre>

<h2>Validatie Logica Patterns</h2>

<h3>1. Context-Afhankelijke Validatie</h3>

<pre><code>def validate(self, definitie: str, begrip: str, context: Optional[Dict] = None):
    # Check context
    if context and context.get('categorie') == 'proces':
        # Speciale logica voor processen
        return self._validate_proces(definitie)
    else:
        # Standaard validatie
        return self._validate_standaard(definitie)</code></pre>

<h3>2. Geavanceerde Pattern Matching</h3>

<pre><code>def validate(self, definitie: str, begrip: str, context: Optional[Dict] = None):
    # Meerdere patronen met verschillende scores
    patterns = [
        (r'\buniek\s+identificatie', 1.0, "Expliciete unieke ID"),
        (r'\b(individueel|specifiek)\b', 0.8, "Impliciete uniciteit"),
        (r'\b(onderscheidbaar|herkenbaar)\b', 0.6, "Zwakke indicatie")
    ]

    for pattern, score, beschrijving in patterns:
        if re.search(pattern, definitie, re.IGNORECASE):
            return True, f"✔️ {self.id}: {beschrijving}", score

    return False, f"❌ {self.id}: Geen unieke identificatie", 0.0</code></pre>

<h3>3. Semantische Analyse</h3>

<pre><code>def validate(self, definitie: str, begrip: str, context: Optional[Dict] = None):
    # Tel belangrijke concepten
    concepten = self._extract_concepten(definitie)

    score = len(concepten) / 5.0  # Normaliseer naar 0-1
    score = min(score, 1.0)

    if score &gt; 0.6:
        return True, f"✔️ Voldoende concepten: {', '.join(concepten)}", score
    else:
        return False, f"❌ Te weinig concepten", score</code></pre>

<h2>V2 Validatie en Testen</h2>

<h3>V2 Service (ModularValidationService)</h3>
<ul>
<li>Laadt JSON‑regels via de ToetsregelManager.</li>
<li>Kan uitgebreid worden OM Python validators via een module‑adapter te evalueren.</li>
<li>Geeft schema‑conforme resultaten terug (overall_score, violations, enz.).</li>
</ul>

<h3>Unit Test Template (validators)</h3>

<pre><code># tests/test_toetsregel_TEST_01.py
import pytest
from toetsregels.modular_loader import validate_met_regel

def test_test01_success():
    """Test succesvolle validatie."""
    definitie = "Een test is een voorbeeld met unieke ID"
    succes, melding, score = validate_met_regel("TEST-01", definitie, "test")

    assert succes == True
    assert score &gt; 0.8
    assert "✔️" in melding

def test_test01_failure():
    """Test gefaalde validatie."""
    definitie = "Een test is iets"
    succes, melding, score = validate_met_regel("TEST-01", definitie, "test")

    assert succes == False
    assert score &lt; 0.5
    assert "❌" in melding</code></pre>

<h3>Interactief Testen</h3>

<pre><code># Test een specifieke regel
from toetsregels.modular_loader import get_modular_loader

loader = get_modular_loader()
succes, melding, score = loader.validate_with_regel(
    "ESS-03",
    "Een auto is een voertuig met kenteken ABC-123",
    "auto"
)
print(f"{melding} (score: {score})")</code></pre>

<h2>Best Practices</h2>

<ol>
<li>**Start Simpel**: Begin met pattern matching in JSON, voeg Python toe als nodig</li>
<li>**Hergebruik Patronen**: Gebruik `self.compiled_patterns` voor performance</li>
<li>**Duidelijke Meldingen**: Geef specifieke feedback wat er mis is</li>
<li>**Scores Gebruiken**: Gebruik scores (0-1) voor graduele validatie</li>
<li>**Context Bewust**: Gebruik context voor slimmere validatie</li>
<li>**Test Driven**: Schrijf tests voordat je de validator implementeert</li>
</ol>

<h2>Troubleshooting</h2>

<h3>Regel wordt niet geladen</h3>
<ul>
<li>Check of JSON bestand bestaat in `regels/` directory</li>
<li>Controleer JSON syntax met `python -m json.tool regels/REGEL-ID.json`</li>
</ul>

<h3>Python module wordt niet gebruikt</h3>
<ul>
<li>Bestandsnaam moet overeenkomen: `ESS-03.json` → `ESS_03.py`</li>
<li>Check class naam: `ESS03Validator` of `create_validator` functie</li>
</ul>

<h3>Validatie werkt niet</h3>
<ul>
<li>Check logs voor regex fouten</li>
<li>Test patronen met https://regex101.com</li>
<li>Gebruik debugger in validate() methode</li>
<p>---</p>
<p>canonical: true</p>
<p>status: active</p>
<p>owner: validation</p>
<p>last_verified: 02-09-2025</p>
<p>applies_to: definitie-app@v2</p>
<p>---</p>
</ul>

  </div>
</body>
</html>