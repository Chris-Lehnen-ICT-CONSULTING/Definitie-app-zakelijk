---
aangemaakt: '2025-09-08'
applies_to: definitie-app@v2
bijgewerkt: '2025-09-08'
canonical: false
last_verified: 2025-09-02
owner: product
prioriteit: medium
status: archived
---



# [ARCHIVED] DefinitieAgent Brownfield Enhancement PRD

Deze PRD is gearchiveerd. Voor de actuele architectuur en implementatiestatus:
- Canoniek: `docs/architectuur/SOLUTION_ARCHITECTURE.md`
- Validatie V2: `docs/stories/epic-2-story-2.4-integration-migration.md`
- Health/Status: `reports/status/validation-status.json`

## Intro Project Analysis and Context

### Analysis Source
Document-project output available at: `docs/architectuur/V2_AI_SERVICE_MIGRATIE_BROWNFIELD.md`

### Current Project State
DefinitieAgent is een juridische definitie generatie service met een hybride architectuur:
- **V1 Orchestrator**: Monolithische sync implementatie (490+ regels, productie-klaar)
- **V2 Orchestrator**: 11-fase gestructureerde async flow met **legacy fallbacks**
- **AsyncGPTClient**: Volledig geïmplementeerde async OpenAI wrapper (rate limiting, caching, retries)
- **AI Service**: Sync service laag met moderne interface maar geen async ondersteuning

### Available Documentation Analysis
Document-project analysis available - using existing technical documentation:
- ✅ Tech Stack Documentatie
- ✅ Source Tree/Architectuur
- ✅ API Documentatie
- ✅ Externe API Documentatie
- ✅ Technische Schuld Documentatie

### Enhancement Scope Definition

**Enhancement Type**: ☑️ Integratie met Nieuwe Systemen (AsyncGPTClient → V2 Orchestrator)

**Enhancement Description**:
Implementatie van AIServiceV2 om de legacy fallback mechanismen in V2 orchestrator te vervangen door native async AI calls via bestaande AsyncGPTClient infrastructuur.

**Impact Assessment**: ☑️ Gemiddelde Impact (enkele bestaande code wijzigingen)
- Nieuwe AIServiceV2 klasse toevoegen
- V2 orchestrator legacy fallback vervangen
- Interface definitie toevoegen aan interfaces.py
- V1 orchestrator blijft ongewijzigd

### Goals and Background Context

**Goals**:
• Elimineer legacy sync fallbacks in V2 orchestrator
• Integreer bestaande AsyncGPTClient in service laag
• Behoud 100% backward compatibility met V1 flows
• Realiseer 3-5x performance verbetering voor batch operaties

**Background Context**:
De V2 orchestrator is gebouwd voor async AI verwerking maar valt terug op sync legacy calls vanwege ontbrekende AIServiceInterface implementatie. AsyncGPTClient bestaat al volledig met rate limiting, caching en retry logic, maar wordt niet gebruikt door de orchestrator laag. Deze migratie combineert bestaande technische componenten zonder nieuwe external dependencies.

**Change Log**:
| Wijziging | Datum | Versie | Beschrijving | Auteur |
|-----------|-------|--------|--------------|---------|
| Initial PRD | 2025-08-28 | 1.0 | V2 AI Service migratie vereistes | PM John |
| Codex Updates | 2025-08-28 | 1.1 | Codex cross-validation: FR6, NFR6-7, story updates | PM John |
| Strategic Pivot | 2025-08-28 | 2.0 | V1 elimination strategy: Remove compatibility vereistes, add validation vereistes | PM John |

## Requirements

### Functionele Requirements

**FR1**: De V2 orchestrator moet native async AI calls kunnen maken via AIServiceV2 zonder legacy fallbacks

**FR2**: AIServiceV2 moet AsyncGPTClient hergebruiken voor rate limiting, caching, en retry logic

**FR3**: AIServiceInterface moet gedefinieerd worden in interfaces.py met async generate_definition() en batch_generate() methoden

**FR4**: **[V1 ELIMINATION]** V1 orchestrator code moet volledig gedeactiveerd en verwijderd worden uit service container routing

**FR5**: **[V1 ELIMINATION]** Legacy functions (`stuur_prompt_naar_gpt()`) moeten gedepreceerd en verwijderd worden

**FR8**: **[ARCHITECT]** Interface moet explicit batch support bevatten met AIGenerationResult structured response inclusief generation_time, cached status, en retry_count

**FR9**: **[ARCHITECT]** Error taxonomie moet geharmoniseerd worden naar AIServiceError wrapper als facade over OpenAI errors

**FR6**: **[CODEX]** AIServiceV2 moet OpenAI errors (OpenAIError, RateLimitError) wrappen naar AIServiceError voor consistent error handling

**FR7**: **[ARCHITECT REQUIREMENT]** Emergency rollback procedure moet gedocumenteerd zijn voor V1 restoration indien nodig

### Niet-Functionele Requirements

**NFR1**: AIServiceV2 moet 3-5x performance verbetering leveren voor batch operaties vergeleken met legacy sync calls (throughput ≥ 3x V1 bij parallelle prompts)

**NFR2**: **[ARCHITECT CRITICAL]** V2 orchestrator met AIServiceV2 moet performance parity behouden met V1 baseline voor single requests (p95 latency ≤ V1 ±10%)

**NFR3**: **[PRE-MORTEM]** AsyncGPTClient rate limiter moet thread-safe zijn onder concurrent load (min 50 requests/sec)

**NFR4**: **[PRE-MORTEM]** AIServiceV2 moet gebruik maken van dezelfde cache keys als legacy AI service voor consistency, met thread-pool execution voor sync cache calls in async context

**NFR5**: **[PRE-MORTEM]** V2 orchestrator met AIServiceV2 moet minimaal gelijke performance hebben als V1 voor single requests

**NFR6**: **[CODEX REVISED]** AIServiceV2 token counting implementeert heuristiek (tiktoken) met ≥90% accuracy of rapportage met 'tokens_estimated' flag totdat per-call usage beschikbaar

**NFR7**: **[CODEX]** AIServiceV2 moet RateLimitConfig centraliseren via config_manager i.p.v. eigen configuratie om conflicten te voorkomen

**NFR10**: **[ARCHITECT]** Observability metrics moeten minimaal bevatten: generation_time, tokens_used/tokens_estimated, model, retry_count, cache_hit

**NFR11**: **[ARCHITECT]** Logging moet eenduidige, parsebare logs genereren (JSON of gestructureerde velden) voor alle AI calls

**NFR8**: **[ARCHITECT MANDATORY]** Comprehensive performance benchmarking suite moet V1 vs V2+AIServiceV2 vergelijking uitvoeren voor validation (single request p95 ≤ +10%, batch throughput ≥ 3x)

**NFR9**: **[ARCHITECT MANDATORY]** AsyncGPTClient stability testing moet concurrent load scenarios valideren (50 rps gedurende 30-60 min voor rate limiter stabiliteit)

### Compatibiliteit Requirements

**CR1**: AIServiceV2 moet implementeren van AIServiceInterface voor type safety in V2 orchestrator

**CR2**: Database schema compatibility - geen database wijzigingen vereist voor migratie

**CR3**: UI/UX consistency - eindgebruiker ervaart geen verschil tussen V1 en V2 orchestrator responses (UI/endpoint compatibiliteit ongewijzigd)

**CR4**: **[V1 ELIMINATION]** Alle definitie generation requests moeten exclusief via V2 orchestrator worden gerouteerd

**CR5**: **[ARCHITECT REQUIREMENT]** Error handling completeness - alle V1 error scenarios moeten gemapped zijn naar V2 equivalenten

**CR6**: **[ARCHITECT]** Voorbeelden-generatie functionaliteit moet gelijkwaardig of beter zijn dan V1 baseline

## Technische Constraints en Integratie Requirements

### Bestaande Technology Stack

**Talen**: Python 3.x
**Frameworks**: FastAPI, AsyncIO
**Database**: SQLite (definitie opslag)
**Infrastructuur**: Service container architectuur met afhankelijkheid injection
**Externe Dependencies**: OpenAI API via AsyncGPTClient, bestaande cache systeem

### Integratie Benadering

**Database Integratie Strategie**: Geen database wijzigingen - AIServiceV2 gebruikt bestaande cache tabellen en configuratie

**API Integratie Strategie**: AIServiceV2 wordt geïnjecteerd via service container, V2 orchestrator krijgt AIServiceInterface i.p.v. legacy fallback

**Frontend Integratie Strategie**: Transparant - eindgebruiker ziet geen verschil tussen V1/V2 orchestrator responses

**Testing Integratie Strategie**: Uitbreiding bestaande test suite met async AI service tests, V1/V2 compatibility tests

### Code Organisatie en Standards

**File Structure Benadering**: Nieuwe AIServiceV2 in `src/services/ai_service_v2.py`, interface toevoegen aan `src/services/interfaces.py`

**Naming Conventions**: Volgen bestaande patterns - AIServiceV2, AsyncAIService, generate_definition_async()

**Coding Standards**: Consistente error handling met bestaande AIServiceError, async/await patterns zoals AsyncGPTClient

**Documentatie Standards**: Docstrings met type hints, README updates voor nieuwe V2 configuratie

### Deployment en Operations

**Build Process Integratie**: Geen wijzigingen - AIServiceV2 wordt geimporteerd zoals bestaande services

**Deployment Strategie**: Direct V2-only replacement - V1 orchestrator volledig gedeactiveerd, geen dual-mode ondersteuning

**Monitoring en Logging**: Hergebruik bestaande logging patterns, uitbreiding met async performance metrics

**Configuration Management**: Centraal via config_manager zoals bestaande services, AsyncGPTClient configuratie integratie

### Risico Beoordeling en Mitigatie

**Technische Risico's**: AsyncGPTClient concurrency bugs, cache consistency issues, V2 performance regression vs V1 baseline

**Integratie Risico's**: Error handling gaps in V2, token counting inaccuracy impact, production stability zonder fallback

**Deployment Risico's**: V1 elimination zonder adequate rollback testing, performance regression detection delay

**Mitigatie Strategieën**: Mandatory performance benchmarking, AsyncGPTClient stability testing, emergency rollback procedures, comprehensive V2-only testing

## Epic en Story Structuur

### Epic Benadering

**Epic Structure Beslissing**: Enkele comprehensive epic met rationale - De V2 AI Service migratie vereist gecoördineerde wijzigingen over meerdere service lagen (interfaces, implementatie, container wiring) die samen één coherente feature leveren. Multiple epics zouden onnodige complexiteit toevoegen voor wat essentieel een integratie taak is.

## Epic 1: V2 AI Service - Complete V1 Elimination

**Epic Goal**: Complete eliminatie van V1 orchestrator en implementatie van pure async V2 architecture met native AIServiceV2, resulting in clean production-ready codebase zonder legacy dependencies

**Integratie Requirements**: Volledige V1 code removal, AsyncGPTClient native integration, performance validation voor production readiness, emergency rollback capability voor risk mitigation

### Story 1.1: AIServiceInterface Definitie

Als een **ontwikkelaar**,
Wil ik **een gedefinieerde AIServiceInterface in interfaces.py**,
Zodat **V2 orchestrator type-safe async AI calls kan maken**.

#### Acceptance Criteria
1. AIServiceInterface gedefinieerd met async generate_definition() methode
2. Interface bevat batch_generate() methode voor parallelle verwerking
3. Interface definieert AIGenerationResult met text, model, tokens_used, generation_time, cached, retry_count, metadata fields
4. Type hints consistent met bestaande service interfaces
5. Interface ondersteunt optionele parameters (model, temperature, max_tokens, system_prompt, timeout_seconds)
6. Error taxonomie geharmoniseerd naar AIServiceError wrapper voor OpenAI errors

#### Integratie Verificatie
**IV1**: Bestaande import statements in V2 orchestrator blijven werken zonder wijzigingen
**IV2**: IDE type checking rapporteert geen errors voor AIServiceInterface usage
**IV3**: Bestaande services kunnen interface implementeren zonder breaking changes

### Story 1.2: AIServiceV2 Core Implementatie

Als een **V2 orchestrator**,
Wil ik **een native async AI service die AsyncGPTClient hergebruikt**,
Zodat **ik echte async AI calls kan maken zonder legacy fallbacks**.

#### Acceptance Criteria
1. AIServiceV2 implementeert AIServiceInterface volledig met batch_generate() ondersteuning
2. Hergebruik AsyncGPTClient voor rate limiting, retries en caching
3. Structured AIGenerationResult objecten met heuristiek token counting (≥90% accuracy of 'tokens_estimated' flag)
4. OpenAI errors (OpenAIError, RateLimitError) gewrapped naar AIServiceError
5. RateLimitConfig gecentraliseerd via config_manager
6. Zelfde cache keys als V1 voor compatibility
7. Timeouts/retries/rate limiting aantoonbaar actief via logs/metrics

#### Integratie Verificatie
**IV1**: AsyncGPTClient rate limiter werkt correct onder concurrent requests
**IV2**: Cache integratie gebruikt dezelfde keys als legacy AI service met thread-pool voor sync calls
**IV3**: Performance voor single requests minimaal gelijk aan legacy service
**IV4**: Error consistency - OpenAI errors correct gewrapped naar AIServiceError

### Story 1.3: V1 Orchestrator Elimination

Als een **development team**,
Wil ik **alle V1 orchestrator code volledig verwijderen**,
Zodat **we een clean async-only architecture hebben voor production**.

#### Acceptance Criteria
1. V1 orchestrator (`src/services/definition_orchestrator.py`) gedeactiveerd in service container
2. Legacy functions (`stuur_prompt_naar_gpt()`) verwijderd uit codebase
3. V2 orchestrator legacy fallback methods (`_get_legacy_ai_service()`) geëlimineerd
4. Service container routing exclusief via V2 orchestrator
5. Dual-path test coverage geconsolideerd naar async-only test suite

#### Integratie Verificatie
**IV1**: Alle definition generation requests lopen via V2 orchestrator only
**IV2**: Zero legacy fallback code paths in production
**IV3**: Emergency rollback procedure gedocumenteerd en getest

### Story 1.4: Performance Validation & Benchmarking

Als een **development team**,
Wil ik **comprehensive performance validation van V2-only architecture**,
Zodat **we kunnen garanderen dat performance parity wordt behaald**.

#### Acceptance Criteria
1. Performance benchmarking suite ontwikkeld voor V1 vs V2+AIServiceV2 vergelijking
2. Single request latency validation (p95 ≤ V1 ±10%)
3. Batch operation throughput confirmation (≥3x V1 bij parallelle prompts)
4. AsyncGPTClient concurrent load testing (50 rps gedurende 30-60 min)
5. Cache consistency verification onder load scenarios
6. Rate limiter stabiliteit, foutpercentages, geheugenverbruik geverifieerd

#### Integratie Verificatie
**IV1**: V2 orchestrator behaalt performance parity met V1 baseline
**IV2**: Async batch operations tonen 3-5x performance improvement
**IV3**: No performance regressions detected onder production-like load

### Story 1.5: V2-Only Production Readiness

Als een **QA engineer**,
Wil ik **comprehensive testing van V2-only architecture**,
Zodat **production launch succesvol verloopt zonder V1 dependencies**.

#### Acceptance Criteria
1. Async-only test suite voor V2 orchestrator + AIServiceV2 integration
2. Error handling completeness testing (alle V1 scenarios mapped naar V2)
3. Production readiness validation (zero legacy dependencies)
4. Emergency rollback testing en procedure validation
5. Load testing onder production-like scenarios

#### Integratie Verificatie
**IV1**: V2-only architecture slaagt voor alle production readiness criteria
**IV2**: Error scenarios gehandled consistent zonder V1 fallback dependencies
**IV3**: Rollback procedures gevalideerd en gedocumenteerd voor emergency use
